<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/sugw.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sugw.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sugw.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/sugw.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/sugw.github.io/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sugw.github.io","root":"/sugw.github.io/","scheme":"Gemini","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="~前言：一、为什么要用Rsync+sersync架构?1、sersync是基于Inotify开发的，类似于Inotify-tools的工具2、sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的这个文件或者这个目录。二、Rsync+Inotify-tools与Rsync+sersync这两种架构有什么">
<meta property="og:type" content="article">
<meta property="og:title" content="一只小笨鸟">
<meta property="og:url" content="https://sugw.github.io/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/index.html">
<meta property="og:site_name" content="一只小笨鸟">
<meta property="og:description" content="~前言：一、为什么要用Rsync+sersync架构?1、sersync是基于Inotify开发的，类似于Inotify-tools的工具2、sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的这个文件或者这个目录。二、Rsync+Inotify-tools与Rsync+sersync这两种架构有什么">
<meta property="og:locale">
<meta property="article:published_time" content="2020-10-16T03:41:31.483Z">
<meta property="article:modified_time" content="2020-10-16T03:27:35.293Z">
<meta property="article:author" content="guowei su">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://sugw.github.io/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title> | 一只小笨鸟</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/sugw.github.io/atom.xml" title="一只小笨鸟" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/sugw.github.io/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">一只小笨鸟</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/sugw.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/sugw.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/sugw.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/sugw.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/sugw.github.io/%E5%BD%92%E6%A1%A3/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="guowei su"
      src="/sugw.github.io/images/321603183701.jpg">
  <p class="site-author-name" itemprop="name">guowei su</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/sugw.github.io/%E5%BD%92%E6%A1%A3/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/sugw.github.io/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      
  
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://sugw.github.io/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/sugw.github.io/images/321603183701.jpg">
      <meta itemprop="name" content="guowei su">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只小笨鸟">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2020-10-16 11:41:31 / Modified: 11:27:35" itemprop="dateCreated datePublished" datetime="2020-10-16T11:41:31+08:00">2020-10-16</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><del>~</del><br>前言：<br>一、为什么要用Rsync+sersync架构?<br>1、sersync是基于Inotify开发的，类似于Inotify-tools的工具<br>2、sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的这个文件或者这个目录。<br>二、Rsync+Inotify-tools与Rsync+sersync这两种架构有什么区别？<br>1、Rsync+Inotify-tools<br>（1）：Inotify-tools只能记录下被监听的目录发生了变化（包括增加、删除、修改），并没有把具体是哪个文件或者哪个目录发生了变化记录下来；<br>（2）：rsync在同步的时候，并不知道具体是哪个文件或者哪个目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此，效率很低。<br>2、Rsync+sersync<br>（1）：sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字；<br>（2）：rsync在同步的时候，只同步发生变化的这个文件或者这个目录（每次发生变化的数据相对整个同步目录数据来说是很小的，rsync在遍历查找比对文件时，速度很快），因此，效率很高。<br>小结：当同步的目录数据量不大时，建议使用Rsync+Inotify-tools；当数据量很大（几百G甚至1T以上）、文件很多时，建议使用Rsync+sersync。<br>说明：<br>操作系统：CentOS 5.X<br>源服务器：192.168.21.129<br>目标服务器：192.168.21.127，192.168.21.128<br>目的：把源服务器上/home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com目录实时同步到目标服务器的/home/www.osyunwei.com%E4%B8%8B">www.osyunwei.com目录实时同步到目标服务器的/home/www.osyunwei.com下</a><br>系统运维  <a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a>  温馨提醒：qihang01原创内容 版权所有,转载请注明出处及原文链接<br>具体操作：<br>第一部分：分别在两台目标服务器192.168.21.127，192.168.21.128上操作<br>一、分别在两台在目标服务器安装Rsync服务端<br>1、关闭SELINUX<br>vi /etc/selinux/config #编辑防火墙配置文件<br>#SELINUX=enforcing #注释掉<br>#SELINUXTYPE=targeted #注释掉<br>SELINUX=disabled #增加<br>:wq! #保存，退出<br>setenforce 0 #立即生效<br>2、开启防火墙tcp 873端口（Rsync默认端口）<br>vi /etc/sysconfig/iptables #编辑防火墙配置文件<br>-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 873 -j ACCEPT<br>:wq! #保存退出<br>/etc/init.d/iptables restart #最后重启防火墙使配置生效<br>3、安装Rsync服务端软件<br>yum install rsync xinetd #安装<br>vi /etc/xinetd.d/rsync #编辑配置文件，设置开机启动rsync<br>disable = no #修改为no<br>:wq! #保存退出<br>/etc/init.d/xinetd start #启动（CentOS中是以xinetd来管理Rsync服务的）<br>4、创建rsyncd.conf配置文件<br>vi /etc/rsyncd.conf #创建配置文件，添加以下代码<br>log file = /var/log/rsyncd.log #日志文件位置，启动rsync后自动产生这个文件，无需提前创建<br>pidfile = /var/run/rsyncd.pid  #pid文件的存放位置<br>lock file = /var/run/rsync.lock  #支持max connections参数的锁文件<br>secrets file = /etc/rsync.pass  #用户认证配置文件，里面保存用户名称和密码，后面会创建这个文件<br>motd file = /etc/rsyncd.Motd  #rsync启动时欢迎信息页面文件位置（文件内容自定义）<br>[home_<a href="http://www.osyunwei.com]">www.osyunwei.com]</a> #自定义名称<br>path = /home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com/</a> #rsync服务端数据目录路径<br>comment = home_<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a> #模块名称与[home_<a href="http://www.osyunwei.com]自定义名称相同">www.osyunwei.com]自定义名称相同</a><br>uid = root #设置rsync运行权限为root<br>gid = root #设置rsync运行权限为root<br>port=873  #默认端口<br>use chroot = no #默认为true，修改为no，增加对目录文件软连接的备份<br>read only = no  #设置rsync服务端文件为读写权限<br>list = no #不显示rsync服务端资源列表<br>max connections = 200 #最大连接数<br>timeout = 600  #设置超时时间<br>auth users = home_<a target="_blank" rel="noopener" href="http://www.osyunwei.com_user/">www.osyunwei.com_user</a> #执行数据同步的用户名，可以设置多个，用英文状态下逗号隔开<br>hosts allow = 192.168.21.129  #允许进行数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开<br>hosts deny = 192.168.21.254 #禁止数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开<br>:wq!  #保存,退出<br>5、创建用户认证文件<br>vi /etc/rsync.pass #配置文件，添加以下内容<br>home_<a href="http://www.osyunwei.com_user:123456">www.osyunwei.com_user:123456</a>  #格式，用户名:密码，可以设置多个，每行一个用户名:密码<br>:wq!  #保存退出<br>6、设置文件权限<br>chmod 600 /etc/rsyncd.conf  #设置文件所有者读取、写入权限<br>chmod 600 /etc/rsync.pass  #设置文件所有者读取、写入权限<br>7、启动rsync<br>/etc/init.d/xinetd start  #启动<br>service xinetd stop   #停止<br>service xinetd restart  #重新启动<br>第二部分：在源服务器192.168.21.129上操作<br>一、安装Rsync客户端<br>1、关闭SELINUX<br>vi /etc/selinux/config  #编辑防火墙配置文件<br>#SELINUX=enforcing  #注释掉<br>#SELINUXTYPE=targeted  #注释掉<br>SELINUX=disabled  #增加<br>:wq!  #保存退出<br>setenforce 0   #立即生效<br>2、开启防火墙tcp 873端口（Rsync默认端口，做为客户端的Rsync可以不用开启873端口）<br>vi /etc/sysconfig/iptables  #编辑防火墙配置文件<br>-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 873 -j ACCEPT<br>:wq! #保存退出<br>/etc/init.d/iptables restart #最后重启防火墙使配置生效<br>3、安装Rsync客户端端软件<br>whereis rsync   #查看系统是否已安装rsync,出现下面的提示，说明已经安装<br>rsync: /usr/bin/rsync /usr/share/man/man1/rsync.1.gz<br>yum install  xinetd  #只安装xinetd即可，CentOS中是以xinetd来管理rsync服务的<br>yum install rsync xinetd #如果默认没有rsync，运行此命令进行安装rsync和xinetd<br>vi /etc/xinetd.d/rsync #编辑配置文件，设置开机启动rsync<br>disable = no #修改为no<br>/etc/init.d/xinetd start #启动（CentOS中是以xinetd来管理rsync服务的）<br>4、创建认证密码文件<br>vi /etc/passwd.txt  #编辑文件，添加以下内容<br>123456 #密码<br>:wq! #保存退出<br>chmod 600 /etc/passwd.txt  #设置文件权限，只设置文件所有者具有读取、写入权限即可<br>5、测试源服务器192.168.21.129到两台目标服务器192.168.21.127，192.168.21.128之间的数据同步<br>mkdir /home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com/ceshi">www.osyunwei.com/ceshi</a>  #在源服务器上创建测试文件夹，然后在源服务器运行下面2行命令<br>rsync -avH –port=873 –progress –delete  /home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com/</a>  <a href="mailto:&#x68;&#x6f;&#109;&#101;&#95;&#x77;&#x77;&#x77;&#x2e;&#111;&#115;&#121;&#117;&#x6e;&#x77;&#x65;&#x69;&#x2e;&#99;&#x6f;&#x6d;&#x5f;&#x75;&#x73;&#101;&#114;&#64;&#49;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#50;&#49;&#46;&#x31;&#50;&#x37;">&#x68;&#x6f;&#109;&#101;&#95;&#x77;&#x77;&#x77;&#x2e;&#111;&#115;&#121;&#117;&#x6e;&#x77;&#x65;&#x69;&#x2e;&#99;&#x6f;&#x6d;&#x5f;&#x75;&#x73;&#101;&#114;&#64;&#49;&#x39;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#50;&#49;&#46;&#x31;&#50;&#x37;</a>::home_<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a> –password-file=/etc/passwd.txt<br>rsync -avH –port=873 –progress –delete  /home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com/</a>  <a href="mailto:&#104;&#111;&#x6d;&#x65;&#95;&#x77;&#119;&#x77;&#x2e;&#111;&#x73;&#121;&#117;&#110;&#119;&#101;&#x69;&#46;&#x63;&#x6f;&#109;&#95;&#117;&#x73;&#101;&#114;&#x40;&#49;&#x39;&#50;&#46;&#x31;&#x36;&#56;&#46;&#50;&#x31;&#x2e;&#49;&#x32;&#x38;">&#104;&#111;&#x6d;&#x65;&#95;&#x77;&#119;&#x77;&#x2e;&#111;&#x73;&#121;&#117;&#110;&#119;&#101;&#x69;&#46;&#x63;&#x6f;&#109;&#95;&#117;&#x73;&#101;&#114;&#x40;&#49;&#x39;&#50;&#46;&#x31;&#x36;&#56;&#46;&#50;&#x31;&#x2e;&#49;&#x32;&#x38;</a>::home_<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a> –password-file=/etc/passwd.txt<br>运行完成后，分别在两台目标服务器192.168.21.127，192.168.21.128上查看，在/home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com目录下有ceshi文件夹,说明数据同步成功./">www.osyunwei.com目录下有ceshi文件夹，说明数据同步成功。</a><br>系统运维  <a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a>  温馨提醒：qihang01原创内容 版权所有,转载请注明出处及原文链接<br>二、安装sersync工具，实时触发rsync进行同步<br>1、查看服务器内核是否支持inotify<br>ll /proc/sys/fs/inotify   #列出文件目录，出现下面的内容，说明服务器内核支持inotify<br>-rw-r–r– 1 root root 0 Mar  7 02:17 max_queued_events<br>-rw-r–r– 1 root root 0 Mar  7 02:17 max_user_instances<br>-rw-r–r– 1 root root 0 Mar  7 02:17 max_user_watches<br>备注：Linux下支持inotify的内核最小为2.6.13，可以输入命令：uname -a查看内核<br>CentOS 5.X 内核为2.6.18，默认已经支持inotify<br>2、修改inotify默认参数（inotify默认内核参数值太小）<br>查看系统默认参数值：<br>sysctl -a | grep max_queued_events<br>结果是：fs.inotify.max_queued_events = 16384<br>sysctl -a | grep max_user_watches<br>结果是：fs.inotify.max_user_watches = 8192<br>sysctl -a | grep max_user_instances<br>结果是：fs.inotify.max_user_instances = 128<br>修改参数：<br>sysctl -w fs.inotify.max_queued_events=”99999999”<br>sysctl -w fs.inotify.max_user_watches=”99999999”<br>sysctl -w fs.inotify.max_user_instances=”65535”<br>vi /etc/sysctl.conf #添加以下代码<br>fs.inotify.max_queued_events=99999999<br>fs.inotify.max_user_watches=99999999<br>fs.inotify.max_user_instances=65535<br>:wq! #保存退出<br>参数说明：<br>max_queued_events：<br>inotify队列最大长度，如果值太小，会出现”** Event Queue Overflow **”错误，导致监控文件不准确<br>max_user_watches：<br>要同步的文件包含多少目录，可以用：find /home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com/">www.osyunwei.com</a> -type d | wc -l 统计，必须保证max_user_watches值大于统计结果（这里/home/<a target="_blank" rel="noopener" href="http://www.osyunwei.com为同步文件目录)/">www.osyunwei.com为同步文件目录）</a><br>max_user_instances：<br>每个用户创建inotify实例最大值<br>3、安装sersync<br>sersync下载地址：<a target="_blank" rel="noopener" href="https://sersync.googlecode.com/files/sersync2.5.4_64bit_binary_stable_final.tar.gz">https://sersync.googlecode.com/files/sersync2.5.4_64bit_binary_stable_final.tar.gz</a><br>上传sersync2.5.4_64bit_binary_stable_final.tar.gz到/usr/local/src目录下<br>cd /usr/local/src<br>tar zxvf sersync2.5.4_64bit_binary_stable_final.tar.gz  #解压<br>mv GNU-Linux-x86  /usr/local/sersync  #移动目录到/usr/local/sersync<br>4、配置sersync<br>cd  /usr/local/sersync #进入sersync安装目录<br>cp confxml.xml confxml.xml-bak  #备份原文件<br>vi confxml.xml  #编辑，修改下面的代码<br><?xml version="1.0" encoding="ISO-8859-1"?></p>
<head version="2.5">
<host hostip="localhost" port="8008"></host>
<debug start="false"/>
<fileSystem xfs="false"/>
<filter start="false">
<exclude expression="(.*)\.svn"></exclude>
<exclude expression="(.*)\.gz"></exclude>
<exclude expression="^info/*"></exclude>
<exclude expression="^static/*"></exclude>
</filter>
<inotify>
<delete start="true"/>
<createFolder start="true"/>
<createFile start="false"/>
<closeWrite start="true"/>
<moveFrom start="true"/>
<moveTo start="true"/>
<attrib start="false"/>
<modify start="false"/>
</inotify>
<sersync>
<localpath watch="/home/www.osyunwei.com">
<remote ip="192.168.21.127" name="home_www.osyunwei.com"/>
<remote ip="192.168.21.128" name="home_www.osyunwei.com"/>
<!--<remote ip="192.168.8.40" name="tongbu"/>-->
</localpath>
<rsync>
<commonParams params="-artuz"/>
<auth start="true" users="home_www.osyunwei.com_user" passwordfile="/etc/passwd.txt"/>
<userDefinedPort start="false" port="874"/><!-- port=874 -->
<timeout start="false" time="100"/><!-- timeout=100 -->
<ssh start="false"/>
</rsync>
<failLog path="/tmp/rsync_fail_log.sh" timeToExecute="60"/><!--default every 60mins execute once-->
<crontab start="true" schedule="600"><!--600mins-->
<crontabfilter start="false">
<exclude expression="*.php"></exclude>
<exclude expression="info/*"></exclude>
</crontabfilter>
</crontab>
<plugin start="false" name="command"/>
</sersync>
<plugin name="command">
<param prefix="/bin/sh" suffix="" ignoreError="true"/>  <!--prefix /opt/tongbu/mmm.sh suffix-->
<filter start="false">
<include expression="(.*)\.php"/>
<include expression="(.*)\.sh"/>
</filter>
</plugin>
<plugin name="socket">
<localpath watch="/opt/tongbu">
<deshost ip="192.168.138.20" port="8009"/>
</localpath>
</plugin>
<plugin name="refreshCDN">
<localpath watch="/data0/htdocs/cms.xoyo.com/site/">
<cdninfo domainname="ccms.chinacache.com" port="80" username="xxxx" passwd="xxxx"/>
<sendurl base="http://pic.xoyo.com/cms"/>
<regexurl regex="false" match="cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images"/>
</localpath>
</plugin>
</head>
:wq!  #保存退出
参数说明：
localpath watch="/home/www.osyunwei.com"：#源服务器同步目录
192.168.21.127，192.168.21.128：#目标服务器IP地址
name="home_www.osyunwei.com"： #目标服务器rsync同步目录模块名称
users="home_www.osyunwei.com_user"： #目标服务器rsync同步用户名
passwordfile="/etc/passwd.txt"： #目标服务器rsync同步用户的密码在源服务器的存放路径
remote ip="192.168.21.127":  #目标服务器ip，每行一个
remote ip="192.168.21.128":  #目标服务器ip，每行一个
failLog path="/tmp/rsync_fail_log.sh"  #脚本运行失败日志记录
start="true"  #设置为true，每隔600分钟执行一次全盘同步
5、设置sersync监控开机自动执行
vi /etc/rc.d/rc.local  #编辑，在最后添加一行
/usr/local/sersync/sersync2 -d -r -o  /usr/local/sersync/confxml.xml  ＃设置开机自动运行脚本
:wq!  #保存退出
6、添加脚本监控sersync是否正常运行
vi  /home/crontab/check_sersync.sh  #编辑，添加以下代码
#!/bin/sh
sersync="/usr/local/sersync/sersync2"
confxml="/usr/local/sersync/confxml.xml"
status=$(ps aux |grep 'sersync2'|grep -v 'grep'|wc -l)
if [ $status -eq 0 ];
then
$sersync -d -r -o $confxml &
else
exit 0;
fi
:wq!  #保存退出
chmod +x /home/crontab/check_sersync.sh #添加脚本执行权限
vi /etc/crontab #编辑，在最后添加下面一行
*/5 * * * * root /home/crontab/check_sersync.sh > /dev/null 2>&1  #每隔5分钟执行一次脚本
service crond reload  #重新加载服务
6、测试sersync实时触发rsync同步脚本是否正常运行
在源服务器192.168.21.129上创建文件inotify_rsync_ceshi
mkdir /home/www.osyunwei.com/inotify_rsync_ceshi
重新启动源服务器：192.168.21.129
等系统启动之后，查看两台目标服务器192.168.21.127，192.168.21.128的/home/www.osyunwei.com下是否有inotify_rsync_ceshi文件夹
然后再在源服务器192.168.21.129创建文件夹inotify_rsync_ceshi_new
mkdir /home/www.osyunwei.com/inotify_rsync_ceshi_new
继续查看两台目标服务器192.168.21.127，192.168.21.128的/home/www.osyunwei.com下是否有inotify_rsync_ceshi_new文件夹
如果以上测试都通过，说明inotify实时触发rsync同步脚本运行正常。
至此，Linux下Rsync+sersync实现数据实时同步完成。
扩展阅读：
sersync开发者网站：http://blog.johntechinfo.com/sersyncguild
rsync参数
-v, --verbose 详细模式输出
-q, --quiet 精简输出模式
-c, --checksum 打开校验开关，强制对文件传输进行校验
-a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD
-r, --recursive 对子目录以递归模式处理
-R, --relative 使用相对路径信息
-b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时，将老的文件重新命名为~filename。可以使用--suffix选项来指定不同的备份文件前缀。
--backup-dir 将备份文件(如~filename)存放在在目录下。
-suffix=SUFFIX 定义备份文件前缀
-u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件)
-l, --links 保留软链结
-L, --copy-links 想对待常规文件一样处理软链结
--copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结
--safe-links 忽略指向SRC路径目录树以外的链结
-H, --hard-links 保留硬链结
-p, --perms 保持文件权限
-o, --owner 保持文件属主信息
-g, --group 保持文件属组信息
-D, --devices 保持设备文件信息
-t, --times 保持文件时间信息
-S, --sparse 对稀疏文件进行特殊处理以节省DST的空间
-n, --dry-run现实哪些文件将被传输
-W, --whole-file 拷贝文件，不进行增量检测
-x, --one-file-system 不要跨越文件系统边界
-B, --block-size=SIZE 检验算法使用的块尺寸，默认是700字节
-e, --rsh=COMMAND 指定使用rsh、ssh方式进行数据同步
--rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息
-C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件
--existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件
--delete 删除那些DST中SRC没有的文件
--delete-excluded 同样删除接收端那些被该选项指定排除的文件
--delete-after 传输结束以后再删除
--ignore-errors 及时出现IO错误也进行删除
--max-delete=NUM 最多删除NUM个文件
--partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输
--force 强制删除目录，即使不为空
--numeric-ids 不将数字的用户和组ID匹配为用户名和组名
--timeout=TIME IP超时时间，单位为秒
-I, --ignore-times 不跳过那些有同样的时间和长度的文件
--size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间
--modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为0
-T --temp-dir=DIR 在DIR中创建临时文件
--compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份
-P 等同于 --partial
--progress 显示备份过程
-z, --compress 对备份的文件在传输时进行压缩处理
--exclude=PATTERN 指定排除不需要传输的文件模式
--include=PATTERN 指定不排除而需要传输的文件模式
--exclude-from=FILE 排除FILE中指定模式的文件
--include-from=FILE 不排除FILE指定模式匹配的文件
--version 打印版本信息
--address 绑定到特定的地址
--config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件
--port=PORT 指定其他的rsync服务端口
--blocking-io 对远程shell使用阻塞IO
-stats 给出某些文件的传输状态
--progress 在传输时现实传输过程
--log-format=formAT 指定日志文件格式
--password-file=FILE 从FILE中得到密码
--bwlimit=KBPS 限制I/O带宽，KBytes per second
-h, --help 显示帮助信息
    </div>
    
    
    

    <footer class="post-footer">
          

  <div class="followme">
    <span>Welcome to my other publishing channels</span>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/rsync%E9%85%8D%E7%BD%AE/" rel="prev" title="">
                  <i class="fa fa-chevron-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/10/16/sersync%E5%AE%89%E8%A3%85/" rel="next" title="Hello World">
                  Hello World <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">guowei su</span>
</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>

    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/sugw.github.io/js/utils.js"></script><script src="/sugw.github.io/js/motion.js"></script><script src="/sugw.github.io/js/next-boot.js"></script>

  




  <script src="/sugw.github.io/js/local-search.js"></script>












  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: "/sugw.github.io/2020/10/16/%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/sersync+rsync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/",
    }, {"enable":true,"appId":"Rvi5XTbIGoBGqGhM3SdPXNnc-gzGzoHsz","appKey":"tsLwTwnG13sIxCOXRrDVxPqW","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
