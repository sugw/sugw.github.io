<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>
<!DOCTYPE html>
<html lang="zh-CN">
<head><!-- hexo injector head_begin start --><link href="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/sugw.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sugw.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sugw.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/sugw.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/sugw.github.io/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sugw.github.io","root":"/sugw.github.io/","scheme":"Gemini","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））  环境准备  编写ansible playbook脚本实现Wordpress远程部署  将wordpress源码与playbook部署脚本提交到gitlab仓库  编写pipeline job脚本实现Jenkins流水线持续交付流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins+Gitlab+Ansible自动化部署(六)">
<meta property="og:url" content="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/index.html">
<meta property="og:site_name" content="苏国伟">
<meta property="og:description" content="Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））  环境准备  编写ansible playbook脚本实现Wordpress远程部署  将wordpress源码与playbook部署脚本提交到gitlab仓库  编写pipeline job脚本实现Jenkins流水线持续交付流程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-27T02:03:01.705Z">
<meta property="article:modified_time" content="2021-01-07T10:09:46.461Z">
<meta property="article:author" content="苏国伟">
<meta property="article:tag" content="自动部署">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Jenkins+Gitlab+Ansible自动化部署(六) | 苏国伟</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/sugw.github.io/atom.xml" title="苏国伟" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/sugw.github.io/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">苏国伟</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/sugw.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-作者">

    <a href="/sugw.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>作者</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/sugw.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/sugw.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/sugw.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苏国伟"
      src="/sugw.github.io/images/291603183698.jpg">
  <p class="site-author-name" itemprop="name">苏国伟</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/sugw.github.io/archives">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/sugw.github.io/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/sugw.github.io/tags/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      
  
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/sugw.github.io/images/291603183698.jpg">
      <meta itemprop="name" content="苏国伟">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏国伟">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jenkins+Gitlab+Ansible自动化部署(六)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-27 10:03:01" itemprop="dateCreated datePublished" datetime="2020-11-27T10:03:01+08:00">2020-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-01-07 18:09:46" itemprop="dateModified" datetime="2021-01-07T18:09:46+08:00">2021-01-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/sugw.github.io/categories/Jenkins/" itemprop="url" rel="index"><span itemprop="name">Jenkins</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>47k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>42 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><strong>Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））</strong></p>
<ul>
<li><p>环境准备</p>
</li>
<li><p>编写ansible playbook脚本实现Wordpress远程部署</p>
</li>
<li><p>将wordpress源码与playbook部署脚本提交到gitlab仓库</p>
</li>
<li><p>编写pipeline job脚本实现Jenkins流水线持续交付流程</p>
</li>
<li><p>Jenkins集成Ansible与gitlab实现wordpress的自动化部署</p>
<p>验证环境</p>
</li>
</ul>
<p>登录Jenkins主机</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~</span><br><span class="line">$ ssh <span class="symbol">root@</span>jenkins.example.com</span><br><span class="line">Last login: Thu Jan <span class="number">10</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">49</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.1</span></span><br><span class="line"><span class="string">[root@jenkins ~]</span># su - deploy</span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">20</span>:<span class="number">24</span>:<span class="number">43</span> CST <span class="number">2019</span> on pts/<span class="number">0</span></span><br><span class="line"><span class="string">[deploy@jenkins ~]</span>$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/bin/activate           (.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/hacking/env-setup -q</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> c748512c4c) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible-playbook</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ ssh <span class="symbol">root@</span>test.example.com</span><br><span class="line">Last login: Thu Jan <span class="number">10</span> <span class="number">13</span>:<span class="number">04</span>:<span class="number">32</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.131</span></span><br><span class="line"><span class="string">[root@test ~]</span># hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>登录Jenkins web管理页</p>
<p>4464</p>
<p>登录gitlab web管理页</p>
<p>4576</p>
<p>至此环境准备完成。</p>
<p>接下来编写ansible playbook脚本实现wordpress远程部署</p>
<p>开始编写配置文件</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd ~/Desktop/repo/ansible-playbook-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">5</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">11</span>:<span class="number">57</span> ansible-playbook.txt</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">27</span> nginx_playbooks/</span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">312</span> <span class="number">7</span>月  <span class="number">15</span> <span class="number">08</span>:<span class="number">33</span> nginx-freestyle-job.sh</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ mkdir wordpress_playbooks</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ cd wordpress_playbooks/</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ mkdir inventory</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ mkdir -p roles/wordpress/&#123;files,tasks,templates&#125;</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">13</span>:<span class="number">29</span> inventory/</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">13</span>:<span class="number">30</span> roles/</span><br><span class="line"></span><br><span class="line">配置deploy.retry</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.retry</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>配置deploy.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">xueji@xueji</span> <span class="string">MINGW64</span> <span class="string">~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks</span> <span class="string">(master)</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">deploy.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">backup_to:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;root&#125;&#125;</span>_<span class="template-variable">&#123;&#123;branch&#125;&#125;</span>_<span class="template-variable">&#123;&#123;ansible_date_time.epoch&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wordpress</span></span><br></pre></td></tr></table></figure>



<p>配置dev</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim inventory/dev</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line"><span class="attribute">server_name</span>=test.example.com</span><br><span class="line"><span class="attribute">port</span>=8080</span><br><span class="line"><span class="attribute">user</span>=deploy</span><br><span class="line"><span class="attribute">worker_processes</span>=2</span><br><span class="line"><span class="attribute">max_open_file</span>=30000</span><br><span class="line"><span class="attribute">root</span>=/data/www</span><br><span class="line"><span class="attribute">gitlab_user</span>=<span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="attribute">gitlab_pass</span>=<span class="string">&#x27;12345678&#x27;</span></span><br></pre></td></tr></table></figure>



<p>配置prod</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim inventory/prod</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line"><span class="attribute">server_name</span>=test.example.com</span><br><span class="line"><span class="attribute">port</span>=80</span><br><span class="line"><span class="attribute">user</span>=deploy</span><br><span class="line"><span class="attribute">worker_processes</span>=4</span><br><span class="line"><span class="attribute">max_open_file</span>=65505</span><br><span class="line"><span class="attribute">root</span>=/data/www</span><br><span class="line"><span class="attribute">gitlab_user</span>=<span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="attribute">gitlab_pass</span>=<span class="string">&#x27;12345678&#x27;</span></span><br></pre></td></tr></table></figure>



<p>配置health_check.sh和info.php</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/wordpress/</span>files/health_check.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">URL=<span class="variable">$1</span></span><br><span class="line">PORT=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">curl -Is http:<span class="regexp">//</span><span class="variable">$URL</span>:<span class="variable">$PORT</span><span class="regexp">/info.php &gt; /</span>dev/null &amp;&amp; echo <span class="string">&quot;The remote side is healthy&quot;</span> || echo <span class="string">&quot;The remote side is failed, please check&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ echo <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> &gt;&gt; roles<span class="regexp">/wordpress/</span>files/info.php</span><br></pre></td></tr></table></figure>



<p>配置<a href="http://www.conf/">www.conf</a></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line">xueji<span class="symbol">@xueji</span> MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim roles/wordpress/files/www.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">; Start a new pool named &#x27;www&#x27;.</span></span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line"><span class="comment">; Unix user/group of processes</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The user is mandatory. If the group is not set, the default user&#x27;s group</span></span><br><span class="line"><span class="comment">;       will be used.</span></span><br><span class="line"><span class="comment">; RPM: apache Choosed to be able to access some dir as httpd</span></span><br><span class="line">user = deploy</span><br><span class="line"><span class="comment">; RPM: Keep a group allowed to write in log dir.</span></span><br><span class="line">group = deploy</span><br><span class="line"></span><br><span class="line"><span class="comment">; The address on which to accept FastCGI requests.</span></span><br><span class="line"><span class="comment">; Valid syntaxes are:</span></span><br><span class="line"><span class="comment">;   &#x27;ip.add.re.ss:port&#x27;    - to listen on a TCP socket to a specific IPv4 address on</span></span><br><span class="line"><span class="comment">;                            a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;[ip:6:addr:ess]:port&#x27; - to listen on a TCP socket to a specific IPv6 address on</span></span><br><span class="line"><span class="comment">;                            a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;port&#x27;                 - to listen on a TCP socket to all addresses</span></span><br><span class="line"><span class="comment">;                            (IPv6 and IPv4-mapped) on a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;/path/to/unix/socket&#x27; - to listen on a unix socket.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line"><span class="comment">;listen = 127.0.0.1:9000</span></span><br><span class="line">listen = /var/<span class="built_in">run</span>/php-fpm/php-fpm.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set listen(2) backlog.</span></span><br><span class="line"><span class="comment">; Default Value: 511 (-1 on FreeBSD and OpenBSD)</span></span><br><span class="line"><span class="comment">;listen.backlog = 511</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set permissions for unix socket, if one is used. In Linux, read/write</span></span><br><span class="line"><span class="comment">; permissions must be set in order to allow connections from a web server. Many</span></span><br><span class="line"><span class="comment">; BSD-derived systems allow connections regardless of permissions.</span></span><br><span class="line"><span class="comment">; Default Values: user and group are set as the running user</span></span><br><span class="line"><span class="comment">;                 mode is set to 0660</span></span><br><span class="line">listen.owner = deploy</span><br><span class="line">listen.group = deploy</span><br><span class="line"><span class="comment">;listen.mode = 0660</span></span><br><span class="line"><span class="comment">; When POSIX Access Control Lists are supported you can set them using</span></span><br><span class="line"><span class="comment">; these options, value is a comma separated list of user/group names.</span></span><br><span class="line"><span class="comment">; When set, listen.owner and listen.group are ignored</span></span><br><span class="line"><span class="comment">;listen.acl_users =</span></span><br><span class="line"><span class="comment">;listen.acl_groups =</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.</span></span><br><span class="line"><span class="comment">; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original</span></span><br><span class="line"><span class="comment">; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address</span></span><br><span class="line"><span class="comment">; must be separated by a comma. If this value is left blank, connections will be</span></span><br><span class="line"><span class="comment">; accepted from any ip address.</span></span><br><span class="line"><span class="comment">; Default Value: any</span></span><br><span class="line">listen.allowed_clients = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Specify the nice(2) priority to apply to the pool processes (only if set)</span></span><br><span class="line"><span class="comment">; The value can vary from -19 (highest priority) to 20 (lower priority)</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> - It will only work if the FPM master process is launched as root</span></span><br><span class="line"><span class="comment">;       - The pool processes will inherit the master process priority</span></span><br><span class="line"><span class="comment">;         unless it specified otherwise</span></span><br><span class="line"><span class="comment">; Default Value: no set</span></span><br><span class="line"><span class="comment">; process.priority = -19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Choose how the process manager will control the number of child processes.</span></span><br><span class="line"><span class="comment">; Possible Values:</span></span><br><span class="line"><span class="comment">;   static  - a fixed number (pm.max_children) of child processes;</span></span><br><span class="line"><span class="comment">;   dynamic - the number of child processes are set dynamically based on the</span></span><br><span class="line"><span class="comment">;             following directives. With this process management, there will be</span></span><br><span class="line"><span class="comment">;             always at least 1 children.</span></span><br><span class="line"><span class="comment">;             pm.max_children      - the maximum number of children that can</span></span><br><span class="line"><span class="comment">;                                    be alive at the same time.</span></span><br><span class="line"><span class="comment">;             pm.start_servers     - the number of children created on startup.</span></span><br><span class="line"><span class="comment">;             pm.min_spare_servers - the minimum number of children in &#x27;idle&#x27;</span></span><br><span class="line"><span class="comment">;                                    state (waiting to process). If the number</span></span><br><span class="line"><span class="comment">;                                    of &#x27;idle&#x27; processes is less than this</span></span><br><span class="line"><span class="comment">;                                    number then some children will be created.</span></span><br><span class="line"><span class="comment">;             pm.max_spare_servers - the maximum number of children in &#x27;idle&#x27;</span></span><br><span class="line"><span class="comment">;                                    state (waiting to process). If the number</span></span><br><span class="line"><span class="comment">;                                    of &#x27;idle&#x27; processes is greater than this</span></span><br><span class="line"><span class="comment">;                                    number then some children will be killed.</span></span><br><span class="line"><span class="comment">;  ondemand - no children are created at startup. Children will be forked when</span></span><br><span class="line"><span class="comment">;             new requests will connect. The following parameter are used:</span></span><br><span class="line"><span class="comment">;             pm.max_children           - the maximum number of children that</span></span><br><span class="line"><span class="comment">;                                         can be alive at the same time.</span></span><br><span class="line"><span class="comment">;             pm.process_idle_timeout   - The number of seconds after which</span></span><br><span class="line"><span class="comment">;                                         an idle process will be killed.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line">pm = dynamic</span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of child processes to be created when pm is set to &#x27;static&#x27; and the</span></span><br><span class="line"><span class="comment">; maximum number of child processes when pm is set to &#x27;dynamic&#x27; or &#x27;ondemand&#x27;.</span></span><br><span class="line"><span class="comment">; This value sets the limit on the number of simultaneous requests that will be</span></span><br><span class="line"><span class="comment">; served. Equivalent to the ApacheMaxClients directive with mpm_prefork.</span></span><br><span class="line"><span class="comment">; Equivalent to the PHP_FCGI_CHILDREN environment variable in the original PHP</span></span><br><span class="line"><span class="comment">; CGI.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used when pm is set to &#x27;static&#x27;, &#x27;dynamic&#x27; or &#x27;ondemand&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line">pm.max_children = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of child processes created on startup.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2</span></span><br><span class="line">pm.start_servers = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The desired minimum number of idle server processes.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Mandatory when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line">pm.min_spare_servers = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The desired maximum number of idle server processes.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Mandatory when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line">pm.max_spare_servers = <span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of seconds after which an idle process will be killed.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;ondemand&#x27;</span></span><br><span class="line"><span class="comment">; Default Value: 10s</span></span><br><span class="line"><span class="comment">;pm.process_idle_timeout = 10s;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of requests each child process should execute before respawning.</span></span><br><span class="line"><span class="comment">; This can be useful to work around memory leaks in 3rd party libraries. For</span></span><br><span class="line"><span class="comment">; endless request processing specify &#x27;0&#x27;. Equivalent to PHP_FCGI_MAX_REQUESTS.</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;pm.max_requests = 500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The URI to view the FPM status page. If this value is not set, no URI will be</span></span><br><span class="line"><span class="comment">; recognized as a status page. It shows the following informations:</span></span><br><span class="line"><span class="comment">;   pool                 - the name of the pool;</span></span><br><span class="line"><span class="comment">;   process manager      - static, dynamic or ondemand;</span></span><br><span class="line"><span class="comment">;   start time           - the date and time FPM has started;</span></span><br><span class="line"><span class="comment">;   start since          - number of seconds since FPM has started;</span></span><br><span class="line"><span class="comment">;   accepted conn        - the number of request accepted by the pool;</span></span><br><span class="line"><span class="comment">;   listen queue         - the number of request in the queue of pending</span></span><br><span class="line"><span class="comment">;                          connections (see backlog in listen(2));</span></span><br><span class="line"><span class="comment">;   max listen queue     - the maximum number of requests in the queue</span></span><br><span class="line"><span class="comment">;                          of pending connections since FPM has started;</span></span><br><span class="line"><span class="comment">;   listen queue len     - the size of the socket queue of pending connections;</span></span><br><span class="line"><span class="comment">;   idle processes       - the number of idle processes;</span></span><br><span class="line"><span class="comment">;   active processes     - the number of active processes;</span></span><br><span class="line"><span class="comment">;   total processes      - the number of idle + active processes;</span></span><br><span class="line"><span class="comment">;   max active processes - the maximum number of active processes since FPM</span></span><br><span class="line"><span class="comment">;                          has started;</span></span><br><span class="line"><span class="comment">;   max children reached - number of times, the process limit has been reached,</span></span><br><span class="line"><span class="comment">;                          when pm tries to start more children (works only for</span></span><br><span class="line"><span class="comment">;                          pm &#x27;dynamic&#x27; and &#x27;ondemand&#x27;);</span></span><br><span class="line"><span class="comment">; Value are updated in real time.</span></span><br><span class="line"><span class="comment">; Example output:</span></span><br><span class="line"><span class="comment">;   pool:                 www</span></span><br><span class="line"><span class="comment">;   process manager:      static</span></span><br><span class="line"><span class="comment">;   start time:           01/Jul/2011:17:53:49 +0200</span></span><br><span class="line"><span class="comment">;   start since:          62636</span></span><br><span class="line"><span class="comment">;   accepted conn:        190460</span></span><br><span class="line"><span class="comment">;   listen queue:         0</span></span><br><span class="line"><span class="comment">;   max listen queue:     1</span></span><br><span class="line"><span class="comment">;   listen queue len:     42</span></span><br><span class="line"><span class="comment">;   idle processes:       4</span></span><br><span class="line"><span class="comment">;   active processes:     11</span></span><br><span class="line"><span class="comment">;   total processes:      15</span></span><br><span class="line"><span class="comment">;   max active processes: 12</span></span><br><span class="line"><span class="comment">;   max children reached: 0</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; By default the status page output is formatted as text/plain. Passing either</span></span><br><span class="line"><span class="comment">; &#x27;html&#x27;, &#x27;xml&#x27; or &#x27;json&#x27; in the query string will return the corresponding</span></span><br><span class="line"><span class="comment">; output syntax. Example:</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?json</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?html</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?xml</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; By default the status page only outputs short status. Passing &#x27;full&#x27; in the</span></span><br><span class="line"><span class="comment">; query string will also return status for each pool process.</span></span><br><span class="line"><span class="comment">; Example:</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?json&amp;full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?html&amp;full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?xml&amp;full</span></span><br><span class="line"><span class="comment">; The Full status returns for each process:</span></span><br><span class="line"><span class="comment">;   pid                  - the PID of the process;</span></span><br><span class="line"><span class="comment">;   state                - the state of the process (Idle, Running, ...);</span></span><br><span class="line"><span class="comment">;   start time           - the date and time the process has started;</span></span><br><span class="line"><span class="comment">;   start since          - the number of seconds since the process has started;</span></span><br><span class="line"><span class="comment">;   requests             - the number of requests the process has served;</span></span><br><span class="line"><span class="comment">;   request duration     - the duration in µs of the requests;</span></span><br><span class="line"><span class="comment">;   request method       - the request method (GET, POST, ...);</span></span><br><span class="line"><span class="comment">;   request URI          - the request URI with the query string;</span></span><br><span class="line"><span class="comment">;   content length       - the content length of the request (only with POST);</span></span><br><span class="line"><span class="comment">;   user                 - the user (PHP_AUTH_USER) (or &#x27;-&#x27; if not set);</span></span><br><span class="line"><span class="comment">;   script               - the main script called (or &#x27;-&#x27; if not set);</span></span><br><span class="line"><span class="comment">;   last request cpu     - the %cpu the last request consumed</span></span><br><span class="line"><span class="comment">;                          it&#x27;s always 0 if the process is not in Idle state</span></span><br><span class="line"><span class="comment">;                          because CPU calculation is done when the request</span></span><br><span class="line"><span class="comment">;                          processing has terminated;</span></span><br><span class="line"><span class="comment">;   last request memory  - the max amount of memory the last request consumed</span></span><br><span class="line"><span class="comment">;                          it&#x27;s always 0 if the process is not in Idle state</span></span><br><span class="line"><span class="comment">;                          because memory calculation is done when the request</span></span><br><span class="line"><span class="comment">;                          processing has terminated;</span></span><br><span class="line"><span class="comment">; If the process is in Idle state, then informations are related to the</span></span><br><span class="line"><span class="comment">; last request the process has served. Otherwise informations are related to</span></span><br><span class="line"><span class="comment">; the current request being served.</span></span><br><span class="line"><span class="comment">; Example output:</span></span><br><span class="line"><span class="comment">;   ************************</span></span><br><span class="line"><span class="comment">;   pid:                  31330</span></span><br><span class="line"><span class="comment">;   state:                Running</span></span><br><span class="line"><span class="comment">;   start time:           01/Jul/2011:17:53:49 +0200</span></span><br><span class="line"><span class="comment">;   start since:          63087</span></span><br><span class="line"><span class="comment">;   requests:             12808</span></span><br><span class="line"><span class="comment">;   request duration:     1250261</span></span><br><span class="line"><span class="comment">;   request method:       GET</span></span><br><span class="line"><span class="comment">;   request URI:          /test_mem.php?N=10000</span></span><br><span class="line"><span class="comment">;   content length:       0</span></span><br><span class="line"><span class="comment">;   user:                 -</span></span><br><span class="line"><span class="comment">;   script:               /home/fat/web/docs/php/test_mem.php</span></span><br><span class="line"><span class="comment">;   last request cpu:     0.00</span></span><br><span class="line"><span class="comment">;   last request memory:  0</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> There is a real-time FPM status monitoring sample web page available</span></span><br><span class="line"><span class="comment">;       It&#x27;s available in: @EXPANDED_DATADIR@/fpm/status.html</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The value must start with a leading slash (/). The value can be</span></span><br><span class="line"><span class="comment">;       anything, but it may not be a good idea to use the .php extension or it</span></span><br><span class="line"><span class="comment">;       may conflict with a real PHP file.</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;pm.status_path = /status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The ping URI to call the monitoring page of FPM. If this value is not set, no</span></span><br><span class="line"><span class="comment">; URI will be recognized as a ping page. This could be used to test from outside</span></span><br><span class="line"><span class="comment">; that FPM is alive and responding, or to</span></span><br><span class="line"><span class="comment">; - create a graph of FPM availability (rrd or such);</span></span><br><span class="line"><span class="comment">; - remove a server from a group if it is not responding (load balancing);</span></span><br><span class="line"><span class="comment">; - trigger alerts for the operating team (24/7).</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The value must start with a leading slash (/). The value can be</span></span><br><span class="line"><span class="comment">;       anything, but it may not be a good idea to use the .php extension or it</span></span><br><span class="line"><span class="comment">;       may conflict with a real PHP file.</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;ping.path = /ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; This directive may be used to customize the response of a ping request. The</span></span><br><span class="line"><span class="comment">; response is formatted as text/plain with a 200 response code.</span></span><br><span class="line"><span class="comment">; Default Value: pong</span></span><br><span class="line"><span class="comment">;ping.response = pong</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The access log file</span></span><br><span class="line"><span class="comment">; Default: not set</span></span><br><span class="line"><span class="comment">;access.log = log/$pool.access.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The access log format.</span></span><br><span class="line"><span class="comment">; The following syntax is allowed</span></span><br><span class="line"><span class="comment">;  %%: the &#x27;%&#x27; character</span></span><br><span class="line"><span class="comment">;  %C: %CPU used by the request</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;user&#125;C for user CPU only</span></span><br><span class="line"><span class="comment">;      - %&#123;system&#125;C for system CPU only</span></span><br><span class="line"><span class="comment">;      - %&#123;total&#125;C  for user + system CPU (default)</span></span><br><span class="line"><span class="comment">;  %d: time taken to serve the request</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;seconds&#125;d (default)</span></span><br><span class="line"><span class="comment">;      - %&#123;miliseconds&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;mili&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;microseconds&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;micro&#125;d</span></span><br><span class="line"><span class="comment">;  %e: an environment variable (same as $_ENV or $_SERVER)</span></span><br><span class="line"><span class="comment">;      it must be associated with embraces to specify the name of the env</span></span><br><span class="line"><span class="comment">;      variable. Some exemples:</span></span><br><span class="line"><span class="comment">;      - server specifics like: %&#123;REQUEST_METHOD&#125;e or %&#123;SERVER_PROTOCOL&#125;e</span></span><br><span class="line"><span class="comment">;      - HTTP headers like: %&#123;HTTP_HOST&#125;e or %&#123;HTTP_USER_AGENT&#125;e</span></span><br><span class="line"><span class="comment">;  %f: script filename</span></span><br><span class="line"><span class="comment">;  %l: content-length of the request (for POST request only)</span></span><br><span class="line"><span class="comment">;  %m: request method</span></span><br><span class="line"><span class="comment">;  %M: peak of memory allocated by PHP</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;bytes&#125;M (default)</span></span><br><span class="line"><span class="comment">;      - %&#123;kilobytes&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;kilo&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;megabytes&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;mega&#125;M</span></span><br><span class="line"><span class="comment">;  %n: pool name</span></span><br><span class="line"><span class="comment">;  %o: output header</span></span><br><span class="line"><span class="comment">;      it must be associated with embraces to specify the name of the header:</span></span><br><span class="line"><span class="comment">;      - %&#123;Content-Type&#125;o</span></span><br><span class="line"><span class="comment">;      - %&#123;X-Powered-By&#125;o</span></span><br><span class="line"><span class="comment">;      - %&#123;Transfert-Encoding&#125;o</span></span><br><span class="line"><span class="comment">;      - ....</span></span><br><span class="line"><span class="comment">;  %p: PID of the child that serviced the request</span></span><br><span class="line"><span class="comment">;  %P: PID of the parent of the child that serviced the request</span></span><br><span class="line"><span class="comment">;  %q: the query string</span></span><br><span class="line"><span class="comment">;  %Q: the &#x27;?&#x27; character if query string exists</span></span><br><span class="line"><span class="comment">;  %r: the request URI (without the query string, see %q and %Q)</span></span><br><span class="line"><span class="comment">;  %R: remote IP address</span></span><br><span class="line"><span class="comment">;  %s: status (response code)</span></span><br><span class="line"><span class="comment">;  %t: server time the request was received</span></span><br><span class="line"><span class="comment">;      it can accept a strftime(3) format:</span></span><br><span class="line"><span class="comment">;      %d/%b/%Y:%H:%M:%S %z (default)</span></span><br><span class="line"><span class="comment">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span></span><br><span class="line"><span class="comment">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span></span><br><span class="line"><span class="comment">;  %T: time the log has been written (the request has finished)</span></span><br><span class="line"><span class="comment">;      it can accept a strftime(3) format:</span></span><br><span class="line"><span class="comment">;      %d/%b/%Y:%H:%M:%S %z (default)</span></span><br><span class="line"><span class="comment">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span></span><br><span class="line"><span class="comment">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span></span><br><span class="line"><span class="comment">;  %u: remote user</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Default: &quot;%R - %u %t \&quot;%m %r\&quot; %s&quot;</span></span><br><span class="line"><span class="comment">;access.format = &quot;%R - %u %t \&quot;%m %r%Q%q\&quot; %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The log file for slow requests</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> slowlog is mandatory if request_slowlog_timeout is set</span></span><br><span class="line">slowlog = /var/<span class="built_in">log</span>/php-fpm/www-slow.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The timeout for serving a single request after which a PHP backtrace will be</span></span><br><span class="line"><span class="comment">; dumped to the &#x27;slowlog&#x27; file. A value of &#x27;0s&#x27; means &#x27;off&#x27;.</span></span><br><span class="line"><span class="comment">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;request_slowlog_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The timeout for serving a single request after which the worker process will</span></span><br><span class="line"><span class="comment">; be killed. This option should be used when the &#x27;max_execution_time&#x27; ini option</span></span><br><span class="line"><span class="comment">; does not stop script execution for some reason. A value of &#x27;0&#x27; means &#x27;off&#x27;.</span></span><br><span class="line"><span class="comment">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;request_terminate_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set open file descriptor rlimit.</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_files = 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set max core size rlimit.</span></span><br><span class="line"><span class="comment">; Possible Values: &#x27;unlimited&#x27; or an integer greater or equal to 0</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_core = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Chroot to this directory at the start. This value must be defined as an</span></span><br><span class="line"><span class="comment">; absolute path. When this value is not set, chroot is not used.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> chrooting is a great security feature and should be used whenever</span></span><br><span class="line"><span class="comment">;       possible. However, all PHP paths will be relative to the chroot</span></span><br><span class="line"><span class="comment">;       (error_log, sessions.save_path, ...).</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;chroot =</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Chdir to this directory at the start.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> relative path can be used.</span></span><br><span class="line"><span class="comment">; Default Value: current directory or / when chroot</span></span><br><span class="line"><span class="comment">;chdir = /var/www</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Redirect worker stdout and stderr into main error log. If not set, stdout and</span></span><br><span class="line"><span class="comment">; stderr will be redirected to /dev/null according to FastCGI specs.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> on highloaded environement, this can cause some delay in the page</span></span><br><span class="line"><span class="comment">; process time (several ms).</span></span><br><span class="line"><span class="comment">; Default Value: no</span></span><br><span class="line"><span class="comment">;catch_workers_output = yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Clear environment in FPM workers</span></span><br><span class="line"><span class="comment">; Prevents arbitrary environment variables from reaching FPM worker processes</span></span><br><span class="line"><span class="comment">; by clearing the environment in workers before env vars specified in this</span></span><br><span class="line"><span class="comment">; pool configuration are added.</span></span><br><span class="line"><span class="comment">; Setting to &quot;no&quot; will make all environment variables available to PHP code</span></span><br><span class="line"><span class="comment">; via getenv(), $_ENV and $_SERVER.</span></span><br><span class="line"><span class="comment">; Default Value: yes</span></span><br><span class="line"><span class="comment">;clear_env = no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Limits the extensions of the main script FPM will allow to parse. This can</span></span><br><span class="line"><span class="comment">; prevent configuration mistakes on the web server side. You should only limit</span></span><br><span class="line"><span class="comment">; FPM to .php extensions to prevent malicious users to use other extensions to</span></span><br><span class="line"><span class="comment">; exectute php code.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> set an empty value to allow all extensions.</span></span><br><span class="line"><span class="comment">; Default Value: .php</span></span><br><span class="line"><span class="comment">;security.limit_extensions = .php .php3 .php4 .php5 .php7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from</span></span><br><span class="line"><span class="comment">; the current environment.</span></span><br><span class="line"><span class="comment">; Default Value: clean env</span></span><br><span class="line"><span class="comment">;env[HOSTNAME] = $HOSTNAME</span></span><br><span class="line"><span class="comment">;env[PATH] = /usr/local/bin:/usr/bin:/bin</span></span><br><span class="line"><span class="comment">;env[TMP] = /tmp</span></span><br><span class="line"><span class="comment">;env[TMPDIR] = /tmp</span></span><br><span class="line"><span class="comment">;env[TEMP] = /tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Additional php.ini defines, specific to this pool of workers. These settings</span></span><br><span class="line"><span class="comment">; overwrite the values previously defined in the php.ini. The directives are the</span></span><br><span class="line"><span class="comment">; same as the PHP SAPI:</span></span><br><span class="line"><span class="comment">;   php_value/php_flag             - you can set classic ini defines which can</span></span><br><span class="line"><span class="comment">;                                    be overwritten from PHP call &#x27;ini_set&#x27;.</span></span><br><span class="line"><span class="comment">;   php_admin_value/php_admin_flag - these directives won&#x27;t be overwritten by</span></span><br><span class="line"><span class="comment">;                                     PHP call &#x27;ini_set&#x27;</span></span><br><span class="line"><span class="comment">; For php_*flag, valid values are on, off, 1, 0, true, false, yes or no.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Defining &#x27;extension&#x27; will load the corresponding shared extension from</span></span><br><span class="line"><span class="comment">; extension_dir. Defining &#x27;disable_functions&#x27; or &#x27;disable_classes&#x27; will not</span></span><br><span class="line"><span class="comment">; overwrite previously defined php.ini values, but will append the new value</span></span><br><span class="line"><span class="comment">; instead.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Default Value: nothing is defined by default except the values in php.ini and</span></span><br><span class="line"><span class="comment">;                specified at startup with the -d argument</span></span><br><span class="line"><span class="comment">;php_admin_value[sendmail_path] = /usr/sbin/sendmail -t -i -f www@my.domain.com</span></span><br><span class="line"><span class="comment">;php_flag[display_errors] = off</span></span><br><span class="line">php_admin_value[error_log] = /var/<span class="built_in">log</span>/php-fpm/www-error.<span class="built_in">log</span></span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line"><span class="comment">;php_admin_value[memory_limit] = 128M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set session path to a directory owned by process user</span></span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path]    = /var/lib/php/session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcache</span><br></pre></td></tr></table></figure>



<p>配置main.yml</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim roles/wordpress/tasks/main.yml</span><br><span class="line"></span><br><span class="line">- name: Update yum dependency</span><br><span class="line">  shell: <span class="string">&#x27;yum update -y warn=False&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Disable</span><span class="built_in"> system </span>firewall</span><br><span class="line">  service: <span class="attribute">name</span>=firewalld <span class="attribute">state</span>=stopped</span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Disable</span> SELINX</span><br><span class="line">  selinux: <span class="attribute">state</span>=disabled</span><br><span class="line"></span><br><span class="line">- name: Setup epel yum source <span class="keyword">for</span> nginx <span class="keyword">and</span> mariadb(mysql)</span><br><span class="line">  yum: <span class="attribute">pkg</span>=epel-release <span class="attribute">state</span>=latest</span><br><span class="line"></span><br><span class="line">- name: Setup webtatic yum source <span class="keyword">for</span> php-fpm</span><br><span class="line">  yum: <span class="attribute">name</span>=https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line"></span><br><span class="line">- name: Ensure nginx is at the latest version</span><br><span class="line">  yum: <span class="attribute">pkg</span>=nginx <span class="attribute">state</span>=latest</span><br><span class="line"></span><br><span class="line">- name: Write the nginx<span class="built_in"> config </span>file</span><br><span class="line">  template: <span class="attribute">src</span>=roles/wordpress/templates/nginx.conf.j2 <span class="attribute">dest</span>=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">- name: Create nginx root folder</span><br><span class="line">  file: <span class="string">&#x27;path=&#123;&#123; root &#125;&#125; state=directory owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125; mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Copy info.php <span class="keyword">to</span> remote</span><br><span class="line">  copy: <span class="string">&#x27;remote_src=no src=roles/wordpress/files/info.php dest=/data/www/info.php mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart nginx service</span><br><span class="line">  service: <span class="attribute">name</span>=nginx <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: Setup php-fpm</span><br><span class="line">  command: <span class="string">&#x27;yum install -y php70w php70w-fpm php70w-common php70w-mysql php70w-gd php70w-xml php70w-mbstring php70w-mcrypt warn=False&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: <span class="attribute">name</span>=php-fpm <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: Copy php-fpm<span class="built_in"> config </span>file <span class="keyword">to</span> remote</span><br><span class="line">  copy: <span class="string">&#x27;remote_src=no src=roles/wordpress/files/www.conf dest=/etc/php-fpm.d/www.conf mode=0755 owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125; force=yes&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: <span class="attribute">name</span>=php-fpm <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Run</span> the<span class="built_in"> health </span>check locally</span><br><span class="line">  shell: <span class="string">&quot;sh roles/wordpress/files/health_check.sh &#123;&#123; server_name &#125;&#125; &#123;&#123; port &#125;&#125;&quot;</span></span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: <span class="attribute">msg</span>=<span class="string">&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">- name: Setup mariadb(mysql)</span><br><span class="line">  command: <span class="string">&quot;yum install -y mariadb mariadb-server warn=False&quot;</span></span><br><span class="line"></span><br><span class="line">- name: Backup current www folder</span><br><span class="line">  shell: <span class="string">&#x27;mv &#123;&#123; root &#125;&#125; &#123;&#123; backup_to &#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Close git ssl verification</span><br><span class="line">  shell: <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Clone WordPress repo <span class="keyword">to</span> remote</span><br><span class="line">  git: <span class="string">&quot;repo=https://&#123;&#123; gitlab_user | urlencode &#125;&#125;:&#123;&#123; gitlab_pass | urlencode &#125;&#125;@gitlab.example.com/root/Wordpress-project.git dest=/data/www version=&#123;&#123; branch &#125;&#125;&quot;</span></span><br><span class="line">  when: project == <span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Change www folder permission</span><br><span class="line">  file: <span class="string">&quot;path=/data/www mode=0755 owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<p>配置nginx.conf.j2</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/wordpress/</span>templates/nginx.conf.j2</span><br><span class="line"><span class="comment"># For more information on configuration, see: </span></span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>error.log;  </span><br><span class="line">  </span><br><span class="line">pid        <span class="regexp">/var/</span>run/nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       <span class="regexp">/etc/</span>nginx/mime.types;  </span><br><span class="line">    default_type  application/octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span>  </span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span>  </span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    access_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    <span class="comment">#tcp_nopush     on;  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">#keepalive_timeout  0;  </span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">#gzip  on;  </span></span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Load config files from the /etc/nginx/conf.d directory  </span></span><br><span class="line">    <span class="comment"># The default server is in conf.d/default.conf  </span></span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;  </span></span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;  </span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;  </span><br><span class="line">        root         &#123;&#123; root &#125;&#125;;</span><br><span class="line">        <span class="comment">#charset koi8-r;  </span></span><br><span class="line">  </span><br><span class="line">        location / &#123;  </span><br><span class="line">            index  index.html index.htm index.php;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            try_files <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">            fastcgi_pass unix:<span class="regexp">/var/</span>run<span class="regexp">/php-fpm/</span>php-fpm.sock;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">            fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地提交</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ pwd</span><br><span class="line"><span class="regexp">/c/U</span>sers<span class="regexp">/xueji/</span>Desktop<span class="regexp">/repo/</span>ansible-playbook-repo/wordpress_playbooks</span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/deploy.retry.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/deploy.yml.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/inventory/</span>dev.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/inventory/</span>prod.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>health_check.sh.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/m</span>ain.yml.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>www.conf.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/templates/</span>nginx.conf.j2.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;first commit&quot;</span></span><br><span class="line">[master c526626] first commit</span><br><span class="line"> <span class="number">9</span> files changed, <span class="number">564</span> insertions(+)</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks/deploy.retry</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks/deploy.yml</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/inventory/</span>dev</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/inventory/</span>prod</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>health_check.sh</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/m</span>ain.yml</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>www.conf</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/templates/</span>nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git <span class="keyword">push</span> origin master</span><br><span class="line">Enumerating objects: <span class="number">17</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">17</span>/<span class="number">17</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">13</span>/<span class="number">13</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">16</span><span class="regexp">/16), 8.48 KiB | 1.70 MiB/</span>s, done.</span><br><span class="line">Total <span class="number">16</span> (delta <span class="number">1</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo.git</span></span><br><span class="line">   <span class="number">06431</span>dc..c526626  master -&gt; master</span><br></pre></td></tr></table></figure>



<p>返回gitlab查看</p>
<p>93776</p>
<p>创建Wordpress-project仓库并提交本地代码到gitlab</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git -c http.sslVerify=<span class="keyword">false</span> clone https:<span class="comment">//gitlab.example.com/root/Wordpress-project.git</span></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git add .</span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git <span class="keyword">push</span> origin master</span><br></pre></td></tr></table></figure>



<p>登录到Jenkins web管理页</p>
<p>点击“New 任务”</p>
<p>95489</p>
<p>添加描述</p>
<p>95591</p>
<p>在如下输入框中输入</p>
<p>95700</p>
<p>pipeline script脚本内容（注意credentialsId要查看本地设置的凭据中的ID，复制过来替换掉即可）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label <span class="string">&#x27;master&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        <span class="attribute">PATH</span>=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            choices: <span class="string">&#x27;dev\nrprod&#x27;</span>,</span><br><span class="line">            description: <span class="string">&#x27;Choose deploy environment&#x27;</span>,</span><br><span class="line">            name: <span class="string">&#x27;deploy_env&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        string (name: <span class="string">&#x27;branch&#x27;</span>, defaultValue: <span class="string">&#x27;master&#x27;</span>, description: <span class="string">&#x27;Fill in your ansible repo branch&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage (<span class="string">&quot;Pull deploy code&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line">                dir (<span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>&quot;</span>)&#123;</span><br><span class="line">                    git branch: <span class="string">&#x27;master&#x27;</span>, credentialsId: <span class="string">&#x27;&#x27;</span>, url: <span class="string">&#x27;https://gitlab.example.com/root/ansible-playbook-repo.git&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (<span class="string">&quot;Check env&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                set +x</span></span><br><span class="line"><span class="string">                user=`whoami`</span></span><br><span class="line"><span class="string">                if [ <span class="variable">$user</span> == deploy ]</span></span><br><span class="line"><span class="string">                then</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current deployment<span class="built_in"> user </span>is <span class="variable">$user</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current python version<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    python --version</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current ansible version<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ansible-playbook --version</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Remote<span class="built_in"> system </span>disk space<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ssh root@test.example.com df -h</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Rmote<span class="built_in"> system </span>RAM<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ssh root@test.example.com free -m</span></span><br><span class="line"><span class="string">                else</span></span><br><span class="line"><span class="string">                    echo &quot;</span>Deployment<span class="built_in"> user </span>is incorrect, please check<span class="string">&quot;</span></span><br><span class="line"><span class="string">                fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                set -x</span></span><br><span class="line"><span class="string">                &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (<span class="string">&quot;Anisble deployment&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                input <span class="string">&quot;Do you approve the deployment?&quot;</span></span><br><span class="line">                dir(<span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/wordpress_playbooks&quot;</span>)&#123;</span><br><span class="line">                    echo <span class="string">&quot;[INFO] Start deployment&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                    set +x</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">                    ansible-playbook -i inventory/<span class="variable">$deploy_env</span> ./deploy.yml -e project=wordpress -e branch=<span class="variable">$branch</span> -e env=<span class="variable">$deploy_env</span></span></span><br><span class="line"><span class="string">                    set -x</span></span><br><span class="line"><span class="string">                    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">                    echo <span class="string">&quot;[INFO] Deployment finished...&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>凭据ID</p>
<p>105855</p>
<p>点击查看输出信息</p>
<p>105964</p>
<p>106060</p>
<p>(正常情况下)稍等片刻之后就会看到“SUCCESS”(注意首次构建可能会提示“No such property: deploy_env for class: groovy.lang.Binding”)遇到这个错误，只需返回到word press-pipeline-job工程点击“Build with Parameters”选择默认dev用户再次构建即可。</p>
<p>（纸上得来终觉浅，绝知此事要躬行，真的是各种采坑）久违的“SUCCESS”</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">Do you approve the deployment?</span><br><span class="line">Proceed or Abort</span><br><span class="line"></span><br><span class="line">Approved by admin</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in /var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress<span class="emphasis">_playbooks</span></span><br><span class="line"><span class="emphasis">[Pipeline] &#123;</span></span><br><span class="line"><span class="emphasis">[Pipeline] echo</span></span><br><span class="line"><span class="emphasis">[INFO] Start deployment</span></span><br><span class="line"><span class="emphasis">[Pipeline] sh</span></span><br><span class="line"><span class="emphasis">+ set +x</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">PLAY [wordpress] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [Gathering Facts] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : install git] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Update yum dependency] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Disable system firewall] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Disable SELINX] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Setup epel yum source for nginx and mariadb(mysql)] <span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Setup webtatic yum source for php-fpm] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : Ensure nginx is at the latest version] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">ok: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Write the nginx config file] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">ok: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Create nginx root folder] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Copy info.php to remote] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Restart nginx service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Setup php-fpm] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Restart php-fpm service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Copy php-fpm config file to remote] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Restart php-fpm service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : Run the health check locally] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">changed: [test.example.com -&gt; localhost]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : debug] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">ok: [test.example.com] =&gt; &#123;</span></span><br><span class="line"><span class="emphasis">    &quot;msg&quot;: &quot;The remote side is healthy&quot;</span></span><br><span class="line"><span class="emphasis">&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Setup mariadb(mysql)] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Backup current www folder] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Close git ssl verification] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Clone WordPress repo to remote] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Change www folder permission] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">PLAY RECAP <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">test.example.com           : ok=23   changed=14   unreachable=0    failed=0   </span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] echo</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[INFO] Deployment finished...</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // dir</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // stage</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // withEnv</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // node</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] End of Pipeline</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Finished: SUCCESS</span></span></span><br></pre></td></tr></table></figure>



<p>最后需要利用git bash或者xshell登录test.example.com主机上初始化MySQL数据库，（实际生产环境中不建议使用Jenkins重复构建初始化MySQL数据库，容易出现各种问题）</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]<span class="meta"># systemctl status mariadb</span></span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (/usr/<span class="keyword">lib</span>/systemd/system/mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@test ~]<span class="meta"># systemctl start mariadb</span></span><br><span class="line">[root@test ~]<span class="meta"># mysql_secure_installation</span></span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS <span class="keyword">OF</span> THIS SCRIPT <span class="keyword">IS</span> RECOMMENDED <span class="keyword">FOR</span> ALL MariaDB</span><br><span class="line">      SERVERS <span class="keyword">IN</span> PRODUCTION USE!  PLEASE READ <span class="keyword">EACH</span> <span class="keyword">STEP</span> CAREFULLY!</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> log <span class="keyword">into</span> MariaDB <span class="keyword">to</span> secure it, we<span class="comment">&#x27;ll need the current</span></span><br><span class="line">password <span class="keyword">for</span> the root user.  <span class="keyword">If</span> you<span class="comment">&#x27;ve just installed MariaDB, and</span></span><br><span class="line">you haven<span class="comment">&#x27;t set the root password yet, the password will be blank,</span></span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):   <span class="meta">#mariadb5.5首次安装没有root密码，所以直接回车即可</span></span><br><span class="line">OK, successfully used password, moving <span class="keyword">on</span>...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log <span class="keyword">into</span> the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> root password? [Y/n] y</span><br><span class="line"><span class="keyword">New</span> password:   <span class="meta">#123456</span></span><br><span class="line">Re-enter <span class="keyword">new</span> password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">By</span> <span class="keyword">default</span>, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line"><span class="keyword">to</span> log <span class="keyword">into</span> MariaDB without having <span class="keyword">to</span> have a user account created <span class="keyword">for</span></span><br><span class="line">them.  This <span class="keyword">is</span> intended only <span class="keyword">for</span> testing, <span class="keyword">and</span> <span class="keyword">to</span> make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving <span class="keyword">into</span> a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed <span class="keyword">to</span> connect <span class="keyword">from</span> <span class="comment">&#x27;localhost&#x27;.  This</span></span><br><span class="line">ensures that someone cannot guess at the root password <span class="keyword">from</span> the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"><span class="keyword">By</span> <span class="keyword">default</span>, MariaDB comes <span class="keyword">with</span> a database named <span class="comment">&#x27;test&#x27; that anyone can</span></span><br><span class="line">access.  This <span class="keyword">is</span> also intended only <span class="keyword">for</span> testing, <span class="keyword">and</span> should be removed</span><br><span class="line">before moving <span class="keyword">into</span> a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database <span class="keyword">and</span> access <span class="keyword">to</span> it? [Y/n] y</span><br><span class="line"> - Dropping test database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges <span class="keyword">on</span> test database...</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will <span class="keyword">take</span> effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  <span class="keyword">If</span> you<span class="comment">&#x27;ve completed all of the above steps, your MariaDB</span></span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks <span class="keyword">for</span> <span class="keyword">using</span> MariaDB!</span><br></pre></td></tr></table></figure>



<p>创建wordpress数据库</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# mysql -uroot -p123456</span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands end with ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MariaDB<span class="built_in"> connection </span>id is 10</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help.<span class="built_in"> Type </span><span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database wordpress character <span class="builtin-name">set</span> utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; \q</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>



<p>浏览器登录</p>
<p>141278</p>
<p>141374</p>
<p>141470</p>
<p>141566</p>
<p>141661</p>
<p>141756</p>
<p>141852</p>
<p>查看首页</p>
<p>141953</p>
<p>至此，使用Jenkins+Gitlab+Ansible自动化部署wordpresss全部完成。</p>
<p>接下来说说注意点，尽量避免以后重蹈覆辙：</p>
<p>第一次没有上传Wordpress-project仓库，也没有配置test.example.com主机上的/etc/hosts文件，导致在部署过程中一直卡在某个环节不动，或者直接提示</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Clone WordPress repo to remote] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span><br><span class="line"><span class="strong">fatal: [test.example.com]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;cmd&quot;: &quot;/usr/bin/git clone --origin origin &#x27;https://root:**</span><span class="strong">****</span><span class="strong">**@gitlab.example.com/root/Wordpress-project.git&#x27; /data/www&quot;, &quot;msg&quot;: &quot;fatal: unable to access &#x27;https://root:**</span><span class="strong">****</span><span class="strong">**@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error&quot;, &quot;rc&quot;: 128, &quot;stderr&quot;: &quot;fatal: unable to access &#x27;https://root:12345678@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error\n&quot;, &quot;stderr<span class="emphasis">_lines&quot;: [&quot;fatal: unable to access &#x27;https://root:12345678@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error&quot;], &quot;stdout&quot;: &quot;Cloning into &#x27;/data/www&#x27;...\n&quot;, &quot;stdout_</span>lines&quot;: [&quot;Cloning into &#x27;/data/www&#x27;...&quot;]&#125;</span></span><br><span class="line"><span class="strong">    to retry, use: --limit @/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress<span class="emphasis">_playbooks/deploy.retry</span></span></span><br><span class="line"><span class="strong"><span class="emphasis"></span></span></span><br><span class="line"><span class="strong"><span class="emphasis">PLAY RECAP <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span><br></pre></td></tr></table></figure>

<p>145024</p>
<p>错误信息2</p>
<p>ansible-playbook-repo仓库中没有info.php文件，所以抛出以下异常</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line">An exception occurred during task execution. To see the full traceback, use -vvv. The error was:     <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: false, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Could not find or access &#x27;roles/wordpress/files/info.php&#x27;\nSearched in:\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/files/info.php&quot;</span>&#125;</span><br><span class="line">    to retry, use: --limit @<span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks/deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok=<span class="number">9</span>    changed=<span class="number">4</span>    unreachable=<span class="number">0</span>    failed=<span class="number">1</span>   </span><br><span class="line"></span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line"></span><br><span class="line">[Pipeline] <span class="regexp">//</span> withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">ERROR: script returned <span class="keyword">exit</span> code <span class="number">2</span></span><br></pre></td></tr></table></figure>



<p>错误信息3</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Setup webtatic yum source <span class="keyword">for</span> php-fpm] ***********************</span><br><span class="line">Sending interrupt signal to process</span><br><span class="line">Aborted by admin</span><br><span class="line">fatal: [test.example.com]: UNREACHABLE! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: false, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Failed to connect to the host via ssh: Shared connection to test.example.com closed.\r\n&quot;</span>, <span class="string">&quot;unreachable&quot;</span>: true&#125;</span><br><span class="line"><span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks@tmp<span class="regexp">/durable-55384134/</span>script.sh: line <span class="number">5</span>: <span class="number">22534</span> Terminated              ansible-playbook -i inventory<span class="regexp">/dev ./</span>deploy.yml -e project=wordpress -e branch=master -e env=dev</span><br><span class="line">script returned <span class="keyword">exit</span> code <span class="number">143</span></span><br></pre></td></tr></table></figure>



<p>错误信息4</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;&quot;<span class="attribute">changed&quot;</span>: true, &quot;cmd&quot;: &quot;yum install git&quot;, &quot;delta&quot;: &quot;0:00:04.471168&quot;, &quot;end&quot;: &quot;2019-01-10 18:05:37.319608&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 1, &quot;start&quot;: &quot;2019-01-10 18:05:32.848440&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;stderr_lines&quot;: [], &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * epel: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * extras: mirrors.163<span class="variable">.com</span>\n * updates: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * webtatic: us-east<span class="variable">.repo</span><span class="variable">.webtatic</span><span class="variable">.com</span>\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package git<span class="variable">.x</span>86_64 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed\n--&gt; Processing Dependency: perl-Git = 1.8.3.1-20<span class="variable">.el</span>7 for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Running transaction check\n---&gt; Package perl-Error<span class="variable">.noarch</span> 1:0.17020-2<span class="variable">.el</span>7 will be installed\n---&gt; Package perl-Git<span class="variable">.noarch</span> 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed\n---&gt; Package perl-TermReadKey<span class="variable">.x</span>86_64 0:2.30-20<span class="variable">.el</span>7 will be installed\n---&gt; Package rsync<span class="variable">.x</span>86_64 0:3.1.2-4<span class="variable">.el</span>7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package                Arch         Version                Repository     Size\n================================================================================\nInstalling:\n git                    x86_64       1.8.3.1-20<span class="variable">.el</span>7         updates       4.4 M\nInstalling for dependencies:\n perl-Error             noarch       1:0.17020-2<span class="variable">.el</span>7        base           32 k\n perl-Git               noarch       1.8.3.1-20<span class="variable">.el</span>7         updates        55 k\n perl-TermReadKey       x86_64       2.30-20<span class="variable">.el</span>7            base           31 k\n rsync                  x86_64       3.1.2-4<span class="variable">.el</span>7            base          403 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package (+4 Dependent packages)\n\nTotal download size: 4.9 M\nInstalled size: 23 M\nIs this ok [y/d/N]: Exiting on user command\nYour transaction was saved, rerun it with:\n yum load-transaction /tmp/yum_save_tx.2019-01-10.18-05<span class="variable">.jmunIG</span><span class="variable">.yumtx</span>&quot;, &quot;stdout_lines&quot;: [&quot;Loaded plugins: fastestmirror&quot;, &quot;Loading mirror speeds from cached hostfile&quot;, &quot; * base: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * epel: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * extras: mirrors.163<span class="variable">.com</span>&quot;, &quot; * updates: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * webtatic: us-east<span class="variable">.repo</span><span class="variable">.webtatic</span><span class="variable">.com</span>&quot;, &quot;Resolving Dependencies&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package git<span class="variable">.x</span>86_64 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed&quot;, &quot;--&gt; Processing Dependency: perl-Git = 1.8.3.1-20<span class="variable">.el</span>7 for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package perl-Error<span class="variable">.noarch</span> 1:0.17020-2<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package perl-Git<span class="variable">.noarch</span> 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package perl-TermReadKey<span class="variable">.x</span>86_64 0:2.30-20<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package rsync<span class="variable">.x</span>86_64 0:3.1.2-4<span class="variable">.el</span>7 will be installed&quot;, &quot;--&gt; Finished Dependency Resolution&quot;, &quot;&quot;, &quot;Dependencies Resolved&quot;, &quot;&quot;, &quot;================================================================================&quot;, &quot; Package                Arch         Version                Repository     Size&quot;, &quot;================================================================================&quot;, &quot;Installing:&quot;, &quot; git                    x86_64       1.8.3.1-20<span class="variable">.el</span>7         updates       4.4 M&quot;, &quot;Installing for dependencies:&quot;, &quot; perl-Error             noarch       1:0.17020-2<span class="variable">.el</span>7        base           32 k&quot;, &quot; perl-Git               noarch       1.8.3.1-20<span class="variable">.el</span>7         updates        55 k&quot;, &quot; perl-TermReadKey       x86_64       2.30-20<span class="variable">.el</span>7            base           31 k&quot;, &quot; rsync                  x86_64       3.1.2-4<span class="variable">.el</span>7            base          403 k&quot;, &quot;&quot;, &quot;Transaction Summary&quot;, &quot;================================================================================&quot;, &quot;Install  1 Package (+4 Dependent packages)&quot;, &quot;&quot;, &quot;Total download size: 4.9 M&quot;, &quot;Installed size: 23 M&quot;, &quot;Is this ok [y/d/N]: Exiting on user command&quot;, &quot;Your transaction was saved, rerun it with:&quot;, &quot; yum load-transaction /tmp/yum_save_tx.2019-01-10.18-05<span class="variable">.jmunIG</span><span class="variable">.yumtx</span>&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/deploy<span class="variable">.retry</span></span><br></pre></td></tr></table></figure>

<p>错误信息5</p>
<p>这个报错是在错误信息4之前，因为test.example.com主机没有git命令所以才有了错误信息4的步骤</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TASK</span> [wordpress : Close git ssl verification] **********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: <span class="keyword">true</span>, <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;git config --global http.sslVerify false&quot;</span>, <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.002747&quot;</span>, <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2019-01-10 18:00:36.334202&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;non-zero return code&quot;</span>, <span class="string">&quot;rc&quot;</span>: <span class="number">127</span>, <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2019-01-10 18:00:36.331455&quot;</span>, <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;/bin/sh: git: command not found&quot;</span>, <span class="string">&quot;stderr_lines&quot;</span>: [<span class="string">&quot;/bin/sh: git: command not found&quot;</span>], <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;stdout_lines&quot;</span>: []&#125;</span><br><span class="line">    to retry, use: --limit @<span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks/deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息6</p>
<p>这个变量没有在deploy.yml中定义，所以会抛出异常解决办法就是在deploy.yml中声明以下backup_to</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line"><span class="symbol">fatal:</span> [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;The task includes an option with an undefined variable. The error was: &#x27;backup_to&#x27; is undefined\n\nThe error appears to have been in &#x27;/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/main.yml&#x27;: line 53, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Backup current www folder\n  ^ here\n&quot;</span>&#125;</span><br><span class="line">    to retry, <span class="symbol">use:</span> --limit @/var/<span class="class"><span class="keyword">lib</span>/<span class="title">jenkins</span>/<span class="title">workspace</span>/<span class="title">wordpress</span>-<span class="title">pipeline</span>-<span class="title">job</span>/<span class="title">wordpress_playbooks</span>/<span class="title">deploy</span>.<span class="title">retry</span></span></span><br></pre></td></tr></table></figure>

<p>deploy.yml中添加颜色加重部分</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">     <span class="attr">backup_to:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;root&#125;&#125;</span>_<span class="template-variable">&#123;&#123;branch&#125;&#125;</span>_<span class="template-variable">&#123;&#123;ansible_date_time.epoch&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wordpress</span></span><br></pre></td></tr></table></figure>



<p>解决过程中还遇到一个git提交错误</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/roles/wordpress/files/info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git <span class="keyword">commit</span> -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">[<span class="keyword">master</span> eab3d83] <span class="keyword">first</span> <span class="keyword">commit</span></span><br><span class="line"> <span class="number">1</span> <span class="keyword">file</span> <span class="keyword">changed</span>, <span class="number">0</span> insertions(+), <span class="number">0</span> deletions(-)</span><br><span class="line"> <span class="keyword">rename</span> wordpress_playbooks/<span class="keyword">roles</span>/wordpress/files/&#123;index.php =&gt; info.php&#125; (<span class="number">100</span>%)</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (<span class="keyword">master</span>)</span><br><span class="line">$ git push origin <span class="keyword">master</span></span><br><span class="line"><span class="keyword">To</span> https://gitlab.example.com/root/ansible-playbook-repo.git</span><br><span class="line"> ! [rejected]        <span class="keyword">master</span> -&gt; <span class="keyword">master</span> (<span class="keyword">fetch</span> <span class="keyword">first</span>)</span><br><span class="line"><span class="keyword">error</span>: <span class="keyword">failed</span> <span class="keyword">to</span> push <span class="keyword">some</span> refs <span class="keyword">to</span> <span class="string">&#x27;https://gitlab.example.com/root/ansible-playbook-repo.git&#x27;</span></span><br><span class="line">hint: Updates were rejected because the remote contains <span class="keyword">work</span> that you <span class="keyword">do</span></span><br><span class="line">hint: <span class="keyword">not</span> have locally. This <span class="keyword">is</span> usually caused <span class="keyword">by</span> another repository pushing</span><br><span class="line">hint: <span class="keyword">to</span> the same ref. You may want <span class="keyword">to</span> <span class="keyword">first</span> integrate the remote changes</span><br><span class="line">hint: (e.g., <span class="string">&#x27;git pull ...&#x27;</span>) <span class="keyword">before</span> pushing again.</span><br><span class="line">hint: See the <span class="string">&#x27;Note about fast-forwards&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;git push --help&#x27;</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>



<p>解决办法是，在推送到远端之前，先pull一下，然后再提交</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git pull origin master</span><br><span class="line">remote: Enumerating objects: <span class="number">1</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">1</span>/<span class="number">1</span>), done.</span><br><span class="line">remote: Total <span class="number">1</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">1</span>/<span class="number">1</span>), done.</span><br><span class="line">From https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo</span></span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   <span class="number">2</span>dc88b0.<span class="number">.5</span>ea65a4  master     -&gt; origin/master</span><br><span class="line">Already up to date!</span><br><span class="line">Merge made by the <span class="string">&#x27;recursive&#x27;</span> strategy.</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: <span class="number">12</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">12</span>/<span class="number">12</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">6</span>/<span class="number">6</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">7</span>/<span class="number">7</span>), <span class="number">648</span> bytes | <span class="number">648.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">7</span> (delta <span class="number">4</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo.git</span></span><br><span class="line">   <span class="number">5</span>ea65a4.<span class="number">.6127999</span>  master -&gt; master</span><br></pre></td></tr></table></figure>
    </div>
    
    
    

    <footer class="post-footer">
          

  <div class="followme">
    <span>欢迎关注我的其它发布渠道</span>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>

          <div class="post-tags">
              <a href="/sugw.github.io/tags/%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/" rel="tag"># 自动部署</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/" rel="prev" title="Jenkins+Gitlab+Ansible自动化部署(五)">
                  <i class="fa fa-chevron-left"></i> Jenkins+Gitlab+Ansible自动化部署(五)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/12/01/datagrip/" rel="next" title="datagrip">
                  datagrip <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏国伟</span>
</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">271k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:07</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>

    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="//cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
<script src="/sugw.github.io/js/utils.js"></script><script src="/sugw.github.io/js/motion.js"></script><script src="/sugw.github.io/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/sugw.github.io/js/local-search.js"></script>












  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: "/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/",
    }, {"enable":true,"appId":"Rvi5XTbIGoBGqGhM3SdPXNnc-gzGzoHsz","appKey":"tsLwTwnG13sIxCOXRrDVxPqW","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});
</script>

    </div>
<!-- hexo injector body_end start --><script src="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/js/index.js"></script><div id="widget-tree">
      <ul><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Jenkins/">Jenkins</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/23/Jenkins%20pipeline%20%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%A4%9A%E5%88%86%E6%94%AF%E5%8F%91%E7%89%88/" title="Jenkins pipeline 多服务器，多分支发版"><i class="post-icon gg-file-document"></i>Jenkins pipeline 多服务器，多分支发版</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/" title="Jenkins+Gitlab+Ansible自动化部署(三)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(三)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/" title="Jenkins+Gitlab+Ansible自动化部署(五)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(五)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/" title="Jenkins-pipeline的创建和参数传递"><i class="post-icon gg-file-document"></i>Jenkins-pipeline的创建和参数传递</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/" title="Jenkins+Gitlab+Ansible自动化部署(四)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(四)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/" title="Jenkins+Gitlab+Ansible自动化部署(一)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(一)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%8C)/" title="Jenkins+Gitlab+Ansible自动化部署(二)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(二)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/" title="Jenkins+Gitlab+Ansible自动化部署(六)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(六)</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Linux/">Linux</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/28/Firewalld/" title="Firewalld"><i class="post-icon gg-file-document"></i>Firewalld</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/28/centos6.8%20%E5%AE%89%E8%A3%85supervisor/" title="centos6.8 安装supervisor"><i class="post-icon gg-file-document"></i>centos6.8 安装supervisor</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/20/linux%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96/" title="linux内核优化"><i class="post-icon gg-file-document"></i>linux内核优化</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/21/linux%20%E7%A3%81%E7%9B%98%E6%BB%A1/" title="linux 磁盘"><i class="post-icon gg-file-document"></i>linux 磁盘</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/03/Centos67%20%E5%AE%89%E8%A3%85PHP7.3%E6%95%99%E7%A8%8B/" title="Centos6/7 安装PHP7.3教程"><i class="post-icon gg-file-document"></i>Centos6/7 安装PHP7.3教程</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Mac/">Mac</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/26/mac%20for%20supervisor/" title="Mac start hexo for supervisor"><i class="post-icon gg-file-document"></i>Mac start hexo for supervisor</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/PHP/">PHP</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/PHP-FPM%20%E8%AE%BE%E7%BD%AE%E5%A4%9Apool%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99/" title="PHP-FPM 设置多pool、配置文件重写"><i class="post-icon gg-file-document"></i>PHP-FPM 设置多pool、配置文件重写</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/PHP-php-fpm%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/" title="PHP-php-fpm配置优化"><i class="post-icon gg-file-document"></i>PHP-php-fpm配置优化</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/ansible/">ansible</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/20/ansible%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/" title="ansible定时任务和用户组模块使用"><i class="post-icon gg-file-document"></i>ansible定时任务和用户组模块使用</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/wiki/">wiki</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%20lockdown%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" title="mediawiki lockdown权限配置"><i class="post-icon gg-file-document"></i>mediawiki lockdown权限配置</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%E5%AE%89%E8%A3%85/" title="mediawiki安装"><i class="post-icon gg-file-document"></i>mediawiki安装</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%E6%82%AC%E6%B5%AE%E7%9B%AE%E5%BD%95/" title="mediawiki悬浮目录"><i class="post-icon gg-file-document"></i>mediawiki悬浮目录</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E4%BC%98%E5%8C%96/">优化</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/12/nginx%20%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E7%BC%93%E5%AD%98/" title="nginx 静态网站缓存"><i class="post-icon gg-file-document"></i>nginx 静态网站缓存</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/12/nginx%E4%BC%98%E5%8C%96/" title="Nginx优化详解"><i class="post-icon gg-file-document"></i>Nginx优化详解</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E5%AE%9E%E6%88%98/">实战</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/13/l2tp+ppp+ipsec/" title="l2tp+ppp+ipsec"><i class="post-icon gg-file-document"></i>l2tp+ppp+ipsec</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86/">接口管理</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/18/DOClever-for-centos7%E5%AE%89%E8%A3%85/" title="DOClever for centos7安装"><i class="post-icon gg-file-document"></i>DOClever for centos7安装</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/27/Mysql%20%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%A4%A7%E5%B0%8F/" title="Mysql数据库查询大小"><i class="post-icon gg-file-document"></i>Mysql数据库查询大小</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/27/Mysql%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E8%A1%A8/" title="Mysql 批量删除表"><i class="post-icon gg-file-document"></i>Mysql 批量删除表</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/17/Mysqldump%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%8E%92%E9%99%A4%E6%9F%90%E4%BA%9B%E5%BA%93/" title="Mysqldump备份数据库时排除某些库"><i class="post-icon gg-file-document"></i>Mysqldump备份数据库时排除某些库</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/06/mysql-delete/" title="mysql 删除表数据空间没有释放"><i class="post-icon gg-file-document"></i>mysql 删除表数据空间没有释放</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/17/%E5%BC%80%E5%90%AFGTID%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%20/" title="开启GTID的情况下导出导入库的注意事项"><i class="post-icon gg-file-document"></i>开启GTID的情况下导出导入库的注意事项</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%97%A5%E5%BF%97/">日志</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/12/nginx%20%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2/" title="nginx 日志切割"><i class="post-icon gg-file-document"></i>nginx 日志切割</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/12/nginx%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F/" title="nginx日志格式"><i class="post-icon gg-file-document"></i>nginx日志格式</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%B5%8B%E8%AF%95/">测试</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/ab%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/" title="ab压测工具"><i class="post-icon gg-file-document"></i>ab压测工具</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%BF%80%E6%B4%BB/">激活</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/01/datagrip/" title="datagrip"><i class="post-icon gg-file-document"></i>datagrip</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E7%9B%91%E6%8E%A7/">监控</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/26/Prometheus%E7%9B%91%E6%8E%A7node_exporter%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99/" title="Prometheus监控node_exporter的告警规则"><i class="post-icon gg-file-document"></i>Prometheus监控node_exporter的告警规则</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/23/prometheus-pushgateway/" title="Prometheus-pushgateway"><i class="post-icon gg-file-document"></i>Prometheus-pushgateway</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2021/01/13/LVS%20NAT,DR,TUN%E4%B8%89%E7%A7%8D%E8%B4%9F%E8%BD%BD%E5%8E%9F%E7%90%86/" title="LVS NAT,DR,TUN三种负载原理"><i class="post-icon gg-file-document"></i>LVS NAT,DR,TUN三种负载原理</a></li></ul></li></ul>
        <div id="widget-tree-button">
          <i class="gg-chevron-right"></i>
        </div>
      </div><!-- hexo injector body_end end --><script src="/sugw.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-chitose"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
