<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>
<!DOCTYPE html>
<html lang="zh-CN">
<head><!-- hexo injector head_begin start --><link href="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/sugw.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sugw.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sugw.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/sugw.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/sugw.github.io/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sugw.github.io","root":"/sugw.github.io/","scheme":"Gemini","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））  环境准备  编写ansible playbook脚本实现Wordpress远程部署  将wordpress源码与playbook部署脚本提交到gitlab仓库  编写pipeline job脚本实现Jenkins流水线持续交付流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins+Gitlab+Ansible自动化部署(六)">
<meta property="og:url" content="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/index.html">
<meta property="og:site_name" content="一只小笨鸟">
<meta property="og:description" content="Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））  环境准备  编写ansible playbook脚本实现Wordpress远程部署  将wordpress源码与playbook部署脚本提交到gitlab仓库  编写pipeline job脚本实现Jenkins流水线持续交付流程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-27T02:03:01.705Z">
<meta property="article:modified_time" content="2020-12-07T06:24:45.466Z">
<meta property="article:author" content="guowei su">
<meta property="article:tag" content="自动部署">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Jenkins+Gitlab+Ansible自动化部署(六) | 一只小笨鸟</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/sugw.github.io/atom.xml" title="一只小笨鸟" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/sugw.github.io/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">一只小笨鸟</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/sugw.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-作者">

    <a href="/sugw.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>作者</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/sugw.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/sugw.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/sugw.github.io/%E5%BD%92%E6%A1%A3/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-日历">

    <a href="/sugw.github.io/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日历</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="guowei su"
      src="/sugw.github.io/images/291603183698.jpg">
  <p class="site-author-name" itemprop="name">guowei su</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/sugw.github.io/archives">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/sugw.github.io/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      
  
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sugw.github.io/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/sugw.github.io/images/291603183698.jpg">
      <meta itemprop="name" content="guowei su">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只小笨鸟">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jenkins+Gitlab+Ansible自动化部署(六)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-27 10:03:01" itemprop="dateCreated datePublished" datetime="2020-11-27T10:03:01+08:00">2020-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-12-07 14:24:45" itemprop="dateModified" datetime="2020-12-07T14:24:45+08:00">2020-12-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/sugw.github.io/categories/Jenkins-Gitlab-Ansible/" itemprop="url" rel="index"><span itemprop="name">Jenkins+Gitlab+Ansible</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>53k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>48 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><strong>Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））</strong></p>
<ul>
<li><p>环境准备</p>
</li>
<li><p>编写ansible playbook脚本实现Wordpress远程部署</p>
</li>
<li><p>将wordpress源码与playbook部署脚本提交到gitlab仓库</p>
</li>
<li><p>编写pipeline job脚本实现Jenkins流水线持续交付流程</p>
</li>
<li><p>Jenkins集成Ansible与gitlab实现wordpress的自动化部署</p>
<p>验证环境</p>
</li>
</ul>
<p>登录Jenkins主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~</span><br><span class="line">$ ssh root@jenkins.example.com</span><br><span class="line">Last login: Thu Jan 10 11:41:49 2019 from 192.168.244.1</span><br><span class="line">[root@jenkins ~]# su - deploy</span><br><span class="line">Last login: Wed Jan  9 20:24:43 CST 2019 on pts&#x2F;0</span><br><span class="line">[deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate           (.py3-a2.5-env) [deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible-playbook</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ssh root@test.example.com</span><br><span class="line">Last login: Thu Jan 10 13:04:32 2019 from 192.168.244.131</span><br><span class="line">[root@test ~]# hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>登录Jenkins web管理页</p>
<p>2808</p>
<p>登录gitlab web管理页</p>
<p>2920</p>
<p>至此环境准备完成。</p>
<p>接下来编写ansible playbook脚本实现wordpress远程部署</p>
<p>开始编写配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total 5</span><br><span class="line">-rw-r--r-- 1 xueji 1049089   0 1月  10 11:57 ansible-playbook.txt</span><br><span class="line">drwxr-xr-x 1 xueji 1049089   0 1月  10 12:27 nginx_playbooks&#x2F;</span><br><span class="line">-rw-r--r-- 1 xueji 1049089 312 7月  15 08:33 nginx-freestyle-job.sh</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ mkdir wordpress_playbooks</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ cd wordpress_playbooks&#x2F;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ mkdir inventory</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ mkdir -p roles&#x2F;wordpress&#x2F;&#123;files,tasks,templates&#125;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 1 xueji 1049089 0 1月  10 13:29 inventory&#x2F;</span><br><span class="line">drwxr-xr-x 1 xueji 1049089 0 1月  10 13:30 roles&#x2F;</span><br><span class="line"></span><br><span class="line">配置deploy.retry</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.retry</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>配置deploy.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.yml</span><br><span class="line">- hosts: wordpress</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">      backup_to: &quot;&#123;&#123;root&#125;&#125;_&#123;&#123;branch&#125;&#125;_&#123;&#123;ansible_date_time.epoch&#125;&#125;&quot;</span><br><span class="line">  roles:</span><br><span class="line">    - wordpress</span><br></pre></td></tr></table></figure>



<p>配置dev</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;dev</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;8080</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;2</span><br><span class="line">max_open_file&#x3D;30000</span><br><span class="line">root&#x3D;&#x2F;data&#x2F;www</span><br><span class="line">gitlab_user&#x3D;&#39;root&#39;</span><br><span class="line">gitlab_pass&#x3D;&#39;12345678&#39;</span><br></pre></td></tr></table></figure>



<p>配置prod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;prod</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;80</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;4</span><br><span class="line">max_open_file&#x3D;65505</span><br><span class="line">root&#x3D;&#x2F;data&#x2F;www</span><br><span class="line">gitlab_user&#x3D;&#39;root&#39;</span><br><span class="line">gitlab_pass&#x3D;&#39;12345678&#39;</span><br></pre></td></tr></table></figure>



<p>配置health_check.sh和info.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">URL&#x3D;$1</span><br><span class="line">PORT&#x3D;$2</span><br><span class="line"></span><br><span class="line">curl -Is http:&#x2F;&#x2F;$URL:$PORT&#x2F;info.php &gt; &#x2F;dev&#x2F;null &amp;&amp; echo &quot;The remote side is healthy&quot; || echo &quot;The remote side is failed, please check&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt;&gt; roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br></pre></td></tr></table></figure>



<p>配置<a href="http://www.conf/">www.conf</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;files&#x2F;www.conf</span><br><span class="line"></span><br><span class="line">; Start a new pool named &#39;www&#39;.</span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line">; Unix user&#x2F;group of processes</span><br><span class="line">; Note: The user is mandatory. If the group is not set, the default user&#39;s group</span><br><span class="line">;       will be used.</span><br><span class="line">; RPM: apache Choosed to be able to access some dir as httpd</span><br><span class="line">user &#x3D; deploy</span><br><span class="line">; RPM: Keep a group allowed to write in log dir.</span><br><span class="line">group &#x3D; deploy</span><br><span class="line"></span><br><span class="line">; The address on which to accept FastCGI requests.</span><br><span class="line">; Valid syntaxes are:</span><br><span class="line">;   &#39;ip.add.re.ss:port&#39;    - to listen on a TCP socket to a specific IPv4 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#39;[ip:6:addr:ess]:port&#39; - to listen on a TCP socket to a specific IPv6 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#39;port&#39;                 - to listen on a TCP socket to all addresses</span><br><span class="line">;                            (IPv6 and IPv4-mapped) on a specific port;</span><br><span class="line">;   &#39;&#x2F;path&#x2F;to&#x2F;unix&#x2F;socket&#39; - to listen on a unix socket.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">;listen &#x3D; 127.0.0.1:9000</span><br><span class="line">listen &#x3D; &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Set listen(2) backlog.</span><br><span class="line">; Default Value: 511 (-1 on FreeBSD and OpenBSD)</span><br><span class="line">;listen.backlog &#x3D; 511</span><br><span class="line"></span><br><span class="line">; Set permissions for unix socket, if one is used. In Linux, read&#x2F;write</span><br><span class="line">; permissions must be set in order to allow connections from a web server. Many</span><br><span class="line">; BSD-derived systems allow connections regardless of permissions.</span><br><span class="line">; Default Values: user and group are set as the running user</span><br><span class="line">;                 mode is set to 0660</span><br><span class="line">listen.owner &#x3D; deploy</span><br><span class="line">listen.group &#x3D; deploy</span><br><span class="line">;listen.mode &#x3D; 0660</span><br><span class="line">; When POSIX Access Control Lists are supported you can set them using</span><br><span class="line">; these options, value is a comma separated list of user&#x2F;group names.</span><br><span class="line">; When set, listen.owner and listen.group are ignored</span><br><span class="line">;listen.acl_users &#x3D;</span><br><span class="line">;listen.acl_groups &#x3D;</span><br><span class="line"></span><br><span class="line">; List of addresses (IPv4&#x2F;IPv6) of FastCGI clients which are allowed to connect.</span><br><span class="line">; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original</span><br><span class="line">; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address</span><br><span class="line">; must be separated by a comma. If this value is left blank, connections will be</span><br><span class="line">; accepted from any ip address.</span><br><span class="line">; Default Value: any</span><br><span class="line">listen.allowed_clients &#x3D; 127.0.0.1</span><br><span class="line"></span><br><span class="line">; Specify the nice(2) priority to apply to the pool processes (only if set)</span><br><span class="line">; The value can vary from -19 (highest priority) to 20 (lower priority)</span><br><span class="line">; Note: - It will only work if the FPM master process is launched as root</span><br><span class="line">;       - The pool processes will inherit the master process priority</span><br><span class="line">;         unless it specified otherwise</span><br><span class="line">; Default Value: no set</span><br><span class="line">; process.priority &#x3D; -19</span><br><span class="line"></span><br><span class="line">; Choose how the process manager will control the number of child processes.</span><br><span class="line">; Possible Values:</span><br><span class="line">;   static  - a fixed number (pm.max_children) of child processes;</span><br><span class="line">;   dynamic - the number of child processes are set dynamically based on the</span><br><span class="line">;             following directives. With this process management, there will be</span><br><span class="line">;             always at least 1 children.</span><br><span class="line">;             pm.max_children      - the maximum number of children that can</span><br><span class="line">;                                    be alive at the same time.</span><br><span class="line">;             pm.start_servers     - the number of children created on startup.</span><br><span class="line">;             pm.min_spare_servers - the minimum number of children in &#39;idle&#39;</span><br><span class="line">;                                    state (waiting to process). If the number</span><br><span class="line">;                                    of &#39;idle&#39; processes is less than this</span><br><span class="line">;                                    number then some children will be created.</span><br><span class="line">;             pm.max_spare_servers - the maximum number of children in &#39;idle&#39;</span><br><span class="line">;                                    state (waiting to process). If the number</span><br><span class="line">;                                    of &#39;idle&#39; processes is greater than this</span><br><span class="line">;                                    number then some children will be killed.</span><br><span class="line">;  ondemand - no children are created at startup. Children will be forked when</span><br><span class="line">;             new requests will connect. The following parameter are used:</span><br><span class="line">;             pm.max_children           - the maximum number of children that</span><br><span class="line">;                                         can be alive at the same time.</span><br><span class="line">;             pm.process_idle_timeout   - The number of seconds after which</span><br><span class="line">;                                         an idle process will be killed.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">pm &#x3D; dynamic</span><br><span class="line"></span><br><span class="line">; The number of child processes to be created when pm is set to &#39;static&#39; and the</span><br><span class="line">; maximum number of child processes when pm is set to &#39;dynamic&#39; or &#39;ondemand&#39;.</span><br><span class="line">; This value sets the limit on the number of simultaneous requests that will be</span><br><span class="line">; served. Equivalent to the ApacheMaxClients directive with mpm_prefork.</span><br><span class="line">; Equivalent to the PHP_FCGI_CHILDREN environment variable in the original PHP</span><br><span class="line">; CGI.</span><br><span class="line">; Note: Used when pm is set to &#39;static&#39;, &#39;dynamic&#39; or &#39;ondemand&#39;</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">pm.max_children &#x3D; 50</span><br><span class="line"></span><br><span class="line">; The number of child processes created on startup.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) &#x2F; 2</span><br><span class="line">pm.start_servers &#x3D; 5</span><br><span class="line"></span><br><span class="line">; The desired minimum number of idle server processes.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Note: Mandatory when pm is set to &#39;dynamic&#39;</span><br><span class="line">pm.min_spare_servers &#x3D; 5</span><br><span class="line"></span><br><span class="line">; The desired maximum number of idle server processes.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Note: Mandatory when pm is set to &#39;dynamic&#39;</span><br><span class="line">pm.max_spare_servers &#x3D; 35</span><br><span class="line"></span><br><span class="line">; The number of seconds after which an idle process will be killed.</span><br><span class="line">; Note: Used only when pm is set to &#39;ondemand&#39;</span><br><span class="line">; Default Value: 10s</span><br><span class="line">;pm.process_idle_timeout &#x3D; 10s;</span><br><span class="line"></span><br><span class="line">; The number of requests each child process should execute before respawning.</span><br><span class="line">; This can be useful to work around memory leaks in 3rd party libraries. For</span><br><span class="line">; endless request processing specify &#39;0&#39;. Equivalent to PHP_FCGI_MAX_REQUESTS.</span><br><span class="line">; Default Value: 0</span><br><span class="line">;pm.max_requests &#x3D; 500</span><br><span class="line"></span><br><span class="line">; The URI to view the FPM status page. If this value is not set, no URI will be</span><br><span class="line">; recognized as a status page. It shows the following informations:</span><br><span class="line">;   pool                 - the name of the pool;</span><br><span class="line">;   process manager      - static, dynamic or ondemand;</span><br><span class="line">;   start time           - the date and time FPM has started;</span><br><span class="line">;   start since          - number of seconds since FPM has started;</span><br><span class="line">;   accepted conn        - the number of request accepted by the pool;</span><br><span class="line">;   listen queue         - the number of request in the queue of pending</span><br><span class="line">;                          connections (see backlog in listen(2));</span><br><span class="line">;   max listen queue     - the maximum number of requests in the queue</span><br><span class="line">;                          of pending connections since FPM has started;</span><br><span class="line">;   listen queue len     - the size of the socket queue of pending connections;</span><br><span class="line">;   idle processes       - the number of idle processes;</span><br><span class="line">;   active processes     - the number of active processes;</span><br><span class="line">;   total processes      - the number of idle + active processes;</span><br><span class="line">;   max active processes - the maximum number of active processes since FPM</span><br><span class="line">;                          has started;</span><br><span class="line">;   max children reached - number of times, the process limit has been reached,</span><br><span class="line">;                          when pm tries to start more children (works only for</span><br><span class="line">;                          pm &#39;dynamic&#39; and &#39;ondemand&#39;);</span><br><span class="line">; Value are updated in real time.</span><br><span class="line">; Example output:</span><br><span class="line">;   pool:                 www</span><br><span class="line">;   process manager:      static</span><br><span class="line">;   start time:           01&#x2F;Jul&#x2F;2011:17:53:49 +0200</span><br><span class="line">;   start since:          62636</span><br><span class="line">;   accepted conn:        190460</span><br><span class="line">;   listen queue:         0</span><br><span class="line">;   max listen queue:     1</span><br><span class="line">;   listen queue len:     42</span><br><span class="line">;   idle processes:       4</span><br><span class="line">;   active processes:     11</span><br><span class="line">;   total processes:      15</span><br><span class="line">;   max active processes: 12</span><br><span class="line">;   max children reached: 0</span><br><span class="line">;</span><br><span class="line">; By default the status page output is formatted as text&#x2F;plain. Passing either</span><br><span class="line">; &#39;html&#39;, &#39;xml&#39; or &#39;json&#39; in the query string will return the corresponding</span><br><span class="line">; output syntax. Example:</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?json</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?html</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?xml</span><br><span class="line">;</span><br><span class="line">; By default the status page only outputs short status. Passing &#39;full&#39; in the</span><br><span class="line">; query string will also return status for each pool process.</span><br><span class="line">; Example:</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?json&amp;full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?html&amp;full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?xml&amp;full</span><br><span class="line">; The Full status returns for each process:</span><br><span class="line">;   pid                  - the PID of the process;</span><br><span class="line">;   state                - the state of the process (Idle, Running, ...);</span><br><span class="line">;   start time           - the date and time the process has started;</span><br><span class="line">;   start since          - the number of seconds since the process has started;</span><br><span class="line">;   requests             - the number of requests the process has served;</span><br><span class="line">;   request duration     - the duration in µs of the requests;</span><br><span class="line">;   request method       - the request method (GET, POST, ...);</span><br><span class="line">;   request URI          - the request URI with the query string;</span><br><span class="line">;   content length       - the content length of the request (only with POST);</span><br><span class="line">;   user                 - the user (PHP_AUTH_USER) (or &#39;-&#39; if not set);</span><br><span class="line">;   script               - the main script called (or &#39;-&#39; if not set);</span><br><span class="line">;   last request cpu     - the %cpu the last request consumed</span><br><span class="line">;                          it&#39;s always 0 if the process is not in Idle state</span><br><span class="line">;                          because CPU calculation is done when the request</span><br><span class="line">;                          processing has terminated;</span><br><span class="line">;   last request memory  - the max amount of memory the last request consumed</span><br><span class="line">;                          it&#39;s always 0 if the process is not in Idle state</span><br><span class="line">;                          because memory calculation is done when the request</span><br><span class="line">;                          processing has terminated;</span><br><span class="line">; If the process is in Idle state, then informations are related to the</span><br><span class="line">; last request the process has served. Otherwise informations are related to</span><br><span class="line">; the current request being served.</span><br><span class="line">; Example output:</span><br><span class="line">;   ************************</span><br><span class="line">;   pid:                  31330</span><br><span class="line">;   state:                Running</span><br><span class="line">;   start time:           01&#x2F;Jul&#x2F;2011:17:53:49 +0200</span><br><span class="line">;   start since:          63087</span><br><span class="line">;   requests:             12808</span><br><span class="line">;   request duration:     1250261</span><br><span class="line">;   request method:       GET</span><br><span class="line">;   request URI:          &#x2F;test_mem.php?N&#x3D;10000</span><br><span class="line">;   content length:       0</span><br><span class="line">;   user:                 -</span><br><span class="line">;   script:               &#x2F;home&#x2F;fat&#x2F;web&#x2F;docs&#x2F;php&#x2F;test_mem.php</span><br><span class="line">;   last request cpu:     0.00</span><br><span class="line">;   last request memory:  0</span><br><span class="line">;</span><br><span class="line">; Note: There is a real-time FPM status monitoring sample web page available</span><br><span class="line">;       It&#39;s available in: @EXPANDED_DATADIR@&#x2F;fpm&#x2F;status.html</span><br><span class="line">;</span><br><span class="line">; Note: The value must start with a leading slash (&#x2F;). The value can be</span><br><span class="line">;       anything, but it may not be a good idea to use the .php extension or it</span><br><span class="line">;       may conflict with a real PHP file.</span><br><span class="line">; Default Value: not set</span><br><span class="line">;pm.status_path &#x3D; &#x2F;status</span><br><span class="line"></span><br><span class="line">; The ping URI to call the monitoring page of FPM. If this value is not set, no</span><br><span class="line">; URI will be recognized as a ping page. This could be used to test from outside</span><br><span class="line">; that FPM is alive and responding, or to</span><br><span class="line">; - create a graph of FPM availability (rrd or such);</span><br><span class="line">; - remove a server from a group if it is not responding (load balancing);</span><br><span class="line">; - trigger alerts for the operating team (24&#x2F;7).</span><br><span class="line">; Note: The value must start with a leading slash (&#x2F;). The value can be</span><br><span class="line">;       anything, but it may not be a good idea to use the .php extension or it</span><br><span class="line">;       may conflict with a real PHP file.</span><br><span class="line">; Default Value: not set</span><br><span class="line">;ping.path &#x3D; &#x2F;ping</span><br><span class="line"></span><br><span class="line">; This directive may be used to customize the response of a ping request. The</span><br><span class="line">; response is formatted as text&#x2F;plain with a 200 response code.</span><br><span class="line">; Default Value: pong</span><br><span class="line">;ping.response &#x3D; pong</span><br><span class="line"></span><br><span class="line">; The access log file</span><br><span class="line">; Default: not set</span><br><span class="line">;access.log &#x3D; log&#x2F;$pool.access.log</span><br><span class="line"></span><br><span class="line">; The access log format.</span><br><span class="line">; The following syntax is allowed</span><br><span class="line">;  %%: the &#39;%&#39; character</span><br><span class="line">;  %C: %CPU used by the request</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;user&#125;C for user CPU only</span><br><span class="line">;      - %&#123;system&#125;C for system CPU only</span><br><span class="line">;      - %&#123;total&#125;C  for user + system CPU (default)</span><br><span class="line">;  %d: time taken to serve the request</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;seconds&#125;d (default)</span><br><span class="line">;      - %&#123;miliseconds&#125;d</span><br><span class="line">;      - %&#123;mili&#125;d</span><br><span class="line">;      - %&#123;microseconds&#125;d</span><br><span class="line">;      - %&#123;micro&#125;d</span><br><span class="line">;  %e: an environment variable (same as $_ENV or $_SERVER)</span><br><span class="line">;      it must be associated with embraces to specify the name of the env</span><br><span class="line">;      variable. Some exemples:</span><br><span class="line">;      - server specifics like: %&#123;REQUEST_METHOD&#125;e or %&#123;SERVER_PROTOCOL&#125;e</span><br><span class="line">;      - HTTP headers like: %&#123;HTTP_HOST&#125;e or %&#123;HTTP_USER_AGENT&#125;e</span><br><span class="line">;  %f: script filename</span><br><span class="line">;  %l: content-length of the request (for POST request only)</span><br><span class="line">;  %m: request method</span><br><span class="line">;  %M: peak of memory allocated by PHP</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;bytes&#125;M (default)</span><br><span class="line">;      - %&#123;kilobytes&#125;M</span><br><span class="line">;      - %&#123;kilo&#125;M</span><br><span class="line">;      - %&#123;megabytes&#125;M</span><br><span class="line">;      - %&#123;mega&#125;M</span><br><span class="line">;  %n: pool name</span><br><span class="line">;  %o: output header</span><br><span class="line">;      it must be associated with embraces to specify the name of the header:</span><br><span class="line">;      - %&#123;Content-Type&#125;o</span><br><span class="line">;      - %&#123;X-Powered-By&#125;o</span><br><span class="line">;      - %&#123;Transfert-Encoding&#125;o</span><br><span class="line">;      - ....</span><br><span class="line">;  %p: PID of the child that serviced the request</span><br><span class="line">;  %P: PID of the parent of the child that serviced the request</span><br><span class="line">;  %q: the query string</span><br><span class="line">;  %Q: the &#39;?&#39; character if query string exists</span><br><span class="line">;  %r: the request URI (without the query string, see %q and %Q)</span><br><span class="line">;  %R: remote IP address</span><br><span class="line">;  %s: status (response code)</span><br><span class="line">;  %t: server time the request was received</span><br><span class="line">;      it can accept a strftime(3) format:</span><br><span class="line">;      %d&#x2F;%b&#x2F;%Y:%H:%M:%S %z (default)</span><br><span class="line">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span><br><span class="line">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span><br><span class="line">;  %T: time the log has been written (the request has finished)</span><br><span class="line">;      it can accept a strftime(3) format:</span><br><span class="line">;      %d&#x2F;%b&#x2F;%Y:%H:%M:%S %z (default)</span><br><span class="line">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span><br><span class="line">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span><br><span class="line">;  %u: remote user</span><br><span class="line">;</span><br><span class="line">; Default: &quot;%R - %u %t \&quot;%m %r\&quot; %s&quot;</span><br><span class="line">;access.format &#x3D; &quot;%R - %u %t \&quot;%m %r%Q%q\&quot; %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%&quot;</span><br><span class="line"></span><br><span class="line">; The log file for slow requests</span><br><span class="line">; Default Value: not set</span><br><span class="line">; Note: slowlog is mandatory if request_slowlog_timeout is set</span><br><span class="line">slowlog &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;www-slow.log</span><br><span class="line"></span><br><span class="line">; The timeout for serving a single request after which a PHP backtrace will be</span><br><span class="line">; dumped to the &#39;slowlog&#39; file. A value of &#39;0s&#39; means &#39;off&#39;.</span><br><span class="line">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Value: 0</span><br><span class="line">;request_slowlog_timeout &#x3D; 0</span><br><span class="line"></span><br><span class="line">; The timeout for serving a single request after which the worker process will</span><br><span class="line">; be killed. This option should be used when the &#39;max_execution_time&#39; ini option</span><br><span class="line">; does not stop script execution for some reason. A value of &#39;0&#39; means &#39;off&#39;.</span><br><span class="line">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Value: 0</span><br><span class="line">;request_terminate_timeout &#x3D; 0</span><br><span class="line"></span><br><span class="line">; Set open file descriptor rlimit.</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_files &#x3D; 1024</span><br><span class="line"></span><br><span class="line">; Set max core size rlimit.</span><br><span class="line">; Possible Values: &#39;unlimited&#39; or an integer greater or equal to 0</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_core &#x3D; 0</span><br><span class="line"></span><br><span class="line">; Chroot to this directory at the start. This value must be defined as an</span><br><span class="line">; absolute path. When this value is not set, chroot is not used.</span><br><span class="line">; Note: chrooting is a great security feature and should be used whenever</span><br><span class="line">;       possible. However, all PHP paths will be relative to the chroot</span><br><span class="line">;       (error_log, sessions.save_path, ...).</span><br><span class="line">; Default Value: not set</span><br><span class="line">;chroot &#x3D;</span><br><span class="line"></span><br><span class="line">; Chdir to this directory at the start.</span><br><span class="line">; Note: relative path can be used.</span><br><span class="line">; Default Value: current directory or &#x2F; when chroot</span><br><span class="line">;chdir &#x3D; &#x2F;var&#x2F;www</span><br><span class="line"></span><br><span class="line">; Redirect worker stdout and stderr into main error log. If not set, stdout and</span><br><span class="line">; stderr will be redirected to &#x2F;dev&#x2F;null according to FastCGI specs.</span><br><span class="line">; Note: on highloaded environement, this can cause some delay in the page</span><br><span class="line">; process time (several ms).</span><br><span class="line">; Default Value: no</span><br><span class="line">;catch_workers_output &#x3D; yes</span><br><span class="line"></span><br><span class="line">; Clear environment in FPM workers</span><br><span class="line">; Prevents arbitrary environment variables from reaching FPM worker processes</span><br><span class="line">; by clearing the environment in workers before env vars specified in this</span><br><span class="line">; pool configuration are added.</span><br><span class="line">; Setting to &quot;no&quot; will make all environment variables available to PHP code</span><br><span class="line">; via getenv(), $_ENV and $_SERVER.</span><br><span class="line">; Default Value: yes</span><br><span class="line">;clear_env &#x3D; no</span><br><span class="line"></span><br><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; exectute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7</span><br><span class="line"></span><br><span class="line">; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from</span><br><span class="line">; the current environment.</span><br><span class="line">; Default Value: clean env</span><br><span class="line">;env[HOSTNAME] &#x3D; $HOSTNAME</span><br><span class="line">;env[PATH] &#x3D; &#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;bin:&#x2F;bin</span><br><span class="line">;env[TMP] &#x3D; &#x2F;tmp</span><br><span class="line">;env[TMPDIR] &#x3D; &#x2F;tmp</span><br><span class="line">;env[TEMP] &#x3D; &#x2F;tmp</span><br><span class="line"></span><br><span class="line">; Additional php.ini defines, specific to this pool of workers. These settings</span><br><span class="line">; overwrite the values previously defined in the php.ini. The directives are the</span><br><span class="line">; same as the PHP SAPI:</span><br><span class="line">;   php_value&#x2F;php_flag             - you can set classic ini defines which can</span><br><span class="line">;                                    be overwritten from PHP call &#39;ini_set&#39;.</span><br><span class="line">;   php_admin_value&#x2F;php_admin_flag - these directives won&#39;t be overwritten by</span><br><span class="line">;                                     PHP call &#39;ini_set&#39;</span><br><span class="line">; For php_*flag, valid values are on, off, 1, 0, true, false, yes or no.</span><br><span class="line"></span><br><span class="line">; Defining &#39;extension&#39; will load the corresponding shared extension from</span><br><span class="line">; extension_dir. Defining &#39;disable_functions&#39; or &#39;disable_classes&#39; will not</span><br><span class="line">; overwrite previously defined php.ini values, but will append the new value</span><br><span class="line">; instead.</span><br><span class="line"></span><br><span class="line">; Default Value: nothing is defined by default except the values in php.ini and</span><br><span class="line">;                specified at startup with the -d argument</span><br><span class="line">;php_admin_value[sendmail_path] &#x3D; &#x2F;usr&#x2F;sbin&#x2F;sendmail -t -i -f www@my.domain.com</span><br><span class="line">;php_flag[display_errors] &#x3D; off</span><br><span class="line">php_admin_value[error_log] &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;www-error.log</span><br><span class="line">php_admin_flag[log_errors] &#x3D; on</span><br><span class="line">;php_admin_value[memory_limit] &#x3D; 128M</span><br><span class="line"></span><br><span class="line">; Set session path to a directory owned by process user</span><br><span class="line">php_value[session.save_handler] &#x3D; files</span><br><span class="line">php_value[session.save_path]    &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;wsdlcache</span><br></pre></td></tr></table></figure>



<p>配置main.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;tasks&#x2F;main.yml</span><br><span class="line"></span><br><span class="line">- name: Update yum dependency</span><br><span class="line">  shell: &#39;yum update -y warn&#x3D;False&#39;</span><br><span class="line"></span><br><span class="line">- name: Disable system firewall</span><br><span class="line">  service: name&#x3D;firewalld state&#x3D;stopped</span><br><span class="line"></span><br><span class="line">- name: Disable SELINX</span><br><span class="line">  selinux: state&#x3D;disabled</span><br><span class="line"></span><br><span class="line">- name: Setup epel yum source for nginx and mariadb(mysql)</span><br><span class="line">  yum: pkg&#x3D;epel-release state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: Setup webtatic yum source for php-fpm</span><br><span class="line">  yum: name&#x3D;https:&#x2F;&#x2F;mirror.webtatic.com&#x2F;yum&#x2F;el7&#x2F;webtatic-release.rpm</span><br><span class="line"></span><br><span class="line">- name: Ensure nginx is at the latest version</span><br><span class="line">  yum: pkg&#x3D;nginx state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: Write the nginx config file</span><br><span class="line">  template: src&#x3D;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">- name: Create nginx root folder</span><br><span class="line">  file: &#39;path&#x3D;&#123;&#123; root &#125;&#125; state&#x3D;directory owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125; mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: Copy info.php to remote</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;wordpress&#x2F;files&#x2F;info.php dest&#x3D;&#x2F;data&#x2F;www&#x2F;info.php mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart nginx service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Setup php-fpm</span><br><span class="line">  command: &#39;yum install -y php70w php70w-fpm php70w-common php70w-mysql php70w-gd php70w-xml php70w-mbstring php70w-mcrypt warn&#x3D;False&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: name&#x3D;php-fpm state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Copy php-fpm config file to remote</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf dest&#x3D;&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf mode&#x3D;0755 owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125; force&#x3D;yes&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: name&#x3D;php-fpm state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Run the health check locally</span><br><span class="line">  shell: &quot;sh roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh &#123;&#123; server_name &#125;&#125; &#123;&#123; port &#125;&#125;&quot;</span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: msg&#x3D;&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">- name: Setup mariadb(mysql)</span><br><span class="line">  command: &quot;yum install -y mariadb mariadb-server warn&#x3D;False&quot;</span><br><span class="line"></span><br><span class="line">- name: Backup current www folder</span><br><span class="line">  shell: &#39;mv &#123;&#123; root &#125;&#125; &#123;&#123; backup_to &#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">- name: Close git ssl verification</span><br><span class="line">  shell: &#39;git config --global http.sslVerify false&#39;</span><br><span class="line"></span><br><span class="line">- name: Clone WordPress repo to remote</span><br><span class="line">  git: &quot;repo&#x3D;https:&#x2F;&#x2F;&#123;&#123; gitlab_user | urlencode &#125;&#125;:&#123;&#123; gitlab_pass | urlencode &#125;&#125;@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git dest&#x3D;&#x2F;data&#x2F;www version&#x3D;&#123;&#123; branch &#125;&#125;&quot;</span><br><span class="line">  when: project &#x3D;&#x3D; &#39;wordpress&#39;</span><br><span class="line"></span><br><span class="line">- name: Change www folder permission</span><br><span class="line">  file: &quot;path&#x3D;&#x2F;data&#x2F;www mode&#x3D;0755 owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>



<p>配置nginx.conf.j2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"># For more information on configuration, see: </span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;  </span><br><span class="line">  </span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;  </span><br><span class="line">    default_type  application&#x2F;octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;  </span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;  </span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  </span><br><span class="line">  </span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    #tcp_nopush     on;  </span><br><span class="line">  </span><br><span class="line">    #keepalive_timeout  0;  </span><br><span class="line">    keepalive_timeout  65;  </span><br><span class="line">  </span><br><span class="line">    #gzip  on;  </span><br><span class="line">      </span><br><span class="line">    # Load config files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory  </span><br><span class="line">    # The default server is in conf.d&#x2F;default.conf  </span><br><span class="line">    #include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;  </span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;  </span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;  </span><br><span class="line">        root         &#123;&#123; root &#125;&#125;;</span><br><span class="line">        #charset koi8-r;  </span><br><span class="line">  </span><br><span class="line">        location &#x2F; &#123;  </span><br><span class="line">            index  index.html index.htm index.php;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            try_files $uri &#x3D;404;</span><br><span class="line">            fastcgi_pass unix:&#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">            include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;deploy.retry.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;deploy.yml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;inventory&#x2F;dev.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;inventory&#x2F;prod.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;main.yml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git commit -m&quot;first commit&quot;</span><br><span class="line">[master c526626] first commit</span><br><span class="line"> 9 files changed, 564 insertions(+)</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;deploy.yml</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;inventory&#x2F;dev</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;inventory&#x2F;prod</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;main.yml</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 17, done.</span><br><span class="line">Counting objects: 100% (17&#x2F;17), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (13&#x2F;13), done.</span><br><span class="line">Writing objects: 100% (16&#x2F;16), 8.48 KiB | 1.70 MiB&#x2F;s, done.</span><br><span class="line">Total 16 (delta 1), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">   06431dc..c526626  master -&gt; master</span><br></pre></td></tr></table></figure>



<p>返回gitlab查看</p>
<p>76112</p>
<p>创建Wordpress-project仓库并提交本地代码到gitlab</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git add .</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git commit -m &quot;first commit&quot;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git push origin master</span><br></pre></td></tr></table></figure>



<p>登录到Jenkins web管理页</p>
<p>点击“New 任务”</p>
<p>77474</p>
<p>添加描述</p>
<p>77576</p>
<p>在如下输入框中输入</p>
<p>77685</p>
<p>pipeline script脚本内容（注意credentialsId要查看本地设置的凭据中的ID，复制过来替换掉即可）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label &#39;master&#39;&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH&#x3D;&quot;&#x2F;bin:&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            choices: &#39;dev\nrprod&#39;,</span><br><span class="line">            description: &#39;Choose deploy environment&#39;,</span><br><span class="line">            name: &#39;deploy_env&#39;</span><br><span class="line">        )</span><br><span class="line">        string (name: &#39;branch&#39;, defaultValue: &#39;master&#39;, description: &#39;Fill in your ansible repo branch&#39;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage (&quot;Pull deploy code&quot;) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh &#39;git config --global http.sslVerify false&#39;</span><br><span class="line">                dir (&quot;$&#123;env.WORKSPACE&#125;&quot;)&#123;</span><br><span class="line">                    git branch: &#39;master&#39;, credentialsId: &#39;&#39;, url: &#39;https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git&#39;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (&quot;Check env&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &quot;&quot;&quot;</span><br><span class="line">                set +x</span><br><span class="line">                user&#x3D;&#96;whoami&#96;</span><br><span class="line">                if [ $user &#x3D;&#x3D; deploy ]</span><br><span class="line">                then</span><br><span class="line">                    echo &quot;[INFO] Current deployment user is $user&quot;</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">                    echo &quot;[INFO] Current python version&quot;</span><br><span class="line">                    python --version</span><br><span class="line">                    echo &quot;[INFO] Current ansible version&quot;</span><br><span class="line">                    ansible-playbook --version</span><br><span class="line">                    echo &quot;[INFO] Remote system disk space&quot;</span><br><span class="line">                    ssh root@test.example.com df -h</span><br><span class="line">                    echo &quot;[INFO] Rmote system RAM&quot;</span><br><span class="line">                    ssh root@test.example.com free -m</span><br><span class="line">                else</span><br><span class="line">                    echo &quot;Deployment user is incorrect, please check&quot;</span><br><span class="line">                fi</span><br><span class="line"></span><br><span class="line">                set -x</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (&quot;Anisble deployment&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                input &quot;Do you approve the deployment?&quot;</span><br><span class="line">                dir(&quot;$&#123;env.WORKSPACE&#125;&#x2F;wordpress_playbooks&quot;)&#123;</span><br><span class="line">                    echo &quot;[INFO] Start deployment&quot;</span><br><span class="line">                    sh &quot;&quot;&quot;</span><br><span class="line">                    set +x</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">                    ansible-playbook -i inventory&#x2F;$deploy_env .&#x2F;deploy.yml -e project&#x3D;wordpress -e branch&#x3D;$branch -e env&#x3D;$deploy_env</span><br><span class="line">                    set -x</span><br><span class="line">                    &quot;&quot;&quot;</span><br><span class="line">                    echo &quot;[INFO] Deployment finished...&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>凭据ID</p>
<p>85836</p>
<p>点击查看输出信息</p>
<p>85945</p>
<p>86041</p>
<p>(正常情况下)稍等片刻之后就会看到“SUCCESS”(注意首次构建可能会提示“No such property: deploy_env for class: groovy.lang.Binding”)遇到这个错误，只需返回到word press-pipeline-job工程点击“Build with Parameters”选择默认dev用户再次构建即可。</p>
<p>（纸上得来终觉浅，绝知此事要躬行，真的是各种采坑）久违的“SUCCESS”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">Do you approve the deployment?</span><br><span class="line">Proceed or Abort</span><br><span class="line"></span><br><span class="line">Approved by admin</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] echo</span><br><span class="line">[INFO] Start deployment</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ set +x</span><br><span class="line"></span><br><span class="line">PLAY [wordpress] ***************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Update yum dependency] ***************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Disable system firewall] *************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Disable SELINX] **********************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup epel yum source for nginx and mariadb(mysql)] **********</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup webtatic yum source for php-fpm] ***********************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Ensure nginx is at the latest version] ***********************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Write the nginx config file] *********************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Create nginx root folder] ************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart nginx service] ***************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup php-fpm] ***********************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart php-fpm service] *************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Copy php-fpm config file to remote] **************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart php-fpm service] *************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Run the health check locally] ********************************</span><br><span class="line">changed: [test.example.com -&gt; localhost]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : debug] *******************************************************</span><br><span class="line">ok: [test.example.com] &#x3D;&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;The remote side is healthy&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup mariadb(mysql)] ****************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Close git ssl verification] **********************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Clone WordPress repo to remote] ******************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Change www folder permission] ********************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;23   changed&#x3D;14   unreachable&#x3D;0    failed&#x3D;0   </span><br><span class="line"></span><br><span class="line">[Pipeline] echo</span><br><span class="line">[INFO] Deployment finished...</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>



<p>最后需要利用git bash或者xshell登录test.example.com主机上初始化MySQL数据库，（实际生产环境中不建议使用Jenkins重复构建初始化MySQL数据库，容易出现各种问题）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# systemctl status mariadb</span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line">[root@test ~]# mysql_secure_installation</span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to log into MariaDB to secure it, we&#39;ll need the current</span><br><span class="line">password for the root user.  If you&#39;ve just installed MariaDB, and</span><br><span class="line">you haven&#39;t set the root password yet, the password will be blank,</span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none):   #mariadb5.5首次安装没有root密码，所以直接回车即可</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log into the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">Set root password? [Y&#x2F;n] y</span><br><span class="line">New password:   #123456</span><br><span class="line">Re-enter new password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MariaDB without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &#39;localhost&#39;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">By default, MariaDB comes with a database named &#39;test&#39; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y&#x2F;n] y</span><br><span class="line"> - Dropping test database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges on test database...</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  If you&#39;ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks for using MariaDB!</span><br></pre></td></tr></table></figure>



<p>创建wordpress数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# mysql -uroot -p123456</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 10</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database wordpress character set utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; \q</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>



<p>浏览器登录</p>
<p>104917</p>
<p>105013</p>
<p>105109</p>
<p>105205</p>
<p>105300</p>
<p>105395</p>
<p>105491</p>
<p>查看首页</p>
<p>105592</p>
<p>至此，使用Jenkins+Gitlab+Ansible自动化部署wordpresss全部完成。</p>
<p>接下来说说注意点，尽量避免以后重蹈覆辙：</p>
<p>第一次没有上传Wordpress-project仓库，也没有配置test.example.com主机上的/etc/hosts文件，导致在部署过程中一直卡在某个环节不动，或者直接提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Clone WordPress repo to remote] ******************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;cmd&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;git clone --origin origin &#39;https:&#x2F;&#x2F;root:********@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#39; &#x2F;data&#x2F;www&quot;, &quot;msg&quot;: &quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:********@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error&quot;, &quot;rc&quot;: 128, &quot;stderr&quot;: &quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:12345678@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error\n&quot;, &quot;stderr_lines&quot;: [&quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:12345678@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error&quot;], &quot;stdout&quot;: &quot;Cloning into &#39;&#x2F;data&#x2F;www&#39;...\n&quot;, &quot;stdout_lines&quot;: [&quot;Cloning into &#39;&#x2F;data&#x2F;www&#39;...&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br></pre></td></tr></table></figure>

<p>107784</p>
<p>错误信息2</p>
<p>ansible-playbook-repo仓库中没有info.php文件，所以抛出以下异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line">An exception occurred during task execution. To see the full traceback, use -vvv. The error was:     &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Could not find or access &#39;roles&#x2F;wordpress&#x2F;files&#x2F;info.php&#39;\nSearched in:\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php&quot;&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;9    changed&#x3D;4    unreachable&#x3D;0    failed&#x3D;1   </span><br><span class="line"></span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line"></span><br><span class="line">[Pipeline] &#x2F;&#x2F; withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">ERROR: script returned exit code 2</span><br></pre></td></tr></table></figure>



<p>错误信息3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Setup webtatic yum source for php-fpm] ***********************</span><br><span class="line">Sending interrupt signal to process</span><br><span class="line">Aborted by admin</span><br><span class="line">fatal: [test.example.com]: UNREACHABLE! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Shared connection to test.example.com closed.\r\n&quot;, &quot;unreachable&quot;: true&#125;</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks@tmp&#x2F;durable-55384134&#x2F;script.sh: line 5: 22534 Terminated              ansible-playbook -i inventory&#x2F;dev .&#x2F;deploy.yml -e project&#x3D;wordpress -e branch&#x3D;master -e env&#x3D;dev</span><br><span class="line">script returned exit code 143</span><br></pre></td></tr></table></figure>



<p>错误信息4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: true, &quot;cmd&quot;: &quot;yum install git&quot;, &quot;delta&quot;: &quot;0:00:04.471168&quot;, &quot;end&quot;: &quot;2019-01-10 18:05:37.319608&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 1, &quot;start&quot;: &quot;2019-01-10 18:05:32.848440&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;stderr_lines&quot;: [], &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors.aliyun.com\n * epel: mirrors.aliyun.com\n * extras: mirrors.163.com\n * updates: mirrors.aliyun.com\n * webtatic: us-east.repo.webtatic.com\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package git.x86_64 0:1.8.3.1-20.el7 will be installed\n--&gt; Processing Dependency: perl-Git &#x3D; 1.8.3.1-20.el7 for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Running transaction check\n---&gt; Package perl-Error.noarch 1:0.17020-2.el7 will be installed\n---&gt; Package perl-Git.noarch 0:1.8.3.1-20.el7 will be installed\n---&gt; Package perl-TermReadKey.x86_64 0:2.30-20.el7 will be installed\n---&gt; Package rsync.x86_64 0:3.1.2-4.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n Package                Arch         Version                Repository     Size\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstalling:\n git                    x86_64       1.8.3.1-20.el7         updates       4.4 M\nInstalling for dependencies:\n perl-Error             noarch       1:0.17020-2.el7        base           32 k\n perl-Git               noarch       1.8.3.1-20.el7         updates        55 k\n perl-TermReadKey       x86_64       2.30-20.el7            base           31 k\n rsync                  x86_64       3.1.2-4.el7            base          403 k\n\nTransaction Summary\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstall  1 Package (+4 Dependent packages)\n\nTotal download size: 4.9 M\nInstalled size: 23 M\nIs this ok [y&#x2F;d&#x2F;N]: Exiting on user command\nYour transaction was saved, rerun it with:\n yum load-transaction &#x2F;tmp&#x2F;yum_save_tx.2019-01-10.18-05.jmunIG.yumtx&quot;, &quot;stdout_lines&quot;: [&quot;Loaded plugins: fastestmirror&quot;, &quot;Loading mirror speeds from cached hostfile&quot;, &quot; * base: mirrors.aliyun.com&quot;, &quot; * epel: mirrors.aliyun.com&quot;, &quot; * extras: mirrors.163.com&quot;, &quot; * updates: mirrors.aliyun.com&quot;, &quot; * webtatic: us-east.repo.webtatic.com&quot;, &quot;Resolving Dependencies&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package git.x86_64 0:1.8.3.1-20.el7 will be installed&quot;, &quot;--&gt; Processing Dependency: perl-Git &#x3D; 1.8.3.1-20.el7 for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package perl-Error.noarch 1:0.17020-2.el7 will be installed&quot;, &quot;---&gt; Package perl-Git.noarch 0:1.8.3.1-20.el7 will be installed&quot;, &quot;---&gt; Package perl-TermReadKey.x86_64 0:2.30-20.el7 will be installed&quot;, &quot;---&gt; Package rsync.x86_64 0:3.1.2-4.el7 will be installed&quot;, &quot;--&gt; Finished Dependency Resolution&quot;, &quot;&quot;, &quot;Dependencies Resolved&quot;, &quot;&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot; Package                Arch         Version                Repository     Size&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot;Installing:&quot;, &quot; git                    x86_64       1.8.3.1-20.el7         updates       4.4 M&quot;, &quot;Installing for dependencies:&quot;, &quot; perl-Error             noarch       1:0.17020-2.el7        base           32 k&quot;, &quot; perl-Git               noarch       1.8.3.1-20.el7         updates        55 k&quot;, &quot; perl-TermReadKey       x86_64       2.30-20.el7            base           31 k&quot;, &quot; rsync                  x86_64       3.1.2-4.el7            base          403 k&quot;, &quot;&quot;, &quot;Transaction Summary&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot;Install  1 Package (+4 Dependent packages)&quot;, &quot;&quot;, &quot;Total download size: 4.9 M&quot;, &quot;Installed size: 23 M&quot;, &quot;Is this ok [y&#x2F;d&#x2F;N]: Exiting on user command&quot;, &quot;Your transaction was saved, rerun it with:&quot;, &quot; yum load-transaction &#x2F;tmp&#x2F;yum_save_tx.2019-01-10.18-05.jmunIG.yumtx&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息5</p>
<p>这个报错是在错误信息4之前，因为test.example.com主机没有git命令所以才有了错误信息4的步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Close git ssl verification] **********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: true, &quot;cmd&quot;: &quot;git config --global http.sslVerify false&quot;, &quot;delta&quot;: &quot;0:00:00.002747&quot;, &quot;end&quot;: &quot;2019-01-10 18:00:36.334202&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 127, &quot;start&quot;: &quot;2019-01-10 18:00:36.331455&quot;, &quot;stderr&quot;: &quot;&#x2F;bin&#x2F;sh: git: command not found&quot;, &quot;stderr_lines&quot;: [&quot;&#x2F;bin&#x2F;sh: git: command not found&quot;], &quot;stdout&quot;: &quot;&quot;, &quot;stdout_lines&quot;: []&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息6</p>
<p>这个变量没有在deploy.yml中定义，所以会抛出异常解决办法就是在deploy.yml中声明以下backup_to</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;msg&quot;: &quot;The task includes an option with an undefined variable. The error was: &#39;backup_to&#39; is undefined\n\nThe error appears to have been in &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;main.yml&#39;: line 53, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Backup current www folder\n  ^ here\n&quot;&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>deploy.yml中添加颜色加重部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- hosts: wordpress</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">     backup_to: &quot;&#123;&#123;root&#125;&#125;_&#123;&#123;branch&#125;&#125;_&#123;&#123;ansible_date_time.epoch&#125;&#125;&quot;</span><br><span class="line">  roles:</span><br><span class="line">    - wordpress</span><br></pre></td></tr></table></figure>



<p>解决过程中还遇到一个git提交错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git commit -m &quot;first commit&quot;</span><br><span class="line">[master eab3d83] first commit</span><br><span class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class="line"> rename wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;&#123;index.php &#x3D;&gt; info.php&#125; (100%)</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line"> ! [rejected]        master -&gt; master (fetch first)</span><br><span class="line">error: failed to push some refs to &#39;https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git&#39;</span><br><span class="line">hint: Updates were rejected because the remote contains work that you do</span><br><span class="line">hint: not have locally. This is usually caused by another repository pushing</span><br><span class="line">hint: to the same ref. You may want to first integrate the remote changes</span><br><span class="line">hint: (e.g., &#39;git pull ...&#39;) before pushing again.</span><br><span class="line">hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.</span><br></pre></td></tr></table></figure>



<p>解决办法是，在推送到远端之前，先pull一下，然后再提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git pull origin master</span><br><span class="line">remote: Enumerating objects: 1, done.</span><br><span class="line">remote: Counting objects: 100% (1&#x2F;1), done.</span><br><span class="line">remote: Total 1 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (1&#x2F;1), done.</span><br><span class="line">From https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo</span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   2dc88b0..5ea65a4  master     -&gt; origin&#x2F;master</span><br><span class="line">Already up to date!</span><br><span class="line">Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 12, done.</span><br><span class="line">Counting objects: 100% (12&#x2F;12), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (6&#x2F;6), done.</span><br><span class="line">Writing objects: 100% (7&#x2F;7), 648 bytes | 648.00 KiB&#x2F;s, done.</span><br><span class="line">Total 7 (delta 4), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">   5ea65a4..6127999  master -&gt; master</span><br></pre></td></tr></table></figure>
    </div>
    
    
    

    <footer class="post-footer">
          

  <div class="followme">
    <span>欢迎关注我的其它发布渠道</span>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>

          <div class="post-tags">
              <a href="/sugw.github.io/tags/%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/" rel="tag"># 自动部署</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/" rel="prev" title="Jenkins+Gitlab+Ansible自动化部署(五)">
                  <i class="fa fa-chevron-left"></i> Jenkins+Gitlab+Ansible自动化部署(五)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/sugw.github.io/2020/12/01/datagrip/" rel="next" title="datagrip">
                  datagrip <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">guowei su</span>
</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">269k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:04</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>

    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="//cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
<script src="/sugw.github.io/js/utils.js"></script><script src="/sugw.github.io/js/motion.js"></script><script src="/sugw.github.io/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/sugw.github.io/js/local-search.js"></script>












  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: "/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/",
    }, {"enable":true,"appId":"Rvi5XTbIGoBGqGhM3SdPXNnc-gzGzoHsz","appKey":"tsLwTwnG13sIxCOXRrDVxPqW","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});
</script>

    </div>
<!-- hexo injector body_end start --><script src="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.0.5/js/index.js"></script><div id="widget-tree">
      <ul><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Jenkins/">Jenkins</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/23/Jenkins%20pipeline%20%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%A4%9A%E5%88%86%E6%94%AF%E5%8F%91%E7%89%88/" title="Jenkins pipeline 多服务器，多分支发版"><i class="post-icon gg-file-document"></i>Jenkins pipeline 多服务器，多分支发版</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Jenkins-Gitlab-Ansible/">Jenkins+Gitlab+Ansible</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/" title="Jenkins+Gitlab+Ansible自动化部署(三)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(三)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/" title="Jenkins+Gitlab+Ansible自动化部署(五)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(五)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/" title="Jenkins-pipeline的创建和参数传递"><i class="post-icon gg-file-document"></i>Jenkins-pipeline的创建和参数传递</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/" title="Jenkins+Gitlab+Ansible自动化部署(四)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(四)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/" title="Jenkins+Gitlab+Ansible自动化部署(一)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(一)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%8C)/" title="Jenkins+Gitlab+Ansible自动化部署(二)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(二)</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/" title="Jenkins+Gitlab+Ansible自动化部署(六)"><i class="post-icon gg-file-document"></i>Jenkins+Gitlab+Ansible自动化部署(六)</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Linux/">Linux</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/28/Firewalld/" title="Firewalld"><i class="post-icon gg-file-document"></i>Firewalld</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/28/centos6.8%20%E5%AE%89%E8%A3%85supervisor/" title="centos6.8 安装supervisor"><i class="post-icon gg-file-document"></i>centos6.8 安装supervisor</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/20/linux%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96/" title="linux内核优化"><i class="post-icon gg-file-document"></i>linux内核优化</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/21/linux%20%E7%A3%81%E7%9B%98%E6%BB%A1/" title="linux 磁盘"><i class="post-icon gg-file-document"></i>linux 磁盘</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/28/nginx%E9%98%BB%E6%AD%A2IP%E8%AE%BF%E9%97%AE%E5%AE%9E%E4%BE%8B/" title="nginx 阻止IP访问实例"><i class="post-icon gg-file-document"></i>nginx 阻止IP访问实例</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/03/Centos67%20%E5%AE%89%E8%A3%85PHP7.3%E6%95%99%E7%A8%8B/" title="Centos6/7 安装PHP7.3教程"><i class="post-icon gg-file-document"></i>Centos6/7 安装PHP7.3教程</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/Mac/">Mac</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/26/mac%20for%20supervisor/" title="Mac start hexo for supervisor"><i class="post-icon gg-file-document"></i>Mac start hexo for supervisor</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/PHP/">PHP</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/PHP-FPM%20%E8%AE%BE%E7%BD%AE%E5%A4%9Apool%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99/" title="PHP-FPM 设置多pool、配置文件重写"><i class="post-icon gg-file-document"></i>PHP-FPM 设置多pool、配置文件重写</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/PHP-php-fpm%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/" title="PHP-php-fpm配置优化"><i class="post-icon gg-file-document"></i>PHP-php-fpm配置优化</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/ansible/">ansible</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/20/ansible%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/" title="ansible定时任务和用户组模块使用"><i class="post-icon gg-file-document"></i>ansible定时任务和用户组模块使用</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/mysql/">mysql</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/17/%E5%BC%80%E5%90%AFGTID%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%20/" title="开启GTID的情况下导出导入库的注意事项"><i class="post-icon gg-file-document"></i>开启GTID的情况下导出导入库的注意事项</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/wiki/">wiki</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%E5%AE%89%E8%A3%85/" title="mediawiki安装"><i class="post-icon gg-file-document"></i>mediawiki安装</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%20lockdown%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" title="mediawiki lockdown权限配置"><i class="post-icon gg-file-document"></i>mediawiki lockdown权限配置</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/13/mediawiki%E6%82%AC%E6%B5%AE%E7%9B%AE%E5%BD%95/" title="mediawiki悬浮目录"><i class="post-icon gg-file-document"></i>mediawiki悬浮目录</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E4%BC%98%E5%8C%96/">优化</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/Nginx%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3/" title="Nginx优化详解"><i class="post-icon gg-file-document"></i>Nginx优化详解</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86/">接口管理</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/18/DOClever-for-centos7%E5%AE%89%E8%A3%85/" title="DOClever for centos7安装"><i class="post-icon gg-file-document"></i>DOClever for centos7安装</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/27/Mysql%20%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%A4%A7%E5%B0%8F/" title="Mysql数据库查询大小"><i class="post-icon gg-file-document"></i>Mysql数据库查询大小</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/27/Mysql%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E8%A1%A8/" title="Mysql 批量删除表"><i class="post-icon gg-file-document"></i>Mysql 批量删除表</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/17/Mysqldump%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%8E%92%E9%99%A4%E6%9F%90%E4%BA%9B%E5%BA%93/" title="Mysqldump备份数据库时排除某些库"><i class="post-icon gg-file-document"></i>Mysqldump备份数据库时排除某些库</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%B5%8B%E8%AF%95/">测试</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/19/ab%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/" title="ab压测工具"><i class="post-icon gg-file-document"></i>ab压测工具</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E6%BF%80%E6%B4%BB/">激活</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/12/01/datagrip/" title="datagrip"><i class="post-icon gg-file-document"></i>datagrip</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/sugw.github.io/categories/%E7%9B%91%E6%8E%A7/">监控</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/10/26/Prometheus%E7%9B%91%E6%8E%A7node_exporter%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99/" title="Prometheus监控node_exporter的告警规则"><i class="post-icon gg-file-document"></i>Prometheus监控node_exporter的告警规则</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/sugw.github.io/2020/11/23/prometheus-pushgateway/" title="Prometheus-pushgateway"><i class="post-icon gg-file-document"></i>Prometheus-pushgateway</a></li></ul></li></ul>
        <div id="widget-tree-button">
          <i class="gg-chevron-right"></i>
        </div>
      </div><!-- hexo injector body_end end --><script src="/sugw.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-chitose"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
