<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>DOClever for centos7安装</title>
    <url>/sugw.github.io/2020/11/18/DOClever-for-centos7%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>#安装参考</p>
<p><a href="https://github.com/sx1989827/DOClever/blob/master/README.md">https://github.com/sx1989827/DOClever/blob/master/README.md</a> </p>
<h2 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;nodejs.org&#x2F;dist&#x2F;v8.11.1&#x2F;node-v8.11.1-linux-x64.tar.xz</span><br><span class="line">tar xvf node-v8.11.1-linux-x64.tar.xz</span><br><span class="line">mv node-v8.11.1-linux-x64 nodev8</span><br><span class="line">ln -s &#x2F;data&#x2F;nodev8&#x2F;bin&#x2F;node &#x2F;usr&#x2F;local&#x2F;bin&#x2F;node</span><br><span class="line">ln -s &#x2F;data&#x2F;nodev8&#x2F;bin&#x2F;npm &#x2F;usr&#x2F;local&#x2F;bin&#x2F;npm</span><br></pre></td></tr></table></figure>

<h2 id="安装mongodb"><a href="#安装mongodb" class="headerlink" title="安装mongodb"></a>安装mongodb</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;yum.repos.d&#x2F;mongodb-org-4.4.repo</span><br><span class="line">[mongodb-org-4.4]</span><br><span class="line">name&#x3D;MongoDB Repository</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;repo.mongodb.org&#x2F;yum&#x2F;redhat&#x2F;$releasever&#x2F;mongodb-org&#x2F;4.4&#x2F;x86_64&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;www.mongodb.org&#x2F;static&#x2F;pgp&#x2F;server-4.4.asc</span><br><span class="line"></span><br><span class="line">sudo yum install -y mongodb-org</span><br><span class="line">sudo systemctl start mongod</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装studio"><a href="#安装studio" class="headerlink" title="安装studio"></a>安装studio</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;download.studio3t.com&#x2F;robomongo&#x2F;linux&#x2F;studio-3t-robo-3t-linux-double-pack.tar.gz</span><br><span class="line">tar xvf studio-3t-robo-3t-linux-double-pack.tar.gz</span><br><span class="line"> &#x2F;bin&#x2F;sh studio-3t-linux-x64.sh</span><br></pre></td></tr></table></figure>

<h2 id="安装DOClever"><a href="#安装DOClever" class="headerlink" title="安装DOClever"></a>安装DOClever</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;sx1989827&#x2F;DOClever&#x2F;archive&#x2F;master.zip</span><br><span class="line">unzip master.zip</span><br></pre></td></tr></table></figure>

<h2 id="安装supervisor"><a href="#安装supervisor" class="headerlink" title="安装supervisor"></a>安装supervisor</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> yum install supervisor</span><br><span class="line"> systemctl start supervisord</span><br><span class="line"> systemctl enable supervisord</span><br><span class="line"> </span><br><span class="line"> cat &#x2F;etc&#x2F;supervisord.d&#x2F;DOClever.ini</span><br><span class="line">[program:DOClever]</span><br><span class="line">command&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;node &#x2F;data&#x2F;DOClever-master&#x2F;Server&#x2F;bin&#x2F;www</span><br><span class="line">autostart&#x3D;true</span><br><span class="line">startretries&#x3D;10</span><br><span class="line">autorestart&#x3D;true</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;DOClever&#x2F;DOClever.log</span><br><span class="line">stderr_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;DOClever&#x2F;error.log</span><br><span class="line">directory&#x3D;&#x2F;data&#x2F;DOClever-master</span><br><span class="line"></span><br><span class="line"> systemctl restart supervisord</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>接口管理</category>
      </categories>
      <tags>
        <tag>接口管理</tag>
      </tags>
  </entry>
  <entry>
    <title>Firewalld</title>
    <url>/sugw.github.io/2020/10/28/Firewalld/</url>
    <content><![CDATA[<p>启动一个服务：systemctl start firewalld.service</p>
<p>关闭一个服务：systemctl stop firewalld.service</p>
<p>重启一个服务：systemctl restart firewalld.service</p>
<p>显示一个服务的状态：systemctl status firewalld.service</p>
<p>在开机时启用一个服务：systemctl enable firewalld.service</p>
<p>在开机时禁用一个服务：systemctl disable firewalld.service</p>
<p>查看服务是否开机启动：systemctlis-enabled firewalld.service</p>
<p>查看已启动的服务列表：systemctllist-unit-files|grep enabled</p>
<p>查看启动失败的服务列表：systemctl–failed</p>
<p>3.配置firewalld-cmd</p>
<p>查看版本： firewall-cmd –version</p>
<p>查看帮助： firewall-cmd –help</p>
<p>显示状态： firewall-cmd –state</p>
<p>查看所有打开的端口： firewall-cmd–zone=public –list-ports</p>
<p>更新防火墙规则： firewall-cmd –reload</p>
<p>查看区域信息:  firewall-cmd–get-active-zones</p>
<p>查看指定接口所属区域： firewall-cmd–get-zone-of-interface=eth0</p>
<p>拒绝所有包：firewall-cmd –panic-on</p>
<p>取消拒绝状态： firewall-cmd –panic-off</p>
<p>查看是否拒绝： firewall-cmd –query-panic</p>
<p>添加</p>
<p>==firewall-cmd –zone=public –add-port=80/tcp –permanent  （–permanent永久生效，没有此参数重启后失效）==</p>
<p>重新载入</p>
<p>firewall-cmd –reload</p>
<p>查看</p>
<p>firewall-cmd –zone=public –query-port=80/tcp</p>
<p>删除</p>
<p>firewall-cmd –zone=public –remove-port=80/tcp –permanent</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>防火墙</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins pipeline 多服务器，多分支发版</title>
    <url>/sugw.github.io/2020/12/23/Jenkins%20pipeline%20%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%A4%9A%E5%88%86%E6%94%AF%E5%8F%91%E7%89%88/</url>
    <content><![CDATA[<h2 id="Jenkins-pipeline-多服务器，多分支发版"><a href="#Jenkins-pipeline-多服务器，多分支发版" class="headerlink" title="Jenkins pipeline 多服务器，多分支发版"></a>Jenkins pipeline 多服务器，多分支发版</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any </span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">        String0 =  <span class="string">&#x27;$&#123;params.SERVER&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">    <span class="comment">//发版选择</span></span><br><span class="line">    choice(<span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">choices:</span> [<span class="string">&#x27;Deploy&#x27;</span>, <span class="string">&#x27;RollBACK&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;Deploy: 发版\n -------- \n RollBACK: 回滚 &#x27;</span>)</span><br><span class="line">    string <span class="attr">defaultValue:</span> <span class="string">&#x27;0&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;&#x27;&#x27;-------此添加项为回滚的版本号，如果您是发布，请忽略此选项-------&#x27;&#x27;&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;Version&#x27;</span>, <span class="attr">trim:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">//分支选择 </span></span><br><span class="line">    gitParameter <span class="attr">branchFilter:</span> <span class="string">&#x27;origin/(.*)&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;master&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;BRANCH&#x27;</span>, <span class="attr">type:</span> <span class="string">&#x27;PT_BRANCH&#x27;</span></span><br><span class="line">    <span class="comment">//选择服务器</span></span><br><span class="line">    extendedChoice <span class="attr">defaultValue:</span> <span class="string">&#x27;&quot;IP1&quot;&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;选择发版服务器&#x27;</span>, <span class="attr">multiSelectDelimiter:</span> <span class="string">&#x27;,&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;SERVER&#x27;</span>, <span class="attr">quoteValue:</span> <span class="literal">true</span>, <span class="attr">saveJSONParameterToFile:</span> <span class="literal">false</span>, <span class="attr">type:</span> <span class="string">&#x27;PT_CHECKBOX&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;&quot;IP1&quot;,&quot;IP2&quot;,&quot;IP3&quot;&#x27;</span>, <span class="attr">visibleItemCount:</span> <span class="number">5</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;清理本地仓库&#x27;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;if [ &quot;$(ls -A $WORKSPACE|wc -l)&quot; -ge &quot;2&quot; ];then</span></span><br><span class="line"><span class="string">                        cd $WORKSPACE/</span></span><br><span class="line"><span class="string">                        if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                            ls -A|grep -v email.html|xargs rm -rf </span></span><br><span class="line"><span class="string">                        fi</span></span><br><span class="line"><span class="string">                    fi&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">&#x27;拉取项目代码&#x27;</span>) &#123;</span><br><span class="line">      when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        git <span class="attr">branch:</span> <span class="string">&quot;$&#123;params.BRANCH&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;d3eda646-8d66-4cda-a627-cc8a546550af&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git地址&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">&#x27;构建项目&#x27;</span>) &#123;</span><br><span class="line">            when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                if [ -d $WORKSPACE/deploy_history ];then</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                    echo &quot;The file is already exists!!!&quot;</span></span><br><span class="line"><span class="string">                else</span></span><br><span class="line"><span class="string">                    mkdir -p $WORKSPACE/deploy_history</span></span><br><span class="line"><span class="string">                fi</span></span><br><span class="line"><span class="string">                cd $WORKSPACE</span></span><br><span class="line"><span class="string">                tar czf $&#123;env.WORKSPACE&#125;/deploy_history/$&#123;env.JOB_NAME&#125;-$&#123;env.BUILD_NUMBER&#125;.tar.gz ./* --exclude=deploy_history</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;项目备份&#x27;</span>)&#123;</span><br><span class="line">            when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line"> </span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    echo </span></span><br><span class="line"><span class="string">                    BUILD_SAVE=5</span></span><br><span class="line"><span class="string">                    BACKDIR=$&#123;JENKINS_HOME&#125;/backdir/$&#123;JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                    if [ ! -d  $&#123;BACKDIR&#125; ];then</span></span><br><span class="line"><span class="string">                            mkdir -p $&#123;BACKDIR&#125;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    ## 备份当前发布版本代码,加入版本号,供回滚使用</span></span><br><span class="line"><span class="string">                    rsync -avz $&#123;WORKSPACE&#125;/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz $BACKDIR/</span></span><br><span class="line"><span class="string">                    if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                            echo &quot;备份完成,项目版本号为$&#123;BUILD_NUMBER&#125;&quot;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    while true;</span></span><br><span class="line"><span class="string">                    do</span></span><br><span class="line"><span class="string">                    cd $BACKDIR</span></span><br><span class="line"><span class="string">                    BAKFILES=$(ls -1tr *.tar.gz|wc -l)</span></span><br><span class="line"><span class="string">                    if [ $BAKFILES -gt &quot;$BUILD_SAVE&quot; ];then</span></span><br><span class="line"><span class="string">                           ls -1tr *.tar.gz|head -1|xargs rm -f</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                            break;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    done</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;版本回滚&#x27;</span>)&#123;</span><br><span class="line">                when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;RollBACK&#x27;</span> &#125;</span><br><span class="line">     </span><br><span class="line">                steps&#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    BACKDIR=$&#123;JENKINS_HOME&#125;/backdir/$&#123;JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                    ## 根据jenkins版本号选择锁定回滚文件</span></span><br><span class="line"><span class="string">                    if [ &quot;$Version&quot; == &quot;0&quot; ];then</span></span><br><span class="line"><span class="string">                        BACKFILE=$&#123;BACKDIR&#125;/$(ls $BACKDIR -1t|head -2|tail -1)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        BACKFILE=$&#123;BACKDIR&#125;/$&#123;JOB_NAME&#125;-$&#123;Version&#125;.tar.gz</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    if [ -f $&#123;BACKFILE&#125; ];then</span></span><br><span class="line"><span class="string">                            cd $WORKSPACE</span></span><br><span class="line"><span class="string">                            mkdir $WORKSPACE/deploy_history/ -p</span></span><br><span class="line"><span class="string">                            rsync -avz $BACKFILE $WORKSPACE/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz</span></span><br><span class="line"><span class="string">                            if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件拷贝完成&quot;</span></span><br><span class="line"><span class="string">                            else</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件拷贝失败&quot;</span></span><br><span class="line"><span class="string">                            fi</span></span><br><span class="line"><span class="string">                            tar -zxf $WORKSPACE/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz -C $WORKSPACE/</span></span><br><span class="line"><span class="string">                            if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件解压完成&quot;</span></span><br><span class="line"><span class="string">                            else</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件解压失败&quot;</span></span><br><span class="line"><span class="string">                            fi</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                            echo &quot;backfile not find&quot;</span></span><br><span class="line"><span class="string">                            exit 1;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        stage(<span class="string">&#x27;发布项目&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                script &#123;</span><br><span class="line">    				script &#123;</span><br><span class="line">    				    echo <span class="string">&quot;start deploy&quot;</span></span><br><span class="line">    				    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    				    set +x</span></span><br><span class="line"><span class="string">    				    </span></span><br><span class="line"><span class="string">    				    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                        source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">    				    set -x</span></span><br><span class="line"><span class="string">    				    &quot;&quot;&quot;</span></span><br><span class="line">    				    </span><br><span class="line">    					<span class="keyword">for</span> (item <span class="keyword">in</span> <span class="string">&quot;$&#123;params.SERVER&#125;&quot;</span>.tokenize(<span class="string">&#x27;,&quot;&#x27;</span>))&#123;</span><br><span class="line">    					    </span><br><span class="line">    						echo <span class="string">&#x27;Deploying to&#x27;</span>  + item</span><br><span class="line">                            </span><br><span class="line">                            sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                            cd /home/deploy/ansible-playbook-repo/</span></span><br><span class="line"><span class="string">                            ansible-playbook ./api_before-pipeline.yml -i ./hosts -e target=$item -e project=$&#123;JOB_NAME&#125; -e jenkins_dir=$&#123;WORKSPACE&#125; -e project_file=$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz -e job_number=$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125; -e user=www</span></span><br><span class="line"><span class="string">                            &quot;&quot;&quot;</span></span><br><span class="line">                            echo <span class="string">&quot; [INFO] Deployment finished...&quot;</span></span><br><span class="line">    					&#125;</span><br><span class="line">			    	&#125;</span><br><span class="line">			    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> cat roles&#x2F;api_before-pipeline&#x2F;tasks&#x2F;main.yml</span><br><span class="line">- name: copy  &#123;&#123; project &#125;&#125;</span><br><span class="line">  copy: &#39;src&#x3D;&#123;&#123; jenkins_dir &#125;&#125;&#x2F;deploy_history&#x2F;&#123;&#123;project_file&#125;&#125; dest&#x3D;&#x2F;data&#x2F;deploy&#x2F;&#123;&#123; project &#125;&#125;&#x2F;&#39;</span><br><span class="line"></span><br><span class="line">- name: create deploy file</span><br><span class="line">  file:</span><br><span class="line">    path&#x3D;&#x2F;data&#x2F;deploy&#x2F;&#123;&#123; project &#125;&#125;&#x2F;&#123;&#123; job_number &#125;&#125;</span><br><span class="line">    mode&#x3D;0755</span><br><span class="line">    owner&#x3D;&#123;&#123; user &#125;&#125;</span><br><span class="line">    group&#x3D;&#123;&#123; user &#125;&#125;</span><br><span class="line">    state&#x3D;directory</span><br><span class="line"></span><br><span class="line">- name: Unzip the project</span><br><span class="line">  unarchive: &#39;src&#x3D;&#x2F;data&#x2F;deploy&#x2F;&#123;&#123; project &#125;&#125;&#x2F;&#123;&#123; project_file &#125;&#125; dest&#x3D;&#x2F;data&#x2F;deploy&#x2F;&#123;&#123; project &#125;&#125;&#x2F;&#123;&#123; job_number &#125;&#125; copy&#x3D;no&#39;</span><br><span class="line"></span><br><span class="line">- name: Link site directory</span><br><span class="line">  shell: &#39;ln -snf &#x2F;data&#x2F;deploy&#x2F;&#123;&#123; project &#125;&#125;&#x2F;&#123;&#123; job_number &#125;&#125; &#x2F;data&#x2F;www&#x2F;&#123;&#123; project &#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">- name: chage www folder permission</span><br><span class="line">  file: &#39;path&#x3D;&#x2F;data&#x2F;www&#x2F; mode&#x3D;0755 owner&#x3D;&#123;&#123; user&#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(三)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/</url>
    <content><![CDATA[<p>接Jenkins+Gitlab+Ansible自动化部署（一）<a href="https://www.cnblogs.com/zd520pyx1314/p/10210727.html">https://www.cnblogs.com/zd520pyx1314/p/10210727.html</a> 和（二）<a href="https://www.cnblogs.com/zd520pyx1314/p/10213549.html">https://www.cnblogs.com/zd520pyx1314/p/10213549.html </a></p>
<p>Jenkins是一个开源持续集成工具，提供了软甲你开发的持续集成服务，支持主流软件配置管理，配合实现软件配置管理，持续集成功能。是主流的运维开发平台，兼容所有主流开发环境，插件市场可与海量业内主流开发工具实现集成，Job为配置单位与日志管理，使运维与开发人员能协同工作。丰富的权限管理划分不同Job不同角色；强大的负载均衡功能，保证我们项目的可靠性。</p>
<p><strong>Jenkins的安装、配置与管理</strong></p>
<p>添加Jenkins yum仓库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">官网地址</span><br><span class="line">https:&#x2F;&#x2F;pkg.jenkins.io&#x2F;redhat-stable&#x2F;</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;jenkins.repo https:&#x2F;&#x2F;pkg.jenkins.io&#x2F;redhat-stable&#x2F;jenkins.repo</span><br><span class="line">[root@jenkins ~]# rpm --import https:&#x2F;&#x2F;pkg.jenkins.io&#x2F;redhat-stable&#x2F;jenkins.io.key</span><br><span class="line">安装Java</span><br><span class="line">[root@jenkins ~]# yum install -y java</span><br><span class="line">[root@jenkins ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_191&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_191-b12)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode)</span><br><span class="line">安装Jenkins</span><br><span class="line">[root@jenkins ~]# yum list | grep &#39;jenkins&#39;</span><br><span class="line">jenkins.noarch  </span><br><span class="line">[root@jenkins ~]# yum install -y jenkins</span><br></pre></td></tr></table></figure>

<p>创建Jenkins系统服务用户并配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">创建Jenkins系统服务用户</span><br><span class="line">[root@jenkins ~]# useradd deploy</span><br><span class="line">[root@jenkins ~]# cp &#x2F;etc&#x2F;sysconfig&#x2F;jenkins&#123;,.bak&#125;</span><br><span class="line">[root@jenkins ~]# vim &#x2F;etc&#x2F;sysconfig&#x2F;jenkins</span><br><span class="line"># 大约在29行，改为deploy用户</span><br><span class="line">29 JENKINS_USER&#x3D;&quot;deploy&quot;</span><br><span class="line"># 确定Jenkins端口号8080</span><br><span class="line">56 JENKINS_PORT&#x3D;&quot;8080&quot;</span><br><span class="line">更改目录权限</span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy &#x2F;var&#x2F;lib&#x2F;jenkins</span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy &#x2F;var&#x2F;log&#x2F;jenkins&#x2F;</span><br><span class="line">启动Jenkins</span><br><span class="line">[root@jenkins ~]# systemctl start jenkins</span><br><span class="line">[root@jenkins ~]# lsof -i:8080</span><br><span class="line"># 这里发现端口没起来，查看日志发现</span><br><span class="line">[root@jenkins ~]# cat &#x2F;var&#x2F;log&#x2F;jenkins&#x2F;jenkins.log</span><br><span class="line">java.io.FileNotFoundException: &#x2F;var&#x2F;cache&#x2F;jenkins&#x2F;war&#x2F;META-INF&#x2F;MANIFEST.MF (Permission denied)</span><br><span class="line"># 然后赋予deploy目录权限</span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy &#x2F;var&#x2F;cache&#x2F;jenkins&#x2F;</span><br><span class="line">[root@jenkins ~]# systemctl restart jenkins</span><br><span class="line">[root@jenkins ~]# lsof -i:8080</span><br><span class="line">COMMAND  PID   USER   FD   TYPE DEVICE SIZE&#x2F;OFF NODE NAME</span><br><span class="line">java    4086 deploy  163u  IPv6  49665      0t0  TCP *:webcache (LISTEN)</span><br><span class="line">启动成功</span><br></pre></td></tr></table></figure>

<p>登录jenkins web管理界面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109081517163-2114153447-20201126190249856.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109081626700-723998084-20201126190249837.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082239880-237022095-20201126190249822.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082318765-2143972765-20201126190249852.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082335879-1281083527-20201126190249820.png" class title="img">

<p>点击“Start using jenkins”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082514810-201360737-20201126190249812.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082719110-1415462867-20201126190249933.png" class title="img">

<p><strong>Jenkins Job构建</strong></p>
<p>Freestyle Job与Pipeline Job区别：</p>
<p>Freestyle Job需要在页面添加模块配置项与参数完成配置；每个Job仅能实现一个开发功能；无法将配置代码化，不利于Job配置迁移与版本控制；逻辑相对简单，无需额外学习成本。</p>
<p>Pipeline Job匹配持续集成与持续交付的概念;所有模块、参数配置都可以体现为一个pipeline脚本；可定义多个stage构建一个管道工作集；所有配置代码化，方便Job配置迁移与版本控制；需要Pipeline脚本语法基础。</p>
<p><strong>Jenkins Job构建之环境准备（添加Jenkins后台git client user与email）</strong></p>
<p>1.配置Jenkins server本地GItlab DNS</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# vim &#x2F;etc&#x2F;hosts</span><br><span class="line"># 文件末尾添加如下一条记录</span><br><span class="line">192.168.244.130 gitlab.example.com</span><br></pre></td></tr></table></figure>

<p> 2.安装git client,curl工具依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# yum install -y git curl</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关闭系统git http.sslVerify安全认证</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# git config --system http.sslVerify false</span><br><span class="line">[root@jenkins ~]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>4.添加Jenkins后台git client user与email</p>
<p>首先登录Jenkins web管理页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084213080-1358957517-20201126190249885.png" class title="img">

<p>在Git plugin选项中填写以下信息，点击保存</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084413710-1327479070-20201126190249866.png" class title="img">

<p>接下来添加凭据，点击“凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084855295-161429267-20201126190249903.png" class title="img">



<p>点击“全局凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084938261-1920709690-20201126190249915.png" class title="img">

<p>点击“添加凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085158834-1103026643-20201126190249924.png" class title="img">

<p>添加完成会提示如下图所示</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085221186-1109971985-20201126190249965.png" class title="img">

<p>接着添加一个Jenkins freestyle job</p>
<p>点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085416483-615353023-20201126190249917.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085535820-429058585-20201126190249972.png" class title="img">

<p>填写描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085656285-297058289-20201126190249972.png" class title="img">

<p>添加参数</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085744007-1248036268-20201126190249979.png" class title="img">

<p>接着点击添加“文本参数” </p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090146442-1850185077-20201126190249979.png" class title="img">

<p>添加完成后点击“save”即可，接着回到Jenkins首页，点击刚才创建的“test-freestyle-job”黑色小三角，找到“configure”选项，开始添加git源码管理</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090555819-1615649654-20201126190249990.png" class title="img">

<p>使用root登录gitlab，复制test-repo仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090828866-807026891-20201126190250034.png" class title="img">

<p>粘贴至下面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109091101815-196564836-20201126190250031.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100937058-2135270099-20201126190250054.png" class title="img">



<p>接着进行“build 配置”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100122390-1257749025-20201126190250039.png" class title="img">

<p>在以下框内粘贴</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100220904-751145266-20201126190250052.png" class title="img">



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Print env variable</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Print env variable&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Current deployment envrionment is <span class="variable">$deploy_env</span>&quot;</span> &gt;&gt; test.properties</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;THe build is <span class="variable">$version</span>&quot;</span> &gt;&gt; test.properties</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Done...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check test properties</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Check test properties&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -s test.properties ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  cat test.properties</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;test.properties is empty&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Build finished...&quot;</span></span><br></pre></td></tr></table></figure>



<p>接下来点击“Build with Parameters”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101418019-1763426339-20201126190250047.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101528999-2110448840-20201126190250097.png" class title="img">

<p>提示失败，点击红色失败按钮，查看日志并解决</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101630227-44210240-20201126190250093.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101707180-924579553-20201126190250136.png" class title="img">

<p>可以看出还是之前的git有点问题，回到test-freestyle-job配置项，查看并确认</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109134829251-494673673-20201126190250104.png" class title="img">

<p>然后重新构建</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109140716411-601549284-20201126190250122.png" class title="img">

<p>可以看到已经成功构建。</p>
<p><strong>接下来演示Jenkins Pipeline Job构建过程</strong></p>
<p>Pipeline基础架构</p>
<p>1.所有代码包裹在pipeline{}层内</p>
<p>2.stages{}层用来包含该pipeline所有stage子层</p>
<p>3.stage{}层用来包含具体我们需要编写任务的steps{}子层</p>
<p>4.steps{}用来添加我们具体需要调用的模块语句</p>
<p>agent区域</p>
<ul>
<li>agent定义pipeline在哪里运行，可以使用any,none,或具体的Jenkins node主机名等；例如：假定我们要特指在node1上执行，可以写成：agent{node1 {label ‘node1’}}。</li>
</ul>
<p>environment区域</p>
<ul>
<li>“变量名称=变量值”定义我们的环境变量；</li>
<li>可以定义全局环境变量，应用所有stage任务</li>
<li>可以定义stage环境变量，应用单独的stage任务</li>
</ul>
<p>script区域（可选）</p>
<ul>
<li>在steps内定义script{}；</li>
<li>groovy脚本语言；</li>
<li>用来进行脚本逻辑运算；</li>
</ul>
<p>常用steps区域</p>
<ul>
<li>echo：打印输出</li>
<li>sh:调用Linux系统shell命令</li>
<li>git url:调用git模块进行git相关操作</li>
</ul>
<p><strong>开始构建Jenkins Pipeline Job</strong></p>
<p>首先登录到Jenkins web 管理页</p>
<p>点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109143745658-319503731-20201126190250119.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109143857612-1734103608-20201126190250169.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144252732-493693831-20201126190250143.png" class title="img">



<p>添加pipeline script</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144953517-2101125996-20201126190250152.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144338170-287033618-20201126190250174.png" class title="img">

<p>pipeline script脚本内容（用上述复制下来的ID粘贴至credentialsId后）</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label <span class="string">&#x27;master&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            <span class="symbol">choices:</span> <span class="string">&#x27;dev\nprod&#x27;</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;choose deploy environment&#x27;</span>,</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;deploy_env&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        string (<span class="attr">name:</span> <span class="string">&#x27;version&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;1.0.0&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;build version&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&quot;Checkout test repo&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    git <span class="attr">branch:</span> <span class="string">&#x27;master&#x27;</span>, <span class="attr">credentialsId:</span><span class="string">&quot;b974bdfd-bb73-4f0a-8a0d-85d867681ed0&quot;</span>, <span class="attr">url:</span> <span class="string">&#x27;https://root@gitlab.example.com/root/test-repo.git&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;Print env variable&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Print env variable&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;Current deployment environment is $deploy_env&quot; &gt;&gt; test.properties</span></span><br><span class="line"><span class="string">                    echo &quot;The build is $version&quot; &gt;&gt; test.properties</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;Check test properties&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Check test properties&quot;</span></span><br><span class="line"><span class="string">                    if [ -s test.properties ]</span></span><br><span class="line"><span class="string">                    then </span></span><br><span class="line"><span class="string">                        cat test.properties</span></span><br><span class="line"><span class="string">                        echo &quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        echo &quot;test.properties is empty&quot;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">                    echo <span class="string">&quot;[INFO] Build finished...&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>“保存”之后，点击“立即构建”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109145708989-943685020-20201126190250188.png" class title="img">

<p>报错，点击查看报错信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109145822391-1260621257-20201126190250203.png" class title="img">

<p>根据错误提示：没有找到对应参数的变量，是因为首次构建pipeline job时，参数没有被引用到当前pipeline job当中，返回test-pipeline-job主界面，此时的“立即构建”按钮会变为“Build with Parameters”,点击“Build with Parameters”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109150419295-1383499991-20201126190250215.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109150446540-1007804867-20201126190250218.png" class title="img">

<p>可以看到第二次构建是成功的，点击#2前的蓝色圆球查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Running in Durability level: MAX_SURVIVABILITY</span><br><span class="line">[Pipeline] node</span><br><span class="line">Running on Jenkins in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;test-pipeline-job</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] withEnv</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] stage</span><br><span class="line">[Pipeline] &#123; (Checkout test repo)</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ git config --global http.sslVerify false</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;test-pipeline-job</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] git</span><br><span class="line"> &gt; git rev-parse --is-inside-work-tree # timeout&#x3D;10</span><br><span class="line">Fetching changes from the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;root@gitlab.example.com&#x2F;root&#x2F;test-repo.git # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;root@gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line"> &gt; git --version # timeout&#x3D;10</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;root@gitlab.example.com&#x2F;root&#x2F;test-repo.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line">Checking out Revision dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef (refs&#x2F;remotes&#x2F;origin&#x2F;master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -f dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef</span><br><span class="line"> &gt; git branch -a -v --no-abbrev # timeout&#x3D;10</span><br><span class="line"> &gt; git branch -D master # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -b master dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef</span><br><span class="line">Commit message: &quot;Merge branch &#39;release-1.0.0&#39; into &#39;master&#39;&quot;</span><br><span class="line"> &gt; git rev-list --no-walk dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef # timeout&#x3D;10</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] stage</span><br><span class="line">[Pipeline] &#123; (Print env variable)</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;test-pipeline-job</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ echo &#39;[INFO] Print env variable&#39;</span><br><span class="line">[INFO] Print env variable</span><br><span class="line">+ echo &#39;Current deployment environment is dev&#39;</span><br><span class="line">+ echo &#39;The build is 1.0.0&#39;</span><br><span class="line">+ echo &#39;[INFO] Done...&#39;</span><br><span class="line">[INFO] Done...</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] stage</span><br><span class="line">[Pipeline] &#123; (Check test properties)</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;test-pipeline-job</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ echo &#39;[INFO] Check test properties&#39;</span><br><span class="line">[INFO] Check test properties</span><br><span class="line">+ &#39;[&#39; -s test.properties &#39;]&#39;</span><br><span class="line">+ cat test.properties</span><br><span class="line">Current deployment environment is dev</span><br><span class="line">The build is 1.0.0</span><br><span class="line">+ echo &#39;[INFO] Done...&#39;</span><br><span class="line">[INFO] Done...</span><br><span class="line">[Pipeline] echo</span><br><span class="line">[INFO] Build finished...</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>



<p>可以看到输出状态为“SUCCESS”，证明构建成功。</p>
]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(五)</title>
    <url>/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/</url>
    <content><![CDATA[<p><strong>Freestyle Job实现静态网站部署交付（接Jenkins+Gitlab+Ansible自动化部署（四</strong></p>
<ul>
<li>环境构建</li>
<li>编写ansible playbook脚本实现静态网页远程部署</li>
<li>将playbook部署脚本提交到GitLab仓库</li>
<li>构建Freestyle Job任务框架</li>
<li>Jenkins集成Ansible与Gitlab实现静态网页的自动化部署</li>
</ul>
<p>首先确定自己的环境已经准备完毕。</p>
<p>登录gitlab查看</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110114757705-2039134505.png" class title="img">

<p>登录Jenkins首页</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110114859004-607837330.png" class title="img">

<p>登录Jenkins主机查看Ansible2.5+python 3.6虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ssh root@192.168.244.131</span><br><span class="line">Last login: Wed Jan  9 13:40:48 2019 from 192.168.244.1</span><br><span class="line">[root@jenkins ~]# su - deploy</span><br><span class="line">Last login: Wed Jan  9 20:24:43 CST 2019 on pts&#x2F;0</span><br><span class="line">[deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate           (.py3-a2.5-env) [deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ansible --version</span><br><span class="line">ansible 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$</span><br></pre></td></tr></table></figure>

<p>准备就绪，开始编写ansible playbook脚本实现静态网页远程部署，打开Git bash命令行，将之前创建好的ansible-playbook-repo仓库clone到本地：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~</span><br><span class="line">$ git config --global http.sslVerify false</span><br><span class="line">xueji@xueji MINGW64 ~</span><br><span class="line">$ cd Desktop&#x2F;repo&#x2F;</span><br><span class="line">$  git clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">Cloning into &#39;ansible-playbook-repo&#39;...</span><br><span class="line">remote: Enumerating objects: 3, done.</span><br><span class="line">remote: Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3&#x2F;3), done.</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total 9</span><br><span class="line">-rw-r--r-- 1 xueji 1049089   0 1月  10 11:57 ansible-playbook.txt</span><br><span class="line">drwxr-xr-x 1 xueji 1049089   0 1月  10 12:02 nginx_playbooks&#x2F;</span><br><span class="line">-rw-r--r-- 1 xueji 1049089 312 7月  15 08:33 nginx-freestyle-job.sh</span><br><span class="line">drwxr-xr-x 1 xueji 1049089   0 1月  10 12:02 test_playbooks&#x2F;</span><br></pre></td></tr></table></figure>

<p>开始配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total 2</span><br><span class="line">-rw-r--r-- 1 xueji 1049089 17 7月  17 21:06 deploy.retry</span><br><span class="line">-rw-r--r-- 1 xueji 1049089 80 7月  17 21:06 deploy.yml</span><br><span class="line">drwxr-xr-x 1 xueji 1049089  0 1月  10 12:02 inventory&#x2F;</span><br><span class="line">drwxr-xr-x 1 xueji 1049089  0 1月  10 12:02 roles&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim deploy.yml</span><br><span class="line">- hosts: &quot;nginx&quot;</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - nginx</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;prod</span><br><span class="line">[nginx]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[nginx:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;80</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;4</span><br><span class="line">max_open_file&#x3D;65505</span><br><span class="line">root&#x3D;&#x2F;www</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;dev</span><br><span class="line">[nginx]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[nginx:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;80</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;4</span><br><span class="line">max_open_file&#x3D;65505</span><br><span class="line">root&#x3D;&#x2F;www</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;nginx&#x2F;files&#x2F;health_check.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">URL&#x3D;$1</span><br><span class="line"></span><br><span class="line">curl -Is http:&#x2F;&#x2F;$URL &gt; &#x2F;dev&#x2F;null &amp;&amp; echo &quot;The remote side is healthy&quot; || echo &quot;The remote side is failed, please check&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ cat roles&#x2F;nginx&#x2F;files&#x2F;index.html</span><br><span class="line">This is my first website</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;nginx&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"># For more information on configuration, see:</span><br><span class="line">user              &#123;&#123; user &#125;&#125;;</span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;</span><br><span class="line"></span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    # Load config files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory</span><br><span class="line">    # The default server is in conf.d&#x2F;default.conf</span><br><span class="line">    #include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;</span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs&#x2F;host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#123;&#123; root &#125;&#125;;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page  404              &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;404.html &#123;</span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page &#x2F;50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;nginx&#x2F;tasks&#x2F;main.yml</span><br><span class="line">- name: Disable system firewall</span><br><span class="line">  service: name&#x3D;firewalld state&#x3D;stopped</span><br><span class="line"></span><br><span class="line">- name: Disable SELINUX</span><br><span class="line">  selinux: state&#x3D;disabled</span><br><span class="line"></span><br><span class="line">- name: setup nginx yum source</span><br><span class="line">  yum: pkg&#x3D;epel-release state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: write then nginx config file</span><br><span class="line">  template: src&#x3D;roles&#x2F;nginx&#x2F;templates&#x2F;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">- name: create nginx root folder</span><br><span class="line">  file: &#39;path&#x3D;&#123;&#123; root &#125;&#125; state&#x3D;directory owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125; mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: copy index.html to remote</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;nginx&#x2F;files&#x2F;index.html dest&#x3D;&#x2F;www&#x2F;index.html mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: restart nginx service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: run the health check locally</span><br><span class="line">  shell: &quot;sh roles&#x2F;nginx&#x2F;files&#x2F;health_check.sh &#123;&#123; server_name &#125;&#125;&quot;</span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: msg&#x3D;&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>将配置好的文件，提交到远程gitlab</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;nginx_playbooks (master)</span><br><span class="line">$ cd ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ git commit -m&quot;First commit&quot;</span><br><span class="line">[master 06431dc] First commit</span><br><span class="line"> 8 files changed, 122 deletions(-)</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;deploy.retry</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;deploy.yml</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;inventory&#x2F;dev</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;inventory&#x2F;prod</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;roles&#x2F;nginx&#x2F;files&#x2F;health_check.sh</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;roles&#x2F;nginx&#x2F;files&#x2F;index.html</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;roles&#x2F;nginx&#x2F;tasks&#x2F;main.yml</span><br><span class="line"> delete mode 100644 test_playbooks&#x2F;roles&#x2F;nginx&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 3, done.</span><br><span class="line">Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (2&#x2F;2), done.</span><br><span class="line">Writing objects: 100% (2&#x2F;2), 212 bytes | 212.00 KiB&#x2F;s, done.</span><br><span class="line">Total 2 (delta 1), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">   169dec7..06431dc  master -&gt; master</span><br></pre></td></tr></table></figure>

<p>返回到Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110123958236-403778399.png" class title="img">

<p>添加描述</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124110288-1434823474.png" class title="img">

<p>添加Git仓库（该仓库地址即为上述配置的ansible-playbook-repo的仓库地址）</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124237561-37305220.png" class title="img">

<p>参数化构建过程</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110125704491-2057128880.png" class title="img">

<p>添加构建步骤</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124349459-278531014.png" class title="img">

<p>在执行shell弹出的输入框内输入以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">set +x</span><br><span class="line">source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line"></span><br><span class="line">cd $WORKSPACE&#x2F;nginx_playbooks</span><br><span class="line">ansible --version</span><br><span class="line">ansible-playbook --version</span><br><span class="line"></span><br><span class="line">ansible-playbook -i inventory&#x2F;$deploy_env .&#x2F;deploy.yml -e project&#x3D;nginx -e branch&#x3D;$branch -e env&#x3D;$deploy_env</span><br></pre></td></tr></table></figure>

<p>点击“Save”，然后点击“Build with Parameters”，在右侧下拉列表中选择dev，点击“Build”</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110125928002-1300800677.png" class title="img">

<p>查看输出信息</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130432060-169697566.png" class title="img">

<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130455058-1081834209.png" class title="img">

<p>验证目标主机是否部署成功，在浏览器输入test.exmaple.com查看</p>
<p>前提是保证本地windows主机下的C:\Windows\System32\drivers\etc\hosts文件中末尾有如下对应关系</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.244.130 gitlab.example.com</span><br><span class="line">192.168.244.131 jenkins.example.com</span><br><span class="line">192.168.244.132 ansible.example.com</span><br><span class="line">192.168.244.133 test.example.com</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130936245-979652804.png" class title="img">

<p>可以看到已经成功部署~</p>
]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins-pipeline的创建和参数传递</title>
    <url>/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/</url>
    <content><![CDATA[<h2 id="一、单分支的pipeline"><a href="#一、单分支的pipeline" class="headerlink" title="一、单分支的pipeline"></a><strong>一、单分支的pipeline</strong></h2><p>Pipline的特点是可以多节点运行，节点之间可以并行或者串行执行，从而实现编译-部署-部署的持续化构建和发布。</p>
<p>与自由风格不同的是，我们可以通过编写功能强大的Jenkinsfile脚本，来实现我们所需要的功能，比如：执行shell，执行bat，重试，等待，并行/串行，发邮件，触发其他工程。难点在于需要遵循一定的Groovy语法。有一定的学习成本。</p>
<ol>
<li><h4 id="job的创建"><a href="#job的创建" class="headerlink" title="job的创建"></a>job的创建</h4></li>
</ol>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-d0c14a7f65815132bf26825168817ae9188.png" class title="img">





<h4 id="2-job的配置"><a href="#2-job的配置" class="headerlink" title="2. job的配置"></a>2. job的配置</h4><p>最主要的就是如下图的脚本编写。</p>
<p>（1）选择pipeline script 则就是在文本框中中编写执行的脚本</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-42989560c0b158a8e7472757b1143d92fa6.png" class title="img">

<p>（2）选择pipeline script from scm 则需要指定git项目地址，并在项目路径下创建一个名为Jenkinsfile的文本文件, 然后编写Groovy脚本。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-e539db5914ca4e803acfe33b91fbaafcec3.png" class title="img">

<p>（3）Groovy语法参考：</p>
<p><a href="https://www.jenkins.io/zh/doc/pipeline/tour/getting-started/">https://www.jenkins.io/zh/doc/pipeline/tour/getting-started/</a></p>
<h2 id="二、多分支的pipeline"><a href="#二、多分支的pipeline" class="headerlink" title="二、多分支的pipeline"></a><strong>二、多分支的pipeline</strong></h2><p>顾名思义，多分支pipeline就是能够实现每个分支都可以实现流水线，前提是需要每个分支下都有一个名为Jenkinsfile的文本文件。</p>
<h3 id="1-传统配置："><a href="#1-传统配置：" class="headerlink" title="1. 传统配置："></a><strong>1. 传统配置：</strong></h3><p>新建任务的时候，选择如下类型</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-fb546dc5b749db89c584a5f2c5e4768c2f1.png" class title="img">

<p><strong>配置</strong>。主要就是确定项目的地址。其余默认即可。此项目下的所有分支都会寻找一个Jenkinsfile的文本文件。如果找到了就执行，没有找到就放弃。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-8b0432ba5447e65fd4105f915af386b5001.png" class title="img">



<p>比如，我的一个am项目路径下master分支的Jenkinsfile文件，如下图：</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-7cb5d2fd0f46675ad8d53ad71660bc3728f.png" class title="img">

<p><strong>面板查看</strong>。提供一些简要信息，比如编译的哪些项目，编译时间，点击可以查看具体项目的日志。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-496ab70e31c3e0c7ab0dceb2d28be7ec5b5.png" class title="img">



<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="2-Blue-ocean创建："><a href="#2-Blue-ocean创建：" class="headerlink" title="2. Blue ocean创建："></a><strong>2. Blue ocean创建：</strong></h3><p>Blue ocean视图是专门为流水线任务打造的，可以实现创建、编辑、查看日志等功能。点击上图中的左边 “打开Blue Ocean” 即可进入。</p>
<p>比如am 项目下有三个分支都有jenkinsfile，所以显示了三个分支，并且每个分支执行都是成功的。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-c559495da3e9bb80847dfe1fe71b4894b34.png" class title="img">

<p>可点击master分支，查看详情。Build Test Deploy是顺序运行的三个阶段（stage）每个stage中可以包含多个步骤（step）。点击右上角的编辑按钮，可以实现编辑。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-d5961cb90b3183d0a7b291b800cad9f719b.png" class title="img">

<p>点击图中的+号，可以在右侧添加步骤，保存后会在相应分支生成Jenkinsfile文件。更加详细的步骤可以参考：<a href="https://www.jenkins.io/zh/doc/book/blueocean">https://www.jenkins.io/zh/doc/book/blueocean</a></p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-b9ab5a63a198c1ed421cc679aca0ac238af.png" class title="img">







<h2 id="三、-注意事项"><a href="#三、-注意事项" class="headerlink" title="三、 注意事项"></a><strong>三、 注意事项</strong></h2><h4 id="（1）参数化构建。"><a href="#（1）参数化构建。" class="headerlink" title="（1）参数化构建。"></a>（1）参数化构建。</h4><p>如果想实现和自由风格一样的参数化构建功能，在选项栏中直接配置是不行的，如下设置是不生效的</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-9dc966a3419d119122f8949cc72191bab94.png" class title="img">

<p>脚本内容：  </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">    pipeline &#123;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line"></span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      steps &#123;</span><br><span class="line"></span><br><span class="line">           echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上脚本，在脚本里获取参数是不行的，即${isPublishVersion} 为null。</p>
<p>解决方案：参数化构建需要在脚本里定义，而不是在选项栏中配置。脚本参考：   </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"> pipeline &#123;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line"></span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parameters &#123;</span><br><span class="line"></span><br><span class="line">          booleanParam(<span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">defaultValue:</span> <span class="literal">false</span>, <span class="attr">description:</span> <span class="string">&#x27;默认不发布&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          choice(<span class="attr">choices:</span> [<span class="string">&#x27;origin/release-bugfix&#x27;</span>, <span class="string">&#x27;origin/release&#x27;</span>, <span class="string">&#x27;origin/master&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;构建分支选择，默认origin/release-bugfix&#x27;</span> , <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stages &#123;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      steps &#123;</span><br><span class="line"></span><br><span class="line">           echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存此脚本后，参数化构建选项栏将会自动根据脚本的参数设置自动生成。如此可实现和普通项目一样的参数选择构建。</p>
<h4 id="2-多项目间参数传递："><a href="#2-多项目间参数传递：" class="headerlink" title="2. 多项目间参数传递："></a>2. 多项目间参数传递：</h4><p>流水线中可能会执行多个任务，每个任务执行在不同机器上，而子项目可能会依赖一些参数设置，此时，在执行子项目时就需要传递参数。</p>
<p>对于String类型的传递，可以使用如下方式，GIT_LOCAL_BRANCH 参数便是前面脚本里设置的，现在需要传给zerotrust-idam-framework-dailybuild-IAM项目。请注意值的取法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">build job: &#39;zerotrust-idam-framework-dailybuild-IAM&#39;, parameters: [string(name:&#39;GIT_LOCAL_BRANCH&#39;, value: &quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;)]</span><br></pre></td></tr></table></figure>

<p>对于Boolean类型的参数传递，只能使用如下方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[$class: &#39;BooleanParameterValue&#39;, name: &#39;isPublishVersion&#39;, value:  &quot;$&#123;params.isPublishVersion&#125;&quot;]</span><br></pre></td></tr></table></figure>

<p>如果Boolean和String类型都需要传递，则只能使用以下方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">build job: &#39;zerotrust-idam-am-dailybuild-IAM&#39;, parameters: [</span><br><span class="line"></span><br><span class="line">              [$class: &#39;StringParameterValue&#39;, name: &#39;GIT_LOCAL_BRANCH&#39;, value: &quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;],</span><br><span class="line"></span><br><span class="line">              [$class: &#39;BooleanParameterValue&#39;, name: &#39;isPublishVersion&#39;, value:  &quot;$&#123;params.isPublishVersion&#125;&quot;]</span><br><span class="line"></span><br><span class="line">            ]</span><br></pre></td></tr></table></figure>

<p>另外，注意boolean类型的值传递其实也是string类型，所以前面的boolean参数值传递写法为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">value: &quot;$&#123;params.isPublishVersion&#125;&quot;</span><br></pre></td></tr></table></figure>



<p>最后，贴下自己写的流水线脚本，仅供参考。实现了job的参数化构建，以及job间的参数传递：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  parameters &#123;</span><br><span class="line">          booleanParam(<span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">defaultValue:</span> <span class="literal">false</span>, <span class="attr">description:</span> <span class="string">&#x27;默认不发布&#x27;</span>)</span><br><span class="line">          choice(<span class="attr">choices:</span> [<span class="string">&#x27;origin/release&#x27;</span>,<span class="string">&#x27;origin/release-bugfix&#x27;</span>, <span class="string">&#x27;origin/master&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;构建分支选择，默认origin/release-bugfix&#x27;</span> , <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">	    echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line">        build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-framework-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [string(<span class="attr">name:</span><span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>)]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;buildIAM&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">        stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-idm-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-authz-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span>  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-am-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span>  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;deploy&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">            stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-idm-dailydeploy&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-am-dailyDeploy&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;smoke&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">            stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-idm-smoke&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-am-smoke&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行过后的Ocean Blue视图：smoke阶段的IDM步骤构建失败了。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-5ade856b069dc30e49305e58db6479db001.png" class title="img">]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql数据库查询大小</title>
    <url>/sugw.github.io/2020/10/27/Mysql%20%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<h2 id="查询库大小"><a href="#查询库大小" class="headerlink" title="查询库大小"></a>查询库大小</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.查看所有数据库容量大小</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">table_schema as &#39;数据库&#39;,</span><br><span class="line">sum(table_rows) as &#39;记录数&#39;,</span><br><span class="line">sum(truncate(data_length&#x2F;1024&#x2F;1024, 2)) as &#39;数据容量(MB)&#39;,</span><br><span class="line">sum(truncate(index_length&#x2F;1024&#x2F;1024, 2)) as &#39;索引容量(MB)&#39;</span><br><span class="line">from information_schema.tables</span><br><span class="line">group by table_schema</span><br><span class="line">order by sum(data_length) desc, sum(index_length) desc;</span><br><span class="line">2.查看所有数据库各表容量大小</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">table_schema as &#39;数据库&#39;,</span><br><span class="line">table_name as &#39;表名&#39;,</span><br><span class="line">table_rows as &#39;记录数&#39;,</span><br><span class="line">truncate(data_length&#x2F;1024&#x2F;1024, 2) as &#39;数据容量(MB)&#39;,</span><br><span class="line">truncate(index_length&#x2F;1024&#x2F;1024, 2) as &#39;索引容量(MB)&#39;</span><br><span class="line">from information_schema.tables</span><br><span class="line">order by data_length desc, index_length desc;</span><br><span class="line">3.查看指定数据库容量大小</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">table_schema as &#39;数据库&#39;,</span><br><span class="line">sum(table_rows) as &#39;记录数&#39;,</span><br><span class="line">sum(truncate(data_length&#x2F;1024&#x2F;1024, 2)) as &#39;数据容量(MB)&#39;,</span><br><span class="line">sum(truncate(index_length&#x2F;1024&#x2F;1024, 2)) as &#39;索引容量(MB)&#39;</span><br><span class="line">from information_schema.tables</span><br><span class="line">where table_schema&#x3D;&#39;mysql&#39;;</span><br><span class="line"></span><br><span class="line">4.查看指定数据库各表容量大小</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">table_schema as &#39;数据库&#39;,</span><br><span class="line">table_name as &#39;表名&#39;,</span><br><span class="line">table_rows as &#39;记录数&#39;,</span><br><span class="line">truncate(data_length&#x2F;1024&#x2F;1024, 2) as &#39;数据容量(MB)&#39;,</span><br><span class="line">truncate(index_length&#x2F;1024&#x2F;1024, 2) as &#39;索引容量(MB)&#39;</span><br><span class="line">from information_schema.tables</span><br><span class="line">where table_schema&#x3D;&#39;mysql&#39;</span><br><span class="line">order by data_length desc, index_length desc;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="查询表大小"><a href="#查询表大小" class="headerlink" title="查询表大小"></a>查询表大小</h2><h3 id="1、首先，切换到-information-schema数据库"><a href="#1、首先，切换到-information-schema数据库" class="headerlink" title="1、首先，切换到 information_schema数据库"></a>1、首先，切换到 information_schema数据库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use information_schema;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2、查询mysql数据最大的10张表"><a href="#2、查询mysql数据最大的10张表" class="headerlink" title="2、查询mysql数据最大的10张表"></a>2、查询mysql数据最大的10张表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select TABLE_SCHEMA,table_name,table_rows,ENGINE,DATA_LENGTH,MAX_DATA_LENGTH,DATA_FREE from  tables order by table_rows desc limit 10;</span><br></pre></td></tr></table></figure>

<p><strong>这是查询mysql数据最大的10张表，不区分数据库的</strong></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql 批量删除表</title>
    <url>/sugw.github.io/2020/10/27/Mysql%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E8%A1%A8/</url>
    <content><![CDATA[<h2 id="生成删除表语句"><a href="#生成删除表语句" class="headerlink" title="生成删除表语句"></a>生成删除表语句</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -h主机 -D库 -u用户 -p密码 -e &quot;Select CONCAT( &#x27;drop tables &#x27;, table_name, &#x27;;&#x27; ) FROM information_schema.tables Where table_name LIKE &#x27;sample_%&#x27;;&quot; &gt;delete_tables.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="批量删除表"><a href="#批量删除表" class="headerlink" title="批量删除表"></a>批量删除表</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -h主机 -D库 -u用户 -p密码 -e &quot;source /opt/delete_tables.sql&quot;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqldump备份数据库时排除某些库</title>
    <url>/sugw.github.io/2020/11/17/Mysqldump%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%8E%92%E9%99%A4%E6%9F%90%E4%BA%9B%E5%BA%93/</url>
    <content><![CDATA[<p><strong>说明：</strong><br>使用mysqldump –all-databases会导出所有库。但如果做主从，从主库dump出数据时，我们是不需要也不想要information_schema 和 mysql 库的。数据库少的情况下还可以通过<code>/usr/local/mysql/bin/mysqldump -uroot -p --databases db1 db2 &gt; db1db2.sql</code> 这样再导出，但如果数据多，这样指定就很麻烦了。<br>mysql是支持 ignore-table 的，但是没有ignore-database，所以要导出除 information_schema和mysql库的其它所有库，难道就只能一个个指定database吗？</p>
<p><strong>解决：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql -e &quot;show databases;&quot; -uroot -p| grep -Ev &quot;Database|information_schema|mysql|test&quot; | xargs mysqldump -uroot -p --databases &gt; mysql_dump.sql</span></span><br></pre></td></tr></table></figure>


<p><strong>附录：</strong><br>附录1：mysqldump: Got error: 1142: SELECT,LOCK TABL command denied to user ‘root’@’localhost’ for table ‘cond_instances’ when using LOCK TABLES<br>在mysql5.5中增加了performance_schema，当我们进行mysqldump的时候，会报如下错误信息：<br>mysqldump: Got error: 1142: SELECT,LOCK TABL command denied to user ‘root’@’localhost’ for table ‘cond_instances’ when using LOCK TABLES</p>
<p>我们可以在mysqldump中加上参数 –skip-lock-tables，如</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysqldump  -uroot  -p   --skip-lock-tables  performance_schema &gt; performance_schema.sql </span></span><br></pre></td></tr></table></figure>

<p>或者过滤掉performance_schema这个库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql -e &quot;show databases;&quot; -uroot -p| grep -Ev &quot;Database|information_schema|mysql|test|performance_schema&quot; | xargs mysqldump -uroot -p --databases &gt; mysql_dump.sql</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx优化详解</title>
    <url>/sugw.github.io/2020/11/19/Nginx%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="一、一般来说nginx-配置文件中对优化比较有作用的为以下几项："><a href="#一、一般来说nginx-配置文件中对优化比较有作用的为以下几项：" class="headerlink" title="一、一般来说nginx 配置文件中对优化比较有作用的为以下几项："></a><strong>一、一般来说nginx 配置文件中对优化比较有作用的为以下几项：</strong></h2><h3 id="1-worker-processes-8"><a href="#1-worker-processes-8" class="headerlink" title="1. worker_processes 8;"></a><strong>1. worker_processes 8;</strong></h3><p>​     nginx 进程数，建议按照cpu 数目来指定，一般为它的倍数 (如,2个四核的cpu计为8)。</p>
<p>   <strong>2. worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</strong></p>
<p>​     为每个进程分配cpu，上例中将8 个进程分配到8 个cpu，当然可以写多个，或者将一个进程分配到多个cpu。</p>
<p>   <strong>3.</strong> <strong>worker_rlimit_nofile 65535;</strong></p>
<p>​     这个指令是指当一个nginx 进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx 进程数相除，但是nginx 分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致。</p>
<p>​     现在在linux 2.6内核下开启文件打开数为65535，worker_rlimit_nofile就相应应该填写65535。</p>
<p>​     这是因为nginx调度时分配请求到进程并不是那么的均衡，所以假如填写10240，总并发量达到3-4万时就有进程可能超过10240了，这时会返回502错误。</p>
<p>​     查看linux系统文件描述符的方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@web001 ~]# sysctl -a | grep fs.file</span><br><span class="line"></span><br><span class="line">                 fs.file-max &#x3D; 789972</span><br><span class="line"></span><br><span class="line">                 fs.file-nr &#x3D; 510 0 789972</span><br></pre></td></tr></table></figure>

<p>   <strong>4.</strong> <strong>use epoll;</strong></p>
<p>​     使用epoll 的I/O 模型</p>
<p>​     (</p>
<p>​     补充说明:</p>
<p>​       与apache相类，nginx针对不同的操作系统，有不同的事件模型</p>
<p>​       A）标准事件模型<br>​         Select、poll属于标准事件模型，如果当前系统不存在更有效的方法，nginx会选择select或poll<br>​       B）高效事件模型<br>​         <strong>Kqueue：</strong>使用于 FreeBSD 4.1+, OpenBSD 2.9+, NetBSD 2.0 和 MacOS X. 使用双处理器的MacOS X系统使用kqueue可能会造成内核崩溃。<br>​         <strong>Epoll:</strong> 使用于Linux内核2.6版本及以后的系统。</p>
<p>​         /dev/poll：使用于 Solaris 7 11/99+, HP/UX 11.22+ (eventport), IRIX 6.5.15+ 和 Tru64 UNIX 5.1A+。</p>
<p>​         Eventport：使用于 Solaris 10. 为了防止出现内核崩溃的问题， 有必要安装安全补丁。</p>
<p>​     )</p>
<p>​    <strong>5.</strong> <strong>worker_connections 65535;</strong></p>
<p>​      每个进程允许的最多连接数， 理论上每台nginx 服务器的最大连接数为worker_processes*worker_connections。</p>
<p>​    <strong>6.</strong> <strong>keepalive_timeout 60;</strong></p>
<p>​      keepalive 超时时间。</p>
<p>​    <strong>7**</strong>.** <strong>client_header_buffer_size 4k;</strong></p>
<p>​      客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</p>
<p>​      分页大小可以用命令<strong>getconf PAGESIZE</strong> 取得。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@web001 ~]# getconf PAGESIZE</span><br><span class="line">                 4096</span><br></pre></td></tr></table></figure>

<p>​     但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为<strong>“系统分页大小”的整倍数。</strong></p>
<p>​    <strong>8**</strong>.** <strong>open_file_cache max=65535 inactive=60s;</strong></p>
<p>​      这个将为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件数一致，inactive 是指经过多长时间文件没被请求后删除缓存。</p>
<p>​    <strong>9**</strong>.** <strong>open_file_cache_valid 80s;</strong></p>
<p>​     这个是指多长时间检查一次缓存的有效信息。</p>
<p>   <strong>10**</strong>.** <strong>open_file_cache_min_uses 1;</strong></p>
<p>​     open_file_cache 指令中的inactive 参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive 时间内一次没被使用，它将被移除。</p>
<h1 id="二、关于内核参数的优化："><a href="#二、关于内核参数的优化：" class="headerlink" title="二、关于内核参数的优化："></a><strong>二、关于内核参数的优化：</strong></h1><p>​      <strong>net.ipv4.tcp_max_tw_buckets = 6000</strong></p>
<p>​        timewait 的数量，默认是180000。</p>
<p>​      <strong>net.ipv4.ip_local_port_range = 1024 65000</strong></p>
<p>​        允许系统打开的端口范围。</p>
<p>​      <strong>net.ipv4.tcp_tw_recycle = 1</strong></p>
<p>​        启用timewait 快速回收。</p>
<p>​      <strong>net.ipv4.tcp_tw_reuse = 1</strong></p>
<p>​        开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接。</p>
<p>​      <strong>net.ipv4.tcp_syncookies = 1</strong></p>
<p>​        开启SYN Cookies，当出现SYN 等待队列溢出时，启用cookies 来处理。</p>
<p>​      <strong>net.core.somaxconn = 262144</strong></p>
<p>​        web 应用中listen 函数的backlog 默认会给我们内核参数的net.core.somaxconn 限制到128，而nginx 定义的NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。</p>
<p>​      <strong>net.core.netdev_max_backlog = 262144</strong></p>
<p>​        每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</p>
<p>​      <strong>net.ipv4.tcp_max_orphans = 262144</strong></p>
<p>​        系统中最多有多少个TCP 套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS 攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</p>
<p>​      <strong>net.ipv4.tcp_max_syn_backlog = 262144</strong></p>
<p>​        记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有128M 内存的系统而言，缺省值是1024，小内存的系统则是128。</p>
<p>​      <strong>net.ipv4.tcp_timestamps = 0</strong></p>
<p>​        时间戳可以避免序列号的卷绕。一个1Gbps 的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。这里需要将其关掉。</p>
<p>​      <strong>net.ipv4.tcp_synack_retries = 1</strong></p>
<p>​        为了打开对端的连接，内核需要发送一个SYN 并附带一个回应前面一个SYN 的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK 包的数量。</p>
<p>​      <strong>net.ipv4.tcp_syn_retries = 1</strong></p>
<p>​        在内核放弃建立连接之前发送SYN 包的数量。</p>
<p>​      <strong>net.ipv4.tcp_fin_timeout = 1</strong></p>
<p>​        如 果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2 状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是60 秒。2.2 内核的通常值是180 秒，3你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB 服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2 的危险性比FIN-WAIT-1 要小，因为它最多只能吃掉1.5K 内存，但是它们的生存期长些。</p>
<p>​      <strong>net.ipv4.tcp_keepalive_time = 30</strong></p>
<p>​        当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时。</p>
<h1 id="三、下面贴一个完整的内核优化设置"><a href="#三、下面贴一个完整的内核优化设置" class="headerlink" title="三、下面贴一个完整的内核优化设置:"></a><strong>三、下面贴一个完整的内核优化设置:</strong></h1><p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#CentOS5.5中可以将所有内容清空直接替换为如下内容:</span><br><span class="line">vi &#x2F;etc&#x2F;sysctl.conf </span><br><span class="line"></span><br><span class="line">   net.ipv4.ip_forward &#x3D; 0</span><br><span class="line">   net.ipv4.conf.default.rp_filter &#x3D; 1</span><br><span class="line">   net.ipv4.conf.default.accept_source_route &#x3D; 0</span><br><span class="line">   kernel.sysrq &#x3D; 0</span><br><span class="line">   kernel.core_uses_pid &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_syncookies &#x3D; 1</span><br><span class="line">   kernel.msgmnb &#x3D; 65536</span><br><span class="line">   kernel.msgmax &#x3D; 65536</span><br><span class="line">   kernel.shmmax &#x3D; 68719476736</span><br><span class="line">   kernel.shmall &#x3D; 4294967296</span><br><span class="line">   net.ipv4.tcp_max_tw_buckets &#x3D; 6000</span><br><span class="line">   net.ipv4.tcp_sack &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_window_scaling &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_rmem &#x3D; 4096 87380 4194304</span><br><span class="line">   net.ipv4.tcp_wmem &#x3D; 4096 16384 4194304</span><br><span class="line">   net.core.wmem_default &#x3D; 8388608</span><br><span class="line">   net.core.rmem_default &#x3D; 8388608</span><br><span class="line">   net.core.rmem_max &#x3D; 16777216</span><br><span class="line">   net.core.wmem_max &#x3D; 16777216</span><br><span class="line">   net.core.netdev_max_backlog &#x3D; 262144</span><br><span class="line">   net.core.somaxconn &#x3D; 262144</span><br><span class="line">   net.ipv4.tcp_max_orphans &#x3D; 3276800</span><br><span class="line">   net.ipv4.tcp_max_syn_backlog &#x3D; 262144</span><br><span class="line">   net.ipv4.tcp_timestamps &#x3D; 0</span><br><span class="line">   net.ipv4.tcp_synack_retries &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_syn_retries &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_tw_recycle &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_tw_reuse &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_mem &#x3D; 94500000 915000000 927000000</span><br><span class="line">   net.ipv4.tcp_fin_timeout &#x3D; 1</span><br><span class="line">   net.ipv4.tcp_keepalive_time &#x3D; 30</span><br><span class="line">   net.ipv4.ip_local_port_range &#x3D; 1024 65000</span><br><span class="line"></span><br><span class="line">#使配置立即生效可使用如下命令：</span><br><span class="line"> &#x2F;sbin&#x2F;sysctl -p</span><br></pre></td></tr></table></figure>

<p>[</p>
<h1 id="四、下面是关于系统连接数的优化"><a href="#四、下面是关于系统连接数的优化" class="headerlink" title="四、下面是关于系统连接数的优化"></a><strong>四、下面是关于系统连接数的优化</strong></h1><p>​    <strong>linux 默认值 open files 和 max user processes 为 1024</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ulimit -n</span><br><span class="line"> 1024</span><br><span class="line"></span><br><span class="line">#ulimit Cu</span><br><span class="line"> 1024</span><br></pre></td></tr></table></figure>

<p>   <strong>问题描述：</strong> </p>
<p>​      说明 server 只允许同时打开 1024 个文件，处理 1024 个用户进程</p>
<p>​      使用ulimit -a 可以查看当前系统的所有限制值，使用ulimit -n 可以查看当前的最大打开文件数。</p>
<p>​      新装的linux 默认只有1024 ，当作负载较大的服务器时，很容易遇到error: too many open files 。因此，需要将其改大。</p>
<p>   <strong>解决方法：</strong></p>
<p>​      使用 ulimit Cn 65535 可即时修改，但重启后就无效了。（注ulimit -SHn 65535 等效 ulimit -n 65535 ，-S 指soft ，-H 指hard)</p>
<p>​      有如下三种修改方式：</p>
<p>​         \1. 在/etc/rc.local 中增加一行 ulimit -SHn 65535<br>​         \2. 在/etc/profile 中增加一行 ulimit -SHn 65535<br>​         \3. 在**/etc/security/limits.conf** 最后增加：</p>
<p>​          <strong>* soft nofile 65535<br>​          * hard nofile 65535<br>​          * soft nproc 65535<br>​          * hard nproc 65535</strong></p>
<p>​       具体使用哪种，<strong>在 CentOS 中使用第1 种方式无效果，使用第3 种方式有效果</strong>，而在Debian 中使用第2 种有效果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ulimit -n</span><br><span class="line">  65535</span><br><span class="line"></span><br><span class="line"># ulimit -u</span><br><span class="line">  65535</span><br></pre></td></tr></table></figure>

<p>​      备注：ulimit 命令本身就有分软硬设置，加-H 就是硬，加-S 就是软，默认显示的是软限制</p>
<p>​      soft 限制指的是当前系统生效的设置值。 hard 限制值可以被普通用户降低。但是不能增加。 soft 限制不能设置的比 hard 限制更高。 只有 root 用户才能够增加 hard 限制值。</p>
<h1 id="五、下面是一个简单的nginx-配置文件："><a href="#五、下面是一个简单的nginx-配置文件：" class="headerlink" title="五、下面是一个简单的nginx 配置文件："></a><strong>五、下面是一个简单的nginx 配置文件：</strong></h1><p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user www www;</span><br><span class="line"></span><br><span class="line">worker_processes 8;</span><br><span class="line"></span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000;</span><br><span class="line"></span><br><span class="line">error_log &#x2F;www&#x2F;log&#x2F;nginx_error.log crit;</span><br><span class="line"></span><br><span class="line">pid &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 204800;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">  use epoll;</span><br><span class="line">  worker_connections 204800;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">  include mime.types;</span><br><span class="line">  default_type application&#x2F;octet-stream;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_names_hash_bucket_size 128;</span><br><span class="line">  client_header_buffer_size 2k;</span><br><span class="line">  large_client_header_buffers 4 4k;</span><br><span class="line">  client_max_body_size 8m;</span><br><span class="line">  sendfile on;</span><br><span class="line">  tcp_nopush on;</span><br><span class="line">  keepalive_timeout 60;</span><br><span class="line">  fastcgi_cache_path &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;fastcgi_cache levels&#x3D;1:2</span><br><span class="line">  keys_zone&#x3D;TEST:10m</span><br><span class="line">  inactive&#x3D;5m;</span><br><span class="line">  fastcgi_connect_timeout 300;</span><br><span class="line">  fastcgi_send_timeout 300;</span><br><span class="line">  fastcgi_read_timeout 300;</span><br><span class="line">  fastcgi_buffer_size 4k;</span><br><span class="line">  fastcgi_buffers 8 4k;</span><br><span class="line">  fastcgi_busy_buffers_size 8k;</span><br><span class="line">  fastcgi_temp_file_write_size 8k;</span><br><span class="line">  fastcgi_cache TEST;</span><br><span class="line">  fastcgi_cache_valid 200 302 1h;</span><br><span class="line">  fastcgi_cache_valid 301 1d;</span><br><span class="line">  fastcgi_cache_valid any 1m;</span><br><span class="line">  fastcgi_cache_min_uses 1;</span><br><span class="line">  fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class="line">  open_file_cache max&#x3D;204800 inactive&#x3D;20s;</span><br><span class="line">  open_file_cache_min_uses 1;</span><br><span class="line">  open_file_cache_valid 30s;</span><br><span class="line">  tcp_nodelay on;</span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_min_length 1k;</span><br><span class="line">  gzip_buffers 4 16k;</span><br><span class="line">  gzip_http_version 1.0;</span><br><span class="line">  gzip_comp_level 2;</span><br><span class="line">  gzip_types text&#x2F;plain application&#x2F;x-javascript text&#x2F;css application&#x2F;xml;</span><br><span class="line">  gzip_vary on;</span><br><span class="line"></span><br><span class="line">  server</span><br><span class="line">  &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name backup.aiju.com;</span><br><span class="line">    index index.php index.htm;</span><br><span class="line">    root &#x2F;www&#x2F;html&#x2F;;</span><br><span class="line"></span><br><span class="line">    location &#x2F;status</span><br><span class="line">    &#123;</span><br><span class="line">      stub_status on;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ~ .*&#x2F;.(php|php5)?$</span><br><span class="line">    &#123;</span><br><span class="line">     fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">     fastcgi_index index.php;</span><br><span class="line">     include fcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    location ~ .*&#x2F;.(gif|jpg|jpeg|png|bmp|swf|js|css)$</span><br><span class="line">    &#123;</span><br><span class="line">     expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    log_format access &#39;$remote_addr — $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">    &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">    &#39;&quot;$http_user_agent&quot; $http_x_forwarded_for&#39;;</span><br><span class="line">    access_log &#x2F;www&#x2F;log&#x2F;access.log access;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[</p>
<h1 id="六、关于FastCGI-的几个指令："><a href="#六、关于FastCGI-的几个指令：" class="headerlink" title="六、关于FastCGI 的几个指令："></a><strong>六、关于FastCGI 的几个指令：</strong></h1><p>​    fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2 keys_zone=TEST:10minactive=5m;</p>
<p>​      这个指令为FastCGI 缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。</p>
<p>​    <strong>fastcgi_connect_timeout 300;</strong></p>
<p>​      指定连接到后端FastCGI 的超时时间。</p>
<p>​    <strong>fastcgi_send_timeout 300;</strong></p>
<p>​      向FastCGI 传送请求的超时时间，这个值是指已经完成两次握手后向FastCGI 传送请求的超时时间。</p>
<p>​    <strong>fastcgi_read_timeout 300;</strong></p>
<p>​      接收FastCGI 应答的超时时间，这个值是指已经完成两次握手后接收FastCGI 应答的超时时间。</p>
<p>​    <strong>fastcgi_buffer_size 4k;</strong></p>
<p>​      指定读取FastCGI 应答第一部分需要用多大的缓冲区，一般第一部分应答不会超过1k，由于页面大小为4k，所以这里设置为4k。</p>
<p>​    <strong>fastcgi_buffers 8 4k;</strong></p>
<p>​      指定本地需要用多少和多大的缓冲区来缓冲FastCGI 的应答。</p>
<p>​    <strong>fastcgi_busy_buffers_size 8k;</strong></p>
<p>​      这个指令我也不知道是做什么用，只知道默认值是fastcgi_buffers 的两倍。</p>
<p>​    <strong>fastcgi_temp_file_write_size 8k;</strong></p>
<p>​      在写入fastcgi_temp_path 时将用多大的数据块，默认值是fastcgi_buffers 的两倍。</p>
<p>​    <strong>fastcgi_cache TEST</strong></p>
<p>​       开启FastCGI 缓存并且为其制定一个名称。个人感觉开启缓存非常有用，可以有效降低CPU 负载，并且防止502 错误。</p>
<p>​    <strong>fastcgi_cache_valid 200 302 1h;<br>​    fastcgi_cache_valid 301 1d;<br>​    fastcgi_cache_valid any 1m;</strong></p>
<p>​       为指定的应答代码指定缓存时间，如上例中将200，302 应答缓存一小时，301 应答缓存1 天，其他为1 分钟。</p>
<p>​    <strong>fastcgi_cache_min_uses 1;</strong></p>
<p>​       缓存在fastcgi_cache_path 指令inactive 参数值时间内的最少使用次数，如上例，如果在5 分钟内某文件1 次也没有被使用，那么这个文件将被移除。</p>
<p>​    <strong>fastcgi_cache_use_stale error timeout invalid_header http_500;</strong></p>
<p>​       不知道这个参数的作用，猜想应该是让nginx 知道哪些类型的缓存是没用的。以上为nginx 中FastCGI 相关参数，另外，FastCGI 自身也有一些配置需要进行优化，如果你使用php-fpm 来管理FastCGI，可以修改配置文件中的以下值：</p>
<p>​       <strong><value name="”max_children”">60</value></strong></p>
<p>​         同时处理的并发请求数，即它将开启最多60 个子线程来处理并发连接。</p>
<p>​       <strong><value name="”rlimit_files”">102400</value></strong></p>
<p>​         最多打开文件数。</p>
<p>​       <strong><value name="”max_requests”">204800</value></strong></p>
<p>​         每个进程在重置之前能够执行的最多请求数。</p>
]]></content>
      <categories>
        <category>优化</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP-FPM 设置多pool、配置文件重写</title>
    <url>/sugw.github.io/2020/11/19/PHP-FPM%20%E8%AE%BE%E7%BD%AE%E5%A4%9Apool%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99/</url>
    <content><![CDATA[<p><strong>重写配置文件</strong></p>
<p><strong>1</strong>、清空php配置文件</p>
<p>命令：&gt; /usr/local/php/etc/php-fpm.conf</p>
<p><strong>2</strong>、重新写入php-fpm配置</p>
<p>命令：vim /usr/local/php/etc/php-fpm.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 全局配置</span><br><span class="line">[global]</span><br><span class="line"># PID、可以不填</span><br><span class="line">pid &#x3D; &#x2F;usr&#x2F;local&#x2F;php&#x2F;var&#x2F;run&#x2F;php-fpm.pid</span><br><span class="line"># 错误日志路径、可以不填</span><br><span class="line">error_log &#x3D; &#x2F;usr&#x2F;local&#x2F;php&#x2F;var&#x2F;log&#x2F;php-fpm.log</span><br><span class="line"># www虚拟主机配置、可写多个</span><br><span class="line"></span><br><span class="line"># pool命名：www</span><br><span class="line">[www]</span><br><span class="line"># 监听socket方式 </span><br><span class="line"># 可以写成listen &#x3D; 127.0.0.1:9000</span><br><span class="line">listen &#x3D; &#x2F;tmp&#x2F;php-fcgi.sock</span><br><span class="line"># 开启php-fpm的执行用户</span><br><span class="line">user &#x3D; php-fpm</span><br><span class="line"># 开启php-fpm的所属组</span><br><span class="line">group &#x3D; php-fpm</span><br><span class="line"># 监听listen的用户，和后面的nginx的一致</span><br><span class="line">listen.owner &#x3D; nobody</span><br><span class="line"># 监听listen的组，和后面的nginx的一致</span><br><span class="line">listen.group &#x3D; nobody</span><br><span class="line"># 怎样的形式启用进程</span><br><span class="line">pm &#x3D; dynamic</span><br><span class="line"># 最大开启子进程数</span><br><span class="line">pm.max_children &#x3D; 50</span><br><span class="line"># 一开始启动多少子进程</span><br><span class="line">pm.start_servers &#x3D; 20</span><br><span class="line"># 空闲时保留多少个子进程</span><br><span class="line">pm.min_spare_servers &#x3D; 5</span><br><span class="line"># 最多空闲子进程</span><br><span class="line">pm.max_spare_servers &#x3D; 35</span><br><span class="line"># 进程处理多少个请求之后销毁重建</span><br><span class="line">pm.max_requests &#x3D; 500</span><br><span class="line"># 限定打开最大的文件数</span><br><span class="line">rlimit_files &#x3D; 1024</span><br></pre></td></tr></table></figure>

<p><strong>3</strong>、测试配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 测试配置文件&#96;&#96;&#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;php-fpm -t&#96; &#96;测试成功：&#96;&#96;[30-Jan-2018 23:43:32] NOTICE: configuration file &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.conf test &#96;&#96;is&#96; &#96;successful</span><br></pre></td></tr></table></figure>

<p><strong>4</strong>、重启动php-fpm</p>
<p>命令：/etc/init.d/php-fpm start</p>
<p><strong>5</strong>、查看启动状况</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -aux | grep php-fpm</span><br><span class="line"></span><br><span class="line">root      1530  0.0  0.5  32036  2928 ?        Ss   23:45   0:00 php-fpm: master process (&#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.conf)                                                                    </span><br><span class="line">php-fpm   1531  0.0  0.4  32036  2512 ?        S    23:45   0:00 php-fpm: pool www                                                                                                            </span><br><span class="line">php-fpm   1532  0.0  0.4  32036  2512 ?        S    23:45   0:00 php-fpm: pool www                                                                                                            </span><br><span class="line">php-fpm   1533  0.0  0.4  32036  2512 ?        S    23:45   0:00 php-fpm: pool www                                                                                                            </span><br><span class="line">php-fpm   1534  0.0  0.4  32036  2512 ?        S    23:45   0:00 php-fpm: pool www          </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls -l &#x2F;tmp&#x2F;php-fcgi.sock </span><br><span class="line"></span><br><span class="line">srw-rw-rw-. 1 nobody nobody 0 1月  30 23:45 &#x2F;tmp&#x2F;php-fcgi.sock</span><br><span class="line"></span><br><span class="line">注：权限都需要有读写，nginx才可以访问到socket。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps aux | grep nginx</span><br><span class="line">root      1606  0.0  0.1   5352   640 ?        Ss   02:46   0:00 nginx: master process &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br><span class="line">nobody    1607  0.0  0.3   6164  1568 ?        S    02:46   0:00 nginx: worker process      </span><br><span class="line">root      1609  0.0  0.1   5980   744 pts&#x2F;0    S+   02:46   0:00 grep nginx</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>设置多个pool</strong></p>
<p>需求：置两个pool，www1，www2</p>
<p>注：pool对应一个nginx的站点，这样可以提高安全，如同站点切割。</p>
<p><strong>1</strong>、主配置文件下配置两个pool。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 全局配置</span><br><span class="line">[global]</span><br><span class="line"># PID、可以不填</span><br><span class="line">pid &#x3D; &#x2F;usr&#x2F;local&#x2F;php&#x2F;var&#x2F;run&#x2F;php-fpm.pid</span><br><span class="line"># 错误日志路径、可以不填</span><br><span class="line">error_log &#x3D; &#x2F;usr&#x2F;local&#x2F;php&#x2F;var&#x2F;log&#x2F;php-fpm.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># www虚拟主机配置、可写多个</span><br><span class="line">[www1]</span><br><span class="line"># 监听socket方式 可以写成127.0.0.1:9000 TCP的。</span><br><span class="line">listen &#x3D; &#x2F;tmp&#x2F;php-fcgi1.sock</span><br><span class="line"># 开启php-fpm的执行用户</span><br><span class="line">user &#x3D; php-fpm</span><br><span class="line"># 开启php-fpm的所属组</span><br><span class="line">group &#x3D; php-fpm</span><br><span class="line"># 监听listen的用户，和后面的nginx的一致</span><br><span class="line">listen.owner &#x3D; nobody</span><br><span class="line"># 监听listen的组，和后面的nginx的一致</span><br><span class="line">listen.group &#x3D; nobody</span><br><span class="line"># 怎样的形式启用进程、static static静态、pm dynamic动态</span><br><span class="line">pm &#x3D; dynamic</span><br><span class="line"># 最大开启子进程数</span><br><span class="line">pm.max_children &#x3D; 50</span><br><span class="line"># 一开始启动多少子进程</span><br><span class="line">pm.start_servers &#x3D; 20</span><br><span class="line"># 空闲时保留多少个子进程</span><br><span class="line">pm.min_spare_servers &#x3D; 5</span><br><span class="line"># 最多空闲子进程</span><br><span class="line">pm.max_spare_servers &#x3D; 35</span><br><span class="line"># 进程处理多少个请求之后销毁重建</span><br><span class="line">pm.max_requests &#x3D; 500</span><br><span class="line"># 限定打开最大的文件数</span><br><span class="line">rlimit_files &#x3D; 1024</span><br><span class="line"># 定义慢日志</span><br><span class="line">slowlog &#x3D; &#x2F;tmp&#x2F;xxx_slow.log</span><br><span class="line"># 处理延迟多少秒记录一次慢日志</span><br><span class="line">request_slowlog_timeout &#x3D; 1</span><br><span class="line"># 配置隔离网站</span><br><span class="line">php_admin_value[open_basedir]&#x3D;&#x2F;usr&#x2F;local&#x2F;url1:&#x2F;usr&#x2F;local&#x2F;url2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># www虚拟主机配置、可写多个</span><br><span class="line">[www2]</span><br><span class="line"># 监听socket方式 可以写成127.0.0.1:9000 TCP的。</span><br><span class="line">listen &#x3D; &#x2F;tmp&#x2F;php-fcgi2.sock</span><br><span class="line"># 开启php-fpm的执行用户</span><br><span class="line">user &#x3D; test</span><br><span class="line"># 怎样的形式启用进程、static static静态、pm dynamic动态</span><br><span class="line">pm &#x3D; dynamic</span><br><span class="line"># 最大开启子进程数</span><br><span class="line">pm.max_children &#x3D; 50</span><br><span class="line"># 一开始启动多少子进程</span><br><span class="line">pm.start_servers &#x3D; 20</span><br><span class="line"># 空闲时保留多少个子进程</span><br><span class="line">pm.min_spare_servers &#x3D; 5</span><br><span class="line"># 最多空闲子进程</span><br><span class="line">pm.max_spare_servers &#x3D; 35</span><br><span class="line"># 进程处理多少个请求之后销毁重建</span><br><span class="line">pm.max_requests &#x3D; 500</span><br><span class="line"># 限定打开最大的文件数</span><br><span class="line">rlimit_files &#x3D; 1024</span><br><span class="line"># 定义慢日志</span><br><span class="line">slowlog &#x3D; &#x2F;tmp&#x2F;xxx2_slow.log</span><br><span class="line"># 处理延迟多少秒记录一次慢日志</span><br><span class="line">request_slowlog_timeout &#x3D; 1</span><br><span class="line"># 配置隔离网站</span><br><span class="line">php_admin_value[open_basedir]&#x3D;&#x2F;usr&#x2F;local&#x2F;url1:&#x2F;usr&#x2F;local&#x2F;url2</span><br></pre></td></tr></table></figure>

<p><strong>2</strong>、查看两个pool的启动进程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -aux | grep php-rpm</span><br><span class="line"></span><br><span class="line">root      2486  0.4  0.6  32240  3136 ?        Ss   09:31   0:00 php-fpm: master process (&#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.conf)                                                                    </span><br><span class="line">php-fpm   2487  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                                                                                                           </span><br><span class="line">php-fpm   2488  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                                                                                                           </span><br><span class="line">php-fpm   2489  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                                                                                                           </span><br><span class="line">php-fpm   2490  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                                                                                                           </span><br><span class="line">php-fpm   2491  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                                                                                                           </span><br><span class="line">php-fpm   2492  0.0  0.4  32036  2532 ?        S    09:31   0:00 php-fpm: pool www1                        </span><br><span class="line">test      2507  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                                                                           </span><br><span class="line">test      2508  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                                                                           </span><br><span class="line">test      2509  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                                                                           </span><br><span class="line">test      2510  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                                                                           </span><br><span class="line">test      2511  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                                                                           </span><br><span class="line">test      2512  0.0  0.4  32036  2536 ?        S    09:31   0:00 php-fpm: pool www2                                                 </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus监控node_exporter的告警规则</title>
    <url>/sugw.github.io/2020/10/26/Prometheus%E7%9B%91%E6%8E%A7node_exporter%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<h3 id="针对磁盘CPU-IO-磁盘使用、内存使用、TCP、网络流量配置监控告警"><a href="#针对磁盘CPU-IO-磁盘使用、内存使用、TCP、网络流量配置监控告警" class="headerlink" title="针对磁盘CPU,IO ,磁盘使用、内存使用、TCP、网络流量配置监控告警"></a>针对磁盘CPU,IO ,磁盘使用、内存使用、TCP、网络流量配置监控告警</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">主机状态-监控告警</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">主机状态</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">非常严重</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>:服务器宕机&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>:服务器延时超过5分钟&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">CPU使用情况</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">by(instance)*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">一般告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> CPU使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> CPU使用大于60%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line">  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">内存使用</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="string">-(node_memory_MemTotal_bytes</span> <span class="string">-node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes</span> <span class="string">)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes</span> <span class="string">*</span> <span class="number">100</span><span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 内存使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 内存使用大于80%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">IO性能</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(avg(irate(node_disk_io_time_seconds_total[1m]))</span> <span class="string">by(instance)*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入磁盘IO使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 流入磁盘IO大于60%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>)&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">网络</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">((sum(rate</span> <span class="string">(node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m]))</span> <span class="string">by</span> <span class="string">(instance))</span> <span class="string">/</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">102400</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入网络带宽过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span>流入网络带宽持续2分钟高于100M. RX带宽使用率<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">网络</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">((sum(rate</span> <span class="string">(node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m]))</span> <span class="string">by</span> <span class="string">(instance))</span> <span class="string">/</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">102400</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流出网络带宽过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span>流出网络带宽持续2分钟高于100M. RX带宽使用率<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">TCP会话</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">node_netstat_Tcp_CurrEstab</span> <span class="string">&gt;</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> TCP_ESTABLISHED过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> TCP_ESTABLISHED大于1000%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">磁盘容量</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes</span> &#123;<span class="string">fstype=~&quot;ext4|xfs&quot;</span>&#125;<span class="string">*100)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 磁盘分区使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 磁盘分区使用大于80%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Prometheus针对nodes告警规则配置"><a href="#Prometheus针对nodes告警规则配置" class="headerlink" title="Prometheus针对nodes告警规则配置"></a>Prometheus针对nodes告警规则配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">实例丢失</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;node-exporter&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 丢失&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 上的任务 <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> 已经停止了 1 分钟已上了&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">磁盘容量小于</span> <span class="number">5</span><span class="string">%</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">((node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,mountpoint=~&quot;.*&quot;,fstype=~&quot;ext4|xfs|ext2|ext3&quot;&#125;</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes</span> &#123;<span class="string">job=&quot;node-exporter&quot;</span>,<span class="string">mountpoint=~&quot;.*&quot;</span>,<span class="string">fstype=~&quot;ext4|xfs|ext2|ext3&quot;</span>&#125;<span class="string">)</span> <span class="string">&gt;</span> <span class="number">95</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘不足 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>磁盘 <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> 资源 已不足 5%, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;内存容量小于 20%&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">((node_memory_MemTotal_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_MemFree_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Buffers_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Cached_bytes)</span> <span class="string">/</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="string">))</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存不足 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>内存资源已不足 20%,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;CPU 平均负载大于 4 个&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">node_load5</span> <span class="string">&gt;</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>CPU 平均负载(5 分钟) 已超过 4 ,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;磁盘读 I/O 超过 30MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">irate(node_disk_read_bytes_total&#123;device=&quot;sda&quot;&#125;[1m])</span> <span class="string">&gt;</span> <span class="number">30000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> I/O 读负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>I/O 每分钟读已超过 30MB/s,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;磁盘写 I/O 超过 30MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">irate(node_disk_written_bytes_total&#123;device=&quot;sda&quot;&#125;[1m])</span> <span class="string">&gt;</span> <span class="number">30000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> I/O 写负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>I/O 每分钟写已超过 30MB/s,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;网卡流出速率大于 10MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">(irate(node_network_transmit_bytes_total&#123;device!~&quot;lo&quot;&#125;[1m])</span> <span class="string">/</span> <span class="number">1000</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">1000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 网卡流量负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>网卡 <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> 流量已经超过 10MB/s, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;CPU 使用率大于 90%&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">((avg</span> <span class="string">by</span> <span class="string">(instance,job,env)(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[30s])))</span> <span class="string">*100)</span> <span class="string">&gt;</span> <span class="number">90</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>CPU 使用率已超过 90%, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>ab压测工具</title>
    <url>/sugw.github.io/2020/11/19/ab%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>ab压测参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-n 测试会话中所执行的请求个数,默认仅执行一个请求 </span><br><span class="line">-c 一次产生的请求个数,即同一时间发出多少个请求,默认为一次一个 </span><br><span class="line">-t 测试所进行的最大秒数,默认为无时间限制....其内部隐含值是[-n 50000],它可以使对服务器的测试限制在一个固定的总时间以内 </span><br><span class="line">-p 包含了需要POST的数据的文件 </span><br><span class="line">-T POST数据所使用的Content-type头信息 </span><br><span class="line">-v 设置显示信息的详细程度 </span><br><span class="line">-w 以HTML表格的形式输出结果,默认是白色背景的两列宽度的一张表</span><br><span class="line">-i 以HTML表格的形式输出结果,默认是白色背景的两列宽度的一张表 </span><br><span class="line">-x 设置&lt;table&gt;属性的字符串,此属性被填入&lt;table 这里&gt; </span><br><span class="line">-y 设置&lt;tr&gt;属性的字符串 </span><br><span class="line">-z 设置&lt;td&gt;属性的字符串 </span><br><span class="line">-C 对请求附加一个Cookie行，其典型形式是name&#x3D;value的参数对,此参数可以重复 </span><br><span class="line">-H 对请求附加额外的头信息,此参数的典型形式是一个有效的头信息行,其中包含了以冒号分隔的字段和值的对(如&quot;Accept-Encoding: zip&#x2F;zop;8bit&quot;) </span><br><span class="line">-A HTTP验证,用冒号:分隔传递用户名及密码 </span><br><span class="line">-P 无论服务器是否需要(即是否发送了401认证需求代码),此字符串都会被发送 </span><br><span class="line">-X 对请求使用代理服务器 </span><br><span class="line">-V 显示版本号并退出 </span><br><span class="line">-k 启用HTTP KeepAlive功能,即在一个HTTP会话中执行多个请求,默认为不启用KeepAlive功能 </span><br><span class="line">-d 不显示&quot;percentage served within XX [ms] table&quot;的消息(为以前的版本提供支持) </span><br><span class="line">-S 不显示中值和标准背离值,且均值和中值为标准背离值的1到2倍时,也不显示警告或出错信息,默认会显示最小值&#x2F;均值&#x2F;最大值等(为以前的版本提供支持) </span><br><span class="line">-g 把所有测试结果写入一个&#39;gnuplot&#39;或者TSV(以Tab分隔的)文件 </span><br><span class="line">-e 产生一个以逗号分隔的(CSV)文件,其中包含了处理每个相应百分比的请求所需要(从1%到100%)的相应百分比的(以微妙为单位)时间 </span><br><span class="line">-h 显示使用方法 </span><br><span class="line">-k 发送keep-alive指令到服务器端</span><br></pre></td></tr></table></figure>

<p>ab压测命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ab -n 10 -s 50000 -k &quot;http:&#x2F;&#x2F;127.0.0.1:9501&#x2F;?uid&#x3D;123&quot;</span><br></pre></td></tr></table></figure>

<p>ab压测结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">This is apacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient).....done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        swoole-http-server#服务器软件</span><br><span class="line">Server Hostname:        127.0.0.1#域名</span><br><span class="line">Server Port:            9501#请求端口号</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;?uid&#x3D;123#文件路径</span><br><span class="line">Document Length:        818 bytes#页面字节数</span><br><span class="line"></span><br><span class="line">Concurrency Level:      1#请求的并发数</span><br><span class="line">Time taken for tests:   225.551 seconds#总访问时间</span><br><span class="line">Complete requests:      10#请求成功数量</span><br><span class="line">Failed requests:        1#请求失败数量</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 1, Exceptions: 0)</span><br><span class="line">Keep-Alive requests:    10</span><br><span class="line">Total transferred:      9791 bytes#请求总数据大小（包括header头信息）</span><br><span class="line">HTML transferred:       8181 bytes#html页面实际总字节数</span><br><span class="line">Requests per second:    0.04 [#&#x2F;sec] (mean)#每秒多少请求，服务器的吞吐量</span><br><span class="line">Time per request:       22555.056 [ms] (mean)#用户平均请求等待时间 </span><br><span class="line">Time per request:       22555.056 [ms] (mean, across all concurrent requests)# 服务器平均处理时间，也就是服务器吞吐量的倒数</span><br><span class="line">Transfer rate:          0.04 [Kbytes&#x2F;sec] received#每秒获取的数据长度</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:        0    0   0.0      0       0</span><br><span class="line">Processing:  6434 22555 19246.5  21379   61285</span><br><span class="line">Waiting:     6434 22555 19246.4  21379   61285</span><br><span class="line">Total:       6434 22555 19246.5  21379   61285</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%  21379#50%用户请求在21379ms内返回</span><br><span class="line">  66%  30850#66%用户请求在30850ms内返回</span><br><span class="line">  75%  31684#75%用户请求在31684ms内返回</span><br><span class="line">  80%  44672#80%用户请求在44672ms内返回</span><br><span class="line">  90%  61285#90%用户请求在61285ms内返回</span><br><span class="line">  95%  61285#95%用户请求在61285ms内返回</span><br><span class="line">  98%  61285#98%用户请求在61285ms内返回</span><br><span class="line">  99%  61285#99%用户请求在61285ms内返回</span><br><span class="line"> 100%  61285 (longest request)</span><br></pre></td></tr></table></figure>



<p>以上就是ab压测参数详解的全部内容。</p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>测试</tag>
      </tags>
  </entry>
  <entry>
    <title>ansible定时任务和用户组模块使用</title>
    <url>/sugw.github.io/2020/11/20/ansible%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="用户模块的使用"><a href="#用户模块的使用" class="headerlink" title="用户模块的使用"></a>用户模块的使用</h2><p>用户模块主要用来管理用户账号和用户的属性（对远程主机用户进行批量管理）。</p>
<p>用户模块依赖的指令为useradd，userdel，usermod</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认值</th>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Append</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>如果没有指定group，append设定为yes，那么会添加到用户同名组；append设定为no，那么会添加到user组。如果指定了group，那么都会添加在指定的group组</td>
</tr>
<tr>
<td>Comment</td>
<td>否</td>
<td></td>
<td></td>
<td>用户的备注信息</td>
</tr>
<tr>
<td>Force</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>当状态为absent的时候，相当于userdel -force</td>
</tr>
<tr>
<td>generate_ssh_key</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>是否生成秘钥</td>
</tr>
<tr>
<td>Group</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定用户的主组</td>
</tr>
<tr>
<td>Groups</td>
<td>否</td>
<td></td>
<td></td>
<td>用逗号分隔的组，当groups设定为空的时候，那么会移除除了主组的其他所有组</td>
</tr>
<tr>
<td>Home</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定为用户的home目录</td>
</tr>
<tr>
<td>Login_class</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定用户的登录类 FreeBSD, OpenBSD and NetBSD systems.</td>
</tr>
<tr>
<td>Name</td>
<td>是</td>
<td></td>
<td></td>
<td>用户创建，移除，修改</td>
</tr>
<tr>
<td>Move_home</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>如果使用了选项home=设置为yes，那么会将用户家目录移到不存在的home目录中</td>
</tr>
<tr>
<td>Non_unique</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>可选的，当使用-u选项的时候，将用户的uid设置为non_unique</td>
</tr>
<tr>
<td>Password</td>
<td>否</td>
<td></td>
<td></td>
<td>设定用户的密码</td>
</tr>
<tr>
<td>Remove</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>当使用状态为state=absent的时候，差不多和userdel –remove（删除所有信息）</td>
</tr>
<tr>
<td>Shell</td>
<td>否</td>
<td></td>
<td></td>
<td>设定用户的shell</td>
</tr>
<tr>
<td>Ssh_key_bits</td>
<td>否</td>
<td>2048</td>
<td></td>
<td>设定秘钥的位数</td>
</tr>
<tr>
<td>Ssh_key_comments</td>
<td>否</td>
<td>￥HOSTHOME</td>
<td></td>
<td>Ssh key备注信息</td>
</tr>
<tr>
<td>Ssh_key_file</td>
<td>否</td>
<td>.sha/id_rsa</td>
<td></td>
<td>秘钥的文件名</td>
</tr>
<tr>
<td>ssh_key_passphrase</td>
<td>否</td>
<td></td>
<td></td>
<td>Ssh秘钥的密码</td>
</tr>
<tr>
<td>Ssh_key_type</td>
<td>否</td>
<td>Rsa</td>
<td></td>
<td>Ssh秘钥的类型</td>
</tr>
<tr>
<td>State</td>
<td>否</td>
<td>Present</td>
<td>PresentAbsent</td>
<td>新增删除</td>
</tr>
<tr>
<td>System</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>创建为系统账号，不会改变已经存在的用户</td>
</tr>
<tr>
<td>Uid</td>
<td>否</td>
<td></td>
<td></td>
<td>设定为用户的uid</td>
</tr>
<tr>
<td>Update_password</td>
<td>否</td>
<td>Always</td>
<td>AlwaysOn_create</td>
<td>Always当用户密码不同，会修改，是否需要修改密码</td>
</tr>
</tbody></table>
<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly group=kelly uid=555 comment=’kelly’ state=present”</p>
<p>添加用户，指定用户名name，指定用户主组kelly，设定用户uid为555 ，设定备注信息</p>
<h3 id="添加用户使用append"><a href="#添加用户使用append" class="headerlink" title="添加用户使用append"></a>添加用户使用append</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly shell=/bin/bash groups=kelly,kel append=yes</p>
<p>添加用户，将用户添加在组kelly和kel中，指定shell为/bin/bash，然后将用户添加组user中</p>
<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly state=absent remove=yes</p>
<p>将用户强制删除</p>
<h3 id="新建用户创建sshkey"><a href="#新建用户创建sshkey" class="headerlink" title="新建用户创建sshkey"></a>新建用户创建sshkey</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa”</p>
<p>创建用户，设定sshkey等属性</p>
<h3 id="hostname模块使用"><a href="#hostname模块使用" class="headerlink" title="hostname模块使用"></a>hostname模块使用</h3><p>hostname模块主要用来修改主机的名称。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>否</td>
<td></td>
<td></td>
<td>主机名称</td>
</tr>
</tbody></table>
<h3 id="修改主机名称"><a href="#修改主机名称" class="headerlink" title="修改主机名称"></a>修改主机名称</h3><p>[root@ansibleserver ~]# ansible pythonserver -m hostname -a “name=python”</p>
<p>在查看的时候，主要查看文件/etc/sysconfig/network，重启之后才能生效</p>
<h3 id="ping模块的使用"><a href="#ping模块的使用" class="headerlink" title="ping模块的使用"></a>ping模块的使用</h3><p>ping模块主要是无意义的测试模块，主要用来检查ansible是否可以用的模块以及python是否配置好的，在playbook中基本不会使用，在能成功连接之后，总是返回结果pong</p>
<p>[root@ansibleserver ~]# ansible all -m ping</p>
<h3 id="定时任务管理模块使用"><a href="#定时任务管理模块使用" class="headerlink" title="定时任务管理模块使用"></a>定时任务管理模块使用</h3><p>主要是用来对定时任务进行调度，定时任务模块会包含一句描述信息，格式如下：</p>
<p>“#Ansible: <name>“</name></p>
<p>name对应的为模块传递过去的参数，主要用来给以后ansible进行操作的时候，查看相关的状态或者检查相关状态</p>
<p>依赖的模块为cron</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Backup</td>
<td>非</td>
<td></td>
<td>Yes/no</td>
<td>如果yes，那么在修改之后会进行备份，备份的路径在backup_file</td>
</tr>
<tr>
<td>Cron_file</td>
<td>非</td>
<td></td>
<td></td>
<td>如果设置了，那么在cron.d中使用此文件替代单独用户的crontab，在使用此选项的时候，必须使用user选项</td>
</tr>
<tr>
<td>Day</td>
<td>非</td>
<td></td>
<td></td>
<td>天</td>
</tr>
<tr>
<td>Hour</td>
<td>非</td>
<td></td>
<td></td>
<td>小时 ( 0-23, *, */2, etc )</td>
</tr>
<tr>
<td>Job</td>
<td>非</td>
<td></td>
<td></td>
<td>需要执行的命令，必须状态为present</td>
</tr>
<tr>
<td>Minute</td>
<td>非</td>
<td></td>
<td></td>
<td>分 ( 0-59, *, */2, etc )</td>
</tr>
<tr>
<td>Month</td>
<td>非</td>
<td></td>
<td></td>
<td>月( 1-12, *, */2, etc )</td>
</tr>
<tr>
<td>Name</td>
<td>非</td>
<td></td>
<td></td>
<td>任务的描述</td>
</tr>
<tr>
<td>Reboot</td>
<td>非</td>
<td>No</td>
<td>Yes/no</td>
<td>重启后是否需要执行</td>
</tr>
<tr>
<td>Special_time</td>
<td>非</td>
<td></td>
<td>rebootyearlyannuallymonthlyweeklydailyhourly</td>
<td>特定的执行时间</td>
</tr>
<tr>
<td>State</td>
<td>非</td>
<td>Present</td>
<td>PresentAbsent</td>
<td>启用或停用任务</td>
</tr>
<tr>
<td>User</td>
<td>非</td>
<td>Root</td>
<td></td>
<td>执行任务的用户</td>
</tr>
<tr>
<td>Weekday</td>
<td>非</td>
<td></td>
<td></td>
<td>每一周的哪天进行运行（0-6 for Sunday-Saturday, *, etc）</td>
</tr>
</tbody></table>
<h3 id="新增一个定时任务"><a href="#新增一个定时任务" class="headerlink" title="新增一个定时任务"></a>新增一个定时任务</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=check minute=5 job=’crontab -l &gt;&gt;/root/123’”</p>
<p>新增一个任务，每五分钟执行一次，任务名称为check</p>
<h3 id="删除定时任务"><a href="#删除定时任务" class="headerlink" title="删除定时任务"></a>删除定时任务</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=check state=absent”</p>
<p>删除刚刚新建的定时任务</p>
<h3 id="新建一个cron文件"><a href="#新建一个cron文件" class="headerlink" title="新建一个cron文件"></a>新建一个cron文件</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=’for test’ weekday=’2’ minute=’0’ hour=12 user=’root’ job=’cat /etc/passwd &gt;/root/111’ cron_file=’test ansible’”</p>
<p>新增一个任务，在目录/etc/cron.d/目录中，文件名称为test ansible，用户为root</p>
<h3 id="删除一个cron文件"><a href="#删除一个cron文件" class="headerlink" title="删除一个cron文件"></a>删除一个cron文件</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=’for test’ cron_file=’test ansible’ state=absent”</p>
<p>删除上面新建的cron文件。</p>
<h2 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h2><p>这个模块在playbook中自动被查找的，从而得到远程主机的相关信息，可以作为变量使用。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Fact_path</td>
<td>否</td>
<td>/etc/ansible/facts.d</td>
<td></td>
<td>Fact的路径</td>
</tr>
<tr>
<td>Filter</td>
<td>否</td>
<td>*</td>
<td></td>
<td>过滤串</td>
</tr>
</tbody></table>
<h2 id="收集fact并且进行保存"><a href="#收集fact并且进行保存" class="headerlink" title="收集fact并且进行保存"></a>收集fact并且进行保存</h2><p>ansible pythonserver -m setup –tree /tmp/facts</p>
<p>执行之后，会显示相关的fact，并且在/tmp/facts中会保存fact信息，如下：</p>
<p>[root@ansibleserver tmp]# ls -l /tmp/facts/total 12-rw-r–r– 1 root root 8990 Jan 18 13:16 192.168.1.60</p>
<p>使用–tree选项，在分类的时候，会根据主机的名称进行分类</p>
<h3 id="收集内存信息并输出"><a href="#收集内存信息并输出" class="headerlink" title="收集内存信息并输出"></a>收集内存信息并输出</h3><p>[root@ansibleserver tmp]# ansible pythonserver -m setup -a “filter=ansible_*_mb”</p>
<p>使用过滤字符串，从而进行了相关的匹配，得到相关的内存信息</p>
<h3 id="收集主机网卡信息"><a href="#收集主机网卡信息" class="headerlink" title="收集主机网卡信息"></a>收集主机网卡信息</h3><p>[root@ansibleserver tmp]# ansible pythonserver -m setup -a “filter=ansible_eth[02]”</p>
<p>收集特定的网卡信息</p>
]]></content>
      <categories>
        <category>ansible</category>
      </categories>
      <tags>
        <tag>ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>centos6.8 安装supervisor</title>
    <url>/sugw.github.io/2020/10/28/centos6.8%20%E5%AE%89%E8%A3%85supervisor/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> centos6.8安装supervisor，有很多种方法，但是有很多坑，为了以后不重复踩坑，这里记录一下。</p>
<p>如果用yum install supervisor, 默认安装的是2.1.9版本，2.x版本的问题很多，可以启动supervisord进程，但是启动的进程不输出日志</p>
<p>用pip install supervisor，默认装的是最新的4.0.3版本，但是centos6.8默认的只有python2.6，4.0.3的supervisor跑不起来，具体错误没有记录了</p>
<h2 id="升级到python2-7"><a href="#升级到python2-7" class="headerlink" title="升级到python2.7"></a>升级到python2.7</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://prdownloads.sourceforge.net/libpng/zlib-1.2.8.tar.gz</span><br><span class="line">tar zxf zlib-1.2.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> zlib-1.2.8</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"> </span><br><span class="line">yum install openssl openssl-devel -y</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">wget http://www.python.org/ftp/python/2.7.10/Python-2.7.10.tar.xz</span><br><span class="line">tar xf Python-2.7.10.tar.xz</span><br><span class="line"><span class="built_in">cd</span> Python-2.7.10</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python2.7</span><br><span class="line"><span class="comment"># 找到下面这句，去掉注释 </span></span><br><span class="line"><span class="comment"># zlib zlibmodule.c -I$(prefix)/include -L$(exec_prefix)/lib -lz </span></span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接下来需要创建一个链接来使系统默认python变为python2.7</span><br><span class="line">ln -fs /usr/<span class="built_in">local</span>/python2.7/bin/python2.7 /usr/bin/python</span><br><span class="line"></span><br><span class="line">更改后yum会无法运行,此时修改/usr/bin/yum 文件的第一行</span><br><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line">改为系统原有python版本</span><br><span class="line"><span class="meta">#!/usr/bin/python2.6</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-supervisor"><a href="#安装-supervisor" class="headerlink" title="安装 supervisor"></a>安装 supervisor</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip2.7 install supervisor</span><br></pre></td></tr></table></figure>

<h3 id="配置-supervisor"><a href="#配置-supervisor" class="headerlink" title="配置 supervisor"></a>配置 supervisor</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo_supervisord_conf &gt;&#x2F;etc&#x2F;supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;supervisord.conf</span><br><span class="line">[include]</span><br><span class="line">files &#x3D; &#x2F;etc&#x2F;supervisord.d&#x2F;*.ini</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;supervisord -c &#x2F;etc&#x2F;supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;supervisorctl -c &#x2F;etc&#x2F;supervisord.conf status</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="加入开机启动"><a href="#加入开机启动" class="headerlink" title="加入开机启动"></a>加入开机启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;supervisord.conf </span><br><span class="line"># 修改以下内容</span><br><span class="line"></span><br><span class="line">file&#x3D;&#x2F;var&#x2F;run&#x2F;supervisor.sock </span><br><span class="line"></span><br><span class="line">logfile&#x3D;&#x2F;var&#x2F;log&#x2F;supervisord.log pidfile&#x3D;&#x2F;var&#x2F;run&#x2F;supervisord.pid </span><br><span class="line"></span><br><span class="line">serverurl&#x3D;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;supervisor.sock</span><br><span class="line"></span><br><span class="line"> [include] </span><br><span class="line"></span><br><span class="line">files &#x3D; supervisord.d&#x2F;*.conf</span><br></pre></td></tr></table></figure>

<h4 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/init.d/supervisord</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># supervisord   This scripts turns supervisord on</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author:       Mike McGrath &lt;mmcgrath@redhat.com&gt; (based off yumupdatesd)</span></span><br><span class="line"><span class="comment">#               Jason Koppe &lt;jkoppe@indeed.com&gt; adjusted to read sysconfig,</span></span><br><span class="line"><span class="comment">#                   use supervisord tools to start/stop, conditionally wait</span></span><br><span class="line"><span class="comment">#                   for child processes to shutdown, and startup later</span></span><br><span class="line"><span class="comment">#               Mikhail Mingalev &lt;mingalevme@gmail.com&gt; Merged</span></span><br><span class="line"><span class="comment">#                   redhat-init-jkoppe and redhat-sysconfig-jkoppe, and</span></span><br><span class="line"><span class="comment">#                   made the script &quot;simple customizable&quot;.</span></span><br><span class="line"><span class="comment">#               Brendan Maguire &lt;maguire.brendan@gmail.com&gt; Added OPTIONS to</span></span><br><span class="line"><span class="comment">#                   SUPERVISORCTL status call</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:    345 83 04</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># description:  supervisor is a process control utility.  It has a web based</span></span><br><span class="line"><span class="comment">#               xmlrpc interface as well as a few other nifty features.</span></span><br><span class="line"><span class="comment">#               Script was originally written by Jason Koppe &lt;jkoppe@indeed.com&gt;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># source function library</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -a</span><br><span class="line"></span><br><span class="line">PREFIX=/usr</span><br><span class="line"></span><br><span class="line">SUPERVISORD=<span class="variable">$PREFIX</span>/bin/supervisord</span><br><span class="line">SUPERVISORCTL=<span class="variable">$PREFIX</span>/bin/supervisorctl</span><br><span class="line"></span><br><span class="line">PIDFILE=/var/run/supervisord.pid</span><br><span class="line">LOCKFILE=/var/lock/subsys/supervisord</span><br><span class="line"></span><br><span class="line">OPTIONS=<span class="string">&quot;-c /etc/supervisord.conf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unset this variable if you don&#x27;t care to wait for child processes to shutdown before removing the $LOCKFILE-lock</span></span><br><span class="line">WAIT_FOR_SUBPROCESSES=yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove this if you manage number of open files in some other fashion</span></span><br><span class="line"><span class="built_in">ulimit</span> -n 96000</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">running_pid()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Check if a given process pid&#x27;s cmdline matches a given name</span></span><br><span class="line">    pid=<span class="variable">$1</span></span><br><span class="line">    name=<span class="variable">$2</span></span><br><span class="line">    [ -z <span class="string">&quot;<span class="variable">$pid</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    [ ! -d /proc/<span class="variable">$pid</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    (cat /proc/<span class="variable">$pid</span>/cmdline | tr <span class="string">&quot;\000&quot;</span> <span class="string">&quot;\n&quot;</span>|grep -q <span class="variable">$name</span>) || <span class="built_in">return</span> 1</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">running()</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment"># Check if the process is running looking at /proc</span></span><br><span class="line"><span class="comment"># (works for all users)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># No pidfile, probably no daemon present</span></span><br><span class="line">    [ ! -f <span class="string">&quot;<span class="variable">$PIDFILE</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    <span class="comment"># Obtain the pid and check it against the binary name</span></span><br><span class="line">    pid=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line">    running_pid <span class="variable">$pid</span> <span class="variable">$SUPERVISORD</span> || <span class="built_in">return</span> 1</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting supervisord: &quot;</span></span><br><span class="line">	</span><br><span class="line">        <span class="keyword">if</span> [ -e <span class="variable">$PIDFILE</span> ]; <span class="keyword">then</span> </span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;ALREADY STARTED&quot;</span></span><br><span class="line">		<span class="built_in">return</span> 1</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># start supervisord with options from sysconfig (stuff like -c)</span></span><br><span class="line">        <span class="variable">$SUPERVISORD</span> <span class="variable">$OPTIONS</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># show initial startup status</span></span><br><span class="line">	<span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> status</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># only create the subsyslock if we created the PIDFILE</span></span><br><span class="line">        [ -e <span class="variable">$PIDFILE</span> ] &amp;&amp; touch <span class="variable">$LOCKFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Stopping supervisord: &quot;</span></span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> shutdown</span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$WAIT_FOR_SUBPROCESSES</span>&quot;</span> ]; <span class="keyword">then</span> </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Waiting roughly 60 seconds for <span class="variable">$PIDFILE</span> to be removed after child processes exit&quot;</span></span><br><span class="line">            <span class="keyword">for</span> sleep <span class="keyword">in</span>  2 2 2 2 4 4 4 4 8 8 8 8 last; <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> [ ! -e <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">&quot;Supervisord exited as expected in under <span class="variable">$total_sleep</span> seconds&quot;</span></span><br><span class="line">                    <span class="built_in">break</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">if</span> [[ <span class="variable">$sleep</span> -eq <span class="string">&quot;last&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;Supervisord still working on shutting down. We&#x27;ve waited roughly 60 seconds, we&#x27;ll let it do its thing from here&quot;</span></span><br><span class="line">                        <span class="built_in">return</span> 1</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        sleep <span class="variable">$sleep</span></span><br><span class="line">                        total_sleep=$(( <span class="variable">$total_sleep</span> + <span class="variable">$sleep</span> ))</span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># always remove the subsys. We might have waited a while, but just remove it at this point.</span></span><br><span class="line">        rm -f <span class="variable">$LOCKFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">        stop</span><br><span class="line">        start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        start</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        stop</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    restart|force-reload)</span><br><span class="line">        restart</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> reload</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    condrestart)</span><br><span class="line">        [ -f <span class="variable">$LOCKFILE</span> ] &amp;&amp; restart</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> status</span><br><span class="line">        <span class="keyword">if</span> running ; <span class="keyword">then</span></span><br><span class="line">            RETVAL=0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            RETVAL=1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|reload|force-reload|condrestart&#125;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$RETVAL</span></span><br></pre></td></tr></table></figure>

<h4 id="加入服务"><a href="#加入服务" class="headerlink" title="加入服务"></a>加入服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig --add supervisord</span><br></pre></td></tr></table></figure>

<h4 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod 755 /etc/init.d/supervisord</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h4 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig supervisord on</span><br></pre></td></tr></table></figure>

<p><strong>启动supervisor</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service supervisord start </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看supervisor运行状态</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service supervisord status</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>supervisors</tag>
      </tags>
  </entry>
  <entry>
    <title>linux 磁盘</title>
    <url>/sugw.github.io/2020/10/21/linux%20%E7%A3%81%E7%9B%98%E6%BB%A1/</url>
    <content><![CDATA[<h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><hr>
<p>​        磁盘显示已满，实际占用空间很小</p>
<h3 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h3><hr>
<p>​        程序没有释放已删除的文件</p>
<h3 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h3><hr>
<blockquote>
<p>​        重启占用文件的程序</p>
<p>​        1.检查磁盘占用</p>
<p>​                 df -Th</p>
<p>​        2.检查目录占用大小</p>
<p>​                cd /</p>
<p>​                du -sh *|grep G</p>
<p>​        3.查看为释放文件的程序</p>
<p>​                lsof -i|grep delete</p>
</blockquote>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>磁盘</tag>
      </tags>
  </entry>
  <entry>
    <title>datagrip</title>
    <url>/sugw.github.io/2020/12/01/datagrip/</url>
    <content><![CDATA[<p><a href="https://mp.weixin.qq.com/s/DTECLX-Y-9XJEScsA4boDw">https://mp.weixin.qq.com/s/DTECLX-Y-9XJEScsA4boDw</a></p>
]]></content>
      <categories>
        <category>激活</category>
      </categories>
      <tags>
        <tag>激活</tag>
      </tags>
  </entry>
  <entry>
    <title>linux内核优化</title>
    <url>/sugw.github.io/2020/11/20/linux%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h3 id="一、配置国内源和epel"><a href="#一、配置国内源和epel" class="headerlink" title="一、配置国内源和epel"></a>一、配置国内源和epel</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">mkdir repo_bak</span><br><span class="line">mv *.repo repo_bak&#x2F;</span><br><span class="line">#基础源文件</span><br><span class="line">wget -P &#x2F;etc&#x2F;yum.repos.d&#x2F; http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo</span><br><span class="line">#epel源文件</span><br><span class="line">wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;epel-7.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo</span><br><span class="line">#重新生成yum缓存</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">#同步时间</span><br><span class="line">yum -y install ntp</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;ntpdate ntp1.aliyun.com</span><br><span class="line">echo &quot;* 04 * * * &#x2F;usr&#x2F;sbin&#x2F;ntpdate ntp1.aliyun.com &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot; &gt;&gt;&#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</span><br><span class="line"></span><br><span class="line">#禁用selinux</span><br><span class="line">sed -i &#39;s&#x2F;SELINUX&#x3D;enforcing&#x2F;SELINUX&#x3D;disabled&#x2F;&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line">#set ssh</span><br><span class="line">sed -i &#39;s&#x2F;^GSSAPIAuthentication yes$&#x2F;GSSAPIAuthentication no&#x2F;&#39; &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line">sed -i &#39;s&#x2F;#UseDNS yes&#x2F;UseDNS no&#x2F;&#39; &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line">systemctl  restart sshd.service</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="二、安装基础依赖包"><a href="#二、安装基础依赖包" class="headerlink" title="二、安装基础依赖包"></a>二、安装基础依赖包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y htop lrzsz nmap screen man expect \</span><br><span class="line">gcc gcc-c++ autoconf automake bzip2-devel \</span><br><span class="line">openssl-devel multitail kernel-devel \</span><br><span class="line">pam-devel zlib-devel perl-devel tcp_wrappers-devel</span><br></pre></td></tr></table></figure>



<h3 id="三、关闭selinux"><a href="#三、关闭selinux" class="headerlink" title="三、关闭selinux"></a>三、关闭selinux</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -i &#39;s&#x2F;^SELINUX&#x3D;.*&#x2F;SELINUX&#x3D;disabled&#x2F;g&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">setenforce 0</span><br><span class="line">#查看selinux设置</span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>

<h3 id="四、关闭默认的邮件服务"><a href="#四、关闭默认的邮件服务" class="headerlink" title="四、关闭默认的邮件服务"></a>四、关闭默认的邮件服务</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#(默认端口25)</span><br><span class="line">systemctl disable postfix</span><br><span class="line">systemctl stop postfix</span><br><span class="line">#查看系统默认监听的端口</span><br><span class="line">netstat -nlput |grep -v &quot;Proto&quot; | grep &quot;LISTEN&quot;</span><br></pre></td></tr></table></figure>

<h3 id="五、设置系统环境变量"><a href="#五、设置系统环境变量" class="headerlink" title="五、设置系统环境变量"></a>五、设置系统环境变量</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#添加执行权限</span><br><span class="line">chmod a+x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">#设置环境变量</span><br><span class="line">cat &gt;&gt;&#x2F;etc&#x2F;profile &lt;&lt;EOF</span><br><span class="line">$(date +%F)</span><br><span class="line">alias vi&#x3D;&#39;vim&#39;</span><br><span class="line">alias grep&#x3D;&#39;grep --color&#x3D;auto&#39;</span><br><span class="line">#设置300秒内用户无操作就字段断开终端</span><br><span class="line">export TMOUT&#x3D;300</span><br><span class="line">#将值设置为readonly 防止用户更改</span><br><span class="line">readonly TMOUT</span><br><span class="line">EOF</span><br><span class="line">source &#x2F;etc&#x2F;profile</span><br><span class="line">#vimrc设置</span><br><span class="line">cat &gt;&gt;&#x2F;etc&#x2F;vimrc &lt;&lt;EOF</span><br><span class="line">set tabstop&#x3D;4</span><br><span class="line">set softtabstop&#x3D;4</span><br><span class="line">set shiftwidth&#x3D;4</span><br><span class="line">set expandtab</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="六、设置文件打开描述符"><a href="#六、设置文件打开描述符" class="headerlink" title="六、设置文件打开描述符"></a>六、设置文件打开描述符</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;security&#x2F;limits.conf &lt;&lt;EOF</span><br><span class="line">##### $(date) #####</span><br><span class="line">* soft noproc 65535</span><br><span class="line">* hard noproc 65535</span><br><span class="line">* soft nofile 409600</span><br><span class="line">* hard nofile 409600</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="七、优化系统内核参数"><a href="#七、优化系统内核参数" class="headerlink" title="七、优化系统内核参数"></a>七、优化系统内核参数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#修改最大连接数</span><br><span class="line">net.nf_conntrack_max &#x3D; 655360</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established &#x3D; 1200</span><br><span class="line">#套接字由本端关闭，这个参数决了它在FIN-WAIT-2状态的时间，默认是60秒。</span><br><span class="line">net.ipv4.tcp_fin_timeout &#x3D; 2</span><br><span class="line">#socket废弃前重试的次数，重负载web服务器建议调小</span><br><span class="line">net.ipv4.tcp_orphan_retries &#x3D; 1</span><br><span class="line">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接。</span><br><span class="line">net.ipv4.tcp_tw_reuse &#x3D; 1</span><br><span class="line">#表示开启TCP连接中TIME-WAIT sockets的快速回收。</span><br><span class="line">net.ipv4.tcp_tw_recycle &#x3D; 1</span><br><span class="line">#表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN***。</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1</span><br><span class="line">#表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为10分钟。</span><br><span class="line">net.ipv4.tcp_keepalive_time &#x3D; 600</span><br><span class="line">#表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。</span><br><span class="line">net.ipv4.ip_local_port_range &#x3D; 1024 65000</span><br><span class="line">#加大SYN队列长度，默认是1024.可以容纳更多等待连接的网络连接数。</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 262144</span><br><span class="line">#imewait的数量，默认是180000。</span><br><span class="line">net.ipv4.tcp_max_tw_buckets &#x3D; 6000</span><br><span class="line">net.core.rmem_max &#x3D; 16777216</span><br><span class="line">net.core.wmem_max &#x3D; 16777216</span><br><span class="line">net.ipv4.tcp_sack &#x3D; 1</span><br><span class="line">net.ipv4.tcp_window_scaling &#x3D; 1</span><br><span class="line">net.ipv4.tcp_rmem &#x3D; 4096        87380   4194304</span><br><span class="line">net.ipv4.tcp_wmem &#x3D; 4096        16384   4194304</span><br><span class="line">net.core.wmem_default &#x3D; 8388608</span><br><span class="line">net.core.rmem_default &#x3D; 8388608</span><br><span class="line"></span><br><span class="line">#路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由，默认是300。</span><br><span class="line">net.ipv4.route.gc_timeout &#x3D; 100</span><br><span class="line">#内核放弃连接之前发送SYN+ACK的时间</span><br><span class="line">net.ipv4.tcp_syn_retries &#x3D; 1</span><br><span class="line">#内核放弃建立连接之前发送SYN包的数量。</span><br><span class="line">net.ipv4.tcp_synack_retries &#x3D; 1</span><br><span class="line">#调解系统同时发起的TCP连接数，默认为128.在高并发的请求中，默认值可能导致连接超时或重传。</span><br><span class="line">net.core.somaxconn &#x3D; 262144</span><br><span class="line">#该参数决定了，网络设备接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span><br><span class="line">net.core.netdev_max_backlog &#x3D; 262144</span><br><span class="line">#设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。可防止简单DoS***。</span><br><span class="line">net.ipv4.tcp_max_orphans &#x3D; 262144</span><br><span class="line"># 确保无人能修改路由表</span><br><span class="line">net.ipv4.conf.all.accept_redirects &#x3D; 0</span><br><span class="line">net.ipv4.conf.default.accept_redirects &#x3D; 0</span><br><span class="line">net.ipv4.conf.all.secure_redirects &#x3D; 0</span><br><span class="line">net.ipv4.conf.default.secure_redirects &#x3D; 0</span><br><span class="line"></span><br><span class="line">#关闭ipv6</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 &#x3D; 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 &#x3D; 1</span><br><span class="line"># 避免放大攻击</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts &#x3D; 1</span><br><span class="line"># 开启恶意icmp错误消息保护</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses &#x3D; 1</span><br><span class="line">#开启反向路径过滤</span><br><span class="line">net.ipv4.conf.all.rp_filter &#x3D; 1</span><br><span class="line">net.ipv4.conf.default.rp_filter &#x3D; 1</span><br><span class="line">关闭sysrq功能</span><br><span class="line">kernel.sysrq &#x3D; 0</span><br><span class="line"></span><br><span class="line">#core文件名中添加pid作为扩展名</span><br><span class="line">kernel.core_uses_pid &#x3D; 1</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1</span><br><span class="line">#修改消息队列长度</span><br><span class="line">kernel.msgmnb &#x3D; 65536</span><br><span class="line">kernel.msgmax &#x3D; 65536</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置最大内存共享段大小bytes</span><br><span class="line">kernel.shmmax &#x3D; 68719476736</span><br><span class="line">kernel.shmall &#x3D; 4294967296</span><br><span class="line"></span><br><span class="line">#刷新系统内核参数：</span><br><span class="line">&#x2F;sbin&#x2F;sysctl -p</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac start hexo for supervisor</title>
    <url>/sugw.github.io/2020/10/26/mac%20for%20supervisor/</url>
    <content><![CDATA[<h1 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">系统：mac</span><br><span class="line"></span><br><span class="line">应用：hexo</span><br><span class="line"></span><br><span class="line">守护程序：supervisord</span><br></pre></td></tr></table></figure>

<h1 id="1-安装supervisord"><a href="#1-安装supervisord" class="headerlink" title="1.安装supervisord"></a>1.安装supervisord</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip install supervisor</span><br></pre></td></tr></table></figure>

<h1 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h1><hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisord.conf</span><br><span class="line"></span><br><span class="line">; 包含其他的配置文件</span><br><span class="line">[include]</span><br><span class="line">files &#x3D; &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisor.d&#x2F;*.conf    ; 可以随意指定，目录不存在请先建立。配置文件可以是 *.conf 或 *.ini</span><br><span class="line"></span><br><span class="line"># &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisor.d&#x2F;hexo.conf</span><br><span class="line">[program:hexo]                          ; 是应用程序的唯一标识，不能重复</span><br><span class="line">directory &#x3D; &#x2F;Users&#x2F;suguowei&#x2F;Desktop&#x2F;sugw&#x2F;sugwBlog          ; 程序的启动目录</span><br><span class="line">command &#x3D; hexo s ; 启动命令</span><br><span class="line">autostart &#x3D; true                        ; 在 supervisord 启动的时候也自动启动</span><br><span class="line">startsecs &#x3D; 5                           ; 启动 5 秒后没有异常退出，就当作已经正常启动了</span><br><span class="line">autorestart &#x3D; true                      ; 程序异常退出后自动重启</span><br><span class="line">startretries &#x3D; 3                        ; 启动失败自动重试次数，默认是 3</span><br><span class="line">redirect_stderr &#x3D; true                  ; 把 stderr 重定向到 stdout，默认 false</span><br><span class="line">stdout_logfile_maxbytes &#x3D; 20MB</span><br><span class="line">stdout_logfile_backups &#x3D; 20</span><br><span class="line">stdout_logfile &#x3D; &#x2F;var&#x2F;log&#x2F;supervusor&#x2F;hexo.log   ; stdout 日志文件，注意：要确保目录已经建立并且可以访问（写权限）</span><br></pre></td></tr></table></figure>



<h1 id="3-启动"><a href="#3-启动" class="headerlink" title="3.启动"></a>3.启动</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/supervisord -c /usr/<span class="built_in">local</span>/etc/supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-问题"><a href="#4-问题" class="headerlink" title="4.问题"></a>4.问题</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-	程序启动目录权限</span><br><span class="line"></span><br><span class="line">-	日志文件权限</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>supervisor</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki lockdown权限配置</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%20lockdown%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h2 id="禁止游客访问站点内容，需注册"><a href="#禁止游客访问站点内容，需注册" class="headerlink" title="禁止游客访问站点内容，需注册"></a>禁止游客访问站点内容，需注册</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 拒绝没注册用户浏览和编辑</span><br><span class="line">$wgGroupPermissions[&#39;*&#39;][&#39;edit&#39;] &#x3D; false;</span><br><span class="line">$wgGroupPermissions[&#39;*&#39;][&#39;read&#39;] &#x3D; false;</span><br><span class="line"></span><br><span class="line">## 设置游客可以看到的页面</span><br><span class="line">$wgWhitelistRead &#x3D; array (&quot;Main Page&quot;, &quot;MediaWiki:Common.css&quot;,&quot;MediaWiki:Common.js&quot;,&quot;Special:Userlogin&quot;,&quot;特殊:创建账户&quot;, &quot;Wikipedia:Help&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="安装lockdown插件"><a href="#安装lockdown插件" class="headerlink" title="安装lockdown插件"></a>安装lockdown插件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#1.下载</span><br><span class="line"># 2.解压</span><br><span class="line"># 3. 放到extensions&#x2F;目录下</span><br><span class="line">extensions&#x2F;Lockdown&#x2F;</span><br><span class="line"># 4. 配置文件引入</span><br><span class="line">wfLoadExtension( &#39;Lockdown&#39; );</span><br><span class="line"># 5. LocalSettings.php创建名字空间</span><br><span class="line">$wgExtraNamespaces &#x3D;</span><br><span class="line">       array (104 &#x3D;&gt; &quot;OPS&quot;,</span><br><span class="line">             105 &#x3D;&gt; &quot;OPS_Talk&quot;);</span><br><span class="line"># 6. 只允许sysop用户访问</span><br><span class="line">$wgNamespacePermissionLockdown &#x3D; array_fill( 104, 105, [  &#39;*&#39; &#x3D;&gt; [ &#39;sysop&#39;  ] ] );</span><br><span class="line"></span><br><span class="line"># 7. 创建页面，把页面移动到ops名字空间</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki安装</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h2 id="环境：php73-mysql5-7-mediawiki1-35-nginx1-18"><a href="#环境：php73-mysql5-7-mediawiki1-35-nginx1-18" class="headerlink" title="环境：php73+mysql5.7+mediawiki1.35+nginx1.18"></a>环境：php73+mysql5.7+mediawiki1.35+nginx1.18</h2><h3 id="安装PHP73"><a href="#安装PHP73" class="headerlink" title="安装PHP73"></a>安装PHP73</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#首先安装 EPEL 源：</span></span><br><span class="line">yum install epel-release</span><br><span class="line"><span class="comment">#安装 REMI 源：</span></span><br><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">yum install -y php73 php73-php-pecl-apcu php73-php-intl php73-php-mbstring php73-php-xml php73-php-pecl-mysql</span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">systemctl restart php73-php-fpm</span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> php73-php-fpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看安装包</span></span><br><span class="line">[root@l-wiki01 ~]<span class="comment">#  rpm -qa | grep &#x27;php&#x27;</span></span><br><span class="line">php73-php-cli-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-2.0-1.el7.remi.x86_64</span><br><span class="line">php73-php-mbstring-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-gd-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-crypto-0.3.1-5.el7.remi.x86_64</span><br><span class="line">oniguruma5php-6.9.5+rev1-4.el7.remi.x86_64</span><br><span class="line">php73-runtime-2.0-1.el7.remi.x86_64</span><br><span class="line">php73-php-common-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pdo-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-mysql-1.0.0-0.20.20180226.647c933.el7.remi.x86_64</span><br><span class="line">php73-php-intl-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-apcu-5.1.19-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-mcrypt-1.0.3-1.el7.remi.x86_64</span><br><span class="line">php73-php-snmp-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-bcmath-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-geoip-1.1.1-6.el7.remi.x86_64</span><br><span class="line">php73-php-soap-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-json-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-mysqlnd-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-xml-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-recode-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-opcache-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-fpm-7.3.24-1.el7.remi.x86_64</span><br><span class="line"></span><br><span class="line">找到：php73-php-fpm-7.3.24-1.el7.remi.x86_64安装位置</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># rpm -ql php73-php-fpm-7.3.24-1.el7.remi.x86_64</span></span><br><span class="line">/etc/logrotate.d/php73-php-fpm</span><br><span class="line">/etc/opt/remi/php73/php-fpm.conf</span><br><span class="line">/etc/opt/remi/php73/php-fpm.d</span><br><span class="line">/etc/opt/remi/php73/php-fpm.d/www.conf</span><br><span class="line">/etc/opt/remi/php73/sysconfig/php-fpm</span><br><span class="line">/etc/systemd/system/php73-php-fpm.service.d</span><br><span class="line">/opt/remi/php73/root/usr/sbin/php-fpm</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24/php-fpm.conf.default</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24/www.conf.default</span><br><span class="line">/opt/remi/php73/root/usr/share/fpm</span><br><span class="line">/opt/remi/php73/root/usr/share/fpm/status.html</span><br><span class="line">/opt/remi/php73/root/usr/share/licenses/php73-php-fpm-7.3.24</span><br><span class="line">/opt/remi/php73/root/usr/share/licenses/php73-php-fpm-7.3.24/fpm_LICENSE</span><br><span class="line">/opt/remi/php73/root/usr/share/man/man8/php-fpm.8.gz</span><br><span class="line">/usr/lib/systemd/system/php73-php-fpm.service</span><br><span class="line">/var/opt/remi/php73/lib/php/opcache</span><br><span class="line">/var/opt/remi/php73/lib/php/session</span><br><span class="line">/var/opt/remi/php73/lib/php/wsdlcache</span><br><span class="line">/var/opt/remi/php73/<span class="built_in">log</span>/php-fpm</span><br><span class="line">/var/opt/remi/php73/run/php-fpm</span><br><span class="line"></span><br><span class="line">查找php.ini位置：</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># find /etc/opt/remi/php73 -name php.ini</span></span><br><span class="line">/etc/opt/remi/php73/php.ini</span><br><span class="line"></span><br><span class="line">编辑/etc/opt/remi/php73/php.ini替换换 ;cgi.fix_pathinfo=1 为 cgi.fix_pathinfo=0 快捷命令：</span><br><span class="line">sed -i <span class="string">&#x27;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/&#x27;</span> /etc/opt/remi/php73/php.ini</span><br><span class="line"></span><br><span class="line">重启php73-php-fpm</span><br><span class="line">systemctl restart php73-php-fpm</span><br><span class="line">更多操作：</span><br><span class="line">systemctl restart php73-php-fpm <span class="comment">#重启</span></span><br><span class="line">systemctl start php73-php-fpm <span class="comment">#启动</span></span><br><span class="line">systemctl stop php73-php-fpm <span class="comment">#关闭</span></span><br><span class="line">systemctl status php73-php-fpm <span class="comment">#检查状态</span></span><br><span class="line">查看 PHP</span><br><span class="line">验证一下是否安装成功：</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># php73 -v</span></span><br><span class="line">PHP 7.3.24 (cli) (built: Oct 27 2020 11:01:59) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.3.24, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.3.24, Copyright (c) 1999-2018, by Zend Technologies</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载源</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line"><span class="comment">#更新源</span></span><br><span class="line">rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line"><span class="comment">#安装mysql</span></span><br><span class="line">yum -y install mysql-server</span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="comment">#查看临时密码</span></span><br><span class="line">grep <span class="string">&#x27;temporary password&#x27;</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"><span class="comment">#修改root临时密码</span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123@CSDN.com&#x27;</span>;  <span class="comment">#密码要符合安全策略否则不生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建wiki库</span></span><br><span class="line">CREATE DATABASE IF NOT EXISTS wiki DEFAULT CHARACTER SET = utf8mb4;</span><br><span class="line"><span class="comment">#创建wiki库管理账号密码</span></span><br><span class="line"><span class="comment">#授权的同时设置密码</span></span><br><span class="line">grant all privileges on wiki.* to wiki@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装mediawiki1-35"><a href="#安装mediawiki1-35" class="headerlink" title="安装mediawiki1.35"></a>安装mediawiki1.35</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载 官网下载需要翻墙</span></span><br><span class="line">百度云盘下载</span><br><span class="line">链接: https://pan.baidu.com/s/1Gd0OEirZOQttU4LPSJ9DiQ 提取码: drds </span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar zxvf mediawiki-1.35.0.tar.gz</span><br><span class="line"><span class="comment"># 更名</span></span><br><span class="line">mv mediawiki-1.35.0 mediawiki</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install nginx</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="comment"># 开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">[root@l-wiki01 nginx]<span class="comment"># cat vhost/wiki.conf</span></span><br><span class="line">server</span><br><span class="line">  &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  wiki.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root  /data/mediawiki;</span><br><span class="line"></span><br><span class="line">    location ~ /.svn/ &#123;</span><br><span class="line">    deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#rewrite ^/$ /?user=talkvip last;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    rewrite ^/$ /index.php last;</span><br><span class="line">    rewrite ^/(?!index\.php|index\.html|extensions|images|public|robots\.txt)(.*)$ /index.php/<span class="variable">$1</span> last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   location ~ \.php &#123;</span><br><span class="line">		 proxy_busy_buffers_size   512k;</span><br><span class="line">		 proxy_buffers   4 512k;</span><br><span class="line">		 proxy_buffer_size   256k;</span><br><span class="line">                fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">                fastcgi_index index.php;</span><br><span class="line">                fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">                include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~/uploads/.*\.(php|php7)?$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~/public/.*\.(php|php7)?$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">    &#123;</span><br><span class="line">      expires      30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(js|css)?$</span><br><span class="line">   &#123;</span><br><span class="line">      expires      8d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        access_log  /data/logs/mediawiki/access.log  main;</span><br><span class="line">        error_log  /data/logs/mediawiki/error.log ;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#nginx 配置文件引入wiki.conf文件</span></span><br><span class="line">    include vhost/*.conf;</span><br><span class="line"><span class="comment"># 加载配置文件</span></span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问不到站点可能存在以下几个原因</span></span><br><span class="line">1.站点权限和nginx配置文件权限不匹配</span><br><span class="line">2.站点权限nginx权限和php权限检查</span><br><span class="line"></span><br><span class="line">[root@l-wiki01 nginx]<span class="comment"># cat /etc/opt/remi/php73/php-fpm.d/www.conf |egrep -v &quot;^$|;&quot;</span></span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 5</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">slowlog = /var/opt/remi/php73/<span class="built_in">log</span>/php-fpm/www-slow.log</span><br><span class="line">security.limit_extensions = .php .php3 .php4 .php5 .php7 .html .htm .pl .js .css .jpg .jpeg .gif .png .svg</span><br><span class="line">php_admin_value[error_log] = /var/opt/remi/php73/<span class="built_in">log</span>/php-fpm/www-error.log</span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path]    = /var/opt/remi/php73/lib/php/session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/opt/remi/php73/lib/php/wsdlcache</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="访问站点根据教程安装"><a href="#访问站点根据教程安装" class="headerlink" title="访问站点根据教程安装"></a>访问站点根据教程安装</h3><p>wiki.com</p>
<p>参考文档：<a href="https://zhuanlan.zhihu.com/p/53827054">https://zhuanlan.zhihu.com/p/53827054</a></p>
]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki悬浮目录</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%E6%82%AC%E6%B5%AE%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<h2 id="MediaWiki-Common-css"><a href="#MediaWiki-Common-css" class="headerlink" title="MediaWiki:Common.css"></a>MediaWiki:Common.css</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#toc</span>&#123;</span><br><span class="line"> <span class="attribute">display</span>: block;</span><br><span class="line"> <span class="attribute">position</span>: fixed;</span><br><span class="line"> <span class="attribute">top</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">right</span>: <span class="number">0px</span>;</span><br><span class="line"> <span class="attribute">min-width</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">max-width</span>: <span class="number">350px</span>;</span><br><span class="line"> <span class="attribute">max-height</span>: <span class="number">20px</span>;</span><br><span class="line"> <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line"> <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#aaa</span>;</span><br><span class="line"> <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">-moz-border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">249</span>,<span class="number">249</span>,<span class="number">249</span>,<span class="number">0.75</span>);</span><br><span class="line"> <span class="attribute">padding</span>: <span class="number">12px</span>;</span><br><span class="line"> <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-webkit-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-moz-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="selector-id">#toc</span><span class="selector-pseudo">:hover</span>&#123;</span><br><span class="line"> <span class="attribute">display</span>: block;</span><br><span class="line"> <span class="attribute">position</span>: fixed;</span><br><span class="line"> <span class="attribute">top</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">right</span>: <span class="number">0px</span>;</span><br><span class="line"> <span class="attribute">min-width</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">max-width</span>: <span class="number">350px</span>;</span><br><span class="line"> <span class="attribute">max-height</span>: <span class="number">500px</span>;</span><br><span class="line"> <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line"> <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#aaa</span>;</span><br><span class="line"> <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">-moz-border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">249</span>,<span class="number">249</span>,<span class="number">249</span>,<span class="number">0.75</span>);</span><br><span class="line"> <span class="attribute">padding</span>: <span class="number">12px</span>;</span><br><span class="line"> <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-webkit-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-moz-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="selector-tag">body</span> &#123; <span class="attribute">overflow-x</span>: hidden;&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql 删除表数据空间没有释放</title>
    <url>/sugw.github.io/2021/01/06/mysql-delete/</url>
    <content><![CDATA[<p>事件起因：</p>
<p>今天运维人员找我，说我们的数据库磁盘空间满了。于是提供了一些删除表数据的sql给他，让他执行下。</p>
<p>执行之后，查询数据库，表数据是不在了，但是问题来了。</p>
<p>磁盘空间并没有释放，这是为啥咧？？？？</p>
<p>于是乎，上网查找资料，功夫不负有心人，终于找到问题原因：</p>
<h3 id="使用delete-加上-where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。-被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。"><a href="#使用delete-加上-where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。-被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。" class="headerlink" title="使用delete 加上 where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。 被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。"></a><strong>使用delete 加上 where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。</strong> <strong>被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。</strong></h3><p>解决方法：</p>
<p>执行完delete语句的时候，再执行下：<strong>OPTIMIZE TABLE XXXTable(自己的表名)</strong></p>
<p><strong>注意事项：</strong></p>
<p><strong>执行OPTIMIZE TABLE的时候，会导致锁表，而且没有必要每次delete之后都执行，一个月定时清理下即可。另外，OPTIMIZE 操作会导致锁表，建议在访问量小的时候执行！</strong></p>
<p>转载于：<a href="https://www.cnblogs.com/shawnloong/archive/2013/02/07/2908911.html">https://www.cnblogs.com/shawnloong/archive/2013/02/07/2908911.html</a></p>
]]></content>
      <categories>
        <category>mysql 删除表数据空间没有释放</category>
      </categories>
  </entry>
  <entry>
    <title>nginx 阻止IP访问实例</title>
    <url>/sugw.github.io/2020/10/28/nginx%E9%98%BB%E6%AD%A2IP%E8%AE%BF%E9%97%AE%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<h3 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h3><p>静态文件，较简单</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ^~ &#x2F;static&#x2F;css&#x2F; &#123;</span><br><span class="line">       deny 10.120.0.1;</span><br><span class="line">       deny 10.120.11.78;</span><br><span class="line">       #allow 10.120.11.3;</span><br><span class="line">       #allow 43.243.138.146;</span><br><span class="line">       #allow 114.118.12.231;</span><br><span class="line">       deny all;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h3><p>路由较复杂：</p>
<figure class="highlight plain"><figcaption><span>s</span></figcaption><table><tr><td class="code"><pre><span class="line">location ^~ &#x2F;api&#x2F;fanstest&#x2F; &#123;</span><br><span class="line">   if ($remote_addr ~ &quot;(103.118.52.18|114.118.12.231|114.118.13.46)&quot;) &#123;</span><br><span class="line">       rewrite  ^(.*)$  &#x2F;index.php?s&#x3D;$1  last;</span><br><span class="line">   &#125;</span><br><span class="line">   if ($remote_addr &#x3D; &quot;10.120.11.3&quot;) &#123;</span><br><span class="line">       rewrite  ^(.*)$  &#x2F;index.php?s&#x3D;$1  last;</span><br><span class="line">   &#125;</span><br><span class="line">     return 403;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>开启GTID的情况下导出导入库的注意事项</title>
    <url>/sugw.github.io/2020/12/17/%E5%BC%80%E5%90%AFGTID%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%20/</url>
    <content><![CDATA[<blockquote>
<p>在开启了 GTID 功能的 MySQL 数据库中, 不论是否使用了 GTID 的方式做了主从同步, 导出导入时都需要特别注意数据库中的 GTID 信息.</p>
</blockquote>
<h1 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  mysqldump -uroot -p userdb &gt; userdb.sql</span><br><span class="line">Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don&#39;t want to restore GTIDs, pass --set-gtid-purged&#x3D;OFF. To make a complete dump, pass --all-databases --triggers --routines --events</span><br></pre></td></tr></table></figure>

<p>mysql提示: 当前数据库实例中开启了 GTID 功能, 在开启有 GTID 功能的数据库实例中, 导出其中任何一个库, 如果没有显示地指定<code>--set-gtid-purged</code>参数, 都会提示这一行信息. 意思是默认情况下, 导出的库中含有 GTID 信息, 如果不想导出包含有 GTID 信息的数据库, 需要显示地添加<code>--set-gtid-purged=OFF</code>参数. 于是乎, dump 变成了如下样子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ mysqldump -uroot -p --set-gtid-purged&#x3D;OFF userdb &gt; userdb.sql</span><br></pre></td></tr></table></figure>

<p>使用以上这条命令 dump 出来的库是不包含 GTID 信息的</p>
<h1 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h1><p>导入的时候也分两种, 一种是导入带有 GTID 的信息的库, 一种是导入不带有 GTID 信息的库</p>
<h2 id="不带有-GTID-信息"><a href="#不带有-GTID-信息" class="headerlink" title="不带有 GTID 信息"></a>不带有 GTID 信息</h2><p>不带有 GTID 信息的 dump 文件, 不管目标数据库实例是否开启了 GTID 功能, 且不管数据库实例是否已有其他 GTID 信息, 都可以顺利导入</p>
<h2 id="带有-GTID-信息"><a href="#带有-GTID-信息" class="headerlink" title="带有 GTID 信息"></a>带有 GTID 信息</h2><p>带有 GTID 信息的 dump 文件, 要求目标数据库实例必须开启 GTID 功能, 且当前数据库中无其他 GTID 信息. 如果目标数据库中已经记录了一条或一条以上的 GTID 信息, 那么在导入数据库时会报出类似如下的错误❌</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  mysql -uroot -p userdb &lt; userdb.sql</span><br><span class="line">Password:xxxxxxxx</span><br><span class="line">ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure>

<p>在 mysql5.7版本中加入了多 channel 的特性, 一台数据库实例可以同时与多个主库同步, 实现多主一从架构, 但是假如现在数据库实例中开启了 GTID, 并以 GTID 的方式与 A 主库和 B 主库同步,那么现在的 slave 中就记录有两条 GTID 信息. 在导入带有新 GTID 信息的库时, 会报错, 要求你清除掉目标数据库实例中所有的 GTID 信息. 在这种情况下, 问题就比较严重了, 因为我的这台数据库已经和两台主库建立主从关系, 现在为了导入一个新库, 需要 reset 掉所有同步信息(GTID 信息)</p>
<p>这个时候你有两个选择:</p>
<ol>
<li>重新 dump 数据库, 使用<code>--set-gtid-purged=OFF</code>的参数禁止🚫导出 GTID 信息,再 load 进目标数据库</li>
<li>在目标数据库中执行<code>mysql&gt; reset slave all;</code> <code>mysql&gt; reset master;</code> 清空所有 GTID 信息之后就可以导入了</li>
</ol>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus-pushgateway</title>
    <url>/sugw.github.io/2020/11/23/prometheus-pushgateway/</url>
    <content><![CDATA[<h1 id="一、Pushgateway-简介"><a href="#一、Pushgateway-简介" class="headerlink" title="一、Pushgateway 简介"></a>一、Pushgateway 简介</h1><p><a href="https://github.com/prometheus/pushgateway">Pushgateway</a> 是 Prometheus 生态中一个重要工具，使用它的原因主要是：</p>
<ul>
<li>Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。</li>
<li>在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。</li>
</ul>
<p>由于以上原因，不得不使用 pushgateway，但在使用之前，有必要了解一下它的一些弊端：</p>
<ul>
<li>将多个节点数据汇总到 pushgateway, 如果 pushgateway 挂了，受影响比多个 target 大。</li>
<li>Prometheus 拉取状态 <code>up</code> 只针对 pushgateway, 无法做到对每个节点有效。</li>
<li>Pushgateway 可以持久化推送给它的所有监控数据。</li>
</ul>
<p>因此，即使你的监控已经下线，prometheus 还会拉取到旧的监控数据，需要手动清理 pushgateway 不要的数据。</p>
<p>拓扑图如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181109120151807-1018788353.png" class title="img">





<h3 id="二、-安装"><a href="#二、-安装" class="headerlink" title="二、 安装"></a>二、 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.3.0/pushgateway-1.3.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar xf pushgateway-1.3.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv pushgateway-1.3.0.linux-amd64 pushgateway</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> pushgateway/</span><br><span class="line"></span><br><span class="line">./pushgateway</span><br></pre></td></tr></table></figure>



<p>访问url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.91.132:9091&#x2F;</span><br></pre></td></tr></table></figure>



<p>效果如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184527450-1425046509.png" class title="img">





<p>要使Push Gateway正常工作，必须要在prometheus中配置对应的job才行</p>
<p>修改配置文件 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;opt&#x2F;apps&#x2F;prometheus&#x2F;prometheus.yml</span><br></pre></td></tr></table></figure>



<p>添加Push Gateway，完整内容如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">60s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">60s</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">prometheus</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.91.132:9100&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">pushgateway</span></span><br><span class="line">    <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.91.132:9091&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">pushgateway</span> </span><br></pre></td></tr></table></figure>

<p>访问targets，等待1分钟，等待pushgateway状态为UP</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185739578-1598911471.png" class title="img">



<h2 id="三、数据管理"><a href="#三、数据管理" class="headerlink" title="三、数据管理"></a>三、数据管理</h2><p>正常情况我们会使用 Client SDK 推送数据到 pushgateway, 但是我们还可以通过 API 来管理, 例如：</p>
<h2 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h2><p>向 {job=”some_job”} 添加单条数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;some_metric 3.14&quot; | curl --data-binary @- http:&#x2F;&#x2F;pushgateway.example.org:9091&#x2F;metrics&#x2F;job&#x2F;some_job</span><br></pre></td></tr></table></figure>



<p> –data-binary 表示发送二进制数据，注意：它是使用POST方式发送的！</p>
<p>添加更多更复杂数据，通常数据会带上 instance, 表示来源位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http:&#x2F;&#x2F;pushgateway.example.org:9091&#x2F;metrics&#x2F;job&#x2F;some_job&#x2F;instance&#x2F;some_instance</span><br><span class="line"># TYPE some_metric counter</span><br><span class="line">some_metric&#123;label&#x3D;&quot;val1&quot;&#125; 42</span><br><span class="line"># TYPE another_metric gauge</span><br><span class="line"># HELP another_metric Just an example.</span><br><span class="line">another_metric 2398.283</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>注意：必须是指定的格式才行！ </p>
<p>删除某个组下的某实例的所有数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -X DELETE http:&#x2F;&#x2F;pushgateway.example.org:9091&#x2F;metrics&#x2F;job&#x2F;some_job&#x2F;instance&#x2F;some_instance</span><br></pre></td></tr></table></figure>



<p>删除某个组下的所有数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -X DELETE http:&#x2F;&#x2F;pushgateway.example.org:9091&#x2F;metrics&#x2F;job&#x2F;some_job</span><br></pre></td></tr></table></figure>



<p>可以发现 pushgateway 中的数据我们通常按照 <code>job</code> 和 <code>instance</code> 分组分类，所以这两个参数不可缺少。</p>
<p>因为 Prometheus 配置 pushgateway 的时候，也会指定 job 和 instance, 但是它只表示 pushgateway 实例，不能真正表达收集数据的含义。所以在 prometheus 中配置 pushgateway 的时候，需要添加 <code>honor_labels: true</code> 参数， 从而避免收集数据本身的 <code>job</code> 和 <code>instance</code> 被覆盖。</p>
<p>注意，为了防止 pushgateway 重启或意外挂掉，导致数据丢失，我们可以通过 <code>-persistence.file</code> 和 <code>-persistence.interval</code> 参数将数据持久化下来。</p>
<p>本文参考链接：</p>
<p><a href="https://songjiayang.gitbooks.io/prometheus/content/pushgateway/how.html">https://songjiayang.gitbooks.io/prometheus/content/pushgateway/how.html</a></p>
<h2 id="python脚本"><a href="#python脚本" class="headerlink" title="python脚本"></a>python脚本</h2><h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install flask</span><br><span class="line">pip3 install prometheus_client</span><br></pre></td></tr></table></figure>



<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><p>Prometheus提供4种类型Metrics：<code>Counter</code>, <code>Gauge</code>, <code>Summary</code>和<code>Histogram</code></p>
<h4 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h4><p>Counter可以增长，并且在程序重启的时候会被重设为0，常被用于任务个数，总处理时间，错误个数等只增不减的指标。</p>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> prometheus_client</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> prometheus_client.core <span class="keyword">import</span> CollectorRegistry</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Response, Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">requests_total = Counter(<span class="string">&quot;request_count&quot;</span>, <span class="string">&quot;Total request cout of the host&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/metrics&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requests_count</span>():</span></span><br><span class="line">    requests_total.inc()</span><br><span class="line">    <span class="comment"># requests_total.inc(2)</span></span><br><span class="line">    <span class="keyword">return</span> Response(prometheus_client.generate_latest(requests_total),</span><br><span class="line">                    mimetype=<span class="string">&quot;text/plain&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    requests_total.inc()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>) </span><br></pre></td></tr></table></figure>

<p>运行该脚本，访问youhost:5000/metrics</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># HELP request_count Total request cout of the host</span><br><span class="line"># TYPE request_count counter</span><br><span class="line">request_count 3.0</span><br></pre></td></tr></table></figure>



<h4 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h4><p>Gauge与Counter类似，唯一不同的是Gauge数值可以减少，常被用于温度、利用率等指标。</p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import random</span><br><span class="line">import prometheus_client</span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">from flask import Response, Flask</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">random_value &#x3D; Gauge(&quot;random_value&quot;, &quot;Random value of the request&quot;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;metrics&quot;)</span><br><span class="line">def r_value():</span><br><span class="line">    random_value.set(random.randint(0, 10))</span><br><span class="line">    return Response(prometheus_client.generate_latest(random_value),</span><br><span class="line">                    mimetype&#x3D;&quot;text&#x2F;plain&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run(host&#x3D;&quot;0.0.0.0&quot;) </span><br></pre></td></tr></table></figure>

<p>运行该脚本，访问youhost:5000/metrics</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># HELP random_value Random value of the request</span><br><span class="line"># TYPE random_value gauge</span><br><span class="line">random_value 3.0</span><br></pre></td></tr></table></figure>



<h4 id="Summary-Histogram"><a href="#Summary-Histogram" class="headerlink" title="Summary/Histogram"></a>Summary/Histogram</h4><p>Summary/Histogram概念比较复杂，一般exporter很难用到，暂且不说。</p>
<p><strong>PLUS</strong></p>
<p><strong>LABELS</strong></p>
<p>使用labels来区分metric的特征</p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from prometheus_client import Counter</span><br><span class="line"></span><br><span class="line">c &#x3D; Counter(&#39;requests_total&#39;, &#39;HTTP requests total&#39;, [&#39;method&#39;, &#39;clientip&#39;])</span><br><span class="line"></span><br><span class="line">c.labels(&#39;get&#39;, &#39;127.0.0.1&#39;).inc()</span><br><span class="line">c.labels(&#39;post&#39;, &#39;192.168.0.1&#39;).inc(3)</span><br><span class="line">c.labels(method&#x3D;&quot;get&quot;, clientip&#x3D;&quot;192.168.0.1&quot;).inc()</span><br></pre></td></tr></table></figure>



<p><strong>REGISTRY</strong></p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from prometheus_client import Counter, Gauge</span><br><span class="line">from prometheus_client.core import CollectorRegistry</span><br><span class="line"></span><br><span class="line">REGISTRY &#x3D; CollectorRegistry(auto_describe&#x3D;False)</span><br><span class="line"></span><br><span class="line">requests_total &#x3D; Counter(&quot;request_count&quot;, &quot;Total request cout of the host&quot;, registry&#x3D;REGISTRY)</span><br><span class="line">random_value &#x3D; Gauge(&quot;random_value&quot;, &quot;Random value of the request&quot;, registry&#x3D;REGISTRY) </span><br></pre></td></tr></table></figure>

<p>本文参考链接：</p>
<p><a href="https://blog.csdn.net/huochen1994/article/details/76263078">https://blog.csdn.net/huochen1994/article/details/76263078</a></p>
<h3 id="举例-网卡流量"><a href="#举例-网卡流量" class="headerlink" title="举例:(网卡流量)"></a>举例:(网卡流量)</h3><p>先访问这篇文章《python 获取网卡实时流量》：</p>
<p><a href="http://www.py3study.com/Article/details/id/347.html">http://www.py3study.com/Article/details/id/347.html</a></p>
<p>下面这段python脚本，主要是参考上面文章的基础上修改的</p>
<p>发送本机网卡流量 </p>
<p>执行脚本，它会发送1次数据给Push Gateway</p>
<p>取到的流量没有除以1024，所以默认是字节</p>
<p><strong>注意：发送的链接，约定成俗的格式如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;Pushgateway地址:9091&#x2F;metrics&#x2F;job&#x2F;监控项目</span><br></pre></td></tr></table></figure>

<p>比如监控etcd，地址就是这样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;Pushgateway地址:9091&#x2F;metrics&#x2F;job&#x2F;etcd</span><br></pre></td></tr></table></figure>



<p><strong>必须使用POST方式发送数据！</strong></p>
<h4 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h4><p>关键代码，就是这几行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGISTRY &#x3D; CollectorRegistry(auto_describe&#x3D;False)</span><br><span class="line">input &#x3D; Gauge(&quot;network_traffic_input&quot;, hostname,[&#39;adapter_name&#39;,&#39;unit&#39;,&#39;ip&#39;,&#39;instance&#39;],registry&#x3D;REGISTRY)  # 流入</span><br><span class="line">output &#x3D; Gauge(&quot;network_traffic_output&quot;, hostname,[&#39;adapter_name&#39;,&#39;unit&#39;,&#39;ip&#39;,&#39;instance&#39;],registry&#x3D;REGISTRY)  # 流出</span><br><span class="line"></span><br><span class="line">input.labels(ip&#x3D;net_addr[key],adapter_name&#x3D;key, unit&#x3D;&quot;Byte&quot;,instance&#x3D;hostname).inc(net_in.get(key))</span><br><span class="line">output.labels(ip&#x3D;net_addr[key],adapter_name&#x3D;key, unit&#x3D;&quot;Byte&quot;,instance&#x3D;hostname).inc(net_out.get(key))</span><br></pre></td></tr></table></figure>



<p>1、自定义的指标收集类都必须到CollectorRegistry进行注册， 指标数据通过CollectorRegistry类的方法或者函数，返回给Prometheus.<br>2、CollectorRegistry必须提供register()和unregister()函数，一个指标收集器可以注册多个CollectorRegistry.<br>3、客户端库必须是线程安全的</p>
<p>代码第一行，声明了CollectorRegistry</p>
<p>input和output是流入流出的流量。Metrics使用的是Gauge</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">input &#x3D; Gauge(&quot;network_traffic_input&quot;, hostname,[&#39;adapter_name&#39;,&#39;unit&#39;,&#39;ip&#39;,&#39;instance&#39;],registry&#x3D;REGISTRY)  # 流入</span><br></pre></td></tr></table></figure>



<p>network_traffic_input表示键值，它必须唯一。因为在grafana图表中，要用这个键值绘制图表。</p>
<p>“” 为空，它其实对应的是描述信息。为了避免数据冗长，一般不写它。</p>
<p>[‘adapter_name’,’unit’,’ip’,’instance’] ，它是一个列表，里面每一个元素都是labels，它是用来区分metric的特征</p>
<p>registry=REGISTRY 把数据注册到REGISTRY中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">input.labels(ip&#x3D;net_addr[key],adapter_name&#x3D;key, unit&#x3D;&quot;Byte&quot;,instance&#x3D;hostname).inc(net_in.get(key))</span><br></pre></td></tr></table></figure>



<p>这里定义了input的labels，括号里面有3个键值对。<strong>注意：这3个键值对必须在[‘adapter_name’,’unit’,’ip’] 列表中。</strong></p>
<p>如果labels中要增加键值对，那么上面的列表中，也要增加对应的元素。否则会报错！</p>
<p>inc表示具体值。它对应的是input</p>
<p>刷新Push Gateway页面</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184858813-100768690.png" class title="img">



<p>展开数据，这里就是流入流出的数据了</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184910331-1187418117.png" class title="img">



<p> 进入grafana页面，新建一个图表</p>
<p>添加网络 流入和流出指标</p>
 <img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185021071-1832061672.png" class title="img">



<p>更改标题</p>
 <img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185132311-1692507631.png" class title="img">



<p>设置liunx任务计划，每分钟执行一次</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">* * * * * python3 &#x2F;opt&#x2F;test.py</span><br></pre></td></tr></table></figure>





<p>效果如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185223977-1139168879.png" class title="img">



<p>如果服务器没有流量的话，可以造点流量</p>
<p>写一个脚本，持续访问某张图片</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">while True:</span><br><span class="line">    requests.get(&quot;http:&#x2F;&#x2F;192.168.91.128&#x2F;Netraffic&#x2F;dt.jpg&quot;)</span><br><span class="line">    print(&#39;正在访问图片&#39;)</span><br></pre></td></tr></table></figure>



<p>如果需要监控Mysql，参考这篇文章</p>
<p><a href="https://www.jianshu.com/p/27b979554ef8">https://www.jianshu.com/p/27b979554ef8</a></p>
<p>注意：它使用的是用flask暴露了一个Metrics，用来给Prometheus提供数据。</p>
<p>那么就需要在 Prometheus的配置文件中，添加对应的job才能收集到数据。</p>
<p>它会定期访问暴露的http链接，获取数据。</p>
<p>总结：</p>
<p>使用Prometheus监控，有2中方式</p>
<ol>
<li><p>暴露http方式的Metrics，注意：需要在Prometheus的配置文件中添加job</p>
</li>
<li><p>主动发送数据到Pushgateway，注意：只需要添加一个Pushgateway就可以了。它相当于一个API，无论有多少个服务器，发送到统一的地址。</p>
</li>
</ol>
<p>生产环境中，一般使用Pushgateway，简单，也不需要修改Prometheus的配置文件！</p>
<ul>
<li><h1 id="node-exports-推送"><a href="#node-exports-推送" class="headerlink" title="node_exports 推送"></a>node_exports 推送</h1></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl 127.0.0.1:9100/metrics|curl --data-binary @- http://114.118.10.162:9091/metrics/job/node_exporter/instance/比格云/hostname/l-crmeb01.qa.hn-ml.com</span><br></pre></td></tr></table></figure>

<p><strong>也可以通过使用官方给的<a href="https://github.com/prometheus/client_python">python library</a>，使用push 方式把数据推送到pushgateway。</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat client.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, push_to_gateway</span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line">g = Gauge(<span class="string">&#x27;ping&#x27;</span>, <span class="string">&#x27;检测最大响应时间&#x27;</span>,[<span class="string">&#x27;dst_ip&#x27;</span>,<span class="string">&#x27;city&#x27;</span>], registry=registry) <span class="comment">#Guage(metric_name,HELP,labels_name,registry=registry)</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.10&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).<span class="built_in">set</span>(<span class="number">42.2</span>) <span class="comment">#set设定值</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.11&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).dec(<span class="number">2</span>)  <span class="comment">#dec递减2</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.12&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).inc()  <span class="comment">#inc递增，默认增1</span></span><br><span class="line">push_to_gateway(<span class="string">&#x27;localhost:9091&#x27;</span>, job=<span class="string">&#x27;ping_status&#x27;</span>, registry=registry)</span><br></pre></td></tr></table></figure>

<p><strong>需要注意：使用这种方法，如果使用相同的job名 ，后面插入的数据会覆盖掉之前的。</strong></p>
<p>例如，job 都叫 ping_status</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, push_to_gateway</span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line">g = Gauge(<span class="string">&#x27;test_metrics&#x27;</span>, <span class="string">&#x27;描述信息&#x27;</span>,[<span class="string">&#x27;label_name&#x27;</span>], registry=registry)</span><br><span class="line">g.labels(<span class="string">&#x27;label1&#x27;</span>).<span class="built_in">set</span>(<span class="number">2</span>)</span><br><span class="line">push_to_gateway(<span class="string">&#x27;localhost:9091&#x27;</span>, job=<span class="string">&#x27;ping_status&#x27;</span>, registry=registry)</span><br></pre></td></tr></table></figure>

<p>监控脚本示例</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">获取tcp连接数脚本</span><br><span class="line"><span class="comment"># cat tcpestab.sh </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#获取主机名，常传输到Prometheus标签以主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d<span class="string">&#x27;.&#x27;</span> -f1`</span><br><span class="line"><span class="comment">#判断主机名不能是localhost不然发送过的数据不知道是那个主机的 </span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$instance_name</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hostname must not localhost&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#自定义key，在Prometheus即可使用key查询</span></span><br><span class="line">label=<span class="string">&quot;count_estab_connections&quot;</span> </span><br><span class="line"><span class="comment">#获取TCP estab 连接数</span></span><br><span class="line">count_estab_connections=`netstat -an | grep -i <span class="string">&#x27;established&#x27;</span> | wc -l`</span><br><span class="line"><span class="comment">#将数据发送到pushgateway固定格式</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$label</span> <span class="variable">$count_estab_connections</span>&quot;</span>  | curl --data-binary @- http://192.168.184.130:9191/metrics/job/pushgateway/instance/<span class="variable">$instance_name</span></span><br></pre></td></tr></table></figure>

<p>设置数据采集频率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#15s 采集一次</span></span><br><span class="line">*/15 * * * * sh /root/tcpestab.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos6/7 安装PHP7.3教程</title>
    <url>/sugw.github.io/2020/11/03/Centos67%20%E5%AE%89%E8%A3%85PHP7.3%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>最近的 PHP 7.3.0 已经在 2018 年12月6日 发布 GA，大家已经可以开始第一时间体验新版本了，这里先放出 PHP7.3 安装的教程以便大家升级。</p>
<h1 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h1><p>PHP 7.3 的主要更新内容：</p>
<blockquote>
<p>灵活的 Heredoc 和 Nowdoc 语法<br>从 PCRE 迁移至 PCRE2<br>Multiple MBString Improvements<br>LDAP 控件支持<br>改善 FPM 日志<br>改善 Windows 文件删除<br>弃用相关就平台</p>
</blockquote>
<p>PHP 7.3 并没有带来特别激进的更新，同一天发布更新的 WordPress 5.0 也是第一时间带来了对 PHP7.3 的支持。</p>
<p>当然了 PHP 7.3 也带了性能提升，相比早期的 PHP 7.0 有了近 22% 的性能提升。同时 PHP 5.6 和 7.0 都即将失去 PHP 社区官方的支持，所以也是建议大家能尽快的升级到最新版本。</p>
<p>421</p>
<h1 id="安装-PHP"><a href="#安装-PHP" class="headerlink" title="安装 PHP"></a>安装 PHP</h1><p><strong>教程适用系统：</strong> CentOS6 CentOS7，CentOS8 由于使用了 APPStream ，所以安装方式有变</p>
<p>Remi 软件源 主要提供最新版的 PHP 软件包和其他一些 PHP 扩展工具包，它是针对 Fedora 和 RHEL 系分支变体 （包括：RHEL, CentOS, Oracle Linux 等等） 要安装 PHP，推荐使用 Remi 软件源。Remi 对 PHP 的支持和更新都很积极，可以在第一时间获得新版本的支持。</p>
<p>由于 PHP 7.3 是新出的版本势必有不少的兼容性问题，特别是国产的程序建议等待开发者通知再进行升级，一些 PECL 扩展可能也不会及时适配最新版。<strong>建议更新前提前做好备份准备</strong>。目前已知的是 WordPress 5.0 版本开始支持 PHP 7.3。</p>
<h2 id="添加软件源"><a href="#添加软件源" class="headerlink" title="添加软件源"></a>添加软件源</h2><h3 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h3><h4 id="安装-EPEL-源："><a href="#安装-EPEL-源：" class="headerlink" title="安装 EPEL 源："></a>安装 EPEL 源：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br></pre></td></tr></table></figure>

<h4 id="安装-REMI-源："><a href="#安装-REMI-源：" class="headerlink" title="安装 REMI 源："></a>安装 REMI 源：</h4><p><strong>CentOS 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm  </span><br></pre></td></tr></table></figure>

<p><strong>CentOS 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-6.rpm</span><br></pre></td></tr></table></figure>

<h4 id="安装-Yum-源管理工具："><a href="#安装-Yum-源管理工具：" class="headerlink" title="安装 Yum 源管理工具："></a>安装 Yum 源管理工具：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure>

<h3 id="RHEL"><a href="#RHEL" class="headerlink" title="RHEL"></a>RHEL</h3><h4 id="安装-EPEL-源：-1"><a href="#安装-EPEL-源：-1" class="headerlink" title="安装 EPEL 源："></a>安装 EPEL 源：</h4><p><strong>RHEL 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br></pre></td></tr></table></figure>

<p><strong>RHEL 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm</span><br></pre></td></tr></table></figure>

<h4 id="安装-REMI-源：-1"><a href="#安装-REMI-源：-1" class="headerlink" title="安装 REMI 源："></a>安装 REMI 源：</h4><p><strong>RHEL 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br></pre></td></tr></table></figure>

<p><strong>RHEL 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-6.rpm</span><br></pre></td></tr></table></figure>

<p><strong>安装 Yum 源管理工具：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure>

<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><p><strong>安装 PHP7.3：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y <span class="variable">$phpversion</span>-php-fpm <span class="variable">$phpversion</span>-php-cli <span class="variable">$phpversion</span>-php-bcmath <span class="variable">$phpversion</span>-php-gd <span class="variable">$phpversion</span>-php-json <span class="variable">$phpversion</span>-php-mbstring <span class="variable">$phpversion</span>-php-mcrypt <span class="variable">$phpversion</span>-php-mysqlnd <span class="variable">$phpversion</span>-php-opcache <span class="variable">$phpversion</span>-php-pdo <span class="variable">$phpversion</span>-php-pecl-crypto <span class="variable">$phpversion</span>-php-pecl-mcrypt <span class="variable">$phpversion</span>-php-pecl-geoip <span class="variable">$phpversion</span>-php-recode <span class="variable">$phpversion</span>-php-snmp <span class="variable">$phpversion</span>-php-soap <span class="variable">$phpversion</span>-php-xmll</span><br></pre></td></tr></table></figure>

<h2 id="设置-PHP"><a href="#设置-PHP" class="headerlink" title="设置 PHP"></a>设置 PHP</h2><p>安装完成后，编辑 <code>/etc/php/7.3/fpm/php.ini</code> 替换换 <code>;cgi.fix_pathinfo=1</code> 为 <code>cgi.fix_pathinfo=0</code> 快捷命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/&#x27;</span> /etc/opt/remi/php73/php.ini</span><br></pre></td></tr></table></figure>

<h2 id="管理-PHP"><a href="#管理-PHP" class="headerlink" title="管理 PHP"></a>管理 PHP</h2><p>安装好了先重启一下！</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart php73-php-fpm</span><br></pre></td></tr></table></figure>

<p>设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> php73-php-fpm</span><br></pre></td></tr></table></figure>

<p><strong>更多操作：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart php73-php-fpm <span class="comment">#重启</span></span><br><span class="line">systemctl start php73-php-fpm <span class="comment">#启动</span></span><br><span class="line">systemctl stop php73-php-fpm <span class="comment">#关闭</span></span><br><span class="line">systemctl status php73-php-fpm <span class="comment">#检查状态</span></span><br></pre></td></tr></table></figure>

<h1 id="查看-PHP"><a href="#查看-PHP" class="headerlink" title="查看 PHP"></a>查看 PHP</h1><p>验证一下是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mf88.biz-service:~<span class="comment"># php73 -v</span></span><br><span class="line">PHP 7.3.0-1+(cli) (built: Dec  6 2018 20:24:55) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.3.0-dev, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.3.0-1+ubuntu18.04.1+deb.sury.org+1, Copyright (c) 1999-2018, by Zend Technologies</span><br></pre></td></tr></table></figure>

<h2 id="更新-PHP"><a href="#更新-PHP" class="headerlink" title="更新 PHP"></a>更新 PHP</h2><p>运行下面的命令系统就会更新所有可以更新的软件包括 PHP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure>

<h2 id="安装更多组件"><a href="#安装更多组件" class="headerlink" title="安装更多组件"></a>安装更多组件</h2><p>上面的一条命令安装 PHP 只是安装了部分 PHP 拓展，更多的软件可见：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@iZbp11tmwedluukz6y0d5gZ ~]<span class="comment"># yum search php73</span></span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Last metadata expiration check: 0:27:54 ago on Wed 15 May 2019 10:39:52 AM EDT.</span><br><span class="line">============================================================================================= Name Exactly Matched: php73 ==============================================================================================</span><br><span class="line">php73.x86_64 : Package that installs PHP 7.3</span><br><span class="line">php73.x86_64 : Package that installs PHP 7.3</span><br><span class="line">============================================================================================ Name &amp; Summary Matched: php73 =============================================================================================</span><br><span class="line">php73-syspaths.x86_64 : System-wide wrappers <span class="keyword">for</span> the php73 package</span><br><span class="line">php73-syspaths.x86_64 : System-wide wrappers <span class="keyword">for</span> the php73 package</span><br><span class="line">php73-scldevel.x86_64 : Package shipping development files <span class="keyword">for</span> php73</span><br><span class="line">php73-scldevel.x86_64 : Package shipping development files <span class="keyword">for</span> php73</span><br><span class="line">php73-php-zstd-devel.x86_64 : php73-php-zstd developer files (header)</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-php-pecl-psr-devel.x86_64 : php73-php-pecl-psr developer files (header)</span><br><span class="line">php73-php-pecl-psr-devel.x86_64 : php73-php-pecl-psr developer files (header)</span><br><span class="line">php73-php-pecl-raphf-devel.x86_64 : php73-php-pecl-raphf developer files (header)</span><br><span class="line">php73-php-pecl-raphf-devel.x86_64 : php73-php-pecl-raphf developer files (header)</span><br><span class="line">php73-php-pecl-propro-devel.x86_64 : php73-php-pecl-propro developer files (header)</span><br><span class="line">php73-php-pecl-yaconf-devel.x86_64 : php73-php-pecl-yaconf developer files (header)</span><br><span class="line">php73-php-pecl-propro-devel.x86_64 : php73-php-pecl-propro developer files (header)</span><br><span class="line">php73-php-pecl-yaconf-devel.x86_64 : php73-php-pecl-yaconf developer files (header)</span><br><span class="line">php73-php-pecl-xmldiff-devel.x86_64 : php73-php-pecl-xmldiff developer files (header)</span><br><span class="line">php73-php-pecl-swoole4-devel.x86_64 : php73-php-pecl-swoole4 developer files (header)</span><br><span class="line">php73-php-pecl-xmldiff-devel.x86_64 : php73-php-pecl-xmldiff developer files (header)</span><br><span class="line">php73-php-zephir-parser-devel.x86_64 : php73-php-zephir-parser developer files (headers)</span><br><span class="line">php73-php-zephir-parser-devel.x86_64 : php73-php-zephir-parser developer files (headers)</span><br><span class="line">php73-php-pecl-handlebars-devel.x86_64 : php73-php-pecl-handlebars developer files (header)</span><br><span class="line">================================================================================================= Name Matched: php73 ==================================================================================================</span><br><span class="line">php73-php.x86_64 : PHP scripting language <span class="keyword">for</span> creating dynamic web sites</span><br><span class="line">php73-php.x86_64 : PHP scripting language <span class="keyword">for</span> creating dynamic web sites</span><br><span class="line">php73-build.x86_64 : Package shipping basic build configuration</span><br><span class="line">php73-build.x86_64 : Package shipping basic build configuration</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-zephir.noarch : Zephir language <span class="keyword">for</span> creation of extensions <span class="keyword">for</span> PHP.</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-zephir.noarch : Zephir language <span class="keyword">for</span> creation of extensions <span class="keyword">for</span> PHP.</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-ast.x86_64 : Abstract Syntax Tree</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-dba.x86_64 : A database abstraction layer module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-dbg.x86_64 : The interactive PHP debugger</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-gmp.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the GNU MP library</span><br><span class="line">php73-php-lz4.x86_64 : LZ4 Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-ast.x86_64 : Abstract Syntax Tree</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-dba.x86_64 : A database abstraction layer module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-dbg.x86_64 : The interactive PHP debugger</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-gmp.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the GNU MP library</span><br><span class="line">php73-php-lz4.x86_64 : LZ4 Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-geos.x86_64 : PHP module <span class="keyword">for</span> GEOS</span><br><span class="line">php73-php-imap.x86_64 : A module <span class="keyword">for</span> PHP applications that use IMAP</span><br><span class="line">php73-php-intl.x86_64 : Internationalization extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-ldap.x86_64 : A module <span class="keyword">for</span> PHP applications that use LDAP</span><br><span class="line">php73-php-oci8.x86_64 : A module <span class="keyword">for</span> PHP applications that use OCI8 databases</span><br><span class="line">php73-php-odbc.x86_64 : A module <span class="keyword">for</span> PHP applications that use ODBC databases</span><br><span class="line">php73-php-pear.noarch : PHP Extension and Application Repository framework</span><br><span class="line">php73-php-pggi.x86_64 : GTK bindings</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-tidy.x86_64 : Standard PHP module provides tidy library support</span><br><span class="line">php73-php-zstd.x86_64 : Zstd Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-geos.x86_64 : PHP module <span class="keyword">for</span> GEOS</span><br><span class="line">php73-php-imap.x86_64 : A module <span class="keyword">for</span> PHP applications that use IMAP</span><br><span class="line">php73-php-intl.x86_64 : Internationalization extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-ldap.x86_64 : A module <span class="keyword">for</span> PHP applications that use LDAP</span><br><span class="line">php73-php-oci8.x86_64 : A module <span class="keyword">for</span> PHP applications that use OCI8 databases</span><br><span class="line">php73-php-odbc.x86_64 : A module <span class="keyword">for</span> PHP applications that use ODBC databases</span><br><span class="line">php73-php-pear.noarch : PHP Extension and Application Repository framework</span><br><span class="line">php73-php-pggi.x86_64 : GTK bindings</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-tidy.x86_64 : Standard PHP module provides tidy library support</span><br><span class="line">php73-php-twig.noarch : The flexible, fast, and secure template engine <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-zstd.x86_64 : Zstd Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-unit-php.x86_64 : PHP module <span class="keyword">for</span> NGINX Unit</span><br><span class="line">php73-php-devel.x86_64 : Files needed <span class="keyword">for</span> building PHP extensions</span><br><span class="line">php73-php-pgsql.x86_64 : A PostgreSQL database module <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pinba.x86_64 : Client extension <span class="keyword">for</span> Pinba statistics server</span><br><span class="line">php73-php-devel.x86_64 : Files needed <span class="keyword">for</span> building PHP extensions</span><br><span class="line">php73-php-pgsql.x86_64 : A PostgreSQL database module <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pinba.x86_64 : Client extension <span class="keyword">for</span> Pinba statistics server</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-brotli.x86_64 : Brotli Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pspell.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using pspell interfaces</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-snappy.x86_64 : Snappy Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-sodium.x86_64 : Wrapper <span class="keyword">for</span> the Sodium cryptographic library</span><br><span class="line">php73-php-sqlsrv.x86_64 : Microsoft Drivers <span class="keyword">for</span> PHP <span class="keyword">for</span> SQL Server</span><br><span class="line">php73-php-xmlrpc.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use the XML-RPC protocol</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-brotli.x86_64 : Brotli Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pspell.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using pspell interfaces</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-snappy.x86_64 : Snappy Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-sodium.x86_64 : Wrapper <span class="keyword">for</span> the Sodium cryptographic library</span><br><span class="line">php73-php-sqlsrv.x86_64 : Microsoft Drivers <span class="keyword">for</span> PHP <span class="keyword">for</span> SQL Server</span><br><span class="line">php73-php-xmlrpc.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use the XML-RPC protocol</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-enchant.x86_64 : Enchant spelling extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-libvirt.x86_64 : PHP language binding <span class="keyword">for</span> Libvirt</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-pecl-ds.x86_64 : Data Structures <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-pq.x86_64 : PostgreSQL client library (libpq) binding</span><br><span class="line">php73-php-pecl-uv.x86_64 : Libuv wrapper</span><br><span class="line">php73-php-process.x86_64 : Modules <span class="keyword">for</span> PHP script using system process interfaces</span><br><span class="line">php73-php-enchant.x86_64 : Enchant spelling extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-libvirt.x86_64 : PHP language binding <span class="keyword">for</span> Libvirt</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-pecl-ds.x86_64 : Data Structures <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-pq.x86_64 : PostgreSQL client library (libpq) binding</span><br><span class="line">php73-php-pecl-uv.x86_64 : Libuv wrapper</span><br><span class="line">php73-php-process.x86_64 : Modules <span class="keyword">for</span> PHP script using system process interfaces</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-embedded.x86_64 : PHP library <span class="keyword">for</span> embedding <span class="keyword">in</span> applications</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-pecl-dio.x86_64 : Direct I/O <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-eio.x86_64 : Provides interface to the libeio library</span><br><span class="line">php73-php-pecl-env.x86_64 : Load environment variables</span><br><span class="line">php73-php-pecl-lua.x86_64 : Embedded lua interpreter</span><br><span class="line">php73-php-pecl-lzf.x86_64 : Extension to handle LZF de/compression</span><br><span class="line">php73-php-pecl-nsq.x86_64 : PHP extension <span class="keyword">for</span> NSQ client</span><br><span class="line">php73-php-pecl-psr.x86_64 : PSR interfaces</span><br><span class="line">php73-php-pecl-rar.x86_64 : PHP extension <span class="keyword">for</span> reading RAR archives</span><br><span class="line">php73-php-pecl-rrd.x86_64 : PHP Bindings <span class="keyword">for</span> rrdtool</span><br><span class="line">php73-php-pecl-vld.x86_64 : Dump the internal representation of PHP scripts</span><br><span class="line">php73-php-pecl-yac.x86_64 : Lockless user data cache</span><br><span class="line">php73-php-pecl-yaf.x86_64 : Yet Another Framework</span><br><span class="line">php73-php-pecl-yar.x86_64 : Light, concurrent RPC framework</span><br><span class="line">php73-php-pecl-yaz.x86_64 : Z39.50/SRU client</span><br><span class="line">php73-php-pecl-zip.x86_64 : Une extension de gestion des ZIP</span><br><span class="line">php73-php-pecl-zmq.x86_64 : ZeroMQ messaging</span><br><span class="line">php73-php-phalcon3.x86_64 : Phalcon Framework</span><br><span class="line">php73-php-embedded.x86_64 : PHP library <span class="keyword">for</span> embedding <span class="keyword">in</span> applications</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-pecl-dio.x86_64 : Direct I/O <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-eio.x86_64 : Provides interface to the libeio library</span><br><span class="line">php73-php-pecl-env.x86_64 : Load environment variables</span><br><span class="line">php73-php-pecl-lua.x86_64 : Embedded lua interpreter</span><br><span class="line">php73-php-pecl-lzf.x86_64 : Extension to handle LZF de/compression</span><br><span class="line">php73-php-pecl-nsq.x86_64 : PHP extension <span class="keyword">for</span> NSQ client</span><br><span class="line">php73-php-pecl-psr.x86_64 : PSR interfaces</span><br><span class="line">php73-php-pecl-rar.x86_64 : PHP extension <span class="keyword">for</span> reading RAR archives</span><br><span class="line">php73-php-pecl-rrd.x86_64 : PHP Bindings <span class="keyword">for</span> rrdtool</span><br><span class="line">php73-php-pecl-vld.x86_64 : Dump the internal representation of PHP scripts</span><br><span class="line">php73-php-pecl-yac.x86_64 : Lockless user data cache</span><br><span class="line">php73-php-pecl-yaf.x86_64 : Yet Another Framework</span><br><span class="line">php73-php-pecl-yar.x86_64 : Light, concurrent RPC framework</span><br><span class="line">php73-php-pecl-yaz.x86_64 : Z39.50/SRU client</span><br><span class="line">php73-php-pecl-zip.x86_64 : Une extension de gestion des ZIP</span><br><span class="line">php73-php-pecl-zmq.x86_64 : ZeroMQ messaging</span><br><span class="line">php73-php-phalcon3.x86_64 : Phalcon Framework</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-componere.x86_64 : Composing PHP classes at runtime</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-maxminddb.x86_64 : MaxMind DB Reader extension</span><br><span class="line">php73-php-pdo-dblib.x86_64 : PDO driver Microsoft SQL Server and Sybase databases</span><br><span class="line">php73-php-pecl-amqp.x86_64 : Communicate with any AMQP compliant server</span><br><span class="line">php73-php-pecl-apcu.x86_64 : APC User Cache</span><br><span class="line">php73-php-pecl-apfd.x86_64 : Always Populate Form Data</span><br><span class="line">php73-php-pecl-fann.x86_64 : Wrapper <span class="keyword">for</span> FANN Library</span><br><span class="line">php73-php-pecl-grpc.x86_64 : General RPC framework</span><br><span class="line">php73-php-pecl-http.x86_64 : Extended HTTP support</span><br><span class="line">php73-php-pecl-krb5.x86_64 : Kerberos authentification extension</span><br><span class="line">php73-php-pecl-pcov.x86_64 : Code coverage driver</span><br><span class="line">php73-php-pecl-ssh2.x86_64 : Bindings <span class="keyword">for</span> the libssh2 library</span><br><span class="line">php73-php-pecl-sync.x86_64 : Named and unnamed synchronization objects</span><br><span class="line">php73-php-pecl-uopz.x86_64 : User Operations <span class="keyword">for</span> Zend</span><br><span class="line">php73-php-pecl-uuid.x86_64 : Universally Unique Identifier extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-vips.x86_64 : PHP extension <span class="keyword">for</span> interfacing with libvips</span><br><span class="line">php73-php-pecl-yaml.x86_64 : PHP Bindings <span class="keyword">for</span> yaml</span><br><span class="line">php73-php-phpiredis.x86_64 : Client extension <span class="keyword">for</span> Redis</span><br><span class="line">php73-php-smbclient.x86_64 : PHP wrapper <span class="keyword">for</span> libsmbclient</span><br><span class="line">php73-php-wkhtmltox.x86_64 : HTML Converter</span><br><span class="line">php73-php-componere.x86_64 : Composing PHP classes at runtime</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-maxminddb.x86_64 : MaxMind DB Reader extension</span><br><span class="line">php73-php-pdo-dblib.x86_64 : PDO driver Microsoft SQL Server and Sybase databases</span><br><span class="line">php73-php-pecl-amqp.x86_64 : Communicate with any AMQP compliant server</span><br><span class="line">php73-php-pecl-apcu.x86_64 : APC User Cache</span><br><span class="line">php73-php-pecl-apfd.x86_64 : Always Populate Form Data</span><br><span class="line">php73-php-pecl-fann.x86_64 : Wrapper <span class="keyword">for</span> FANN Library</span><br><span class="line">php73-php-pecl-grpc.x86_64 : General RPC framework</span><br><span class="line">php73-php-pecl-http.x86_64 : Extended HTTP support</span><br><span class="line">php73-php-pecl-krb5.x86_64 : Kerberos authentification extension</span><br><span class="line">php73-php-pecl-pcov.x86_64 : Code coverage driver</span><br><span class="line">php73-php-pecl-ssh2.x86_64 : Bindings <span class="keyword">for</span> the libssh2 library</span><br><span class="line">php73-php-pecl-sync.x86_64 : Named and unnamed synchronization objects</span><br><span class="line">php73-php-pecl-uopz.x86_64 : User Operations <span class="keyword">for</span> Zend</span><br><span class="line">php73-php-pecl-uuid.x86_64 : Universally Unique Identifier extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-vips.x86_64 : PHP extension <span class="keyword">for</span> interfacing with libvips</span><br><span class="line">php73-php-pecl-yaml.x86_64 : PHP Bindings <span class="keyword">for</span> yaml</span><br><span class="line">php73-php-phpiredis.x86_64 : Client extension <span class="keyword">for</span> Redis</span><br><span class="line">php73-php-smbclient.x86_64 : PHP wrapper <span class="keyword">for</span> libsmbclient</span><br><span class="line">php73-php-wkhtmltox.x86_64 : HTML Converter</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-cmark.x86_64 : CommonMark extension</span><br><span class="line">php73-php-pecl-dbase.x86_64 : dBase database file access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-druid.x86_64 : A Druid driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-event.x86_64 : Provides interface to libevent library</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-gnupg.x86_64 : Wrapper around the gpgme library</span><br><span class="line">php73-php-pecl-mysql.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-oauth.x86_64 : PHP OAuth consumer extension</span><br><span class="line">php73-php-pecl-parle.x86_64 : Parsing and lexing</span><br><span class="line">php73-php-pecl-raphf.x86_64 : Resource and persistent handles factory</span><br><span class="line">php73-php-pecl-solr2.x86_64 : API orientée objet pour Apache Solr</span><br><span class="line">php73-php-pecl-stats.x86_64 : Routines <span class="keyword">for</span> statistical computation</span><br><span class="line">php73-php-pecl-stomp.x86_64 : Stomp client extension</span><br><span class="line">php73-php-pecl-taint.x86_64 : XSS code sniffer</span><br><span class="line">php73-php-pecl-trace.x86_64 : Trace is a low-overhead tracing tool <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xattr.x86_64 : Extended attributes</span><br><span class="line">php73-php-pecl-xdiff.x86_64 : File differences/patches</span><br><span class="line">php73-php-pecl-xxtea.x86_64 : XXTEA encryption algorithm extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-cmark.x86_64 : CommonMark extension</span><br><span class="line">php73-php-pecl-dbase.x86_64 : dBase database file access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-druid.x86_64 : A Druid driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-event.x86_64 : Provides interface to libevent library</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-gnupg.x86_64 : Wrapper around the gpgme library</span><br><span class="line">php73-php-pecl-mysql.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-oauth.x86_64 : PHP OAuth consumer extension</span><br><span class="line">php73-php-pecl-parle.x86_64 : Parsing and lexing</span><br><span class="line">php73-php-pecl-raphf.x86_64 : Resource and persistent handles factory</span><br><span class="line">php73-php-pecl-solr2.x86_64 : API orientée objet pour Apache Solr</span><br><span class="line">php73-php-pecl-stats.x86_64 : Routines <span class="keyword">for</span> statistical computation</span><br><span class="line">php73-php-pecl-stomp.x86_64 : Stomp client extension</span><br><span class="line">php73-php-pecl-taint.x86_64 : XSS code sniffer</span><br><span class="line">php73-php-pecl-trace.x86_64 : Trace is a low-overhead tracing tool <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xattr.x86_64 : Extended attributes</span><br><span class="line">php73-php-pecl-xdiff.x86_64 : File differences/patches</span><br><span class="line">php73-php-pecl-xxtea.x86_64 : XXTEA encryption algorithm extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-libvirt-doc.noarch : Document of php-libvirt</span><br><span class="line">php73-php-pecl-base58.x86_64 : Encode and decode data with base58</span><br><span class="line">php73-php-pecl-bitset.x86_64 : BITSET library</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-gender.x86_64 : Gender Extension</span><br><span class="line">php73-php-pecl-hprose.x86_64 : Hprose <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hrtime.x86_64 : High resolution timing</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-pecl-molten.x86_64 : Extension <span class="keyword">for</span> application tracing</span><br><span class="line">php73-php-pecl-pdflib.x86_64 : Package <span class="keyword">for</span> generating PDF files</span><br><span class="line">php73-php-pecl-propro.x86_64 : Property proxy</span><br><span class="line">php73-php-pecl-radius.x86_64 : Radius client library</span><br><span class="line">php73-php-pecl-redis4.x86_64 : Extension <span class="keyword">for</span> communicating with the Redis key-value store</span><br><span class="line">php73-php-pecl-scrypt.x86_64 : Scrypt hashing <span class="keyword">function</span></span><br><span class="line">php73-php-pecl-sphinx.x86_64 : PECL extension <span class="keyword">for</span> Sphinx SQL full-text search engine</span><br><span class="line">php73-php-pecl-ssdeep.x86_64 : Wrapper <span class="keyword">for</span> libfuzzy library</span><br><span class="line">php73-php-pecl-trader.x86_64 : Technical Analysis <span class="keyword">for</span> traders</span><br><span class="line">php73-php-pecl-xdebug.x86_64 : PECL package <span class="keyword">for</span> debugging PHP scripts</span><br><span class="line">php73-php-pecl-yaconf.x86_64 : Yet Another Configurations Container</span><br><span class="line">php73-php-libvirt-doc.noarch : Document of php-libvirt</span><br><span class="line">php73-php-pecl-base58.x86_64 : Encode and decode data with base58</span><br><span class="line">php73-php-pecl-bitset.x86_64 : BITSET library</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-gender.x86_64 : Gender Extension</span><br><span class="line">php73-php-pecl-hprose.x86_64 : Hprose <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hrtime.x86_64 : High resolution timing</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-pecl-molten.x86_64 : Extension <span class="keyword">for</span> application tracing</span><br><span class="line">php73-php-pecl-pdflib.x86_64 : Package <span class="keyword">for</span> generating PDF files</span><br><span class="line">php73-php-pecl-propro.x86_64 : Property proxy</span><br><span class="line">php73-php-pecl-radius.x86_64 : Radius client library</span><br><span class="line">php73-php-pecl-redis4.x86_64 : Extension <span class="keyword">for</span> communicating with the Redis key-value store</span><br><span class="line">php73-php-pecl-scrypt.x86_64 : Scrypt hashing <span class="keyword">function</span></span><br><span class="line">php73-php-pecl-sphinx.x86_64 : PECL extension <span class="keyword">for</span> Sphinx SQL full-text search engine</span><br><span class="line">php73-php-pecl-ssdeep.x86_64 : Wrapper <span class="keyword">for</span> libfuzzy library</span><br><span class="line">php73-php-pecl-trader.x86_64 : Technical Analysis <span class="keyword">for</span> traders</span><br><span class="line">php73-php-pecl-xdebug.x86_64 : PECL package <span class="keyword">for</span> debugging PHP scripts</span><br><span class="line">php73-php-pecl-yaconf.x86_64 : Yet Another Configurations Container</span><br><span class="line">php73-php-pecl-apcu-bc.x86_64 : APCu Backwards Compatibility Module</span><br><span class="line">php73-php-pecl-decimal.x86_64 : Arbitrary-precision floating-point decimal</span><br><span class="line">php73-php-pecl-gearman.x86_64 : PHP wrapper to libgearman</span><br><span class="line">php73-php-pecl-gmagick.x86_64 : Provides a wrapper to the GraphicsMagick library</span><br><span class="line">php73-php-pecl-imagick.x86_64 : Extension to create and modify images using ImageMagick</span><br><span class="line">php73-php-pecl-inotify.x86_64 : Inotify</span><br><span class="line">php73-php-pecl-leveldb.x86_64 : LevelDB PHP bindings</span><br><span class="line">php73-php-pecl-memprof.x86_64 : Memory usage profiler</span><br><span class="line">php73-php-pecl-mongodb.x86_64 : MongoDB driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-msgpack.x86_64 : API <span class="keyword">for</span> communicating with MessagePack serialization</span><br><span class="line">php73-php-pecl-rdkafka.x86_64 : Kafka client based on librdkafka</span><br><span class="line">php73-php-pecl-request.x86_64 : Server-side request and response objects</span><br><span class="line">php73-php-pecl-rpminfo.x86_64 : RPM information</span><br><span class="line">php73-php-pecl-runkit7.x86_64 : For all those things you... shouldn<span class="string">&#x27;t have been doing anyway... but surely do!</span></span><br><span class="line"><span class="string">php73-php-pecl-seaslog.x86_64 : An effective, fast, stable log extension for PHP</span></span><br><span class="line"><span class="string">php73-php-pecl-selinux.x86_64 : SELinux binding for PHP scripting language</span></span><br><span class="line"><span class="string">php73-php-pecl-swoole4.x86_64 : PHP&#x27;</span>s asynchronous concurrent distributed networking framework</span><br><span class="line">php73-php-pecl-timecop.x86_64 : Time travel and freezing extension</span><br><span class="line">php73-php-pecl-varnish.x86_64 : Varnish Cache bindings</span><br><span class="line">php73-php-pecl-xmldiff.x86_64 : XML diff and merge</span><br><span class="line">php73-php-pecl-apcu-bc.x86_64 : APCu Backwards Compatibility Module</span><br><span class="line">php73-php-pecl-decimal.x86_64 : Arbitrary-precision floating-point decimal</span><br><span class="line">php73-php-pecl-gearman.x86_64 : PHP wrapper to libgearman</span><br><span class="line">php73-php-pecl-gmagick.x86_64 : Provides a wrapper to the GraphicsMagick library</span><br><span class="line">php73-php-pecl-imagick.x86_64 : Extension to create and modify images using ImageMagick</span><br><span class="line">php73-php-pecl-inotify.x86_64 : Inotify</span><br><span class="line">php73-php-pecl-leveldb.x86_64 : LevelDB PHP bindings</span><br><span class="line">php73-php-pecl-memprof.x86_64 : Memory usage profiler</span><br><span class="line">php73-php-pecl-mongodb.x86_64 : MongoDB driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-msgpack.x86_64 : API <span class="keyword">for</span> communicating with MessagePack serialization</span><br><span class="line">php73-php-pecl-rdkafka.x86_64 : Kafka client based on librdkafka</span><br><span class="line">php73-php-pecl-request.x86_64 : Server-side request and response objects</span><br><span class="line">php73-php-pecl-rpminfo.x86_64 : RPM information</span><br><span class="line">php73-php-pecl-runkit7.x86_64 : For all those things you... shouldn<span class="string">&#x27;t have been doing anyway... but surely do!</span></span><br><span class="line"><span class="string">php73-php-pecl-seaslog.x86_64 : An effective, fast, stable log extension for PHP</span></span><br><span class="line"><span class="string">php73-php-pecl-selinux.x86_64 : SELinux binding for PHP scripting language</span></span><br><span class="line"><span class="string">php73-php-pecl-swoole4.x86_64 : PHP&#x27;</span>s asynchronous concurrent distributed networking framework</span><br><span class="line">php73-php-pecl-timecop.x86_64 : Time travel and freezing extension</span><br><span class="line">php73-php-pecl-varnish.x86_64 : Varnish Cache bindings</span><br><span class="line">php73-php-pecl-xmldiff.x86_64 : XML diff and merge</span><br><span class="line">php73-php-pecl-igbinary.x86_64 : Replacement <span class="keyword">for</span> the standard PHP serializer</span><br><span class="line">php73-php-pecl-memcache.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mogilefs.x86_64 : PHP client library to communicate with the MogileFS storage</span><br><span class="line">php73-php-pecl-mustache.x86_64 : Mustache templating language</span><br><span class="line">php73-php-pecl-protobuf.x86_64 : Mechanism <span class="keyword">for</span> serializing structured data</span><br><span class="line">php73-php-snuffleupagus.x86_64 : Security module <span class="keyword">for</span> php7</span><br><span class="line">php73-php-zephir-parser.x86_64 : Zephir parser extension</span><br><span class="line">php73-php-channel-horde.noarch : Adds pear.horde.org channel to PEAR</span><br><span class="line">php73-php-pecl-igbinary.x86_64 : Replacement <span class="keyword">for</span> the standard PHP serializer</span><br><span class="line">php73-php-pecl-memcache.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mogilefs.x86_64 : PHP client library to communicate with the MogileFS storage</span><br><span class="line">php73-php-pecl-mustache.x86_64 : Mustache templating language</span><br><span class="line">php73-php-pecl-protobuf.x86_64 : Mechanism <span class="keyword">for</span> serializing structured data</span><br><span class="line">php73-php-pecl-translit.x86_64 : Transliterates non-latin character sets to latin</span><br><span class="line">php73-php-snuffleupagus.x86_64 : Security module <span class="keyword">for</span> php7</span><br><span class="line">php73-php-zephir-parser.x86_64 : Zephir parser extension</span><br><span class="line">php73-php-ioncube-loader.x86_64 : Loader <span class="keyword">for</span> ionCube Encoded Files with ionCube 24 support</span><br><span class="line">php73-php-pecl-cassandra.x86_64 : DataStax PHP Driver <span class="keyword">for</span> Apache Cassandra</span><br><span class="line">php73-php-pecl-json-post.x86_64 : JSON POST handler</span><br><span class="line">php73-php-pecl-mailparse.x86_64 : PHP PECL package <span class="keyword">for</span> parsing and working with email messages</span><br><span class="line">php73-php-pecl-memcached.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mosquitto.x86_64 : Extension <span class="keyword">for</span> libmosquitto</span><br><span class="line">php73-php-pecl-seasclick.x86_64 : An Yandex ClickHouse client driven extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xlswriter.x86_64 : An efficient and fast xlsx file <span class="built_in">export</span> extension</span><br><span class="line">php73-php-ioncube-loader.x86_64 : Loader <span class="keyword">for</span> ionCube Encoded Files with ionCube 24 support</span><br><span class="line">php73-php-pecl-cassandra.x86_64 : DataStax PHP Driver <span class="keyword">for</span> Apache Cassandra</span><br><span class="line">php73-php-pecl-json-post.x86_64 : JSON POST handler</span><br><span class="line">php73-php-pecl-mailparse.x86_64 : PHP PECL package <span class="keyword">for</span> parsing and working with email messages</span><br><span class="line">php73-php-pecl-memcached.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mosquitto.x86_64 : Extension <span class="keyword">for</span> libmosquitto</span><br><span class="line">php73-php-pecl-seasclick.x86_64 : An Yandex ClickHouse client driven extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xlswriter.x86_64 : An efficient and fast xlsx file <span class="built_in">export</span> extension</span><br><span class="line">php73-php-horde-horde-lz4.x86_64 : Horde LZ4 Compression Extension</span><br><span class="line">php73-php-pecl-apcu-devel.x86_64 : APCu developer files (header)</span><br><span class="line">php73-php-pecl-couchbase2.x86_64 : Couchbase Server PHP extension</span><br><span class="line">php73-php-pecl-geospatial.x86_64 : PHP Extension to handle common geospatial <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-handlebars.x86_64 : Handlebars templating language</span><br><span class="line">php73-php-pecl-http-devel.x86_64 : Extended HTTP support developer files (header)</span><br><span class="line">php73-php-pecl-krb5-devel.x86_64 : Kerberos extension developer files (header)</span><br><span class="line">php73-php-pecl-luasandbox.x86_64 : Lua interpreter with limits and safe environment</span><br><span class="line">php73-php-pecl-opencensus.x86_64 : A stats collection and distributed tracing framework</span><br><span class="line">php73-php-horde-horde-lz4.x86_64 : Horde LZ4 Compression Extension</span><br><span class="line">php73-php-pecl-apcu-devel.x86_64 : APCu developer files (header)</span><br><span class="line">php73-php-pecl-couchbase2.x86_64 : Couchbase Server PHP extension</span><br><span class="line">php73-php-pecl-geospatial.x86_64 : PHP Extension to handle common geospatial <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-handlebars.x86_64 : Handlebars templating language</span><br><span class="line">php73-php-pecl-http-devel.x86_64 : Extended HTTP support developer files (header)</span><br><span class="line">php73-php-pecl-krb5-devel.x86_64 : Kerberos extension developer files (header)</span><br><span class="line">php73-php-pecl-luasandbox.x86_64 : Lua interpreter with limits and safe environment</span><br><span class="line">php73-php-pecl-opencensus.x86_64 : A stats collection and distributed tracing framework</span><br><span class="line">php73-php-pecl-ahocorasick.x86_64 : Effective Aho-Corasick string pattern matching algorithm</span><br><span class="line">php73-php-pecl-ip2location.x86_64 : Get geo location information of an IP address</span><br><span class="line">php73-php-pecl-ahocorasick.x86_64 : Effective Aho-Corasick string pattern matching algorithm</span><br><span class="line">php73-php-pecl-ip2location.x86_64 : Get geo location information of an IP address</span><br><span class="line">php73-php-pecl-datadog-trace.x86_64 : APM and distributed tracing <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hdr-histogram.x86_64 : PHP extension wrapper <span class="keyword">for</span> the C hdrhistogram API</span><br><span class="line">php73-php-pecl-imagick-devel.x86_64 : imagick extension developer files (header)</span><br><span class="line">php73-php-pecl-msgpack-devel.x86_64 : MessagePack developer files (header)</span><br><span class="line">php73-php-pecl-mysql-xdevapi.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-datadog-trace.x86_64 : APM and distributed tracing <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hdr-histogram.x86_64 : PHP extension wrapper <span class="keyword">for</span> the C hdrhistogram API</span><br><span class="line">php73-php-pecl-imagick-devel.x86_64 : imagick extension developer files (header)</span><br><span class="line">php73-php-pecl-msgpack-devel.x86_64 : MessagePack developer files (header)</span><br><span class="line">php73-php-pecl-mysql-xdevapi.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-igbinary-devel.x86_64 : Igbinary developer files (header)</span><br><span class="line">php73-php-pecl-uploadprogress.x86_64 : An extension to track progress of a file upload</span><br><span class="line">php73-php-pecl-igbinary-devel.x86_64 : Igbinary developer files (header)</span><br><span class="line">php73-php-pecl-uploadprogress.x86_64 : An extension to track progress of a file upload</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(四)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/</url>
    <content><![CDATA[<p><strong>Jenkins应用</strong></p>
<p>Jenkins Linux Shell集成</p>
<p>登录Jenkins web管理页，点击新建任务</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151723046-524146976-20201127095232069.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151824593-1161146941-20201127095231859.png" class title="img">



<p>添加构建执行shell</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151858012-1214119596-20201127095231676.png" class title="img">

<p>在执行shell输入框内输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">user&#x3D;&#96;whoami&#96;</span><br><span class="line"></span><br><span class="line">if [ $user &#x3D;&#x3D; &#39;deploy&#39; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Hello, my name is $user&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Sorry, I am not $user&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ip addr</span><br><span class="line"></span><br><span class="line">cat &#x2F;etc&#x2F;system-release</span><br><span class="line"></span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line">py_cmd&#x3D;&#96;which python&#96;</span><br><span class="line"></span><br><span class="line">$py_cmd --version</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109152040887-2048586029-20201127095232008.png" class title="img">

<p> 点击查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;shell-freestyle-job</span><br><span class="line">[shell-freestyle-job] $ &#x2F;bin&#x2F;sh &#x2F;tmp&#x2F;jenkins3318863497197478868.sh</span><br><span class="line">Hello, my name is deploy</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1&#x2F;128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:23:04:a4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.244.131&#x2F;24 brd 192.168.244.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6c1f:4afc:8c42:2ef7&#x2F;64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:23:04:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:d5:9c:dd brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1&#x2F;24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:d5:9c:dd brd ff:ff:ff:ff:ff:ff</span><br><span class="line">CentOS Linux release 7.5.1804 (Core) </span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           1982        1032         377          10         571         707</span><br><span class="line">Swap:          2047           0        2047</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root   18G  4.6G   13G  26% &#x2F;</span><br><span class="line">devtmpfs                 975M     0  975M   0% &#x2F;dev</span><br><span class="line">tmpfs                    992M     0  992M   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                    992M   11M  982M   2% &#x2F;run</span><br><span class="line">tmpfs                    992M     0  992M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sr0                 8.8G  8.8G     0 100% &#x2F;media&#x2F;cdrom</span><br><span class="line">&#x2F;dev&#x2F;sda1                497M  150M  347M  31% &#x2F;boot</span><br><span class="line">tmpfs                    199M   12K  199M   1% &#x2F;run&#x2F;user&#x2F;42</span><br><span class="line">tmpfs                    199M     0  199M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">Python 2.7.5</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins 参数集成</p>
<p>仍然登录到Jenkins web管理页，点击新建任务。</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109153842155-2075650169-20201127095231946.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109154042627-129308152-20201127095231940.png" class title="img">



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">echo &quot;Current deploy environment is $deploy_env&quot;</span><br><span class="line">echo &quot;The build is $version&quot;</span><br><span class="line">echo &quot;The paasword is $pass&quot;</span><br><span class="line"></span><br><span class="line">if $bool</span><br><span class="line">then</span><br><span class="line">    echo &quot;Request is approved&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Request is rejected&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>点击“Build with Parameters”后如下图所示</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109155131087-890865953-20201127095232222.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109155404456-420065666-20201127095232301.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;parameter-freestyle-job</span><br><span class="line">[parameter-freestyle-job] $ &#x2F;bin&#x2F;sh &#x2F;tmp&#x2F;jenkins459467524349987986.sh</span><br><span class="line">Current deploy environment is dev</span><br><span class="line">The build is 1.0.1</span><br><span class="line">The paasword is 123456</span><br><span class="line">Request is approved</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins Git集成</p>
<p>首先还是登录Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109163623111-1109999465-20201127095232289.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109163915438-500405355-20201127095232386.png" class title="img">

<p>返回到gitlab新建一个ansible-playbook.repo工程（新建过程略），只有一个ansible-playbook.txt空文件</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164541615-708856621-20201127095232478.png" class title="img">

<p>复制ansible-playbook.repo仓库地址，粘贴至下图</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164637907-1104298296-20201127095232461.png" class title="img">

<p>点击“立即构建”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164720097-767872863-20201127095232519.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;git-freestyle-job</span><br><span class="line">Cloning the remote Git repository</span><br><span class="line">Cloning repository https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line"> &gt; git init &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;git-freestyle-job # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line"> &gt; git --version # timeout&#x3D;10</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git # timeout&#x3D;10</span><br><span class="line"> &gt; git config --add remote.origin.fetch +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;* # timeout&#x3D;10</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line">Checking out Revision eb4736cb66dd954b1f45b1d38f789c84aaedb078 (refs&#x2F;remotes&#x2F;origin&#x2F;master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -f eb4736cb66dd954b1f45b1d38f789c84aaedb078</span><br><span class="line">Commit message: &quot;First comm&quot;</span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins maven集成</p>
<p>打开maven官网：<a href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p>
<p>复制最新maven的软件包链接</p>
<p><a href="http://mirrors.shu.edu.cn/apache/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz">http://mirrors.shu.edu.cn/apache/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz</a></p>
<p>安装maven</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# wget http:&#x2F;&#x2F;mirrors.shu.edu.cn&#x2F;apache&#x2F;maven&#x2F;maven-3&#x2F;3.6.0&#x2F;binaries&#x2F;apache-maven-3.6.0-bin.tar.gz</span><br><span class="line">[root@jenkins ~]# tar -xf apache-maven-3.6.0-bin.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line">[root@jenkins ~]# ls &#x2F;opt&#x2F;</span><br><span class="line">apache-maven-3.6.0  rh</span><br><span class="line">[root@jenkins ~]# cd &#x2F;opt&#x2F;apache-maven-3.6.0&#x2F;bin&#x2F;</span><br><span class="line">[root@jenkins bin]# .&#x2F;mvn --version</span><br><span class="line">Apache Maven 3.6.0 (97c98ec64a1fdfee7767ce5ffb20918da4f719f3; 2018-10-25T02:41:47+08:00)</span><br><span class="line">Maven home: &#x2F;opt&#x2F;apache-maven-3.6.0</span><br><span class="line">Java version: 1.8.0_191, vendor: Oracle Corporation, runtime: &#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.8.0-openjdk-1.8.0.191.b12-1.el7_6.x86_64&#x2F;jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-862.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure>

<p>回到Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109165658126-635979322-20201127095232612.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109165741713-178101175-20201127095232561.png" class title="img">

<p>回到gitlab主页</p>
<p> 新建一个空的Java-war-dev工程，复制其仓库地址；</p>
<p>然后切到windows git bash命令行，上传本地代码到刚才新建的Java-war-dev仓库中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls</span><br><span class="line">Java-war-dev&#x2F;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ git config --global user.name &quot;root&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ git config --global user.email &quot;root@example.com&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ git init</span><br><span class="line">Initialized empty Git repository in C:&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo&#x2F;.git&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo (master)</span><br><span class="line">$ git remote add origin https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in Java-war-dev&#x2F;pom.xml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in Java-war-dev&#x2F;src&#x2F;main&#x2F;webapp&#x2F;WEB-INF&#x2F;web.xml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in Java-war-dev&#x2F;src&#x2F;main&#x2F;webapp&#x2F;index.jsp.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo (master)</span><br><span class="line">$ git commit -m&quot;first commit&quot;</span><br><span class="line">[master (root-commit) aa3c70c] first commit</span><br><span class="line"> 7 files changed, 58 insertions(+)</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;.DS_Store</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;pom.xml</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;src&#x2F;.DS_Store</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;src&#x2F;main&#x2F;.DS_Store</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;src&#x2F;main&#x2F;webapp&#x2F;.DS_Store</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;src&#x2F;main&#x2F;webapp&#x2F;WEB-INF&#x2F;web.xml</span><br><span class="line"> create mode 100644 Java-war-dev&#x2F;src&#x2F;main&#x2F;webapp&#x2F;index.jsp</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push origin master</span><br><span class="line">Enumerating objects: 14, done.</span><br><span class="line">Counting objects: 100% (14&#x2F;14), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (12&#x2F;12), done.</span><br><span class="line">Writing objects: 100% (14&#x2F;14), 2.13 KiB | 726.00 KiB&#x2F;s, done.</span><br><span class="line">Total 14 (delta 3), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>查看gitlab上已经上传成功，复制Java-war-dev仓库地址；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192205777-396732044-20201127095232627.png" class title="img">



<p>再次回到Jenkins刚才创建的maven-freestyle-job中，将复制的仓库地址粘贴过来；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192057780-559306233-20201127095232785.png" class title="img">

<p> 接着添加构建步骤</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171745487-1863116514-20201127095232814.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171833932-2138348804-20201127095232881.png" class title="img">

<p>返回到Jenkins系统管理设置jdk和maven路径</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171954411-440162308-20201127095232795.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109172647579-2007679914-20201127095232898.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109172823526-350650902-20201127095232986.png" class title="img">

<p>点击“Apply”,最后点击“Save”</p>
<p>回到Jenkins mavent-freestyle-job配置页；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109173140430-1450915196-20201127095233046.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192337953-1505758240-20201127095233087.png" class title="img">

<p>试了好多次，中间错误过程及错误信息在本文结尾列出，针对我的环境，我猜测的是路径错误导致的，因为重新设置了路径之后，第16次构建，也就是上述构建成功的截图就是我重新建了一个Java-war-dev工程，直接在工程下面就是src目录，之前的错误因为我的目录结构是Java-war-dev工程下还有一个Java-war-dev文件夹，导致一直报错，在晚上转了一大圈，也没解决，最后我尝试新建了一个工程，重新配置了一下，构建成功！</p>
<p>查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job</span><br><span class="line"> &gt; git rev-parse --is-inside-work-tree # timeout&#x3D;10</span><br><span class="line">Fetching changes from the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;Java-war-dev.git # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;Java-war-dev.git</span><br><span class="line"> &gt; git --version # timeout&#x3D;10</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;Java-war-dev.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line">Checking out Revision 87d659a9d8706b67e70a89fe7c9d5359d8fd72f5 (refs&#x2F;remotes&#x2F;origin&#x2F;master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -f 87d659a9d8706b67e70a89fe7c9d5359d8fd72f5</span><br><span class="line">Commit message: &quot;master-1.0.0&quot;</span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line">[maven-freestyle-job] $ &#x2F;opt&#x2F;apache-maven-3.6.0&#x2F;bin&#x2F;mvn package</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] -------------------&lt; com.jenkins.demo:Java-war-dev &gt;--------------------</span><br><span class="line">[INFO] Building Java-war-dev Maven Webapp 1.0.15-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ war ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ Java-war-dev ---</span><br><span class="line">[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] skip non existing resourceDirectory &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;src&#x2F;main&#x2F;resources</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ Java-war-dev ---</span><br><span class="line">[INFO] No sources to compile</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ Java-war-dev ---</span><br><span class="line">[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] skip non existing resourceDirectory &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;src&#x2F;test&#x2F;resources</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ Java-war-dev ---</span><br><span class="line">[INFO] No sources to compile</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-surefire-plugin:2.12.4:test (default-test) @ Java-war-dev ---</span><br><span class="line">[INFO] No tests to run.</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-war-plugin:2.2:war (default-war) @ Java-war-dev ---</span><br><span class="line">[INFO] Packaging webapp</span><br><span class="line">[INFO] Assembling webapp [Java-war-dev] in [&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;target&#x2F;Java-war-dev]</span><br><span class="line">[INFO] Processing war project</span><br><span class="line">[INFO] Copying webapp resources [&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;src&#x2F;main&#x2F;webapp]</span><br><span class="line">[INFO] Webapp assembled in [21 msecs]</span><br><span class="line">[INFO] Building war: &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;target&#x2F;Java-war-dev.war</span><br><span class="line">[INFO] WEB-INF&#x2F;web.xml already added, skipping</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  1.341 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T19:22:35+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p><strong>Jenkins Ansible集成演示</strong></p>
<p>需要同anible主机上的配置ansible2.5+python 3.6虚拟环境一致，</p>
<p>配置Ansible2.5+python3.6</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins Python-3.6.8]# yum install -y openssl* gcc zlib*</span><br><span class="line">[root@jenkins ~]# wget https:&#x2F;&#x2F;www.python.org&#x2F;ftp&#x2F;python&#x2F;3.6.8&#x2F;Python-3.6.8.tar.xz</span><br><span class="line">[root@jenkins ~]# tar -xf Python-3.6.8.tar.xz -C &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">[root@jenkins ~]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;Python-3.6.8&#x2F;</span><br><span class="line">[root@jenkins Python-3.6.8]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F; --with-ensurepip&#x3D;install --enable-shared LDFLAGS&#x3D;&quot;-Wl,-rpath &#x2F;usr&#x2F;local&#x2F;lib&quot;</span><br><span class="line">[root@jenkins Python-3.6.8]# make &amp;&amp; echo $? &amp;&amp; sleep 3 &amp;&amp; make altinstall &amp;&amp; echo $?</span><br><span class="line">[root@jenkins Python-3.6.8]# whereis pip3.6</span><br><span class="line">pip3: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip3.6</span><br><span class="line">[root@jenkins Python-3.6.8]# whereis pip</span><br><span class="line">pip: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip3.6</span><br><span class="line">[root@jenkins Python-3.6.8]# ln -s &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip3.6 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip</span><br><span class="line">[root@jenkins ~]# pip install virtualenv</span><br><span class="line">[root@jenkins ~]# su - deploy</span><br><span class="line">[deploy@jenkins ~]$ virtualenv -p &#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3.6 .py3-a2.5-env</span><br><span class="line">Already using interpreter &#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3.6</span><br><span class="line">Using base prefix &#39;&#x2F;usr&#x2F;local&#39;</span><br><span class="line">New python executable in &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;python3.6</span><br><span class="line">Also creating executable in &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line">done.</span><br><span class="line">[deploy@jenkins ~]$ cd &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;</span><br><span class="line">[deploy@jenkins .py3-a2.5-env]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins .py3-a2.5-env]$ pip install paramiko PyYAML jinja2</span><br><span class="line"> (.py3-a2.5-env) [deploy@jenkins .py3-a2.5-env]$git clone https:&#x2F;&#x2F;github.com&#x2F;ansible&#x2F;ansible.git</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins .py3-a2.5-env]$ cd ansible&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ansible]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ansible]$ git checkout stable-2.5</span><br><span class="line">Branch stable-2.5 set up to track remote branch stable-2.5 from origin.</span><br><span class="line">Switched to a new branch &#39;stable-2.5&#39;</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ansible]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ansible]$ ansible --version</span><br><span class="line">ansible 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br></pre></td></tr></table></figure>

<p>配置jenkins.example.com主机到test.example.com主机的ssh免秘钥认证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ssh-keygen</span><br><span class="line">Generating public&#x2F;private rsa key pair.</span><br><span class="line">Enter file in which to save the key (&#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa):</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in &#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.</span><br><span class="line">Your public key has been saved in &#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:cXo&#x2F;fOrw7FhywXZvsRmHUBkMPvuY2C3wdMIFTgeaZ1Q deploy@jenkins.example.com</span><br><span class="line">The key&#39;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|            *&#x3D;Eo |</span><br><span class="line">|           B +o  |</span><br><span class="line">|        . + B .  |</span><br><span class="line">|         + &#x3D; &#x3D; . |</span><br><span class="line">|        S o O +o.|</span><br><span class="line">|         . X X .*|</span><br><span class="line">|          + % +oo|</span><br><span class="line">|           O &#x3D; . |</span><br><span class="line">|          .o*    |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ssh-copy-id root@test.example.com</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: Source of key(s) to be installed: &quot;&#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.pub&quot;</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@test.example.com&#39;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &#39;root@test.example.com&#39;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ssh root@test.example.com</span><br><span class="line">Last login: Wed Jan  9 20:20:16 2019 from 192.168.244.131</span><br><span class="line">[root@test ~]# hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>

<p>配置ansible</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[deploy@jenkins ~]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy</span><br><span class="line">[deploy@jenkins ~]$ cat testservers</span><br><span class="line">[testserver]</span><br><span class="line">test.example.com  ansible_user&#x3D;root</span><br></pre></td></tr></table></figure>



<p>登录到jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109202822525-464652266-20201127095233123.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109202940751-1626799640-20201127095233272.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109203014667-206268133-20201127095233045.png" class title="img">



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">set +x</span><br><span class="line">source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line"></span><br><span class="line">cd &#x2F;home&#x2F;deploy</span><br><span class="line">ansible --version</span><br><span class="line">ansible-playbook --version</span><br><span class="line"></span><br><span class="line">cat testservers</span><br><span class="line"></span><br><span class="line">ansible -i testservers testserver -m command -a &quot;ip addr&quot;</span><br><span class="line">set -x</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109203212938-471059166-20201127095233307.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;ansible-freestyle-job</span><br><span class="line">[ansible-freestyle-job] $ &#x2F;bin&#x2F;sh &#x2F;tmp&#x2F;jenkins7988516678097340995.sh</span><br><span class="line">ansible 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line">ansible-playbook 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible-playbook</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line">[testserver]</span><br><span class="line">test.example.com  ansible_user&#x3D;root</span><br><span class="line"></span><br><span class="line">test.example.com | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1&#x2F;128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:61:aa:73 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.244.133&#x2F;24 brd 192.168.244.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::7395:7e45:e2e6:ec36&#x2F;64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:0c:29:61:aa:7d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.182.134&#x2F;24 brd 192.168.182.255 scope global noprefixroute dynamic ens34</span><br><span class="line">       valid_lft 1477sec preferred_lft 1477sec</span><br><span class="line">    inet6 fe80::196:adf0:e929:d612&#x2F;64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>





<p>下面错误信息就是上述构建jenkins maven集成时报错信息（可以随便看看）： </p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109173345826-1534145406-20201127095233364.png" class title="img">

<p>构建失败，查看错误输出信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job</span><br><span class="line">Cloning the remote Git repository</span><br><span class="line">Cloning repository https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line"> &gt; git init &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line"> &gt; git --version # timeout&#x3D;10</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git # timeout&#x3D;10</span><br><span class="line"> &gt; git config --add remote.origin.fetch +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;* # timeout&#x3D;10</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line">Checking out Revision aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 (refs&#x2F;remotes&#x2F;origin&#x2F;master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -f aa3c70c49a68bfc91b4fe65c38be0b4b15461a63</span><br><span class="line">Commit message: &quot;first commit&quot;</span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line">[maven-freestyle-job] $ &#x2F;opt&#x2F;apache-maven-3.6.0&#x2F;bin&#x2F;mvn package</span><br><span class="line">The JAVA_HOME environment variable is not defined correctly</span><br><span class="line">This environment variable is needed to run this program</span><br><span class="line">NB: JAVA_HOME should point to a JDK not a JRE</span><br><span class="line">Build step &#39;Invoke top-level Maven targets&#39; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>由报错信息可以看出，jdk环境设置有问题</p>
<p>以下报错信息目前没有解决掉，如果有热心同学知道解决办法的欢迎评论区指教^_^ ~,针对以上问题，我是删掉重新构建了一遍，包括全局凭据也是删掉重新创建了一个一样的，然后再次执行的时候就没有报错。</p>
<p>但是经反复确认，jdk路径没有错，接着有重新构建，提示以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job</span><br><span class="line"> &gt; git rev-parse --is-inside-work-tree # timeout&#x3D;10</span><br><span class="line">Fetching changes from the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git # timeout&#x3D;10</span><br><span class="line">Fetching upstream changes from https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git</span><br><span class="line"> &gt; git --version # timeout&#x3D;10</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;java-war-dev.git +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line"> &gt; git rev-parse refs&#x2F;remotes&#x2F;origin&#x2F;origin&#x2F;master^&#123;commit&#125; # timeout&#x3D;10</span><br><span class="line">Checking out Revision aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 (refs&#x2F;remotes&#x2F;origin&#x2F;master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout&#x3D;10</span><br><span class="line"> &gt; git checkout -f aa3c70c49a68bfc91b4fe65c38be0b4b15461a63</span><br><span class="line">Commit message: &quot;first commit&quot;</span><br><span class="line"> &gt; git rev-list --no-walk aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 # timeout&#x3D;10</span><br><span class="line">[maven-freestyle-job] $ &#x2F;opt&#x2F;apache-maven-3.6.0&#x2F;bin&#x2F;mvn package</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  0.112 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T17:46:04+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] The goal you specified requires a project to execute but there is no POM in this directory (&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job). Please verify you invoked Maven from the correct directory. -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http:&#x2F;&#x2F;cwiki.apache.org&#x2F;confluence&#x2F;display&#x2F;MAVEN&#x2F;MissingProjectException</span><br><span class="line">Build step &#39;Invoke top-level Maven targets&#39; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>然后进行如下操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# cd &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job</span><br><span class="line">[root@jenkins maven-freestyle-job]# ls</span><br><span class="line">Java-war-dev</span><br><span class="line">[root@jenkins maven-freestyle-job]# ls Java-war-dev&#x2F;</span><br><span class="line">pom.xml  src</span><br><span class="line">[root@jenkins maven-freestyle-job]# mv Java-war-dev&#x2F;pom.xml .</span><br><span class="line">[root@jenkins maven-freestyle-job]# ls</span><br><span class="line">Java-war-dev  pom.xml</span><br></pre></td></tr></table></figure>

<p>再次执行构建操作，还是报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">........</span><br><span class="line">[INFO] Building war: &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;target&#x2F;Java-war-dev.war</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  01:36 min</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:04:52+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal </span><br><span class="line">org.apache.maven.plugins:maven-war-plugin:2.2:war (default-war) on project Java-war-dev: Error assembling WAR: webxml attribute is required (or pre-existing WEB-INF&#x2F;web.xml if executing in update mode) -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http:&#x2F;&#x2F;cwiki.apache.org&#x2F;confluence&#x2F;display&#x2F;MAVEN&#x2F;MojoExecutionException</span><br><span class="line"></span><br><span class="line">Build step &#39;Invoke top-level Maven targets&#39; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>



<p>改了pom.xml文件之后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;artifactId&gt;maven-release-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;version&gt;3.6&lt;&#x2F;version&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;webXml&gt;WebRoot\WEB-INF\web.xml&lt;&#x2F;webXml&gt;</span><br><span class="line">    &lt;warSourceDirectory&gt;WebRoot&lt;&#x2F;warSourceDirectory&gt;</span><br><span class="line">    &lt;!--autoVersionSubmodules&gt;true&lt;&#x2F;autoVersionSubmodules--&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>

<p>仍然报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[INFO] Building war: &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;target&#x2F;Java-war-dev.war</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  0.995 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:23:24+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-war-plugin:2.2:war (default-war) on project Java-war-dev: Error assembling WAR: webxml attribute is required (or pre-existing WEB-INF&#x2F;web.xml if executing in update mode) -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http:&#x2F;&#x2F;cwiki.apache.org&#x2F;confluence&#x2F;display&#x2F;MAVEN&#x2F;MojoExecutionException</span><br><span class="line">Build step &#39;Invoke top-level Maven targets&#39; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>再次更改pom.xml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;version&gt;3.6&lt;&#x2F;version&gt;</span><br><span class="line">           &lt;configuration&gt;</span><br><span class="line">               &lt;webResources&gt;</span><br><span class="line">                   &lt;resource&gt;</span><br><span class="line">                       &lt;directory&gt;web&lt;&#x2F;directory&gt;</span><br><span class="line">                   &lt;&#x2F;resource&gt;</span><br><span class="line">               &lt;&#x2F;webResources&gt;</span><br><span class="line">               &lt;!--webXml&gt;WebRoot\WEB-INF\web.xml&lt;&#x2F;webXml&gt;</span><br><span class="line">               &lt;warSourceDirectory&gt;WebRoot&lt;&#x2F;warSourceDirectory--&gt;</span><br><span class="line">               &lt;!--autoVersionSubmodules&gt;true&lt;&#x2F;autoVersionSubmodules--&gt;</span><br><span class="line">           &lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>

<p>仍然报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[INFO] Building war: &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;maven-freestyle-job&#x2F;target&#x2F;Java-war-dev.war</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  0.982 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:26:38+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-war-plugin:2.2:war (default-war) on project Java-war-dev: Error assembling WAR: webxml attribute is required (or pre-existing WEB-INF&#x2F;web.xml if executing in update mode) -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http:&#x2F;&#x2F;cwiki.apache.org&#x2F;confluence&#x2F;display&#x2F;MAVEN&#x2F;MojoExecutionException</span><br><span class="line">Build step &#39;Invoke top-level Maven targets&#39; marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>然而网友说的这些并不能解决问题。</p>
]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP-php-fpm配置优化</title>
    <url>/sugw.github.io/2020/11/19/PHP-php-fpm%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>前言:</p>
<p>　　1.少安装PHP模块, 费内存</p>
<p>　　2.调高linux内核打开文件数量，可以使用这些命令(必须是root帐号)(我是修改/etc/rc.local，加入ulimit -SHn 51200的)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &#96;ulimit -HSn 65536&#96; &gt;&gt; &#x2F;etc&#x2F;profile</span><br><span class="line">echo &#96;ulimit -HSn 65536&#96; &gt;&gt; &#x2F;etc&#x2F;rc.local</span><br><span class="line">source &#x2F;etc&#x2F;profile </span><br></pre></td></tr></table></figure>

<p>　　如果<code>ulimit -n</code>数量依旧不多(即上面配置没生效)的话, 可以在 /etc/security/limits.conf 文件最后加上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">* soft nofile 51200</span><br><span class="line">* hard nofile 51200</span><br></pre></td></tr></table></figure>

<p>1.<strong>与Nginx使用Unix域Socket通信(Nginx和php-fpm在同一台服务器)</strong></p>
<p>　　Unix域Socket因为不走网络，的确可以提高Nginx和php-fpm通信的性能，但在高并发时会不稳定。</p>
<p>　　Nginx会频繁报错：connect() to unix:/dev/shm/php-fcgi.sock failed (11: Resource temporarily unavailable) while connecting to upstream</p>
<p>　　可以通过下面两种方式提高稳定性：<br>　　1）调高nginx和php-fpm中的backlog<br>  　　 配置方法为：在nginx配置文件中这个域名的server下，在listen 80后面添加default backlog=1024。<br>   　　同时配置php-fpm.conf中的listen.backlog为1024，默认为128。<br>　　2）增加sock文件和php-fpm实例数<br>   　　再新建一个sock文件，在Nginx中通过upstream模块将请求负载均衡到两个sock文件背后的两套php-fpm实例上。</p>
<p>2.<strong>php-fpm参数调优</strong></p>
<p>　　pm = dynamic; 表示使用哪种进程数量管理方式</p>
<p>　　　　dynamic表示php-fpm进程数是动态的，最开始是pm.start_servers指定的数量，如果请求较多，则会自动增加，保证空闲的进程数不小于pm.min_spare_servers，如果进程数较多，也会进行相应清理，保证多余的进程数不多于pm.max_spare_servers</p>
<p>　　　　static表示php-fpm进程数是静态的, 进程数自始至终都是pm.max_children指定的数量，不再增加或减少</p>
<p>　　pm.max_children = 300; <strong>静态方式</strong>下开启的php-fpm进程数量<br>　　pm.start_servers = 20; <strong>动态方式</strong>下的起始php-fpm进程数量<br>　　pm.min_spare_servers = 5; <strong>动态方式</strong>下的最小php-fpm进程数量<br>　　pm.max_spare_servers = 35; <strong>动态方式</strong>下的最大php-fpm进程数量</p>
<p>　　　　如果pm为static, 那么其实只有pm.max_children这个参数生效。系统会开启设置数量的php-fpm进程</p>
<p>　　　　如果pm为dynamic, 那么pm.max_children参数失效，后面3个参数生效。系统会在php-fpm运行开始的时候启动pm.start_servers个php-fpm进程，然后根据系统的需求动态在pm.min_spare_servers和pm.max_spare_servers之间调整php-fpm进程数</p>
<p>　　　　那么，对于我们的服务器，选择哪种pm方式比较好呢？事实上，跟Apache一样，运行的PHP程序在执行完成后，或多或少会有内存泄露的问题。这也是为什么开始的时候一个php-fpm进程只占用3M左右内存，运行一段时间后就会上升到20-30M的原因了。</p>
<p>　　　　对于内存大的服务器（比如8G以上）来说，指定静态的max_children实际上更为妥当，因为这样不需要进行额外的进程数目控制，会提高效率。因为频繁开关php-fpm进程也会有时滞，所以内存够大的情况下开静态效果会更好。数量也可以根据 内存/30M 得到，比如8GB内存可以设置为100，那么php-fpm耗费的内存就能控制在 2G-3G的样子。如果内存稍微小点，比如1G，那么指定静态的进程数量更加有利于服务器的稳定。这样可以保证php-fpm只获取够用的内存，将不多的内存分配给其他应用去使用，会使系统的运行更加畅通。</p>
<p>　　　　对于小内存的服务器来说，比如256M内存的VPS，即使按照<strong>一个20M</strong>的内存量来算，10个php-cgi进程就将耗掉200M内存，那系统的崩溃就应该很正常了。因此应该尽量地控制php-fpm进程的数量，大体明确其他应用占用的内存后，给它指定一个静态的小数量，会让系统更加平稳一些。或者使用动态方式，因为动态方式会结束掉多余的进程，可以回收释放一些内存，所以推荐在内存较少的服务器或VPS上使用。具体最大数量根据 内存/20M 得到。比如说512M的VPS，建议pm.max_spare_servers设置为20。至于pm.min_spare_servers，则建议根据服务器的负载情况来设置，比较合适的值在5~10之间。</p>
<p>　　　　在4G内存的服务器上200就可以(<strong>我的1G测试机，开64个是最好的</strong>，建议使用压力测试获取最佳值)</p>
<p>　　pm.max_requests = 10240;</p>
<p>　　　　nginx php-fpm配置过程中最大问题是内泄漏出问题：服务器的负载不大，但是内存占用迅速增加，很快吃掉内存接着开始吃交换分区，系统很快挂掉！其实根据官方的介绍，php-cgi不存在内存泄漏，每个请求完成后php-cgi会回收内存，但是不会释放给操作系统，这样就会导致大量内存被php-cgi占用。
　　　　</p>
<p>　　　　官方的解决办法是降低PHP_FCGI_MAX_REQUESTS的值，如果用的是php-fpm，对应的php-fpm.conf中的就是max_requests，该值的意思是发送多少个请求后会重启该线程，我们需要适当降低这个值，用以让php-fpm自动的释放内存，不是大部分网上说的51200等等，实际上还有另一个跟它有关联的值max_children，这个是每次php-fpm会建立多少个进程，这样实际上的内存消耗是max_children<em>max_requests</em>每个请求使用内存，根据这个我们可以预估一下内存的使用情况，就不用再写脚本去kill了。</p>
<p>　　request_terminate_timeout = 30;</p>
<p>　　　　最大执行时间, 在php.ini中也可以进行配置(max_execution_time)</p>
<p>　　request_slowlog_timeout = 2; 开启慢日志<br>　　slowlog = log/$pool.log.slow; 慢日志路径</p>
<p>　　rlimit_files = 1024; 增加php-fpm打开文件描述符的限制</p>
<p>3.<strong>php-fpm的高CPU使用率排查方法</strong></p>
<p>　　1)使用top命令, 直接执行top命令后，输入1就可以看到各个核心的CPU使用率。而且通过top -d 0.1可以缩短采样时间</p>
<p>　　2)查询php-fpm慢日志</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -v &quot;^$&quot; www.log.slow.tmp | cut -d &quot; &quot; -f 3,2 | sort | uniq -c | sort -k1,1nr | head -n 50</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5181 run() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;filters&#x2F;CFilter.php:41</span><br><span class="line"></span><br><span class="line">5156 filter() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;filters&#x2F;CFilterChain.php:131</span><br><span class="line"></span><br><span class="line">2670 &#x3D; &#x2F;www&#x2F;test.net&#x2F;index.php</span><br><span class="line"></span><br><span class="line">2636 run() &#x2F;www&#x2F;test.net&#x2F;application&#x2F;controllers&#x2F;survey&#x2F;index.php:665</span><br><span class="line"></span><br><span class="line">2630 action() &#x2F;www&#x2F;test.net&#x2F;application&#x2F;controllers&#x2F;survey&#x2F;index.php:18</span><br><span class="line"></span><br><span class="line">2625 run() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;actions&#x2F;CAction.php:75</span><br><span class="line"></span><br><span class="line">2605 runWithParams() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;CController.php:309</span><br><span class="line"></span><br><span class="line">2604 runAction() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;filters&#x2F;CFilterChain.php:134</span><br><span class="line"></span><br><span class="line">2538 run() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;CController.php:292</span><br><span class="line"></span><br><span class="line">2484 runActionWithFilters() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;CController.php:266</span><br><span class="line"></span><br><span class="line">2251 run() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;CWebApplication.php:276</span><br><span class="line"></span><br><span class="line">1799 translate() &#x2F;www&#x2F;test.net&#x2F;application&#x2F;libraries&#x2F;Limesurvey_lang.php:118</span><br><span class="line"></span><br><span class="line">1786 load_tables() &#x2F;www&#x2F;test.net&#x2F;application&#x2F;third_party&#x2F;php-gettext&#x2F;gettext.php:254</span><br><span class="line"></span><br><span class="line">1447 runController() &#x2F;www&#x2F;test.net&#x2F;framework&#x2F;web&#x2F;CWebApplication.php:135</span><br></pre></td></tr></table></figure>

<p>　　　　参数解释:</p>
<p>​         sort: 对单词进行排序<br>​         uniq -c: 显示唯一的行，并在每行行首加上本行在文件中出现的次数<br>​         sort -k1,1nr: 按照第一个字段，数值排序，且为逆序<br>​         head -10: 取前10行数据</p>
<p>　　3)用strace跟踪进程</p>
<p>　　　　a)利用nohup将strace转为后台执行，直到attach上的php-fpm进程死掉为止：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nohup strace -T -p 13167 &gt; 13167-strace.log &amp;</span><br></pre></td></tr></table></figure>

<p>　　　　参数说明:</p>
<p>　　　　　 -c 统计每一系统调用的所执行的时间,次数和出错的次数等.<br>         -d 输出strace关于标准错误的调试信息.<br>         -f 跟踪由fork调用所产生的子进程.<br>         -o filename,则所有进程的跟踪结果输出到相应的filename<br>         -F 尝试跟踪vfork调用.在-f时,vfork不被跟踪.<br>         -h 输出简要的帮助信息.<br>         -i 输出系统调用的入口指针.<br>         -q 禁止输出关于脱离的消息.<br>         -r 打印出相对时间关于,,每一个系统调用.<br>         -t 在输出中的每一行前加上时间信息.<br>         -tt 在输出中的每一行前加上时间信息,微秒级.<br>         -ttt 微秒级输出,以秒了表示时间.<br>         -T 显示每一调用所耗的时间.<br>         -v 输出所有的系统调用.一些调用关于环境变量,状态,输入输出等调用由于使用频繁,默认不输出.<br>         -V 输出strace的版本信息.<br>         -x 以十六进制形式输出非标准字符串<br>         -xx 所有字符串以十六进制形式输出.<br>         -a column<br>         设置返回值的输出位置.默认为40.<br>         -e execve 只记录 execve 这类系统调用<br>         -p 主进程号</p>
<p>　　　　b)用利用-c参数让strace帮助汇总，非常方便非常强大！</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@b28-12 log]# strace -cp 9907</span><br><span class="line"></span><br><span class="line">Process 9907 attached - interrupt to quit</span><br><span class="line"></span><br><span class="line">Process 9907 detached</span><br><span class="line"></span><br><span class="line">% time     seconds  usecs&#x2F;call     calls    errors syscall</span><br><span class="line"></span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"></span><br><span class="line">56.61    0.016612           5      3121           read</span><br><span class="line"></span><br><span class="line">11.11    0.003259           1      2517       715 stat</span><br><span class="line"></span><br><span class="line">  8.04    0.002358           7       349           brk</span><br><span class="line"></span><br><span class="line">  6.02    0.001767           1      1315           poll</span><br><span class="line"></span><br><span class="line">  4.28    0.001255           6       228           recvfrom</span><br><span class="line"></span><br><span class="line">  2.71    0.000796           1       671           open</span><br><span class="line"></span><br><span class="line">  2.54    0.000745           0      2453           fcntl</span><br><span class="line"></span><br><span class="line">  2.37    0.000696           1      1141           write</span><br><span class="line"></span><br><span class="line">  1.69    0.000497           1       593        13 access</span><br><span class="line"></span><br><span class="line">  1.37    0.000403           0      1816           lseek</span><br><span class="line"></span><br><span class="line">  0.89    0.000262           1       451        22 sendto</span><br><span class="line"></span><br><span class="line">  0.56    0.000163           1       276       208 lstat</span><br><span class="line"></span><br><span class="line">  0.49    0.000145           0       384           getcwd</span><br><span class="line"></span><br><span class="line">  0.31    0.000090           0      1222           fstat</span><br><span class="line"></span><br><span class="line">  0.28    0.000082           0       173           munmap</span><br><span class="line"></span><br><span class="line">  0.26    0.000077           0       174           mmap</span><br><span class="line"></span><br><span class="line">  0.24    0.000069           2        41           socket</span><br><span class="line"></span><br><span class="line">  0.23    0.000068           0       725           close</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        13           rt_sigaction</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        13           rt_sigprocmask</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0         1           rt_sigreturn</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        78           setitimer</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        26        26 connect</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        15         2 accept</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        39           recvmsg</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        26           shutdown</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        13           bind</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        13           getsockname</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        65           setsockopt</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        13           getsockopt</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0         8           getdents</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0        26           chdir</span><br><span class="line"></span><br><span class="line">  0.00    0.000000           0         1           futex</span><br><span class="line"></span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"></span><br><span class="line">100.00    0.029344                 18000       986 total</span><br></pre></td></tr></table></figure>

<p>4.<strong>使用Opcode缓存</strong>(<a href="http://www.cnblogs.com/JohnABC/p/4531038.html">http://www.cnblogs.com/JohnABC/p/4531038.html</a>)</p>
<p>5.<strong>对PHP性能进行监控</strong></p>
<p>　　常用的方法就是开启xdebug的性能监控功能，将xdebug输出结果通过WinCacheGrind软件分析。</p>
<p>　　xdebug的安装和配合IDE调试的方法参见：<a href="http://blog.csdn.net/dc_726/article/details/8809696">Vim+XDebug调试PHP</a></p>
<p>　　php.ini中配置的这几项是输出性能信息的：</p>
<blockquote>
<p>xdebug.auto_trace = on</p>
</blockquote>
<blockquote>
<p>xdebug.auto_profile = on<br>xdebug.collect_params = on<br>xdebug.collect_return = on<br>xdebug.profiler_enable = on<br>xdebug.trace_output_dir = “/tmp”<br>xdebug.profiler_output_dir =”/tmp”</p>
</blockquote>
<p>　　这样XDebug会输出所有执行php函数的性能数据，但产生的文件也会比较大。可以关闭一些选项如collect_params、collect_return，</p>
<p>　　来减少输出的数据量。或者关闭自动输出，通过在想要监控的函数首尾调用xdebug函数来监控指定的函数。</p>
<p>　　输出的文件名类似cachegrind.out.1277560600和trace.3495983249.txt，可以拿到Windows平台下用WinCacheGrind进行图形化分析。</p>
<p>6.监测php-fpm线程状态</p>
<p>　　nginx配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ~ ^&#x2F;status$ &#123;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">    fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　php-fpm配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pm.status_path &#x3D; &#x2F;status</span><br></pre></td></tr></table></figure>

<p>　　这样的话通过http://域名/status就可以看到当前的php情况</p>
<p>　　下面介绍每个参数的作用：<br>　　pool：php-fpm池的名称，一般都是应该是www<br>　　process manage：进程的管理方法，php-fpm支持三种管理方法，分别是static,dynamic和ondemand，一般情况下都是dynamic<br>　　start time：php-fpm启动时候的时间，不管是restart或者reload都会更新这里的时间<br>　　start since：php-fpm自启动起来经过的时间，默认为秒<br>　　accepted conn：当前接收的连接数<br>　　listen queue：在队列中等待连接的请求个数，如果这个数字为非0，那么最好增加进程的fpm个数<br>　　max listen queue：从fpm启动以来，在队列中等待连接请求的最大值<br>　　listen queue len：等待连接的套接字队列大小<br>　　idle processes：空闲的进程个数<br>　　active processes：活动的进程个数<br>　　total processes：总共的进程个数<br>　　max active processes：从fpm启动以来，活动进程的最大个数，如果这个值小于当前的max_children，可以调小此值<br>　　max children reached：当pm尝试启动更多的进程，却因为max_children的限制，没有启动更多进程的次数。如果这个值非0，那么可以适当增加fpm的进程数<br>　　slow requests：慢请求的次数，一般如果这个值未非0，那么可能会有慢的php进程，一般一个不好的mysql查询是最大的祸首。</p>
<p>7.开启php-fpm慢日志</p>
<p>　　slowlog = /usr/local/php/log/php-fpm.log.slow</p>
<p>　　request_slowlog_timeout = 5s</p>
<p>8.设置php-fpm单次请求最大执行时间，今天碰到一个问题，测试服务器php-fpm一直是被占满状态，后来发现是set_time_limit(0)，file_get_content()，原因如下:</p>
<p>　　比如file_get_contents(url)等函数，如果网站反应慢，会一直等在那儿不超时，php-fpm一直被占用。有一个参数 max_execution_time 可以设置 PHP 脚本的最大执行时间，但是，在 php-cgi(php-fpm) 中，该参数不会起效。真正能够控制 PHP 脚本最大执行时间的是 php-fpm.conf 配置文件中的以下参数。</p>
<p>　　request_terminate_timeout = 10s</p>
<p>　　默认值为 0 秒，也就是说，PHP 脚本会一直执行下去。这样，当所有的 php-cgi 进程都卡在 file_get_contents() 函数时，这台 Nginx+PHP 的 WebServer 已经无法再处理新的 PHP 请求了，Nginx 将给用户返回“502 Bad Gateway”。可以使用 request_terminate_timeout = 30s，但是如果发生 file_get_contents() 获取网页内容较慢的情况，这就意味着 150 个 php-cgi 进程，每秒钟只能处理 5 个请求，WebServer 同样很难避免“502 Bad Gateway”。php-cgi进程数不够用、php执行时间长、或者是php-cgi进程死掉，都会出现502错误。</p>
<p>　　要做到彻底解决，只能让 PHP 程序员们改掉直接使用 file_get_contents(“<a href="http://example.com/&quot;">http://example.com/&quot;</a>) 的习惯，而是稍微修改一下，加个超时时间，用以下方式来实现 HTTP GET 请求。要是觉得麻烦，可以自行将以下代码封装成一个函数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">    $ctx &#x3D; stream_context_create(array(  </span><br><span class="line">       &#39;http&#39; &#x3D;&gt; array(  </span><br><span class="line">           &#39;timeout&#39; &#x3D;&gt; 1 &#x2F;&#x2F;设置一个超时时间，单位为秒  </span><br><span class="line">           )  </span><br><span class="line">       )  </span><br><span class="line">    );  </span><br><span class="line">    file_get_contents(&quot;http:&#x2F;&#x2F;example.com&#x2F;&quot;, 0, $ctx);  </span><br></pre></td></tr></table></figure>



<p>　　当然，导致 php-cgi 进程 CPU 100% 的原因不只有这一种，那么，怎么确定是 file_get_contents() 函数导致的呢？</p>
<p>　　首先，使用 top 命令查看 CPU 使用率较高的 php-cgi 进程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">top - 10:34:18 up 724 days, 21:01,  3 users,  load average: 17.86, 11.16, 7.69</span><br><span class="line">Tasks: 561 total,  15 running, 546 sleeping,   0 stopped,   0 zombie</span><br><span class="line">Cpu(s):  5.9%us,  4.2%sy,  0.0%ni, 89.4%id,  0.2%wa,  0.0%hi,  0.2%si,  0.0%st</span><br><span class="line">Mem:   8100996k total,  4320108k used,  3780888k free,   772572k buffers</span><br><span class="line">Swap:  8193108k total,    50776k used,  8142332k free,   412088k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                              </span><br><span class="line">10747 www       18   0  360m  22m  12m R 100.6 0.3    0:02.60 php-cgi                                                                                                              </span><br><span class="line">10709 www       16   0  359m  28m  17m R 96.8  0.4    0:11.34 php-cgi                                                                                                              </span><br><span class="line">10745 www       18   0  360m  24m  14m R 94.8  0.3    0:39.51 php-cgi                                                                                                              </span><br><span class="line">10707 www       18   0  360m  25m  14m S 77.4  0.3    0:33.48 php-cgi                                                                                                              </span><br><span class="line">10782 www       20   0  360m  26m  15m R 75.5  0.3    0:10.93 php-cgi                                                                                                              </span><br><span class="line">10708 www       25   0  360m  22m  12m R 69.7  0.3    0:45.16 php-cgi                                                                                                              </span><br><span class="line">10683 www       25   0  362m  28m  15m R 54.2  0.4    0:32.65 php-cgi                                                                                                              </span><br><span class="line">10711 www       25   0  360m  25m  15m R 52.2  0.3    0:44.25 php-cgi                                                                                                              </span><br><span class="line">10688 www       25   0  359m  25m  15m R 38.7  0.3    0:10.44 php-cgi                                                                                                              </span><br><span class="line">10719 www       25   0  360m  26m  16m R  7.7  0.3    0:40.59 php-cgi</span><br></pre></td></tr></table></figure>

<p>　　找其中一个 CPU 100% 的 php-cgi 进程的 PID，用以下命令跟踪一下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strace -p 10747</span><br></pre></td></tr></table></figure>

<p>　　如果屏幕显示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br><span class="line">select(7, [6], [6], [], &#123;15, 0&#125;)        &#x3D; 1 (out [6], left &#123;15, 0&#125;)</span><br><span class="line">poll([&#123;fd&#x3D;6, events&#x3D;POLLIN&#125;], 1, 0)     &#x3D; 0 (Timeout)</span><br></pre></td></tr></table></figure>

<p>　　那么，就可以确定是 file_get_contents() 导致的问题了。(参考:<a href="http://zyan.cc/tags/request_terminate_timeout/1/">http://zyan.cc/tags/request_terminate_timeout/1/</a>)</p>
<p>9.查看php-fpm启动时间(可以得出执行了多长时间)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -A -o pid,lstart,cmd |grep php-fpm</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(一)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/</url>
    <content><![CDATA[<h2 id="首先准备实验环境"><a href="#首先准备实验环境" class="headerlink" title="首先准备实验环境"></a>首先准备实验环境</h2><table>
<thead>
<tr>
<th>虚拟机</th>
<th>主机名</th>
<th>IP地址</th>
<th>服务</th>
<th>系统版本</th>
<th>内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>Vmware Workstation 14</td>
<td>gitlab.example.com</td>
<td>20.10.1.249</td>
<td>gitlab</td>
<td>CentOS Linux release 7.5.1804 (Core)</td>
<td>3.10.0-862.el7.x86_64</td>
</tr>
<tr>
<td></td>
<td>jenkins.example.com</td>
<td>192.168.244.131</td>
<td>jenkis</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ansible.example.com</td>
<td>192.168.244.132</td>
<td>asible</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="hosts解析"><a href="#hosts解析" class="headerlink" title="hosts解析"></a>hosts解析</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">20.10.1.249 gitlab.example.com</span><br><span class="line">192.168.244.131 jenkins.example.com</span><br><span class="line">192.168.244.132 ansible.example.com</span><br></pre></td></tr></table></figure>

<h2 id="关闭防火墙和selinux"><a href="#关闭防火墙和selinux" class="headerlink" title="关闭防火墙和selinux"></a>关闭防火墙和selinux</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># sed -i &quot;s/enforcing/disabled/&quot; /etc/selinux/config</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># systemctl stop firewalld &amp;&amp; systemmctl disable firewalld</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># reboot</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># getenforce</span></span><br><span class="line">Permissive</span><br><span class="line">[root@server01 ~]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure>

<h2 id="安装postfix并启动"><a href="#安装postfix并启动" class="headerlink" title="安装postfix并启动"></a>安装postfix并启动</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum install postfix</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># systemctl start postfix &amp;&amp; systemctl enable postfix</span></span><br></pre></td></tr></table></figure>

<h2 id="安装Gitlab组件及gitlab-ce"><a href="#安装Gitlab组件及gitlab-ce" class="headerlink" title="安装Gitlab组件及gitlab-ce"></a>安装Gitlab组件及gitlab-ce</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum install curl policycoreutils openssh-server openssh-clients</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># yum install -y gitlab-ce </span></span><br></pre></td></tr></table></figure>

<h2 id="也可以去https-packages-gitlab-com-gitlab-gitlab-ce-packages-el-7-gitlab-ce-10-0-0-ce-0-el7-x86-64-rpm安装方法。"><a href="#也可以去https-packages-gitlab-com-gitlab-gitlab-ce-packages-el-7-gitlab-ce-10-0-0-ce-0-el7-x86-64-rpm安装方法。" class="headerlink" title="也可以去https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。"></a>也可以去<a href="https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E3%80%82">https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。</a></h2><h2 id="证书创建与配置加载"><a href="#证书创建与配置加载" class="headerlink" title="证书创建与配置加载"></a>证书创建与配置加载</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># mkdir -p /etc/gitlab/ssl </span></span><br><span class="line"><span class="comment">#创建私有密钥 </span></span><br><span class="line">[root@gitlab ~]<span class="comment"># openssl genrsa -out &quot;/etc/gitlab/ssl/gitlab.key&quot; 2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建私有证书</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># openssl req -new -key &quot;/etc/gitlab/ssl/gitlab.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.csr&quot;</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:sh</span><br><span class="line">Locality Name (eg, city) [Default City]:sh</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:  <span class="comment">#输入空格，然后回车</span></span><br><span class="line">Organizational Unit Name (eg, section) []:  <span class="comment">#输入空格，然后回车</span></span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:gitlab.example.com</span></span><br><span class="line"><span class="string">Email Address []:admin@example.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:123456</span></span><br><span class="line"><span class="string">An optional company name []:  #直接回车</span></span><br><span class="line"><span class="string"># 查看</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 8</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span></span><br><span class="line"><span class="string"># 接下来利用私有密钥和私有证书创建CRT签署证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]#  openssl x509 -req -days 365 -in &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot; -signkey &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line"><span class="string">Signature ok</span></span><br><span class="line"><span class="string">subject=/C=cn/ST=sh/L=sh/O= /OU= /CN=gitlab.sugw.io/emailAddress=suguowei@sugw.io</span></span><br><span class="line"><span class="string">Getting Private key</span></span><br><span class="line"><span class="string"># 查看</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 12</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br><span class="line"><span class="string">利用openssl命令输出pem证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]# openssl dhparam -out /etc/gitlab/ssl/dhparam.pem 2048</span></span><br><span class="line"><span class="string">Generating DH parameters, 2048 bit long safe prime, generator 2</span></span><br><span class="line"><span class="string">This is going to take a long time</span></span><br><span class="line"><span class="string">........................................................+................................................................................+.....................................+..................................................................................+..............................................+..................................................................................................................................+..+........................................................................................................................................+..............................................................................................................................................................................+......+..............+.....................................................+.................+.......................................................................................+..+.................................................................................................................................................+..........................................................+.............+.........+...........................................................+........................................................................................................................................................................................................................................+...................................................................................................................................................................................................................................................................................................................++*++*</span></span><br><span class="line"><span class="string">#  这个过程有点久</span></span><br><span class="line"><span class="string"># 查看生成的证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 16</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root  424 11月 27 04:11 dhparam.pem</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br><span class="line"><span class="string">更改文件权限</span></span><br><span class="line"><span class="string">[root@gitlab ~]# chmod 600 /etc/gitlab/ssl/*</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 16</span></span><br><span class="line"><span class="string">-rw------- 1 root root  424 11月 27 04:11 dhparam.pem</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br></pre></td></tr></table></figure>

<h2 id="配置gitlab"><a href="#配置gitlab" class="headerlink" title="配置gitlab"></a>配置gitlab</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># cp /etc/gitlab/gitlab.rb&#123;,.bak&#125;</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/gitlab/gitlab.rb</span></span><br><span class="line"><span class="comment">## 更改如下</span></span><br><span class="line"> 13 external_url <span class="string">&#x27;https://gitlab.example.com&#x27;</span> </span><br><span class="line">952 nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">964 nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line">965 nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span></span><br><span class="line">979 <span class="comment"># nginx[&#x27;ssl_dhparam&#x27;] = /etc/gitlab/ssl/dhparam.pem # Path to dhparams.pem,      eg. /etc/gitlab/ssl/dhparams.pem</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化gitlab相关服务配置"><a href="#初始化gitlab相关服务配置" class="headerlink" title="初始化gitlab相关服务配置"></a>初始化gitlab相关服务配置</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">。。。。过程有点长，需要等一会（看个人服务器配置了）</span><br><span class="line">Running handlers:</span><br><span class="line">Running handlers complete</span><br><span class="line">Chef Client finished, 454&#x2F;655 resources updated in 02 minutes 16 seconds</span><br><span class="line">gitlab Reconfigured!</span><br><span class="line"># 出现这个表示配置没有问题！</span><br></pre></td></tr></table></figure>

<h2 id="对nginx配置"><a href="#对nginx配置" class="headerlink" title="对nginx配置"></a>对nginx配置</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;nginx&#x2F;conf&#x2F;gitlab-http.conf&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;nginx&#x2F;conf&#x2F;gitlab-http.conf</span><br><span class="line"> 37   server_name gitlab.example.com; #在此行下面添加38行的内容</span><br><span class="line"> 38   rewrite ^(.*)$ https:&#x2F;&#x2F;$host$1 permanent;</span><br></pre></td></tr></table></figure>

<p>重启gitlab</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl restart</span><br><span class="line">ok: run: alertmanager: (pid 6526) 1s</span><br><span class="line">ok: run: gitaly: (pid 6543) 0s</span><br><span class="line">ok: run: gitlab-monitor: (pid 6556) 0s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 6579) 1s</span><br><span class="line">ok: run: logrotate: (pid 6589) 0s</span><br><span class="line">ok: run: nginx: (pid 6597) 1s</span><br><span class="line">ok: run: node-exporter: (pid 6681) 0s</span><br><span class="line">ok: run: postgres-exporter: (pid 6687) 1s</span><br><span class="line">ok: run: postgresql: (pid 6698) 0s</span><br><span class="line">ok: run: prometheus: (pid 6706) 0s</span><br><span class="line">ok: run: redis: (pid 6722) 0s</span><br><span class="line">ok: run: redis-exporter: (pid 6856) 0s</span><br><span class="line">ok: run: sidekiq: (pid 6866) 0s</span><br><span class="line">ok: run: unicorn: (pid 6880) 0s</span><br><span class="line">#  可以看出gitlab的所有服务重启完成</span><br></pre></td></tr></table></figure>

<h2 id="使用宿主访问gitlab-sugw-io-80"><a href="#使用宿主访问gitlab-sugw-io-80" class="headerlink" title="使用宿主访问gitlab.sugw.io:80"></a>使用宿主访问gitlab.sugw.io:80</h2><img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164045215-3943660.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164153110-1651878067.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164224914-827989240.png" class title="img">

<p>开始使用gitlab</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164356206-501778199.png" class title="img">

<p>创建一个测试工程</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164555544-1084217569.png" class title="img">

<p>复制仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164808408-621505099.png" class title="img">

<p>回到win10宿主机，重新打开一个git命令行窗口如下所示操作</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102165212447-658335923.png" class title="img">

<p># 粘贴仓库地址回车后会弹出输入账户和密码的窗口</p>
<p>之后就会将空的测试仓库克隆到本地宿主机的桌面上的repo目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line">Cloning into &#39;test-repo&#39;...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls test-repo&#x2F;</span><br></pre></td></tr></table></figure>

<p>在win10宿主机下的test-repo目录下新建一个test.py文件，并上传至gitlab</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ vi test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in test.py.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">[master (root-commit) 93bd740] First Commit</span><br><span class="line"> Committer: unknown &lt;xueji@pin.com&gt;</span><br><span class="line">Your name and email address were configured automatically based</span><br><span class="line">on your username and hostname. Please check that they are accurate.</span><br><span class="line">You can suppress this message by setting them explicitly. Run the</span><br><span class="line">following command and follow the instructions in your editor to edit</span><br><span class="line">your configuration file:</span><br><span class="line"></span><br><span class="line">    git config --global --edit</span><br><span class="line"></span><br><span class="line">After doing this, you may fix the identity used for this commit with:</span><br><span class="line"></span><br><span class="line">    git commit --amend --reset-author</span><br><span class="line"></span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config  --global user.email &quot;admin@example.com&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.name &quot;admin&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">Your branch is based on &#39;origin&#x2F;master&#39;, but the upstream is gone.</span><br><span class="line">  (use &quot;git branch --unset-upstream&quot; to fixup)</span><br><span class="line"></span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push master</span><br><span class="line">fatal: &#39;master&#39; does not appear to be a git repository</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br></pre></td></tr></table></figure>

<p>报错，跟据提示信息我们进行如下操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git branch --unset-upstream</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.email &quot;admin@example.com&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.name &quot;admin&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;Second Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push origin master</span><br><span class="line">Enumerating objects: 3, done.</span><br><span class="line">Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">Writing objects: 100% (3&#x2F;3), 242 bytes | 242.00 KiB&#x2F;s, done.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>回到gitlab的浏览器页面，刷新查看</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172541680-1685258190.png" class title="img">

<p>已经成功上传到test-repo工程当中。</p>
<p>Gitlab应用</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172834006-957477766.png" class title="img">

<p>比如说Systeminfo</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173017476-1297762493.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173108736-1671134778.png" class title="img">

<p>比如说日志</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173204986-1045231309.png" class title="img">

<p>需要我们关注的是application.log和production.log两项</p>
<p>比如说健康状况</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173522576-1583433372.png" class title="img">

<p>创建开发人员及leader的账号</p>
<p>开发人员账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173648091-57729423.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173839541-132784246.png" class title="img">

<p>其他选项不要动，点击创建即可。</p>
<p>创建leader的账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174006279-1152234077.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174112736-1497099430.png" class title="img">

<p>其他也不要动。</p>
<p>建好后的账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174214548-2047513172.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174323576-45552471.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174428809-1250049533.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174525431-600068675.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174619643-830800285.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174809969-1580189936.png" class title="img">

<p>同理添加lead账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175038572-8109703.png" class title="img">

<p>更改两个账户的密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175340108-1125836966.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175430628-339857982.png" class title="img">

<p>其他选项保持不变，然后点击页面最下面的save changes，同理更改lead的密码</p>
<p>使用dev账户进行git命令行的提交操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 以下步骤也是在win10宿主机上进行的</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo&#x2F;test-repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ cd ..</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ rm -rf test-repo&#x2F;</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line">Cloning into &#39;test-repo&#39;...</span><br><span class="line">remote: Enumerating objects: 3, done.</span><br><span class="line">remote: Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3&#x2F;3), done.</span><br><span class="line">#  这一步就很尴尬了，本来是想要验证dev账户的，谁知道什么都不需要输入就直接可以clone下来。</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls test-repo&#x2F;</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git checkout -b release-1.0   #创建开发人员版本</span><br><span class="line">Switched to a new branch &#39;release-1.0&#39;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ ls</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ vim test.py</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ cat test.py</span><br><span class="line">print(&quot;This is a test python file for release-1.0!&quot;)</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push origin release-1.0</span><br><span class="line">Enumerating objects: 5, done.</span><br><span class="line">Counting objects: 100% (5&#x2F;5), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (2&#x2F;2), done.</span><br><span class="line">Writing objects: 100% (3&#x2F;3), 287 bytes | 287.00 KiB&#x2F;s, done.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote:</span><br><span class="line">remote: To create a merge request for release-1.0, visit:</span><br><span class="line">remote:   https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo&#x2F;merge_requests&#x2F;new?merge_request%5Bsource_branch%5D&#x3D;release-1.0</span><br><span class="line">remote:</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line"> * [new branch]      release-1.0 -&gt; release-1.0</span><br><span class="line">#  我靠，估计版本不一样，这一步不需要输入账户名和密码</span><br></pre></td></tr></table></figure>

<p>返回gitlab的浏览器页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180851535-2098739677.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180912746-365779940.png" class title="img">

<p> 使用开发账户登录</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202149369-1982672005.png" class title="img">

<p>设置新密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202530519-730722560.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202651084-1127147532.png" class title="img">

<p> 至此，gitlab安装配置完成，接下来演示gitlab应用：</p>
<p>开发人员创建一个分支，然后发申请到主管请求合并到主分支，</p>
<p>回到gitbash命令行，首先删除之前的test-repo目录：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080255311-216023418.png" class title="img">

<p>然后使用dev账号登陆gitlab，并复制gitlab仓库地址：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080504843-764533681.png" class title="img">

<p>本地提交并推送到gitlab远端：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080550570-591512284.png" class title="img">

<p>开始提交合并到主分支的申请</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080711039-283092739.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080747722-293518077.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081015734-905282817.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081027714-647433423.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081223203-663097162.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081345859-1974744297.png" class title="img">

<p>接着退出当前的dev账号，使用lead账号登录，同样lead账号首次登录需要更改密码，步骤同dev一样：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081654799-1325405956.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081737842-576013049.png" class title="img">

 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081834712-1983955035.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082118521-107543261.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082235982-1151283651.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082302424-429176945.png" class title="img">



 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082334050-1662187133.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082350221-411675038.png" class title="img">

<p>jenkins的配置与使用见Jenkins+Gitlab+Ansible自动化部署(二)首先准备实验环境</p>
<table>
<thead>
<tr>
<th>虚拟机</th>
<th>主机名</th>
<th>IP地址</th>
<th>服务</th>
<th>系统版本</th>
<th>内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>Vmware Workstation 14</td>
<td>gitlab.example.com</td>
<td>192.168.244.130</td>
<td>gitlab</td>
<td>CentOS Linux release 7.5.1804 (Core)</td>
<td>3.10.0-862.el7.x86_64</td>
</tr>
<tr>
<td>jenkins.example.com</td>
<td>192.168.244.131</td>
<td>jenkis</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ansible.example.com</td>
<td>192.168.244.132</td>
<td>asible</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>除此之外，还要在宿主机win10系统下的C:\Windows\System32\drivers\etc\hosts文件中添加如下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.244.130 gitlab.example.com</span><br><span class="line">192.168.244.131 jenkins.example.com</span><br><span class="line">192.168.244.132 ansible.example.com</span><br></pre></td></tr></table></figure>

<p>关闭防火墙和selinux</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# sed -i &quot;s&#x2F;enforcing&#x2F;disabled&#x2F;&quot; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">[root@gitlab ~]# systemctl stop firewalld &amp;&amp; systemmctl disable firewalld</span><br><span class="line">[root@gitlab ~]# reboot</span><br><span class="line">[root@gitlab ~]# getenforce</span><br><span class="line">Permissive</span><br><span class="line">[root@server01 ~]# systemctl status firewalld</span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>安装postfix并启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# yum install postfix</span><br><span class="line">[root@gitlab ~]# systemctl start postfix &amp;&amp; systemctl enable postfix</span><br></pre></td></tr></table></figure>

<p>安装Gitlab组件及gitlab-ce</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# yum install curl policycoreutils openssh-server openssh-clients</span><br><span class="line">[root@gitlab ~]# curl -sS https:&#x2F;&#x2F;packages.gitlab.com&#x2F;install&#x2F;repositories&#x2F;gitlab&#x2F;gitlab-ce&#x2F;script.rpm.sh | sudo bash</span><br><span class="line">[root@gitlab ~]# yum install -y gitlab-ce </span><br></pre></td></tr></table></figure>

<p>也可以去<a href="https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E3%80%82">https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。</a></p>
<p>证书创建与配置加载</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# mkdir -p &#x2F;etc&#x2F;gitlab&#x2F;ssl </span><br><span class="line">创建私有密钥 </span><br><span class="line">[root@gitlab ~]# openssl genrsa -out &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.key&quot;  2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...............+++</span><br><span class="line">...............................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">创建私有证书</span><br><span class="line">[root@gitlab ~]# openssl req -new -key &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.key&quot;  -out &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.csr&quot;</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#39;.&#39;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:sh</span><br><span class="line">Locality Name (eg, city) [Default City]:sh</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:  #输入空格，然后回车</span><br><span class="line">Organizational Unit Name (eg, section) []:  #输入空格，然后回车</span><br><span class="line">Common Name (eg, your name or your server&#39;s hostname) []:gitlab.example.com</span><br><span class="line">Email Address []:admin@example.com</span><br><span class="line"></span><br><span class="line">Please enter the following &#39;extra&#39; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:123456</span><br><span class="line">An optional company name []:  #直接回车</span><br><span class="line">查看</span><br><span class="line">[root@gitlab ~]# ll &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span><br><span class="line">-rw-r--r-- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span><br><span class="line">接下来利用私有密钥和私有证书创建CRT签署证书</span><br><span class="line">[root@gitlab ~]# openssl x509 -req -days 365 -in &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.csr&quot; -signkey &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.key&quot; -out &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.crt&quot;</span><br><span class="line">Signature ok</span><br><span class="line">subject&#x3D;&#x2F;C&#x3D;cn&#x2F;ST&#x3D;sh&#x2F;L&#x3D;sh&#x2F;O&#x3D; &#x2F;OU&#x3D; &#x2F;CN&#x3D;gitlab.example.com&#x2F;emailAddress&#x3D;admin@example.com</span><br><span class="line">Getting Private key</span><br><span class="line">查看</span><br><span class="line">[root@gitlab ~]# ll &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root 1265 Jan  2 15:39 gitlab.example.com.crt</span><br><span class="line">-rw-r--r-- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span><br><span class="line">-rw-r--r-- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span><br><span class="line">利用openssl命令输出pem证书</span><br><span class="line">[root@gitlab ~]# openssl dhparam -out &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;dhparam.pem 2048</span><br><span class="line">Generating DH parameters, 2048 bit long safe prime, generator 2</span><br><span class="line">This is going to take a long time</span><br><span class="line">........................................................+................................................................................+.....................................+..................................................................................+..............................................+..................................................................................................................................+..+........................................................................................................................................+..............................................................................................................................................................................+......+..............+.....................................................+.................+.......................................................................................+..+.................................................................................................................................................+..........................................................+.............+.........+...........................................................+........................................................................................................................................................................................................................................+...................................................................................................................................................................................................................................................................................................................++*++*</span><br><span class="line">#  这个过程有点久</span><br><span class="line"># 查看生成的证书</span><br><span class="line">[root@gitlab ~]# ll &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 root root  424 Jan  2 15:46 dhparam.pem</span><br><span class="line">-rw-r--r-- 1 root root 1265 Jan  2 15:39 gitlab.example.com.crt</span><br><span class="line">-rw-r--r-- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span><br><span class="line">-rw-r--r-- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span><br><span class="line">更改文件权限</span><br><span class="line">[root@gitlab ~]# chmod 600 &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;*</span><br><span class="line">[root@gitlab ~]# ll &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br><span class="line">total 16</span><br><span class="line">-rw------- 1 root root  424 Jan  2 15:46 dhparam.pem</span><br><span class="line">-rw------- 1 root root 1265 Jan  2 15:39 gitlab.example.com.crt</span><br><span class="line">-rw------- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span><br><span class="line">-rw------- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>配置gitlab</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</span><br><span class="line">## 更改如下</span><br><span class="line"> 13 external_url &#39;https:&#x2F;&#x2F;gitlab.example.com&#39;  13行左右</span><br><span class="line">952 nginx[&#39;redirect_http_to_https&#39;] &#x3D; true</span><br><span class="line">964 nginx[&#39;ssl_certificate&#39;] &#x3D; &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.crt&quot;</span><br><span class="line">965 nginx[&#39;ssl_certificate_key&#39;] &#x3D; &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.key&quot;</span><br><span class="line">979 # nginx[&#39;ssl_dhparam&#39;] &#x3D; &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;dhparam.pem # Path to dhparams.pem,      eg. &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;dhparams.pem</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>初始化gitlab相关服务配置</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl reconfigure</span><br><span class="line">Starting Chef Client, version 13.6.4</span><br><span class="line">resolving cookbooks for run list: [&quot;gitlab&quot;]</span><br><span class="line">Synchronizing Cookbooks:</span><br><span class="line">  - gitlab (0.0.1)</span><br><span class="line">  - package (0.1.0)</span><br><span class="line">  - postgresql (0.1.0)</span><br><span class="line">  - redis (0.1.0)</span><br><span class="line">  - mattermost (0.1.0)</span><br><span class="line">  - registry (0.1.0)</span><br><span class="line">  - gitaly (0.1.0)</span><br><span class="line">  - consul (0.0.0)</span><br><span class="line">  - nginx (0.1.0)</span><br><span class="line">  - runit (0.14.2)</span><br><span class="line">  - letsencrypt (0.1.0)</span><br><span class="line">  - acme (3.1.0)</span><br><span class="line">  - crond (0.1.0)</span><br><span class="line">  - compat_resource (12.19.0)</span><br><span class="line">Installing Cookbook Gems:</span><br><span class="line">Compiling Cookbooks...</span><br><span class="line">Recipe: gitlab::default</span><br><span class="line">  * directory[&#x2F;etc&#x2F;gitlab] action create</span><br><span class="line">    - change mode from &#39;0755&#39; to &#39;0775&#39;</span><br><span class="line">  Converging 493 resources</span><br><span class="line">  * directory[&#x2F;etc&#x2F;gitlab] action create (up to date)</span><br><span class="line">  * directory[Create &#x2F;var&#x2F;opt&#x2F;gitlab] action create</span><br><span class="line">    - create new directory &#x2F;var&#x2F;opt&#x2F;gitlab</span><br><span class="line">    - change mode from &#39;&#39; to &#39;0755&#39;</span><br><span class="line">    - change owner from &#39;&#39; to &#39;root&#39;</span><br><span class="line">    - change group from &#39;&#39; to &#39;root&#39;</span><br><span class="line">  * directory[&#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;etc] action create</span><br><span class="line">    - create new directory &#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;etc</span><br><span class="line">    - change mode from &#39;&#39; to &#39;0755&#39;</span><br><span class="line">    - change owner from &#39;&#39; to &#39;root&#39;</span><br><span class="line">    - change group from &#39;&#39; to &#39;root&#39;</span><br><span class="line">  * template[&#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;etc&#x2F;gitconfig] action create</span><br><span class="line">    - create new file &#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;etc&#x2F;gitconfig</span><br><span class="line">    - update content in file &#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;etc&#x2F;gitconfig from none to 987af3</span><br><span class="line"></span><br><span class="line">。。。。过程有点长，需要等一会（看个人服务器配置了）</span><br><span class="line">Running handlers:</span><br><span class="line">Running handlers complete</span><br><span class="line">Chef Client finished, 454&#x2F;655 resources updated in 02 minutes 16 seconds</span><br><span class="line">gitlab Reconfigured!</span><br><span class="line"># 出现这个表示配置没有问题！</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>对nginx配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;nginx&#x2F;conf&#x2F;gitlab-http.conf&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;nginx&#x2F;conf&#x2F;gitlab-http.conf</span><br><span class="line"> 37   server_name gitlab.example.com; #在此行下面添加38行的内容</span><br><span class="line"> 38   rewrite ^(.*)$ https:&#x2F;&#x2F;$host$1 permanent;</span><br></pre></td></tr></table></figure>

<p>重启gitlab</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl restart</span><br><span class="line">ok: run: alertmanager: (pid 6526) 1s</span><br><span class="line">ok: run: gitaly: (pid 6543) 0s</span><br><span class="line">ok: run: gitlab-monitor: (pid 6556) 0s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 6579) 1s</span><br><span class="line">ok: run: logrotate: (pid 6589) 0s</span><br><span class="line">ok: run: nginx: (pid 6597) 1s</span><br><span class="line">ok: run: node-exporter: (pid 6681) 0s</span><br><span class="line">ok: run: postgres-exporter: (pid 6687) 1s</span><br><span class="line">ok: run: postgresql: (pid 6698) 0s</span><br><span class="line">ok: run: prometheus: (pid 6706) 0s</span><br><span class="line">ok: run: redis: (pid 6722) 0s</span><br><span class="line">ok: run: redis-exporter: (pid 6856) 0s</span><br><span class="line">ok: run: sidekiq: (pid 6866) 0s</span><br><span class="line">ok: run: unicorn: (pid 6880) 0s</span><br><span class="line">#  可以看出gitlab的所有服务重启完成</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>使用宿主机win10下的chrome浏览器访问gitlab.example.com:80</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164045215-3943660-20201126184445518.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164153110-1651878067-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164224914-827989240-20201126184445611.png" class title="img">

<p>开始使用gitlab</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164356206-501778199-20201126184445496.png" class title="img">

<p>创建一个测试工程</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164555544-1084217569-20201126184445512.png" class title="img">

<p>复制仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164808408-621505099-20201126184446008.png" class title="img">

<p>回到win10宿主机，重新打开一个git命令行窗口如下所示操作</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102165212447-658335923-20201126184445579.png" class title="img">

<p># 粘贴仓库地址回车后会弹出输入账户和密码的窗口</p>
<p>之后就会将空的测试仓库克隆到本地宿主机的桌面上的repo目录下</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line">Cloning into &#39;test-repo&#39;...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls test-repo&#x2F;</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>在win10宿主机下的test-repo目录下新建一个test.py文件，并上传至gitlab</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ vi test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in test.py.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">[master (root-commit) 93bd740] First Commit</span><br><span class="line"> Committer: unknown &lt;xueji@pin.com&gt;</span><br><span class="line">Your name and email address were configured automatically based</span><br><span class="line">on your username and hostname. Please check that they are accurate.</span><br><span class="line">You can suppress this message by setting them explicitly. Run the</span><br><span class="line">following command and follow the instructions in your editor to edit</span><br><span class="line">your configuration file:</span><br><span class="line"></span><br><span class="line">    git config --global --edit</span><br><span class="line"></span><br><span class="line">After doing this, you may fix the identity used for this commit with:</span><br><span class="line"></span><br><span class="line">    git commit --amend --reset-author</span><br><span class="line"></span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config  --global user.email &quot;admin@example.com&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.name &quot;admin&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">Your branch is based on &#39;origin&#x2F;master&#39;, but the upstream is gone.</span><br><span class="line">  (use &quot;git branch --unset-upstream&quot; to fixup)</span><br><span class="line"></span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push master</span><br><span class="line">fatal: &#39;master&#39; does not appear to be a git repository</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>报错，跟据提示信息我们进行如下操作</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git branch --unset-upstream</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.email &quot;admin@example.com&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git config --global user.name &quot;admin&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;First Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git commit -m&quot;Second Commit&quot;</span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push origin master</span><br><span class="line">Enumerating objects: 3, done.</span><br><span class="line">Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">Writing objects: 100% (3&#x2F;3), 242 bytes | 242.00 KiB&#x2F;s, done.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>回到gitlab的浏览器页面，刷新查看</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172541680-1685258190-20201126184445604.png" class title="img">

<p>已经成功上传到test-repo工程当中。</p>
<p>Gitlab应用</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172834006-957477766-20201126184445611.png" class title="img">

<p>比如说Systeminfo</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173017476-1297762493-20201126184445660.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173108736-1671134778-20201126184445736.png" class title="img">

<p>比如说日志</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173204986-1045231309-20201126184445725.png" class title="img">

<p>需要我们关注的是application.log和production.log两项</p>
<p>比如说健康状况</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173522576-1583433372-20201126184445693.png" class title="img">

<p>创建开发人员及leader的账号</p>
<p>开发人员账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173648091-57729423-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173839541-132784246-20201126184445804.png" class title="img">

<p>其他选项不要动，点击创建即可。</p>
<p>创建leader的账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174006279-1152234077-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174112736-1497099430-20201126184445855.png" class title="img">

<p>其他也不要动。</p>
<p>建好后的账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174214548-2047513172-20201126184445822.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174323576-45552471-20201126184445885.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174428809-1250049533-20201126184445881.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174525431-600068675-20201126184445868.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174619643-830800285-20201126184445911.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174809969-1580189936-20201126184445953.png" class title="img">

<p>同理添加lead账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175038572-8109703-20201126184445956.png" class title="img">

<p>更改两个账户的密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175340108-1125836966-20201126184445994.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175430628-339857982-20201126184445956.png" class title="img">

<p>其他选项保持不变，然后点击页面最下面的save changes，同理更改lead的密码</p>
<p>使用dev账户进行git命令行的提交操作</p>
<p>[</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 以下步骤也是在win10宿主机上进行的</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo&#x2F;test-repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ cd ..</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ rm -rf test-repo&#x2F;</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line">Cloning into &#39;test-repo&#39;...</span><br><span class="line">remote: Enumerating objects: 3, done.</span><br><span class="line">remote: Counting objects: 100% (3&#x2F;3), done.</span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (3&#x2F;3), done.</span><br><span class="line">#  这一步就很尴尬了，本来是想要验证dev账户的，谁知道什么都不需要输入就直接可以clone下来。</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ ls test-repo&#x2F;</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd test-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (master)</span><br><span class="line">$ git checkout -b release-1.0   #创建开发人员版本</span><br><span class="line">Switched to a new branch &#39;release-1.0&#39;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ ls</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ vim test.py</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ cat test.py</span><br><span class="line">print(&quot;This is a test python file for release-1.0!&quot;)</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;test-repo (release-1.0)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false push origin release-1.0</span><br><span class="line">Enumerating objects: 5, done.</span><br><span class="line">Counting objects: 100% (5&#x2F;5), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (2&#x2F;2), done.</span><br><span class="line">Writing objects: 100% (3&#x2F;3), 287 bytes | 287.00 KiB&#x2F;s, done.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote:</span><br><span class="line">remote: To create a merge request for release-1.0, visit:</span><br><span class="line">remote:   https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo&#x2F;merge_requests&#x2F;new?merge_request%5Bsource_branch%5D&#x3D;release-1.0</span><br><span class="line">remote:</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;test-repo.git</span><br><span class="line"> * [new branch]      release-1.0 -&gt; release-1.0</span><br><span class="line">#  我靠，估计版本不一样，这一步不需要输入账户名和密码</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>返回gitlab的浏览器页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180851535-2098739677-20201126184446074.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180912746-365779940-20201126184446074.png" class title="img">

<p> 使用开发账户登录</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202149369-1982672005-20201126184446054.png" class title="img">

<p>设置新密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202530519-730722560-20201126184446048.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202651084-1127147532-20201126184446161.png" class title="img">

<p> 至此，gitlab安装配置完成，接下来演示gitlab应用：</p>
<p>开发人员创建一个分支，然后发申请到主管请求合并到主分支，</p>
<p>回到gitbash命令行，首先删除之前的test-repo目录：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080255311-216023418-20201126184446016.png" class title="img">

<p>然后使用dev账号登陆gitlab，并复制gitlab仓库地址：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080504843-764533681-20201126184446171.png" class title="img">

<p>本地提交并推送到gitlab远端：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080550570-591512284-20201126184446196.png" class title="img">

<p>开始提交合并到主分支的申请</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080711039-283092739-20201126184446189.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080747722-293518077-20201126184446205.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081015734-905282817-20201126184446180.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081027714-647433423-20201126184446274.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081223203-663097162-20201126184446308.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081345859-1974744297-20201126184446354.png" class title="img">

<p>接着退出当前的dev账号，使用lead账号登录，同样lead账号首次登录需要更改密码，步骤同dev一样：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081654799-1325405956-20201126184446283.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081737842-576013049-20201126184446292.png" class title="img">

 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081834712-1983955035-20201126184446391.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082118521-107543261-20201126184446416.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082235982-1151283651-20201126184446371.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082302424-429176945-20201126184446391.png" class title="img">



 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082334050-1662187133-20201126184446418.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082350221-411675038-20201126184446449.png" class title="img">

<p>jenkins的配置与使用见Jenkins+Gitlab+Ansible自动化部署(二)</p>
]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(二)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%8C)/</url>
    <content><![CDATA[<p>接Jenkins+Gitlab+Ansbile自动化部署(一):</p>
<p><a href="https://sugw.github.io/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/">https://sugw.github.io/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/</a></p>
<p>Ansible的配置与部署</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>Chef</td>
<td>采用Ruby编写，C/S架构，配置需要Git依赖，Recipe脚本编写规范，需要良好的编程经验。</td>
</tr>
<tr>
<td>Ansible</td>
<td>采用Python编写，无Client，模块化配置管理，Playbook脚本编写规范，易于上手，适合中小规模快速部署。</td>
</tr>
<tr>
<td>Saltstack</td>
<td>采用Python编写，C/S架构，模块化配置管理，YAML脚本编写规范，内置异步文件服务器可以为客户端文件加快服务速度，适合大规模集群部署，但是需要安装客户端。</td>
</tr>
</tbody></table>
<p>Ansible的优势和应用场景</p>
<p>优势：</p>
<ul>
<li>轻量级无客户端（Agentless）；</li>
<li>开源免费，学习成本低，快速上手；</li>
<li>使用playbook作为核心配置架构，同意的脚本格式批量化部署；</li>
<li>完善的模块化扩展，支持目前主流的开发环境；</li>
<li>强大的稳定性和兼容性；</li>
<li>活跃的官方社区问题讨论，方便troubleshooting与debug问题；</li>
</ul>
<p>Ansible配合virtualenv安装配置</p>
<p>使用python自带的python virtualenv工具隔离Python3.6、Ansible2.5和系统其他python依赖环境。</p>
<p>Ansible安装方式</p>
<p>1.yum一键安装（不推荐） </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]# yum install -y ansible</span><br><span class="line"># 虽然简单，但是会带来一系列的依赖和模块混乱</span><br></pre></td></tr></table></figure>

<p>2.Git源码安装（推荐）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># yum install -y git      #如果系统中没有git的话，使用这条命令安装即可</span></span><br><span class="line">[root@ansible ~]<span class="comment"># git clone https://github.com/ansible/ansible.git</span></span><br></pre></td></tr></table></figure>

<p>Ansible2.5+Python3.6安装步骤</p>
<p>1.安装python3.6.5和virtualenv工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]# wget http:&#x2F;&#x2F;www.python.org&#x2F;ftp&#x2F;python&#x2F;3.6.5&#x2F;Python-3.6.5.tar.xz</span><br><span class="line">[root@ansible ~]# tar -xf Python-3.6.5.tar.xz -C &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">[root@ansible ~]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;Python-3.6.5&#x2F;</span><br><span class="line">[root@ansible ~]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;Python-3.6.5&#x2F;</span><br><span class="line">[root@ansible Python-3.6.5]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F; --with-ensurepip&#x3D;install --enable-shared LDFLAGS&#x3D;&quot;-Wl,-rpath &#x2F;usr&#x2F;local&#x2F;lib&quot;</span><br><span class="line">#竟然报错</span><br><span class="line">configure: error: in &#96;&#x2F;usr&#x2F;local&#x2F;src&#x2F;Python-3.6.5&#39;:</span><br><span class="line">configure: error: no acceptable C compiler found in $PATH</span><br><span class="line">See &#96;config.log&#39; for more details</span><br><span class="line"># 根据报错信息，需要安装GCC套件</span><br><span class="line">[root@ansible Python-3.6.5]# yum install -y gcc </span><br><span class="line"># 然后再次执行编译操作，完事执行安装</span><br><span class="line">[root@ansible Python-3.6.5]# make &amp;&amp; make altinstall</span><br><span class="line"># 然而又报错了</span><br><span class="line">....</span><br><span class="line">    import pip</span><br><span class="line">zipimport.ZipImportError: can&#39;t decompress data; zlib not available</span><br><span class="line">make: *** [altinstall] Error 1</span><br><span class="line"># 提示很明显了直接执行</span><br><span class="line">[root@ansible Python-3.6.5]# yum install zlib*</span><br><span class="line"># 然后再吃运行安装命令即可</span><br><span class="line">[root@ansible Python-3.6.5]# make &amp;&amp; make altinstall</span><br><span class="line"># 当看到</span><br><span class="line">.....</span><br><span class="line">Collecting setuptools</span><br><span class="line">Collecting pip</span><br><span class="line">Installing collected packages: setuptools, pip</span><br><span class="line">Successfully installed pip-9.0.3 setuptools-39.0.1</span><br><span class="line"># 表明安装成功</span><br><span class="line"># 接着安装virtualenv,然而并不顺利</span><br><span class="line">[root@ansible bin]# pwd</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line">[root@ansible bin]# .&#x2F;pip --trusted-host pypi.python.org install virtualenv</span><br><span class="line">pip is configured with locations that require TLS&#x2F;SSL, however the ssl module in Python is not available.</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Retrying (Retry(total&#x3D;4, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;3, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;2, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;1, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;0, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Could not fetch URL https:&#x2F;&#x2F;pypi.python.org&#x2F;simple&#x2F;virtualenv&#x2F;: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host&#x3D;&#39;pypi.python.org&#39;, port&#x3D;443): Max retries exceeded with url: &#x2F;simple&#x2F;virtualenv&#x2F; (Caused by SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)) - skipping</span><br><span class="line">  Could not find a version that satisfies the requirement virtualenv (from versions: )</span><br><span class="line">No matching distribution found for virtualenv</span><br><span class="line"># 使用网友提供的方法  加上--trusted-host参数，哦...依然不行</span><br><span class="line">[root@ansible bin]# .&#x2F;pip --trusted-host pypi.python.org install virtualenv</span><br><span class="line">pip is configured with locations that require TLS&#x2F;SSL, however the ssl module in Python is not available.</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Retrying (Retry(total&#x3D;4, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;3, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;2, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;1, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Retrying (Retry(total&#x3D;0, connect&#x3D;None, read&#x3D;None, redirect&#x3D;None, status&#x3D;None)) after connection broken by &#39;SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)&#39;: &#x2F;simple&#x2F;virtualenv&#x2F;</span><br><span class="line">  Could not fetch URL https:&#x2F;&#x2F;pypi.python.org&#x2F;simple&#x2F;virtualenv&#x2F;: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host&#x3D;&#39;pypi.python.org&#39;, port&#x3D;443): Max retries exceeded with url: &#x2F;simple&#x2F;virtualenv&#x2F; (Caused by SSLError(&quot;Can&#39;t connect to HTTPS URL because the SSL module is not available.&quot;,)) - skipping</span><br><span class="line">  Could not find a version that satisfies the requirement virtualenv (from versions: )</span><br><span class="line">No matching distribution found for virtualenv</span><br><span class="line"># 根据第一行报错提示</span><br><span class="line">pip is configured with locations that require TLS&#x2F;SSL, however the ssl module in Python is not available</span><br><span class="line"># 需要安装openssl相关软件包</span><br><span class="line">[root@ansible bin]# yum install -y openssl*</span><br><span class="line">#除此之外，卸载掉python2.7安装的pip防止干扰</span><br><span class="line">[root@ansible bin]# python -m pip uninstall pip</span><br><span class="line">Uninstalling pip-18.1:</span><br><span class="line">  Would remove:</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;pip</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;pip2</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;pip2.7</span><br><span class="line">    &#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pip-18.1.dist-info&#x2F;*</span><br><span class="line">    &#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pip&#x2F;*</span><br><span class="line">Proceed (y&#x2F;n)? y</span><br><span class="line">  Successfully uninstalled pip-18.1</span><br><span class="line"># 然后回到解压包里，重新运行编译安装过程</span><br><span class="line">[root@ansible Python-3.6.5]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F; --with-ensurepip&#x3D;install --enable-shared LDFLAGS&#x3D;&quot;-Wl,-rpath &#x2F;usr&#x2F;local&#x2F;lib&quot;</span><br><span class="line">[root@ansible Python-3.6.5]# make &amp;&amp; make altinstall </span><br><span class="line">.......</span><br><span class="line">Requirement already satisfied: setuptools in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.6&#x2F;site-packages</span><br><span class="line">Requirement already satisfied: pip in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.6&#x2F;site-packages</span><br><span class="line">[root@ansible Python-3.6.5]# cd ..&#x2F;..&#x2F;bin&#x2F;</span><br><span class="line">[root@ansible bin]# ll</span><br><span class="line">total 68</span><br><span class="line">-rwxr-xr-x. 1 root root   101 Jan  7 11:42 2to3-3.6</span><br><span class="line">-rwxr-xr-x. 1 root root   242 Jan  7 11:00 easy_install-3.6</span><br><span class="line">-rwxr-xr-x. 1 root root    99 Jan  7 11:42 idle3.6</span><br><span class="line">lrwxrwxrwx. 1 root root    21 Jan  7 11:03 pip -&gt; &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip3.6</span><br><span class="line">-rwxr-xr-x. 1 root root   214 Jan  7 11:00 pip3.6</span><br><span class="line">-rwxr-xr-x. 1 root root    84 Jan  7 11:42 pydoc3.6</span><br><span class="line">-rwxr-xr-x. 2 root root 17712 Jan  7 11:41 python3.6</span><br><span class="line">-rwxr-xr-x. 2 root root 17712 Jan  7 11:41 python3.6m</span><br><span class="line">-rwxr-xr-x. 1 root root  3109 Jan  7 11:42 python3.6m-config</span><br><span class="line">-rwxr-xr-x. 1 root root   441 Jan  7 11:42 pyvenv-3.6</span><br><span class="line">[root@ansible bin]# ln -s &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip3.6 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pip</span><br><span class="line"># 再次使用pip安装virtualenv</span><br><span class="line">[root@ansible bin]# pip install virtualenv</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Cache entry deserialization failed, entry ignored</span><br><span class="line">  Cache entry deserialization failed, entry ignored</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;6a&#x2F;d1&#x2F;e0d142ce7b8a5c76adbfad01d853bca84c7c0240e35577498e20bc2ade7d&#x2F;virtualenv-16.2.0-py2.py3-none-any.whl (1.9MB)</span><br><span class="line">    100% |████████████████████████████████| 1.9MB 64kB&#x2F;s</span><br><span class="line">Requirement already satisfied: setuptools&gt;&#x3D;18.0.0 in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.6&#x2F;site-packages (from virtualenv)</span><br><span class="line">Installing collected packages: virtualenv</span><br><span class="line">Successfully installed virtualenv-16.2.0</span><br><span class="line">You are using pip version 9.0.3, however version 18.1 is available.</span><br><span class="line">You should consider upgrading via the &#39;pip install --upgrade pip&#39; command.</span><br><span class="line"># 安装成功</span><br></pre></td></tr></table></figure>



<p>2.创建ansible账户并安装python3.6.5版本virtualenv实例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># useradd deploy &amp;&amp; su - deploy</span></span><br><span class="line">[deploy@ansible ~]$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python3.6 .py3-a2.5-env</span><br><span class="line">Already using interpreter /usr/<span class="built_in">local</span>/bin/python3.6</span><br><span class="line">Using base prefix <span class="string">&#x27;/usr/local&#x27;</span></span><br><span class="line">New python executable <span class="keyword">in</span> /home/deploy/.py3-a2.5-env/bin/python3.6</span><br><span class="line">Also creating executable <span class="keyword">in</span> /home/deploy/.py3-a2.5-env/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">[deploy@ansible ~]$</span><br></pre></td></tr></table></figure>

<p>3.Git源码安装ansible2.5</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先使用root账户确保git nss curl命令已经安装</span></span><br><span class="line">[root@ansible ~]<span class="comment"># yum install -y git nss curl</span></span><br><span class="line"><span class="comment"># 然后切到deploy用户，进入之前创建的.py3-a2.5-env目录下</span></span><br><span class="line">[deploy@ansible ~]$ <span class="built_in">cd</span> /home/deploy/.py3-a2.5-env/</span><br><span class="line">[deploy@ansible .py3-a2.5-env]$ git <span class="built_in">clone</span> https://github.com/ansible/ansible.git</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>加载python3.6.5 virtualenv环境</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[deploy@ansible .py3-a2.5-env]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible .py3-a2.5-env]$</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装ansible依赖包</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 安装依赖包</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible .py3-a2.5-env]$ pip install paramiko PyYAML jinja2</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible .py3-a2.5-env]$ ll</span><br><span class="line">total 8</span><br><span class="line">drwxrwxr-x. 14 deploy deploy 4096 Jan  7 13:31 ansible</span><br><span class="line">drwxrwxr-x.  2 deploy deploy 4096 Jan  7 11:52 bin</span><br><span class="line">drwxrwxr-x.  2 deploy deploy   24 Jan  7 11:52 include</span><br><span class="line">drwxrwxr-x.  3 deploy deploy   23 Jan  7 11:52 lib</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible .py3-a2.5-env]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>在python3.6.5虚拟环境下加载ansible2.5</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 确认ansible源码包在.py3-a2.5-env目录下</span><br><span class="line"># 进入ansible目录</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible .py3-a2.5-env]$ cd ansible&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ansible]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ansible]$ git checkout stable-2.5  #将ansible切换到2.5版本</span><br><span class="line">Branch stable-2.5 set up to track remote branch stable-2.5 from origin.</span><br><span class="line">Switched to a new branch &#39;stable-2.5&#39;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ansible]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q  #在此虚拟环境下加载ansible2.5版本</span><br></pre></td></tr></table></figure>

<p>7.验证ansible版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible ansible]$ ansible --version</span><br><span class="line">ansible 2.5.14 (stable-2.5 6548b7a558) last updated 2019&#x2F;01&#x2F;07 13:56:01 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible</span><br><span class="line">  python version &#x3D; 3.6.5 (default, Jan  7 2019, 11:40:52) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line"># 至此ansible2.5在虚拟环境下安装加载完成</span><br></pre></td></tr></table></figure>

<p>Playbooks框架与格式</p>
<table>
<thead>
<tr>
<th>父目录</th>
<th>1级子目录</th>
<th>2级子目录</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>inventory/</td>
<td>Server详细清单目录</td>
<td>用来保存主机域名、IP地址和相关参数</td>
<td></td>
</tr>
<tr>
<td></td>
<td>testenv</td>
<td>具体清单与变量声明文件</td>
<td></td>
</tr>
<tr>
<td>roles/</td>
<td>roles任务列表</td>
<td>可以存放一个或多个role</td>
<td></td>
</tr>
<tr>
<td></td>
<td>testbox/</td>
<td>testbox详细任务</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>tasks/</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>main.yml</td>
<td>testbox主任务文件</td>
</tr>
<tr>
<td>deploy.yml</td>
<td>Playbook任务入口文件</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>格式说明</p>
<table>
<thead>
<tr>
<th>testenv文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>[testservers]</td>
<td>Server组列表</td>
</tr>
<tr>
<td>test.example.com</td>
<td>目标部署服务器主机名</td>
</tr>
<tr>
<td>[testservers:vars]</td>
<td>Server组列表参数</td>
</tr>
<tr>
<td>server_name=test,example.com</td>
<td>目标主机Key/Value参数</td>
</tr>
<tr>
<td>user=root</td>
<td></td>
</tr>
<tr>
<td>output=/root/test.txt</td>
<td></td>
</tr>
</tbody></table>
<p>主任务文件main.yml</p>
<table>
<thead>
<tr>
<th>文件内容</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>- name:Print Server name and user to remote testbox</td>
<td>任务名称</td>
</tr>
<tr>
<td>shell:”echo ‘Currently is logining ‘ &gt; “</td>
<td>shell:使用shell模块执行命令</td>
</tr>
<tr>
<td>inventory/testenv文件[testservers:vars]server_name=test.example.comuser=rootoutput=/root/test.txt</td>
<td></td>
</tr>
</tbody></table>
<p>任务入口文件deploy.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- hosts:&quot;testservers&quot;      #Server列表</span><br><span class="line">  gather_facts:true         #获取Server基本信息   </span><br><span class="line">   remote_user:root        # 目标服务器系统用户指定</span><br><span class="line">   roles:</span><br><span class="line">   - testbox                      #进入roles&#x2F;testbox任务目录</span><br></pre></td></tr></table></figure>

<p>登录ansible主机，加载之前配置好的python3.6.5和ansible2.5环境，并验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]# su - deploy</span><br><span class="line">Last login: Mon Jan  7 11:51:41 CST 2019 on pts&#x2F;1</span><br><span class="line">[deploy@ansible ~]$ source .py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ source .py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook 2.5.14 (stable-2.5 6548b7a558) last updated 2019&#x2F;01&#x2F;07 13:56:01 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible-playbook</span><br><span class="line">  python version &#x3D; 3.6.5 (default, Jan  7 2019, 11:40:52) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br></pre></td></tr></table></figure>

<p>开始编写playbooks</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ mkdir test-playbooks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ cd test-playbooks&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir inventory</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ cd inventory</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible inventory]$ vim testenv</span><br><span class="line">[testservers]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[testservers:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">user&#x3D;root</span><br><span class="line">output&#x3D;&#x2F;root&#x2F;test.txt</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible inventory]$ cd ..</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ls</span><br><span class="line">inventory  roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ cd roles&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible roles]$ mkdir testbox</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible roles]$ cd testbox&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible testbox]$ mkdir tasks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible testbox]$ cd tasks&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible tasks]$ vim main.yml</span><br><span class="line">- name: Print server name and user to remote testbox</span><br><span class="line">  shell:&quot;echo &#39;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#39; &gt; &#123;&#123; output &#125;&#125;&quot;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible tasks]$ cd ..&#x2F;..&#x2F;..</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;test-playbooks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible tasks]$ cd ..&#x2F;..&#x2F;..</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;test-playbooks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim deploy.yml</span><br><span class="line"></span><br><span class="line">- hosts: &quot;testservers&quot;</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">  - testbox</span><br></pre></td></tr></table></figure>



<p>查看test_playbooxs目录结构</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ tree .</span><br><span class="line">.</span><br><span class="line">├── deploy.yml</span><br><span class="line">├── inventory</span><br><span class="line">│?? └── testenv</span><br><span class="line">└── roles</span><br><span class="line">    └── testbox</span><br><span class="line">        └── tasks</span><br><span class="line">            └── main.yml</span><br><span class="line"></span><br><span class="line">4 directories, 3 files</span><br></pre></td></tr></table></figure>

<p>这里需要另外一台测试被部署机器test.example.com</p>
<table>
<thead>
<tr>
<th>系统版本</th>
<th>主机名</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>CentOS Linux release 7.5.1804 (core)</td>
<td>test.example.com</td>
<td>20.10.1.209</td>
</tr>
</tbody></table>
<p>被部署的机器test.example.com与其他三台主机实验环境一致。</p>
<p>配置SSH免秘钥认证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ su - root</span><br><span class="line">Password:</span><br><span class="line">Last login: Mon Jan  7 10:05:23 CST 2019 from 192.168.244.1 on pts&#x2F;1</span><br><span class="line">[root@ansible ~]# vim &#x2F;etc&#x2F;hosts</span><br><span class="line">....</span><br><span class="line">192.168.244.133 test.example.com</span><br><span class="line">[root@ansible ~]# exit</span><br><span class="line">logout</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh-keygen -t rsa</span><br><span class="line">Generating public&#x2F;private rsa key pair.</span><br><span class="line">Enter file in which to save the key (&#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa):</span><br><span class="line">Created directory &#39;&#x2F;home&#x2F;deploy&#x2F;.ssh&#39;.</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in &#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.</span><br><span class="line">Your public key has been saved in &#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:Aj+FzKSwqZS19eI&#x2F;3EQt13L78+u3vjMtseX8YXNFnnY deploy@ansible.example.com</span><br><span class="line">The key&#39;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|  .. ..          |</span><br><span class="line">|  o+o&#x3D;..  . .    |</span><br><span class="line">| oo.o.+..o + o  .|</span><br><span class="line">|..  .o... o o .o.|</span><br><span class="line">|.    .+ S.   . oE|</span><br><span class="line">|      ooo     + +|</span><br><span class="line">|       + .     %o|</span><br><span class="line">|        .     +o@|</span><br><span class="line">|              oB@|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh-copy-id -i &#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.pub root@test.example.com</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: Source of key(s) to be installed: &quot;&#x2F;home&#x2F;deploy&#x2F;.ssh&#x2F;id_rsa.pub&quot;</span><br><span class="line">The authenticity of host &#39;test.example.com (192.168.244.133)&#39; can&#39;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:66hu+WU6R2SL4+7r&#x2F;WYk2kjrGi7IwjuJieTrdMhwLc0.</span><br><span class="line">ECDSA key fingerprint is MD5:af:c7:bd:88:0d:40:d8:19:6d:28:7f:dd:af:aa:3a:c9.</span><br><span class="line">Are you sure you want to continue connecting (yes&#x2F;no)? yes</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">&#x2F;bin&#x2F;ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@test.example.com&#39;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &#39;root@test.example.com&#39;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  7 17:35:38 2019 from 192.168.244.1</span><br><span class="line">[root@test ~]# whoami</span><br><span class="line">root</span><br><span class="line">[root@test ~]# hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>测试部署</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ cd test-playbooks&#x2F;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ls</span><br><span class="line">deploy.yml  inventory  roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;2    changed&#x3D;1    unreachable&#x3D;0    failed&#x3D;0  </span><br><span class="line"># 以下内容可以看出已经成功在远程被部署主机test.example.com上创建一个test.txt文件，且文件内容与预先设置的一致</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  7 17:42:57 2019 from 192.168.244.132</span><br><span class="line">[root@test ~]# ls</span><br><span class="line">anaconda-ks.cfg  test.txt</span><br><span class="line">[root@test ~]# cat test.txt</span><br><span class="line">Currently root is loggging test.example.com</span><br></pre></td></tr></table></figure>



<p>Ansible Playbooks常用模块</p>
<p>File模块：</p>
<p>在目标主机创建文件或目录，并赋予其系统权限，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: create a file   # 任务名称</span><br><span class="line">  file: &#39;path&#x3D;&#x2F;root&#x2F;a.txt state&#x3D;touch mode&#x3D;0755 owner&#x3D;sishen group&#x3D;sishen&#39;</span><br><span class="line"># 任务内容</span><br></pre></td></tr></table></figure>

<p>Copy模块：</p>
<p>实现Ansible服务端到目标主机的文件传送，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: copy a file   #任务名称 复制一个文件</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;testbox&#x2F;files&#x2F;test.sh dest&#x3D;&#x2F;root&#x2F;test.sh mode&#x3D;0644 force&#x3D;yes&#39;</span><br><span class="line"></span><br><span class="line"># 说明</span><br><span class="line">remote_src:声明将ansible服务端文件传送到目标主机当中</span><br><span class="line">src:源文件的路径</span><br><span class="line">dest:目标文件的路径</span><br><span class="line">mode:赋予的文件权限</span><br><span class="line">force:强制执行</span><br></pre></td></tr></table></figure>

<p>Stat模块：</p>
<p>获取远程文件状态信息，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: check if test.sh exists</span><br><span class="line">  stat: &#39;path&#x3D;&#x2F;root&#x2F;test.sh&#39;   #需要获取的文件路径</span><br><span class="line">  register: script_stat           #将stat变量获取到的信息传递给script_stat</span><br></pre></td></tr></table></figure>

<p>Debug模块：</p>
<p>打印语句到Ansible执行输出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- debug: msf&#x3D;test.sh exists</span><br><span class="line">  when:script_stat.stat.exists</span><br></pre></td></tr></table></figure>

<p>Command/Shell模块</p>
<p>用来执行Linux目标主机命令行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: run the script</span><br><span class="line">  command: &quot;sh &#x2F;root&#x2F;test.sh&quot;</span><br><span class="line"></span><br><span class="line">- name: run the script</span><br><span class="line">  shell: &quot;echo &#39;test&#39; &gt; &#x2F;root&#x2F;test.txt&quot; (推荐)</span><br></pre></td></tr></table></figure>

<p>Template模块</p>
<p>实现Ansible服务端到目标主机的jinja2模板传送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: write the nginx config file</span><br><span class="line">  template: src&#x3D;roles&#x2F;testbox&#x2F;templates&#x2F;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>Packaging模块</p>
<p>调用目标主机系统包管理工具(yum，apt)进行安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  yum: pkg&#x3D;nginx state&#x3D;latest  #(CentOS&#x2F;RHEL)</span><br><span class="line"></span><br><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  apt: pkg&#x3D;nginx state&#x3D;latest    #(Debian&#x2F;Ubuntu)</span><br></pre></td></tr></table></figure>

<p>Service模块</p>
<p>管理目标主机系统服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- name: start nginx service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;started</span><br></pre></td></tr></table></figure>

<p>登录被部署主机，创建测试用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  7 17:44:56 2019 from 192.168.244.132</span><br><span class="line">[root@test ~]# useradd sishen</span><br><span class="line">useradd: user &#39;sishen&#39; already exists</span><br><span class="line">[root@test ~]# useradd god</span><br><span class="line">[root@test ~]# useradd deploy</span><br><span class="line">[root@test ~]# mkdir &#x2F;etc&#x2F;nginx</span><br><span class="line">[root@test ~]# rpm -Uvh http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;noarch&#x2F;RPMS&#x2F;nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class="line">Retrieving http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;noarch&#x2F;RPMS&#x2F;nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class="line">warning: &#x2F;var&#x2F;tmp&#x2F;rpm-tmp.i5SPeu: Header V4 RSA&#x2F;SHA1 Signature, key ID 7bd9bf62: NOKEY</span><br><span class="line">Preparing...                                                            (100%################################# [100%]</span><br><span class="line">Updating &#x2F; installing...</span><br><span class="line">   1:nginx-release-centos-7-0.el7.ngx                                   ( 81%################################# [100%]</span><br></pre></td></tr></table></figure>



<p>退出被部署主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@test ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to test.example.com closed.</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ pwd</span><br><span class="line">&#x2F;home&#x2F;deploy&#x2F;test-playbooks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ls</span><br><span class="line">deploy.yml  inventory  roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;tasks&#x2F;main.yml</span><br><span class="line">- name: Print server name and user to remote testbox</span><br><span class="line">  shell: &quot;echo &#39;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#39; &gt; &#123;&#123; output &#125;&#125;&quot;</span><br><span class="line">#添加以下内容</span><br><span class="line">- name: create a file</span><br><span class="line">  file: &#39;path&#x3D;&#x2F;root&#x2F;god.txt state&#x3D;touch mode&#x3D;0755 owner&#x3D;god group&#x3D;god&#39;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : create a file] *************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;3    changed&#x3D;2    unreachable&#x3D;0    failed&#x3D;0  </span><br></pre></td></tr></table></figure>



<p>登录到远程主机查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  7 19:05:41 2019 from 192.168.244.132</span><br><span class="line">[root@test ~]# ls -l</span><br><span class="line">total 8</span><br><span class="line">-rw-------. 1 root root 1732 Dec 26 20:03 anaconda-ks.cfg</span><br><span class="line">-rwxr-xr-x. 1 god  god     0 Jan  7 19:05 god.txt  #已经成功创建并赋予文件权限</span><br><span class="line">-rw-r--r--. 1 root root   44 Jan  7 19:05 test.txt</span><br></pre></td></tr></table></figure>



<p>或者直接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com ls -l  &#x2F;root&#x2F;god.txt</span><br><span class="line">-rwxr-xr-x. 1 god god 0 Jan  7 19:05 &#x2F;root&#x2F;god.txt</span><br></pre></td></tr></table></figure>

<p>创建god.sh</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir roles&#x2F;testbox&#x2F;files</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;files&#x2F;god.sh</span><br><span class="line">echo &quot;this is a test script&quot;</span><br><span class="line">echo &quot;If you see this message, the script is executed successfully.&quot;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;tasks&#x2F;main.yml</span><br><span class="line">- name: Print server name and user to remote testbox</span><br><span class="line">  shell: &quot;echo &#39;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#39; &gt; &#123;&#123; output &#125;&#125;&quot;</span><br><span class="line">- name: create a file</span><br><span class="line">  file: &#39;path&#x3D;&#x2F;root&#x2F;god.txt state&#x3D;touch mode&#x3D;0755 owner&#x3D;god group&#x3D;god&#39;</span><br><span class="line">#添加以下内容</span><br><span class="line">- name: copy a file</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;testbox&#x2F;files&#x2F;god.sh dest&#x3D;&#x2F;root&#x2F;god.sh mode&#x3D;0644 force&#x3D;yes&#39;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br></pre></td></tr></table></figure>



<p>验证并查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com ls -l &#x2F;root&#x2F;god.sh</span><br><span class="line">-rw-r--r--. 1 root root 99 Jan  7 19:19 &#x2F;root&#x2F;god.sh</span><br></pre></td></tr></table></figure>

<p>演示stat与debug模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;tasks&#x2F;main.yml</span><br><span class="line">....</span><br><span class="line"># 文件末尾添加以下内容</span><br><span class="line">- name: check if god.sh exists</span><br><span class="line">  stat: &#39;path&#x3D;&#x2F;root&#x2F;gid.sh&#39;</span><br><span class="line">  register: script_stat</span><br><span class="line"></span><br><span class="line">- debug: msg&#x3D;&quot;god.sh exists&quot;</span><br><span class="line">  when: script_stat.stat.exists</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : create a file] *************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : copy a file] ***************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : check if god.sh exists] ****************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : debug] *********************************************************</span><br><span class="line">ok: [test.example.com] &#x3D;&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;god.sh exists&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;6    changed&#x3D;2    unreachable&#x3D;0    failed&#x3D;0  </span><br><span class="line"></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span><br></pre></td></tr></table></figure>



<p>演示command模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;tasks&#x2F;main.yml</span><br><span class="line"># 末尾添加以下内容</span><br><span class="line">- name: run the script</span><br><span class="line">  command: &#39;sh &#x2F;root&#x2F;god.sh&#39;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : create a file] *************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : copy a file] ***************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : check if god.sh exists] ****************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : debug] *********************************************************</span><br><span class="line">ok: [test.example.com] &#x3D;&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;god.sh exists&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [testbox : run the script] ************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;7    changed&#x3D;3    unreachable&#x3D;0    failed&#x3D;0  </span><br></pre></td></tr></table></figure>



<p>template模块演示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim inventory&#x2F;testenv</span><br><span class="line"># 末尾添加以下内容</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;80</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;4</span><br><span class="line">max_open_file&#x3D;65505</span><br><span class="line">root&#x3D;&#x2F;www</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir roles&#x2F;testbox&#x2F;templates</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"># For more information on configuration, see: </span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;  </span><br><span class="line">  </span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;  </span><br><span class="line">    default_type  application&#x2F;octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;  </span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;  </span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  </span><br><span class="line">  </span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    #tcp_nopush     on;  </span><br><span class="line">  </span><br><span class="line">    #keepalive_timeout  0;  </span><br><span class="line">    keepalive_timeout  65;  </span><br><span class="line">  </span><br><span class="line">    #gzip  on;  </span><br><span class="line">      </span><br><span class="line">    # Load config files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory  </span><br><span class="line">    # The default server is in conf.d&#x2F;default.conf  </span><br><span class="line">    #include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;  </span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;  </span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">        #charset koi8-r;  </span><br><span class="line">  </span><br><span class="line">        #access_log  logs&#x2F;host.access.log  main;  </span><br><span class="line">  </span><br><span class="line">        location &#x2F; &#123;  </span><br><span class="line">            root   &#123;&#123; root &#125;&#125;;  </span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        error_page  404              &#x2F;404.html;  </span><br><span class="line">        location &#x3D; &#x2F;404.html &#123;  </span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        # redirect server error pages to the static page &#x2F;50x.html  </span><br><span class="line">        #  </span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;  </span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;  </span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">配置main.yml文件</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles&#x2F;testbox&#x2F;tasks&#x2F;main.yml</span><br><span class="line"># 末尾添加如下内容</span><br><span class="line">- name: write the nginx config file</span><br><span class="line">  template: src&#x3D;roles&#x2F;testbox&#x2F;templates&#x2F;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.c</span><br><span class="line">onf</span><br><span class="line"></span><br><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  yum: pkg&#x3D;nginx state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: start nginx service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;started</span><br><span class="line"></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory&#x2F;testenv .&#x2F;deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : create a file] *************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : copy a file] ***************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : check if god.sh exists] ****************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : debug] *********************************************************</span><br><span class="line">ok: [test.example.com] &#x3D;&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;god.sh exists&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [testbox : run the script] ************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : write the nginx config file] ***********************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : ensure nginx is at the latest version] *************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : start nginx service] *******************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;10   changed&#x3D;6    unreachable&#x3D;0    failed&#x3D;0  </span><br><span class="line"></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span><br></pre></td></tr></table></figure>



<p>查看并验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"># For more information on configuration, see:</span><br><span class="line">user              deploy;</span><br><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;</span><br><span class="line"></span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  65505;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    # Load config files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory</span><br><span class="line">    # The default server is in conf.d&#x2F;default.conf</span><br><span class="line">    #include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  test.example.com;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs&#x2F;host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   &#x2F;www;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page  404              &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;404.html &#123;</span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page &#x2F;50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com ps -ef | grep nginx</span><br><span class="line">root       5047      1  0 19:49 ?        00:00:00 nginx: master process &#x2F;usr&#x2F;sbin&#x2F;nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">deploy     5048   5047  0 19:49 ?        00:00:00 nginx: worker process</span><br><span class="line">deploy     5049   5047  0 19:49 ?        00:00:00 nginx: worker process</span><br><span class="line">deploy     5050   5047  0 19:49 ?        00:00:00 nginx: worker process</span><br><span class="line">deploy     5051   5047  0 19:49 ?        00:00:00 nginx: worker process</span><br></pre></td></tr></table></figure>



<p>至此ansible的安装、配置与演示已全部完成。</p>
]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(六)</title>
    <url>/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/</url>
    <content><![CDATA[<p><strong>Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））</strong></p>
<ul>
<li><p>环境准备</p>
</li>
<li><p>编写ansible playbook脚本实现Wordpress远程部署</p>
</li>
<li><p>将wordpress源码与playbook部署脚本提交到gitlab仓库</p>
</li>
<li><p>编写pipeline job脚本实现Jenkins流水线持续交付流程</p>
</li>
<li><p>Jenkins集成Ansible与gitlab实现wordpress的自动化部署</p>
<p>验证环境</p>
</li>
</ul>
<p>登录Jenkins主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~</span><br><span class="line">$ ssh root@jenkins.example.com</span><br><span class="line">Last login: Thu Jan 10 11:41:49 2019 from 192.168.244.1</span><br><span class="line">[root@jenkins ~]# su - deploy</span><br><span class="line">Last login: Wed Jan  9 20:24:43 CST 2019 on pts&#x2F;0</span><br><span class="line">[deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate           (.py3-a2.5-env) [deploy@jenkins ~]$ source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook 2.5.14 (stable-2.5 c748512c4c) last updated 2019&#x2F;01&#x2F;09 20:03:39 (GMT +800)</span><br><span class="line">  config file &#x3D; None</span><br><span class="line">  configured module search path &#x3D; [&#39;&#x2F;home&#x2F;deploy&#x2F;.ansible&#x2F;plugins&#x2F;modules&#39;, &#39;&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;plugins&#x2F;modules&#39;]</span><br><span class="line">  ansible python module location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;lib&#x2F;ansible</span><br><span class="line">  executable location &#x3D; &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;bin&#x2F;ansible-playbook</span><br><span class="line">  python version &#x3D; 3.6.8 (default, Jan  9 2019, 19:44:42) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br><span class="line">(.py3-a2.5-env) [deploy@jenkins ~]$ ssh root@test.example.com</span><br><span class="line">Last login: Thu Jan 10 13:04:32 2019 from 192.168.244.131</span><br><span class="line">[root@test ~]# hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>登录Jenkins web管理页</p>
<p>2808</p>
<p>登录gitlab web管理页</p>
<p>2920</p>
<p>至此环境准备完成。</p>
<p>接下来编写ansible playbook脚本实现wordpress远程部署</p>
<p>开始编写配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo</span><br><span class="line">$ cd ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total 5</span><br><span class="line">-rw-r--r-- 1 xueji 1049089   0 1月  10 11:57 ansible-playbook.txt</span><br><span class="line">drwxr-xr-x 1 xueji 1049089   0 1月  10 12:27 nginx_playbooks&#x2F;</span><br><span class="line">-rw-r--r-- 1 xueji 1049089 312 7月  15 08:33 nginx-freestyle-job.sh</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ mkdir wordpress_playbooks</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo (master)</span><br><span class="line">$ cd wordpress_playbooks&#x2F;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ mkdir inventory</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ mkdir -p roles&#x2F;wordpress&#x2F;&#123;files,tasks,templates&#125;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 1 xueji 1049089 0 1月  10 13:29 inventory&#x2F;</span><br><span class="line">drwxr-xr-x 1 xueji 1049089 0 1月  10 13:30 roles&#x2F;</span><br><span class="line"></span><br><span class="line">配置deploy.retry</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.retry</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>配置deploy.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.yml</span><br><span class="line">- hosts: wordpress</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">      backup_to: &quot;&#123;&#123;root&#125;&#125;_&#123;&#123;branch&#125;&#125;_&#123;&#123;ansible_date_time.epoch&#125;&#125;&quot;</span><br><span class="line">  roles:</span><br><span class="line">    - wordpress</span><br></pre></td></tr></table></figure>



<p>配置dev</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;dev</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;8080</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;2</span><br><span class="line">max_open_file&#x3D;30000</span><br><span class="line">root&#x3D;&#x2F;data&#x2F;www</span><br><span class="line">gitlab_user&#x3D;&#39;root&#39;</span><br><span class="line">gitlab_pass&#x3D;&#39;12345678&#39;</span><br></pre></td></tr></table></figure>



<p>配置prod</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim inventory&#x2F;prod</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line">server_name&#x3D;test.example.com</span><br><span class="line">port&#x3D;80</span><br><span class="line">user&#x3D;deploy</span><br><span class="line">worker_processes&#x3D;4</span><br><span class="line">max_open_file&#x3D;65505</span><br><span class="line">root&#x3D;&#x2F;data&#x2F;www</span><br><span class="line">gitlab_user&#x3D;&#39;root&#39;</span><br><span class="line">gitlab_pass&#x3D;&#39;12345678&#39;</span><br></pre></td></tr></table></figure>



<p>配置health_check.sh和info.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">URL&#x3D;$1</span><br><span class="line">PORT&#x3D;$2</span><br><span class="line"></span><br><span class="line">curl -Is http:&#x2F;&#x2F;$URL:$PORT&#x2F;info.php &gt; &#x2F;dev&#x2F;null &amp;&amp; echo &quot;The remote side is healthy&quot; || echo &quot;The remote side is failed, please check&quot;</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt;&gt; roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br></pre></td></tr></table></figure>



<p>配置<a href="http://www.conf/">www.conf</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;files&#x2F;www.conf</span><br><span class="line"></span><br><span class="line">; Start a new pool named &#39;www&#39;.</span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line">; Unix user&#x2F;group of processes</span><br><span class="line">; Note: The user is mandatory. If the group is not set, the default user&#39;s group</span><br><span class="line">;       will be used.</span><br><span class="line">; RPM: apache Choosed to be able to access some dir as httpd</span><br><span class="line">user &#x3D; deploy</span><br><span class="line">; RPM: Keep a group allowed to write in log dir.</span><br><span class="line">group &#x3D; deploy</span><br><span class="line"></span><br><span class="line">; The address on which to accept FastCGI requests.</span><br><span class="line">; Valid syntaxes are:</span><br><span class="line">;   &#39;ip.add.re.ss:port&#39;    - to listen on a TCP socket to a specific IPv4 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#39;[ip:6:addr:ess]:port&#39; - to listen on a TCP socket to a specific IPv6 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#39;port&#39;                 - to listen on a TCP socket to all addresses</span><br><span class="line">;                            (IPv6 and IPv4-mapped) on a specific port;</span><br><span class="line">;   &#39;&#x2F;path&#x2F;to&#x2F;unix&#x2F;socket&#39; - to listen on a unix socket.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">;listen &#x3D; 127.0.0.1:9000</span><br><span class="line">listen &#x3D; &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; Set listen(2) backlog.</span><br><span class="line">; Default Value: 511 (-1 on FreeBSD and OpenBSD)</span><br><span class="line">;listen.backlog &#x3D; 511</span><br><span class="line"></span><br><span class="line">; Set permissions for unix socket, if one is used. In Linux, read&#x2F;write</span><br><span class="line">; permissions must be set in order to allow connections from a web server. Many</span><br><span class="line">; BSD-derived systems allow connections regardless of permissions.</span><br><span class="line">; Default Values: user and group are set as the running user</span><br><span class="line">;                 mode is set to 0660</span><br><span class="line">listen.owner &#x3D; deploy</span><br><span class="line">listen.group &#x3D; deploy</span><br><span class="line">;listen.mode &#x3D; 0660</span><br><span class="line">; When POSIX Access Control Lists are supported you can set them using</span><br><span class="line">; these options, value is a comma separated list of user&#x2F;group names.</span><br><span class="line">; When set, listen.owner and listen.group are ignored</span><br><span class="line">;listen.acl_users &#x3D;</span><br><span class="line">;listen.acl_groups &#x3D;</span><br><span class="line"></span><br><span class="line">; List of addresses (IPv4&#x2F;IPv6) of FastCGI clients which are allowed to connect.</span><br><span class="line">; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original</span><br><span class="line">; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address</span><br><span class="line">; must be separated by a comma. If this value is left blank, connections will be</span><br><span class="line">; accepted from any ip address.</span><br><span class="line">; Default Value: any</span><br><span class="line">listen.allowed_clients &#x3D; 127.0.0.1</span><br><span class="line"></span><br><span class="line">; Specify the nice(2) priority to apply to the pool processes (only if set)</span><br><span class="line">; The value can vary from -19 (highest priority) to 20 (lower priority)</span><br><span class="line">; Note: - It will only work if the FPM master process is launched as root</span><br><span class="line">;       - The pool processes will inherit the master process priority</span><br><span class="line">;         unless it specified otherwise</span><br><span class="line">; Default Value: no set</span><br><span class="line">; process.priority &#x3D; -19</span><br><span class="line"></span><br><span class="line">; Choose how the process manager will control the number of child processes.</span><br><span class="line">; Possible Values:</span><br><span class="line">;   static  - a fixed number (pm.max_children) of child processes;</span><br><span class="line">;   dynamic - the number of child processes are set dynamically based on the</span><br><span class="line">;             following directives. With this process management, there will be</span><br><span class="line">;             always at least 1 children.</span><br><span class="line">;             pm.max_children      - the maximum number of children that can</span><br><span class="line">;                                    be alive at the same time.</span><br><span class="line">;             pm.start_servers     - the number of children created on startup.</span><br><span class="line">;             pm.min_spare_servers - the minimum number of children in &#39;idle&#39;</span><br><span class="line">;                                    state (waiting to process). If the number</span><br><span class="line">;                                    of &#39;idle&#39; processes is less than this</span><br><span class="line">;                                    number then some children will be created.</span><br><span class="line">;             pm.max_spare_servers - the maximum number of children in &#39;idle&#39;</span><br><span class="line">;                                    state (waiting to process). If the number</span><br><span class="line">;                                    of &#39;idle&#39; processes is greater than this</span><br><span class="line">;                                    number then some children will be killed.</span><br><span class="line">;  ondemand - no children are created at startup. Children will be forked when</span><br><span class="line">;             new requests will connect. The following parameter are used:</span><br><span class="line">;             pm.max_children           - the maximum number of children that</span><br><span class="line">;                                         can be alive at the same time.</span><br><span class="line">;             pm.process_idle_timeout   - The number of seconds after which</span><br><span class="line">;                                         an idle process will be killed.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">pm &#x3D; dynamic</span><br><span class="line"></span><br><span class="line">; The number of child processes to be created when pm is set to &#39;static&#39; and the</span><br><span class="line">; maximum number of child processes when pm is set to &#39;dynamic&#39; or &#39;ondemand&#39;.</span><br><span class="line">; This value sets the limit on the number of simultaneous requests that will be</span><br><span class="line">; served. Equivalent to the ApacheMaxClients directive with mpm_prefork.</span><br><span class="line">; Equivalent to the PHP_FCGI_CHILDREN environment variable in the original PHP</span><br><span class="line">; CGI.</span><br><span class="line">; Note: Used when pm is set to &#39;static&#39;, &#39;dynamic&#39; or &#39;ondemand&#39;</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">pm.max_children &#x3D; 50</span><br><span class="line"></span><br><span class="line">; The number of child processes created on startup.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) &#x2F; 2</span><br><span class="line">pm.start_servers &#x3D; 5</span><br><span class="line"></span><br><span class="line">; The desired minimum number of idle server processes.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Note: Mandatory when pm is set to &#39;dynamic&#39;</span><br><span class="line">pm.min_spare_servers &#x3D; 5</span><br><span class="line"></span><br><span class="line">; The desired maximum number of idle server processes.</span><br><span class="line">; Note: Used only when pm is set to &#39;dynamic&#39;</span><br><span class="line">; Note: Mandatory when pm is set to &#39;dynamic&#39;</span><br><span class="line">pm.max_spare_servers &#x3D; 35</span><br><span class="line"></span><br><span class="line">; The number of seconds after which an idle process will be killed.</span><br><span class="line">; Note: Used only when pm is set to &#39;ondemand&#39;</span><br><span class="line">; Default Value: 10s</span><br><span class="line">;pm.process_idle_timeout &#x3D; 10s;</span><br><span class="line"></span><br><span class="line">; The number of requests each child process should execute before respawning.</span><br><span class="line">; This can be useful to work around memory leaks in 3rd party libraries. For</span><br><span class="line">; endless request processing specify &#39;0&#39;. Equivalent to PHP_FCGI_MAX_REQUESTS.</span><br><span class="line">; Default Value: 0</span><br><span class="line">;pm.max_requests &#x3D; 500</span><br><span class="line"></span><br><span class="line">; The URI to view the FPM status page. If this value is not set, no URI will be</span><br><span class="line">; recognized as a status page. It shows the following informations:</span><br><span class="line">;   pool                 - the name of the pool;</span><br><span class="line">;   process manager      - static, dynamic or ondemand;</span><br><span class="line">;   start time           - the date and time FPM has started;</span><br><span class="line">;   start since          - number of seconds since FPM has started;</span><br><span class="line">;   accepted conn        - the number of request accepted by the pool;</span><br><span class="line">;   listen queue         - the number of request in the queue of pending</span><br><span class="line">;                          connections (see backlog in listen(2));</span><br><span class="line">;   max listen queue     - the maximum number of requests in the queue</span><br><span class="line">;                          of pending connections since FPM has started;</span><br><span class="line">;   listen queue len     - the size of the socket queue of pending connections;</span><br><span class="line">;   idle processes       - the number of idle processes;</span><br><span class="line">;   active processes     - the number of active processes;</span><br><span class="line">;   total processes      - the number of idle + active processes;</span><br><span class="line">;   max active processes - the maximum number of active processes since FPM</span><br><span class="line">;                          has started;</span><br><span class="line">;   max children reached - number of times, the process limit has been reached,</span><br><span class="line">;                          when pm tries to start more children (works only for</span><br><span class="line">;                          pm &#39;dynamic&#39; and &#39;ondemand&#39;);</span><br><span class="line">; Value are updated in real time.</span><br><span class="line">; Example output:</span><br><span class="line">;   pool:                 www</span><br><span class="line">;   process manager:      static</span><br><span class="line">;   start time:           01&#x2F;Jul&#x2F;2011:17:53:49 +0200</span><br><span class="line">;   start since:          62636</span><br><span class="line">;   accepted conn:        190460</span><br><span class="line">;   listen queue:         0</span><br><span class="line">;   max listen queue:     1</span><br><span class="line">;   listen queue len:     42</span><br><span class="line">;   idle processes:       4</span><br><span class="line">;   active processes:     11</span><br><span class="line">;   total processes:      15</span><br><span class="line">;   max active processes: 12</span><br><span class="line">;   max children reached: 0</span><br><span class="line">;</span><br><span class="line">; By default the status page output is formatted as text&#x2F;plain. Passing either</span><br><span class="line">; &#39;html&#39;, &#39;xml&#39; or &#39;json&#39; in the query string will return the corresponding</span><br><span class="line">; output syntax. Example:</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?json</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?html</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?xml</span><br><span class="line">;</span><br><span class="line">; By default the status page only outputs short status. Passing &#39;full&#39; in the</span><br><span class="line">; query string will also return status for each pool process.</span><br><span class="line">; Example:</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?json&amp;full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?html&amp;full</span><br><span class="line">;   http:&#x2F;&#x2F;www.foo.bar&#x2F;status?xml&amp;full</span><br><span class="line">; The Full status returns for each process:</span><br><span class="line">;   pid                  - the PID of the process;</span><br><span class="line">;   state                - the state of the process (Idle, Running, ...);</span><br><span class="line">;   start time           - the date and time the process has started;</span><br><span class="line">;   start since          - the number of seconds since the process has started;</span><br><span class="line">;   requests             - the number of requests the process has served;</span><br><span class="line">;   request duration     - the duration in µs of the requests;</span><br><span class="line">;   request method       - the request method (GET, POST, ...);</span><br><span class="line">;   request URI          - the request URI with the query string;</span><br><span class="line">;   content length       - the content length of the request (only with POST);</span><br><span class="line">;   user                 - the user (PHP_AUTH_USER) (or &#39;-&#39; if not set);</span><br><span class="line">;   script               - the main script called (or &#39;-&#39; if not set);</span><br><span class="line">;   last request cpu     - the %cpu the last request consumed</span><br><span class="line">;                          it&#39;s always 0 if the process is not in Idle state</span><br><span class="line">;                          because CPU calculation is done when the request</span><br><span class="line">;                          processing has terminated;</span><br><span class="line">;   last request memory  - the max amount of memory the last request consumed</span><br><span class="line">;                          it&#39;s always 0 if the process is not in Idle state</span><br><span class="line">;                          because memory calculation is done when the request</span><br><span class="line">;                          processing has terminated;</span><br><span class="line">; If the process is in Idle state, then informations are related to the</span><br><span class="line">; last request the process has served. Otherwise informations are related to</span><br><span class="line">; the current request being served.</span><br><span class="line">; Example output:</span><br><span class="line">;   ************************</span><br><span class="line">;   pid:                  31330</span><br><span class="line">;   state:                Running</span><br><span class="line">;   start time:           01&#x2F;Jul&#x2F;2011:17:53:49 +0200</span><br><span class="line">;   start since:          63087</span><br><span class="line">;   requests:             12808</span><br><span class="line">;   request duration:     1250261</span><br><span class="line">;   request method:       GET</span><br><span class="line">;   request URI:          &#x2F;test_mem.php?N&#x3D;10000</span><br><span class="line">;   content length:       0</span><br><span class="line">;   user:                 -</span><br><span class="line">;   script:               &#x2F;home&#x2F;fat&#x2F;web&#x2F;docs&#x2F;php&#x2F;test_mem.php</span><br><span class="line">;   last request cpu:     0.00</span><br><span class="line">;   last request memory:  0</span><br><span class="line">;</span><br><span class="line">; Note: There is a real-time FPM status monitoring sample web page available</span><br><span class="line">;       It&#39;s available in: @EXPANDED_DATADIR@&#x2F;fpm&#x2F;status.html</span><br><span class="line">;</span><br><span class="line">; Note: The value must start with a leading slash (&#x2F;). The value can be</span><br><span class="line">;       anything, but it may not be a good idea to use the .php extension or it</span><br><span class="line">;       may conflict with a real PHP file.</span><br><span class="line">; Default Value: not set</span><br><span class="line">;pm.status_path &#x3D; &#x2F;status</span><br><span class="line"></span><br><span class="line">; The ping URI to call the monitoring page of FPM. If this value is not set, no</span><br><span class="line">; URI will be recognized as a ping page. This could be used to test from outside</span><br><span class="line">; that FPM is alive and responding, or to</span><br><span class="line">; - create a graph of FPM availability (rrd or such);</span><br><span class="line">; - remove a server from a group if it is not responding (load balancing);</span><br><span class="line">; - trigger alerts for the operating team (24&#x2F;7).</span><br><span class="line">; Note: The value must start with a leading slash (&#x2F;). The value can be</span><br><span class="line">;       anything, but it may not be a good idea to use the .php extension or it</span><br><span class="line">;       may conflict with a real PHP file.</span><br><span class="line">; Default Value: not set</span><br><span class="line">;ping.path &#x3D; &#x2F;ping</span><br><span class="line"></span><br><span class="line">; This directive may be used to customize the response of a ping request. The</span><br><span class="line">; response is formatted as text&#x2F;plain with a 200 response code.</span><br><span class="line">; Default Value: pong</span><br><span class="line">;ping.response &#x3D; pong</span><br><span class="line"></span><br><span class="line">; The access log file</span><br><span class="line">; Default: not set</span><br><span class="line">;access.log &#x3D; log&#x2F;$pool.access.log</span><br><span class="line"></span><br><span class="line">; The access log format.</span><br><span class="line">; The following syntax is allowed</span><br><span class="line">;  %%: the &#39;%&#39; character</span><br><span class="line">;  %C: %CPU used by the request</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;user&#125;C for user CPU only</span><br><span class="line">;      - %&#123;system&#125;C for system CPU only</span><br><span class="line">;      - %&#123;total&#125;C  for user + system CPU (default)</span><br><span class="line">;  %d: time taken to serve the request</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;seconds&#125;d (default)</span><br><span class="line">;      - %&#123;miliseconds&#125;d</span><br><span class="line">;      - %&#123;mili&#125;d</span><br><span class="line">;      - %&#123;microseconds&#125;d</span><br><span class="line">;      - %&#123;micro&#125;d</span><br><span class="line">;  %e: an environment variable (same as $_ENV or $_SERVER)</span><br><span class="line">;      it must be associated with embraces to specify the name of the env</span><br><span class="line">;      variable. Some exemples:</span><br><span class="line">;      - server specifics like: %&#123;REQUEST_METHOD&#125;e or %&#123;SERVER_PROTOCOL&#125;e</span><br><span class="line">;      - HTTP headers like: %&#123;HTTP_HOST&#125;e or %&#123;HTTP_USER_AGENT&#125;e</span><br><span class="line">;  %f: script filename</span><br><span class="line">;  %l: content-length of the request (for POST request only)</span><br><span class="line">;  %m: request method</span><br><span class="line">;  %M: peak of memory allocated by PHP</span><br><span class="line">;      it can accept the following format:</span><br><span class="line">;      - %&#123;bytes&#125;M (default)</span><br><span class="line">;      - %&#123;kilobytes&#125;M</span><br><span class="line">;      - %&#123;kilo&#125;M</span><br><span class="line">;      - %&#123;megabytes&#125;M</span><br><span class="line">;      - %&#123;mega&#125;M</span><br><span class="line">;  %n: pool name</span><br><span class="line">;  %o: output header</span><br><span class="line">;      it must be associated with embraces to specify the name of the header:</span><br><span class="line">;      - %&#123;Content-Type&#125;o</span><br><span class="line">;      - %&#123;X-Powered-By&#125;o</span><br><span class="line">;      - %&#123;Transfert-Encoding&#125;o</span><br><span class="line">;      - ....</span><br><span class="line">;  %p: PID of the child that serviced the request</span><br><span class="line">;  %P: PID of the parent of the child that serviced the request</span><br><span class="line">;  %q: the query string</span><br><span class="line">;  %Q: the &#39;?&#39; character if query string exists</span><br><span class="line">;  %r: the request URI (without the query string, see %q and %Q)</span><br><span class="line">;  %R: remote IP address</span><br><span class="line">;  %s: status (response code)</span><br><span class="line">;  %t: server time the request was received</span><br><span class="line">;      it can accept a strftime(3) format:</span><br><span class="line">;      %d&#x2F;%b&#x2F;%Y:%H:%M:%S %z (default)</span><br><span class="line">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span><br><span class="line">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span><br><span class="line">;  %T: time the log has been written (the request has finished)</span><br><span class="line">;      it can accept a strftime(3) format:</span><br><span class="line">;      %d&#x2F;%b&#x2F;%Y:%H:%M:%S %z (default)</span><br><span class="line">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span><br><span class="line">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span><br><span class="line">;  %u: remote user</span><br><span class="line">;</span><br><span class="line">; Default: &quot;%R - %u %t \&quot;%m %r\&quot; %s&quot;</span><br><span class="line">;access.format &#x3D; &quot;%R - %u %t \&quot;%m %r%Q%q\&quot; %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%&quot;</span><br><span class="line"></span><br><span class="line">; The log file for slow requests</span><br><span class="line">; Default Value: not set</span><br><span class="line">; Note: slowlog is mandatory if request_slowlog_timeout is set</span><br><span class="line">slowlog &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;www-slow.log</span><br><span class="line"></span><br><span class="line">; The timeout for serving a single request after which a PHP backtrace will be</span><br><span class="line">; dumped to the &#39;slowlog&#39; file. A value of &#39;0s&#39; means &#39;off&#39;.</span><br><span class="line">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Value: 0</span><br><span class="line">;request_slowlog_timeout &#x3D; 0</span><br><span class="line"></span><br><span class="line">; The timeout for serving a single request after which the worker process will</span><br><span class="line">; be killed. This option should be used when the &#39;max_execution_time&#39; ini option</span><br><span class="line">; does not stop script execution for some reason. A value of &#39;0&#39; means &#39;off&#39;.</span><br><span class="line">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Value: 0</span><br><span class="line">;request_terminate_timeout &#x3D; 0</span><br><span class="line"></span><br><span class="line">; Set open file descriptor rlimit.</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_files &#x3D; 1024</span><br><span class="line"></span><br><span class="line">; Set max core size rlimit.</span><br><span class="line">; Possible Values: &#39;unlimited&#39; or an integer greater or equal to 0</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_core &#x3D; 0</span><br><span class="line"></span><br><span class="line">; Chroot to this directory at the start. This value must be defined as an</span><br><span class="line">; absolute path. When this value is not set, chroot is not used.</span><br><span class="line">; Note: chrooting is a great security feature and should be used whenever</span><br><span class="line">;       possible. However, all PHP paths will be relative to the chroot</span><br><span class="line">;       (error_log, sessions.save_path, ...).</span><br><span class="line">; Default Value: not set</span><br><span class="line">;chroot &#x3D;</span><br><span class="line"></span><br><span class="line">; Chdir to this directory at the start.</span><br><span class="line">; Note: relative path can be used.</span><br><span class="line">; Default Value: current directory or &#x2F; when chroot</span><br><span class="line">;chdir &#x3D; &#x2F;var&#x2F;www</span><br><span class="line"></span><br><span class="line">; Redirect worker stdout and stderr into main error log. If not set, stdout and</span><br><span class="line">; stderr will be redirected to &#x2F;dev&#x2F;null according to FastCGI specs.</span><br><span class="line">; Note: on highloaded environement, this can cause some delay in the page</span><br><span class="line">; process time (several ms).</span><br><span class="line">; Default Value: no</span><br><span class="line">;catch_workers_output &#x3D; yes</span><br><span class="line"></span><br><span class="line">; Clear environment in FPM workers</span><br><span class="line">; Prevents arbitrary environment variables from reaching FPM worker processes</span><br><span class="line">; by clearing the environment in workers before env vars specified in this</span><br><span class="line">; pool configuration are added.</span><br><span class="line">; Setting to &quot;no&quot; will make all environment variables available to PHP code</span><br><span class="line">; via getenv(), $_ENV and $_SERVER.</span><br><span class="line">; Default Value: yes</span><br><span class="line">;clear_env &#x3D; no</span><br><span class="line"></span><br><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; exectute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions &#x3D; .php .php3 .php4 .php5 .php7</span><br><span class="line"></span><br><span class="line">; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from</span><br><span class="line">; the current environment.</span><br><span class="line">; Default Value: clean env</span><br><span class="line">;env[HOSTNAME] &#x3D; $HOSTNAME</span><br><span class="line">;env[PATH] &#x3D; &#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;bin:&#x2F;bin</span><br><span class="line">;env[TMP] &#x3D; &#x2F;tmp</span><br><span class="line">;env[TMPDIR] &#x3D; &#x2F;tmp</span><br><span class="line">;env[TEMP] &#x3D; &#x2F;tmp</span><br><span class="line"></span><br><span class="line">; Additional php.ini defines, specific to this pool of workers. These settings</span><br><span class="line">; overwrite the values previously defined in the php.ini. The directives are the</span><br><span class="line">; same as the PHP SAPI:</span><br><span class="line">;   php_value&#x2F;php_flag             - you can set classic ini defines which can</span><br><span class="line">;                                    be overwritten from PHP call &#39;ini_set&#39;.</span><br><span class="line">;   php_admin_value&#x2F;php_admin_flag - these directives won&#39;t be overwritten by</span><br><span class="line">;                                     PHP call &#39;ini_set&#39;</span><br><span class="line">; For php_*flag, valid values are on, off, 1, 0, true, false, yes or no.</span><br><span class="line"></span><br><span class="line">; Defining &#39;extension&#39; will load the corresponding shared extension from</span><br><span class="line">; extension_dir. Defining &#39;disable_functions&#39; or &#39;disable_classes&#39; will not</span><br><span class="line">; overwrite previously defined php.ini values, but will append the new value</span><br><span class="line">; instead.</span><br><span class="line"></span><br><span class="line">; Default Value: nothing is defined by default except the values in php.ini and</span><br><span class="line">;                specified at startup with the -d argument</span><br><span class="line">;php_admin_value[sendmail_path] &#x3D; &#x2F;usr&#x2F;sbin&#x2F;sendmail -t -i -f www@my.domain.com</span><br><span class="line">;php_flag[display_errors] &#x3D; off</span><br><span class="line">php_admin_value[error_log] &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;www-error.log</span><br><span class="line">php_admin_flag[log_errors] &#x3D; on</span><br><span class="line">;php_admin_value[memory_limit] &#x3D; 128M</span><br><span class="line"></span><br><span class="line">; Set session path to a directory owned by process user</span><br><span class="line">php_value[session.save_handler] &#x3D; files</span><br><span class="line">php_value[session.save_path]    &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;wsdlcache</span><br></pre></td></tr></table></figure>



<p>配置main.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;tasks&#x2F;main.yml</span><br><span class="line"></span><br><span class="line">- name: Update yum dependency</span><br><span class="line">  shell: &#39;yum update -y warn&#x3D;False&#39;</span><br><span class="line"></span><br><span class="line">- name: Disable system firewall</span><br><span class="line">  service: name&#x3D;firewalld state&#x3D;stopped</span><br><span class="line"></span><br><span class="line">- name: Disable SELINX</span><br><span class="line">  selinux: state&#x3D;disabled</span><br><span class="line"></span><br><span class="line">- name: Setup epel yum source for nginx and mariadb(mysql)</span><br><span class="line">  yum: pkg&#x3D;epel-release state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: Setup webtatic yum source for php-fpm</span><br><span class="line">  yum: name&#x3D;https:&#x2F;&#x2F;mirror.webtatic.com&#x2F;yum&#x2F;el7&#x2F;webtatic-release.rpm</span><br><span class="line"></span><br><span class="line">- name: Ensure nginx is at the latest version</span><br><span class="line">  yum: pkg&#x3D;nginx state&#x3D;latest</span><br><span class="line"></span><br><span class="line">- name: Write the nginx config file</span><br><span class="line">  template: src&#x3D;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">- name: Create nginx root folder</span><br><span class="line">  file: &#39;path&#x3D;&#123;&#123; root &#125;&#125; state&#x3D;directory owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125; mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: Copy info.php to remote</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;wordpress&#x2F;files&#x2F;info.php dest&#x3D;&#x2F;data&#x2F;www&#x2F;info.php mode&#x3D;0755&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart nginx service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Setup php-fpm</span><br><span class="line">  command: &#39;yum install -y php70w php70w-fpm php70w-common php70w-mysql php70w-gd php70w-xml php70w-mbstring php70w-mcrypt warn&#x3D;False&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: name&#x3D;php-fpm state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Copy php-fpm config file to remote</span><br><span class="line">  copy: &#39;remote_src&#x3D;no src&#x3D;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf dest&#x3D;&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf mode&#x3D;0755 owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125; force&#x3D;yes&#39;</span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: name&#x3D;php-fpm state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">- name: Run the health check locally</span><br><span class="line">  shell: &quot;sh roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh &#123;&#123; server_name &#125;&#125; &#123;&#123; port &#125;&#125;&quot;</span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: msg&#x3D;&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">- name: Setup mariadb(mysql)</span><br><span class="line">  command: &quot;yum install -y mariadb mariadb-server warn&#x3D;False&quot;</span><br><span class="line"></span><br><span class="line">- name: Backup current www folder</span><br><span class="line">  shell: &#39;mv &#123;&#123; root &#125;&#125; &#123;&#123; backup_to &#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">- name: Close git ssl verification</span><br><span class="line">  shell: &#39;git config --global http.sslVerify false&#39;</span><br><span class="line"></span><br><span class="line">- name: Clone WordPress repo to remote</span><br><span class="line">  git: &quot;repo&#x3D;https:&#x2F;&#x2F;&#123;&#123; gitlab_user | urlencode &#125;&#125;:&#123;&#123; gitlab_pass | urlencode &#125;&#125;@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git dest&#x3D;&#x2F;data&#x2F;www version&#x3D;&#123;&#123; branch &#125;&#125;&quot;</span><br><span class="line">  when: project &#x3D;&#x3D; &#39;wordpress&#39;</span><br><span class="line"></span><br><span class="line">- name: Change www folder permission</span><br><span class="line">  file: &quot;path&#x3D;&#x2F;data&#x2F;www mode&#x3D;0755 owner&#x3D;&#123;&#123; user &#125;&#125; group&#x3D;&#123;&#123; user &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>



<p>配置nginx.conf.j2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ vim roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"># For more information on configuration, see: </span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;  </span><br><span class="line">  </span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;  </span><br><span class="line">    default_type  application&#x2F;octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;  </span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;  </span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  </span><br><span class="line">  </span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    #tcp_nopush     on;  </span><br><span class="line">  </span><br><span class="line">    #keepalive_timeout  0;  </span><br><span class="line">    keepalive_timeout  65;  </span><br><span class="line">  </span><br><span class="line">    #gzip  on;  </span><br><span class="line">      </span><br><span class="line">    # Load config files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory  </span><br><span class="line">    # The default server is in conf.d&#x2F;default.conf  </span><br><span class="line">    #include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;  </span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;  </span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;  </span><br><span class="line">        root         &#123;&#123; root &#125;&#125;;</span><br><span class="line">        #charset koi8-r;  </span><br><span class="line">  </span><br><span class="line">        location &#x2F; &#123;  </span><br><span class="line">            index  index.html index.htm index.php;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            try_files $uri &#x3D;404;</span><br><span class="line">            fastcgi_pass unix:&#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">            include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地提交</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ pwd</span><br><span class="line">&#x2F;c&#x2F;Users&#x2F;xueji&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;deploy.retry.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;deploy.yml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;inventory&#x2F;dev.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;inventory&#x2F;prod.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;main.yml.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git commit -m&quot;first commit&quot;</span><br><span class="line">[master c526626] first commit</span><br><span class="line"> 9 files changed, 564 insertions(+)</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;deploy.yml</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;inventory&#x2F;dev</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;inventory&#x2F;prod</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;health_check.sh</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;main.yml</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;www.conf</span><br><span class="line"> create mode 100644 wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 17, done.</span><br><span class="line">Counting objects: 100% (17&#x2F;17), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (13&#x2F;13), done.</span><br><span class="line">Writing objects: 100% (16&#x2F;16), 8.48 KiB | 1.70 MiB&#x2F;s, done.</span><br><span class="line">Total 16 (delta 1), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">   06431dc..c526626  master -&gt; master</span><br></pre></td></tr></table></figure>



<p>返回gitlab查看</p>
<p>76112</p>
<p>创建Wordpress-project仓库并提交本地代码到gitlab</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git -c http.sslVerify&#x3D;false clone https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git add .</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git commit -m &quot;first commit&quot;</span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;1&#x2F;Wordpress-project (master)</span><br><span class="line">$ git push origin master</span><br></pre></td></tr></table></figure>



<p>登录到Jenkins web管理页</p>
<p>点击“New 任务”</p>
<p>77474</p>
<p>添加描述</p>
<p>77576</p>
<p>在如下输入框中输入</p>
<p>77685</p>
<p>pipeline script脚本内容（注意credentialsId要查看本地设置的凭据中的ID，复制过来替换掉即可）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label &#39;master&#39;&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH&#x3D;&quot;&#x2F;bin:&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            choices: &#39;dev\nrprod&#39;,</span><br><span class="line">            description: &#39;Choose deploy environment&#39;,</span><br><span class="line">            name: &#39;deploy_env&#39;</span><br><span class="line">        )</span><br><span class="line">        string (name: &#39;branch&#39;, defaultValue: &#39;master&#39;, description: &#39;Fill in your ansible repo branch&#39;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage (&quot;Pull deploy code&quot;) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh &#39;git config --global http.sslVerify false&#39;</span><br><span class="line">                dir (&quot;$&#123;env.WORKSPACE&#125;&quot;)&#123;</span><br><span class="line">                    git branch: &#39;master&#39;, credentialsId: &#39;&#39;, url: &#39;https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git&#39;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (&quot;Check env&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &quot;&quot;&quot;</span><br><span class="line">                set +x</span><br><span class="line">                user&#x3D;&#96;whoami&#96;</span><br><span class="line">                if [ $user &#x3D;&#x3D; deploy ]</span><br><span class="line">                then</span><br><span class="line">                    echo &quot;[INFO] Current deployment user is $user&quot;</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">                    echo &quot;[INFO] Current python version&quot;</span><br><span class="line">                    python --version</span><br><span class="line">                    echo &quot;[INFO] Current ansible version&quot;</span><br><span class="line">                    ansible-playbook --version</span><br><span class="line">                    echo &quot;[INFO] Remote system disk space&quot;</span><br><span class="line">                    ssh root@test.example.com df -h</span><br><span class="line">                    echo &quot;[INFO] Rmote system RAM&quot;</span><br><span class="line">                    ssh root@test.example.com free -m</span><br><span class="line">                else</span><br><span class="line">                    echo &quot;Deployment user is incorrect, please check&quot;</span><br><span class="line">                fi</span><br><span class="line"></span><br><span class="line">                set -x</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (&quot;Anisble deployment&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                input &quot;Do you approve the deployment?&quot;</span><br><span class="line">                dir(&quot;$&#123;env.WORKSPACE&#125;&#x2F;wordpress_playbooks&quot;)&#123;</span><br><span class="line">                    echo &quot;[INFO] Start deployment&quot;</span><br><span class="line">                    sh &quot;&quot;&quot;</span><br><span class="line">                    set +x</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;bin&#x2F;activate</span><br><span class="line">                    source &#x2F;home&#x2F;deploy&#x2F;.py3-a2.5-env&#x2F;ansible&#x2F;hacking&#x2F;env-setup -q</span><br><span class="line">                    ansible-playbook -i inventory&#x2F;$deploy_env .&#x2F;deploy.yml -e project&#x3D;wordpress -e branch&#x3D;$branch -e env&#x3D;$deploy_env</span><br><span class="line">                    set -x</span><br><span class="line">                    &quot;&quot;&quot;</span><br><span class="line">                    echo &quot;[INFO] Deployment finished...&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>凭据ID</p>
<p>85836</p>
<p>点击查看输出信息</p>
<p>85945</p>
<p>86041</p>
<p>(正常情况下)稍等片刻之后就会看到“SUCCESS”(注意首次构建可能会提示“No such property: deploy_env for class: groovy.lang.Binding”)遇到这个错误，只需返回到word press-pipeline-job工程点击“Build with Parameters”选择默认dev用户再次构建即可。</p>
<p>（纸上得来终觉浅，绝知此事要躬行，真的是各种采坑）久违的“SUCCESS”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Do you approve the deployment?</span><br><span class="line">Proceed or Abort</span><br><span class="line"></span><br><span class="line">Approved by admin</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] echo</span><br><span class="line">[INFO] Start deployment</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ set +x</span><br><span class="line"></span><br><span class="line">PLAY [wordpress] ***************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Update yum dependency] ***************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Disable system firewall] *************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Disable SELINX] **********************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup epel yum source for nginx and mariadb(mysql)] **********</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup webtatic yum source for php-fpm] ***********************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Ensure nginx is at the latest version] ***********************</span><br><span class="line"></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Write the nginx config file] *********************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Create nginx root folder] ************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart nginx service] ***************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup php-fpm] ***********************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart php-fpm service] *************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Copy php-fpm config file to remote] **************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Restart php-fpm service] *************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Run the health check locally] ********************************</span><br><span class="line">changed: [test.example.com -&gt; localhost]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : debug] *******************************************************</span><br><span class="line">ok: [test.example.com] &#x3D;&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;The remote side is healthy&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Setup mariadb(mysql)] ****************************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Close git ssl verification] **********************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Clone WordPress repo to remote] ******************************</span><br><span class="line"></span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [wordpress : Change www folder permission] ********************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;23   changed&#x3D;14   unreachable&#x3D;0    failed&#x3D;0   </span><br><span class="line"></span><br><span class="line">[Pipeline] echo</span><br><span class="line">[INFO] Deployment finished...</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>



<p>最后需要利用git bash或者xshell登录test.example.com主机上初始化MySQL数据库，（实际生产环境中不建议使用Jenkins重复构建初始化MySQL数据库，容易出现各种问题）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@test ~]# systemctl status mariadb</span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@test ~]# systemctl start mariadb</span><br><span class="line">[root@test ~]# mysql_secure_installation</span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to log into MariaDB to secure it, we&#39;ll need the current</span><br><span class="line">password for the root user.  If you&#39;ve just installed MariaDB, and</span><br><span class="line">you haven&#39;t set the root password yet, the password will be blank,</span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none):   #mariadb5.5首次安装没有root密码，所以直接回车即可</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log into the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">Set root password? [Y&#x2F;n] y</span><br><span class="line">New password:   #123456</span><br><span class="line">Re-enter new password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MariaDB without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &#39;localhost&#39;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">By default, MariaDB comes with a database named &#39;test&#39; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y&#x2F;n] y</span><br><span class="line"> - Dropping test database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges on test database...</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y&#x2F;n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  If you&#39;ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks for using MariaDB!</span><br></pre></td></tr></table></figure>



<p>创建wordpress数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@test ~]# mysql -uroot -p123456</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 10</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database wordpress character set utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; \q</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>



<p>浏览器登录</p>
<p>104917</p>
<p>105013</p>
<p>105109</p>
<p>105205</p>
<p>105300</p>
<p>105395</p>
<p>105491</p>
<p>查看首页</p>
<p>105592</p>
<p>至此，使用Jenkins+Gitlab+Ansible自动化部署wordpresss全部完成。</p>
<p>接下来说说注意点，尽量避免以后重蹈覆辙：</p>
<p>第一次没有上传Wordpress-project仓库，也没有配置test.example.com主机上的/etc/hosts文件，导致在部署过程中一直卡在某个环节不动，或者直接提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Clone WordPress repo to remote] ******************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;cmd&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;git clone --origin origin &#39;https:&#x2F;&#x2F;root:********@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#39; &#x2F;data&#x2F;www&quot;, &quot;msg&quot;: &quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:********@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error&quot;, &quot;rc&quot;: 128, &quot;stderr&quot;: &quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:12345678@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error\n&quot;, &quot;stderr_lines&quot;: [&quot;fatal: unable to access &#39;https:&#x2F;&#x2F;root:12345678@gitlab.example.com&#x2F;root&#x2F;Wordpress-project.git&#x2F;&#39;: Could not resolve host: gitlab.example.com; Unknown error&quot;], &quot;stdout&quot;: &quot;Cloning into &#39;&#x2F;data&#x2F;www&#39;...\n&quot;, &quot;stdout_lines&quot;: [&quot;Cloning into &#39;&#x2F;data&#x2F;www&#39;...&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br></pre></td></tr></table></figure>

<p>107784</p>
<p>错误信息2</p>
<p>ansible-playbook-repo仓库中没有info.php文件，所以抛出以下异常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line">An exception occurred during task execution. To see the full traceback, use -vvv. The error was:     &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Could not find or access &#39;roles&#x2F;wordpress&#x2F;files&#x2F;info.php&#39;\nSearched in:\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;files&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php\n\t&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php&quot;&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok&#x3D;9    changed&#x3D;4    unreachable&#x3D;0    failed&#x3D;1   </span><br><span class="line"></span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line"></span><br><span class="line">[Pipeline] &#x2F;&#x2F; withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] &#x2F;&#x2F; node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">ERROR: script returned exit code 2</span><br></pre></td></tr></table></figure>



<p>错误信息3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Setup webtatic yum source for php-fpm] ***********************</span><br><span class="line">Sending interrupt signal to process</span><br><span class="line">Aborted by admin</span><br><span class="line">fatal: [test.example.com]: UNREACHABLE! &#x3D;&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Shared connection to test.example.com closed.\r\n&quot;, &quot;unreachable&quot;: true&#125;</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks@tmp&#x2F;durable-55384134&#x2F;script.sh: line 5: 22534 Terminated              ansible-playbook -i inventory&#x2F;dev .&#x2F;deploy.yml -e project&#x3D;wordpress -e branch&#x3D;master -e env&#x3D;dev</span><br><span class="line">script returned exit code 143</span><br></pre></td></tr></table></figure>



<p>错误信息4</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: true, &quot;cmd&quot;: &quot;yum install git&quot;, &quot;delta&quot;: &quot;0:00:04.471168&quot;, &quot;end&quot;: &quot;2019-01-10 18:05:37.319608&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 1, &quot;start&quot;: &quot;2019-01-10 18:05:32.848440&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;stderr_lines&quot;: [], &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors.aliyun.com\n * epel: mirrors.aliyun.com\n * extras: mirrors.163.com\n * updates: mirrors.aliyun.com\n * webtatic: us-east.repo.webtatic.com\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package git.x86_64 0:1.8.3.1-20.el7 will be installed\n--&gt; Processing Dependency: perl-Git &#x3D; 1.8.3.1-20.el7 for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20.el7.x86_64\n--&gt; Running transaction check\n---&gt; Package perl-Error.noarch 1:0.17020-2.el7 will be installed\n---&gt; Package perl-Git.noarch 0:1.8.3.1-20.el7 will be installed\n---&gt; Package perl-TermReadKey.x86_64 0:2.30-20.el7 will be installed\n---&gt; Package rsync.x86_64 0:3.1.2-4.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n Package                Arch         Version                Repository     Size\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstalling:\n git                    x86_64       1.8.3.1-20.el7         updates       4.4 M\nInstalling for dependencies:\n perl-Error             noarch       1:0.17020-2.el7        base           32 k\n perl-Git               noarch       1.8.3.1-20.el7         updates        55 k\n perl-TermReadKey       x86_64       2.30-20.el7            base           31 k\n rsync                  x86_64       3.1.2-4.el7            base          403 k\n\nTransaction Summary\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstall  1 Package (+4 Dependent packages)\n\nTotal download size: 4.9 M\nInstalled size: 23 M\nIs this ok [y&#x2F;d&#x2F;N]: Exiting on user command\nYour transaction was saved, rerun it with:\n yum load-transaction &#x2F;tmp&#x2F;yum_save_tx.2019-01-10.18-05.jmunIG.yumtx&quot;, &quot;stdout_lines&quot;: [&quot;Loaded plugins: fastestmirror&quot;, &quot;Loading mirror speeds from cached hostfile&quot;, &quot; * base: mirrors.aliyun.com&quot;, &quot; * epel: mirrors.aliyun.com&quot;, &quot; * extras: mirrors.163.com&quot;, &quot; * updates: mirrors.aliyun.com&quot;, &quot; * webtatic: us-east.repo.webtatic.com&quot;, &quot;Resolving Dependencies&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package git.x86_64 0:1.8.3.1-20.el7 will be installed&quot;, &quot;--&gt; Processing Dependency: perl-Git &#x3D; 1.8.3.1-20.el7 for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20.el7.x86_64&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package perl-Error.noarch 1:0.17020-2.el7 will be installed&quot;, &quot;---&gt; Package perl-Git.noarch 0:1.8.3.1-20.el7 will be installed&quot;, &quot;---&gt; Package perl-TermReadKey.x86_64 0:2.30-20.el7 will be installed&quot;, &quot;---&gt; Package rsync.x86_64 0:3.1.2-4.el7 will be installed&quot;, &quot;--&gt; Finished Dependency Resolution&quot;, &quot;&quot;, &quot;Dependencies Resolved&quot;, &quot;&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot; Package                Arch         Version                Repository     Size&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot;Installing:&quot;, &quot; git                    x86_64       1.8.3.1-20.el7         updates       4.4 M&quot;, &quot;Installing for dependencies:&quot;, &quot; perl-Error             noarch       1:0.17020-2.el7        base           32 k&quot;, &quot; perl-Git               noarch       1.8.3.1-20.el7         updates        55 k&quot;, &quot; perl-TermReadKey       x86_64       2.30-20.el7            base           31 k&quot;, &quot; rsync                  x86_64       3.1.2-4.el7            base          403 k&quot;, &quot;&quot;, &quot;Transaction Summary&quot;, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, &quot;Install  1 Package (+4 Dependent packages)&quot;, &quot;&quot;, &quot;Total download size: 4.9 M&quot;, &quot;Installed size: 23 M&quot;, &quot;Is this ok [y&#x2F;d&#x2F;N]: Exiting on user command&quot;, &quot;Your transaction was saved, rerun it with:&quot;, &quot; yum load-transaction &#x2F;tmp&#x2F;yum_save_tx.2019-01-10.18-05.jmunIG.yumtx&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息5</p>
<p>这个报错是在错误信息4之前，因为test.example.com主机没有git命令所以才有了错误信息4的步骤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Close git ssl verification] **********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;changed&quot;: true, &quot;cmd&quot;: &quot;git config --global http.sslVerify false&quot;, &quot;delta&quot;: &quot;0:00:00.002747&quot;, &quot;end&quot;: &quot;2019-01-10 18:00:36.334202&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 127, &quot;start&quot;: &quot;2019-01-10 18:00:36.331455&quot;, &quot;stderr&quot;: &quot;&#x2F;bin&#x2F;sh: git: command not found&quot;, &quot;stderr_lines&quot;: [&quot;&#x2F;bin&#x2F;sh: git: command not found&quot;], &quot;stdout&quot;: &quot;&quot;, &quot;stdout_lines&quot;: []&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息6</p>
<p>这个变量没有在deploy.yml中定义，所以会抛出异常解决办法就是在deploy.yml中声明以下backup_to</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! &#x3D;&gt; &#123;&quot;msg&quot;: &quot;The task includes an option with an undefined variable. The error was: &#39;backup_to&#39; is undefined\n\nThe error appears to have been in &#39;&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;tasks&#x2F;main.yml&#39;: line 53, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Backup current www folder\n  ^ here\n&quot;&#125;</span><br><span class="line">    to retry, use: --limit @&#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;workspace&#x2F;wordpress-pipeline-job&#x2F;wordpress_playbooks&#x2F;deploy.retry</span><br></pre></td></tr></table></figure>

<p>deploy.yml中添加颜色加重部分</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- hosts: wordpress</span><br><span class="line">  gather_facts: true</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">     backup_to: &quot;&#123;&#123;root&#125;&#125;_&#123;&#123;branch&#125;&#125;_&#123;&#123;ansible_date_time.epoch&#125;&#125;&quot;</span><br><span class="line">  roles:</span><br><span class="line">    - wordpress</span><br></pre></td></tr></table></figure>



<p>解决过程中还遇到一个git提交错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git commit -m &quot;first commit&quot;</span><br><span class="line">[master eab3d83] first commit</span><br><span class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class="line"> rename wordpress_playbooks&#x2F;roles&#x2F;wordpress&#x2F;files&#x2F;&#123;index.php &#x3D;&gt; info.php&#125; (100%)</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line"> ! [rejected]        master -&gt; master (fetch first)</span><br><span class="line">error: failed to push some refs to &#39;https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git&#39;</span><br><span class="line">hint: Updates were rejected because the remote contains work that you do</span><br><span class="line">hint: not have locally. This is usually caused by another repository pushing</span><br><span class="line">hint: to the same ref. You may want to first integrate the remote changes</span><br><span class="line">hint: (e.g., &#39;git pull ...&#39;) before pushing again.</span><br><span class="line">hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.</span><br></pre></td></tr></table></figure>



<p>解决办法是，在推送到远端之前，先pull一下，然后再提交</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git pull origin master</span><br><span class="line">remote: Enumerating objects: 1, done.</span><br><span class="line">remote: Counting objects: 100% (1&#x2F;1), done.</span><br><span class="line">remote: Total 1 (delta 0), reused 0 (delta 0)</span><br><span class="line">Unpacking objects: 100% (1&#x2F;1), done.</span><br><span class="line">From https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo</span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   2dc88b0..5ea65a4  master     -&gt; origin&#x2F;master</span><br><span class="line">Already up to date!</span><br><span class="line">Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~&#x2F;Desktop&#x2F;repo&#x2F;ansible-playbook-repo&#x2F;wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 12, done.</span><br><span class="line">Counting objects: 100% (12&#x2F;12), done.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (6&#x2F;6), done.</span><br><span class="line">Writing objects: 100% (7&#x2F;7), 648 bytes | 648.00 KiB&#x2F;s, done.</span><br><span class="line">Total 7 (delta 4), reused 0 (delta 0)</span><br><span class="line">To https:&#x2F;&#x2F;gitlab.example.com&#x2F;root&#x2F;ansible-playbook-repo.git</span><br><span class="line">   5ea65a4..6127999  master -&gt; master</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Jenkins+Gitlab+Ansible</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
</search>
