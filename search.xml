<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>DOClever for centos7安装</title>
    <url>/sugw.github.io/2020/11/18/DOClever-for-centos7%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>#安装参考</p>
<p><a href="https://github.com/sx1989827/DOClever/blob/master/README.md">https://github.com/sx1989827/DOClever/blob/master/README.md</a> </p>
<h2 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>nodejs.org<span class="regexp">/dist/</span>v8.<span class="number">11.1</span>/node-v8.<span class="number">11.1</span>-linux-x64.tar.xz</span><br><span class="line">tar xvf node-v8.<span class="number">11.1</span>-linux-x64.tar.xz</span><br><span class="line">mv node-v8.<span class="number">11.1</span>-linux-x64 nodev8</span><br><span class="line">ln -s <span class="regexp">/data/</span>nodev8<span class="regexp">/bin/</span>node <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>node</span><br><span class="line">ln -s <span class="regexp">/data/</span>nodev8<span class="regexp">/bin/</span>npm <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>npm</span><br></pre></td></tr></table></figure>

<h2 id="安装mongodb"><a href="#安装mongodb" class="headerlink" title="安装mongodb"></a>安装mongodb</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cat <span class="regexp">/etc/yum</span>.repos.d/mongodb-org-<span class="number">4.4</span>.repo</span><br><span class="line">[mongodb-org-<span class="number">4.4</span>]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https:<span class="regexp">//</span>repo.mongodb.org<span class="regexp">/yum/</span>redhat<span class="regexp">/$releasever/m</span>ongodb-org<span class="regexp">/4.4/</span>x86_64/</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgkey=https:<span class="regexp">//</span>www.mongodb.org<span class="regexp">/static/</span>pgp/server-<span class="number">4.4</span>.asc</span><br><span class="line"></span><br><span class="line">sudo yum install -y mongodb-org</span><br><span class="line">sudo systemctl start mongod</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装studio"><a href="#安装studio" class="headerlink" title="安装studio"></a>安装studio</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>download.studio3t.com<span class="regexp">/robomongo/</span>linux/studio-<span class="number">3</span>t-robo-<span class="number">3</span>t-linux-double-pack.tar.gz</span><br><span class="line">tar xvf studio-<span class="number">3</span>t-robo-<span class="number">3</span>t-linux-double-pack.tar.gz</span><br><span class="line"> <span class="regexp">/bin/</span>sh studio-<span class="number">3</span>t-linux-x64.sh</span><br></pre></td></tr></table></figure>

<h2 id="安装DOClever"><a href="#安装DOClever" class="headerlink" title="安装DOClever"></a>安装DOClever</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/sx1989827/</span>DOClever<span class="regexp">/archive/m</span>aster.zip</span><br><span class="line">unzip master.zip</span><br></pre></td></tr></table></figure>

<h2 id="安装supervisor"><a href="#安装supervisor" class="headerlink" title="安装supervisor"></a>安装supervisor</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"> yum install supervisor</span><br><span class="line"> systemctl start supervisord</span><br><span class="line"> systemctl enable supervisord</span><br><span class="line"> </span><br><span class="line"> cat <span class="regexp">/etc/</span>supervisord.d/DOClever.ini</span><br><span class="line">[program:DOClever]</span><br><span class="line">command=<span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>node <span class="regexp">/data/</span>DOClever-master<span class="regexp">/Server/</span>bin/www</span><br><span class="line">autostart=<span class="keyword">true</span></span><br><span class="line">startretries=<span class="number">10</span></span><br><span class="line">autorestart=<span class="keyword">true</span></span><br><span class="line">stdout_logfile=<span class="regexp">/data/</span>logs<span class="regexp">/DOClever/</span>DOClever.log</span><br><span class="line">stderr_logfile=<span class="regexp">/data/</span>logs<span class="regexp">/DOClever/</span>error.log</span><br><span class="line">directory=<span class="regexp">/data/</span>DOClever-master</span><br><span class="line"></span><br><span class="line"> systemctl restart supervisord</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>接口管理</category>
      </categories>
      <tags>
        <tag>接口管理</tag>
      </tags>
  </entry>
  <entry>
    <title>Firewalld</title>
    <url>/sugw.github.io/2020/10/28/Firewalld/</url>
    <content><![CDATA[<p>启动一个服务：systemctl start firewalld.service</p>
<p>关闭一个服务：systemctl stop firewalld.service</p>
<p>重启一个服务：systemctl restart firewalld.service</p>
<p>显示一个服务的状态：systemctl status firewalld.service</p>
<p>在开机时启用一个服务：systemctl enable firewalld.service</p>
<p>在开机时禁用一个服务：systemctl disable firewalld.service</p>
<p>查看服务是否开机启动：systemctlis-enabled firewalld.service</p>
<p>查看已启动的服务列表：systemctllist-unit-files|grep enabled</p>
<p>查看启动失败的服务列表：systemctl–failed</p>
<p>3.配置firewalld-cmd</p>
<p>查看版本： firewall-cmd –version</p>
<p>查看帮助： firewall-cmd –help</p>
<p>显示状态： firewall-cmd –state</p>
<p>查看所有打开的端口： firewall-cmd–zone=public –list-ports</p>
<p>更新防火墙规则： firewall-cmd –reload</p>
<p>查看区域信息:  firewall-cmd–get-active-zones</p>
<p>查看指定接口所属区域： firewall-cmd–get-zone-of-interface=eth0</p>
<p>拒绝所有包：firewall-cmd –panic-on</p>
<p>取消拒绝状态： firewall-cmd –panic-off</p>
<p>查看是否拒绝： firewall-cmd –query-panic</p>
<p>添加</p>
<p>==firewall-cmd –zone=public –add-port=80/tcp –permanent  （–permanent永久生效，没有此参数重启后失效）==</p>
<p>重新载入</p>
<p>firewall-cmd –reload</p>
<p>查看</p>
<p>firewall-cmd –zone=public –query-port=80/tcp</p>
<p>删除</p>
<p>firewall-cmd –zone=public –remove-port=80/tcp –permanent</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>防火墙</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins pipeline 多服务器，多分支发版</title>
    <url>/sugw.github.io/2020/12/23/Jenkins%20pipeline%20%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%A4%9A%E5%88%86%E6%94%AF%E5%8F%91%E7%89%88/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>一个项目部署到多台服务器，通过jenkins自由风格转变成pipeline风格</p>
<p>发版效果：</p>
<p>![image-20210107182025504](Jenkins pipeline 多服务器，多分支发版/image-20210107182025504.png)</p>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any </span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">        String0 =  <span class="string">&#x27;$&#123;params.SERVER&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">    <span class="comment">//发版选择</span></span><br><span class="line">    choice(<span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">choices:</span> [<span class="string">&#x27;Deploy&#x27;</span>, <span class="string">&#x27;RollBACK&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;Deploy: 发版\n -------- \n RollBACK: 回滚 &#x27;</span>)</span><br><span class="line">    string <span class="attr">defaultValue:</span> <span class="string">&#x27;0&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;&#x27;&#x27;-------此添加项为回滚的版本号，如果您是发布，请忽略此选项-------&#x27;&#x27;&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;Version&#x27;</span>, <span class="attr">trim:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">//分支选择 </span></span><br><span class="line">    gitParameter <span class="attr">branchFilter:</span> <span class="string">&#x27;origin/(.*)&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;master&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;BRANCH&#x27;</span>, <span class="attr">type:</span> <span class="string">&#x27;PT_BRANCH&#x27;</span></span><br><span class="line">    <span class="comment">//选择服务器</span></span><br><span class="line">    extendedChoice <span class="attr">defaultValue:</span> <span class="string">&#x27;&quot;IP1&quot;&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;选择发版服务器&#x27;</span>, <span class="attr">multiSelectDelimiter:</span> <span class="string">&#x27;,&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;SERVER&#x27;</span>, <span class="attr">quoteValue:</span> <span class="literal">true</span>, <span class="attr">saveJSONParameterToFile:</span> <span class="literal">false</span>, <span class="attr">type:</span> <span class="string">&#x27;PT_CHECKBOX&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;&quot;IP1&quot;,&quot;IP2&quot;,&quot;IP3&quot;&#x27;</span>, <span class="attr">visibleItemCount:</span> <span class="number">5</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;清理本地仓库&#x27;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;if [ &quot;$(ls -A $WORKSPACE|wc -l)&quot; -ge &quot;2&quot; ];then</span></span><br><span class="line"><span class="string">                        cd $WORKSPACE/</span></span><br><span class="line"><span class="string">                        if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                            ls -A|grep -v email.html|xargs rm -rf </span></span><br><span class="line"><span class="string">                        fi</span></span><br><span class="line"><span class="string">                    fi&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">&#x27;拉取项目代码&#x27;</span>) &#123;</span><br><span class="line">      when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        git <span class="attr">branch:</span> <span class="string">&quot;$&#123;params.BRANCH&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;d3eda646-8d66-4cda-a627-cc8a546550af&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git地址&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">&#x27;构建项目&#x27;</span>) &#123;</span><br><span class="line">            when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                if [ -d $WORKSPACE/deploy_history ];then</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                    echo &quot;The file is already exists!!!&quot;</span></span><br><span class="line"><span class="string">                else</span></span><br><span class="line"><span class="string">                    mkdir -p $WORKSPACE/deploy_history</span></span><br><span class="line"><span class="string">                fi</span></span><br><span class="line"><span class="string">                cd $WORKSPACE</span></span><br><span class="line"><span class="string">                tar czf $&#123;env.WORKSPACE&#125;/deploy_history/$&#123;env.JOB_NAME&#125;-$&#123;env.BUILD_NUMBER&#125;.tar.gz ./* --exclude=deploy_history</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;项目备份&#x27;</span>)&#123;</span><br><span class="line">            when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;Deploy&#x27;</span> &#125;</span><br><span class="line"> </span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    echo </span></span><br><span class="line"><span class="string">                    BUILD_SAVE=5</span></span><br><span class="line"><span class="string">                    BACKDIR=$&#123;JENKINS_HOME&#125;/backdir/$&#123;JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                    if [ ! -d  $&#123;BACKDIR&#125; ];then</span></span><br><span class="line"><span class="string">                            mkdir -p $&#123;BACKDIR&#125;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    ## 备份当前发布版本代码,加入版本号,供回滚使用</span></span><br><span class="line"><span class="string">                    rsync -avz $&#123;WORKSPACE&#125;/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz $BACKDIR/</span></span><br><span class="line"><span class="string">                    if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                            echo &quot;备份完成,项目版本号为$&#123;BUILD_NUMBER&#125;&quot;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    while true;</span></span><br><span class="line"><span class="string">                    do</span></span><br><span class="line"><span class="string">                    cd $BACKDIR</span></span><br><span class="line"><span class="string">                    BAKFILES=$(ls -1tr *.tar.gz|wc -l)</span></span><br><span class="line"><span class="string">                    if [ $BAKFILES -gt &quot;$BUILD_SAVE&quot; ];then</span></span><br><span class="line"><span class="string">                           ls -1tr *.tar.gz|head -1|xargs rm -f</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                            break;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    done</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;版本回滚&#x27;</span>)&#123;</span><br><span class="line">                when &#123; environment <span class="attr">name:</span> <span class="string">&#x27;Status&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;RollBACK&#x27;</span> &#125;</span><br><span class="line">     </span><br><span class="line">                steps&#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    BACKDIR=$&#123;JENKINS_HOME&#125;/backdir/$&#123;JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                    ## 根据jenkins版本号选择锁定回滚文件</span></span><br><span class="line"><span class="string">                    if [ &quot;$Version&quot; == &quot;0&quot; ];then</span></span><br><span class="line"><span class="string">                        BACKFILE=$&#123;BACKDIR&#125;/$(ls $BACKDIR -1t|head -2|tail -1)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        BACKFILE=$&#123;BACKDIR&#125;/$&#123;JOB_NAME&#125;-$&#123;Version&#125;.tar.gz</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    if [ -f $&#123;BACKFILE&#125; ];then</span></span><br><span class="line"><span class="string">                            cd $WORKSPACE</span></span><br><span class="line"><span class="string">                            mkdir $WORKSPACE/deploy_history/ -p</span></span><br><span class="line"><span class="string">                            rsync -avz $BACKFILE $WORKSPACE/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz</span></span><br><span class="line"><span class="string">                            if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件拷贝完成&quot;</span></span><br><span class="line"><span class="string">                            else</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件拷贝失败&quot;</span></span><br><span class="line"><span class="string">                            fi</span></span><br><span class="line"><span class="string">                            tar -zxf $WORKSPACE/deploy_history/$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz -C $WORKSPACE/</span></span><br><span class="line"><span class="string">                            if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件解压完成&quot;</span></span><br><span class="line"><span class="string">                            else</span></span><br><span class="line"><span class="string">                                    echo &quot;回滚文件解压失败&quot;</span></span><br><span class="line"><span class="string">                            fi</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                            echo &quot;backfile not find&quot;</span></span><br><span class="line"><span class="string">                            exit 1;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        stage(<span class="string">&#x27;发布项目&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                script &#123;</span><br><span class="line">    				script &#123;</span><br><span class="line">    				    echo <span class="string">&quot;start deploy&quot;</span></span><br><span class="line">    				    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    				    set +x</span></span><br><span class="line"><span class="string">    				    </span></span><br><span class="line"><span class="string">    				    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                        source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">    				    set -x</span></span><br><span class="line"><span class="string">    				    &quot;&quot;&quot;</span></span><br><span class="line">    				    </span><br><span class="line">    					<span class="keyword">for</span> (item <span class="keyword">in</span> <span class="string">&quot;$&#123;params.SERVER&#125;&quot;</span>.tokenize(<span class="string">&#x27;,&quot;&#x27;</span>))&#123;</span><br><span class="line">    					    </span><br><span class="line">    						echo <span class="string">&#x27;Deploying to&#x27;</span>  + item</span><br><span class="line">                            </span><br><span class="line">                            sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                            cd /home/deploy/ansible-playbook-repo/</span></span><br><span class="line"><span class="string">                            ansible-playbook ./api_before-pipeline.yml -i ./hosts -e target=$item -e project=$&#123;JOB_NAME&#125; -e jenkins_dir=$&#123;WORKSPACE&#125; -e project_file=$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;.tar.gz -e job_number=$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125; -e user=www</span></span><br><span class="line"><span class="string">                            &quot;&quot;&quot;</span></span><br><span class="line">                            echo <span class="string">&quot; [INFO] Deployment finished...&quot;</span></span><br><span class="line">    					&#125;</span><br><span class="line">			    	&#125;</span><br><span class="line">			    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"> <span class="string">cat</span> <span class="string">roles/api_before-pipeline/tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span>  &#123;&#123; <span class="string">project</span> &#125;&#125;</span><br><span class="line">  <span class="attr">copy:</span> <span class="string">&#x27;src=<span class="template-variable">&#123;&#123; jenkins_dir &#125;&#125;</span>/deploy_history/<span class="template-variable">&#123;&#123;project_file&#125;&#125;</span> dest=/data/deploy/<span class="template-variable">&#123;&#123; project &#125;&#125;</span>/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">deploy</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="string">path=/data/deploy/&#123;&#123;</span> <span class="string">project</span> <span class="string">&#125;&#125;/&#123;&#123;</span> <span class="string">job_number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">mode=0755</span></span><br><span class="line">    <span class="string">owner=&#123;&#123;</span> <span class="string">user</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">group=&#123;&#123;</span> <span class="string">user</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">state=directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Unzip</span> <span class="string">the</span> <span class="string">project</span></span><br><span class="line">  <span class="attr">unarchive:</span> <span class="string">&#x27;src=/data/deploy/<span class="template-variable">&#123;&#123; project &#125;&#125;</span>/<span class="template-variable">&#123;&#123; project_file &#125;&#125;</span> dest=/data/deploy/<span class="template-variable">&#123;&#123; project &#125;&#125;</span>/<span class="template-variable">&#123;&#123; job_number &#125;&#125;</span> copy=no&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Link</span> <span class="string">site</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">&#x27;ln -snf /data/deploy/<span class="template-variable">&#123;&#123; project &#125;&#125;</span>/<span class="template-variable">&#123;&#123; job_number &#125;&#125;</span> /data/www/<span class="template-variable">&#123;&#123; project &#125;&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chage</span> <span class="string">www</span> <span class="string">folder</span> <span class="string">permission</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">&#x27;path=/data/www/ mode=0755 owner=<span class="template-variable">&#123;&#123; user&#125;&#125;</span> group=<span class="template-variable">&#123;&#123; user &#125;&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(三)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/</url>
    <content><![CDATA[<p>接Jenkins+Gitlab+Ansible自动化部署（一）<a href="https://www.cnblogs.com/zd520pyx1314/p/10210727.html">https://www.cnblogs.com/zd520pyx1314/p/10210727.html</a> 和（二）<a href="https://www.cnblogs.com/zd520pyx1314/p/10213549.html">https://www.cnblogs.com/zd520pyx1314/p/10213549.html </a></p>
<p>Jenkins是一个开源持续集成工具，提供了软甲你开发的持续集成服务，支持主流软件配置管理，配合实现软件配置管理，持续集成功能。是主流的运维开发平台，兼容所有主流开发环境，插件市场可与海量业内主流开发工具实现集成，Job为配置单位与日志管理，使运维与开发人员能协同工作。丰富的权限管理划分不同Job不同角色；强大的负载均衡功能，保证我们项目的可靠性。</p>
<p><strong>Jenkins的安装、配置与管理</strong></p>
<p>添加Jenkins yum仓库</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">官网地址</span><br><span class="line">https:<span class="regexp">//</span>pkg.jenkins.io<span class="regexp">/redhat-stable/</span></span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">[root@<span class="keyword">jenkins </span>~]<span class="comment"># wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span></span><br><span class="line">[root@<span class="keyword">jenkins </span>~]<span class="comment"># rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span></span><br><span class="line">安装<span class="keyword">Java</span></span><br><span class="line"><span class="keyword">[root@jenkins </span>~]<span class="comment"># yum install -y java</span></span><br><span class="line">[root@<span class="keyword">jenkins </span>~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_191&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_191-<span class="keyword">b12)</span></span><br><span class="line"><span class="keyword">OpenJDK </span><span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">191</span>-<span class="keyword">b12, </span>mixed mode)</span><br><span class="line">安装<span class="keyword">Jenkins</span></span><br><span class="line"><span class="keyword">[root@jenkins </span>~]<span class="comment"># yum list | grep &#x27;jenkins&#x27;</span></span><br><span class="line"><span class="keyword">jenkins.noarch </span> </span><br><span class="line">[root@<span class="keyword">jenkins </span>~]<span class="comment"># yum install -y jenkins</span></span><br></pre></td></tr></table></figure>

<p>创建Jenkins系统服务用户并配置</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">创建Jenkins系统服务用户</span><br><span class="line">[root@jenkins ~]# useradd deploy</span><br><span class="line">[root@jenkins ~]# cp /etc/sysconfig/jenkins&#123;,.bak&#125;</span><br><span class="line">[root@jenkins ~]# vim /etc/sysconfig/jenkins</span><br><span class="line"><span class="comment"># 大约在29行，改为deploy用户</span></span><br><span class="line">29 <span class="attribute">JENKINS_USER</span>=<span class="string">&quot;deploy&quot;</span></span><br><span class="line"><span class="comment"># 确定Jenkins端口号8080</span></span><br><span class="line">56 <span class="attribute">JENKINS_PORT</span>=<span class="string">&quot;8080&quot;</span></span><br><span class="line">更改目录权限</span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy /var/lib/jenkins</span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy /var/log/jenkins/</span><br><span class="line">启动Jenkins</span><br><span class="line">[root@jenkins ~]# systemctl start jenkins</span><br><span class="line">[root@jenkins ~]# lsof -i:8080</span><br><span class="line"><span class="comment"># 这里发现端口没起来，查看日志发现</span></span><br><span class="line">[root@jenkins ~]# cat /var/log/jenkins/jenkins.log</span><br><span class="line">java.io.FileNotFoundException: /var/cache/jenkins/war/META-INF/MANIFEST.MF (Permission denied)</span><br><span class="line"><span class="comment"># 然后赋予deploy目录权限</span></span><br><span class="line">[root@jenkins ~]# chown -R deploy:deploy /var/cache/jenkins/</span><br><span class="line">[root@jenkins ~]# systemctl restart jenkins</span><br><span class="line">[root@jenkins ~]# lsof -i:8080</span><br><span class="line">COMMAND  PID  <span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>DEVICE SIZE/OFF NODE NAME</span><br><span class="line">java    4086 deploy  163u <span class="built_in"> IPv6 </span> 49665      0t0  TCP *:webcache (LISTEN)</span><br><span class="line">启动成功</span><br></pre></td></tr></table></figure>

<p>登录jenkins web管理界面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109081517163-2114153447-20201126190249856.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109081626700-723998084-20201126190249837.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082239880-237022095-20201126190249822.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082318765-2143972765-20201126190249852.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082335879-1281083527-20201126190249820.png" class title="img">

<p>点击“Start using jenkins”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082514810-201360737-20201126190249812.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109082719110-1415462867-20201126190249933.png" class title="img">

<p><strong>Jenkins Job构建</strong></p>
<p>Freestyle Job与Pipeline Job区别：</p>
<p>Freestyle Job需要在页面添加模块配置项与参数完成配置；每个Job仅能实现一个开发功能；无法将配置代码化，不利于Job配置迁移与版本控制；逻辑相对简单，无需额外学习成本。</p>
<p>Pipeline Job匹配持续集成与持续交付的概念;所有模块、参数配置都可以体现为一个pipeline脚本；可定义多个stage构建一个管道工作集；所有配置代码化，方便Job配置迁移与版本控制；需要Pipeline脚本语法基础。</p>
<p><strong>Jenkins Job构建之环境准备（添加Jenkins后台git client user与email）</strong></p>
<p>1.配置Jenkins server本地GItlab DNS</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@jenkins ~]</span># vim /etc/hosts</span><br><span class="line"># 文件末尾添加如下一条记录</span><br><span class="line"><span class="number">192.168.244.130</span> gitlab.example.com</span><br></pre></td></tr></table></figure>

<p> 2.安装git client,curl工具依赖</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">[root<span class="symbol">@jenkins</span> ~]<span class="meta"># yum install -y git curl</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关闭系统git http.sslVerify安全认证</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@jenkins ~]# git<span class="built_in"> config </span>--system http.sslVerify <span class="literal">false</span></span><br><span class="line">[root@jenkins ~]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>4.添加Jenkins后台git client user与email</p>
<p>首先登录Jenkins web管理页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084213080-1358957517-20201126190249885.png" class title="img">

<p>在Git plugin选项中填写以下信息，点击保存</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084413710-1327479070-20201126190249866.png" class title="img">

<p>接下来添加凭据，点击“凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084855295-161429267-20201126190249903.png" class title="img">



<p>点击“全局凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109084938261-1920709690-20201126190249915.png" class title="img">

<p>点击“添加凭据”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085158834-1103026643-20201126190249924.png" class title="img">

<p>添加完成会提示如下图所示</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085221186-1109971985-20201126190249965.png" class title="img">

<p>接着添加一个Jenkins freestyle job</p>
<p>点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085416483-615353023-20201126190249917.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085535820-429058585-20201126190249972.png" class title="img">

<p>填写描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085656285-297058289-20201126190249972.png" class title="img">

<p>添加参数</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109085744007-1248036268-20201126190249979.png" class title="img">

<p>接着点击添加“文本参数” </p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090146442-1850185077-20201126190249979.png" class title="img">

<p>添加完成后点击“save”即可，接着回到Jenkins首页，点击刚才创建的“test-freestyle-job”黑色小三角，找到“configure”选项，开始添加git源码管理</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090555819-1615649654-20201126190249990.png" class title="img">

<p>使用root登录gitlab，复制test-repo仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109090828866-807026891-20201126190250034.png" class title="img">

<p>粘贴至下面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109091101815-196564836-20201126190250031.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100937058-2135270099-20201126190250054.png" class title="img">



<p>接着进行“build 配置”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100122390-1257749025-20201126190250039.png" class title="img">

<p>在以下框内粘贴</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109100220904-751145266-20201126190250052.png" class title="img">



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Print env variable</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Print env variable&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Current deployment envrionment is <span class="variable">$deploy_env</span>&quot;</span> &gt;&gt; test.properties</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;THe build is <span class="variable">$version</span>&quot;</span> &gt;&gt; test.properties</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Done...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check test properties</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Check test properties&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -s test.properties ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  cat test.properties</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;test.properties is empty&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[INFO] Build finished...&quot;</span></span><br></pre></td></tr></table></figure>



<p>接下来点击“Build with Parameters”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101418019-1763426339-20201126190250047.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101528999-2110448840-20201126190250097.png" class title="img">

<p>提示失败，点击红色失败按钮，查看日志并解决</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101630227-44210240-20201126190250093.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109101707180-924579553-20201126190250136.png" class title="img">

<p>可以看出还是之前的git有点问题，回到test-freestyle-job配置项，查看并确认</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109134829251-494673673-20201126190250104.png" class title="img">

<p>然后重新构建</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109140716411-601549284-20201126190250122.png" class title="img">

<p>可以看到已经成功构建。</p>
<p><strong>接下来演示Jenkins Pipeline Job构建过程</strong></p>
<p>Pipeline基础架构</p>
<p>1.所有代码包裹在pipeline{}层内</p>
<p>2.stages{}层用来包含该pipeline所有stage子层</p>
<p>3.stage{}层用来包含具体我们需要编写任务的steps{}子层</p>
<p>4.steps{}用来添加我们具体需要调用的模块语句</p>
<p>agent区域</p>
<ul>
<li>agent定义pipeline在哪里运行，可以使用any,none,或具体的Jenkins node主机名等；例如：假定我们要特指在node1上执行，可以写成：agent{node1 {label ‘node1’}}。</li>
</ul>
<p>environment区域</p>
<ul>
<li>“变量名称=变量值”定义我们的环境变量；</li>
<li>可以定义全局环境变量，应用所有stage任务</li>
<li>可以定义stage环境变量，应用单独的stage任务</li>
</ul>
<p>script区域（可选）</p>
<ul>
<li>在steps内定义script{}；</li>
<li>groovy脚本语言；</li>
<li>用来进行脚本逻辑运算；</li>
</ul>
<p>常用steps区域</p>
<ul>
<li>echo：打印输出</li>
<li>sh:调用Linux系统shell命令</li>
<li>git url:调用git模块进行git相关操作</li>
</ul>
<p><strong>开始构建Jenkins Pipeline Job</strong></p>
<p>首先登录到Jenkins web 管理页</p>
<p>点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109143745658-319503731-20201126190250119.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109143857612-1734103608-20201126190250169.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144252732-493693831-20201126190250143.png" class title="img">



<p>添加pipeline script</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144953517-2101125996-20201126190250152.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109144338170-287033618-20201126190250174.png" class title="img">

<p>pipeline script脚本内容（用上述复制下来的ID粘贴至credentialsId后）</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">#!groovy</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label <span class="string">&#x27;master&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        PATH=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            <span class="symbol">choices:</span> <span class="string">&#x27;dev\nprod&#x27;</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&#x27;choose deploy environment&#x27;</span>,</span><br><span class="line">            <span class="symbol">name:</span> <span class="string">&#x27;deploy_env&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        string (<span class="attr">name:</span> <span class="string">&#x27;version&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;1.0.0&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;build version&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&quot;Checkout test repo&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    git <span class="attr">branch:</span> <span class="string">&#x27;master&#x27;</span>, <span class="attr">credentialsId:</span><span class="string">&quot;b974bdfd-bb73-4f0a-8a0d-85d867681ed0&quot;</span>, <span class="attr">url:</span> <span class="string">&#x27;https://root@gitlab.example.com/root/test-repo.git&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;Print env variable&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Print env variable&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;Current deployment environment is $deploy_env&quot; &gt;&gt; test.properties</span></span><br><span class="line"><span class="string">                    echo &quot;The build is $version&quot; &gt;&gt; test.properties</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;Check test properties&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                dir (<span class="string">&quot;$&#123;env.WORKSPACE&#125;&quot;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    echo &quot;[INFO] Check test properties&quot;</span></span><br><span class="line"><span class="string">                    if [ -s test.properties ]</span></span><br><span class="line"><span class="string">                    then </span></span><br><span class="line"><span class="string">                        cat test.properties</span></span><br><span class="line"><span class="string">                        echo &quot;[INFO] Done...&quot;</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        echo &quot;test.properties is empty&quot;</span></span><br><span class="line"><span class="string">                    fi</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">                    echo <span class="string">&quot;[INFO] Build finished...&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>“保存”之后，点击“立即构建”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109145708989-943685020-20201126190250188.png" class title="img">

<p>报错，点击查看报错信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109145822391-1260621257-20201126190250203.png" class title="img">

<p>根据错误提示：没有找到对应参数的变量，是因为首次构建pipeline job时，参数没有被引用到当前pipeline job当中，返回test-pipeline-job主界面，此时的“立即构建”按钮会变为“Build with Parameters”,点击“Build with Parameters”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109150419295-1383499991-20201126190250215.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%89)/804543-20190109150446540-1007804867-20201126190250218.png" class title="img">

<p>可以看到第二次构建是成功的，点击#2前的蓝色圆球查看输出信息</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Started <span class="keyword">by</span> user admin</span><br><span class="line">Running <span class="keyword">in</span> Durability level: MAX_SURVIVABILITY</span><br><span class="line">[<span class="meta">Pipeline</span>] node</span><br><span class="line">Running <span class="keyword">on</span> Jenkins <span class="keyword">in</span> /<span class="keyword">var</span>/lib/jenkins/workspace/test-pipeline-job</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123;</span><br><span class="line">[<span class="meta">Pipeline</span>] withEnv</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123;</span><br><span class="line">[<span class="meta">Pipeline</span>] stage</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123; (Checkout test repo)</span><br><span class="line">[<span class="meta">Pipeline</span>] sh</span><br><span class="line">+ git config --<span class="keyword">global</span> http.sslVerify <span class="literal">false</span></span><br><span class="line">[<span class="meta">Pipeline</span>] dir</span><br><span class="line">Running <span class="keyword">in</span> /<span class="keyword">var</span>/lib/jenkins/workspace/test-pipeline-job</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123;</span><br><span class="line">[<span class="meta">Pipeline</span>] git</span><br><span class="line"> &gt; git rev-parse --<span class="keyword">is</span>-inside-work-tree <span class="meta"># timeout=10</span></span><br><span class="line">Fetching changes <span class="keyword">from</span> the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:<span class="comment">//root@gitlab.example.com/root/test-repo.git # timeout=10</span></span><br><span class="line">Fetching upstream changes <span class="keyword">from</span> https:<span class="comment">//root@gitlab.example.com/root/test-repo.git</span></span><br><span class="line"> &gt; git --version <span class="meta"># timeout=10</span></span><br><span class="line"><span class="keyword">using</span> GIT_ASKPASS to <span class="keyword">set</span> credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="comment">//root@gitlab.example.com/root/test-repo.git +refs/heads/*:refs/remotes/origin/*</span></span><br><span class="line"> &gt; git rev-parse refs/remotes/origin/master^&#123;commit&#125; <span class="meta"># timeout=10</span></span><br><span class="line"> &gt; git rev-parse refs/remotes/origin/origin/master^&#123;commit&#125; <span class="meta"># timeout=10</span></span><br><span class="line"><span class="function">Checking <span class="keyword">out</span> Revision <span class="title">dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef</span> (<span class="params">refs/remotes/origin/master</span>)</span></span><br><span class="line"><span class="function"> &gt; git config core.sparsecheckout # timeout</span>=<span class="number">10</span></span><br><span class="line"> &gt; git checkout -f dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef</span><br><span class="line"> &gt; git branch -a -v --no-abbrev <span class="meta"># timeout=10</span></span><br><span class="line"> &gt; git branch -D master <span class="meta"># timeout=10</span></span><br><span class="line"> &gt; git checkout -b master dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef</span><br><span class="line">Commit message: <span class="string">&quot;Merge branch &#x27;release-1.0.0&#x27; into &#x27;master&#x27;&quot;</span></span><br><span class="line"> &gt; git rev-list --no-walk dd39fbeeb70dd5e2d545dfe084c3d540d106d6ef <span class="meta"># timeout=10</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// dir</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// stage</span></span><br><span class="line">[<span class="meta">Pipeline</span>] stage</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123; (Print env variable)</span><br><span class="line">[<span class="meta">Pipeline</span>] dir</span><br><span class="line">Running <span class="keyword">in</span> /<span class="keyword">var</span>/lib/jenkins/workspace/test-pipeline-job</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123;</span><br><span class="line">[<span class="meta">Pipeline</span>] sh</span><br><span class="line">+ echo <span class="string">&#x27;[INFO] Print env variable&#x27;</span></span><br><span class="line">[<span class="meta">INFO</span>] Print env variable</span><br><span class="line">+ echo <span class="string">&#x27;Current deployment environment is dev&#x27;</span></span><br><span class="line">+ echo <span class="string">&#x27;The build is 1.0.0&#x27;</span></span><br><span class="line">+ echo <span class="string">&#x27;[INFO] Done...&#x27;</span></span><br><span class="line">[<span class="meta">INFO</span>] Done...</span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// dir</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// stage</span></span><br><span class="line">[<span class="meta">Pipeline</span>] stage</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123; (Check test properties)</span><br><span class="line">[<span class="meta">Pipeline</span>] dir</span><br><span class="line">Running <span class="keyword">in</span> /<span class="keyword">var</span>/lib/jenkins/workspace/test-pipeline-job</span><br><span class="line">[<span class="meta">Pipeline</span>] &#123;</span><br><span class="line">[<span class="meta">Pipeline</span>] sh</span><br><span class="line">+ echo <span class="string">&#x27;[INFO] Check test properties&#x27;</span></span><br><span class="line">[<span class="meta">INFO</span>] Check test properties</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -s test.properties <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ cat test.properties</span><br><span class="line">Current deployment environment <span class="keyword">is</span> dev</span><br><span class="line">The build <span class="keyword">is</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">+ echo <span class="string">&#x27;[INFO] Done...&#x27;</span></span><br><span class="line">[<span class="meta">INFO</span>] Done...</span><br><span class="line">[<span class="meta">Pipeline</span>] echo</span><br><span class="line">[<span class="meta">INFO</span>] Build finished...</span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// dir</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// stage</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// withEnv</span></span><br><span class="line">[<span class="meta">Pipeline</span>] &#125;</span><br><span class="line">[<span class="meta">Pipeline</span>] <span class="comment">// node</span></span><br><span class="line">[<span class="meta">Pipeline</span>] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>



<p>可以看到输出状态为“SUCCESS”，证明构建成功。</p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(五)</title>
    <url>/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/</url>
    <content><![CDATA[<p><strong>Freestyle Job实现静态网站部署交付（接Jenkins+Gitlab+Ansible自动化部署（四</strong></p>
<ul>
<li>环境构建</li>
<li>编写ansible playbook脚本实现静态网页远程部署</li>
<li>将playbook部署脚本提交到GitLab仓库</li>
<li>构建Freestyle Job任务框架</li>
<li>Jenkins集成Ansible与Gitlab实现静态网页的自动化部署</li>
</ul>
<p>首先确定自己的环境已经准备完毕。</p>
<p>登录gitlab查看</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110114757705-2039134505.png" class title="img">

<p>登录Jenkins首页</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110114859004-607837330.png" class title="img">

<p>登录Jenkins主机查看Ansible2.5+python 3.6虚拟环境</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">$ ssh <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.244</span><span class="number">.131</span></span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">13</span>:<span class="number">40</span>:<span class="number">48</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.1</span></span><br><span class="line"><span class="string">[root@jenkins ~]</span># su - deploy</span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">20</span>:<span class="number">24</span>:<span class="number">43</span> CST <span class="number">2019</span> on pts/<span class="number">0</span></span><br><span class="line"><span class="string">[deploy@jenkins ~]</span>$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/bin/activate           (.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/hacking/env-setup -q</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ ansible --version</span><br><span class="line">ansible <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> c748512c4c) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$</span><br></pre></td></tr></table></figure>

<p>准备就绪，开始编写ansible playbook脚本实现静态网页远程部署，打开Git bash命令行，将之前创建好的ansible-playbook-repo仓库clone到本地：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~</span><br><span class="line">$ git config --global http.sslVerify <span class="literal">false</span></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~</span><br><span class="line">$ cd Desktop/repo/</span><br><span class="line">$  git clone https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo.git</span></span><br><span class="line">Cloning <span class="built_in">int</span>o <span class="string">&#x27;ansible-playbook-repo&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">remote: Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">9</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">11</span>:<span class="number">57</span> ansible-playbook.txt</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">02</span> nginx_playbooks/</span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">312</span> <span class="number">7</span>月  <span class="number">15</span> <span class="number">08</span>:<span class="number">33</span> nginx-freestyle-job.sh</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">02</span> test_playbooks/</span><br></pre></td></tr></table></figure>

<p>开始配置</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">2</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">17</span> <span class="number">7</span>月  <span class="number">17</span> <span class="number">21</span>:<span class="number">06</span> deploy.retry</span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">80</span> <span class="number">7</span>月  <span class="number">17</span> <span class="number">21</span>:<span class="number">06</span> deploy.yml</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>  <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">02</span> inventory/</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>  <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">02</span> roles/</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim deploy.yml</span><br><span class="line">- hosts: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  gather_facts: <span class="keyword">true</span></span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - nginx</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim inventory/prod</span><br><span class="line">[nginx]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[nginx:vars]</span><br><span class="line">server_name=test.example.com</span><br><span class="line">port=<span class="number">80</span></span><br><span class="line">user=deploy</span><br><span class="line">worker_processes=<span class="number">4</span></span><br><span class="line">max_open_file=<span class="number">65505</span></span><br><span class="line">root=/www</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim inventory/dev</span><br><span class="line">[nginx]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[nginx:vars]</span><br><span class="line">server_name=test.example.com</span><br><span class="line">port=<span class="number">80</span></span><br><span class="line">user=deploy</span><br><span class="line">worker_processes=<span class="number">4</span></span><br><span class="line">max_open_file=<span class="number">65505</span></span><br><span class="line">root=/www</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/nginx/</span>files/health_check.sh</span><br><span class="line">#!<span class="regexp">/bin/</span>sh</span><br><span class="line"></span><br><span class="line">URL=$<span class="number">1</span></span><br><span class="line"></span><br><span class="line">curl -Is http:<span class="comment">//$URL &gt; /dev/null &amp;&amp; echo &quot;The remote side is healthy&quot; || echo &quot;The remote side is failed, please check&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ cat roles<span class="regexp">/nginx/</span>files/index.html</span><br><span class="line"><span class="keyword">This</span> is my first website</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/nginx/</span>templates/nginx.conf.j2</span><br><span class="line"># <span class="keyword">For</span> more information on configuration, see:</span><br><span class="line">user              &#123;&#123; user &#125;&#125;;</span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;</span><br><span class="line"></span><br><span class="line">error_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>error.log;</span><br><span class="line"></span><br><span class="line">pid        <span class="regexp">/var/</span>run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="keyword">include</span>       <span class="regexp">/etc/</span>nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  <span class="number">0</span>;</span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    # Load config files <span class="keyword">from</span> the <span class="regexp">/etc/</span>nginx/conf.d directory</span><br><span class="line">    # The <span class="keyword">default</span> server is in conf.d/<span class="keyword">default</span>.conf</span><br><span class="line">    #<span class="keyword">include</span> <span class="regexp">/etc/</span>nginx<span class="regexp">/conf.d/</span>*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;</span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   &#123;&#123; root &#125;&#125;;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page  <span class="number">404</span>              /<span class="number">404</span>.html;</span><br><span class="line">        location = /<span class="number">404</span>.html &#123;</span><br><span class="line">            root   <span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the <span class="keyword">static</span> page /<span class="number">50</span>x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line">        location = /<span class="number">50</span>x.html &#123;</span><br><span class="line">            root   <span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/nginx/</span>tasks/main.yml</span><br><span class="line">- name: Disable system firewall</span><br><span class="line">  service: name=firewalld state=stopped</span><br><span class="line"></span><br><span class="line">- name: Disable SELINUX</span><br><span class="line">  selinux: state=disabled</span><br><span class="line"></span><br><span class="line">- name: setup nginx yum <span class="keyword">source</span></span><br><span class="line">  yum: pkg=epel-release state=latest</span><br><span class="line"></span><br><span class="line">- name: <span class="keyword">write</span> then nginx config <span class="keyword">file</span></span><br><span class="line">  template: src=roles<span class="regexp">/nginx/</span>templates<span class="regexp">/nginx.conf.j2 dest=/</span>etc<span class="regexp">/nginx/</span>nginx.conf</span><br><span class="line"></span><br><span class="line">- name: create nginx root folder</span><br><span class="line">  <span class="keyword">file</span>: <span class="string">&#x27;path=&#123;&#123; root &#125;&#125; state=directory owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125; mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: <span class="keyword">copy</span> index.html to remote</span><br><span class="line">  <span class="keyword">copy</span>: <span class="string">&#x27;remote_src=no src=roles/nginx/files/index.html dest=/www/index.html mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: restart nginx service</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"></span><br><span class="line">- name: run the health check locally</span><br><span class="line">  shell: <span class="string">&quot;sh roles/nginx/files/health_check.sh &#123;&#123; server_name &#125;&#125;&quot;</span></span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: msg=<span class="string">&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>将配置好的文件，提交到远程gitlab</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>nginx_playbooks (master)</span><br><span class="line">$ cd ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo/ansible-playbook-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo/ansible-playbook-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First commit&quot;</span></span><br><span class="line">[master <span class="number">06431</span>dc] First commit</span><br><span class="line"> <span class="number">8</span> files changed, <span class="number">122</span> deletions(-)</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks/deploy.retry</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks/deploy.yml</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/inventory/</span>dev</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/inventory/</span>prod</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/roles/</span>nginx<span class="regexp">/files/</span>health_check.sh</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/roles/</span>nginx<span class="regexp">/files/i</span>ndex.html</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/roles/</span>nginx<span class="regexp">/tasks/m</span>ain.yml</span><br><span class="line"> <span class="keyword">delete</span> mode <span class="number">100644</span> test_playbooks<span class="regexp">/roles/</span>nginx<span class="regexp">/templates/</span>nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo/ansible-playbook-repo (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">2</span><span class="regexp">/2), 212 bytes | 212.00 KiB/</span>s, done.</span><br><span class="line">Total <span class="number">2</span> (delta <span class="number">1</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git</span><br><span class="line">   <span class="number">169</span>dec7..<span class="number">06431</span>dc  master -&gt; master</span><br></pre></td></tr></table></figure>

<p>返回到Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110123958236-403778399.png" class title="img">

<p>添加描述</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124110288-1434823474.png" class title="img">

<p>添加Git仓库（该仓库地址即为上述配置的ansible-playbook-repo的仓库地址）</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124237561-37305220.png" class title="img">

<p>参数化构建过程</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110125704491-2057128880.png" class title="img">

<p>添加构建步骤</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110124349459-278531014.png" class title="img">

<p>在执行shell弹出的输入框内输入以下内容</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">#<span class="regexp">/bin/</span>sh</span><br><span class="line"></span><br><span class="line">set +x</span><br><span class="line"><span class="keyword">source</span> <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>bin/activate</span><br><span class="line"><span class="keyword">source</span> <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>ansible<span class="regexp">/hacking/</span>env-setup -q</span><br><span class="line"></span><br><span class="line">cd $WORKSPACE/nginx_playbooks</span><br><span class="line">ansible --version</span><br><span class="line">ansible-playbook --version</span><br><span class="line"></span><br><span class="line">ansible-playbook -i inventory<span class="regexp">/$deploy_env ./</span>deploy.yml -e <span class="keyword">project</span>=nginx -e branch=$branch -e env=$deploy_env</span><br></pre></td></tr></table></figure>

<p>点击“Save”，然后点击“Build with Parameters”，在右侧下拉列表中选择dev，点击“Build”</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110125928002-1300800677.png" class title="img">

<p>查看输出信息</p>
<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130432060-169697566.png" class title="img">

<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130455058-1081834209.png" class title="img">

<p>验证目标主机是否部署成功，在浏览器输入test.exmaple.com查看</p>
<p>前提是保证本地windows主机下的C:\Windows\System32\drivers\etc\hosts文件中末尾有如下对应关系</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168.244.130</span> gitlab.example.com</span><br><span class="line"><span class="number">192.168.244.131</span> jenkins.example.com</span><br><span class="line"><span class="number">192.168.244.132</span> ansible.example.com</span><br><span class="line"><span class="number">192.168.244.133</span> test.example.com</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%94)/804543-20190110130936245-979652804.png" class title="img">

<p>可以看到已经成功部署~</p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins-pipeline的创建和参数传递</title>
    <url>/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/</url>
    <content><![CDATA[<h2 id="一、单分支的pipeline"><a href="#一、单分支的pipeline" class="headerlink" title="一、单分支的pipeline"></a><strong>一、单分支的pipeline</strong></h2><p>Pipline的特点是可以多节点运行，节点之间可以并行或者串行执行，从而实现编译-部署-部署的持续化构建和发布。</p>
<p>与自由风格不同的是，我们可以通过编写功能强大的Jenkinsfile脚本，来实现我们所需要的功能，比如：执行shell，执行bat，重试，等待，并行/串行，发邮件，触发其他工程。难点在于需要遵循一定的Groovy语法。有一定的学习成本。</p>
<ol>
<li><h4 id="job的创建"><a href="#job的创建" class="headerlink" title="job的创建"></a>job的创建</h4></li>
</ol>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-d0c14a7f65815132bf26825168817ae9188.png" class title="img">





<h4 id="2-job的配置"><a href="#2-job的配置" class="headerlink" title="2. job的配置"></a>2. job的配置</h4><p>最主要的就是如下图的脚本编写。</p>
<p>（1）选择pipeline script 则就是在文本框中中编写执行的脚本</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-42989560c0b158a8e7472757b1143d92fa6.png" class title="img">

<p>（2）选择pipeline script from scm 则需要指定git项目地址，并在项目路径下创建一个名为Jenkinsfile的文本文件, 然后编写Groovy脚本。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-e539db5914ca4e803acfe33b91fbaafcec3.png" class title="img">

<p>（3）Groovy语法参考：</p>
<p><a href="https://www.jenkins.io/zh/doc/pipeline/tour/getting-started/">https://www.jenkins.io/zh/doc/pipeline/tour/getting-started/</a></p>
<h2 id="二、多分支的pipeline"><a href="#二、多分支的pipeline" class="headerlink" title="二、多分支的pipeline"></a><strong>二、多分支的pipeline</strong></h2><p>顾名思义，多分支pipeline就是能够实现每个分支都可以实现流水线，前提是需要每个分支下都有一个名为Jenkinsfile的文本文件。</p>
<h3 id="1-传统配置："><a href="#1-传统配置：" class="headerlink" title="1. 传统配置："></a><strong>1. 传统配置：</strong></h3><p>新建任务的时候，选择如下类型</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-fb546dc5b749db89c584a5f2c5e4768c2f1.png" class title="img">

<p><strong>配置</strong>。主要就是确定项目的地址。其余默认即可。此项目下的所有分支都会寻找一个Jenkinsfile的文本文件。如果找到了就执行，没有找到就放弃。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-8b0432ba5447e65fd4105f915af386b5001.png" class title="img">



<p>比如，我的一个am项目路径下master分支的Jenkinsfile文件，如下图：</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-7cb5d2fd0f46675ad8d53ad71660bc3728f.png" class title="img">

<p><strong>面板查看</strong>。提供一些简要信息，比如编译的哪些项目，编译时间，点击可以查看具体项目的日志。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-496ab70e31c3e0c7ab0dceb2d28be7ec5b5.png" class title="img">



<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="2-Blue-ocean创建："><a href="#2-Blue-ocean创建：" class="headerlink" title="2. Blue ocean创建："></a><strong>2. Blue ocean创建：</strong></h3><p>Blue ocean视图是专门为流水线任务打造的，可以实现创建、编辑、查看日志等功能。点击上图中的左边 “打开Blue Ocean” 即可进入。</p>
<p>比如am 项目下有三个分支都有jenkinsfile，所以显示了三个分支，并且每个分支执行都是成功的。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-c559495da3e9bb80847dfe1fe71b4894b34.png" class title="img">

<p>可点击master分支，查看详情。Build Test Deploy是顺序运行的三个阶段（stage）每个stage中可以包含多个步骤（step）。点击右上角的编辑按钮，可以实现编辑。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-d5961cb90b3183d0a7b291b800cad9f719b.png" class title="img">

<p>点击图中的+号，可以在右侧添加步骤，保存后会在相应分支生成Jenkinsfile文件。更加详细的步骤可以参考：<a href="https://www.jenkins.io/zh/doc/book/blueocean">https://www.jenkins.io/zh/doc/book/blueocean</a></p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-b9ab5a63a198c1ed421cc679aca0ac238af.png" class title="img">







<h2 id="三、-注意事项"><a href="#三、-注意事项" class="headerlink" title="三、 注意事项"></a><strong>三、 注意事项</strong></h2><h4 id="（1）参数化构建。"><a href="#（1）参数化构建。" class="headerlink" title="（1）参数化构建。"></a>（1）参数化构建。</h4><p>如果想实现和自由风格一样的参数化构建功能，在选项栏中直接配置是不行的，如下设置是不生效的</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-9dc966a3419d119122f8949cc72191bab94.png" class title="img">

<p>脚本内容：  </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">    pipeline &#123;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line"></span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      steps &#123;</span><br><span class="line"></span><br><span class="line">           echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上脚本，在脚本里获取参数是不行的，即${isPublishVersion} 为null。</p>
<p>解决方案：参数化构建需要在脚本里定义，而不是在选项栏中配置。脚本参考：   </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"> pipeline &#123;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line"></span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parameters &#123;</span><br><span class="line"></span><br><span class="line">          booleanParam(<span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">defaultValue:</span> <span class="literal">false</span>, <span class="attr">description:</span> <span class="string">&#x27;默认不发布&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          choice(<span class="attr">choices:</span> [<span class="string">&#x27;origin/release-bugfix&#x27;</span>, <span class="string">&#x27;origin/release&#x27;</span>, <span class="string">&#x27;origin/master&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;构建分支选择，默认origin/release-bugfix&#x27;</span> , <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stages &#123;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      steps &#123;</span><br><span class="line"></span><br><span class="line">           echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存此脚本后，参数化构建选项栏将会自动根据脚本的参数设置自动生成。如此可实现和普通项目一样的参数选择构建。</p>
<h4 id="2-多项目间参数传递："><a href="#2-多项目间参数传递：" class="headerlink" title="2. 多项目间参数传递："></a>2. 多项目间参数传递：</h4><p>流水线中可能会执行多个任务，每个任务执行在不同机器上，而子项目可能会依赖一些参数设置，此时，在执行子项目时就需要传递参数。</p>
<p>对于String类型的传递，可以使用如下方式，GIT_LOCAL_BRANCH 参数便是前面脚本里设置的，现在需要传给zerotrust-idam-framework-dailybuild-IAM项目。请注意值的取法：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-framework-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [string(<span class="attr">name:</span><span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>)]</span><br></pre></td></tr></table></figure>

<p>对于Boolean类型的参数传递，只能使用如下方式</p>
<figure class="highlight scheme"><table><tr><td class="code"><pre><span class="line">[<span class="name">$class:</span> <span class="symbol">&#x27;BooleanParameterValue</span>&#x27;, name: <span class="symbol">&#x27;isPublishVersion</span>&#x27;, value:  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>如果Boolean和String类型都需要传递，则只能使用以下方式</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-am-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line"></span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line"></span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span>  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line"></span><br><span class="line">            ]</span><br></pre></td></tr></table></figure>

<p>另外，注意boolean类型的值传递其实也是string类型，所以前面的boolean参数值传递写法为:</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">value:</span> <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<p>最后，贴下自己写的流水线脚本，仅供参考。实现了job的参数化构建，以及job间的参数传递：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label <span class="string">&#x27;idam_4.244&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  parameters &#123;</span><br><span class="line">          booleanParam(<span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">defaultValue:</span> <span class="literal">false</span>, <span class="attr">description:</span> <span class="string">&#x27;默认不发布&#x27;</span>)</span><br><span class="line">          choice(<span class="attr">choices:</span> [<span class="string">&#x27;origin/release&#x27;</span>,<span class="string">&#x27;origin/release-bugfix&#x27;</span>, <span class="string">&#x27;origin/master&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;构建分支选择，默认origin/release-bugfix&#x27;</span> , <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;buildFramework&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">	    echo <span class="string">&quot;GIT_LOCAL_BRANCH: $&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;isPublishVersion: $&#123;params.isPublishVersion&#125;&quot;</span></span><br><span class="line">        build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-framework-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [string(<span class="attr">name:</span><span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>)]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;buildIAM&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">        stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-idm-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-authz-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span>  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">            build <span class="attr">job:</span> <span class="string">&#x27;zerotrust-idam-am-dailybuild-IAM&#x27;</span>, <span class="attr">parameters:</span> [</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;StringParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;GIT_LOCAL_BRANCH&#x27;</span>, <span class="attr">value:</span> <span class="string">&quot;$&#123;params.GIT_LOCAL_BRANCH&#125;&quot;</span>],</span><br><span class="line">              [<span class="attr">$class:</span> <span class="string">&#x27;BooleanParameterValue&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;isPublishVersion&#x27;</span>, <span class="attr">value:</span>  <span class="string">&quot;$&#123;params.isPublishVersion&#125;&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;deploy&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">            stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-idm-dailydeploy&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-am-dailyDeploy&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;smoke&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">            stage(<span class="string">&#x27;IDM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-idm-smoke&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stage(<span class="string">&#x27;AM&#x27;</span>) &#123;</span><br><span class="line">              steps &#123;</span><br><span class="line">                build <span class="string">&#x27;zerotrust-idam-am-smoke&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行过后的Ocean Blue视图：smoke阶段的IDM步骤构建失败了。</p>
<img src="/sugw.github.io/2020/12/08/Jenkins-pipeline%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/up-5ade856b069dc30e49305e58db6479db001.png" class title="img">]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql数据库查询大小</title>
    <url>/sugw.github.io/2020/10/27/Mysql%20%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<h2 id="查询库大小"><a href="#查询库大小" class="headerlink" title="查询库大小"></a>查询库大小</h2><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>查看所有数据库容量大小</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">sum(table_rows) <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">sum(<span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">sum(<span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.<span class="keyword">tables</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> table_schema</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sum(data_length) <span class="keyword">desc</span>, sum(index_length) <span class="keyword">desc</span>;</span><br><span class="line"><span class="number">2.</span>查看所有数据库各表容量大小</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line"><span class="built_in">table_name</span> <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.<span class="keyword">tables</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br><span class="line"><span class="number">3.</span>查看指定数据库容量大小</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">sum(table_rows) <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line">sum(<span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line">sum(<span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.<span class="keyword">tables</span></span><br><span class="line"><span class="keyword">where</span> table_schema=<span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>查看指定数据库各表容量大小</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line"><span class="built_in">table_name</span> <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.<span class="keyword">tables</span></span><br><span class="line"><span class="keyword">where</span> table_schema=<span class="string">&#x27;mysql&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="查询表大小"><a href="#查询表大小" class="headerlink" title="查询表大小"></a>查询表大小</h2><h3 id="1、首先，切换到-information-schema数据库"><a href="#1、首先，切换到-information-schema数据库" class="headerlink" title="1、首先，切换到 information_schema数据库"></a>1、首先，切换到 information_schema数据库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use information_schema;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2、查询mysql数据最大的10张表"><a href="#2、查询mysql数据最大的10张表" class="headerlink" title="2、查询mysql数据最大的10张表"></a>2、查询mysql数据最大的10张表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select TABLE_SCHEMA,table_name,table_rows,ENGINE,DATA_LENGTH,MAX_DATA_LENGTH,DATA_FREE from  tables order by table_rows desc limit 10;</span><br></pre></td></tr></table></figure>

<p><strong>这是查询mysql数据最大的10张表，不区分数据库的</strong></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql 批量删除表</title>
    <url>/sugw.github.io/2020/10/27/Mysql%20%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E8%A1%A8/</url>
    <content><![CDATA[<h2 id="生成删除表语句"><a href="#生成删除表语句" class="headerlink" title="生成删除表语句"></a>生成删除表语句</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -h主机 -D库 -u用户 -p密码 -e &quot;Select CONCAT( &#x27;drop tables &#x27;, table_name, &#x27;;&#x27; ) FROM information_schema.tables Where table_name LIKE &#x27;sample_%&#x27;;&quot; &gt;delete_tables.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="批量删除表"><a href="#批量删除表" class="headerlink" title="批量删除表"></a>批量删除表</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -h主机 -D库 -u用户 -p密码 -e &quot;source /opt/delete_tables.sql&quot;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysqldump备份数据库时排除某些库</title>
    <url>/sugw.github.io/2020/11/17/Mysqldump%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%8E%92%E9%99%A4%E6%9F%90%E4%BA%9B%E5%BA%93/</url>
    <content><![CDATA[<p><strong>说明：</strong><br>使用mysqldump –all-databases会导出所有库。但如果做主从，从主库dump出数据时，我们是不需要也不想要information_schema 和 mysql 库的。数据库少的情况下还可以通过<code>/usr/local/mysql/bin/mysqldump -uroot -p --databases db1 db2 &gt; db1db2.sql</code> 这样再导出，但如果数据多，这样指定就很麻烦了。<br>mysql是支持 ignore-table 的，但是没有ignore-database，所以要导出除 information_schema和mysql库的其它所有库，难道就只能一个个指定database吗？</p>
<p><strong>解决：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql -e &quot;show databases;&quot; -uroot -p| grep -Ev &quot;Database|information_schema|mysql|test&quot; | xargs mysqldump -uroot -p --databases &gt; mysql_dump.sql</span></span><br></pre></td></tr></table></figure>


<p><strong>附录：</strong><br>附录1：mysqldump: Got error: 1142: SELECT,LOCK TABL command denied to user ‘root’@’localhost’ for table ‘cond_instances’ when using LOCK TABLES<br>在mysql5.5中增加了performance_schema，当我们进行mysqldump的时候，会报如下错误信息：<br>mysqldump: Got error: 1142: SELECT,LOCK TABL command denied to user ‘root’@’localhost’ for table ‘cond_instances’ when using LOCK TABLES</p>
<p>我们可以在mysqldump中加上参数 –skip-lock-tables，如</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysqldump  -uroot  -p   --skip-lock-tables  performance_schema &gt; performance_schema.sql </span></span><br></pre></td></tr></table></figure>

<p>或者过滤掉performance_schema这个库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql -e &quot;show databases;&quot; -uroot -p| grep -Ev &quot;Database|information_schema|mysql|test|performance_schema&quot; | xargs mysqldump -uroot -p --databases &gt; mysql_dump.sql</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx优化详解</title>
    <url>/sugw.github.io/2020/11/19/Nginx%E4%BC%98%E5%8C%96%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="一、一般来说nginx-配置文件中对优化比较有作用的为以下几项："><a href="#一、一般来说nginx-配置文件中对优化比较有作用的为以下几项：" class="headerlink" title="一、一般来说nginx 配置文件中对优化比较有作用的为以下几项："></a><strong>一、一般来说nginx 配置文件中对优化比较有作用的为以下几项：</strong></h2><h3 id="1-worker-processes-8"><a href="#1-worker-processes-8" class="headerlink" title="1. worker_processes 8;"></a><strong>1. worker_processes 8;</strong></h3><p>​     nginx 进程数，建议按照cpu 数目来指定，一般为它的倍数 (如,2个四核的cpu计为8)。</p>
<p>   <strong>2. worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</strong></p>
<p>​     为每个进程分配cpu，上例中将8 个进程分配到8 个cpu，当然可以写多个，或者将一个进程分配到多个cpu。</p>
<p>   <strong>3.</strong> <strong>worker_rlimit_nofile 65535;</strong></p>
<p>​     这个指令是指当一个nginx 进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx 进程数相除，但是nginx 分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致。</p>
<p>​     现在在linux 2.6内核下开启文件打开数为65535，worker_rlimit_nofile就相应应该填写65535。</p>
<p>​     这是因为nginx调度时分配请求到进程并不是那么的均衡，所以假如填写10240，总并发量达到3-4万时就有进程可能超过10240了，这时会返回502错误。</p>
<p>​     查看linux系统文件描述符的方法：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[root@web001 ~]</span><span class="comment"># sysctl -a | grep fs.file</span></span><br><span class="line"></span><br><span class="line">                 <span class="attr">fs.file-max</span> = <span class="number">789972</span></span><br><span class="line"></span><br><span class="line">                 <span class="attr">fs.file-nr</span> = <span class="number">510</span> <span class="number">0</span> <span class="number">789972</span></span><br></pre></td></tr></table></figure>

<p>   <strong>4.</strong> <strong>use epoll;</strong></p>
<p>​     使用epoll 的I/O 模型</p>
<p>​     (</p>
<p>​     补充说明:</p>
<p>​       与apache相类，nginx针对不同的操作系统，有不同的事件模型</p>
<p>​       A）标准事件模型<br>​         Select、poll属于标准事件模型，如果当前系统不存在更有效的方法，nginx会选择select或poll<br>​       B）高效事件模型<br>​         <strong>Kqueue：</strong>使用于 FreeBSD 4.1+, OpenBSD 2.9+, NetBSD 2.0 和 MacOS X. 使用双处理器的MacOS X系统使用kqueue可能会造成内核崩溃。<br>​         <strong>Epoll:</strong> 使用于Linux内核2.6版本及以后的系统。</p>
<p>​         /dev/poll：使用于 Solaris 7 11/99+, HP/UX 11.22+ (eventport), IRIX 6.5.15+ 和 Tru64 UNIX 5.1A+。</p>
<p>​         Eventport：使用于 Solaris 10. 为了防止出现内核崩溃的问题， 有必要安装安全补丁。</p>
<p>​     )</p>
<p>​    <strong>5.</strong> <strong>worker_connections 65535;</strong></p>
<p>​      每个进程允许的最多连接数， 理论上每台nginx 服务器的最大连接数为worker_processes*worker_connections。</p>
<p>​    <strong>6.</strong> <strong>keepalive_timeout 60;</strong></p>
<p>​      keepalive 超时时间。</p>
<p>​    <strong>7**</strong>.** <strong>client_header_buffer_size 4k;</strong></p>
<p>​      客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</p>
<p>​      分页大小可以用命令<strong>getconf PAGESIZE</strong> 取得。</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@web001 ~]</span># getconf PAGESIZE</span><br><span class="line">                 <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<p>​     但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为<strong>“系统分页大小”的整倍数。</strong></p>
<p>​    <strong>8**</strong>.** <strong>open_file_cache max=65535 inactive=60s;</strong></p>
<p>​      这个将为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件数一致，inactive 是指经过多长时间文件没被请求后删除缓存。</p>
<p>​    <strong>9**</strong>.** <strong>open_file_cache_valid 80s;</strong></p>
<p>​     这个是指多长时间检查一次缓存的有效信息。</p>
<p>   <strong>10**</strong>.** <strong>open_file_cache_min_uses 1;</strong></p>
<p>​     open_file_cache 指令中的inactive 参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive 时间内一次没被使用，它将被移除。</p>
<h1 id="二、关于内核参数的优化："><a href="#二、关于内核参数的优化：" class="headerlink" title="二、关于内核参数的优化："></a><strong>二、关于内核参数的优化：</strong></h1><p>​      <strong>net.ipv4.tcp_max_tw_buckets = 6000</strong></p>
<p>​        timewait 的数量，默认是180000。</p>
<p>​      <strong>net.ipv4.ip_local_port_range = 1024 65000</strong></p>
<p>​        允许系统打开的端口范围。</p>
<p>​      <strong>net.ipv4.tcp_tw_recycle = 1</strong></p>
<p>​        启用timewait 快速回收。</p>
<p>​      <strong>net.ipv4.tcp_tw_reuse = 1</strong></p>
<p>​        开启重用。允许将TIME-WAIT sockets 重新用于新的TCP 连接。</p>
<p>​      <strong>net.ipv4.tcp_syncookies = 1</strong></p>
<p>​        开启SYN Cookies，当出现SYN 等待队列溢出时，启用cookies 来处理。</p>
<p>​      <strong>net.core.somaxconn = 262144</strong></p>
<p>​        web 应用中listen 函数的backlog 默认会给我们内核参数的net.core.somaxconn 限制到128，而nginx 定义的NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。</p>
<p>​      <strong>net.core.netdev_max_backlog = 262144</strong></p>
<p>​        每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</p>
<p>​      <strong>net.ipv4.tcp_max_orphans = 262144</strong></p>
<p>​        系统中最多有多少个TCP 套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS 攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</p>
<p>​      <strong>net.ipv4.tcp_max_syn_backlog = 262144</strong></p>
<p>​        记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有128M 内存的系统而言，缺省值是1024，小内存的系统则是128。</p>
<p>​      <strong>net.ipv4.tcp_timestamps = 0</strong></p>
<p>​        时间戳可以避免序列号的卷绕。一个1Gbps 的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。这里需要将其关掉。</p>
<p>​      <strong>net.ipv4.tcp_synack_retries = 1</strong></p>
<p>​        为了打开对端的连接，内核需要发送一个SYN 并附带一个回应前面一个SYN 的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK 包的数量。</p>
<p>​      <strong>net.ipv4.tcp_syn_retries = 1</strong></p>
<p>​        在内核放弃建立连接之前发送SYN 包的数量。</p>
<p>​      <strong>net.ipv4.tcp_fin_timeout = 1</strong></p>
<p>​        如 果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2 状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是60 秒。2.2 内核的通常值是180 秒，3你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB 服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2 的危险性比FIN-WAIT-1 要小，因为它最多只能吃掉1.5K 内存，但是它们的生存期长些。</p>
<p>​      <strong>net.ipv4.tcp_keepalive_time = 30</strong></p>
<p>​        当keepalive 起用的时候，TCP 发送keepalive 消息的频度。缺省是2 小时。</p>
<h1 id="三、下面贴一个完整的内核优化设置"><a href="#三、下面贴一个完整的内核优化设置" class="headerlink" title="三、下面贴一个完整的内核优化设置:"></a><strong>三、下面贴一个完整的内核优化设置:</strong></h1><p>[</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#CentOS5</span>.<span class="number">5</span>中可以将所有内容清空直接替换为如下内容:</span><br><span class="line">vi /etc/sysctl<span class="selector-class">.conf</span> </span><br><span class="line"></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">0</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.rp_filter</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_source_route</span> = <span class="number">0</span></span><br><span class="line">   kernel<span class="selector-class">.sysrq</span> = <span class="number">0</span></span><br><span class="line">   kernel<span class="selector-class">.core_uses_pid</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span> = <span class="number">1</span></span><br><span class="line">   kernel<span class="selector-class">.msgmnb</span> = <span class="number">65536</span></span><br><span class="line">   kernel<span class="selector-class">.msgmax</span> = <span class="number">65536</span></span><br><span class="line">   kernel<span class="selector-class">.shmmax</span> = <span class="number">68719476736</span></span><br><span class="line">   kernel<span class="selector-class">.shmall</span> = <span class="number">4294967296</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_tw_buckets</span> = <span class="number">6000</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_sack</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_window_scaling</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_rmem</span> = <span class="number">4096</span> <span class="number">87380</span> <span class="number">4194304</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_wmem</span> = <span class="number">4096</span> <span class="number">16384</span> <span class="number">4194304</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.wmem_default</span> = <span class="number">8388608</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.rmem_default</span> = <span class="number">8388608</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.rmem_max</span> = <span class="number">16777216</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.wmem_max</span> = <span class="number">16777216</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.netdev_max_backlog</span> = <span class="number">262144</span></span><br><span class="line">   net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span> = <span class="number">262144</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_orphans</span> = <span class="number">3276800</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_syn_backlog</span> = <span class="number">262144</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_timestamps</span> = <span class="number">0</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_synack_retries</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syn_retries</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_recycle</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_mem</span> = <span class="number">94500000</span> <span class="number">915000000</span> <span class="number">927000000</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_fin_timeout</span> = <span class="number">1</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_keepalive_time</span> = <span class="number">30</span></span><br><span class="line">   net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_local_port_range</span> = <span class="number">1024</span> <span class="number">65000</span></span><br><span class="line"></span><br><span class="line">#使配置立即生效可使用如下命令：</span><br><span class="line"> /sbin/sysctl -p</span><br></pre></td></tr></table></figure>

<p>[</p>
<h1 id="四、下面是关于系统连接数的优化"><a href="#四、下面是关于系统连接数的优化" class="headerlink" title="四、下面是关于系统连接数的优化"></a><strong>四、下面是关于系统连接数的优化</strong></h1><p>​    <strong>linux 默认值 open files 和 max user processes 为 1024</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">ulimit</span> -n</span></span><br><span class="line"> 1024</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">ulimit</span> Cu</span></span><br><span class="line"> 1024</span><br></pre></td></tr></table></figure>

<p>   <strong>问题描述：</strong> </p>
<p>​      说明 server 只允许同时打开 1024 个文件，处理 1024 个用户进程</p>
<p>​      使用ulimit -a 可以查看当前系统的所有限制值，使用ulimit -n 可以查看当前的最大打开文件数。</p>
<p>​      新装的linux 默认只有1024 ，当作负载较大的服务器时，很容易遇到error: too many open files 。因此，需要将其改大。</p>
<p>   <strong>解决方法：</strong></p>
<p>​      使用 ulimit Cn 65535 可即时修改，但重启后就无效了。（注ulimit -SHn 65535 等效 ulimit -n 65535 ，-S 指soft ，-H 指hard)</p>
<p>​      有如下三种修改方式：</p>
<p>​         \1. 在/etc/rc.local 中增加一行 ulimit -SHn 65535<br>​         \2. 在/etc/profile 中增加一行 ulimit -SHn 65535<br>​         \3. 在**/etc/security/limits.conf** 最后增加：</p>
<p>​          <strong>* soft nofile 65535<br>​          * hard nofile 65535<br>​          * soft nproc 65535<br>​          * hard nproc 65535</strong></p>
<p>​       具体使用哪种，<strong>在 CentOS 中使用第1 种方式无效果，使用第3 种方式有效果</strong>，而在Debian 中使用第2 种有效果</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">ulimit</span> -n</span></span><br><span class="line">  65535</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">ulimit</span> -u</span></span><br><span class="line">  65535</span><br></pre></td></tr></table></figure>

<p>​      备注：ulimit 命令本身就有分软硬设置，加-H 就是硬，加-S 就是软，默认显示的是软限制</p>
<p>​      soft 限制指的是当前系统生效的设置值。 hard 限制值可以被普通用户降低。但是不能增加。 soft 限制不能设置的比 hard 限制更高。 只有 root 用户才能够增加 hard 限制值。</p>
<h1 id="五、下面是一个简单的nginx-配置文件："><a href="#五、下面是一个简单的nginx-配置文件：" class="headerlink" title="五、下面是一个简单的nginx 配置文件："></a><strong>五、下面是一个简单的nginx 配置文件：</strong></h1><p>[</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span> www www;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span> <span class="number">01000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span> /www/log/nginx_error.log <span class="literal">crit</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">pid</span> /usr/local/nginx/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">204800</span>;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">204800</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">include</span> mime.types;</span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_names_hash_bucket_size</span> <span class="number">128</span>;</span><br><span class="line">  <span class="attribute">client_header_buffer_size</span> <span class="number">2k</span>;</span><br><span class="line">  <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">4k</span>;</span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">8m</span>;</span><br><span class="line">  <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">keepalive_timeout</span> <span class="number">60</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache_path</span> /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span></span><br><span class="line">  keys_zone=TEST:<span class="number">10m</span></span><br><span class="line">  inactive=<span class="number">5m</span>;</span><br><span class="line">  <span class="attribute">fastcgi_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_buffer_size</span> <span class="number">4k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_buffers</span> <span class="number">8</span> <span class="number">4k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_busy_buffers_size</span> <span class="number">8k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_temp_file_write_size</span> <span class="number">8k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache</span> TEST;</span><br><span class="line">  <span class="attribute">fastcgi_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">1h</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache_valid</span> <span class="number">301</span> <span class="number">1d</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache_min_uses</span> <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">fastcgi_cache_use_stale</span> <span class="literal">error</span> timeout invalid_header http_500;</span><br><span class="line">  <span class="attribute">open_file_cache</span> max=<span class="number">204800</span> inactive=<span class="number">20s</span>;</span><br><span class="line">  <span class="attribute">open_file_cache_min_uses</span> <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">open_file_cache_valid</span> <span class="number">30s</span>;</span><br><span class="line">  <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">  <span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>;</span><br><span class="line">  <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">  <span class="attribute">gzip_types</span> text/plain application/x-javascript text/css application/xml;</span><br><span class="line">  <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">  server</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> backup.aiju.com;</span><br><span class="line">    <span class="attribute">index</span> index.php index.htm;</span><br><span class="line">    <span class="attribute">root</span> /www/html/;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /status</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ .*/.(php|php5)?$</span></span><br><span class="line"><span class="regexp"></span>    &#123;</span><br><span class="line">     <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">     <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">     <span class="attribute">include</span> fcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ .*/.(gif|jpg|jpeg|png|bmp|swf|js|css)$</span></span><br><span class="line"><span class="regexp"></span>    &#123;</span><br><span class="line">     <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="attribute">log_format</span> access <span class="string">&#x27;<span class="variable">$remote_addr</span> — <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">    <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">    <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; <span class="variable">$http_x_forwarded_for</span>&#x27;</span>;</span><br><span class="line">    <span class="attribute">access_log</span> /www/log/access.log access;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[</p>
<h1 id="六、关于FastCGI-的几个指令："><a href="#六、关于FastCGI-的几个指令：" class="headerlink" title="六、关于FastCGI 的几个指令："></a><strong>六、关于FastCGI 的几个指令：</strong></h1><p>​    fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2 keys_zone=TEST:10minactive=5m;</p>
<p>​      这个指令为FastCGI 缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。</p>
<p>​    <strong>fastcgi_connect_timeout 300;</strong></p>
<p>​      指定连接到后端FastCGI 的超时时间。</p>
<p>​    <strong>fastcgi_send_timeout 300;</strong></p>
<p>​      向FastCGI 传送请求的超时时间，这个值是指已经完成两次握手后向FastCGI 传送请求的超时时间。</p>
<p>​    <strong>fastcgi_read_timeout 300;</strong></p>
<p>​      接收FastCGI 应答的超时时间，这个值是指已经完成两次握手后接收FastCGI 应答的超时时间。</p>
<p>​    <strong>fastcgi_buffer_size 4k;</strong></p>
<p>​      指定读取FastCGI 应答第一部分需要用多大的缓冲区，一般第一部分应答不会超过1k，由于页面大小为4k，所以这里设置为4k。</p>
<p>​    <strong>fastcgi_buffers 8 4k;</strong></p>
<p>​      指定本地需要用多少和多大的缓冲区来缓冲FastCGI 的应答。</p>
<p>​    <strong>fastcgi_busy_buffers_size 8k;</strong></p>
<p>​      这个指令我也不知道是做什么用，只知道默认值是fastcgi_buffers 的两倍。</p>
<p>​    <strong>fastcgi_temp_file_write_size 8k;</strong></p>
<p>​      在写入fastcgi_temp_path 时将用多大的数据块，默认值是fastcgi_buffers 的两倍。</p>
<p>​    <strong>fastcgi_cache TEST</strong></p>
<p>​       开启FastCGI 缓存并且为其制定一个名称。个人感觉开启缓存非常有用，可以有效降低CPU 负载，并且防止502 错误。</p>
<p>​    <strong>fastcgi_cache_valid 200 302 1h;<br>​    fastcgi_cache_valid 301 1d;<br>​    fastcgi_cache_valid any 1m;</strong></p>
<p>​       为指定的应答代码指定缓存时间，如上例中将200，302 应答缓存一小时，301 应答缓存1 天，其他为1 分钟。</p>
<p>​    <strong>fastcgi_cache_min_uses 1;</strong></p>
<p>​       缓存在fastcgi_cache_path 指令inactive 参数值时间内的最少使用次数，如上例，如果在5 分钟内某文件1 次也没有被使用，那么这个文件将被移除。</p>
<p>​    <strong>fastcgi_cache_use_stale error timeout invalid_header http_500;</strong></p>
<p>​       不知道这个参数的作用，猜想应该是让nginx 知道哪些类型的缓存是没用的。以上为nginx 中FastCGI 相关参数，另外，FastCGI 自身也有一些配置需要进行优化，如果你使用php-fpm 来管理FastCGI，可以修改配置文件中的以下值：</p>
<p>​       <strong><value name="”max_children”">60</value></strong></p>
<p>​         同时处理的并发请求数，即它将开启最多60 个子线程来处理并发连接。</p>
<p>​       <strong><value name="”rlimit_files”">102400</value></strong></p>
<p>​         最多打开文件数。</p>
<p>​       <strong><value name="”max_requests”">204800</value></strong></p>
<p>​         每个进程在重置之前能够执行的最多请求数。</p>
]]></content>
      <categories>
        <category>优化</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP-FPM 设置多pool、配置文件重写</title>
    <url>/sugw.github.io/2020/11/19/PHP-FPM%20%E8%AE%BE%E7%BD%AE%E5%A4%9Apool%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99/</url>
    <content><![CDATA[<p><strong>重写配置文件</strong></p>
<p><strong>1</strong>、清空php配置文件</p>
<p>命令：&gt; /usr/local/php/etc/php-fpm.conf</p>
<p><strong>2</strong>、重新写入php-fpm配置</p>
<p>命令：vim /usr/local/php/etc/php-fpm.conf</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="comment"># PID、可以不填</span></span><br><span class="line"><span class="attr">pid</span> = /usr/local/php/var/run/php-fpm.pid</span><br><span class="line"><span class="comment"># 错误日志路径、可以不填</span></span><br><span class="line"><span class="attr">error_log</span> = /usr/local/php/var/log/php-fpm.log</span><br><span class="line"><span class="comment"># www虚拟主机配置、可写多个</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pool命名：www</span></span><br><span class="line"><span class="section">[www]</span></span><br><span class="line"><span class="comment"># 监听socket方式 </span></span><br><span class="line"><span class="comment"># 可以写成listen = 127.0.0.1:9000</span></span><br><span class="line"><span class="attr">listen</span> = /tmp/php-fcgi.sock</span><br><span class="line"><span class="comment"># 开启php-fpm的执行用户</span></span><br><span class="line"><span class="attr">user</span> = php-fpm</span><br><span class="line"><span class="comment"># 开启php-fpm的所属组</span></span><br><span class="line"><span class="attr">group</span> = php-fpm</span><br><span class="line"><span class="comment"># 监听listen的用户，和后面的nginx的一致</span></span><br><span class="line"><span class="attr">listen.owner</span> = nobody</span><br><span class="line"><span class="comment"># 监听listen的组，和后面的nginx的一致</span></span><br><span class="line"><span class="attr">listen.group</span> = nobody</span><br><span class="line"><span class="comment"># 怎样的形式启用进程</span></span><br><span class="line"><span class="attr">pm</span> = dynamic</span><br><span class="line"><span class="comment"># 最大开启子进程数</span></span><br><span class="line"><span class="attr">pm.max_children</span> = <span class="number">50</span></span><br><span class="line"><span class="comment"># 一开始启动多少子进程</span></span><br><span class="line"><span class="attr">pm.start_servers</span> = <span class="number">20</span></span><br><span class="line"><span class="comment"># 空闲时保留多少个子进程</span></span><br><span class="line"><span class="attr">pm.min_spare_servers</span> = <span class="number">5</span></span><br><span class="line"><span class="comment"># 最多空闲子进程</span></span><br><span class="line"><span class="attr">pm.max_spare_servers</span> = <span class="number">35</span></span><br><span class="line"><span class="comment"># 进程处理多少个请求之后销毁重建</span></span><br><span class="line"><span class="attr">pm.max_requests</span> = <span class="number">500</span></span><br><span class="line"><span class="comment"># 限定打开最大的文件数</span></span><br><span class="line"><span class="attr">rlimit_files</span> = <span class="number">1024</span></span><br></pre></td></tr></table></figure>

<p><strong>3</strong>、测试配置文件</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># 测试配置文件``<span class="regexp">/usr/</span>local<span class="regexp">/php/</span>sbin<span class="regexp">/php-fpm -t` `测试成功：``[30-Jan-2018 23:43:32] NOTICE: configuration file /u</span>sr<span class="regexp">/local/</span>php<span class="regexp">/etc/</span>php-fpm.conf test ``is` `successful</span><br></pre></td></tr></table></figure>

<p><strong>4</strong>、重启动php-fpm</p>
<p>命令：/etc/init.d/php-fpm start</p>
<p><strong>5</strong>、查看启动状况</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ps</span> -aux | grep php-fpm</span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span>      <span class="number">1530</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">5</span>  <span class="number">32036</span>  <span class="number">2928</span> ?        Ss   <span class="number">23</span>:<span class="number">45</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: master process (/usr/local/php/etc/php-fpm.conf)                                                                    </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">1531</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2512</span> ?        S    <span class="number">23</span>:<span class="number">45</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www                                                                                                            </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">1532</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2512</span> ?        S    <span class="number">23</span>:<span class="number">45</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www                                                                                                            </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">1533</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2512</span> ?        S    <span class="number">23</span>:<span class="number">45</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www                                                                                                            </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">1534</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2512</span> ?        S    <span class="number">23</span>:<span class="number">45</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www          </span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">ls -l /tmp/php-fcgi.sock </span><br><span class="line"></span><br><span class="line">srw-rw-rw-. <span class="number">1</span> nobody nobody <span class="number">0</span> <span class="number">1</span>月  <span class="number">30</span> <span class="number">23</span>:<span class="number">45</span> /tmp/php-fcgi.sock</span><br><span class="line"></span><br><span class="line">注：权限都需要有读写，nginx才可以访问到socket。</span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ps</span> aux | grep nginx</span><br><span class="line"><span class="attribute">root</span>      <span class="number">1606</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>   <span class="number">5352</span>   <span class="number">640</span> ?        Ss   <span class="number">02</span>:<span class="number">46</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process /usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="attribute">nobody</span>    <span class="number">1607</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">3</span>   <span class="number">6164</span>  <span class="number">1568</span> ?        S    <span class="number">02</span>:<span class="number">46</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process      </span><br><span class="line"><span class="attribute">root</span>      <span class="number">1609</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">1</span>   <span class="number">5980</span>   <span class="number">744</span> pts/<span class="number">0</span>    S+   <span class="number">02</span>:<span class="number">46</span>   <span class="number">0</span>:<span class="number">00</span> grep nginx</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>设置多个pool</strong></p>
<p>需求：置两个pool，www1，www2</p>
<p>注：pool对应一个nginx的站点，这样可以提高安全，如同站点切割。</p>
<p><strong>1</strong>、主配置文件下配置两个pool。</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 全局配置</span></span><br><span class="line">[global]</span><br><span class="line"><span class="meta"># PID、可以不填</span></span><br><span class="line">pid = /usr/local/php/<span class="keyword">var</span>/run/php-fpm.pid</span><br><span class="line"><span class="meta"># 错误日志路径、可以不填</span></span><br><span class="line">error_log = /usr/local/php/<span class="keyword">var</span>/log/php-fpm.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># www虚拟主机配置、可写多个</span></span><br><span class="line">[www1]</span><br><span class="line"><span class="meta"># 监听socket方式 可以写成127.0.0.1:9000 TCP的。</span></span><br><span class="line">listen = /tmp/php-fcgi1.sock</span><br><span class="line"><span class="meta"># 开启php-fpm的执行用户</span></span><br><span class="line">user = php-fpm</span><br><span class="line"><span class="meta"># 开启php-fpm的所属组</span></span><br><span class="line">group = php-fpm</span><br><span class="line"><span class="meta"># 监听listen的用户，和后面的nginx的一致</span></span><br><span class="line">listen.owner = nobody</span><br><span class="line"><span class="meta"># 监听listen的组，和后面的nginx的一致</span></span><br><span class="line">listen.group = nobody</span><br><span class="line"><span class="meta"># 怎样的形式启用进程、static static静态、pm dynamic动态</span></span><br><span class="line">pm = dynamic</span><br><span class="line"><span class="meta"># 最大开启子进程数</span></span><br><span class="line">pm.max_children = <span class="number">50</span></span><br><span class="line"><span class="meta"># 一开始启动多少子进程</span></span><br><span class="line">pm.start_servers = <span class="number">20</span></span><br><span class="line"><span class="meta"># 空闲时保留多少个子进程</span></span><br><span class="line">pm.min_spare_servers = <span class="number">5</span></span><br><span class="line"><span class="meta"># 最多空闲子进程</span></span><br><span class="line">pm.max_spare_servers = <span class="number">35</span></span><br><span class="line"><span class="meta"># 进程处理多少个请求之后销毁重建</span></span><br><span class="line">pm.max_requests = <span class="number">500</span></span><br><span class="line"><span class="meta"># 限定打开最大的文件数</span></span><br><span class="line">rlimit_files = <span class="number">1024</span></span><br><span class="line"><span class="meta"># 定义慢日志</span></span><br><span class="line">slowlog = /tmp/xxx_slow.log</span><br><span class="line"><span class="meta"># 处理延迟多少秒记录一次慢日志</span></span><br><span class="line">request_slowlog_timeout = <span class="number">1</span></span><br><span class="line"><span class="meta"># 配置隔离网站</span></span><br><span class="line">php_admin_value[open_basedir]=/usr/local/url1:/usr/local/url2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># www虚拟主机配置、可写多个</span></span><br><span class="line">[www2]</span><br><span class="line"><span class="meta"># 监听socket方式 可以写成127.0.0.1:9000 TCP的。</span></span><br><span class="line">listen = /tmp/php-fcgi2.sock</span><br><span class="line"><span class="meta"># 开启php-fpm的执行用户</span></span><br><span class="line">user = test</span><br><span class="line"><span class="meta"># 怎样的形式启用进程、static static静态、pm dynamic动态</span></span><br><span class="line">pm = dynamic</span><br><span class="line"><span class="meta"># 最大开启子进程数</span></span><br><span class="line">pm.max_children = <span class="number">50</span></span><br><span class="line"><span class="meta"># 一开始启动多少子进程</span></span><br><span class="line">pm.start_servers = <span class="number">20</span></span><br><span class="line"><span class="meta"># 空闲时保留多少个子进程</span></span><br><span class="line">pm.min_spare_servers = <span class="number">5</span></span><br><span class="line"><span class="meta"># 最多空闲子进程</span></span><br><span class="line">pm.max_spare_servers = <span class="number">35</span></span><br><span class="line"><span class="meta"># 进程处理多少个请求之后销毁重建</span></span><br><span class="line">pm.max_requests = <span class="number">500</span></span><br><span class="line"><span class="meta"># 限定打开最大的文件数</span></span><br><span class="line">rlimit_files = <span class="number">1024</span></span><br><span class="line"><span class="meta"># 定义慢日志</span></span><br><span class="line">slowlog = /tmp/xxx2_slow.log</span><br><span class="line"><span class="meta"># 处理延迟多少秒记录一次慢日志</span></span><br><span class="line">request_slowlog_timeout = <span class="number">1</span></span><br><span class="line"><span class="meta"># 配置隔离网站</span></span><br><span class="line">php_admin_value[open_basedir]=/usr/local/url1:/usr/local/url2</span><br></pre></td></tr></table></figure>

<p><strong>2</strong>、查看两个pool的启动进程</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ps</span> -aux | grep php-rpm</span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span>      <span class="number">2486</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">0</span>.<span class="number">6</span>  <span class="number">32240</span>  <span class="number">3136</span> ?        Ss   <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: master process (/usr/local/php/etc/php-fpm.conf)                                                                    </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2487</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                                                                                                           </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2488</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                                                                                                           </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2489</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                                                                                                           </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2490</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                                                                                                           </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2491</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                                                                                                           </span><br><span class="line"><span class="attribute">php</span>-fpm   <span class="number">2492</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2532</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">1</span>                        </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2507</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                                                                           </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2508</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                                                                           </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2509</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                                                                           </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2510</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                                                                           </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2511</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                                                                           </span><br><span class="line"><span class="attribute">test</span>      <span class="number">2512</span>  <span class="number">0</span>.<span class="number">0</span>  <span class="number">0</span>.<span class="number">4</span>  <span class="number">32036</span>  <span class="number">2536</span> ?        S    <span class="number">09</span>:<span class="number">31</span>   <span class="number">0</span>:<span class="number">00</span> php-fpm: pool www<span class="number">2</span>                                                 </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus监控node_exporter的告警规则</title>
    <url>/sugw.github.io/2020/10/26/Prometheus%E7%9B%91%E6%8E%A7node_exporter%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<h3 id="针对磁盘CPU-IO-磁盘使用、内存使用、TCP、网络流量配置监控告警"><a href="#针对磁盘CPU-IO-磁盘使用、内存使用、TCP、网络流量配置监控告警" class="headerlink" title="针对磁盘CPU,IO ,磁盘使用、内存使用、TCP、网络流量配置监控告警"></a>针对磁盘CPU,IO ,磁盘使用、内存使用、TCP、网络流量配置监控告警</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">主机状态-监控告警</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">主机状态</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">非常严重</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>:服务器宕机&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span>:服务器延时超过5分钟&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">CPU使用情况</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">by(instance)*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">一般告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> CPU使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> CPU使用大于60%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line">  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">内存使用</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="string">-(node_memory_MemTotal_bytes</span> <span class="string">-node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes</span> <span class="string">)</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes</span> <span class="string">*</span> <span class="number">100</span><span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 内存使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 内存使用大于80%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">IO性能</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(avg(irate(node_disk_io_time_seconds_total[1m]))</span> <span class="string">by(instance)*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&lt;</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入磁盘IO使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 流入磁盘IO大于60%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>)&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">网络</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">((sum(rate</span> <span class="string">(node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m]))</span> <span class="string">by</span> <span class="string">(instance))</span> <span class="string">/</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">102400</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入网络带宽过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span>流入网络带宽持续2分钟高于100M. RX带宽使用率<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">网络</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">((sum(rate</span> <span class="string">(node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m]))</span> <span class="string">by</span> <span class="string">(instance))</span> <span class="string">/</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">102400</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流出网络带宽过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span>流出网络带宽持续2分钟高于100M. RX带宽使用率<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">TCP会话</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">node_netstat_Tcp_CurrEstab</span> <span class="string">&gt;</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> TCP_ESTABLISHED过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> TCP_ESTABLISHED大于1000%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br><span class="line"> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">磁盘容量</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span><span class="string">-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes</span> &#123;<span class="string">fstype=~&quot;ext4|xfs&quot;</span>&#125;<span class="string">*100)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">status:</span> <span class="string">严重告警</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 磁盘分区使用率过高！&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 磁盘分区使用大于80%(目前使用:<span class="template-variable">&#123;&#123;$value&#125;&#125;</span>%)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Prometheus针对nodes告警规则配置"><a href="#Prometheus针对nodes告警规则配置" class="headerlink" title="Prometheus针对nodes告警规则配置"></a>Prometheus针对nodes告警规则配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">实例丢失</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;node-exporter&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 丢失&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 上的任务 <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> 已经停止了 1 分钟已上了&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">磁盘容量小于</span> <span class="number">5</span><span class="string">%</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">((node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,mountpoint=~&quot;.*&quot;,fstype=~&quot;ext4|xfs|ext2|ext3&quot;&#125;</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes</span> &#123;<span class="string">job=&quot;node-exporter&quot;</span>,<span class="string">mountpoint=~&quot;.*&quot;</span>,<span class="string">fstype=~&quot;ext4|xfs|ext2|ext3&quot;</span>&#125;<span class="string">)</span> <span class="string">&gt;</span> <span class="number">95</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘不足 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>磁盘 <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> 资源 已不足 5%, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;内存容量小于 20%&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">((node_memory_MemTotal_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_MemFree_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Buffers_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Cached_bytes)</span> <span class="string">/</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="string">))</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存不足 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>内存资源已不足 20%,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;CPU 平均负载大于 4 个&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">node_load5</span> <span class="string">&gt;</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>CPU 平均负载(5 分钟) 已超过 4 ,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;磁盘读 I/O 超过 30MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">irate(node_disk_read_bytes_total&#123;device=&quot;sda&quot;&#125;[1m])</span> <span class="string">&gt;</span> <span class="number">30000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> I/O 读负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>I/O 每分钟读已超过 30MB/s,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;磁盘写 I/O 超过 30MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">irate(node_disk_written_bytes_total&#123;device=&quot;sda&quot;&#125;[1m])</span> <span class="string">&gt;</span> <span class="number">30000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> I/O 写负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>I/O 每分钟写已超过 30MB/s,当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;网卡流出速率大于 10MB/s&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">(irate(node_network_transmit_bytes_total&#123;device!~&quot;lo&quot;&#125;[1m])</span> <span class="string">/</span> <span class="number">1000</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">1000000</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 网卡流量负载 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>网卡 <span class="template-variable">&#123;&#123; $labels.device &#125;&#125;</span> 流量已经超过 10MB/s, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">&quot;CPU 使用率大于 90%&quot;</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">((avg</span> <span class="string">by</span> <span class="string">(instance,job,env)(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[30s])))</span> <span class="string">*100)</span> <span class="string">&gt;</span> <span class="number">90</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">sumary:</span> <span class="string">&quot;服务器实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率 告警通知&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>CPU 使用率已超过 90%, 当前值: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>ab压测工具</title>
    <url>/sugw.github.io/2020/11/19/ab%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>ab压测参数：</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><span class="line">-<span class="ruby">n 测试会话中所执行的请求个数,默认仅执行一个请求 </span></span><br><span class="line"><span class="ruby">-c 一次产生的请求个数,即同一时间发出多少个请求,默认为一次一个 </span></span><br><span class="line"><span class="ruby">-t 测试所进行的最大秒数,默认为无时间限制....其内部隐含值是[-n <span class="number">50000</span>],它可以使对服务器的测试限制在一个固定的总时间以内 </span></span><br><span class="line"><span class="ruby">-p 包含了需要POST的数据的文件 </span></span><br><span class="line"><span class="ruby">-T POST数据所使用的Content-type头信息 </span></span><br><span class="line"><span class="ruby">-v 设置显示信息的详细程度 </span></span><br><span class="line"><span class="ruby">-w 以HTML表格的形式输出结果,默认是白色背景的两列宽度的一张表</span></span><br><span class="line"><span class="ruby">-i 以HTML表格的形式输出结果,默认是白色背景的两列宽度的一张表 </span></span><br><span class="line"><span class="ruby">-x 设置&lt;table&gt;属性的字符串,此属性被填入&lt;table 这里&gt; </span></span><br><span class="line"><span class="ruby">-y 设置&lt;tr&gt;属性的字符串 </span></span><br><span class="line"><span class="ruby">-z 设置&lt;td&gt;属性的字符串 </span></span><br><span class="line"><span class="ruby">-C 对请求附加一个Cookie行，其典型形式是name=value的参数对,此参数可以重复 </span></span><br><span class="line"><span class="ruby">-H 对请求附加额外的头信息,此参数的典型形式是一个有效的头信息行,其中包含了以冒号分隔的字段和值的对(如<span class="string">&quot;Accept-Encoding: zip/zop;8bit&quot;</span>) </span></span><br><span class="line"><span class="ruby">-A HTTP验证,用冒号<span class="symbol">:</span>分隔传递用户名及密码 </span></span><br><span class="line"><span class="ruby">-P 无论服务器是否需要(即是否发送了<span class="number">401</span>认证需求代码),此字符串都会被发送 </span></span><br><span class="line"><span class="ruby">-X 对请求使用代理服务器 </span></span><br><span class="line"><span class="ruby">-V 显示版本号并退出 </span></span><br><span class="line"><span class="ruby">-k 启用HTTP KeepAlive功能,即在一个HTTP会话中执行多个请求,默认为不启用KeepAlive功能 </span></span><br><span class="line"><span class="ruby">-d 不显示<span class="string">&quot;percentage served within XX [ms] table&quot;</span>的消息(为以前的版本提供支持) </span></span><br><span class="line"><span class="ruby">-S 不显示中值和标准背离值,且均值和中值为标准背离值的<span class="number">1</span>到<span class="number">2</span>倍时,也不显示警告或出错信息,默认会显示最小值/均值/最大值等(为以前的版本提供支持) </span></span><br><span class="line"><span class="ruby">-g 把所有测试结果写入一个<span class="string">&#x27;gnuplot&#x27;</span>或者TSV(以Tab分隔的)文件 </span></span><br><span class="line"><span class="ruby">-e 产生一个以逗号分隔的(CSV)文件,其中包含了处理每个相应百分比的请求所需要(从<span class="number">1</span>%到<span class="number">100</span>%)的相应百分比的(以微妙为单位)时间 </span></span><br><span class="line"><span class="ruby">-h 显示使用方法 </span></span><br><span class="line"><span class="ruby">-k 发送keep-alive指令到服务器端</span></span><br></pre></td></tr></table></figure>

<p>ab压测命令：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ab</span> -n <span class="number">10</span> -s <span class="number">50000</span> -k <span class="string">&quot;http://127.0.0.1:9501/?uid=123&quot;</span></span><br></pre></td></tr></table></figure>

<p>ab压测结果:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">This</span> <span class="string">is</span> <span class="string">apacheBench,</span> <span class="string">Version</span> <span class="number">2.3</span> <span class="string">&lt;$Revision:</span> <span class="number">1843412</span> <span class="string">$&gt;</span></span><br><span class="line"><span class="string">Copyright</span> <span class="number">1996 </span><span class="string">Adam</span> <span class="string">Twiss,</span> <span class="string">Zeus</span> <span class="string">Technology</span> <span class="string">Ltd,</span> <span class="string">http://www.zeustech.net/</span></span><br><span class="line"><span class="string">Licensed</span> <span class="string">to</span> <span class="string">The</span> <span class="string">Apache</span> <span class="string">Software</span> <span class="string">Foundation,</span> <span class="string">http://www.apache.org/</span></span><br><span class="line"></span><br><span class="line"><span class="string">Benchmarking</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">(be</span> <span class="string">patient).....done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">Server Software:</span>        <span class="string">swoole-http-server#服务器软件</span></span><br><span class="line"><span class="attr">Server Hostname:</span>        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="comment">#域名</span></span><br><span class="line"><span class="attr">Server Port:</span>            <span class="number">9501</span><span class="comment">#请求端口号</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Document Path:</span>          <span class="string">/?uid=123#文件路径</span></span><br><span class="line"><span class="attr">Document Length:</span>        <span class="number">818</span> <span class="string">bytes#页面字节数</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Concurrency Level:</span>      <span class="number">1</span><span class="comment">#请求的并发数</span></span><br><span class="line"><span class="attr">Time taken for tests:</span>   <span class="number">225.551</span> <span class="string">seconds#总访问时间</span></span><br><span class="line"><span class="attr">Complete requests:</span>      <span class="number">10</span><span class="comment">#请求成功数量</span></span><br><span class="line"><span class="attr">Failed requests:</span>        <span class="number">1</span><span class="comment">#请求失败数量</span></span><br><span class="line">   <span class="string">(Connect:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">Receive:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">Length:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">Exceptions:</span> <span class="number">0</span><span class="string">)</span></span><br><span class="line"><span class="attr">Keep-Alive requests:</span>    <span class="number">10</span></span><br><span class="line"><span class="attr">Total transferred:</span>      <span class="number">9791 </span><span class="string">bytes#请求总数据大小（包括header头信息）</span></span><br><span class="line"><span class="attr">HTML transferred:</span>       <span class="number">8181 </span><span class="string">bytes#html页面实际总字节数</span></span><br><span class="line"><span class="attr">Requests per second:</span>    <span class="number">0.04</span> [<span class="comment">#/sec] (mean)#每秒多少请求，服务器的吞吐量</span></span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">22555.056</span> [<span class="string">ms</span>] <span class="string">(mean)#用户平均请求等待时间</span> </span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">22555.056</span> [<span class="string">ms</span>] <span class="string">(mean</span>, <span class="string">across</span> <span class="string">all</span> <span class="string">concurrent</span> <span class="string">requests)#</span> <span class="string">服务器平均处理时间，也就是服务器吞吐量的倒数</span></span><br><span class="line"><span class="attr">Transfer rate:</span>          <span class="number">0.04</span> [<span class="string">Kbytes/sec</span>] <span class="string">received#每秒获取的数据长度</span></span><br><span class="line"></span><br><span class="line"><span class="string">Connection</span> <span class="string">Times</span> <span class="string">(ms)</span></span><br><span class="line">              <span class="string">min</span>  <span class="string">mean</span>[<span class="string">+/-sd</span>] <span class="string">median</span>   <span class="string">max</span></span><br><span class="line"><span class="attr">Connect:</span>        <span class="number">0</span>    <span class="number">0</span>   <span class="number">0.0</span>      <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"><span class="attr">Processing:</span>  <span class="number">6434 </span><span class="number">22555</span> <span class="number">19246.5</span>  <span class="number">21379</span>   <span class="number">61285</span></span><br><span class="line"><span class="attr">Waiting:</span>     <span class="number">6434 </span><span class="number">22555</span> <span class="number">19246.4</span>  <span class="number">21379</span>   <span class="number">61285</span></span><br><span class="line"><span class="attr">Total:</span>       <span class="number">6434 </span><span class="number">22555</span> <span class="number">19246.5</span>  <span class="number">21379</span>   <span class="number">61285</span></span><br><span class="line"></span><br><span class="line"><span class="string">Percentage</span> <span class="string">of</span> <span class="string">the</span> <span class="string">requests</span> <span class="string">served</span> <span class="string">within</span> <span class="string">a</span> <span class="string">certain</span> <span class="string">time</span> <span class="string">(ms)</span></span><br><span class="line">  <span class="number">50</span><span class="string">%</span>  <span class="number">21379</span><span class="comment">#50%用户请求在21379ms内返回</span></span><br><span class="line">  <span class="number">66</span><span class="string">%</span>  <span class="number">30850</span><span class="comment">#66%用户请求在30850ms内返回</span></span><br><span class="line">  <span class="number">75</span><span class="string">%</span>  <span class="number">31684</span><span class="comment">#75%用户请求在31684ms内返回</span></span><br><span class="line">  <span class="number">80</span><span class="string">%</span>  <span class="number">44672</span><span class="comment">#80%用户请求在44672ms内返回</span></span><br><span class="line">  <span class="number">90</span><span class="string">%</span>  <span class="number">61285</span><span class="comment">#90%用户请求在61285ms内返回</span></span><br><span class="line">  <span class="number">95</span><span class="string">%</span>  <span class="number">61285</span><span class="comment">#95%用户请求在61285ms内返回</span></span><br><span class="line">  <span class="number">98</span><span class="string">%</span>  <span class="number">61285</span><span class="comment">#98%用户请求在61285ms内返回</span></span><br><span class="line">  <span class="number">99</span><span class="string">%</span>  <span class="number">61285</span><span class="comment">#99%用户请求在61285ms内返回</span></span><br><span class="line"> <span class="number">100</span><span class="string">%</span>  <span class="number">61285</span> <span class="string">(longest</span> <span class="string">request)</span></span><br></pre></td></tr></table></figure>



<p>以上就是ab压测参数详解的全部内容。</p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>测试</tag>
      </tags>
  </entry>
  <entry>
    <title>ansible定时任务和用户组模块使用</title>
    <url>/sugw.github.io/2020/11/20/ansible%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="用户模块的使用"><a href="#用户模块的使用" class="headerlink" title="用户模块的使用"></a>用户模块的使用</h2><p>用户模块主要用来管理用户账号和用户的属性（对远程主机用户进行批量管理）。</p>
<p>用户模块依赖的指令为useradd，userdel，usermod</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认值</th>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Append</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>如果没有指定group，append设定为yes，那么会添加到用户同名组；append设定为no，那么会添加到user组。如果指定了group，那么都会添加在指定的group组</td>
</tr>
<tr>
<td>Comment</td>
<td>否</td>
<td></td>
<td></td>
<td>用户的备注信息</td>
</tr>
<tr>
<td>Force</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>当状态为absent的时候，相当于userdel -force</td>
</tr>
<tr>
<td>generate_ssh_key</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>是否生成秘钥</td>
</tr>
<tr>
<td>Group</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定用户的主组</td>
</tr>
<tr>
<td>Groups</td>
<td>否</td>
<td></td>
<td></td>
<td>用逗号分隔的组，当groups设定为空的时候，那么会移除除了主组的其他所有组</td>
</tr>
<tr>
<td>Home</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定为用户的home目录</td>
</tr>
<tr>
<td>Login_class</td>
<td>否</td>
<td></td>
<td></td>
<td>可选的，设定用户的登录类 FreeBSD, OpenBSD and NetBSD systems.</td>
</tr>
<tr>
<td>Name</td>
<td>是</td>
<td></td>
<td></td>
<td>用户创建，移除，修改</td>
</tr>
<tr>
<td>Move_home</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>如果使用了选项home=设置为yes，那么会将用户家目录移到不存在的home目录中</td>
</tr>
<tr>
<td>Non_unique</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>可选的，当使用-u选项的时候，将用户的uid设置为non_unique</td>
</tr>
<tr>
<td>Password</td>
<td>否</td>
<td></td>
<td></td>
<td>设定用户的密码</td>
</tr>
<tr>
<td>Remove</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>当使用状态为state=absent的时候，差不多和userdel –remove（删除所有信息）</td>
</tr>
<tr>
<td>Shell</td>
<td>否</td>
<td></td>
<td></td>
<td>设定用户的shell</td>
</tr>
<tr>
<td>Ssh_key_bits</td>
<td>否</td>
<td>2048</td>
<td></td>
<td>设定秘钥的位数</td>
</tr>
<tr>
<td>Ssh_key_comments</td>
<td>否</td>
<td>￥HOSTHOME</td>
<td></td>
<td>Ssh key备注信息</td>
</tr>
<tr>
<td>Ssh_key_file</td>
<td>否</td>
<td>.sha/id_rsa</td>
<td></td>
<td>秘钥的文件名</td>
</tr>
<tr>
<td>ssh_key_passphrase</td>
<td>否</td>
<td></td>
<td></td>
<td>Ssh秘钥的密码</td>
</tr>
<tr>
<td>Ssh_key_type</td>
<td>否</td>
<td>Rsa</td>
<td></td>
<td>Ssh秘钥的类型</td>
</tr>
<tr>
<td>State</td>
<td>否</td>
<td>Present</td>
<td>PresentAbsent</td>
<td>新增删除</td>
</tr>
<tr>
<td>System</td>
<td>否</td>
<td>No</td>
<td>Yes/no</td>
<td>创建为系统账号，不会改变已经存在的用户</td>
</tr>
<tr>
<td>Uid</td>
<td>否</td>
<td></td>
<td></td>
<td>设定为用户的uid</td>
</tr>
<tr>
<td>Update_password</td>
<td>否</td>
<td>Always</td>
<td>AlwaysOn_create</td>
<td>Always当用户密码不同，会修改，是否需要修改密码</td>
</tr>
</tbody></table>
<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly group=kelly uid=555 comment=’kelly’ state=present”</p>
<p>添加用户，指定用户名name，指定用户主组kelly，设定用户uid为555 ，设定备注信息</p>
<h3 id="添加用户使用append"><a href="#添加用户使用append" class="headerlink" title="添加用户使用append"></a>添加用户使用append</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly shell=/bin/bash groups=kelly,kel append=yes</p>
<p>添加用户，将用户添加在组kelly和kel中，指定shell为/bin/bash，然后将用户添加组user中</p>
<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly state=absent remove=yes</p>
<p>将用户强制删除</p>
<h3 id="新建用户创建sshkey"><a href="#新建用户创建sshkey" class="headerlink" title="新建用户创建sshkey"></a>新建用户创建sshkey</h3><p>[root@ansibleserver ~]# ansible pythonserver -m user -a “name=kelly generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa”</p>
<p>创建用户，设定sshkey等属性</p>
<h3 id="hostname模块使用"><a href="#hostname模块使用" class="headerlink" title="hostname模块使用"></a>hostname模块使用</h3><p>hostname模块主要用来修改主机的名称。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>否</td>
<td></td>
<td></td>
<td>主机名称</td>
</tr>
</tbody></table>
<h3 id="修改主机名称"><a href="#修改主机名称" class="headerlink" title="修改主机名称"></a>修改主机名称</h3><p>[root@ansibleserver ~]# ansible pythonserver -m hostname -a “name=python”</p>
<p>在查看的时候，主要查看文件/etc/sysconfig/network，重启之后才能生效</p>
<h3 id="ping模块的使用"><a href="#ping模块的使用" class="headerlink" title="ping模块的使用"></a>ping模块的使用</h3><p>ping模块主要是无意义的测试模块，主要用来检查ansible是否可以用的模块以及python是否配置好的，在playbook中基本不会使用，在能成功连接之后，总是返回结果pong</p>
<p>[root@ansibleserver ~]# ansible all -m ping</p>
<h3 id="定时任务管理模块使用"><a href="#定时任务管理模块使用" class="headerlink" title="定时任务管理模块使用"></a>定时任务管理模块使用</h3><p>主要是用来对定时任务进行调度，定时任务模块会包含一句描述信息，格式如下：</p>
<p>“#Ansible: <name>“</name></p>
<p>name对应的为模块传递过去的参数，主要用来给以后ansible进行操作的时候，查看相关的状态或者检查相关状态</p>
<p>依赖的模块为cron</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Backup</td>
<td>非</td>
<td></td>
<td>Yes/no</td>
<td>如果yes，那么在修改之后会进行备份，备份的路径在backup_file</td>
</tr>
<tr>
<td>Cron_file</td>
<td>非</td>
<td></td>
<td></td>
<td>如果设置了，那么在cron.d中使用此文件替代单独用户的crontab，在使用此选项的时候，必须使用user选项</td>
</tr>
<tr>
<td>Day</td>
<td>非</td>
<td></td>
<td></td>
<td>天</td>
</tr>
<tr>
<td>Hour</td>
<td>非</td>
<td></td>
<td></td>
<td>小时 ( 0-23, *, */2, etc )</td>
</tr>
<tr>
<td>Job</td>
<td>非</td>
<td></td>
<td></td>
<td>需要执行的命令，必须状态为present</td>
</tr>
<tr>
<td>Minute</td>
<td>非</td>
<td></td>
<td></td>
<td>分 ( 0-59, *, */2, etc )</td>
</tr>
<tr>
<td>Month</td>
<td>非</td>
<td></td>
<td></td>
<td>月( 1-12, *, */2, etc )</td>
</tr>
<tr>
<td>Name</td>
<td>非</td>
<td></td>
<td></td>
<td>任务的描述</td>
</tr>
<tr>
<td>Reboot</td>
<td>非</td>
<td>No</td>
<td>Yes/no</td>
<td>重启后是否需要执行</td>
</tr>
<tr>
<td>Special_time</td>
<td>非</td>
<td></td>
<td>rebootyearlyannuallymonthlyweeklydailyhourly</td>
<td>特定的执行时间</td>
</tr>
<tr>
<td>State</td>
<td>非</td>
<td>Present</td>
<td>PresentAbsent</td>
<td>启用或停用任务</td>
</tr>
<tr>
<td>User</td>
<td>非</td>
<td>Root</td>
<td></td>
<td>执行任务的用户</td>
</tr>
<tr>
<td>Weekday</td>
<td>非</td>
<td></td>
<td></td>
<td>每一周的哪天进行运行（0-6 for Sunday-Saturday, *, etc）</td>
</tr>
</tbody></table>
<h3 id="新增一个定时任务"><a href="#新增一个定时任务" class="headerlink" title="新增一个定时任务"></a>新增一个定时任务</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=check minute=5 job=’crontab -l &gt;&gt;/root/123’”</p>
<p>新增一个任务，每五分钟执行一次，任务名称为check</p>
<h3 id="删除定时任务"><a href="#删除定时任务" class="headerlink" title="删除定时任务"></a>删除定时任务</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=check state=absent”</p>
<p>删除刚刚新建的定时任务</p>
<h3 id="新建一个cron文件"><a href="#新建一个cron文件" class="headerlink" title="新建一个cron文件"></a>新建一个cron文件</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=’for test’ weekday=’2’ minute=’0’ hour=12 user=’root’ job=’cat /etc/passwd &gt;/root/111’ cron_file=’test ansible’”</p>
<p>新增一个任务，在目录/etc/cron.d/目录中，文件名称为test ansible，用户为root</p>
<h3 id="删除一个cron文件"><a href="#删除一个cron文件" class="headerlink" title="删除一个cron文件"></a>删除一个cron文件</h3><p>[root@ansibleserver ~]# ansible pythonserver -m cron -a “name=’for test’ cron_file=’test ansible’ state=absent”</p>
<p>删除上面新建的cron文件。</p>
<h2 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h2><p>这个模块在playbook中自动被查找的，从而得到远程主机的相关信息，可以作为变量使用。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>必填</th>
<th>默认</th>
<th>选择</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Fact_path</td>
<td>否</td>
<td>/etc/ansible/facts.d</td>
<td></td>
<td>Fact的路径</td>
</tr>
<tr>
<td>Filter</td>
<td>否</td>
<td>*</td>
<td></td>
<td>过滤串</td>
</tr>
</tbody></table>
<h2 id="收集fact并且进行保存"><a href="#收集fact并且进行保存" class="headerlink" title="收集fact并且进行保存"></a>收集fact并且进行保存</h2><p>ansible pythonserver -m setup –tree /tmp/facts</p>
<p>执行之后，会显示相关的fact，并且在/tmp/facts中会保存fact信息，如下：</p>
<p>[root@ansibleserver tmp]# ls -l /tmp/facts/total 12-rw-r–r– 1 root root 8990 Jan 18 13:16 192.168.1.60</p>
<p>使用–tree选项，在分类的时候，会根据主机的名称进行分类</p>
<h3 id="收集内存信息并输出"><a href="#收集内存信息并输出" class="headerlink" title="收集内存信息并输出"></a>收集内存信息并输出</h3><p>[root@ansibleserver tmp]# ansible pythonserver -m setup -a “filter=ansible_*_mb”</p>
<p>使用过滤字符串，从而进行了相关的匹配，得到相关的内存信息</p>
<h3 id="收集主机网卡信息"><a href="#收集主机网卡信息" class="headerlink" title="收集主机网卡信息"></a>收集主机网卡信息</h3><p>[root@ansibleserver tmp]# ansible pythonserver -m setup -a “filter=ansible_eth[02]”</p>
<p>收集特定的网卡信息</p>
]]></content>
      <categories>
        <category>ansible</category>
      </categories>
      <tags>
        <tag>ansible</tag>
      </tags>
  </entry>
  <entry>
    <title>centos6.8 安装supervisor</title>
    <url>/sugw.github.io/2020/10/28/centos6.8%20%E5%AE%89%E8%A3%85supervisor/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p> centos6.8安装supervisor，有很多种方法，但是有很多坑，为了以后不重复踩坑，这里记录一下。</p>
<p>如果用yum install supervisor, 默认安装的是2.1.9版本，2.x版本的问题很多，可以启动supervisord进程，但是启动的进程不输出日志</p>
<p>用pip install supervisor，默认装的是最新的4.0.3版本，但是centos6.8默认的只有python2.6，4.0.3的supervisor跑不起来，具体错误没有记录了</p>
<h2 id="升级到python2-7"><a href="#升级到python2-7" class="headerlink" title="升级到python2.7"></a>升级到python2.7</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://prdownloads.sourceforge.net/libpng/zlib-1.2.8.tar.gz</span><br><span class="line">tar zxf zlib-1.2.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> zlib-1.2.8</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"> </span><br><span class="line">yum install openssl openssl-devel -y</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">wget http://www.python.org/ftp/python/2.7.10/Python-2.7.10.tar.xz</span><br><span class="line">tar xf Python-2.7.10.tar.xz</span><br><span class="line"><span class="built_in">cd</span> Python-2.7.10</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python2.7</span><br><span class="line"><span class="comment"># 找到下面这句，去掉注释 </span></span><br><span class="line"><span class="comment"># zlib zlibmodule.c -I$(prefix)/include -L$(exec_prefix)/lib -lz </span></span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接下来需要创建一个链接来使系统默认python变为python2.7</span><br><span class="line">ln -fs /usr/<span class="built_in">local</span>/python2.7/bin/python2.7 /usr/bin/python</span><br><span class="line"></span><br><span class="line">更改后yum会无法运行,此时修改/usr/bin/yum 文件的第一行</span><br><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line">改为系统原有python版本</span><br><span class="line"><span class="meta">#!/usr/bin/python2.6</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-supervisor"><a href="#安装-supervisor" class="headerlink" title="安装 supervisor"></a>安装 supervisor</h2><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">pip2<span class="number">.7</span> install supervisor</span><br></pre></td></tr></table></figure>

<h3 id="配置-supervisor"><a href="#配置-supervisor" class="headerlink" title="配置 supervisor"></a>配置 supervisor</h3><figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">echo_supervisord_conf &gt;<span class="regexp">/etc/</span>supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>supervisord.conf</span><br><span class="line">[<span class="keyword">include</span>]</span><br><span class="line">files = <span class="regexp">/etc/</span>supervisord.d<span class="comment">/*.ini</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>supervisord -c <span class="regexp">/etc/</span>supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>supervisorctl -c <span class="regexp">/etc/</span>supervisord.conf status</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="加入开机启动"><a href="#加入开机启动" class="headerlink" title="加入开机启动"></a>加入开机启动</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>supervisord.conf </span><br><span class="line"><span class="comment"># 修改以下内容</span></span><br><span class="line"></span><br><span class="line">file=<span class="regexp">/var/</span>run/supervisor.sock </span><br><span class="line"></span><br><span class="line">logfile=<span class="regexp">/var/</span>log<span class="regexp">/supervisord.log pidfile=/</span>var<span class="regexp">/run/</span>supervisord.pid </span><br><span class="line"></span><br><span class="line">serverurl=unix:<span class="regexp">//</span><span class="regexp">/var/</span>run/supervisor.sock</span><br><span class="line"></span><br><span class="line"> [include] </span><br><span class="line"></span><br><span class="line">files = supervisord.d/*.conf</span><br></pre></td></tr></table></figure>

<h4 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/init.d/supervisord</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># supervisord   This scripts turns supervisord on</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author:       Mike McGrath &lt;mmcgrath@redhat.com&gt; (based off yumupdatesd)</span></span><br><span class="line"><span class="comment">#               Jason Koppe &lt;jkoppe@indeed.com&gt; adjusted to read sysconfig,</span></span><br><span class="line"><span class="comment">#                   use supervisord tools to start/stop, conditionally wait</span></span><br><span class="line"><span class="comment">#                   for child processes to shutdown, and startup later</span></span><br><span class="line"><span class="comment">#               Mikhail Mingalev &lt;mingalevme@gmail.com&gt; Merged</span></span><br><span class="line"><span class="comment">#                   redhat-init-jkoppe and redhat-sysconfig-jkoppe, and</span></span><br><span class="line"><span class="comment">#                   made the script &quot;simple customizable&quot;.</span></span><br><span class="line"><span class="comment">#               Brendan Maguire &lt;maguire.brendan@gmail.com&gt; Added OPTIONS to</span></span><br><span class="line"><span class="comment">#                   SUPERVISORCTL status call</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:    345 83 04</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># description:  supervisor is a process control utility.  It has a web based</span></span><br><span class="line"><span class="comment">#               xmlrpc interface as well as a few other nifty features.</span></span><br><span class="line"><span class="comment">#               Script was originally written by Jason Koppe &lt;jkoppe@indeed.com&gt;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># source function library</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -a</span><br><span class="line"></span><br><span class="line">PREFIX=/usr</span><br><span class="line"></span><br><span class="line">SUPERVISORD=<span class="variable">$PREFIX</span>/bin/supervisord</span><br><span class="line">SUPERVISORCTL=<span class="variable">$PREFIX</span>/bin/supervisorctl</span><br><span class="line"></span><br><span class="line">PIDFILE=/var/run/supervisord.pid</span><br><span class="line">LOCKFILE=/var/lock/subsys/supervisord</span><br><span class="line"></span><br><span class="line">OPTIONS=<span class="string">&quot;-c /etc/supervisord.conf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unset this variable if you don&#x27;t care to wait for child processes to shutdown before removing the $LOCKFILE-lock</span></span><br><span class="line">WAIT_FOR_SUBPROCESSES=yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove this if you manage number of open files in some other fashion</span></span><br><span class="line"><span class="built_in">ulimit</span> -n 96000</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">running_pid()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Check if a given process pid&#x27;s cmdline matches a given name</span></span><br><span class="line">    pid=<span class="variable">$1</span></span><br><span class="line">    name=<span class="variable">$2</span></span><br><span class="line">    [ -z <span class="string">&quot;<span class="variable">$pid</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    [ ! -d /proc/<span class="variable">$pid</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    (cat /proc/<span class="variable">$pid</span>/cmdline | tr <span class="string">&quot;\000&quot;</span> <span class="string">&quot;\n&quot;</span>|grep -q <span class="variable">$name</span>) || <span class="built_in">return</span> 1</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">running()</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment"># Check if the process is running looking at /proc</span></span><br><span class="line"><span class="comment"># (works for all users)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># No pidfile, probably no daemon present</span></span><br><span class="line">    [ ! -f <span class="string">&quot;<span class="variable">$PIDFILE</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 1</span><br><span class="line">    <span class="comment"># Obtain the pid and check it against the binary name</span></span><br><span class="line">    pid=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line">    running_pid <span class="variable">$pid</span> <span class="variable">$SUPERVISORD</span> || <span class="built_in">return</span> 1</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting supervisord: &quot;</span></span><br><span class="line">	</span><br><span class="line">        <span class="keyword">if</span> [ -e <span class="variable">$PIDFILE</span> ]; <span class="keyword">then</span> </span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;ALREADY STARTED&quot;</span></span><br><span class="line">		<span class="built_in">return</span> 1</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># start supervisord with options from sysconfig (stuff like -c)</span></span><br><span class="line">        <span class="variable">$SUPERVISORD</span> <span class="variable">$OPTIONS</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># show initial startup status</span></span><br><span class="line">	<span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> status</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># only create the subsyslock if we created the PIDFILE</span></span><br><span class="line">        [ -e <span class="variable">$PIDFILE</span> ] &amp;&amp; touch <span class="variable">$LOCKFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Stopping supervisord: &quot;</span></span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> shutdown</span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$WAIT_FOR_SUBPROCESSES</span>&quot;</span> ]; <span class="keyword">then</span> </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Waiting roughly 60 seconds for <span class="variable">$PIDFILE</span> to be removed after child processes exit&quot;</span></span><br><span class="line">            <span class="keyword">for</span> sleep <span class="keyword">in</span>  2 2 2 2 4 4 4 4 8 8 8 8 last; <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> [ ! -e <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">&quot;Supervisord exited as expected in under <span class="variable">$total_sleep</span> seconds&quot;</span></span><br><span class="line">                    <span class="built_in">break</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">if</span> [[ <span class="variable">$sleep</span> -eq <span class="string">&quot;last&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;Supervisord still working on shutting down. We&#x27;ve waited roughly 60 seconds, we&#x27;ll let it do its thing from here&quot;</span></span><br><span class="line">                        <span class="built_in">return</span> 1</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        sleep <span class="variable">$sleep</span></span><br><span class="line">                        total_sleep=$(( <span class="variable">$total_sleep</span> + <span class="variable">$sleep</span> ))</span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># always remove the subsys. We might have waited a while, but just remove it at this point.</span></span><br><span class="line">        rm -f <span class="variable">$LOCKFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">        stop</span><br><span class="line">        start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        start</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        stop</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    restart|force-reload)</span><br><span class="line">        restart</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> reload</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    condrestart)</span><br><span class="line">        [ -f <span class="variable">$LOCKFILE</span> ] &amp;&amp; restart</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        <span class="variable">$SUPERVISORCTL</span> <span class="variable">$OPTIONS</span> status</span><br><span class="line">        <span class="keyword">if</span> running ; <span class="keyword">then</span></span><br><span class="line">            RETVAL=0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            RETVAL=1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|reload|force-reload|condrestart&#125;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$RETVAL</span></span><br></pre></td></tr></table></figure>

<h4 id="加入服务"><a href="#加入服务" class="headerlink" title="加入服务"></a>加入服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig --add supervisord</span><br></pre></td></tr></table></figure>

<h4 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod 755 /etc/init.d/supervisord</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h4 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig supervisord on</span><br></pre></td></tr></table></figure>

<p><strong>启动supervisor</strong></p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">service supervisord <span class="literal">start</span> </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看supervisor运行状态</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service supervisord status</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>supervisor</tag>
      </tags>
  </entry>
  <entry>
    <title>datagrip</title>
    <url>/sugw.github.io/2020/12/01/datagrip/</url>
    <content><![CDATA[<p><a href="https://mp.weixin.qq.com/s/DTECLX-Y-9XJEScsA4boDw">https://mp.weixin.qq.com/s/DTECLX-Y-9XJEScsA4boDw</a></p>
]]></content>
      <categories>
        <category>激活</category>
      </categories>
      <tags>
        <tag>激活</tag>
      </tags>
  </entry>
  <entry>
    <title>linux 磁盘</title>
    <url>/sugw.github.io/2020/10/21/linux%20%E7%A3%81%E7%9B%98%E6%BB%A1/</url>
    <content><![CDATA[<h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><hr>
<p>​        磁盘显示已满，实际占用空间很小</p>
<h3 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h3><hr>
<p>​        程序没有释放已删除的文件</p>
<h3 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h3><hr>
<blockquote>
<p>​        重启占用文件的程序</p>
<p>​        1.检查磁盘占用</p>
<p>​                 df -Th</p>
<p>​        2.检查目录占用大小</p>
<p>​                cd /</p>
<p>​                du -sh *|grep G</p>
<p>​        3.查看为释放文件的程序</p>
<p>​                lsof -i|grep delete</p>
</blockquote>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>磁盘</tag>
      </tags>
  </entry>
  <entry>
    <title>linux内核优化</title>
    <url>/sugw.github.io/2020/11/20/linux%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h3 id="一、配置国内源和epel"><a href="#一、配置国内源和epel" class="headerlink" title="一、配置国内源和epel"></a>一、配置国内源和epel</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cd <span class="regexp">/etc/yum</span>.repos.d/</span><br><span class="line">mkdir repo_bak</span><br><span class="line">mv *.repo repo_bak/</span><br><span class="line"><span class="comment">#基础源文件</span></span><br><span class="line">wget -P <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/ http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo/Centos-<span class="number">7</span>.repo</span><br><span class="line"><span class="comment">#epel源文件</span></span><br><span class="line">wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/epel-7.repo http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo/epel-<span class="number">7</span>.repo</span><br><span class="line"><span class="comment">#重新生成yum缓存</span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line"><span class="comment">#同步时间</span></span><br><span class="line">yum -y install ntp</span><br><span class="line"><span class="regexp">/usr/</span>sbin/ntpdate ntp1.aliyun.com</span><br><span class="line">echo <span class="string">&quot;* 04 * * * /usr/sbin/ntpdate ntp1.aliyun.com &gt;/dev/null 2&gt;&amp;1&quot;</span> &gt;&gt;<span class="regexp">/var/</span>spool<span class="regexp">/cron/</span>root</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用selinux</span></span><br><span class="line">sed -i <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> <span class="regexp">/etc/</span>selinux/config</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set ssh</span></span><br><span class="line">sed -i <span class="string">&#x27;s/^GSSAPIAuthentication yes$/GSSAPIAuthentication no/&#x27;</span> <span class="regexp">/etc/</span>ssh/sshd_config</span><br><span class="line">sed -i <span class="string">&#x27;s/#UseDNS yes/UseDNS no/&#x27;</span> <span class="regexp">/etc/</span>ssh/sshd_config</span><br><span class="line">systemctl  restart sshd.service</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="二、安装基础依赖包"><a href="#二、安装基础依赖包" class="headerlink" title="二、安装基础依赖包"></a>二、安装基础依赖包</h3><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">yum install -y htop lrzsz nmap<span class="built_in"> screen </span>man expect \</span><br><span class="line">gcc gcc-c++ autoconf automake bzip2-devel \</span><br><span class="line">openssl-devel multitail kernel-devel \</span><br><span class="line">pam-devel zlib-devel perl-devel tcp_wrappers-devel</span><br></pre></td></tr></table></figure>



<h3 id="三、关闭selinux"><a href="#三、关闭selinux" class="headerlink" title="三、关闭selinux"></a>三、关闭selinux</h3><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/g&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment">#查看selinux设置</span></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>

<h3 id="四、关闭默认的邮件服务"><a href="#四、关闭默认的邮件服务" class="headerlink" title="四、关闭默认的邮件服务"></a>四、关闭默认的邮件服务</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#(默认端口25)</span></span><br><span class="line">systemctl disable postfix</span><br><span class="line">systemctl stop postfix</span><br><span class="line"><span class="comment">#查看系统默认监听的端口</span></span><br><span class="line">netstat -nlput |<span class="keyword">grep</span> -v <span class="string">&quot;Proto&quot;</span> | <span class="keyword">grep</span> <span class="string">&quot;LISTEN&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="五、设置系统环境变量"><a href="#五、设置系统环境变量" class="headerlink" title="五、设置系统环境变量"></a>五、设置系统环境变量</h3><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加执行权限</span></span><br><span class="line">chmod a+x /etc/rc.d/rc.local</span><br><span class="line"><span class="comment">#设置环境变量</span></span><br><span class="line">cat &gt;&gt;/etc<span class="built_in">/profile </span>&lt;&lt;EOF</span><br><span class="line">$(date +%F)</span><br><span class="line">alias <span class="attribute">vi</span>=<span class="string">&#x27;vim&#x27;</span></span><br><span class="line">alias <span class="attribute">grep</span>=<span class="string">&#x27;grep --color=auto&#x27;</span></span><br><span class="line"><span class="comment">#设置300秒内用户无操作就字段断开终端</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">TMOUT</span>=300</span><br><span class="line"><span class="comment">#将值设置为readonly 防止用户更改</span></span><br><span class="line">readonly TMOUT</span><br><span class="line">EOF</span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="comment">#vimrc设置</span></span><br><span class="line">cat &gt;&gt;/etc/vimrc &lt;&lt;EOF</span><br><span class="line"><span class="builtin-name">set</span> <span class="attribute">tabstop</span>=4</span><br><span class="line"><span class="builtin-name">set</span> <span class="attribute">softtabstop</span>=4</span><br><span class="line"><span class="builtin-name">set</span> <span class="attribute">shiftwidth</span>=4</span><br><span class="line"><span class="builtin-name">set</span> expandtab</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="六、设置文件打开描述符"><a href="#六、设置文件打开描述符" class="headerlink" title="六、设置文件打开描述符"></a>六、设置文件打开描述符</h3><figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">cat &gt;/etc/security/limits.conf &lt;&lt;EOF</span><br><span class="line">##### $(date) #####</span><br><span class="line">* soft noproc <span class="number">65535</span></span><br><span class="line">* hard noproc <span class="number">65535</span></span><br><span class="line">* soft nofile <span class="number">409600</span></span><br><span class="line">* hard nofile <span class="number">409600</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="七、优化系统内核参数"><a href="#七、优化系统内核参数" class="headerlink" title="七、优化系统内核参数"></a>七、优化系统内核参数</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改最大连接数</span></span><br><span class="line"><span class="string">net.nf_conntrack_max</span> <span class="string">=</span> <span class="number">655360</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established</span> <span class="string">=</span> <span class="number">1200</span></span><br><span class="line"><span class="comment">#套接字由本端关闭，这个参数决了它在FIN-WAIT-2状态的时间，默认是60秒。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#socket废弃前重试的次数，重负载web服务器建议调小</span></span><br><span class="line"><span class="string">net.ipv4.tcp_orphan_retries</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#表示开启TCP连接中TIME-WAIT sockets的快速回收。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN***。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为10分钟。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time</span> <span class="string">=</span> <span class="number">600</span></span><br><span class="line"><span class="comment">#表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range</span> <span class="string">=</span> <span class="number">1024 </span><span class="number">65000</span></span><br><span class="line"><span class="comment">#加大SYN队列长度，默认是1024.可以容纳更多等待连接的网络连接数。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog</span> <span class="string">=</span> <span class="number">262144</span></span><br><span class="line"><span class="comment">#imewait的数量，默认是180000。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets</span> <span class="string">=</span> <span class="number">6000</span></span><br><span class="line"><span class="string">net.core.rmem_max</span> <span class="string">=</span> <span class="number">16777216</span></span><br><span class="line"><span class="string">net.core.wmem_max</span> <span class="string">=</span> <span class="number">16777216</span></span><br><span class="line"><span class="string">net.ipv4.tcp_sack</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_window_scaling</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem</span> <span class="string">=</span> <span class="number">4096        </span><span class="number">87380</span>   <span class="number">4194304</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem</span> <span class="string">=</span> <span class="number">4096        </span><span class="number">16384</span>   <span class="number">4194304</span></span><br><span class="line"><span class="string">net.core.wmem_default</span> <span class="string">=</span> <span class="number">8388608</span></span><br><span class="line"><span class="string">net.core.rmem_default</span> <span class="string">=</span> <span class="number">8388608</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由，默认是300。</span></span><br><span class="line"><span class="string">net.ipv4.route.gc_timeout</span> <span class="string">=</span> <span class="number">100</span></span><br><span class="line"><span class="comment">#内核放弃连接之前发送SYN+ACK的时间</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syn_retries</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#内核放弃建立连接之前发送SYN包的数量。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_synack_retries</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#调解系统同时发起的TCP连接数，默认为128.在高并发的请求中，默认值可能导致连接超时或重传。</span></span><br><span class="line"><span class="string">net.core.somaxconn</span> <span class="string">=</span> <span class="number">262144</span></span><br><span class="line"><span class="comment">#该参数决定了，网络设备接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog</span> <span class="string">=</span> <span class="number">262144</span></span><br><span class="line"><span class="comment">#设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。可防止简单DoS***。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans</span> <span class="string">=</span> <span class="number">262144</span></span><br><span class="line"><span class="comment"># 确保无人能修改路由表</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.accept_redirects</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.secure_redirects</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.secure_redirects</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭ipv6</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 避免放大攻击</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 开启恶意icmp错误消息保护</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#开启反向路径过滤</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">关闭sysrq功能</span></span><br><span class="line"><span class="string">kernel.sysrq</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#core文件名中添加pid作为扩展名</span></span><br><span class="line"><span class="string">kernel.core_uses_pid</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="comment">#修改消息队列长度</span></span><br><span class="line"><span class="string">kernel.msgmnb</span> <span class="string">=</span> <span class="number">65536</span></span><br><span class="line"><span class="string">kernel.msgmax</span> <span class="string">=</span> <span class="number">65536</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置最大内存共享段大小bytes</span></span><br><span class="line"><span class="string">kernel.shmmax</span> <span class="string">=</span> <span class="number">68719476736</span></span><br><span class="line"><span class="string">kernel.shmall</span> <span class="string">=</span> <span class="number">4294967296</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#刷新系统内核参数：</span></span><br><span class="line"><span class="string">/sbin/sysctl</span> <span class="string">-p</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac start hexo for supervisor</title>
    <url>/sugw.github.io/2020/10/26/mac%20for%20supervisor/</url>
    <content><![CDATA[<h1 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h1><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">系统：<span class="keyword">mac</span></span><br><span class="line"></span><br><span class="line">应用：hexo</span><br><span class="line"></span><br><span class="line">守护程序：supervisord</span><br></pre></td></tr></table></figure>

<h1 id="1-安装supervisord"><a href="#1-安装supervisord" class="headerlink" title="1.安装supervisord"></a>1.安装supervisord</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip install supervisor</span><br></pre></td></tr></table></figure>

<h1 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h1><hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisord.conf</span><br><span class="line"></span><br><span class="line">; 包含其他的配置文件</span><br><span class="line">[include]</span><br><span class="line">files &#x3D; &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisor.d&#x2F;*.conf    ; 可以随意指定，目录不存在请先建立。配置文件可以是 *.conf 或 *.ini</span><br><span class="line"></span><br><span class="line"># &#x2F;usr&#x2F;local&#x2F;etc&#x2F;supervisor.d&#x2F;hexo.conf</span><br><span class="line">[program:hexo]                          ; 是应用程序的唯一标识，不能重复</span><br><span class="line">directory &#x3D; &#x2F;Users&#x2F;suguowei&#x2F;Desktop&#x2F;sugw&#x2F;sugwBlog          ; 程序的启动目录</span><br><span class="line">command &#x3D; hexo s ; 启动命令</span><br><span class="line">autostart &#x3D; true                        ; 在 supervisord 启动的时候也自动启动</span><br><span class="line">startsecs &#x3D; 5                           ; 启动 5 秒后没有异常退出，就当作已经正常启动了</span><br><span class="line">autorestart &#x3D; true                      ; 程序异常退出后自动重启</span><br><span class="line">startretries &#x3D; 3                        ; 启动失败自动重试次数，默认是 3</span><br><span class="line">redirect_stderr &#x3D; true                  ; 把 stderr 重定向到 stdout，默认 false</span><br><span class="line">stdout_logfile_maxbytes &#x3D; 20MB</span><br><span class="line">stdout_logfile_backups &#x3D; 20</span><br><span class="line">stdout_logfile &#x3D; &#x2F;var&#x2F;log&#x2F;supervusor&#x2F;hexo.log   ; stdout 日志文件，注意：要确保目录已经建立并且可以访问（写权限）</span><br></pre></td></tr></table></figure>



<h1 id="3-启动"><a href="#3-启动" class="headerlink" title="3.启动"></a>3.启动</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/supervisord -c /usr/<span class="built_in">local</span>/etc/supervisord.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-问题"><a href="#4-问题" class="headerlink" title="4.问题"></a>4.问题</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-	程序启动目录权限</span><br><span class="line"></span><br><span class="line">-	日志文件权限</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Mac</category>
      </categories>
      <tags>
        <tag>supervisor</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki lockdown权限配置</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%20lockdown%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h2 id="禁止游客访问站点内容，需注册"><a href="#禁止游客访问站点内容，需注册" class="headerlink" title="禁止游客访问站点内容，需注册"></a>禁止游客访问站点内容，需注册</h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">## 拒绝没注册用户浏览和编辑</span></span><br><span class="line">$wgGroupPermissions[<span class="string">&#x27;*&#x27;</span>][<span class="symbol">&#x27;edit&#x27;</span>] = false;</span><br><span class="line">$wgGroupPermissions[<span class="string">&#x27;*&#x27;</span>][<span class="symbol">&#x27;read&#x27;</span>] = false;</span><br><span class="line"></span><br><span class="line"><span class="section">## 设置游客可以看到的页面</span></span><br><span class="line">$wgWhitelistRead = array (&quot;Main Page&quot;, &quot;MediaWiki:Common.css&quot;,&quot;MediaWiki:Common.js&quot;,&quot;Special:Userlogin&quot;,&quot;特殊:创建账户&quot;, &quot;Wikipedia:Help&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="安装lockdown插件"><a href="#安装lockdown插件" class="headerlink" title="安装lockdown插件"></a>安装lockdown插件</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta">#1.下载</span></span><br><span class="line"><span class="meta"># 2.解压</span></span><br><span class="line"><span class="meta"># 3. 放到extensions/目录下</span></span><br><span class="line">extensions/Lockdown/</span><br><span class="line"><span class="meta"># 4. 配置文件引入</span></span><br><span class="line">wfLoadExtension( <span class="string">&#x27;Lockdown&#x27;</span> );</span><br><span class="line"><span class="meta"># 5. LocalSettings.php创建名字空间</span></span><br><span class="line">$wgExtraNamespaces =</span><br><span class="line">       array (<span class="number">104</span> =&gt; <span class="string">&quot;OPS&quot;</span>,</span><br><span class="line">             <span class="number">105</span> =&gt; <span class="string">&quot;OPS_Talk&quot;</span>);</span><br><span class="line"><span class="meta"># 6. 只允许sysop用户访问</span></span><br><span class="line">$wgNamespacePermissionLockdown = array_fill( <span class="number">104</span>, <span class="number">105</span>, [  <span class="string">&#x27;*&#x27;</span> =&gt; [ <span class="string">&#x27;sysop&#x27;</span>  ] ] );</span><br><span class="line"></span><br><span class="line"><span class="meta"># 7. 创建页面，把页面移动到ops名字空间</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki安装</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h2 id="环境：php73-mysql5-7-mediawiki1-35-nginx1-18"><a href="#环境：php73-mysql5-7-mediawiki1-35-nginx1-18" class="headerlink" title="环境：php73+mysql5.7+mediawiki1.35+nginx1.18"></a>环境：php73+mysql5.7+mediawiki1.35+nginx1.18</h2><h3 id="安装PHP73"><a href="#安装PHP73" class="headerlink" title="安装PHP73"></a>安装PHP73</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#首先安装 EPEL 源：</span></span><br><span class="line">yum install epel-release</span><br><span class="line"><span class="comment">#安装 REMI 源：</span></span><br><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">yum install -y php73 php73-php-pecl-apcu php73-php-intl php73-php-mbstring php73-php-xml php73-php-pecl-mysql</span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">systemctl restart php73-php-fpm</span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> php73-php-fpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看安装包</span></span><br><span class="line">[root@l-wiki01 ~]<span class="comment">#  rpm -qa | grep &#x27;php&#x27;</span></span><br><span class="line">php73-php-cli-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-2.0-1.el7.remi.x86_64</span><br><span class="line">php73-php-mbstring-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-gd-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-crypto-0.3.1-5.el7.remi.x86_64</span><br><span class="line">oniguruma5php-6.9.5+rev1-4.el7.remi.x86_64</span><br><span class="line">php73-runtime-2.0-1.el7.remi.x86_64</span><br><span class="line">php73-php-common-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pdo-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-mysql-1.0.0-0.20.20180226.647c933.el7.remi.x86_64</span><br><span class="line">php73-php-intl-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-apcu-5.1.19-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-mcrypt-1.0.3-1.el7.remi.x86_64</span><br><span class="line">php73-php-snmp-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-bcmath-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-pecl-geoip-1.1.1-6.el7.remi.x86_64</span><br><span class="line">php73-php-soap-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-json-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-mysqlnd-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-xml-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-recode-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-opcache-7.3.24-1.el7.remi.x86_64</span><br><span class="line">php73-php-fpm-7.3.24-1.el7.remi.x86_64</span><br><span class="line"></span><br><span class="line">找到：php73-php-fpm-7.3.24-1.el7.remi.x86_64安装位置</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># rpm -ql php73-php-fpm-7.3.24-1.el7.remi.x86_64</span></span><br><span class="line">/etc/logrotate.d/php73-php-fpm</span><br><span class="line">/etc/opt/remi/php73/php-fpm.conf</span><br><span class="line">/etc/opt/remi/php73/php-fpm.d</span><br><span class="line">/etc/opt/remi/php73/php-fpm.d/www.conf</span><br><span class="line">/etc/opt/remi/php73/sysconfig/php-fpm</span><br><span class="line">/etc/systemd/system/php73-php-fpm.service.d</span><br><span class="line">/opt/remi/php73/root/usr/sbin/php-fpm</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24/php-fpm.conf.default</span><br><span class="line">/opt/remi/php73/root/usr/share/doc/php73-php-fpm-7.3.24/www.conf.default</span><br><span class="line">/opt/remi/php73/root/usr/share/fpm</span><br><span class="line">/opt/remi/php73/root/usr/share/fpm/status.html</span><br><span class="line">/opt/remi/php73/root/usr/share/licenses/php73-php-fpm-7.3.24</span><br><span class="line">/opt/remi/php73/root/usr/share/licenses/php73-php-fpm-7.3.24/fpm_LICENSE</span><br><span class="line">/opt/remi/php73/root/usr/share/man/man8/php-fpm.8.gz</span><br><span class="line">/usr/lib/systemd/system/php73-php-fpm.service</span><br><span class="line">/var/opt/remi/php73/lib/php/opcache</span><br><span class="line">/var/opt/remi/php73/lib/php/session</span><br><span class="line">/var/opt/remi/php73/lib/php/wsdlcache</span><br><span class="line">/var/opt/remi/php73/<span class="built_in">log</span>/php-fpm</span><br><span class="line">/var/opt/remi/php73/run/php-fpm</span><br><span class="line"></span><br><span class="line">查找php.ini位置：</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># find /etc/opt/remi/php73 -name php.ini</span></span><br><span class="line">/etc/opt/remi/php73/php.ini</span><br><span class="line"></span><br><span class="line">编辑/etc/opt/remi/php73/php.ini替换换 ;cgi.fix_pathinfo=1 为 cgi.fix_pathinfo=0 快捷命令：</span><br><span class="line">sed -i <span class="string">&#x27;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/&#x27;</span> /etc/opt/remi/php73/php.ini</span><br><span class="line"></span><br><span class="line">重启php73-php-fpm</span><br><span class="line">systemctl restart php73-php-fpm</span><br><span class="line">更多操作：</span><br><span class="line">systemctl restart php73-php-fpm <span class="comment">#重启</span></span><br><span class="line">systemctl start php73-php-fpm <span class="comment">#启动</span></span><br><span class="line">systemctl stop php73-php-fpm <span class="comment">#关闭</span></span><br><span class="line">systemctl status php73-php-fpm <span class="comment">#检查状态</span></span><br><span class="line">查看 PHP</span><br><span class="line">验证一下是否安装成功：</span><br><span class="line">[root@l-wiki01 ~]<span class="comment"># php73 -v</span></span><br><span class="line">PHP 7.3.24 (cli) (built: Oct 27 2020 11:01:59) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.3.24, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.3.24, Copyright (c) 1999-2018, by Zend Technologies</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载源</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line"><span class="comment">#更新源</span></span><br><span class="line">rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line"><span class="comment">#安装mysql</span></span><br><span class="line">yum -y install mysql-server</span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="comment">#查看临时密码</span></span><br><span class="line">grep <span class="string">&#x27;temporary password&#x27;</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"><span class="comment">#修改root临时密码</span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123@CSDN.com&#x27;</span>;  <span class="comment">#密码要符合安全策略否则不生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建wiki库</span></span><br><span class="line">CREATE DATABASE IF NOT EXISTS wiki DEFAULT CHARACTER SET = utf8mb4;</span><br><span class="line"><span class="comment">#创建wiki库管理账号密码</span></span><br><span class="line"><span class="comment">#授权的同时设置密码</span></span><br><span class="line">grant all privileges on wiki.* to wiki@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装mediawiki1-35"><a href="#安装mediawiki1-35" class="headerlink" title="安装mediawiki1.35"></a>安装mediawiki1.35</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载 官网下载需要翻墙</span></span><br><span class="line">百度云盘下载</span><br><span class="line">链接: https://pan.baidu.com/s/1Gd0OEirZOQttU4LPSJ9DiQ 提取码: drds </span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar zxvf mediawiki-1.35.0.tar.gz</span><br><span class="line"><span class="comment"># 更名</span></span><br><span class="line">mv mediawiki-1.35.0 mediawiki</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install nginx</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="comment"># 开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">[root@l-wiki01 nginx]<span class="comment"># cat vhost/wiki.conf</span></span><br><span class="line">server</span><br><span class="line">  &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  wiki.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root  /data/mediawiki;</span><br><span class="line"></span><br><span class="line">    location ~ /.svn/ &#123;</span><br><span class="line">    deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#rewrite ^/$ /?user=talkvip last;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    rewrite ^/$ /index.php last;</span><br><span class="line">    rewrite ^/(?!index\.php|index\.html|extensions|images|public|robots\.txt)(.*)$ /index.php/<span class="variable">$1</span> last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   location ~ \.php &#123;</span><br><span class="line">		 proxy_busy_buffers_size   512k;</span><br><span class="line">		 proxy_buffers   4 512k;</span><br><span class="line">		 proxy_buffer_size   256k;</span><br><span class="line">                fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">                fastcgi_index index.php;</span><br><span class="line">                fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">                include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~/uploads/.*\.(php|php7)?$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~/public/.*\.(php|php7)?$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">    &#123;</span><br><span class="line">      expires      30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(js|css)?$</span><br><span class="line">   &#123;</span><br><span class="line">      expires      8d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        access_log  /data/logs/mediawiki/access.log  main;</span><br><span class="line">        error_log  /data/logs/mediawiki/error.log ;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#nginx 配置文件引入wiki.conf文件</span></span><br><span class="line">    include vhost/*.conf;</span><br><span class="line"><span class="comment"># 加载配置文件</span></span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问不到站点可能存在以下几个原因</span></span><br><span class="line">1.站点权限和nginx配置文件权限不匹配</span><br><span class="line">2.站点权限nginx权限和php权限检查</span><br><span class="line"></span><br><span class="line">[root@l-wiki01 nginx]<span class="comment"># cat /etc/opt/remi/php73/php-fpm.d/www.conf |egrep -v &quot;^$|;&quot;</span></span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 5</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">slowlog = /var/opt/remi/php73/<span class="built_in">log</span>/php-fpm/www-slow.log</span><br><span class="line">security.limit_extensions = .php .php3 .php4 .php5 .php7 .html .htm .pl .js .css .jpg .jpeg .gif .png .svg</span><br><span class="line">php_admin_value[error_log] = /var/opt/remi/php73/<span class="built_in">log</span>/php-fpm/www-error.log</span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path]    = /var/opt/remi/php73/lib/php/session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/opt/remi/php73/lib/php/wsdlcache</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="访问站点根据教程安装"><a href="#访问站点根据教程安装" class="headerlink" title="访问站点根据教程安装"></a>访问站点根据教程安装</h3><p>wiki.com</p>
<p>参考文档：<a href="https://zhuanlan.zhihu.com/p/53827054">https://zhuanlan.zhihu.com/p/53827054</a></p>
]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mediawiki悬浮目录</title>
    <url>/sugw.github.io/2020/11/13/mediawiki%E6%82%AC%E6%B5%AE%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<h2 id="MediaWiki-Common-css"><a href="#MediaWiki-Common-css" class="headerlink" title="MediaWiki:Common.css"></a>MediaWiki:Common.css</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#toc</span>&#123;</span><br><span class="line"> <span class="attribute">display</span>: block;</span><br><span class="line"> <span class="attribute">position</span>: fixed;</span><br><span class="line"> <span class="attribute">top</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">right</span>: <span class="number">0px</span>;</span><br><span class="line"> <span class="attribute">min-width</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">max-width</span>: <span class="number">350px</span>;</span><br><span class="line"> <span class="attribute">max-height</span>: <span class="number">20px</span>;</span><br><span class="line"> <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line"> <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#aaa</span>;</span><br><span class="line"> <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">-moz-border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">249</span>,<span class="number">249</span>,<span class="number">249</span>,<span class="number">0.75</span>);</span><br><span class="line"> <span class="attribute">padding</span>: <span class="number">12px</span>;</span><br><span class="line"> <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-webkit-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-moz-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="selector-id">#toc</span><span class="selector-pseudo">:hover</span>&#123;</span><br><span class="line"> <span class="attribute">display</span>: block;</span><br><span class="line"> <span class="attribute">position</span>: fixed;</span><br><span class="line"> <span class="attribute">top</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">right</span>: <span class="number">0px</span>;</span><br><span class="line"> <span class="attribute">min-width</span>: <span class="number">100px</span>;</span><br><span class="line"> <span class="attribute">max-width</span>: <span class="number">350px</span>;</span><br><span class="line"> <span class="attribute">max-height</span>: <span class="number">500px</span>;</span><br><span class="line"> <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line"> <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#aaa</span>;</span><br><span class="line"> <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">-moz-border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">1px</span> <span class="number">1px</span>;</span><br><span class="line"> <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">249</span>,<span class="number">249</span>,<span class="number">249</span>,<span class="number">0.75</span>);</span><br><span class="line"> <span class="attribute">padding</span>: <span class="number">12px</span>;</span><br><span class="line"> <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-webkit-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> <span class="attribute">-moz-box-shadow</span>: <span class="number">0</span> <span class="number">1px</span> <span class="number">8px</span> <span class="number">#000</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="selector-tag">body</span> &#123; <span class="attribute">overflow-x</span>: hidden;&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>wiki</category>
      </categories>
      <tags>
        <tag>wiki</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql 删除表数据空间没有释放</title>
    <url>/sugw.github.io/2021/01/06/mysql-delete/</url>
    <content><![CDATA[<p>事件起因：</p>
<p>今天运维人员找我，说我们的数据库磁盘空间满了。于是提供了一些删除表数据的sql给他，让他执行下。</p>
<p>执行之后，查询数据库，表数据是不在了，但是问题来了。</p>
<p>磁盘空间并没有释放，这是为啥咧？？？？</p>
<p>于是乎，上网查找资料，功夫不负有心人，终于找到问题原因：</p>
<h3 id="使用delete-加上-where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。-被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。"><a href="#使用delete-加上-where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。-被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。" class="headerlink" title="使用delete 加上 where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。 被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。"></a><strong>使用delete 加上 where条件的删除都不是真删除，在删除数据的时候，mysql并没有把数据文件删除，而是将数据文件的标识位删除，没有整理文件，因此不会彻底释放空间。</strong> <strong>被删除的数据将会被保存在一个链接清单中，当有新数据写入的时候，mysql会利用这些已删除的空间再写入。删除操作会带来一些数据碎片，正是这些碎片在占用硬盘空间。</strong></h3><p>解决方法：</p>
<p>执行完delete语句的时候，再执行下：<strong>OPTIMIZE TABLE XXXTable(自己的表名)</strong></p>
<p><strong>注意事项：</strong></p>
<p><strong>执行OPTIMIZE TABLE的时候，会导致锁表，而且没有必要每次delete之后都执行，一个月定时清理下即可。另外，OPTIMIZE 操作会导致锁表，建议在访问量小的时候执行！</strong></p>
<p>转载于：<a href="https://www.cnblogs.com/shawnloong/archive/2013/02/07/2908911.html">https://www.cnblogs.com/shawnloong/archive/2013/02/07/2908911.html</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>nginx 阻止IP访问实例</title>
    <url>/sugw.github.io/2020/10/28/nginx%E9%98%BB%E6%AD%A2IP%E8%AE%BF%E9%97%AE%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<h3 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h3><p>静态文件，较简单</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location ^~ &#x2F;static&#x2F;css&#x2F; &#123;</span><br><span class="line">       deny 10.120.0.1;</span><br><span class="line">       deny 10.120.11.78;</span><br><span class="line">       #allow 10.120.11.3;</span><br><span class="line">       #allow 43.243.138.146;</span><br><span class="line">       #allow 114.118.12.231;</span><br><span class="line">       deny all;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h3><p>路由较复杂：</p>
<figure class="highlight plain"><figcaption><span>s</span></figcaption><table><tr><td class="code"><pre><span class="line">location ^~ &#x2F;api&#x2F;fanstest&#x2F; &#123;</span><br><span class="line">   if ($remote_addr ~ &quot;(103.118.52.18|114.118.12.231|114.118.13.46)&quot;) &#123;</span><br><span class="line">       rewrite  ^(.*)$  &#x2F;index.php?s&#x3D;$1  last;</span><br><span class="line">   &#125;</span><br><span class="line">   if ($remote_addr &#x3D; &quot;10.120.11.3&quot;) &#123;</span><br><span class="line">       rewrite  ^(.*)$  &#x2F;index.php?s&#x3D;$1  last;</span><br><span class="line">   &#125;</span><br><span class="line">     return 403;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus-pushgateway</title>
    <url>/sugw.github.io/2020/11/23/prometheus-pushgateway/</url>
    <content><![CDATA[<h1 id="一、Pushgateway-简介"><a href="#一、Pushgateway-简介" class="headerlink" title="一、Pushgateway 简介"></a>一、Pushgateway 简介</h1><p><a href="https://github.com/prometheus/pushgateway">Pushgateway</a> 是 Prometheus 生态中一个重要工具，使用它的原因主要是：</p>
<ul>
<li>Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。</li>
<li>在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。</li>
</ul>
<p>由于以上原因，不得不使用 pushgateway，但在使用之前，有必要了解一下它的一些弊端：</p>
<ul>
<li>将多个节点数据汇总到 pushgateway, 如果 pushgateway 挂了，受影响比多个 target 大。</li>
<li>Prometheus 拉取状态 <code>up</code> 只针对 pushgateway, 无法做到对每个节点有效。</li>
<li>Pushgateway 可以持久化推送给它的所有监控数据。</li>
</ul>
<p>因此，即使你的监控已经下线，prometheus 还会拉取到旧的监控数据，需要手动清理 pushgateway 不要的数据。</p>
<p>拓扑图如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181109120151807-1018788353.png" class title="img">





<h3 id="二、-安装"><a href="#二、-安装" class="headerlink" title="二、 安装"></a>二、 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.3.0/pushgateway-1.3.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar xf pushgateway-1.3.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv pushgateway-1.3.0.linux-amd64 pushgateway</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> pushgateway/</span><br><span class="line"></span><br><span class="line">./pushgateway</span><br></pre></td></tr></table></figure>



<p>访问url：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">91.132</span>:<span class="number">9091</span>/</span><br></pre></td></tr></table></figure>



<p>效果如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184527450-1425046509.png" class title="img">





<p>要使Push Gateway正常工作，必须要在prometheus中配置对应的job才行</p>
<p>修改配置文件 </p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">vim <span class="regexp">/opt/</span>apps<span class="regexp">/prometheus/</span>prometheus.yml</span><br></pre></td></tr></table></figure>



<p>添加Push Gateway，完整内容如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">60s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">60s</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">prometheus</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.91.132:9100&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">pushgateway</span></span><br><span class="line">    <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.91.132:9091&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">pushgateway</span> </span><br></pre></td></tr></table></figure>

<p>访问targets，等待1分钟，等待pushgateway状态为UP</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185739578-1598911471.png" class title="img">



<h2 id="三、数据管理"><a href="#三、数据管理" class="headerlink" title="三、数据管理"></a>三、数据管理</h2><p>正常情况我们会使用 Client SDK 推送数据到 pushgateway, 但是我们还可以通过 API 来管理, 例如：</p>
<h2 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h2><p>向 {job=”some_job”} 添加单条数据：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">echo <span class="string">&quot;some_metric 3.14&quot;</span> | curl --data-binary @- http:<span class="regexp">//</span>pushgateway.example.org:<span class="number">9091</span><span class="regexp">/metrics/</span>job/some_job</span><br></pre></td></tr></table></figure>



<p> –data-binary 表示发送二进制数据，注意：它是使用POST方式发送的！</p>
<p>添加更多更复杂数据，通常数据会带上 instance, 表示来源位置：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http:<span class="regexp">//</span>pushgateway.example.org:<span class="number">9091</span><span class="regexp">/metrics/</span>job<span class="regexp">/some_job/i</span>nstance/some_instance</span><br><span class="line"><span class="comment"># TYPE some_metric counter</span></span><br><span class="line">some_metric&#123;label=<span class="string">&quot;val1&quot;</span>&#125; <span class="number">42</span></span><br><span class="line"><span class="comment"># TYPE another_metric gauge</span></span><br><span class="line"><span class="comment"># HELP another_metric Just an example.</span></span><br><span class="line">another_metric <span class="number">2398.283</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>注意：必须是指定的格式才行！ </p>
<p>删除某个组下的某实例的所有数据：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -X DELETE http:<span class="regexp">//</span>pushgateway.example.org:<span class="number">9091</span><span class="regexp">/metrics/</span>job<span class="regexp">/some_job/i</span>nstance/some_instance</span><br></pre></td></tr></table></figure>



<p>删除某个组下的所有数据：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -X DELETE http:<span class="regexp">//</span>pushgateway.example.org:<span class="number">9091</span><span class="regexp">/metrics/</span>job/some_job</span><br></pre></td></tr></table></figure>



<p>可以发现 pushgateway 中的数据我们通常按照 <code>job</code> 和 <code>instance</code> 分组分类，所以这两个参数不可缺少。</p>
<p>因为 Prometheus 配置 pushgateway 的时候，也会指定 job 和 instance, 但是它只表示 pushgateway 实例，不能真正表达收集数据的含义。所以在 prometheus 中配置 pushgateway 的时候，需要添加 <code>honor_labels: true</code> 参数， 从而避免收集数据本身的 <code>job</code> 和 <code>instance</code> 被覆盖。</p>
<p>注意，为了防止 pushgateway 重启或意外挂掉，导致数据丢失，我们可以通过 <code>-persistence.file</code> 和 <code>-persistence.interval</code> 参数将数据持久化下来。</p>
<p>本文参考链接：</p>
<p><a href="https://songjiayang.gitbooks.io/prometheus/content/pushgateway/how.html">https://songjiayang.gitbooks.io/prometheus/content/pushgateway/how.html</a></p>
<h2 id="python脚本"><a href="#python脚本" class="headerlink" title="python脚本"></a>python脚本</h2><h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip3 <span class="keyword">install</span> flask</span><br><span class="line">pip3 <span class="keyword">install</span> prometheus_client</span><br></pre></td></tr></table></figure>



<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><p>Prometheus提供4种类型Metrics：<code>Counter</code>, <code>Gauge</code>, <code>Summary</code>和<code>Histogram</code></p>
<h4 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h4><p>Counter可以增长，并且在程序重启的时候会被重设为0，常被用于任务个数，总处理时间，错误个数等只增不减的指标。</p>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> prometheus_client</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> prometheus_client.core <span class="keyword">import</span> CollectorRegistry</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Response, Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">requests_total = Counter(<span class="string">&quot;request_count&quot;</span>, <span class="string">&quot;Total request cout of the host&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/metrics&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requests_count</span>():</span></span><br><span class="line">    requests_total.inc()</span><br><span class="line">    <span class="comment"># requests_total.inc(2)</span></span><br><span class="line">    <span class="keyword">return</span> Response(prometheus_client.generate_latest(requests_total),</span><br><span class="line">                    mimetype=<span class="string">&quot;text/plain&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    requests_total.inc()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>) </span><br></pre></td></tr></table></figure>

<p>运行该脚本，访问youhost:5000/metrics</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># HELP request_count Total request cout of the host</span></span><br><span class="line"><span class="comment"># TYPE request_count counter</span></span><br><span class="line"><span class="attribute">request_count</span> <span class="number">3</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>



<h4 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h4><p>Gauge与Counter类似，唯一不同的是Gauge数值可以减少，常被用于温度、利用率等指标。</p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import random</span><br><span class="line">import prometheus_client</span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">from flask import Response, Flask</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">random_value &#x3D; Gauge(&quot;random_value&quot;, &quot;Random value of the request&quot;)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;metrics&quot;)</span><br><span class="line">def r_value():</span><br><span class="line">    random_value.set(random.randint(0, 10))</span><br><span class="line">    return Response(prometheus_client.generate_latest(random_value),</span><br><span class="line">                    mimetype&#x3D;&quot;text&#x2F;plain&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run(host&#x3D;&quot;0.0.0.0&quot;) </span><br></pre></td></tr></table></figure>

<p>运行该脚本，访问youhost:5000/metrics</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># HELP random_value Random value of the request</span></span><br><span class="line"><span class="comment"># TYPE random_value gauge</span></span><br><span class="line"><span class="attribute">random_value</span> <span class="number">3</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>



<h4 id="Summary-Histogram"><a href="#Summary-Histogram" class="headerlink" title="Summary/Histogram"></a>Summary/Histogram</h4><p>Summary/Histogram概念比较复杂，一般exporter很难用到，暂且不说。</p>
<p><strong>PLUS</strong></p>
<p><strong>LABELS</strong></p>
<p>使用labels来区分metric的特征</p>
<p>示例代码：</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client import Counter</span><br><span class="line"></span><br><span class="line">c = Counter(<span class="string">&#x27;requests_total&#x27;</span>, <span class="string">&#x27;HTTP requests total&#x27;</span>, [<span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;clientip&#x27;</span>])</span><br><span class="line"></span><br><span class="line">c.labels(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>).inc()</span><br><span class="line">c.labels(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;192.168.0.1&#x27;</span>).inc(<span class="number">3</span>)</span><br><span class="line">c.labels(<span class="function"><span class="keyword">method</span>=&quot;<span class="title">get</span>&quot;, <span class="title">clientip</span>=&quot;192.168.0.1&quot;).<span class="title">inc</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>



<p><strong>REGISTRY</strong></p>
<p>示例代码：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client import Counter, Gauge</span><br><span class="line"><span class="keyword">from</span> prometheus_client.core import CollectorRegistry</span><br><span class="line"></span><br><span class="line">REGISTRY = CollectorRegistry(<span class="attribute">auto_describe</span>=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">requests_total = Counter(<span class="string">&quot;request_count&quot;</span>, <span class="string">&quot;Total request cout of the host&quot;</span>, <span class="attribute">registry</span>=REGISTRY)</span><br><span class="line">random_value = Gauge(<span class="string">&quot;random_value&quot;</span>, <span class="string">&quot;Random value of the request&quot;</span>, <span class="attribute">registry</span>=REGISTRY) </span><br></pre></td></tr></table></figure>

<p>本文参考链接：</p>
<p><a href="https://blog.csdn.net/huochen1994/article/details/76263078">https://blog.csdn.net/huochen1994/article/details/76263078</a></p>
<h3 id="举例-网卡流量"><a href="#举例-网卡流量" class="headerlink" title="举例:(网卡流量)"></a>举例:(网卡流量)</h3><p>先访问这篇文章《python 获取网卡实时流量》：</p>
<p><a href="http://www.py3study.com/Article/details/id/347.html">http://www.py3study.com/Article/details/id/347.html</a></p>
<p>下面这段python脚本，主要是参考上面文章的基础上修改的</p>
<p>发送本机网卡流量 </p>
<p>执行脚本，它会发送1次数据给Push Gateway</p>
<p>取到的流量没有除以1024，所以默认是字节</p>
<p><strong>注意：发送的链接，约定成俗的格式如下：</strong></p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>Pushgateway地址:<span class="number">9091</span><span class="regexp">/metrics/</span>job/监控项目</span><br></pre></td></tr></table></figure>

<p>比如监控etcd，地址就是这样的</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">http:<span class="regexp">//</span>Pushgateway地址:<span class="number">9091</span><span class="regexp">/metrics/</span>job/etcd</span><br></pre></td></tr></table></figure>



<p><strong>必须使用POST方式发送数据！</strong></p>
<h4 id="代码解释"><a href="#代码解释" class="headerlink" title="代码解释"></a>代码解释</h4><p>关键代码，就是这几行</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">REGISTRY = CollectorRegistry(<span class="attribute">auto_describe</span>=<span class="literal">False</span>)</span><br><span class="line">input = Gauge(<span class="string">&quot;network_traffic_input&quot;</span>, hostname,[<span class="string">&#x27;adapter_name&#x27;</span>,<span class="string">&#x27;unit&#x27;</span>,<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;instance&#x27;</span>],<span class="attribute">registry</span>=REGISTRY)  # 流入</span><br><span class="line">output = Gauge(<span class="string">&quot;network_traffic_output&quot;</span>, hostname,[<span class="string">&#x27;adapter_name&#x27;</span>,<span class="string">&#x27;unit&#x27;</span>,<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;instance&#x27;</span>],<span class="attribute">registry</span>=REGISTRY)  # 流出</span><br><span class="line"></span><br><span class="line">input.labels(<span class="attribute">ip</span>=net_addr[key],<span class="attribute">adapter_name</span>=key, <span class="attribute">unit</span>=<span class="string">&quot;Byte&quot;</span>,instance=hostname).inc(net_in.get(key))</span><br><span class="line">output.labels(<span class="attribute">ip</span>=net_addr[key],<span class="attribute">adapter_name</span>=key, <span class="attribute">unit</span>=<span class="string">&quot;Byte&quot;</span>,instance=hostname).inc(net_out.get(key))</span><br></pre></td></tr></table></figure>



<p>1、自定义的指标收集类都必须到CollectorRegistry进行注册， 指标数据通过CollectorRegistry类的方法或者函数，返回给Prometheus.<br>2、CollectorRegistry必须提供register()和unregister()函数，一个指标收集器可以注册多个CollectorRegistry.<br>3、客户端库必须是线程安全的</p>
<p>代码第一行，声明了CollectorRegistry</p>
<p>input和output是流入流出的流量。Metrics使用的是Gauge</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">input</span> = Gauge(<span class="string">&quot;network_traffic_input&quot;</span>, hostname,[<span class="string">&#x27;adapter_name&#x27;</span>,<span class="string">&#x27;unit&#x27;</span>,<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;instance&#x27;</span>],registry=REGISTRY)  <span class="comment"># 流入</span></span><br></pre></td></tr></table></figure>



<p>network_traffic_input表示键值，它必须唯一。因为在grafana图表中，要用这个键值绘制图表。</p>
<p>“” 为空，它其实对应的是描述信息。为了避免数据冗长，一般不写它。</p>
<p>[‘adapter_name’,’unit’,’ip’,’instance’] ，它是一个列表，里面每一个元素都是labels，它是用来区分metric的特征</p>
<p>registry=REGISTRY 把数据注册到REGISTRY中</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">input.labels(<span class="attribute">ip</span>=net_addr[key],<span class="attribute">adapter_name</span>=key, <span class="attribute">unit</span>=<span class="string">&quot;Byte&quot;</span>,instance=hostname).inc(net_in.get(key))</span><br></pre></td></tr></table></figure>



<p>这里定义了input的labels，括号里面有3个键值对。<strong>注意：这3个键值对必须在[‘adapter_name’,’unit’,’ip’] 列表中。</strong></p>
<p>如果labels中要增加键值对，那么上面的列表中，也要增加对应的元素。否则会报错！</p>
<p>inc表示具体值。它对应的是input</p>
<p>刷新Push Gateway页面</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184858813-100768690.png" class title="img">



<p>展开数据，这里就是流入流出的数据了</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108184910331-1187418117.png" class title="img">



<p> 进入grafana页面，新建一个图表</p>
<p>添加网络 流入和流出指标</p>
 <img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185021071-1832061672.png" class title="img">



<p>更改标题</p>
 <img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185132311-1692507631.png" class title="img">



<p>设置liunx任务计划，每分钟执行一次</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">*</span> <span class="emphasis">* *</span> <span class="emphasis">* *</span> python3 /opt/test.py</span><br></pre></td></tr></table></figure>





<p>效果如下：</p>
<img src="/sugw.github.io/2020/11/23/prometheus-pushgateway/1341090-20181108185223977-1139168879.png" class title="img">



<p>如果服务器没有流量的话，可以造点流量</p>
<p>写一个脚本，持续访问某张图片</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    requests.<span class="builtin-name">get</span>(<span class="string">&quot;http://192.168.91.128/Netraffic/dt.jpg&quot;</span>)</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">&#x27;正在访问图片&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>如果需要监控Mysql，参考这篇文章</p>
<p><a href="https://www.jianshu.com/p/27b979554ef8">https://www.jianshu.com/p/27b979554ef8</a></p>
<p>注意：它使用的是用flask暴露了一个Metrics，用来给Prometheus提供数据。</p>
<p>那么就需要在 Prometheus的配置文件中，添加对应的job才能收集到数据。</p>
<p>它会定期访问暴露的http链接，获取数据。</p>
<p>总结：</p>
<p>使用Prometheus监控，有2中方式</p>
<ol>
<li><p>暴露http方式的Metrics，注意：需要在Prometheus的配置文件中添加job</p>
</li>
<li><p>主动发送数据到Pushgateway，注意：只需要添加一个Pushgateway就可以了。它相当于一个API，无论有多少个服务器，发送到统一的地址。</p>
</li>
</ol>
<p>生产环境中，一般使用Pushgateway，简单，也不需要修改Prometheus的配置文件！</p>
<ul>
<li><h1 id="node-exports-推送"><a href="#node-exports-推送" class="headerlink" title="node_exports 推送"></a>node_exports 推送</h1></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl 127.0.0.1:9100/metrics|curl --data-binary @- http://114.118.10.162:9091/metrics/job/node_exporter/instance/比格云/hostname/l-crmeb01.qa.hn-ml.com</span><br></pre></td></tr></table></figure>

<p><strong>也可以通过使用官方给的<a href="https://github.com/prometheus/client_python">python library</a>，使用push 方式把数据推送到pushgateway。</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat client.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, push_to_gateway</span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line">g = Gauge(<span class="string">&#x27;ping&#x27;</span>, <span class="string">&#x27;检测最大响应时间&#x27;</span>,[<span class="string">&#x27;dst_ip&#x27;</span>,<span class="string">&#x27;city&#x27;</span>], registry=registry) <span class="comment">#Guage(metric_name,HELP,labels_name,registry=registry)</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.10&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).<span class="built_in">set</span>(<span class="number">42.2</span>) <span class="comment">#set设定值</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.11&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).dec(<span class="number">2</span>)  <span class="comment">#dec递减2</span></span><br><span class="line">g.labels(<span class="string">&#x27;192.168.1.12&#x27;</span>,<span class="string">&#x27;shenzhen&#x27;</span>).inc()  <span class="comment">#inc递增，默认增1</span></span><br><span class="line">push_to_gateway(<span class="string">&#x27;localhost:9091&#x27;</span>, job=<span class="string">&#x27;ping_status&#x27;</span>, registry=registry)</span><br></pre></td></tr></table></figure>

<p><strong>需要注意：使用这种方法，如果使用相同的job名 ，后面插入的数据会覆盖掉之前的。</strong></p>
<p>例如，job 都叫 ping_status</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, push_to_gateway</span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line">g = Gauge(<span class="string">&#x27;test_metrics&#x27;</span>, <span class="string">&#x27;描述信息&#x27;</span>,[<span class="string">&#x27;label_name&#x27;</span>], registry=registry)</span><br><span class="line">g.labels(<span class="string">&#x27;label1&#x27;</span>).<span class="built_in">set</span>(<span class="number">2</span>)</span><br><span class="line">push_to_gateway(<span class="string">&#x27;localhost:9091&#x27;</span>, job=<span class="string">&#x27;ping_status&#x27;</span>, registry=registry)</span><br></pre></td></tr></table></figure>

<p>监控脚本示例</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">获取tcp连接数脚本</span><br><span class="line"><span class="comment"># cat tcpestab.sh </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#获取主机名，常传输到Prometheus标签以主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d<span class="string">&#x27;.&#x27;</span> -f1`</span><br><span class="line"><span class="comment">#判断主机名不能是localhost不然发送过的数据不知道是那个主机的 </span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$instance_name</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hostname must not localhost&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#自定义key，在Prometheus即可使用key查询</span></span><br><span class="line">label=<span class="string">&quot;count_estab_connections&quot;</span> </span><br><span class="line"><span class="comment">#获取TCP estab 连接数</span></span><br><span class="line">count_estab_connections=`netstat -an | grep -i <span class="string">&#x27;established&#x27;</span> | wc -l`</span><br><span class="line"><span class="comment">#将数据发送到pushgateway固定格式</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$label</span> <span class="variable">$count_estab_connections</span>&quot;</span>  | curl --data-binary @- http://192.168.184.130:9191/metrics/job/pushgateway/instance/<span class="variable">$instance_name</span></span><br></pre></td></tr></table></figure>

<p>设置数据采集频率</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#15s 采集一次</span></span><br><span class="line">*/15 * * * * sh /root/tcpestab.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>监控</category>
      </categories>
      <tags>
        <tag>prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>开启GTID的情况下导出导入库的注意事项</title>
    <url>/sugw.github.io/2020/12/17/%E5%BC%80%E5%90%AFGTID%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%AF%BC%E5%87%BA%E5%AF%BC%E5%85%A5%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%20/</url>
    <content><![CDATA[<blockquote>
<p>在开启了 GTID 功能的 MySQL 数据库中, 不论是否使用了 GTID 的方式做了主从同步, 导出导入时都需要特别注意数据库中的 GTID 信息.</p>
</blockquote>
<h1 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">➜  mysqldump -uroot -p userdb &gt; userdb.sql</span><br><span class="line">Warning: A partial dump <span class="keyword">from</span> a<span class="built_in"> server </span>that has GTIDs will by<span class="built_in"> default </span>include the GTIDs of all transactions, even those that changed suppressed parts of the database. <span class="keyword">If</span> you don<span class="string">&#x27;t want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events</span></span><br></pre></td></tr></table></figure>

<p>mysql提示: 当前数据库实例中开启了 GTID 功能, 在开启有 GTID 功能的数据库实例中, 导出其中任何一个库, 如果没有显示地指定<code>--set-gtid-purged</code>参数, 都会提示这一行信息. 意思是默认情况下, 导出的库中含有 GTID 信息, 如果不想导出包含有 GTID 信息的数据库, 需要显示地添加<code>--set-gtid-purged=OFF</code>参数. 于是乎, dump 变成了如下样子</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">➜ mysqldump -uroot -p --<span class="keyword">set</span>-gtid-purged=<span class="keyword">OFF</span> userdb &gt; userdb.sql</span><br></pre></td></tr></table></figure>

<p>使用以上这条命令 dump 出来的库是不包含 GTID 信息的</p>
<h1 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h1><p>导入的时候也分两种, 一种是导入带有 GTID 的信息的库, 一种是导入不带有 GTID 信息的库</p>
<h2 id="不带有-GTID-信息"><a href="#不带有-GTID-信息" class="headerlink" title="不带有 GTID 信息"></a>不带有 GTID 信息</h2><p>不带有 GTID 信息的 dump 文件, 不管目标数据库实例是否开启了 GTID 功能, 且不管数据库实例是否已有其他 GTID 信息, 都可以顺利导入</p>
<h2 id="带有-GTID-信息"><a href="#带有-GTID-信息" class="headerlink" title="带有 GTID 信息"></a>带有 GTID 信息</h2><p>带有 GTID 信息的 dump 文件, 要求目标数据库实例必须开启 GTID 功能, 且当前数据库中无其他 GTID 信息. 如果目标数据库中已经记录了一条或一条以上的 GTID 信息, 那么在导入数据库时会报出类似如下的错误❌</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">➜  mysql -uroot -p userdb &lt; userdb.sql</span><br><span class="line">Password:xxxxxxxx</span><br><span class="line"><span class="keyword">ERROR </span>1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure>

<p>在 mysql5.7版本中加入了多 channel 的特性, 一台数据库实例可以同时与多个主库同步, 实现多主一从架构, 但是假如现在数据库实例中开启了 GTID, 并以 GTID 的方式与 A 主库和 B 主库同步,那么现在的 slave 中就记录有两条 GTID 信息. 在导入带有新 GTID 信息的库时, 会报错, 要求你清除掉目标数据库实例中所有的 GTID 信息. 在这种情况下, 问题就比较严重了, 因为我的这台数据库已经和两台主库建立主从关系, 现在为了导入一个新库, 需要 reset 掉所有同步信息(GTID 信息)</p>
<p>这个时候你有两个选择:</p>
<ol>
<li>重新 dump 数据库, 使用<code>--set-gtid-purged=OFF</code>的参数禁止🚫导出 GTID 信息,再 load 进目标数据库</li>
<li>在目标数据库中执行<code>mysql&gt; reset slave all;</code> <code>mysql&gt; reset master;</code> 清空所有 GTID 信息之后就可以导入了</li>
</ol>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos6/7 安装PHP7.3教程</title>
    <url>/sugw.github.io/2020/11/03/Centos67%20%E5%AE%89%E8%A3%85PHP7.3%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>最近的 PHP 7.3.0 已经在 2018 年12月6日 发布 GA，大家已经可以开始第一时间体验新版本了，这里先放出 PHP7.3 安装的教程以便大家升级。</p>
<h1 id="更新内容"><a href="#更新内容" class="headerlink" title="更新内容"></a>更新内容</h1><p>PHP 7.3 的主要更新内容：</p>
<blockquote>
<p>灵活的 Heredoc 和 Nowdoc 语法<br>从 PCRE 迁移至 PCRE2<br>Multiple MBString Improvements<br>LDAP 控件支持<br>改善 FPM 日志<br>改善 Windows 文件删除<br>弃用相关就平台</p>
</blockquote>
<p>PHP 7.3 并没有带来特别激进的更新，同一天发布更新的 WordPress 5.0 也是第一时间带来了对 PHP7.3 的支持。</p>
<p>当然了 PHP 7.3 也带了性能提升，相比早期的 PHP 7.0 有了近 22% 的性能提升。同时 PHP 5.6 和 7.0 都即将失去 PHP 社区官方的支持，所以也是建议大家能尽快的升级到最新版本。</p>
<p>421</p>
<h1 id="安装-PHP"><a href="#安装-PHP" class="headerlink" title="安装 PHP"></a>安装 PHP</h1><p><strong>教程适用系统：</strong> CentOS6 CentOS7，CentOS8 由于使用了 APPStream ，所以安装方式有变</p>
<p>Remi 软件源 主要提供最新版的 PHP 软件包和其他一些 PHP 扩展工具包，它是针对 Fedora 和 RHEL 系分支变体 （包括：RHEL, CentOS, Oracle Linux 等等） 要安装 PHP，推荐使用 Remi 软件源。Remi 对 PHP 的支持和更新都很积极，可以在第一时间获得新版本的支持。</p>
<p>由于 PHP 7.3 是新出的版本势必有不少的兼容性问题，特别是国产的程序建议等待开发者通知再进行升级，一些 PECL 扩展可能也不会及时适配最新版。<strong>建议更新前提前做好备份准备</strong>。目前已知的是 WordPress 5.0 版本开始支持 PHP 7.3。</p>
<h2 id="添加软件源"><a href="#添加软件源" class="headerlink" title="添加软件源"></a>添加软件源</h2><h3 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h3><h4 id="安装-EPEL-源："><a href="#安装-EPEL-源：" class="headerlink" title="安装 EPEL 源："></a>安装 EPEL 源：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br></pre></td></tr></table></figure>

<h4 id="安装-REMI-源："><a href="#安装-REMI-源：" class="headerlink" title="安装 REMI 源："></a>安装 REMI 源：</h4><p><strong>CentOS 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm  </span><br></pre></td></tr></table></figure>

<p><strong>CentOS 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-6.rpm</span><br></pre></td></tr></table></figure>

<h4 id="安装-Yum-源管理工具："><a href="#安装-Yum-源管理工具：" class="headerlink" title="安装 Yum 源管理工具："></a>安装 Yum 源管理工具：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure>

<h3 id="RHEL"><a href="#RHEL" class="headerlink" title="RHEL"></a>RHEL</h3><h4 id="安装-EPEL-源：-1"><a href="#安装-EPEL-源：-1" class="headerlink" title="安装 EPEL 源："></a>安装 EPEL 源：</h4><p><strong>RHEL 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br></pre></td></tr></table></figure>

<p><strong>RHEL 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm</span><br></pre></td></tr></table></figure>

<h4 id="安装-REMI-源：-1"><a href="#安装-REMI-源：-1" class="headerlink" title="安装 REMI 源："></a>安装 REMI 源：</h4><p><strong>RHEL 7:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br></pre></td></tr></table></figure>

<p><strong>RHEL 6:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install http://rpms.remirepo.net/enterprise/remi-release-6.rpm</span><br></pre></td></tr></table></figure>

<p><strong>安装 Yum 源管理工具：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure>

<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><p><strong>安装 PHP7.3：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y <span class="variable">$phpversion</span>-php-fpm <span class="variable">$phpversion</span>-php-cli <span class="variable">$phpversion</span>-php-bcmath <span class="variable">$phpversion</span>-php-gd <span class="variable">$phpversion</span>-php-json <span class="variable">$phpversion</span>-php-mbstring <span class="variable">$phpversion</span>-php-mcrypt <span class="variable">$phpversion</span>-php-mysqlnd <span class="variable">$phpversion</span>-php-opcache <span class="variable">$phpversion</span>-php-pdo <span class="variable">$phpversion</span>-php-pecl-crypto <span class="variable">$phpversion</span>-php-pecl-mcrypt <span class="variable">$phpversion</span>-php-pecl-geoip <span class="variable">$phpversion</span>-php-recode <span class="variable">$phpversion</span>-php-snmp <span class="variable">$phpversion</span>-php-soap <span class="variable">$phpversion</span>-php-xmll</span><br></pre></td></tr></table></figure>

<h2 id="设置-PHP"><a href="#设置-PHP" class="headerlink" title="设置 PHP"></a>设置 PHP</h2><p>安装完成后，编辑 <code>/etc/php/7.3/fpm/php.ini</code> 替换换 <code>;cgi.fix_pathinfo=1</code> 为 <code>cgi.fix_pathinfo=0</code> 快捷命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/&#x27;</span> /etc/opt/remi/php73/php.ini</span><br></pre></td></tr></table></figure>

<h2 id="管理-PHP"><a href="#管理-PHP" class="headerlink" title="管理 PHP"></a>管理 PHP</h2><p>安装好了先重启一下！</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart php73-php-fpm</span><br></pre></td></tr></table></figure>

<p>设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> php73-php-fpm</span><br></pre></td></tr></table></figure>

<p><strong>更多操作：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart php73-php-fpm <span class="comment">#重启</span></span><br><span class="line">systemctl start php73-php-fpm <span class="comment">#启动</span></span><br><span class="line">systemctl stop php73-php-fpm <span class="comment">#关闭</span></span><br><span class="line">systemctl status php73-php-fpm <span class="comment">#检查状态</span></span><br></pre></td></tr></table></figure>

<h1 id="查看-PHP"><a href="#查看-PHP" class="headerlink" title="查看 PHP"></a>查看 PHP</h1><p>验证一下是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mf88.biz-service:~<span class="comment"># php73 -v</span></span><br><span class="line">PHP 7.3.0-1+(cli) (built: Dec  6 2018 20:24:55) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.3.0-dev, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.3.0-1+ubuntu18.04.1+deb.sury.org+1, Copyright (c) 1999-2018, by Zend Technologies</span><br></pre></td></tr></table></figure>

<h2 id="更新-PHP"><a href="#更新-PHP" class="headerlink" title="更新 PHP"></a>更新 PHP</h2><p>运行下面的命令系统就会更新所有可以更新的软件包括 PHP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure>

<h2 id="安装更多组件"><a href="#安装更多组件" class="headerlink" title="安装更多组件"></a>安装更多组件</h2><p>上面的一条命令安装 PHP 只是安装了部分 PHP 拓展，更多的软件可见：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@iZbp11tmwedluukz6y0d5gZ ~]<span class="comment"># yum search php73</span></span><br><span class="line">Updating Subscription Management repositories.</span><br><span class="line">Last metadata expiration check: 0:27:54 ago on Wed 15 May 2019 10:39:52 AM EDT.</span><br><span class="line">============================================================================================= Name Exactly Matched: php73 ==============================================================================================</span><br><span class="line">php73.x86_64 : Package that installs PHP 7.3</span><br><span class="line">php73.x86_64 : Package that installs PHP 7.3</span><br><span class="line">============================================================================================ Name &amp; Summary Matched: php73 =============================================================================================</span><br><span class="line">php73-syspaths.x86_64 : System-wide wrappers <span class="keyword">for</span> the php73 package</span><br><span class="line">php73-syspaths.x86_64 : System-wide wrappers <span class="keyword">for</span> the php73 package</span><br><span class="line">php73-scldevel.x86_64 : Package shipping development files <span class="keyword">for</span> php73</span><br><span class="line">php73-scldevel.x86_64 : Package shipping development files <span class="keyword">for</span> php73</span><br><span class="line">php73-php-zstd-devel.x86_64 : php73-php-zstd developer files (header)</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-runtime.x86_64 : Package that handles php73 Software Collection.</span><br><span class="line">php73-php-pecl-psr-devel.x86_64 : php73-php-pecl-psr developer files (header)</span><br><span class="line">php73-php-pecl-psr-devel.x86_64 : php73-php-pecl-psr developer files (header)</span><br><span class="line">php73-php-pecl-raphf-devel.x86_64 : php73-php-pecl-raphf developer files (header)</span><br><span class="line">php73-php-pecl-raphf-devel.x86_64 : php73-php-pecl-raphf developer files (header)</span><br><span class="line">php73-php-pecl-propro-devel.x86_64 : php73-php-pecl-propro developer files (header)</span><br><span class="line">php73-php-pecl-yaconf-devel.x86_64 : php73-php-pecl-yaconf developer files (header)</span><br><span class="line">php73-php-pecl-propro-devel.x86_64 : php73-php-pecl-propro developer files (header)</span><br><span class="line">php73-php-pecl-yaconf-devel.x86_64 : php73-php-pecl-yaconf developer files (header)</span><br><span class="line">php73-php-pecl-xmldiff-devel.x86_64 : php73-php-pecl-xmldiff developer files (header)</span><br><span class="line">php73-php-pecl-swoole4-devel.x86_64 : php73-php-pecl-swoole4 developer files (header)</span><br><span class="line">php73-php-pecl-xmldiff-devel.x86_64 : php73-php-pecl-xmldiff developer files (header)</span><br><span class="line">php73-php-zephir-parser-devel.x86_64 : php73-php-zephir-parser developer files (headers)</span><br><span class="line">php73-php-zephir-parser-devel.x86_64 : php73-php-zephir-parser developer files (headers)</span><br><span class="line">php73-php-pecl-handlebars-devel.x86_64 : php73-php-pecl-handlebars developer files (header)</span><br><span class="line">================================================================================================= Name Matched: php73 ==================================================================================================</span><br><span class="line">php73-php.x86_64 : PHP scripting language <span class="keyword">for</span> creating dynamic web sites</span><br><span class="line">php73-php.x86_64 : PHP scripting language <span class="keyword">for</span> creating dynamic web sites</span><br><span class="line">php73-build.x86_64 : Package shipping basic build configuration</span><br><span class="line">php73-build.x86_64 : Package shipping basic build configuration</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-zephir.noarch : Zephir language <span class="keyword">for</span> creation of extensions <span class="keyword">for</span> PHP.</span><br><span class="line">php73-php-gd.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the gd graphics library</span><br><span class="line">php73-zephir.noarch : Zephir language <span class="keyword">for</span> creation of extensions <span class="keyword">for</span> PHP.</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-ast.x86_64 : Abstract Syntax Tree</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-dba.x86_64 : A database abstraction layer module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-dbg.x86_64 : The interactive PHP debugger</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-gmp.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the GNU MP library</span><br><span class="line">php73-php-lz4.x86_64 : LZ4 Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-ast.x86_64 : Abstract Syntax Tree</span><br><span class="line">php73-php-cli.x86_64 : Command-line interface <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-dba.x86_64 : A database abstraction layer module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-dbg.x86_64 : The interactive PHP debugger</span><br><span class="line">php73-php-fpm.x86_64 : PHP FastCGI Process Manager</span><br><span class="line">php73-php-gmp.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the GNU MP library</span><br><span class="line">php73-php-lz4.x86_64 : LZ4 Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pdo.x86_64 : A database access abstraction module <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-xml.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use XML</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-geos.x86_64 : PHP module <span class="keyword">for</span> GEOS</span><br><span class="line">php73-php-imap.x86_64 : A module <span class="keyword">for</span> PHP applications that use IMAP</span><br><span class="line">php73-php-intl.x86_64 : Internationalization extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-ldap.x86_64 : A module <span class="keyword">for</span> PHP applications that use LDAP</span><br><span class="line">php73-php-oci8.x86_64 : A module <span class="keyword">for</span> PHP applications that use OCI8 databases</span><br><span class="line">php73-php-odbc.x86_64 : A module <span class="keyword">for</span> PHP applications that use ODBC databases</span><br><span class="line">php73-php-pear.noarch : PHP Extension and Application Repository framework</span><br><span class="line">php73-php-pggi.x86_64 : GTK bindings</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-tidy.x86_64 : Standard PHP module provides tidy library support</span><br><span class="line">php73-php-zstd.x86_64 : Zstd Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-geos.x86_64 : PHP module <span class="keyword">for</span> GEOS</span><br><span class="line">php73-php-imap.x86_64 : A module <span class="keyword">for</span> PHP applications that use IMAP</span><br><span class="line">php73-php-intl.x86_64 : Internationalization extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-json.x86_64 : JavaScript Object Notation extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-ldap.x86_64 : A module <span class="keyword">for</span> PHP applications that use LDAP</span><br><span class="line">php73-php-oci8.x86_64 : A module <span class="keyword">for</span> PHP applications that use OCI8 databases</span><br><span class="line">php73-php-odbc.x86_64 : A module <span class="keyword">for</span> PHP applications that use ODBC databases</span><br><span class="line">php73-php-pear.noarch : PHP Extension and Application Repository framework</span><br><span class="line">php73-php-pggi.x86_64 : GTK bindings</span><br><span class="line">php73-php-snmp.x86_64 : A module <span class="keyword">for</span> PHP applications that query SNMP-managed devices</span><br><span class="line">php73-php-soap.x86_64 : A module <span class="keyword">for</span> PHP applications that use the SOAP protocol</span><br><span class="line">php73-php-tidy.x86_64 : Standard PHP module provides tidy library support</span><br><span class="line">php73-php-twig.noarch : The flexible, fast, and secure template engine <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-zstd.x86_64 : Zstd Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-unit-php.x86_64 : PHP module <span class="keyword">for</span> NGINX Unit</span><br><span class="line">php73-php-devel.x86_64 : Files needed <span class="keyword">for</span> building PHP extensions</span><br><span class="line">php73-php-pgsql.x86_64 : A PostgreSQL database module <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pinba.x86_64 : Client extension <span class="keyword">for</span> Pinba statistics server</span><br><span class="line">php73-php-devel.x86_64 : Files needed <span class="keyword">for</span> building PHP extensions</span><br><span class="line">php73-php-pgsql.x86_64 : A PostgreSQL database module <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pinba.x86_64 : Client extension <span class="keyword">for</span> Pinba statistics server</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-brotli.x86_64 : Brotli Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pspell.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using pspell interfaces</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-snappy.x86_64 : Snappy Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-sodium.x86_64 : Wrapper <span class="keyword">for</span> the Sodium cryptographic library</span><br><span class="line">php73-php-sqlsrv.x86_64 : Microsoft Drivers <span class="keyword">for</span> PHP <span class="keyword">for</span> SQL Server</span><br><span class="line">php73-php-xmlrpc.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use the XML-RPC protocol</span><br><span class="line">php73-php-bcmath.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the bcmath library</span><br><span class="line">php73-php-brotli.x86_64 : Brotli Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-common.x86_64 : Common files <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pspell.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using pspell interfaces</span><br><span class="line">php73-php-recode.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="keyword">for</span> using the recode library</span><br><span class="line">php73-php-snappy.x86_64 : Snappy Extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-sodium.x86_64 : Wrapper <span class="keyword">for</span> the Sodium cryptographic library</span><br><span class="line">php73-php-sqlsrv.x86_64 : Microsoft Drivers <span class="keyword">for</span> PHP <span class="keyword">for</span> SQL Server</span><br><span class="line">php73-php-xmlrpc.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> use the XML-RPC protocol</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-enchant.x86_64 : Enchant spelling extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-libvirt.x86_64 : PHP language binding <span class="keyword">for</span> Libvirt</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-pecl-ds.x86_64 : Data Structures <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-pq.x86_64 : PostgreSQL client library (libpq) binding</span><br><span class="line">php73-php-pecl-uv.x86_64 : Libuv wrapper</span><br><span class="line">php73-php-process.x86_64 : Modules <span class="keyword">for</span> PHP script using system process interfaces</span><br><span class="line">php73-php-enchant.x86_64 : Enchant spelling extension <span class="keyword">for</span> PHP applications</span><br><span class="line">php73-php-libvirt.x86_64 : PHP language binding <span class="keyword">for</span> Libvirt</span><br><span class="line">php73-php-mysqlnd.x86_64 : A module <span class="keyword">for</span> PHP applications that use MySQL databases</span><br><span class="line">php73-php-opcache.x86_64 : The Zend OPcache</span><br><span class="line">php73-php-pecl-ds.x86_64 : Data Structures <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-pq.x86_64 : PostgreSQL client library (libpq) binding</span><br><span class="line">php73-php-pecl-uv.x86_64 : Libuv wrapper</span><br><span class="line">php73-php-process.x86_64 : Modules <span class="keyword">for</span> PHP script using system process interfaces</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-embedded.x86_64 : PHP library <span class="keyword">for</span> embedding <span class="keyword">in</span> applications</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-pecl-dio.x86_64 : Direct I/O <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-eio.x86_64 : Provides interface to the libeio library</span><br><span class="line">php73-php-pecl-env.x86_64 : Load environment variables</span><br><span class="line">php73-php-pecl-lua.x86_64 : Embedded lua interpreter</span><br><span class="line">php73-php-pecl-lzf.x86_64 : Extension to handle LZF de/compression</span><br><span class="line">php73-php-pecl-nsq.x86_64 : PHP extension <span class="keyword">for</span> NSQ client</span><br><span class="line">php73-php-pecl-psr.x86_64 : PSR interfaces</span><br><span class="line">php73-php-pecl-rar.x86_64 : PHP extension <span class="keyword">for</span> reading RAR archives</span><br><span class="line">php73-php-pecl-rrd.x86_64 : PHP Bindings <span class="keyword">for</span> rrdtool</span><br><span class="line">php73-php-pecl-vld.x86_64 : Dump the internal representation of PHP scripts</span><br><span class="line">php73-php-pecl-yac.x86_64 : Lockless user data cache</span><br><span class="line">php73-php-pecl-yaf.x86_64 : Yet Another Framework</span><br><span class="line">php73-php-pecl-yar.x86_64 : Light, concurrent RPC framework</span><br><span class="line">php73-php-pecl-yaz.x86_64 : Z39.50/SRU client</span><br><span class="line">php73-php-pecl-zip.x86_64 : Une extension de gestion des ZIP</span><br><span class="line">php73-php-pecl-zmq.x86_64 : ZeroMQ messaging</span><br><span class="line">php73-php-phalcon3.x86_64 : Phalcon Framework</span><br><span class="line">php73-php-embedded.x86_64 : PHP library <span class="keyword">for</span> embedding <span class="keyword">in</span> applications</span><br><span class="line">php73-php-mbstring.x86_64 : A module <span class="keyword">for</span> PHP applications <span class="built_in">which</span> need multi-byte string handling</span><br><span class="line">php73-php-pecl-dio.x86_64 : Direct I/O <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-eio.x86_64 : Provides interface to the libeio library</span><br><span class="line">php73-php-pecl-env.x86_64 : Load environment variables</span><br><span class="line">php73-php-pecl-lua.x86_64 : Embedded lua interpreter</span><br><span class="line">php73-php-pecl-lzf.x86_64 : Extension to handle LZF de/compression</span><br><span class="line">php73-php-pecl-nsq.x86_64 : PHP extension <span class="keyword">for</span> NSQ client</span><br><span class="line">php73-php-pecl-psr.x86_64 : PSR interfaces</span><br><span class="line">php73-php-pecl-rar.x86_64 : PHP extension <span class="keyword">for</span> reading RAR archives</span><br><span class="line">php73-php-pecl-rrd.x86_64 : PHP Bindings <span class="keyword">for</span> rrdtool</span><br><span class="line">php73-php-pecl-vld.x86_64 : Dump the internal representation of PHP scripts</span><br><span class="line">php73-php-pecl-yac.x86_64 : Lockless user data cache</span><br><span class="line">php73-php-pecl-yaf.x86_64 : Yet Another Framework</span><br><span class="line">php73-php-pecl-yar.x86_64 : Light, concurrent RPC framework</span><br><span class="line">php73-php-pecl-yaz.x86_64 : Z39.50/SRU client</span><br><span class="line">php73-php-pecl-zip.x86_64 : Une extension de gestion des ZIP</span><br><span class="line">php73-php-pecl-zmq.x86_64 : ZeroMQ messaging</span><br><span class="line">php73-php-phalcon3.x86_64 : Phalcon Framework</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-componere.x86_64 : Composing PHP classes at runtime</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-maxminddb.x86_64 : MaxMind DB Reader extension</span><br><span class="line">php73-php-pdo-dblib.x86_64 : PDO driver Microsoft SQL Server and Sybase databases</span><br><span class="line">php73-php-pecl-amqp.x86_64 : Communicate with any AMQP compliant server</span><br><span class="line">php73-php-pecl-apcu.x86_64 : APC User Cache</span><br><span class="line">php73-php-pecl-apfd.x86_64 : Always Populate Form Data</span><br><span class="line">php73-php-pecl-fann.x86_64 : Wrapper <span class="keyword">for</span> FANN Library</span><br><span class="line">php73-php-pecl-grpc.x86_64 : General RPC framework</span><br><span class="line">php73-php-pecl-http.x86_64 : Extended HTTP support</span><br><span class="line">php73-php-pecl-krb5.x86_64 : Kerberos authentification extension</span><br><span class="line">php73-php-pecl-pcov.x86_64 : Code coverage driver</span><br><span class="line">php73-php-pecl-ssh2.x86_64 : Bindings <span class="keyword">for</span> the libssh2 library</span><br><span class="line">php73-php-pecl-sync.x86_64 : Named and unnamed synchronization objects</span><br><span class="line">php73-php-pecl-uopz.x86_64 : User Operations <span class="keyword">for</span> Zend</span><br><span class="line">php73-php-pecl-uuid.x86_64 : Universally Unique Identifier extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-vips.x86_64 : PHP extension <span class="keyword">for</span> interfacing with libvips</span><br><span class="line">php73-php-pecl-yaml.x86_64 : PHP Bindings <span class="keyword">for</span> yaml</span><br><span class="line">php73-php-phpiredis.x86_64 : Client extension <span class="keyword">for</span> Redis</span><br><span class="line">php73-php-smbclient.x86_64 : PHP wrapper <span class="keyword">for</span> libsmbclient</span><br><span class="line">php73-php-wkhtmltox.x86_64 : HTML Converter</span><br><span class="line">php73-php-componere.x86_64 : Composing PHP classes at runtime</span><br><span class="line">php73-php-litespeed.x86_64 : LiteSpeed Web Server PHP support</span><br><span class="line">php73-php-maxminddb.x86_64 : MaxMind DB Reader extension</span><br><span class="line">php73-php-pdo-dblib.x86_64 : PDO driver Microsoft SQL Server and Sybase databases</span><br><span class="line">php73-php-pecl-amqp.x86_64 : Communicate with any AMQP compliant server</span><br><span class="line">php73-php-pecl-apcu.x86_64 : APC User Cache</span><br><span class="line">php73-php-pecl-apfd.x86_64 : Always Populate Form Data</span><br><span class="line">php73-php-pecl-fann.x86_64 : Wrapper <span class="keyword">for</span> FANN Library</span><br><span class="line">php73-php-pecl-grpc.x86_64 : General RPC framework</span><br><span class="line">php73-php-pecl-http.x86_64 : Extended HTTP support</span><br><span class="line">php73-php-pecl-krb5.x86_64 : Kerberos authentification extension</span><br><span class="line">php73-php-pecl-pcov.x86_64 : Code coverage driver</span><br><span class="line">php73-php-pecl-ssh2.x86_64 : Bindings <span class="keyword">for</span> the libssh2 library</span><br><span class="line">php73-php-pecl-sync.x86_64 : Named and unnamed synchronization objects</span><br><span class="line">php73-php-pecl-uopz.x86_64 : User Operations <span class="keyword">for</span> Zend</span><br><span class="line">php73-php-pecl-uuid.x86_64 : Universally Unique Identifier extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-vips.x86_64 : PHP extension <span class="keyword">for</span> interfacing with libvips</span><br><span class="line">php73-php-pecl-yaml.x86_64 : PHP Bindings <span class="keyword">for</span> yaml</span><br><span class="line">php73-php-phpiredis.x86_64 : Client extension <span class="keyword">for</span> Redis</span><br><span class="line">php73-php-smbclient.x86_64 : PHP wrapper <span class="keyword">for</span> libsmbclient</span><br><span class="line">php73-php-wkhtmltox.x86_64 : HTML Converter</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-cmark.x86_64 : CommonMark extension</span><br><span class="line">php73-php-pecl-dbase.x86_64 : dBase database file access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-druid.x86_64 : A Druid driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-event.x86_64 : Provides interface to libevent library</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-gnupg.x86_64 : Wrapper around the gpgme library</span><br><span class="line">php73-php-pecl-mysql.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-oauth.x86_64 : PHP OAuth consumer extension</span><br><span class="line">php73-php-pecl-parle.x86_64 : Parsing and lexing</span><br><span class="line">php73-php-pecl-raphf.x86_64 : Resource and persistent handles factory</span><br><span class="line">php73-php-pecl-solr2.x86_64 : API orientée objet pour Apache Solr</span><br><span class="line">php73-php-pecl-stats.x86_64 : Routines <span class="keyword">for</span> statistical computation</span><br><span class="line">php73-php-pecl-stomp.x86_64 : Stomp client extension</span><br><span class="line">php73-php-pecl-taint.x86_64 : XSS code sniffer</span><br><span class="line">php73-php-pecl-trace.x86_64 : Trace is a low-overhead tracing tool <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xattr.x86_64 : Extended attributes</span><br><span class="line">php73-php-pecl-xdiff.x86_64 : File differences/patches</span><br><span class="line">php73-php-pecl-xxtea.x86_64 : XXTEA encryption algorithm extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-cmark.x86_64 : CommonMark extension</span><br><span class="line">php73-php-pecl-dbase.x86_64 : dBase database file access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-druid.x86_64 : A Druid driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-event.x86_64 : Provides interface to libevent library</span><br><span class="line">php73-php-pecl-geoip.x86_64 : Extension to map IP addresses to geographic places</span><br><span class="line">php73-php-pecl-gnupg.x86_64 : Wrapper around the gpgme library</span><br><span class="line">php73-php-pecl-mysql.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-oauth.x86_64 : PHP OAuth consumer extension</span><br><span class="line">php73-php-pecl-parle.x86_64 : Parsing and lexing</span><br><span class="line">php73-php-pecl-raphf.x86_64 : Resource and persistent handles factory</span><br><span class="line">php73-php-pecl-solr2.x86_64 : API orientée objet pour Apache Solr</span><br><span class="line">php73-php-pecl-stats.x86_64 : Routines <span class="keyword">for</span> statistical computation</span><br><span class="line">php73-php-pecl-stomp.x86_64 : Stomp client extension</span><br><span class="line">php73-php-pecl-taint.x86_64 : XSS code sniffer</span><br><span class="line">php73-php-pecl-trace.x86_64 : Trace is a low-overhead tracing tool <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xattr.x86_64 : Extended attributes</span><br><span class="line">php73-php-pecl-xdiff.x86_64 : File differences/patches</span><br><span class="line">php73-php-pecl-xxtea.x86_64 : XXTEA encryption algorithm extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-libvirt-doc.noarch : Document of php-libvirt</span><br><span class="line">php73-php-pecl-base58.x86_64 : Encode and decode data with base58</span><br><span class="line">php73-php-pecl-bitset.x86_64 : BITSET library</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-gender.x86_64 : Gender Extension</span><br><span class="line">php73-php-pecl-hprose.x86_64 : Hprose <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hrtime.x86_64 : High resolution timing</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-pecl-molten.x86_64 : Extension <span class="keyword">for</span> application tracing</span><br><span class="line">php73-php-pecl-pdflib.x86_64 : Package <span class="keyword">for</span> generating PDF files</span><br><span class="line">php73-php-pecl-propro.x86_64 : Property proxy</span><br><span class="line">php73-php-pecl-radius.x86_64 : Radius client library</span><br><span class="line">php73-php-pecl-redis4.x86_64 : Extension <span class="keyword">for</span> communicating with the Redis key-value store</span><br><span class="line">php73-php-pecl-scrypt.x86_64 : Scrypt hashing <span class="keyword">function</span></span><br><span class="line">php73-php-pecl-sphinx.x86_64 : PECL extension <span class="keyword">for</span> Sphinx SQL full-text search engine</span><br><span class="line">php73-php-pecl-ssdeep.x86_64 : Wrapper <span class="keyword">for</span> libfuzzy library</span><br><span class="line">php73-php-pecl-trader.x86_64 : Technical Analysis <span class="keyword">for</span> traders</span><br><span class="line">php73-php-pecl-xdebug.x86_64 : PECL package <span class="keyword">for</span> debugging PHP scripts</span><br><span class="line">php73-php-pecl-yaconf.x86_64 : Yet Another Configurations Container</span><br><span class="line">php73-php-libvirt-doc.noarch : Document of php-libvirt</span><br><span class="line">php73-php-pecl-base58.x86_64 : Encode and decode data with base58</span><br><span class="line">php73-php-pecl-bitset.x86_64 : BITSET library</span><br><span class="line">php73-php-pecl-crypto.x86_64 : Wrapper <span class="keyword">for</span> OpenSSL Crypto Library</span><br><span class="line">php73-php-pecl-gender.x86_64 : Gender Extension</span><br><span class="line">php73-php-pecl-hprose.x86_64 : Hprose <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hrtime.x86_64 : High resolution timing</span><br><span class="line">php73-php-pecl-mcrypt.x86_64 : Bindings <span class="keyword">for</span> the libmcrypt library</span><br><span class="line">php73-php-pecl-molten.x86_64 : Extension <span class="keyword">for</span> application tracing</span><br><span class="line">php73-php-pecl-pdflib.x86_64 : Package <span class="keyword">for</span> generating PDF files</span><br><span class="line">php73-php-pecl-propro.x86_64 : Property proxy</span><br><span class="line">php73-php-pecl-radius.x86_64 : Radius client library</span><br><span class="line">php73-php-pecl-redis4.x86_64 : Extension <span class="keyword">for</span> communicating with the Redis key-value store</span><br><span class="line">php73-php-pecl-scrypt.x86_64 : Scrypt hashing <span class="keyword">function</span></span><br><span class="line">php73-php-pecl-sphinx.x86_64 : PECL extension <span class="keyword">for</span> Sphinx SQL full-text search engine</span><br><span class="line">php73-php-pecl-ssdeep.x86_64 : Wrapper <span class="keyword">for</span> libfuzzy library</span><br><span class="line">php73-php-pecl-trader.x86_64 : Technical Analysis <span class="keyword">for</span> traders</span><br><span class="line">php73-php-pecl-xdebug.x86_64 : PECL package <span class="keyword">for</span> debugging PHP scripts</span><br><span class="line">php73-php-pecl-yaconf.x86_64 : Yet Another Configurations Container</span><br><span class="line">php73-php-pecl-apcu-bc.x86_64 : APCu Backwards Compatibility Module</span><br><span class="line">php73-php-pecl-decimal.x86_64 : Arbitrary-precision floating-point decimal</span><br><span class="line">php73-php-pecl-gearman.x86_64 : PHP wrapper to libgearman</span><br><span class="line">php73-php-pecl-gmagick.x86_64 : Provides a wrapper to the GraphicsMagick library</span><br><span class="line">php73-php-pecl-imagick.x86_64 : Extension to create and modify images using ImageMagick</span><br><span class="line">php73-php-pecl-inotify.x86_64 : Inotify</span><br><span class="line">php73-php-pecl-leveldb.x86_64 : LevelDB PHP bindings</span><br><span class="line">php73-php-pecl-memprof.x86_64 : Memory usage profiler</span><br><span class="line">php73-php-pecl-mongodb.x86_64 : MongoDB driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-msgpack.x86_64 : API <span class="keyword">for</span> communicating with MessagePack serialization</span><br><span class="line">php73-php-pecl-rdkafka.x86_64 : Kafka client based on librdkafka</span><br><span class="line">php73-php-pecl-request.x86_64 : Server-side request and response objects</span><br><span class="line">php73-php-pecl-rpminfo.x86_64 : RPM information</span><br><span class="line">php73-php-pecl-runkit7.x86_64 : For all those things you... shouldn<span class="string">&#x27;t have been doing anyway... but surely do!</span></span><br><span class="line"><span class="string">php73-php-pecl-seaslog.x86_64 : An effective, fast, stable log extension for PHP</span></span><br><span class="line"><span class="string">php73-php-pecl-selinux.x86_64 : SELinux binding for PHP scripting language</span></span><br><span class="line"><span class="string">php73-php-pecl-swoole4.x86_64 : PHP&#x27;</span>s asynchronous concurrent distributed networking framework</span><br><span class="line">php73-php-pecl-timecop.x86_64 : Time travel and freezing extension</span><br><span class="line">php73-php-pecl-varnish.x86_64 : Varnish Cache bindings</span><br><span class="line">php73-php-pecl-xmldiff.x86_64 : XML diff and merge</span><br><span class="line">php73-php-pecl-apcu-bc.x86_64 : APCu Backwards Compatibility Module</span><br><span class="line">php73-php-pecl-decimal.x86_64 : Arbitrary-precision floating-point decimal</span><br><span class="line">php73-php-pecl-gearman.x86_64 : PHP wrapper to libgearman</span><br><span class="line">php73-php-pecl-gmagick.x86_64 : Provides a wrapper to the GraphicsMagick library</span><br><span class="line">php73-php-pecl-imagick.x86_64 : Extension to create and modify images using ImageMagick</span><br><span class="line">php73-php-pecl-inotify.x86_64 : Inotify</span><br><span class="line">php73-php-pecl-leveldb.x86_64 : LevelDB PHP bindings</span><br><span class="line">php73-php-pecl-memprof.x86_64 : Memory usage profiler</span><br><span class="line">php73-php-pecl-mongodb.x86_64 : MongoDB driver <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-msgpack.x86_64 : API <span class="keyword">for</span> communicating with MessagePack serialization</span><br><span class="line">php73-php-pecl-rdkafka.x86_64 : Kafka client based on librdkafka</span><br><span class="line">php73-php-pecl-request.x86_64 : Server-side request and response objects</span><br><span class="line">php73-php-pecl-rpminfo.x86_64 : RPM information</span><br><span class="line">php73-php-pecl-runkit7.x86_64 : For all those things you... shouldn<span class="string">&#x27;t have been doing anyway... but surely do!</span></span><br><span class="line"><span class="string">php73-php-pecl-seaslog.x86_64 : An effective, fast, stable log extension for PHP</span></span><br><span class="line"><span class="string">php73-php-pecl-selinux.x86_64 : SELinux binding for PHP scripting language</span></span><br><span class="line"><span class="string">php73-php-pecl-swoole4.x86_64 : PHP&#x27;</span>s asynchronous concurrent distributed networking framework</span><br><span class="line">php73-php-pecl-timecop.x86_64 : Time travel and freezing extension</span><br><span class="line">php73-php-pecl-varnish.x86_64 : Varnish Cache bindings</span><br><span class="line">php73-php-pecl-xmldiff.x86_64 : XML diff and merge</span><br><span class="line">php73-php-pecl-igbinary.x86_64 : Replacement <span class="keyword">for</span> the standard PHP serializer</span><br><span class="line">php73-php-pecl-memcache.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mogilefs.x86_64 : PHP client library to communicate with the MogileFS storage</span><br><span class="line">php73-php-pecl-mustache.x86_64 : Mustache templating language</span><br><span class="line">php73-php-pecl-protobuf.x86_64 : Mechanism <span class="keyword">for</span> serializing structured data</span><br><span class="line">php73-php-snuffleupagus.x86_64 : Security module <span class="keyword">for</span> php7</span><br><span class="line">php73-php-zephir-parser.x86_64 : Zephir parser extension</span><br><span class="line">php73-php-channel-horde.noarch : Adds pear.horde.org channel to PEAR</span><br><span class="line">php73-php-pecl-igbinary.x86_64 : Replacement <span class="keyword">for</span> the standard PHP serializer</span><br><span class="line">php73-php-pecl-memcache.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mogilefs.x86_64 : PHP client library to communicate with the MogileFS storage</span><br><span class="line">php73-php-pecl-mustache.x86_64 : Mustache templating language</span><br><span class="line">php73-php-pecl-protobuf.x86_64 : Mechanism <span class="keyword">for</span> serializing structured data</span><br><span class="line">php73-php-pecl-translit.x86_64 : Transliterates non-latin character sets to latin</span><br><span class="line">php73-php-snuffleupagus.x86_64 : Security module <span class="keyword">for</span> php7</span><br><span class="line">php73-php-zephir-parser.x86_64 : Zephir parser extension</span><br><span class="line">php73-php-ioncube-loader.x86_64 : Loader <span class="keyword">for</span> ionCube Encoded Files with ionCube 24 support</span><br><span class="line">php73-php-pecl-cassandra.x86_64 : DataStax PHP Driver <span class="keyword">for</span> Apache Cassandra</span><br><span class="line">php73-php-pecl-json-post.x86_64 : JSON POST handler</span><br><span class="line">php73-php-pecl-mailparse.x86_64 : PHP PECL package <span class="keyword">for</span> parsing and working with email messages</span><br><span class="line">php73-php-pecl-memcached.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mosquitto.x86_64 : Extension <span class="keyword">for</span> libmosquitto</span><br><span class="line">php73-php-pecl-seasclick.x86_64 : An Yandex ClickHouse client driven extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xlswriter.x86_64 : An efficient and fast xlsx file <span class="built_in">export</span> extension</span><br><span class="line">php73-php-ioncube-loader.x86_64 : Loader <span class="keyword">for</span> ionCube Encoded Files with ionCube 24 support</span><br><span class="line">php73-php-pecl-cassandra.x86_64 : DataStax PHP Driver <span class="keyword">for</span> Apache Cassandra</span><br><span class="line">php73-php-pecl-json-post.x86_64 : JSON POST handler</span><br><span class="line">php73-php-pecl-mailparse.x86_64 : PHP PECL package <span class="keyword">for</span> parsing and working with email messages</span><br><span class="line">php73-php-pecl-memcached.x86_64 : Extension to work with the Memcached caching daemon</span><br><span class="line">php73-php-pecl-mosquitto.x86_64 : Extension <span class="keyword">for</span> libmosquitto</span><br><span class="line">php73-php-pecl-seasclick.x86_64 : An Yandex ClickHouse client driven extension <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-xlswriter.x86_64 : An efficient and fast xlsx file <span class="built_in">export</span> extension</span><br><span class="line">php73-php-horde-horde-lz4.x86_64 : Horde LZ4 Compression Extension</span><br><span class="line">php73-php-pecl-apcu-devel.x86_64 : APCu developer files (header)</span><br><span class="line">php73-php-pecl-couchbase2.x86_64 : Couchbase Server PHP extension</span><br><span class="line">php73-php-pecl-geospatial.x86_64 : PHP Extension to handle common geospatial <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-handlebars.x86_64 : Handlebars templating language</span><br><span class="line">php73-php-pecl-http-devel.x86_64 : Extended HTTP support developer files (header)</span><br><span class="line">php73-php-pecl-krb5-devel.x86_64 : Kerberos extension developer files (header)</span><br><span class="line">php73-php-pecl-luasandbox.x86_64 : Lua interpreter with limits and safe environment</span><br><span class="line">php73-php-pecl-opencensus.x86_64 : A stats collection and distributed tracing framework</span><br><span class="line">php73-php-horde-horde-lz4.x86_64 : Horde LZ4 Compression Extension</span><br><span class="line">php73-php-pecl-apcu-devel.x86_64 : APCu developer files (header)</span><br><span class="line">php73-php-pecl-couchbase2.x86_64 : Couchbase Server PHP extension</span><br><span class="line">php73-php-pecl-geospatial.x86_64 : PHP Extension to handle common geospatial <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-handlebars.x86_64 : Handlebars templating language</span><br><span class="line">php73-php-pecl-http-devel.x86_64 : Extended HTTP support developer files (header)</span><br><span class="line">php73-php-pecl-krb5-devel.x86_64 : Kerberos extension developer files (header)</span><br><span class="line">php73-php-pecl-luasandbox.x86_64 : Lua interpreter with limits and safe environment</span><br><span class="line">php73-php-pecl-opencensus.x86_64 : A stats collection and distributed tracing framework</span><br><span class="line">php73-php-pecl-ahocorasick.x86_64 : Effective Aho-Corasick string pattern matching algorithm</span><br><span class="line">php73-php-pecl-ip2location.x86_64 : Get geo location information of an IP address</span><br><span class="line">php73-php-pecl-ahocorasick.x86_64 : Effective Aho-Corasick string pattern matching algorithm</span><br><span class="line">php73-php-pecl-ip2location.x86_64 : Get geo location information of an IP address</span><br><span class="line">php73-php-pecl-datadog-trace.x86_64 : APM and distributed tracing <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hdr-histogram.x86_64 : PHP extension wrapper <span class="keyword">for</span> the C hdrhistogram API</span><br><span class="line">php73-php-pecl-imagick-devel.x86_64 : imagick extension developer files (header)</span><br><span class="line">php73-php-pecl-msgpack-devel.x86_64 : MessagePack developer files (header)</span><br><span class="line">php73-php-pecl-mysql-xdevapi.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-datadog-trace.x86_64 : APM and distributed tracing <span class="keyword">for</span> PHP</span><br><span class="line">php73-php-pecl-hdr-histogram.x86_64 : PHP extension wrapper <span class="keyword">for</span> the C hdrhistogram API</span><br><span class="line">php73-php-pecl-imagick-devel.x86_64 : imagick extension developer files (header)</span><br><span class="line">php73-php-pecl-msgpack-devel.x86_64 : MessagePack developer files (header)</span><br><span class="line">php73-php-pecl-mysql-xdevapi.x86_64 : MySQL database access <span class="built_in">functions</span></span><br><span class="line">php73-php-pecl-igbinary-devel.x86_64 : Igbinary developer files (header)</span><br><span class="line">php73-php-pecl-uploadprogress.x86_64 : An extension to track progress of a file upload</span><br><span class="line">php73-php-pecl-igbinary-devel.x86_64 : Igbinary developer files (header)</span><br><span class="line">php73-php-pecl-uploadprogress.x86_64 : An extension to track progress of a file upload</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(四)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/</url>
    <content><![CDATA[<p><strong>Jenkins应用</strong></p>
<p>Jenkins Linux Shell集成</p>
<p>登录Jenkins web管理页，点击新建任务</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151723046-524146976-20201127095232069.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151824593-1161146941-20201127095231859.png" class title="img">



<p>添加构建执行shell</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109151858012-1214119596-20201127095231676.png" class title="img">

<p>在执行shell输入框内输入</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">user</span>=`whoami`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$user</span> == <span class="string">&#x27;deploy&#x27;</span> ]</span><br><span class="line">then</span><br><span class="line">    echo <span class="string">&quot;Hello, my name is <span class="variable">$user</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    echo <span class="string">&quot;Sorry, I am not <span class="variable">$user</span>&quot;</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ip addr</span><br><span class="line"></span><br><span class="line">cat /etc/system-release</span><br><span class="line"></span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line"><span class="attribute">py_cmd</span>=`which python`</span><br><span class="line"></span><br><span class="line"><span class="variable">$py_cmd</span> --version</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109152040887-2048586029-20201127095232008.png" class title="img">

<p> 点击查看输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace /var/lib/jenkins/workspace/shell-freestyle-job</span><br><span class="line"><span class="string">[shell-freestyle-job]</span> $ /bin/sh /tmp/jenkins3318863497197478868.sh</span><br><span class="line">Hello, my name <span class="keyword">is</span> deploy</span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">23</span>:<span class="number">04</span>:a4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.244</span><span class="number">.131</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.244</span><span class="number">.255</span> scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">6</span>c1f:<span class="number">4</span>afc:<span class="number">8</span>c42:<span class="number">2</span>ef7/<span class="number">64</span> scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">23</span>:<span class="number">04</span>:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="number">4</span>: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="number">1500</span> qdisc noqueue state DOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">00</span>:d5:<span class="number">9</span>c:dd brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.122</span><span class="number">.1</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.122</span><span class="number">.255</span> scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="number">1500</span> qdisc pfifo_fast master virbr0 state DOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">00</span>:d5:<span class="number">9</span>c:dd brd ff:ff:ff:ff:ff:ff</span><br><span class="line">CentOS Linux release <span class="number">7.5</span><span class="number">.1804</span> (Core) </span><br><span class="line">              total        used        free      <span class="keyword">shared</span>  buff/cache   available</span><br><span class="line">Mem:           <span class="number">1982</span>        <span class="number">1032</span>         <span class="number">377</span>          <span class="number">10</span>         <span class="number">571</span>         <span class="number">707</span></span><br><span class="line">Swap:          <span class="number">2047</span>           <span class="number">0</span>        <span class="number">2047</span></span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root   <span class="number">18</span>G  <span class="number">4.6</span>G   <span class="number">13</span>G  <span class="number">26</span>% /</span><br><span class="line">devtmpfs                 <span class="number">975</span>M     <span class="number">0</span>  <span class="number">975</span>M   <span class="number">0</span>% /dev</span><br><span class="line">tmpfs                    <span class="number">992</span>M     <span class="number">0</span>  <span class="number">992</span>M   <span class="number">0</span>% /dev/shm</span><br><span class="line">tmpfs                    <span class="number">992</span>M   <span class="number">11</span>M  <span class="number">982</span>M   <span class="number">2</span>% /run</span><br><span class="line">tmpfs                    <span class="number">992</span>M     <span class="number">0</span>  <span class="number">992</span>M   <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">/dev/sr0                 <span class="number">8.8</span>G  <span class="number">8.8</span>G     <span class="number">0</span> <span class="number">100</span>% /media/cdrom</span><br><span class="line">/dev/sda1                <span class="number">497</span>M  <span class="number">150</span>M  <span class="number">347</span>M  <span class="number">31</span>% /boot</span><br><span class="line">tmpfs                    <span class="number">199</span>M   <span class="number">12</span>K  <span class="number">199</span>M   <span class="number">1</span>% /run/user/<span class="number">42</span></span><br><span class="line">tmpfs                    <span class="number">199</span>M     <span class="number">0</span>  <span class="number">199</span>M   <span class="number">0</span>% /run/user/<span class="number">0</span></span><br><span class="line">Python <span class="number">2.7</span><span class="number">.5</span></span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins 参数集成</p>
<p>仍然登录到Jenkins web管理页，点击新建任务。</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109153842155-2075650169-20201127095231946.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109154042627-129308152-20201127095231940.png" class title="img">



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Current deploy environment is <span class="variable">$deploy_env</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The build is <span class="variable">$version</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The paasword is <span class="variable">$pass</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$bool</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Request is approved&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Request is rejected&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>点击“Build with Parameters”后如下图所示</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109155131087-890865953-20201127095232222.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109155404456-420065666-20201127095232301.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building in workspace /var/<span class="class"><span class="keyword">lib</span>/<span class="title">jenkins</span>/<span class="title">workspace</span>/<span class="title">parameter</span>-<span class="title">freestyle</span>-<span class="title">job</span></span></span><br><span class="line">[parameter-freestyle-job] $ /bin/sh /tmp/jenkins459467524349987986.sh</span><br><span class="line">Current deploy environment is dev</span><br><span class="line">The build is <span class="number">1.0</span>.<span class="number">1</span></span><br><span class="line">The paasword is <span class="number">123456</span></span><br><span class="line">Request is approved</span><br><span class="line"><span class="symbol">Finished:</span> SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins Git集成</p>
<p>首先还是登录Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109163623111-1109999465-20201127095232289.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109163915438-500405355-20201127095232386.png" class title="img">

<p>返回到gitlab新建一个ansible-playbook.repo工程（新建过程略），只有一个ansible-playbook.txt空文件</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164541615-708856621-20201127095232478.png" class title="img">

<p>复制ansible-playbook.repo仓库地址，粘贴至下图</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164637907-1104298296-20201127095232461.png" class title="img">

<p>点击“立即构建”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109164720097-767872863-20201127095232519.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/git-freestyle-job</span><br><span class="line">Cloning the remote Git repository</span><br><span class="line">Cloning repository https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git</span><br><span class="line"> &gt; git init <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/git-freestyle-job <span class="comment"># timeout=10</span></span><br><span class="line">Fetching upstream changes from https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git</span><br><span class="line"> &gt; git --version <span class="comment"># timeout=10</span></span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/*</span><br><span class="line"> &gt; git config remote.origin.url https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git config --add remote.origin.fetch +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/* <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git config remote.origin.url https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git <span class="comment"># timeout=10</span></span><br><span class="line">Fetching upstream changes from https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>ansible-playbook-repo.git +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/*</span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin<span class="regexp">/origin/m</span>aster^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line">Checking out Revision eb4736cb66dd954b1f45b1d38f789c84aaedb078 (refs<span class="regexp">/remotes/</span>origin/master)</span><br><span class="line"> &gt; git config core.sparsecheckout <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git checkout -f eb4736cb66dd954b1f45b1d38f789c84aaedb078</span><br><span class="line">Commit message: <span class="string">&quot;First comm&quot;</span></span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p>Jenkins maven集成</p>
<p>打开maven官网：<a href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p>
<p>复制最新maven的软件包链接</p>
<p><a href="http://mirrors.shu.edu.cn/apache/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz">http://mirrors.shu.edu.cn/apache/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz</a></p>
<p>安装maven</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@jenkins ~]</span># wget http:<span class="comment">//mirrors.shu.edu.cn/apache/maven/maven-3/3.6.0/binaries/apache-maven-3.6.0-bin.tar.gz</span></span><br><span class="line"><span class="string">[root@jenkins ~]</span># tar -xf apache-maven<span class="number">-3.6</span><span class="number">.0</span>-bin.tar.gz -C /opt/</span><br><span class="line"><span class="string">[root@jenkins ~]</span># ls /opt/</span><br><span class="line">apache-maven<span class="number">-3.6</span><span class="number">.0</span>  rh</span><br><span class="line"><span class="string">[root@jenkins ~]</span># cd /opt/apache-maven<span class="number">-3.6</span><span class="number">.0</span>/bin/</span><br><span class="line"><span class="string">[root@jenkins bin]</span># ./mvn --version</span><br><span class="line">Apache Maven <span class="number">3.6</span><span class="number">.0</span> (<span class="number">97</span>c98ec64a1fdfee7767ce5ffb20918da4f719f3; <span class="number">2018</span><span class="number">-10</span><span class="number">-25</span>T02:<span class="number">41</span>:<span class="number">47</span>+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Maven home: /opt/apache-maven<span class="number">-3.6</span><span class="number">.0</span></span><br><span class="line">Java version: <span class="number">1.8</span><span class="number">.0</span>_191, vendor: Oracle Corporation, runtime: /usr/lib/jvm/java<span class="number">-1.8</span><span class="number">.0</span>-openjdk<span class="number">-1.8</span><span class="number">.0</span><span class="number">.191</span>.b12<span class="number">-1.</span>el7_6.x86_64/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF<span class="number">-8</span></span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;3.10.0-862.el7.x86_64&quot;</span>, arch: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure>

<p>回到Jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109165658126-635979322-20201127095232612.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109165741713-178101175-20201127095232561.png" class title="img">

<p>回到gitlab主页</p>
<p> 新建一个空的Java-war-dev工程，复制其仓库地址；</p>
<p>然后切到windows git bash命令行，上传本地代码到刚才新建的Java-war-dev仓库中：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ pwd</span><br><span class="line"><span class="regexp">/c/</span>Users<span class="regexp">/xueji/</span>Desktop/repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ ls</span><br><span class="line">Java-war-dev/</span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ git config --global user.name <span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ git config --global user.email <span class="string">&quot;root@example.com&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ git init</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> C:<span class="regexp">/Users/</span>xueji<span class="regexp">/Desktop/</span>repo<span class="regexp">/.git/</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo (master)</span><br><span class="line">$ git remote add origin https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF <span class="keyword">in</span> Java-war-dev/pom.xml.</span><br><span class="line">The file will have its original line endings <span class="keyword">in</span> your working directory</span><br><span class="line">warning: LF will be replaced by CRLF <span class="keyword">in</span> Java-war-dev<span class="regexp">/src/m</span>ain<span class="regexp">/webapp/</span>WEB-INF/web.xml.</span><br><span class="line">The file will have its original line endings <span class="keyword">in</span> your working directory</span><br><span class="line">warning: LF will be replaced by CRLF <span class="keyword">in</span> Java-war-dev<span class="regexp">/src/m</span>ain<span class="regexp">/webapp/i</span>ndex.jsp.</span><br><span class="line">The file will have its original line endings <span class="keyword">in</span> your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;first commit&quot;</span></span><br><span class="line">[master (root-commit) aa3c70c] first commit</span><br><span class="line"> <span class="number">7</span> files changed, <span class="number">58</span> insertions(+)</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev/.DS_Store</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev/pom.xml</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev<span class="regexp">/src/</span>.DS_Store</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev<span class="regexp">/src/m</span>ain/.DS_Store</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev<span class="regexp">/src/m</span>ain<span class="regexp">/webapp/</span>.DS_Store</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev<span class="regexp">/src/m</span>ain<span class="regexp">/webapp/</span>WEB-INF/web.xml</span><br><span class="line"> create mode <span class="number">100644</span> Java-war-dev<span class="regexp">/src/m</span>ain<span class="regexp">/webapp/i</span>ndex.jsp</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo (master)</span><br><span class="line">$ git -c http.sslVerify=false push origin master</span><br><span class="line">Enumerating objects: <span class="number">14</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">14</span>/<span class="number">14</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">12</span>/<span class="number">12</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">14</span><span class="regexp">/14), 2.13 KiB | 726.00 KiB/</span>s, done.</span><br><span class="line">Total <span class="number">14</span> (delta <span class="number">3</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>查看gitlab上已经上传成功，复制Java-war-dev仓库地址；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192205777-396732044-20201127095232627.png" class title="img">



<p>再次回到Jenkins刚才创建的maven-freestyle-job中，将复制的仓库地址粘贴过来；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192057780-559306233-20201127095232785.png" class title="img">

<p> 接着添加构建步骤</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171745487-1863116514-20201127095232814.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171833932-2138348804-20201127095232881.png" class title="img">

<p>返回到Jenkins系统管理设置jdk和maven路径</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109171954411-440162308-20201127095232795.png" class title="img">



<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109172647579-2007679914-20201127095232898.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109172823526-350650902-20201127095232986.png" class title="img">

<p>点击“Apply”,最后点击“Save”</p>
<p>回到Jenkins mavent-freestyle-job配置页；</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109173140430-1450915196-20201127095233046.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109192337953-1505758240-20201127095233087.png" class title="img">

<p>试了好多次，中间错误过程及错误信息在本文结尾列出，针对我的环境，我猜测的是路径错误导致的，因为重新设置了路径之后，第16次构建，也就是上述构建成功的截图就是我重新建了一个Java-war-dev工程，直接在工程下面就是src目录，之前的错误因为我的目录结构是Java-war-dev工程下还有一个Java-war-dev文件夹，导致一直报错，在晚上转了一大圈，也没解决，最后我尝试新建了一个工程，重新配置了一下，构建成功！</p>
<p>查看输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace /var/lib/jenkins/workspace/maven-freestyle-job</span><br><span class="line"> &gt; git rev-parse --<span class="keyword">is</span>-inside-work-tree # timeout=<span class="number">10</span></span><br><span class="line">Fetching changes <span class="keyword">from</span> the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:<span class="comment">//gitlab.example.com/root/Java-war-dev.git # timeout=10</span></span><br><span class="line">Fetching upstream changes <span class="keyword">from</span> https:<span class="comment">//gitlab.example.com/root/Java-war-dev.git</span></span><br><span class="line"> &gt; git --version # timeout=<span class="number">10</span></span><br><span class="line">using GIT_ASKPASS to <span class="keyword">set</span> credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="comment">//gitlab.example.com/root/Java-war-dev.git +refs/heads/*:refs/remotes/origin/*</span></span><br><span class="line"> &gt; git rev-parse <span class="built_in">ref</span>s/remotes/origin/master^&#123;commit&#125; # timeout=<span class="number">10</span></span><br><span class="line"> &gt; git rev-parse <span class="built_in">ref</span>s/remotes/origin/origin/master^&#123;commit&#125; # timeout=<span class="number">10</span></span><br><span class="line">Checking <span class="keyword">out</span> Revision <span class="number">87</span>d659a9d8706b67e70a89fe7c9d5359d8fd72f5 (<span class="built_in">ref</span>s/remotes/origin/master)</span><br><span class="line"> &gt; git config core.sparsecheckout # timeout=<span class="number">10</span></span><br><span class="line"> &gt; git checkout -f <span class="number">87</span>d659a9d8706b67e70a89fe7c9d5359d8fd72f5</span><br><span class="line">Commit message: <span class="string">&quot;master-1.0.0&quot;</span></span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line"><span class="string">[maven-freestyle-job]</span> $ /opt/apache-maven<span class="number">-3.6</span><span class="number">.0</span>/bin/mvn package</span><br><span class="line"><span class="string">[INFO]</span> Scanning <span class="keyword">for</span> projects...</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> -------------------&lt; com.jenkins.demo:Java-war-dev &gt;--------------------</span><br><span class="line"><span class="string">[INFO]</span> Building Java-war-dev Maven Webapp <span class="number">1.0</span><span class="number">.15</span>-SNAPSHOT</span><br><span class="line"><span class="string">[INFO]</span> --------------------------------[ war ]---------------------------------</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-resources-plugin:<span class="number">2.6</span>:resources (<span class="keyword">default</span>-resources) @ Java-war-dev ---</span><br><span class="line"><span class="string">[WARNING]</span> Using platform encoding (UTF<span class="number">-8</span> actually) to copy filtered resources, i.e. build <span class="keyword">is</span> platform dependent!</span><br><span class="line"><span class="string">[INFO]</span> skip non existing resourceDirectory /var/lib/jenkins/workspace/maven-freestyle-job/src/main/resources</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-compiler-plugin:<span class="number">3.1</span>:compile (<span class="keyword">default</span>-compile) @ Java-war-dev ---</span><br><span class="line"><span class="string">[INFO]</span> No sources to compile</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-resources-plugin:<span class="number">2.6</span>:testResources (<span class="keyword">default</span>-testResources) @ Java-war-dev ---</span><br><span class="line"><span class="string">[WARNING]</span> Using platform encoding (UTF<span class="number">-8</span> actually) to copy filtered resources, i.e. build <span class="keyword">is</span> platform dependent!</span><br><span class="line"><span class="string">[INFO]</span> skip non existing resourceDirectory /var/lib/jenkins/workspace/maven-freestyle-job/src/test/resources</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-compiler-plugin:<span class="number">3.1</span>:testCompile (<span class="keyword">default</span>-testCompile) @ Java-war-dev ---</span><br><span class="line"><span class="string">[INFO]</span> No sources to compile</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-surefire-plugin:<span class="number">2.12</span><span class="number">.4</span>:test (<span class="keyword">default</span>-test) @ Java-war-dev ---</span><br><span class="line"><span class="string">[INFO]</span> No tests to run.</span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> --- maven-war-plugin:<span class="number">2.2</span>:war (<span class="keyword">default</span>-war) @ Java-war-dev ---</span><br><span class="line"><span class="string">[INFO]</span> Packaging webapp</span><br><span class="line"><span class="string">[INFO]</span> Assembling webapp [Java-war-dev] <span class="keyword">in</span> [/var/lib/jenkins/workspace/maven-freestyle-job/target/Java-war-dev]</span><br><span class="line"><span class="string">[INFO]</span> Processing war project</span><br><span class="line"><span class="string">[INFO]</span> Copying webapp resources [/var/lib/jenkins/workspace/maven-freestyle-job/src/main/webapp]</span><br><span class="line"><span class="string">[INFO]</span> Webapp assembled <span class="keyword">in</span> [<span class="number">21</span> msecs]</span><br><span class="line"><span class="string">[INFO]</span> Building war: /var/lib/jenkins/workspace/maven-freestyle-job/target/Java-war-dev.war</span><br><span class="line"><span class="string">[INFO]</span> WEB-INF/web.xml already added, skipping</span><br><span class="line"><span class="string">[INFO]</span> ------------------------------------------------------------------------</span><br><span class="line"><span class="string">[INFO]</span> BUILD SUCCESS</span><br><span class="line"><span class="string">[INFO]</span> ------------------------------------------------------------------------</span><br><span class="line"><span class="string">[INFO]</span> Total time:  <span class="number">1.341</span> s</span><br><span class="line"><span class="string">[INFO]</span> Finished at: <span class="number">2019</span><span class="number">-01</span><span class="number">-09</span>T19:<span class="number">22</span>:<span class="number">35</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="string">[INFO]</span> ------------------------------------------------------------------------</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>

<p><strong>Jenkins Ansible集成演示</strong></p>
<p>需要同anible主机上的配置ansible2.5+python 3.6虚拟环境一致，</p>
<p>配置Ansible2.5+python3.6</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# yum install -y openssl* gcc zlib*</span><br><span class="line">[root@jenkins ~]# wget https:<span class="comment">//www.python.org/ftp/python/3.6.8/Python-3.6.8.tar.xz</span></span><br><span class="line">[root@jenkins ~]# tar -xf Python-<span class="number">3.6</span>.<span class="number">8</span>.tar.xz -C <span class="regexp">/usr/</span>local<span class="regexp">/src/</span></span><br><span class="line">[root@jenkins ~]# cd <span class="regexp">/usr/</span>local<span class="regexp">/src/</span>Python-<span class="number">3.6</span>.<span class="number">8</span>/</span><br><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# .<span class="regexp">/configure --prefix=/u</span>sr<span class="regexp">/local/</span> --with-ensurepip=install --enable-shared LDFLAGS=<span class="string">&quot;-Wl,-rpath /usr/local/lib&quot;</span></span><br><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# make &amp;&amp; echo $? &amp;&amp; sleep <span class="number">3</span> &amp;&amp; make altinstall &amp;&amp; echo $?</span><br><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# whereis pip3.<span class="number">6</span></span><br><span class="line">pip3: <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip3.<span class="number">6</span></span><br><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# whereis pip</span><br><span class="line">pip: <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip3.<span class="number">6</span></span><br><span class="line">[root@jenkins Python-<span class="number">3.6</span>.<span class="number">8</span>]# ln -s <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip3.<span class="number">6</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>pip</span><br><span class="line">[root@jenkins ~]# pip install virtualenv</span><br><span class="line">[root@jenkins ~]# su - deploy</span><br><span class="line">[deploy@jenkins ~]$ virtualenv -p <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>python3.<span class="number">6</span> .py3-a2.<span class="number">5</span>-env</span><br><span class="line">Already using interpreter <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>python3.<span class="number">6</span></span><br><span class="line">Using base prefix <span class="string">&#x27;/usr/local&#x27;</span></span><br><span class="line"><span class="keyword">New</span> python executable in <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>bin/python3.<span class="number">6</span></span><br><span class="line">Also creating executable in <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line">done.</span><br><span class="line">[deploy@jenkins ~]$ cd <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span></span><br><span class="line">[deploy@jenkins .py3-a2.<span class="number">5</span>-env]$ <span class="keyword">source</span> <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>bin/activate</span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins .py3-a2.<span class="number">5</span>-env]$ pip install paramiko PyYAML jinja2</span><br><span class="line"> (.py3-a2.<span class="number">5</span>-env) [deploy@jenkins .py3-a2.<span class="number">5</span>-env]$git clone https:<span class="comment">//github.com/ansible/ansible.git</span></span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins .py3-a2.<span class="number">5</span>-env]$ cd ansible/</span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins ansible]$ pwd</span><br><span class="line"><span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>ansible</span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins ansible]$ git checkout stable-<span class="number">2.5</span></span><br><span class="line">Branch stable-<span class="number">2.5</span> set up to track remote branch stable-<span class="number">2.5</span> <span class="keyword">from</span> origin.</span><br><span class="line">Switched to a <span class="keyword">new</span> branch <span class="string">&#x27;stable-2.5&#x27;</span></span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins ansible]$ <span class="keyword">source</span> <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>ansible<span class="regexp">/hacking/</span>env-setup -q</span><br><span class="line">(.py3-a2.<span class="number">5</span>-env) [deploy@jenkins ansible]$ ansible --version</span><br><span class="line">ansible <span class="number">2.5</span>.<span class="number">14</span> (stable-<span class="number">2.5</span> c748512c4c) last updated <span class="number">2019</span><span class="regexp">/01/</span><span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config <span class="keyword">file</span> = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>ansible<span class="regexp">/lib/</span>ansible</span><br><span class="line">  executable location = <span class="regexp">/home/</span>deploy<span class="regexp">/.py3-a2.5-env/</span>ansible<span class="regexp">/bin/</span>ansible</span><br><span class="line">  python version = <span class="number">3.6</span>.<span class="number">8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span>.<span class="number">5</span>-<span class="number">36</span>)]</span><br></pre></td></tr></table></figure>

<p>配置jenkins.example.com主机到test.example.com主机的ssh免秘钥认证</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@jenkins ~]$ ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter <span class="built_in">file</span> <span class="keyword">in</span> which <span class="keyword">to</span> save <span class="keyword">the</span> key (/home/deploy/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/deploy/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/deploy/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint <span class="keyword">is</span>:</span><br><span class="line">SHA256:cXo/fOrw7FhywXZvsRmHUBkMPvuY2C3wdMIFTgeaZ1Q deploy@jenkins.example.com</span><br><span class="line">The key&#x27;s randomart image <span class="keyword">is</span>:</span><br><span class="line">+<span class="comment">---[RSA 2048]----+</span></span><br><span class="line">|            *=Eo |</span><br><span class="line">|           B +o  |</span><br><span class="line">|        . + B .  |</span><br><span class="line">|         + = = . |</span><br><span class="line">|        S o O +o.|</span><br><span class="line">|         . X X .*|</span><br><span class="line">|          + % +oo|</span><br><span class="line">|           O = . |</span><br><span class="line">|          .o*    |</span><br><span class="line">+<span class="comment">----[SHA256]-----+</span></span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@jenkins ~]$ ssh-<span class="keyword">copy</span>-<span class="built_in">id</span> root@test.example.com</span><br><span class="line">/bin/ssh-<span class="keyword">copy</span>-<span class="built_in">id</span>: INFO: Source <span class="keyword">of</span> key(s) <span class="keyword">to</span> be installed: <span class="string">&quot;/home/deploy/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">/bin/ssh-<span class="keyword">copy</span>-<span class="built_in">id</span>: INFO: attempting <span class="keyword">to</span> <span class="built_in">log</span> <span class="keyword">in</span> <span class="keyword">with</span> <span class="keyword">the</span> new key(s), <span class="keyword">to</span> filter out any <span class="keyword">that</span> are already installed</span><br><span class="line">/bin/ssh-<span class="keyword">copy</span>-<span class="built_in">id</span>: INFO: <span class="number">1</span> key(s) remain <span class="keyword">to</span> be installed <span class="comment">-- if you are prompted now it is to install the new keys</span></span><br><span class="line">root@test.example.com&#x27;s password:</span><br><span class="line"></span><br><span class="line">Number <span class="keyword">of</span> key(s) added: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> <span class="keyword">the</span> machine, <span class="keyword">with</span>:   <span class="string">&quot;ssh &#x27;root@test.example.com&#x27;&quot;</span></span><br><span class="line"><span class="keyword">and</span> check <span class="keyword">to</span> make sure <span class="keyword">that</span> only <span class="keyword">the</span> key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@jenkins ~]$ ssh root@test.example.com</span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">16</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.131</span></span><br><span class="line">[root@test ~]<span class="comment"># hostname</span></span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>

<p>配置ansible</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">[deploy<span class="variable">@jenkins</span> ~]<span class="variable">$ </span>pwd</span><br><span class="line">/home/deploy</span><br><span class="line">[deploy<span class="variable">@jenkins</span> ~]<span class="variable">$ </span>cat testservers</span><br><span class="line">[testserver]</span><br><span class="line">test.example.com  ansible_user=root</span><br></pre></td></tr></table></figure>



<p>登录到jenkins web管理页，点击“New 任务”</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109202822525-464652266-20201127095233123.png" class title="img">

<p>添加描述信息</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109202940751-1626799640-20201127095233272.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109203014667-206268133-20201127095233045.png" class title="img">



<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> +x</span><br><span class="line"><span class="built_in">source</span> /home/deploy/.py3-a2.5-env/bin/activate</span><br><span class="line"><span class="built_in">source</span> /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/deploy</span><br><span class="line">ansible --version</span><br><span class="line">ansible-playbook --version</span><br><span class="line"></span><br><span class="line">cat testservers</span><br><span class="line"></span><br><span class="line">ansible -i testservers testserver -m <span class="built_in">command</span> -a <span class="string">&quot;ip addr&quot;</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br></pre></td></tr></table></figure>

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109203212938-471059166-20201127095233307.png" class title="img">

<p>查看输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace /var/lib/jenkins/workspace/ansible-freestyle-job</span><br><span class="line"><span class="string">[ansible-freestyle-job]</span> $ /bin/sh /tmp/jenkins7988516678097340995.sh</span><br><span class="line">ansible <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> c748512c4c) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line">ansible-playbook <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> c748512c4c) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible-playbook</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line"><span class="string">[testserver]</span></span><br><span class="line">test.example.com  ansible_user=root</span><br><span class="line"></span><br><span class="line">test.example.com | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">61</span>:aa:<span class="number">73</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.244</span><span class="number">.133</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.244</span><span class="number">.255</span> scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">7395</span>:<span class="number">7e45</span>:e2e6:ec36/<span class="number">64</span> scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: ens34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">61</span>:aa:<span class="number">7</span>d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.182</span><span class="number">.134</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.182</span><span class="number">.255</span> scope global noprefixroute dynamic ens34</span><br><span class="line">       valid_lft <span class="number">1477</span>sec preferred_lft <span class="number">1477</span>sec</span><br><span class="line">    inet6 fe80::<span class="number">196</span>:adf0:e929:d612/<span class="number">64</span> scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>





<p>下面错误信息就是上述构建jenkins maven集成时报错信息（可以随便看看）： </p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%9B%9B)/804543-20190109173345826-1534145406-20201127095233364.png" class title="img">

<p>构建失败，查看错误输出信息</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/maven-freestyle-job</span><br><span class="line">Cloning the remote Git repository</span><br><span class="line">Cloning repository https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line"> &gt; git init <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/maven-freestyle-job <span class="comment"># timeout=10</span></span><br><span class="line">Fetching upstream changes from https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line"> &gt; git --version <span class="comment"># timeout=10</span></span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/*</span><br><span class="line"> &gt; git config remote.origin.url https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git config --add remote.origin.fetch +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/* <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git config remote.origin.url https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git <span class="comment"># timeout=10</span></span><br><span class="line">Fetching upstream changes from https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/*</span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin<span class="regexp">/origin/m</span>aster^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line">Checking out Revision aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 (refs<span class="regexp">/remotes/</span>origin/master)</span><br><span class="line"> &gt; git config core.sparsecheckout <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git checkout -f aa3c70c49a68bfc91b4fe65c38be0b4b15461a63</span><br><span class="line">Commit message: <span class="string">&quot;first commit&quot;</span></span><br><span class="line">First time build. Skipping changelog.</span><br><span class="line">[maven-freestyle-job] $ <span class="regexp">/opt/</span>apache-maven-<span class="number">3.6</span>.<span class="number">0</span><span class="regexp">/bin/m</span>vn package</span><br><span class="line">The JAVA_HOME environment variable is not defined correctly</span><br><span class="line">This environment variable is needed to run this program</span><br><span class="line">NB: JAVA_HOME should point to a JDK not a JRE</span><br><span class="line">Build step <span class="string">&#x27;Invoke top-level Maven targets&#x27;</span> marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>由报错信息可以看出，jdk环境设置有问题</p>
<p>以下报错信息目前没有解决掉，如果有热心同学知道解决办法的欢迎评论区指教^_^ ~,针对以上问题，我是删掉重新构建了一遍，包括全局凭据也是删掉重新创建了一个一样的，然后再次执行的时候就没有报错。</p>
<p>但是经反复确认，jdk路径没有错，接着有重新构建，提示以下内容</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">Started by user admin</span><br><span class="line">Building <span class="keyword">in</span> workspace <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/maven-freestyle-job</span><br><span class="line"> &gt; git rev-parse --is-inside-work-tree <span class="comment"># timeout=10</span></span><br><span class="line">Fetching changes from the remote Git repository</span><br><span class="line"> &gt; git config remote.origin.url https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git <span class="comment"># timeout=10</span></span><br><span class="line">Fetching upstream changes from https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git</span><br><span class="line"> &gt; git --version <span class="comment"># timeout=10</span></span><br><span class="line">using GIT_ASKPASS to set credentials </span><br><span class="line"> &gt; git fetch --tags --progress https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>java-war-dev.git +refs<span class="regexp">/heads/</span>*:refs<span class="regexp">/remotes/</span>origin/*</span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin/master^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git rev-parse refs<span class="regexp">/remotes/</span>origin<span class="regexp">/origin/m</span>aster^&#123;commit&#125; <span class="comment"># timeout=10</span></span><br><span class="line">Checking out Revision aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 (refs<span class="regexp">/remotes/</span>origin/master)</span><br><span class="line"> &gt; git config core.sparsecheckout <span class="comment"># timeout=10</span></span><br><span class="line"> &gt; git checkout -f aa3c70c49a68bfc91b4fe65c38be0b4b15461a63</span><br><span class="line">Commit message: <span class="string">&quot;first commit&quot;</span></span><br><span class="line"> &gt; git rev-list --no-walk aa3c70c49a68bfc91b4fe65c38be0b4b15461a63 <span class="comment"># timeout=10</span></span><br><span class="line">[maven-freestyle-job] $ <span class="regexp">/opt/</span>apache-maven-<span class="number">3.6</span>.<span class="number">0</span><span class="regexp">/bin/m</span>vn package</span><br><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  <span class="number">0.112</span> s</span><br><span class="line">[INFO] Finished at: <span class="number">2019</span>-<span class="number">01</span>-<span class="number">09</span>T17:<span class="number">46</span>:<span class="number">04</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] The goal you specified requires a project to execute but there is no POM <span class="keyword">in</span> this directory (<span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace/maven-freestyle-job). Please verify you invoked Maven from the correct directory. -&gt; [Help <span class="number">1</span>]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help <span class="number">1</span>] http:<span class="regexp">//</span>cwiki.apache.org<span class="regexp">/confluence/</span>display<span class="regexp">/MAVEN/</span>MissingProjectException</span><br><span class="line">Build step <span class="string">&#x27;Invoke top-level Maven targets&#x27;</span> marked build as failure</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure>

<p>然后进行如下操作</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">[root@<span class="keyword">jenkins </span>~]<span class="comment"># cd /var/lib/jenkins/workspace/maven-freestyle-job</span></span><br><span class="line">[root@<span class="keyword">jenkins </span>maven-freestyle-<span class="keyword">job]# </span>ls</span><br><span class="line"><span class="keyword">Java-war-dev</span></span><br><span class="line"><span class="keyword">[root@jenkins </span>maven-freestyle-<span class="keyword">job]# </span>ls <span class="keyword">Java-war-dev/</span></span><br><span class="line"><span class="keyword">pom.xml </span> src</span><br><span class="line">[root@<span class="keyword">jenkins </span>maven-freestyle-<span class="keyword">job]# </span>mv <span class="keyword">Java-war-dev/pom.xml </span>.</span><br><span class="line">[root@<span class="keyword">jenkins </span>maven-freestyle-<span class="keyword">job]# </span>ls</span><br><span class="line"><span class="keyword">Java-war-dev </span> pom.xml</span><br></pre></td></tr></table></figure>

<p>再次执行构建操作，还是报错</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">........</span><br><span class="line">[INFO] Building war: /var/lib/jenkins/workspace/maven-freestyle-job/target/Java-war-dev.war</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] Total time:  01:36 min</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:04:52+08:00</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[ERROR] Failed to <span class="keyword">execute</span> goal </span><br><span class="line">org.apache.maven.plugins:maven-war-<span class="keyword">plugin</span>:<span class="number">2.2</span>:war (<span class="keyword">default</span>-war) <span class="keyword">on</span> <span class="keyword">project</span> <span class="keyword">Java</span>-war-dev: <span class="keyword">Error</span> assembling WAR: webxml <span class="keyword">attribute</span> <span class="keyword">is</span> <span class="keyword">required</span> (<span class="keyword">or</span> pre-existing WEB-INF/web.xml <span class="keyword">if</span> executing <span class="keyword">in</span> <span class="keyword">update</span> <span class="keyword">mode</span>) -&gt; [<span class="keyword">Help</span> <span class="number">1</span>]</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">To</span> see the <span class="keyword">full</span> stack <span class="keyword">trace</span> <span class="keyword">of</span> the <span class="keyword">errors</span>, re-run Maven <span class="keyword">with</span> the -e switch.</span><br><span class="line">[<span class="keyword">ERROR</span>] Re-run Maven <span class="keyword">using</span> the -X <span class="keyword">switch</span> <span class="keyword">to</span> <span class="keyword">enable</span> <span class="keyword">full</span> debug logging.</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">For</span> more information about the <span class="keyword">errors</span> <span class="keyword">and</span> possible solutions, please <span class="keyword">read</span> the <span class="keyword">following</span> articles:</span><br><span class="line">[<span class="keyword">ERROR</span>] [<span class="keyword">Help</span> <span class="number">1</span>] <span class="keyword">http</span>://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException</span><br><span class="line"></span><br><span class="line"><span class="keyword">Build</span> step <span class="string">&#x27;Invoke top-level Maven targets&#x27;</span> marked <span class="keyword">build</span> <span class="keyword">as</span> <span class="keyword">failure</span></span><br><span class="line">Finished: <span class="keyword">FAILURE</span></span><br></pre></td></tr></table></figure>



<p>改了pom.xml文件之后</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">webXml</span>&gt;</span>WebRoot\WEB-INF\web.xml<span class="tag">&lt;/<span class="name">webXml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">warSourceDirectory</span>&gt;</span>WebRoot<span class="tag">&lt;/<span class="name">warSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--autoVersionSubmodules&gt;true&lt;/autoVersionSubmodules--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>仍然报错</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[INFO] Building war: /var/lib/jenkins/workspace/maven-freestyle-job/target/Java-war-dev.war</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] Total time:  0.995 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:23:24+08:00</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[ERROR] Failed to <span class="keyword">execute</span> goal org.apache.maven.plugins:maven-war-<span class="keyword">plugin</span>:<span class="number">2.2</span>:war (<span class="keyword">default</span>-war) <span class="keyword">on</span> <span class="keyword">project</span> <span class="keyword">Java</span>-war-dev: <span class="keyword">Error</span> assembling WAR: webxml <span class="keyword">attribute</span> <span class="keyword">is</span> <span class="keyword">required</span> (<span class="keyword">or</span> pre-existing WEB-INF/web.xml <span class="keyword">if</span> executing <span class="keyword">in</span> <span class="keyword">update</span> <span class="keyword">mode</span>) -&gt; [<span class="keyword">Help</span> <span class="number">1</span>]</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">To</span> see the <span class="keyword">full</span> stack <span class="keyword">trace</span> <span class="keyword">of</span> the <span class="keyword">errors</span>, re-run Maven <span class="keyword">with</span> the -e switch.</span><br><span class="line">[<span class="keyword">ERROR</span>] Re-run Maven <span class="keyword">using</span> the -X <span class="keyword">switch</span> <span class="keyword">to</span> <span class="keyword">enable</span> <span class="keyword">full</span> debug logging.</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">For</span> more information about the <span class="keyword">errors</span> <span class="keyword">and</span> possible solutions, please <span class="keyword">read</span> the <span class="keyword">following</span> articles:</span><br><span class="line">[<span class="keyword">ERROR</span>] [<span class="keyword">Help</span> <span class="number">1</span>] <span class="keyword">http</span>://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException</span><br><span class="line"><span class="keyword">Build</span> step <span class="string">&#x27;Invoke top-level Maven targets&#x27;</span> marked <span class="keyword">build</span> <span class="keyword">as</span> <span class="keyword">failure</span></span><br><span class="line">Finished: <span class="keyword">FAILURE</span></span><br></pre></td></tr></table></figure>

<p>再次更改pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">webResources</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">directory</span>&gt;</span>web<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">webResources</span>&gt;</span></span><br><span class="line">               <span class="comment">&lt;!--webXml&gt;WebRoot\WEB-INF\web.xml&lt;/webXml&gt;</span></span><br><span class="line"><span class="comment">               &lt;warSourceDirectory&gt;WebRoot&lt;/warSourceDirectory--&gt;</span></span><br><span class="line">               <span class="comment">&lt;!--autoVersionSubmodules&gt;true&lt;/autoVersionSubmodules--&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>仍然报错</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[INFO] Building war: /var/lib/jenkins/workspace/maven-freestyle-job/target/Java-war-dev.war</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[INFO] Total time:  0.982 s</span><br><span class="line">[INFO] Finished at: 2019-01-09T18:26:38+08:00</span><br><span class="line">[INFO] <span class="comment">------------------------------------------------------------------------</span></span><br><span class="line">[ERROR] Failed to <span class="keyword">execute</span> goal org.apache.maven.plugins:maven-war-<span class="keyword">plugin</span>:<span class="number">2.2</span>:war (<span class="keyword">default</span>-war) <span class="keyword">on</span> <span class="keyword">project</span> <span class="keyword">Java</span>-war-dev: <span class="keyword">Error</span> assembling WAR: webxml <span class="keyword">attribute</span> <span class="keyword">is</span> <span class="keyword">required</span> (<span class="keyword">or</span> pre-existing WEB-INF/web.xml <span class="keyword">if</span> executing <span class="keyword">in</span> <span class="keyword">update</span> <span class="keyword">mode</span>) -&gt; [<span class="keyword">Help</span> <span class="number">1</span>]</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">To</span> see the <span class="keyword">full</span> stack <span class="keyword">trace</span> <span class="keyword">of</span> the <span class="keyword">errors</span>, re-run Maven <span class="keyword">with</span> the -e switch.</span><br><span class="line">[<span class="keyword">ERROR</span>] Re-run Maven <span class="keyword">using</span> the -X <span class="keyword">switch</span> <span class="keyword">to</span> <span class="keyword">enable</span> <span class="keyword">full</span> debug logging.</span><br><span class="line">[<span class="keyword">ERROR</span>] </span><br><span class="line">[<span class="keyword">ERROR</span>] <span class="keyword">For</span> more information about the <span class="keyword">errors</span> <span class="keyword">and</span> possible solutions, please <span class="keyword">read</span> the <span class="keyword">following</span> articles:</span><br><span class="line">[<span class="keyword">ERROR</span>] [<span class="keyword">Help</span> <span class="number">1</span>] <span class="keyword">http</span>://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException</span><br><span class="line"><span class="keyword">Build</span> step <span class="string">&#x27;Invoke top-level Maven targets&#x27;</span> marked <span class="keyword">build</span> <span class="keyword">as</span> <span class="keyword">failure</span></span><br><span class="line">Finished: <span class="keyword">FAILURE</span></span><br></pre></td></tr></table></figure>

<p>然而网友说的这些并不能解决问题。</p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP-php-fpm配置优化</title>
    <url>/sugw.github.io/2020/11/19/PHP-php-fpm%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>前言:</p>
<p>　　1.少安装PHP模块, 费内存</p>
<p>　　2.调高linux内核打开文件数量，可以使用这些命令(必须是root帐号)(我是修改/etc/rc.local，加入ulimit -SHn 51200的)</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">echo `ulimit -HSn 65536` &gt;&gt; /etc/profile</span><br><span class="line">echo `ulimit -HSn 65536` &gt;&gt; /etc/rc.local</span><br><span class="line">source /etc<span class="built_in">/profile </span></span><br></pre></td></tr></table></figure>

<p>　　如果<code>ulimit -n</code>数量依旧不多(即上面配置没生效)的话, 可以在 /etc/security/limits.conf 文件最后加上</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">* soft nofile <span class="number">51200</span></span><br><span class="line">* hard nofile <span class="number">51200</span></span><br></pre></td></tr></table></figure>

<p>1.<strong>与Nginx使用Unix域Socket通信(Nginx和php-fpm在同一台服务器)</strong></p>
<p>　　Unix域Socket因为不走网络，的确可以提高Nginx和php-fpm通信的性能，但在高并发时会不稳定。</p>
<p>　　Nginx会频繁报错：connect() to unix:/dev/shm/php-fcgi.sock failed (11: Resource temporarily unavailable) while connecting to upstream</p>
<p>　　可以通过下面两种方式提高稳定性：<br>　　1）调高nginx和php-fpm中的backlog<br>  　　 配置方法为：在nginx配置文件中这个域名的server下，在listen 80后面添加default backlog=1024。<br>   　　同时配置php-fpm.conf中的listen.backlog为1024，默认为128。<br>　　2）增加sock文件和php-fpm实例数<br>   　　再新建一个sock文件，在Nginx中通过upstream模块将请求负载均衡到两个sock文件背后的两套php-fpm实例上。</p>
<p>2.<strong>php-fpm参数调优</strong></p>
<p>　　pm = dynamic; 表示使用哪种进程数量管理方式</p>
<p>　　　　dynamic表示php-fpm进程数是动态的，最开始是pm.start_servers指定的数量，如果请求较多，则会自动增加，保证空闲的进程数不小于pm.min_spare_servers，如果进程数较多，也会进行相应清理，保证多余的进程数不多于pm.max_spare_servers</p>
<p>　　　　static表示php-fpm进程数是静态的, 进程数自始至终都是pm.max_children指定的数量，不再增加或减少</p>
<p>　　pm.max_children = 300; <strong>静态方式</strong>下开启的php-fpm进程数量<br>　　pm.start_servers = 20; <strong>动态方式</strong>下的起始php-fpm进程数量<br>　　pm.min_spare_servers = 5; <strong>动态方式</strong>下的最小php-fpm进程数量<br>　　pm.max_spare_servers = 35; <strong>动态方式</strong>下的最大php-fpm进程数量</p>
<p>　　　　如果pm为static, 那么其实只有pm.max_children这个参数生效。系统会开启设置数量的php-fpm进程</p>
<p>　　　　如果pm为dynamic, 那么pm.max_children参数失效，后面3个参数生效。系统会在php-fpm运行开始的时候启动pm.start_servers个php-fpm进程，然后根据系统的需求动态在pm.min_spare_servers和pm.max_spare_servers之间调整php-fpm进程数</p>
<p>　　　　那么，对于我们的服务器，选择哪种pm方式比较好呢？事实上，跟Apache一样，运行的PHP程序在执行完成后，或多或少会有内存泄露的问题。这也是为什么开始的时候一个php-fpm进程只占用3M左右内存，运行一段时间后就会上升到20-30M的原因了。</p>
<p>　　　　对于内存大的服务器（比如8G以上）来说，指定静态的max_children实际上更为妥当，因为这样不需要进行额外的进程数目控制，会提高效率。因为频繁开关php-fpm进程也会有时滞，所以内存够大的情况下开静态效果会更好。数量也可以根据 内存/30M 得到，比如8GB内存可以设置为100，那么php-fpm耗费的内存就能控制在 2G-3G的样子。如果内存稍微小点，比如1G，那么指定静态的进程数量更加有利于服务器的稳定。这样可以保证php-fpm只获取够用的内存，将不多的内存分配给其他应用去使用，会使系统的运行更加畅通。</p>
<p>　　　　对于小内存的服务器来说，比如256M内存的VPS，即使按照<strong>一个20M</strong>的内存量来算，10个php-cgi进程就将耗掉200M内存，那系统的崩溃就应该很正常了。因此应该尽量地控制php-fpm进程的数量，大体明确其他应用占用的内存后，给它指定一个静态的小数量，会让系统更加平稳一些。或者使用动态方式，因为动态方式会结束掉多余的进程，可以回收释放一些内存，所以推荐在内存较少的服务器或VPS上使用。具体最大数量根据 内存/20M 得到。比如说512M的VPS，建议pm.max_spare_servers设置为20。至于pm.min_spare_servers，则建议根据服务器的负载情况来设置，比较合适的值在5~10之间。</p>
<p>　　　　在4G内存的服务器上200就可以(<strong>我的1G测试机，开64个是最好的</strong>，建议使用压力测试获取最佳值)</p>
<p>　　pm.max_requests = 10240;</p>
<p>　　　　nginx php-fpm配置过程中最大问题是内泄漏出问题：服务器的负载不大，但是内存占用迅速增加，很快吃掉内存接着开始吃交换分区，系统很快挂掉！其实根据官方的介绍，php-cgi不存在内存泄漏，每个请求完成后php-cgi会回收内存，但是不会释放给操作系统，这样就会导致大量内存被php-cgi占用。
　　　　</p>
<p>　　　　官方的解决办法是降低PHP_FCGI_MAX_REQUESTS的值，如果用的是php-fpm，对应的php-fpm.conf中的就是max_requests，该值的意思是发送多少个请求后会重启该线程，我们需要适当降低这个值，用以让php-fpm自动的释放内存，不是大部分网上说的51200等等，实际上还有另一个跟它有关联的值max_children，这个是每次php-fpm会建立多少个进程，这样实际上的内存消耗是max_children<em>max_requests</em>每个请求使用内存，根据这个我们可以预估一下内存的使用情况，就不用再写脚本去kill了。</p>
<p>　　request_terminate_timeout = 30;</p>
<p>　　　　最大执行时间, 在php.ini中也可以进行配置(max_execution_time)</p>
<p>　　request_slowlog_timeout = 2; 开启慢日志<br>　　slowlog = log/$pool.log.slow; 慢日志路径</p>
<p>　　rlimit_files = 1024; 增加php-fpm打开文件描述符的限制</p>
<p>3.<strong>php-fpm的高CPU使用率排查方法</strong></p>
<p>　　1)使用top命令, 直接执行top命令后，输入1就可以看到各个核心的CPU使用率。而且通过top -d 0.1可以缩短采样时间</p>
<p>　　2)查询php-fpm慢日志</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">grep</span> -v <span class="string">&quot;^$&quot;</span> www.log.slow.tmp | cut -d <span class="string">&quot; &quot;</span> -f <span class="number">3</span>,<span class="number">2</span> | sort | uniq -c | sort -k<span class="number">1</span>,<span class="number">1</span>nr | head -n <span class="number">50</span></span><br></pre></td></tr></table></figure>



<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">5181 </span><span class="keyword">run</span>() /www/test.net/framework/web/filters/CFilter.php:<span class="number">41</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">5156 </span>filter() /www/test.net/framework/web/filters/CFilterChain.php:<span class="number">131</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2670 </span>= /www/test.net/index.php</span><br><span class="line"></span><br><span class="line"><span class="symbol">2636 </span><span class="keyword">run</span>() /www/test.net/application/controllers/survey/index.php:<span class="number">665</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2630 </span>action() /www/test.net/application/controllers/survey/index.php:<span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2625 </span><span class="keyword">run</span>() /www/test.net/framework/web/actions/CAction.php:<span class="number">75</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2605 </span>runWithParams() /www/test.net/framework/web/CController.php:<span class="number">309</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2604 </span>runAction() /www/test.net/framework/web/filters/CFilterChain.php:<span class="number">134</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2538 </span><span class="keyword">run</span>() /www/test.net/framework/web/CController.php:<span class="number">292</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2484 </span>runActionWithFilters() /www/test.net/framework/web/CController.php:<span class="number">266</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">2251 </span><span class="keyword">run</span>() /www/test.net/framework/web/CWebApplication.php:<span class="number">276</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">1799 </span>translate() /www/test.net/application/libraries/Limesurvey_lang.php:<span class="number">118</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">1786 </span>load_tables() /www/test.net/application/third_party/php-gettext/gettext.php:<span class="number">254</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">1447 </span>runController() /www/test.net/framework/web/CWebApplication.php:<span class="number">135</span></span><br></pre></td></tr></table></figure>

<p>　　　　参数解释:</p>
<p>​         sort: 对单词进行排序<br>​         uniq -c: 显示唯一的行，并在每行行首加上本行在文件中出现的次数<br>​         sort -k1,1nr: 按照第一个字段，数值排序，且为逆序<br>​         head -10: 取前10行数据</p>
<p>　　3)用strace跟踪进程</p>
<p>　　　　a)利用nohup将strace转为后台执行，直到attach上的php-fpm进程死掉为止：</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">nohup strace -T -p <span class="number">13167</span> &gt; <span class="number">13167</span>-strace.<span class="built_in">log</span> <span class="meta">&amp;</span></span><br></pre></td></tr></table></figure>

<p>　　　　参数说明:</p>
<p>　　　　　 -c 统计每一系统调用的所执行的时间,次数和出错的次数等.<br>         -d 输出strace关于标准错误的调试信息.<br>         -f 跟踪由fork调用所产生的子进程.<br>         -o filename,则所有进程的跟踪结果输出到相应的filename<br>         -F 尝试跟踪vfork调用.在-f时,vfork不被跟踪.<br>         -h 输出简要的帮助信息.<br>         -i 输出系统调用的入口指针.<br>         -q 禁止输出关于脱离的消息.<br>         -r 打印出相对时间关于,,每一个系统调用.<br>         -t 在输出中的每一行前加上时间信息.<br>         -tt 在输出中的每一行前加上时间信息,微秒级.<br>         -ttt 微秒级输出,以秒了表示时间.<br>         -T 显示每一调用所耗的时间.<br>         -v 输出所有的系统调用.一些调用关于环境变量,状态,输入输出等调用由于使用频繁,默认不输出.<br>         -V 输出strace的版本信息.<br>         -x 以十六进制形式输出非标准字符串<br>         -xx 所有字符串以十六进制形式输出.<br>         -a column<br>         设置返回值的输出位置.默认为40.<br>         -e execve 只记录 execve 这类系统调用<br>         -p 主进程号</p>
<p>　　　　b)用利用-c参数让strace帮助汇总，非常方便非常强大！</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@b28-12 log]</span># strace -cp <span class="number">9907</span></span><br><span class="line"></span><br><span class="line">Process <span class="number">9907</span> attached - <span class="built_in">int</span>errupt to quit</span><br><span class="line"></span><br><span class="line">Process <span class="number">9907</span> detached</span><br><span class="line"></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line"></span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"></span><br><span class="line"><span class="number">56.61</span>    <span class="number">0.016612</span>           <span class="number">5</span>      <span class="number">3121</span>           read</span><br><span class="line"></span><br><span class="line"><span class="number">11.11</span>    <span class="number">0.003259</span>           <span class="number">1</span>      <span class="number">2517</span>       <span class="number">715</span> stat</span><br><span class="line"></span><br><span class="line">  <span class="number">8.04</span>    <span class="number">0.002358</span>           <span class="number">7</span>       <span class="number">349</span>           brk</span><br><span class="line"></span><br><span class="line">  <span class="number">6.02</span>    <span class="number">0.001767</span>           <span class="number">1</span>      <span class="number">1315</span>           poll</span><br><span class="line"></span><br><span class="line">  <span class="number">4.28</span>    <span class="number">0.001255</span>           <span class="number">6</span>       <span class="number">228</span>           recvfrom</span><br><span class="line"></span><br><span class="line">  <span class="number">2.71</span>    <span class="number">0.000796</span>           <span class="number">1</span>       <span class="number">671</span>           open</span><br><span class="line"></span><br><span class="line">  <span class="number">2.54</span>    <span class="number">0.000745</span>           <span class="number">0</span>      <span class="number">2453</span>           fcntl</span><br><span class="line"></span><br><span class="line">  <span class="number">2.37</span>    <span class="number">0.000696</span>           <span class="number">1</span>      <span class="number">1141</span>           write</span><br><span class="line"></span><br><span class="line">  <span class="number">1.69</span>    <span class="number">0.000497</span>           <span class="number">1</span>       <span class="number">593</span>        <span class="number">13</span> access</span><br><span class="line"></span><br><span class="line">  <span class="number">1.37</span>    <span class="number">0.000403</span>           <span class="number">0</span>      <span class="number">1816</span>           lseek</span><br><span class="line"></span><br><span class="line">  <span class="number">0.89</span>    <span class="number">0.000262</span>           <span class="number">1</span>       <span class="number">451</span>        <span class="number">22</span> sendto</span><br><span class="line"></span><br><span class="line">  <span class="number">0.56</span>    <span class="number">0.000163</span>           <span class="number">1</span>       <span class="number">276</span>       <span class="number">208</span> lstat</span><br><span class="line"></span><br><span class="line">  <span class="number">0.49</span>    <span class="number">0.000145</span>           <span class="number">0</span>       <span class="number">384</span>           getcwd</span><br><span class="line"></span><br><span class="line">  <span class="number">0.31</span>    <span class="number">0.000090</span>           <span class="number">0</span>      <span class="number">1222</span>           fstat</span><br><span class="line"></span><br><span class="line">  <span class="number">0.28</span>    <span class="number">0.000082</span>           <span class="number">0</span>       <span class="number">173</span>           munmap</span><br><span class="line"></span><br><span class="line">  <span class="number">0.26</span>    <span class="number">0.000077</span>           <span class="number">0</span>       <span class="number">174</span>           mmap</span><br><span class="line"></span><br><span class="line">  <span class="number">0.24</span>    <span class="number">0.000069</span>           <span class="number">2</span>        <span class="number">41</span>           socket</span><br><span class="line"></span><br><span class="line">  <span class="number">0.23</span>    <span class="number">0.000068</span>           <span class="number">0</span>       <span class="number">725</span>           close</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">13</span>           rt_sigaction</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">13</span>           rt_sigprocmask</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>         <span class="number">1</span>           rt_sigreturn</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">78</span>           setitimer</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">26</span>        <span class="number">26</span> connect</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">15</span>         <span class="number">2</span> accept</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">39</span>           recvmsg</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">26</span>           shutdown</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">13</span>           bind</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">13</span>           getsockname</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">65</span>           setsockopt</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">13</span>           getsockopt</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>         <span class="number">8</span>           getdents</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>        <span class="number">26</span>           chdir</span><br><span class="line"></span><br><span class="line">  <span class="number">0.00</span>    <span class="number">0.000000</span>           <span class="number">0</span>         <span class="number">1</span>           futex</span><br><span class="line"></span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"></span><br><span class="line"><span class="number">100.00</span>    <span class="number">0.029344</span>                 <span class="number">18000</span>       <span class="number">986</span> total</span><br></pre></td></tr></table></figure>

<p>4.<strong>使用Opcode缓存</strong>(<a href="http://www.cnblogs.com/JohnABC/p/4531038.html">http://www.cnblogs.com/JohnABC/p/4531038.html</a>)</p>
<p>5.<strong>对PHP性能进行监控</strong></p>
<p>　　常用的方法就是开启xdebug的性能监控功能，将xdebug输出结果通过WinCacheGrind软件分析。</p>
<p>　　xdebug的安装和配合IDE调试的方法参见：<a href="http://blog.csdn.net/dc_726/article/details/8809696">Vim+XDebug调试PHP</a></p>
<p>　　php.ini中配置的这几项是输出性能信息的：</p>
<blockquote>
<p>xdebug.auto_trace = on</p>
</blockquote>
<blockquote>
<p>xdebug.auto_profile = on<br>xdebug.collect_params = on<br>xdebug.collect_return = on<br>xdebug.profiler_enable = on<br>xdebug.trace_output_dir = “/tmp”<br>xdebug.profiler_output_dir =”/tmp”</p>
</blockquote>
<p>　　这样XDebug会输出所有执行php函数的性能数据，但产生的文件也会比较大。可以关闭一些选项如collect_params、collect_return，</p>
<p>　　来减少输出的数据量。或者关闭自动输出，通过在想要监控的函数首尾调用xdebug函数来监控指定的函数。</p>
<p>　　输出的文件名类似cachegrind.out.1277560600和trace.3495983249.txt，可以拿到Windows平台下用WinCacheGrind进行图形化分析。</p>
<p>6.监测php-fpm线程状态</p>
<p>　　nginx配置</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ ^/status$</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">    <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　php-fpm配置</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">pm.status_path</span> = /status</span><br></pre></td></tr></table></figure>

<p>　　这样的话通过http://域名/status就可以看到当前的php情况</p>
<p>　　下面介绍每个参数的作用：<br>　　pool：php-fpm池的名称，一般都是应该是www<br>　　process manage：进程的管理方法，php-fpm支持三种管理方法，分别是static,dynamic和ondemand，一般情况下都是dynamic<br>　　start time：php-fpm启动时候的时间，不管是restart或者reload都会更新这里的时间<br>　　start since：php-fpm自启动起来经过的时间，默认为秒<br>　　accepted conn：当前接收的连接数<br>　　listen queue：在队列中等待连接的请求个数，如果这个数字为非0，那么最好增加进程的fpm个数<br>　　max listen queue：从fpm启动以来，在队列中等待连接请求的最大值<br>　　listen queue len：等待连接的套接字队列大小<br>　　idle processes：空闲的进程个数<br>　　active processes：活动的进程个数<br>　　total processes：总共的进程个数<br>　　max active processes：从fpm启动以来，活动进程的最大个数，如果这个值小于当前的max_children，可以调小此值<br>　　max children reached：当pm尝试启动更多的进程，却因为max_children的限制，没有启动更多进程的次数。如果这个值非0，那么可以适当增加fpm的进程数<br>　　slow requests：慢请求的次数，一般如果这个值未非0，那么可能会有慢的php进程，一般一个不好的mysql查询是最大的祸首。</p>
<p>7.开启php-fpm慢日志</p>
<p>　　slowlog = /usr/local/php/log/php-fpm.log.slow</p>
<p>　　request_slowlog_timeout = 5s</p>
<p>8.设置php-fpm单次请求最大执行时间，今天碰到一个问题，测试服务器php-fpm一直是被占满状态，后来发现是set_time_limit(0)，file_get_content()，原因如下:</p>
<p>　　比如file_get_contents(url)等函数，如果网站反应慢，会一直等在那儿不超时，php-fpm一直被占用。有一个参数 max_execution_time 可以设置 PHP 脚本的最大执行时间，但是，在 php-cgi(php-fpm) 中，该参数不会起效。真正能够控制 PHP 脚本最大执行时间的是 php-fpm.conf 配置文件中的以下参数。</p>
<p>　　request_terminate_timeout = 10s</p>
<p>　　默认值为 0 秒，也就是说，PHP 脚本会一直执行下去。这样，当所有的 php-cgi 进程都卡在 file_get_contents() 函数时，这台 Nginx+PHP 的 WebServer 已经无法再处理新的 PHP 请求了，Nginx 将给用户返回“502 Bad Gateway”。可以使用 request_terminate_timeout = 30s，但是如果发生 file_get_contents() 获取网页内容较慢的情况，这就意味着 150 个 php-cgi 进程，每秒钟只能处理 5 个请求，WebServer 同样很难避免“502 Bad Gateway”。php-cgi进程数不够用、php执行时间长、或者是php-cgi进程死掉，都会出现502错误。</p>
<p>　　要做到彻底解决，只能让 PHP 程序员们改掉直接使用 file_get_contents(“<a href="http://example.com/&quot;">http://example.com/&quot;</a>) 的习惯，而是稍微修改一下，加个超时时间，用以下方式来实现 HTTP GET 请求。要是觉得麻烦，可以自行将以下代码封装成一个函数。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    $ctx = stream_context_create(<span class="keyword">array</span>(  </span><br><span class="line">       <span class="string">&#x27;http&#x27;</span> =&gt; <span class="keyword">array</span>(  </span><br><span class="line">           <span class="string">&#x27;timeout&#x27;</span> =&gt; <span class="number">1</span> <span class="comment">//设置一个超时时间，单位为秒  </span></span><br><span class="line">           )  </span><br><span class="line">       )  </span><br><span class="line">    );  </span><br><span class="line">    file_get_contents(<span class="string">&quot;http://example.com/&quot;</span>, <span class="number">0</span>, $ctx);  </span><br></pre></td></tr></table></figure>



<p>　　当然，导致 php-cgi 进程 CPU 100% 的原因不只有这一种，那么，怎么确定是 file_get_contents() 函数导致的呢？</p>
<p>　　首先，使用 top 命令查看 CPU 使用率较高的 php-cgi 进程。</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">top</span> - <span class="number">10</span>:<span class="number">34</span>:<span class="number">18</span> up <span class="number">724</span> days, <span class="number">21</span>:<span class="number">01</span>,  <span class="number">3</span> users,  load average: <span class="number">17</span>.<span class="number">86</span>, <span class="number">11</span>.<span class="number">16</span>, <span class="number">7</span>.<span class="number">69</span></span><br><span class="line"><span class="attribute">Tasks</span>: <span class="number">561</span> total,  <span class="number">15</span> running, <span class="number">546</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line"><span class="attribute">Cpu</span>(s):  <span class="number">5</span>.<span class="number">9</span>%us,  <span class="number">4</span>.<span class="number">2</span>%sy,  <span class="number">0</span>.<span class="number">0</span>%ni, <span class="number">89</span>.<span class="number">4</span>%id,  <span class="number">0</span>.<span class="number">2</span>%wa,  <span class="number">0</span>.<span class="number">0</span>%hi,  <span class="number">0</span>.<span class="number">2</span>%si,  <span class="number">0</span>.<span class="number">0</span>%st</span><br><span class="line"><span class="attribute">Mem</span>:   <span class="number">8100996</span>k total,  <span class="number">4320108</span>k used,  <span class="number">3780888</span>k free,   <span class="number">772572</span>k buffers</span><br><span class="line"><span class="attribute">Swap</span>:  <span class="number">8193108</span>k total,    <span class="number">50776</span>k used,  <span class="number">8142332</span>k free,   <span class="number">412088</span>k cached</span><br><span class="line"></span><br><span class="line">  <span class="attribute">PID</span> USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                              </span><br><span class="line"><span class="attribute">10747</span> www       <span class="number">18</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">22</span>m  <span class="number">12</span>m R <span class="number">100</span>.<span class="number">6</span> <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">02</span>.<span class="number">60</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10709</span> www       <span class="number">16</span>   <span class="number">0</span>  <span class="number">359</span>m  <span class="number">28</span>m  <span class="number">17</span>m R <span class="number">96</span>.<span class="number">8</span>  <span class="number">0</span>.<span class="number">4</span>    <span class="number">0</span>:<span class="number">11</span>.<span class="number">34</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10745</span> www       <span class="number">18</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">24</span>m  <span class="number">14</span>m R <span class="number">94</span>.<span class="number">8</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">39</span>.<span class="number">51</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10707</span> www       <span class="number">18</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">25</span>m  <span class="number">14</span>m S <span class="number">77</span>.<span class="number">4</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">33</span>.<span class="number">48</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10782</span> www       <span class="number">20</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">26</span>m  <span class="number">15</span>m R <span class="number">75</span>.<span class="number">5</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">10</span>.<span class="number">93</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10708</span> www       <span class="number">25</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">22</span>m  <span class="number">12</span>m R <span class="number">69</span>.<span class="number">7</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">45</span>.<span class="number">16</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10683</span> www       <span class="number">25</span>   <span class="number">0</span>  <span class="number">362</span>m  <span class="number">28</span>m  <span class="number">15</span>m R <span class="number">54</span>.<span class="number">2</span>  <span class="number">0</span>.<span class="number">4</span>    <span class="number">0</span>:<span class="number">32</span>.<span class="number">65</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10711</span> www       <span class="number">25</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">25</span>m  <span class="number">15</span>m R <span class="number">52</span>.<span class="number">2</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">44</span>.<span class="number">25</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10688</span> www       <span class="number">25</span>   <span class="number">0</span>  <span class="number">359</span>m  <span class="number">25</span>m  <span class="number">15</span>m R <span class="number">38</span>.<span class="number">7</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">10</span>.<span class="number">44</span> php-cgi                                                                                                              </span><br><span class="line"><span class="attribute">10719</span> www       <span class="number">25</span>   <span class="number">0</span>  <span class="number">360</span>m  <span class="number">26</span>m  <span class="number">16</span>m R  <span class="number">7</span>.<span class="number">7</span>  <span class="number">0</span>.<span class="number">3</span>    <span class="number">0</span>:<span class="number">40</span>.<span class="number">59</span> php-cgi</span><br></pre></td></tr></table></figure>

<p>　　找其中一个 CPU 100% 的 php-cgi 进程的 PID，用以下命令跟踪一下：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">strace -p <span class="number">10747</span></span><br></pre></td></tr></table></figure>

<p>　　如果屏幕显示：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br><span class="line">select(<span class="number">7</span>, [<span class="number">6</span>], [<span class="number">6</span>], [], &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)        = <span class="number">1</span> (<span class="keyword">out</span> [<span class="number">6</span>], left &#123;<span class="number">15</span>, <span class="number">0</span>&#125;)</span><br><span class="line">poll([&#123;fd=<span class="number">6</span>, events=POLLIN&#125;], <span class="number">1</span>, <span class="number">0</span>)     = <span class="number">0</span> (Timeout)</span><br></pre></td></tr></table></figure>

<p>　　那么，就可以确定是 file_get_contents() 导致的问题了。(参考:<a href="http://zyan.cc/tags/request_terminate_timeout/1/">http://zyan.cc/tags/request_terminate_timeout/1/</a>)</p>
<p>9.查看php-fpm启动时间(可以得出执行了多长时间)</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">ps -A -o pid,lstart,<span class="keyword">cmd</span><span class="bash"> |grep php-fpm</span></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(一)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/</url>
    <content><![CDATA[<h2 id="首先准备实验环境"><a href="#首先准备实验环境" class="headerlink" title="首先准备实验环境"></a>首先准备实验环境</h2><table>
<thead>
<tr>
<th>虚拟机</th>
<th>主机名</th>
<th>IP地址</th>
<th>服务</th>
<th>系统版本</th>
<th>内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>Vmware Workstation 14</td>
<td>gitlab.example.com</td>
<td>20.10.1.249</td>
<td>gitlab</td>
<td>CentOS Linux release 7.5.1804 (Core)</td>
<td>3.10.0-862.el7.x86_64</td>
</tr>
<tr>
<td></td>
<td>jenkins.example.com</td>
<td>192.168.244.131</td>
<td>jenkis</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ansible.example.com</td>
<td>192.168.244.132</td>
<td>asible</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="hosts解析"><a href="#hosts解析" class="headerlink" title="hosts解析"></a>hosts解析</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">20.10.1.249 gitlab.example.com</span><br><span class="line">192.168.244.131 jenkins.example.com</span><br><span class="line">192.168.244.132 ansible.example.com</span><br></pre></td></tr></table></figure>

<h2 id="关闭防火墙和selinux"><a href="#关闭防火墙和selinux" class="headerlink" title="关闭防火墙和selinux"></a>关闭防火墙和selinux</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># sed -i &quot;s/enforcing/disabled/&quot; /etc/selinux/config</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># systemctl stop firewalld &amp;&amp; systemmctl disable firewalld</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># reboot</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># getenforce</span></span><br><span class="line">Permissive</span><br><span class="line">[root@server01 ~]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure>

<h2 id="安装postfix并启动"><a href="#安装postfix并启动" class="headerlink" title="安装postfix并启动"></a>安装postfix并启动</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum install postfix</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># systemctl start postfix &amp;&amp; systemctl enable postfix</span></span><br></pre></td></tr></table></figure>

<h2 id="安装Gitlab组件及gitlab-ce"><a href="#安装Gitlab组件及gitlab-ce" class="headerlink" title="安装Gitlab组件及gitlab-ce"></a>安装Gitlab组件及gitlab-ce</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum install curl policycoreutils openssh-server openssh-clients</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># yum install -y gitlab-ce </span></span><br></pre></td></tr></table></figure>

<h2 id="也可以去https-packages-gitlab-com-gitlab-gitlab-ce-packages-el-7-gitlab-ce-10-0-0-ce-0-el7-x86-64-rpm安装方法。"><a href="#也可以去https-packages-gitlab-com-gitlab-gitlab-ce-packages-el-7-gitlab-ce-10-0-0-ce-0-el7-x86-64-rpm安装方法。" class="headerlink" title="也可以去https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。"></a>也可以去<a href="https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E3%80%82">https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。</a></h2><h2 id="证书创建与配置加载"><a href="#证书创建与配置加载" class="headerlink" title="证书创建与配置加载"></a>证书创建与配置加载</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># mkdir -p /etc/gitlab/ssl </span></span><br><span class="line"><span class="comment">#创建私有密钥 </span></span><br><span class="line">[root@gitlab ~]<span class="comment"># openssl genrsa -out &quot;/etc/gitlab/ssl/gitlab.key&quot; 2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建私有证书</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># openssl req -new -key &quot;/etc/gitlab/ssl/gitlab.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.csr&quot;</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:sh</span><br><span class="line">Locality Name (eg, city) [Default City]:sh</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:  <span class="comment">#输入空格，然后回车</span></span><br><span class="line">Organizational Unit Name (eg, section) []:  <span class="comment">#输入空格，然后回车</span></span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:gitlab.example.com</span></span><br><span class="line"><span class="string">Email Address []:admin@example.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:123456</span></span><br><span class="line"><span class="string">An optional company name []:  #直接回车</span></span><br><span class="line"><span class="string"># 查看</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 8</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1066 Jan  2 15:32 gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 Jan  2 15:30 gitlab.example.com.key</span></span><br><span class="line"><span class="string"># 接下来利用私有密钥和私有证书创建CRT签署证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]#  openssl x509 -req -days 365 -in &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot; -signkey &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line"><span class="string">Signature ok</span></span><br><span class="line"><span class="string">subject=/C=cn/ST=sh/L=sh/O= /OU= /CN=gitlab.sugw.io/emailAddress=suguowei@sugw.io</span></span><br><span class="line"><span class="string">Getting Private key</span></span><br><span class="line"><span class="string"># 查看</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 12</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br><span class="line"><span class="string">利用openssl命令输出pem证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]# openssl dhparam -out /etc/gitlab/ssl/dhparam.pem 2048</span></span><br><span class="line"><span class="string">Generating DH parameters, 2048 bit long safe prime, generator 2</span></span><br><span class="line"><span class="string">This is going to take a long time</span></span><br><span class="line"><span class="string">........................................................+................................................................................+.....................................+..................................................................................+..............................................+..................................................................................................................................+..+........................................................................................................................................+..............................................................................................................................................................................+......+..............+.....................................................+.................+.......................................................................................+..+.................................................................................................................................................+..........................................................+.............+.........+...........................................................+........................................................................................................................................................................................................................................+...................................................................................................................................................................................................................................................................................................................++*++*</span></span><br><span class="line"><span class="string">#  这个过程有点久</span></span><br><span class="line"><span class="string"># 查看生成的证书</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 16</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root  424 11月 27 04:11 dhparam.pem</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br><span class="line"><span class="string">更改文件权限</span></span><br><span class="line"><span class="string">[root@gitlab ~]# chmod 600 /etc/gitlab/ssl/*</span></span><br><span class="line"><span class="string">[root@gitlab ~]# ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total 16</span></span><br><span class="line"><span class="string">-rw------- 1 root root  424 11月 27 04:11 dhparam.pem</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1062 11月 27 04:07 gitlab.csr</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1679 11月 27 04:03 gitlab.key</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1249 11月 27 04:08 gitlab.sugw.io.crt</span></span><br></pre></td></tr></table></figure>

<h2 id="配置gitlab"><a href="#配置gitlab" class="headerlink" title="配置gitlab"></a>配置gitlab</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># cp /etc/gitlab/gitlab.rb&#123;,.bak&#125;</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/gitlab/gitlab.rb</span></span><br><span class="line"><span class="comment">## 更改如下</span></span><br><span class="line"> 13 external_url <span class="string">&#x27;https://gitlab.example.com&#x27;</span> </span><br><span class="line">952 nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">964 nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line">965 nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span></span><br><span class="line">979 <span class="comment"># nginx[&#x27;ssl_dhparam&#x27;] = /etc/gitlab/ssl/dhparam.pem # Path to dhparams.pem,      eg. /etc/gitlab/ssl/dhparams.pem</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化gitlab相关服务配置"><a href="#初始化gitlab相关服务配置" class="headerlink" title="初始化gitlab相关服务配置"></a>初始化gitlab相关服务配置</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">。。。。过程有点长，需要等一会（看个人服务器配置了）</span><br><span class="line">Running handlers:</span><br><span class="line">Running handlers complete</span><br><span class="line">Chef<span class="built_in"> Client </span>finished, 454/655 resources updated <span class="keyword">in</span> 02 minutes 16 seconds</span><br><span class="line">gitlab Reconfigured!</span><br><span class="line"><span class="comment"># 出现这个表示配置没有问题！</span></span><br></pre></td></tr></table></figure>

<h2 id="对nginx配置"><a href="#对nginx配置" class="headerlink" title="对nginx配置"></a>对nginx配置</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp <span class="regexp">/var/</span>opt<span class="regexp">/gitlab/</span>nginx<span class="regexp">/conf/gi</span>tlab-http.conf&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim <span class="regexp">/var/</span>opt<span class="regexp">/gitlab/</span>nginx<span class="regexp">/conf/gi</span>tlab-http.conf</span><br><span class="line"> <span class="number">37</span>   server_name gitlab.example.com; #在此行下面添加<span class="number">38</span>行的内容</span><br><span class="line"> <span class="number">38</span>   rewrite ^(.*)$ https:<span class="comment">//$host$1 permanent;</span></span><br></pre></td></tr></table></figure>

<p>重启gitlab</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl restart</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: alertmanager: (pid 6526) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitaly: (pid 6543) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitlab-monitor: (pid 6556) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitlab-workhorse: (pid 6579) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: logrotate: (pid 6589) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: nginx: (pid 6597) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: node-exporter: (pid 6681) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: postgres-exporter: (pid 6687) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: postgresql: (pid 6698) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: prometheus: (pid 6706) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: redis: (pid 6722) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: redis-exporter: (pid 6856) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: sidekiq: (pid 6866) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: unicorn: (pid 6880) 0s</span></span><br><span class="line"><span class="comment">#  可以看出gitlab的所有服务重启完成</span></span><br></pre></td></tr></table></figure>

<h2 id="使用宿主访问gitlab-sugw-io-80"><a href="#使用宿主访问gitlab-sugw-io-80" class="headerlink" title="使用宿主访问gitlab.sugw.io:80"></a>使用宿主访问gitlab.sugw.io:80</h2><img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164045215-3943660.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164153110-1651878067.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164224914-827989240.png" class title="img">

<p>开始使用gitlab</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164356206-501778199.png" class title="img">

<p>创建一个测试工程</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164555544-1084217569.png" class title="img">

<p>复制仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164808408-621505099.png" class title="img">

<p>回到win10宿主机，重新打开一个git命令行窗口如下所示操作</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102165212447-658335923.png" class title="img">

<p># 粘贴仓库地址回车后会弹出输入账户和密码的窗口</p>
<p>之后就会将空的测试仓库克隆到本地宿主机的桌面上的repo目录下</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ git -c http.sslVerify=false clone https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>test-repo.git</span><br><span class="line">Cloning into <span class="string">&#x27;test-repo&#x27;</span>...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ pwd</span><br><span class="line"><span class="regexp">/c/</span>Users<span class="regexp">/xueji/</span>Desktop/repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo/</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ ls test-repo/</span><br></pre></td></tr></table></figure>

<p>在win10宿主机下的test-repo目录下新建一个test.py文件，并上传至gitlab</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd test-repo/</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ vi test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git <span class="builtin-name">add</span> .</span><br><span class="line">warning: LF will be replaced by CRLF <span class="keyword">in</span> test.py.</span><br><span class="line">The file will have its original line endings <span class="keyword">in</span> your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">[master (root-commit) 93bd740] First Commit</span><br><span class="line"> Committer: unknown &lt;xueji@pin.com&gt;</span><br><span class="line">Your name <span class="keyword">and</span> email<span class="built_in"> address </span>were configured automatically based</span><br><span class="line">on your username <span class="keyword">and</span> hostname. Please check that they are accurate.</span><br><span class="line">You can suppress this message by setting them explicitly. <span class="builtin-name">Run</span> the</span><br><span class="line">following command <span class="keyword">and</span> follow the instructions <span class="keyword">in</span> your editor <span class="keyword">to</span> edit</span><br><span class="line">your configuration file:</span><br><span class="line"></span><br><span class="line">    git<span class="built_in"> config </span>--global --edit</span><br><span class="line"></span><br><span class="line">After doing this, you may fix the<span class="built_in"> identity </span>used <span class="keyword">for</span> this commit with:</span><br><span class="line"></span><br><span class="line">    git commit --amend --reset-author</span><br><span class="line"></span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git<span class="built_in"> config </span> --global user.email <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git<span class="built_in"> config </span>--global user.name <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">Your branch is based on <span class="string">&#x27;origin/master&#x27;</span>, but the upstream is gone.</span><br><span class="line">  (use <span class="string">&quot;git branch --unset-upstream&quot;</span> <span class="keyword">to</span> fixup)</span><br><span class="line"></span><br><span class="line"><span class="literal">nothing</span> <span class="keyword">to</span> commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git -c http.<span class="attribute">sslVerify</span>=<span class="literal">false</span> push master</span><br><span class="line">fatal: <span class="string">&#x27;master&#x27;</span> does <span class="keyword">not</span> appear <span class="keyword">to</span> be a git repository</span><br><span class="line">fatal: Could <span class="keyword">not</span> read <span class="keyword">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line"><span class="keyword">and</span> the repository exists.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br></pre></td></tr></table></figure>

<p>报错，跟据提示信息我们进行如下操作</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git branch --unset-upstream</span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git config --<span class="built_in">global</span> user.email <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git config --<span class="built_in">global</span> user.name <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;Second Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> push origin master</span><br><span class="line">Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">242</span> bytes | <span class="number">242.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line"> * [<span class="keyword">new</span> branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>回到gitlab的浏览器页面，刷新查看</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172541680-1685258190.png" class title="img">

<p>已经成功上传到test-repo工程当中。</p>
<p>Gitlab应用</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172834006-957477766.png" class title="img">

<p>比如说Systeminfo</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173017476-1297762493.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173108736-1671134778.png" class title="img">

<p>比如说日志</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173204986-1045231309.png" class title="img">

<p>需要我们关注的是application.log和production.log两项</p>
<p>比如说健康状况</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173522576-1583433372.png" class title="img">

<p>创建开发人员及leader的账号</p>
<p>开发人员账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173648091-57729423.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173839541-132784246.png" class title="img">

<p>其他选项不要动，点击创建即可。</p>
<p>创建leader的账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174006279-1152234077.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174112736-1497099430.png" class title="img">

<p>其他也不要动。</p>
<p>建好后的账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174214548-2047513172.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174323576-45552471.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174428809-1250049533.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174525431-600068675.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174619643-830800285.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174809969-1580189936.png" class title="img">

<p>同理添加lead账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175038572-8109703.png" class title="img">

<p>更改两个账户的密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175340108-1125836966.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175430628-339857982.png" class title="img">

<p>其他选项保持不变，然后点击页面最下面的save changes，同理更改lead的密码</p>
<p>使用dev账户进行git命令行的提交操作</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">## 以下步骤也是在win10宿主机上进行的</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ pwd</span><br><span class="line">/c/Users/xueji/Desktop/repo/test-repo</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ cd ..</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ rm -rf test-repo/</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> clone https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line">Cloning <span class="built_in">int</span>o <span class="string">&#x27;test-repo&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">remote: Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">#  这一步就很尴尬了，本来是想要验证dev账户的，谁知道什么都不需要输入就直接可以clone下来。</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ ls test-repo/</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd test-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git checkout -b release<span class="number">-1.0</span>   #创建开发人员版本</span><br><span class="line">Switched to a new branch <span class="string">&#x27;release-1.0&#x27;</span></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ ls</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ vim test.py</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ cat test.py</span><br><span class="line">print(<span class="string">&quot;This is a test python file for release-1.0!&quot;</span>)</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> push origin release<span class="number">-1.0</span></span><br><span class="line">Enumerating objects: <span class="number">5</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">5</span>/<span class="number">5</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">287</span> bytes | <span class="number">287.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">remote:</span><br><span class="line">remote: To create a merge request <span class="keyword">for</span> release<span class="number">-1.0</span>, visit:</span><br><span class="line">remote:   https:<span class="comment">//gitlab.example.com/root/test-repo/merge_requests/new?merge_request%5Bsource_branch%5D=release-1.0</span></span><br><span class="line">remote:</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line"> * [new branch]      release<span class="number">-1.0</span> -&gt; release<span class="number">-1.0</span></span><br><span class="line">#  我靠，估计版本不一样，这一步不需要输入账户名和密码</span><br></pre></td></tr></table></figure>

<p>返回gitlab的浏览器页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180851535-2098739677.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180912746-365779940.png" class title="img">

<p> 使用开发账户登录</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202149369-1982672005.png" class title="img">

<p>设置新密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202530519-730722560.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202651084-1127147532.png" class title="img">

<p> 至此，gitlab安装配置完成，接下来演示gitlab应用：</p>
<p>开发人员创建一个分支，然后发申请到主管请求合并到主分支，</p>
<p>回到gitbash命令行，首先删除之前的test-repo目录：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080255311-216023418.png" class title="img">

<p>然后使用dev账号登陆gitlab，并复制gitlab仓库地址：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080504843-764533681.png" class title="img">

<p>本地提交并推送到gitlab远端：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080550570-591512284.png" class title="img">

<p>开始提交合并到主分支的申请</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080711039-283092739.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080747722-293518077.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081015734-905282817.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081027714-647433423.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081223203-663097162.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081345859-1974744297.png" class title="img">

<p>接着退出当前的dev账号，使用lead账号登录，同样lead账号首次登录需要更改密码，步骤同dev一样：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081654799-1325405956.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081737842-576013049.png" class title="img">

 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081834712-1983955035.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082118521-107543261.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082235982-1151283651.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082302424-429176945.png" class title="img">



 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082334050-1662187133.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082350221-411675038.png" class title="img">

<p>jenkins的配置与使用见Jenkins+Gitlab+Ansible自动化部署(二)首先准备实验环境</p>
<table>
<thead>
<tr>
<th>虚拟机</th>
<th>主机名</th>
<th>IP地址</th>
<th>服务</th>
<th>系统版本</th>
<th>内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>Vmware Workstation 14</td>
<td>gitlab.example.com</td>
<td>192.168.244.130</td>
<td>gitlab</td>
<td>CentOS Linux release 7.5.1804 (Core)</td>
<td>3.10.0-862.el7.x86_64</td>
</tr>
<tr>
<td>jenkins.example.com</td>
<td>192.168.244.131</td>
<td>jenkis</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ansible.example.com</td>
<td>192.168.244.132</td>
<td>asible</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>除此之外，还要在宿主机win10系统下的C:\Windows\System32\drivers\etc\hosts文件中添加如下内容</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168.244.130</span> gitlab.example.com</span><br><span class="line"><span class="number">192.168.244.131</span> jenkins.example.com</span><br><span class="line"><span class="number">192.168.244.132</span> ansible.example.com</span><br></pre></td></tr></table></figure>

<p>关闭防火墙和selinux</p>
<p>[</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# sed -i <span class="string">&quot;s/enforcing/disabled/&quot;</span> /etc/selinux/config</span><br><span class="line">[root@gitlab ~]# systemctl stop firewalld &amp;&amp; systemmctl <span class="builtin-name">disable</span> firewalld</span><br><span class="line">[root@gitlab ~]# reboot</span><br><span class="line">[root@gitlab ~]# getenforce</span><br><span class="line">Permissive</span><br><span class="line">[root@server01 ~]# systemctl status firewalld</span><br><span class="line">● firewalld.service - firewalld - dynamic<span class="built_in"> firewall </span>daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>安装postfix并启动</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">[root<span class="symbol">@gitlab</span> ~]<span class="meta"># yum install postfix</span></span><br><span class="line">[root<span class="symbol">@gitlab</span> ~]<span class="meta"># systemctl start postfix &amp;&amp; systemctl enable postfix</span></span><br></pre></td></tr></table></figure>

<p>安装Gitlab组件及gitlab-ce</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">[root<span class="symbol">@gitlab</span> ~]<span class="meta"># yum install curl policycoreutils openssh-server openssh-clients</span></span><br><span class="line">[root<span class="symbol">@gitlab</span> ~]<span class="meta"># curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span></span><br><span class="line">[root<span class="symbol">@gitlab</span> ~]<span class="meta"># yum install -y gitlab-ce </span></span><br></pre></td></tr></table></figure>

<p>也可以去<a href="https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E3%80%82">https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.0.0-ce.0.el7.x86_64.rpm安装方法。</a></p>
<p>证书创建与配置加载</p>
<p>[</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># mkdir -p /etc/gitlab/ssl </span></span><br><span class="line"><span class="string">创建私有密钥</span> </span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># openssl genrsa -out &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;  2048</span></span><br><span class="line"><span class="string">Generating</span> <span class="string">RSA</span> <span class="string">private</span> <span class="string">key,</span> <span class="number">2048 </span><span class="string">bit</span> <span class="string">long</span> <span class="string">modulus</span></span><br><span class="line"><span class="string">...............+++</span></span><br><span class="line"><span class="string">...............................................................................+++</span></span><br><span class="line"><span class="string">e</span> <span class="string">is</span> <span class="number">65537</span> <span class="string">(0x10001)</span></span><br><span class="line"><span class="string">创建私有证书</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># openssl req -new -key &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;  -out &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot;</span></span><br><span class="line"><span class="string">You</span> <span class="string">are</span> <span class="string">about</span> <span class="string">to</span> <span class="string">be</span> <span class="string">asked</span> <span class="string">to</span> <span class="string">enter</span> <span class="string">information</span> <span class="string">that</span> <span class="string">will</span> <span class="string">be</span> <span class="string">incorporated</span></span><br><span class="line"><span class="string">into</span> <span class="string">your</span> <span class="string">certificate</span> <span class="string">request.</span></span><br><span class="line"><span class="string">What</span> <span class="string">you</span> <span class="string">are</span> <span class="string">about</span> <span class="string">to</span> <span class="string">enter</span> <span class="string">is</span> <span class="string">what</span> <span class="string">is</span> <span class="string">called</span> <span class="string">a</span> <span class="string">Distinguished</span> <span class="string">Name</span> <span class="string">or</span> <span class="string">a</span> <span class="string">DN.</span></span><br><span class="line"><span class="string">There</span> <span class="string">are</span> <span class="string">quite</span> <span class="string">a</span> <span class="string">few</span> <span class="string">fields</span> <span class="string">but</span> <span class="string">you</span> <span class="string">can</span> <span class="string">leave</span> <span class="string">some</span> <span class="string">blank</span></span><br><span class="line"><span class="string">For</span> <span class="string">some</span> <span class="string">fields</span> <span class="string">there</span> <span class="string">will</span> <span class="string">be</span> <span class="string">a</span> <span class="string">default</span> <span class="string">value,</span></span><br><span class="line"><span class="string">If</span> <span class="string">you</span> <span class="string">enter</span> <span class="string">&#x27;.&#x27;</span><span class="string">,</span> <span class="string">the</span> <span class="string">field</span> <span class="string">will</span> <span class="string">be</span> <span class="string">left</span> <span class="string">blank.</span></span><br><span class="line"><span class="string">-----</span></span><br><span class="line"><span class="string">Country</span> <span class="string">Name</span> <span class="string">(2</span> <span class="string">letter</span> <span class="string">code)</span> [<span class="string">XX</span>]<span class="string">:cn</span></span><br><span class="line"><span class="string">State</span> <span class="string">or</span> <span class="string">Province</span> <span class="string">Name</span> <span class="string">(full</span> <span class="string">name)</span> []<span class="string">:sh</span></span><br><span class="line"><span class="string">Locality</span> <span class="string">Name</span> <span class="string">(eg,</span> <span class="string">city)</span> [<span class="string">Default</span> <span class="string">City</span>]<span class="string">:sh</span></span><br><span class="line"><span class="string">Organization</span> <span class="string">Name</span> <span class="string">(eg,</span> <span class="string">company)</span> [<span class="string">Default</span> <span class="string">Company</span> <span class="string">Ltd</span>]<span class="string">:</span>  <span class="comment">#输入空格，然后回车</span></span><br><span class="line"><span class="string">Organizational</span> <span class="string">Unit</span> <span class="string">Name</span> <span class="string">(eg,</span> <span class="string">section)</span> []<span class="string">:</span>  <span class="comment">#输入空格，然后回车</span></span><br><span class="line"><span class="string">Common</span> <span class="string">Name</span> <span class="string">(eg,</span> <span class="string">your</span> <span class="string">name</span> <span class="string">or</span> <span class="string">your</span> <span class="string">server&#x27;s</span> <span class="string">hostname)</span> []<span class="string">:gitlab.example.com</span></span><br><span class="line"><span class="string">Email</span> <span class="string">Address</span> []<span class="string">:admin@example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">Please</span> <span class="string">enter</span> <span class="string">the</span> <span class="string">following</span> <span class="string">&#x27;extra&#x27;</span> <span class="string">attributes</span></span><br><span class="line"><span class="string">to</span> <span class="string">be</span> <span class="string">sent</span> <span class="string">with</span> <span class="string">your</span> <span class="string">certificate</span> <span class="string">request</span></span><br><span class="line"><span class="string">A</span> <span class="string">challenge</span> <span class="string">password</span> []<span class="string">:123456</span></span><br><span class="line"><span class="string">An</span> <span class="string">optional</span> <span class="string">company</span> <span class="string">name</span> []<span class="string">:</span>  <span class="comment">#直接回车</span></span><br><span class="line"><span class="string">查看</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total</span> <span class="number">8</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1066 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:32</span> <span class="string">gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:30</span> <span class="string">gitlab.example.com.key</span></span><br><span class="line"><span class="string">接下来利用私有密钥和私有证书创建CRT签署证书</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># openssl x509 -req -days 365 -in &quot;/etc/gitlab/ssl/gitlab.example.com.csr&quot; -signkey &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot; -out &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line"><span class="string">Signature</span> <span class="string">ok</span></span><br><span class="line"><span class="string">subject=/C=cn/ST=sh/L=sh/O=</span> <span class="string">/OU=</span> <span class="string">/CN=gitlab.example.com/emailAddress=admin@example.com</span></span><br><span class="line"><span class="string">Getting</span> <span class="string">Private</span> <span class="string">key</span></span><br><span class="line"><span class="string">查看</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total</span> <span class="number">12</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1265 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:39</span> <span class="string">gitlab.example.com.crt</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1066 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:32</span> <span class="string">gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:30</span> <span class="string">gitlab.example.com.key</span></span><br><span class="line"><span class="string">利用openssl命令输出pem证书</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># openssl dhparam -out /etc/gitlab/ssl/dhparam.pem 2048</span></span><br><span class="line"><span class="string">Generating</span> <span class="string">DH</span> <span class="string">parameters,</span> <span class="number">2048 </span><span class="string">bit</span> <span class="string">long</span> <span class="string">safe</span> <span class="string">prime,</span> <span class="string">generator</span> <span class="number">2</span></span><br><span class="line"><span class="string">This</span> <span class="string">is</span> <span class="string">going</span> <span class="string">to</span> <span class="string">take</span> <span class="string">a</span> <span class="string">long</span> <span class="string">time</span></span><br><span class="line"><span class="string">........................................................+................................................................................+.....................................+..................................................................................+..............................................+..................................................................................................................................+..+........................................................................................................................................+..............................................................................................................................................................................+......+..............+.....................................................+.................+.......................................................................................+..+.................................................................................................................................................+..........................................................+.............+.........+...........................................................+........................................................................................................................................................................................................................................+...................................................................................................................................................................................................................................................................................................................++*++*</span></span><br><span class="line"><span class="comment">#  这个过程有点久</span></span><br><span class="line"><span class="comment"># 查看生成的证书</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total</span> <span class="number">16</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">424</span> <span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:46</span> <span class="string">dhparam.pem</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1265 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:39</span> <span class="string">gitlab.example.com.crt</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1066 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:32</span> <span class="string">gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:30</span> <span class="string">gitlab.example.com.key</span></span><br><span class="line"><span class="string">更改文件权限</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># chmod 600 /etc/gitlab/ssl/*</span></span><br><span class="line">[<span class="string">root@gitlab</span> <span class="string">~</span>]<span class="comment"># ll /etc/gitlab/ssl/</span></span><br><span class="line"><span class="string">total</span> <span class="number">16</span></span><br><span class="line"><span class="string">-rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">424</span> <span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:46</span> <span class="string">dhparam.pem</span></span><br><span class="line"><span class="string">-rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1265 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:39</span> <span class="string">gitlab.example.com.crt</span></span><br><span class="line"><span class="string">-rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1066 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:32</span> <span class="string">gitlab.example.com.csr</span></span><br><span class="line"><span class="string">-rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679 </span><span class="string">Jan</span>  <span class="number">2</span> <span class="number">15</span><span class="string">:30</span> <span class="string">gitlab.example.com.key</span></span><br></pre></td></tr></table></figure>

<p>[</p>
<p>配置gitlab</p>
<p>[</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp <span class="regexp">/etc/gi</span>tlab/gitlab.rb&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim <span class="regexp">/etc/gi</span>tlab/gitlab.rb</span><br><span class="line">## 更改如下</span><br><span class="line"> <span class="number">13</span> external_url <span class="string">&#x27;https://gitlab.example.com&#x27;</span>  <span class="number">13</span>行左右</span><br><span class="line"><span class="number">952</span> nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = <span class="keyword">true</span></span><br><span class="line"><span class="number">964</span> nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span></span><br><span class="line"><span class="number">965</span> nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span></span><br><span class="line"><span class="number">979</span> # nginx[<span class="string">&#x27;ssl_dhparam&#x27;</span>] = <span class="regexp">/etc/gi</span>tlab<span class="regexp">/ssl/</span>dhparam.pem # Path to dhparams.pem,      eg. <span class="regexp">/etc/gi</span>tlab<span class="regexp">/ssl/</span>dhparams.pem</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>初始化gitlab相关服务配置</p>
<p>[</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# gitlab-ctl reconfigure</span><br><span class="line">Starting Chef Client, version 13.6.4</span><br><span class="line">resolving cookbooks <span class="keyword">for</span> <span class="builtin-name">run</span> list: [<span class="string">&quot;gitlab&quot;</span>]</span><br><span class="line">Synchronizing Cookbooks:</span><br><span class="line">  - gitlab (0.0.1)</span><br><span class="line">  - package (0.1.0)</span><br><span class="line">  - postgresql (0.1.0)</span><br><span class="line">  - redis (0.1.0)</span><br><span class="line">  - mattermost (0.1.0)</span><br><span class="line">  - registry (0.1.0)</span><br><span class="line">  - gitaly (0.1.0)</span><br><span class="line">  - consul (0.0.0)</span><br><span class="line">  - nginx (0.1.0)</span><br><span class="line">  - runit (0.14.2)</span><br><span class="line">  - letsencrypt (0.1.0)</span><br><span class="line">  - acme (3.1.0)</span><br><span class="line">  - crond (0.1.0)</span><br><span class="line">  - compat_resource (12.19.0)</span><br><span class="line">Installing Cookbook Gems:</span><br><span class="line">Compiling Cookbooks<span class="built_in">..</span>.</span><br><span class="line">Recipe: gitlab::default</span><br><span class="line">  * directory[/etc/gitlab] action create</span><br><span class="line">    - change mode <span class="keyword">from</span> <span class="string">&#x27;0755&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;0775&#x27;</span></span><br><span class="line">  Converging 493 resources</span><br><span class="line">  * directory[/etc/gitlab] action create (up <span class="keyword">to</span> date)</span><br><span class="line">  * directory[Create /var/opt/gitlab] action create</span><br><span class="line">    - create new directory /var/opt/gitlab</span><br><span class="line">    - change mode <span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">    - change owner <span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    - change<span class="built_in"> group </span><span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">  * directory[/opt/gitlab/embedded/etc] action create</span><br><span class="line">    - create new directory /opt/gitlab/embedded/etc</span><br><span class="line">    - change mode <span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">    - change owner <span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    - change<span class="built_in"> group </span><span class="keyword">from</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">  * template[/opt/gitlab/embedded/etc/gitconfig] action create</span><br><span class="line">    - create new file /opt/gitlab/embedded/etc/gitconfig</span><br><span class="line">    - update content <span class="keyword">in</span> file /opt/gitlab/embedded/etc/gitconfig <span class="keyword">from</span> none <span class="keyword">to</span> 987af3</span><br><span class="line"></span><br><span class="line">。。。。过程有点长，需要等一会（看个人服务器配置了）</span><br><span class="line">Running handlers:</span><br><span class="line">Running handlers complete</span><br><span class="line">Chef<span class="built_in"> Client </span>finished, 454/655 resources updated <span class="keyword">in</span> 02 minutes 16 seconds</span><br><span class="line">gitlab Reconfigured!</span><br><span class="line"><span class="comment"># 出现这个表示配置没有问题！</span></span><br></pre></td></tr></table></figure>

<p>[</p>
<p>对nginx配置</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]# cp <span class="regexp">/var/</span>opt<span class="regexp">/gitlab/</span>nginx<span class="regexp">/conf/gi</span>tlab-http.conf&#123;,.bak&#125;</span><br><span class="line">[root@gitlab ~]# vim <span class="regexp">/var/</span>opt<span class="regexp">/gitlab/</span>nginx<span class="regexp">/conf/gi</span>tlab-http.conf</span><br><span class="line"> <span class="number">37</span>   server_name gitlab.example.com; #在此行下面添加<span class="number">38</span>行的内容</span><br><span class="line"> <span class="number">38</span>   rewrite ^(.*)$ https:<span class="comment">//$host$1 permanent;</span></span><br></pre></td></tr></table></figure>

<p>重启gitlab</p>
<p>[</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl restart</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: alertmanager: (pid 6526) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitaly: (pid 6543) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitlab-monitor: (pid 6556) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: gitlab-workhorse: (pid 6579) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: logrotate: (pid 6589) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: nginx: (pid 6597) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: node-exporter: (pid 6681) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: postgres-exporter: (pid 6687) 1s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: postgresql: (pid 6698) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: prometheus: (pid 6706) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: redis: (pid 6722) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: redis-exporter: (pid 6856) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: sidekiq: (pid 6866) 0s</span></span><br><span class="line">ok: <span class="keyword">run</span><span class="bash">: unicorn: (pid 6880) 0s</span></span><br><span class="line"><span class="comment">#  可以看出gitlab的所有服务重启完成</span></span><br></pre></td></tr></table></figure>

<p>[</p>
<p>使用宿主机win10下的chrome浏览器访问gitlab.example.com:80</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164045215-3943660-20201126184445518.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164153110-1651878067-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164224914-827989240-20201126184445611.png" class title="img">

<p>开始使用gitlab</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164356206-501778199-20201126184445496.png" class title="img">

<p>创建一个测试工程</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164555544-1084217569-20201126184445512.png" class title="img">

<p>复制仓库地址</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102164808408-621505099-20201126184446008.png" class title="img">

<p>回到win10宿主机，重新打开一个git命令行窗口如下所示操作</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102165212447-658335923-20201126184445579.png" class title="img">

<p># 粘贴仓库地址回车后会弹出输入账户和密码的窗口</p>
<p>之后就会将空的测试仓库克隆到本地宿主机的桌面上的repo目录下</p>
<p>[</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ git -c http.sslVerify=false clone https:<span class="regexp">//gi</span>tlab.example.com<span class="regexp">/root/</span>test-repo.git</span><br><span class="line">Cloning into <span class="string">&#x27;test-repo&#x27;</span>...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ pwd</span><br><span class="line"><span class="regexp">/c/</span>Users<span class="regexp">/xueji/</span>Desktop/repo</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo/</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo</span><br><span class="line">$ ls test-repo/</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>在win10宿主机下的test-repo目录下新建一个test.py文件，并上传至gitlab</p>
<p>[</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd test-repo/</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ vi test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git <span class="builtin-name">add</span> .</span><br><span class="line">warning: LF will be replaced by CRLF <span class="keyword">in</span> test.py.</span><br><span class="line">The file will have its original line endings <span class="keyword">in</span> your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">[master (root-commit) 93bd740] First Commit</span><br><span class="line"> Committer: unknown &lt;xueji@pin.com&gt;</span><br><span class="line">Your name <span class="keyword">and</span> email<span class="built_in"> address </span>were configured automatically based</span><br><span class="line">on your username <span class="keyword">and</span> hostname. Please check that they are accurate.</span><br><span class="line">You can suppress this message by setting them explicitly. <span class="builtin-name">Run</span> the</span><br><span class="line">following command <span class="keyword">and</span> follow the instructions <span class="keyword">in</span> your editor <span class="keyword">to</span> edit</span><br><span class="line">your configuration file:</span><br><span class="line"></span><br><span class="line">    git<span class="built_in"> config </span>--global --edit</span><br><span class="line"></span><br><span class="line">After doing this, you may fix the<span class="built_in"> identity </span>used <span class="keyword">for</span> this commit with:</span><br><span class="line"></span><br><span class="line">    git commit --amend --reset-author</span><br><span class="line"></span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line"> create mode 100644 test.py</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git<span class="built_in"> config </span> --global user.email <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git<span class="built_in"> config </span>--global user.name <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">Your branch is based on <span class="string">&#x27;origin/master&#x27;</span>, but the upstream is gone.</span><br><span class="line">  (use <span class="string">&quot;git branch --unset-upstream&quot;</span> <span class="keyword">to</span> fixup)</span><br><span class="line"></span><br><span class="line"><span class="literal">nothing</span> <span class="keyword">to</span> commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git -c http.<span class="attribute">sslVerify</span>=<span class="literal">false</span> push master</span><br><span class="line">fatal: <span class="string">&#x27;master&#x27;</span> does <span class="keyword">not</span> appear <span class="keyword">to</span> be a git repository</span><br><span class="line">fatal: Could <span class="keyword">not</span> read <span class="keyword">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line"><span class="keyword">and</span> the repository exists.</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>报错，跟据提示信息我们进行如下操作</p>
<p>[</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git branch --unset-upstream</span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git config --<span class="built_in">global</span> user.email <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git config --<span class="built_in">global</span> user.name <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;First Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;Second Commit&quot;</span></span><br><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"></span><br><span class="line">xueji<span class="meta">@xueji</span> MINGW64 ~<span class="regexp">/Desktop/</span>repo/test-repo (master)</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> push origin master</span><br><span class="line">Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">242</span> bytes | <span class="number">242.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line"> * [<span class="keyword">new</span> branch]      master -&gt; master</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>回到gitlab的浏览器页面，刷新查看</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172541680-1685258190-20201126184445604.png" class title="img">

<p>已经成功上传到test-repo工程当中。</p>
<p>Gitlab应用</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102172834006-957477766-20201126184445611.png" class title="img">

<p>比如说Systeminfo</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173017476-1297762493-20201126184445660.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173108736-1671134778-20201126184445736.png" class title="img">

<p>比如说日志</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173204986-1045231309-20201126184445725.png" class title="img">

<p>需要我们关注的是application.log和production.log两项</p>
<p>比如说健康状况</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173522576-1583433372-20201126184445693.png" class title="img">

<p>创建开发人员及leader的账号</p>
<p>开发人员账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173648091-57729423-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102173839541-132784246-20201126184445804.png" class title="img">

<p>其他选项不要动，点击创建即可。</p>
<p>创建leader的账号</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174006279-1152234077-20201126184445804.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174112736-1497099430-20201126184445855.png" class title="img">

<p>其他也不要动。</p>
<p>建好后的账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174214548-2047513172-20201126184445822.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174323576-45552471-20201126184445885.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174428809-1250049533-20201126184445881.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174525431-600068675-20201126184445868.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174619643-830800285-20201126184445911.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102174809969-1580189936-20201126184445953.png" class title="img">

<p>同理添加lead账户</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175038572-8109703-20201126184445956.png" class title="img">

<p>更改两个账户的密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175340108-1125836966-20201126184445994.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102175430628-339857982-20201126184445956.png" class title="img">

<p>其他选项保持不变，然后点击页面最下面的save changes，同理更改lead的密码</p>
<p>使用dev账户进行git命令行的提交操作</p>
<p>[</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">## 以下步骤也是在win10宿主机上进行的</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ pwd</span><br><span class="line">/c/Users/xueji/Desktop/repo/test-repo</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ cd ..</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ rm -rf test-repo/</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> clone https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line">Cloning <span class="built_in">int</span>o <span class="string">&#x27;test-repo&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">3</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">remote: Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</span><br><span class="line">#  这一步就很尴尬了，本来是想要验证dev账户的，谁知道什么都不需要输入就直接可以clone下来。</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ ls</span><br><span class="line">test-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ ls test-repo/</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd test-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (master)</span><br><span class="line">$ git checkout -b release<span class="number">-1.0</span>   #创建开发人员版本</span><br><span class="line">Switched to a new branch <span class="string">&#x27;release-1.0&#x27;</span></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ ls</span><br><span class="line">test.py</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ vim test.py</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ cat test.py</span><br><span class="line">print(<span class="string">&quot;This is a test python file for release-1.0!&quot;</span>)</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/test-repo (release<span class="number">-1.0</span>)</span><br><span class="line">$ git -c http.sslVerify=<span class="literal">false</span> push origin release<span class="number">-1.0</span></span><br><span class="line">Enumerating objects: <span class="number">5</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">5</span>/<span class="number">5</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">287</span> bytes | <span class="number">287.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">3</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">remote:</span><br><span class="line">remote: To create a merge request <span class="keyword">for</span> release<span class="number">-1.0</span>, visit:</span><br><span class="line">remote:   https:<span class="comment">//gitlab.example.com/root/test-repo/merge_requests/new?merge_request%5Bsource_branch%5D=release-1.0</span></span><br><span class="line">remote:</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/test-repo.git</span></span><br><span class="line"> * [new branch]      release<span class="number">-1.0</span> -&gt; release<span class="number">-1.0</span></span><br><span class="line">#  我靠，估计版本不一样，这一步不需要输入账户名和密码</span><br></pre></td></tr></table></figure>

<p>[</p>
<p>返回gitlab的浏览器页面</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180851535-2098739677-20201126184446074.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102180912746-365779940-20201126184446074.png" class title="img">

<p> 使用开发账户登录</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202149369-1982672005-20201126184446054.png" class title="img">

<p>设置新密码</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202530519-730722560-20201126184446048.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190102202651084-1127147532-20201126184446161.png" class title="img">

<p> 至此，gitlab安装配置完成，接下来演示gitlab应用：</p>
<p>开发人员创建一个分支，然后发申请到主管请求合并到主分支，</p>
<p>回到gitbash命令行，首先删除之前的test-repo目录：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080255311-216023418-20201126184446016.png" class title="img">

<p>然后使用dev账号登陆gitlab，并复制gitlab仓库地址：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080504843-764533681-20201126184446171.png" class title="img">

<p>本地提交并推送到gitlab远端：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080550570-591512284-20201126184446196.png" class title="img">

<p>开始提交合并到主分支的申请</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080711039-283092739-20201126184446189.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106080747722-293518077-20201126184446205.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081015734-905282817-20201126184446180.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081027714-647433423-20201126184446274.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081223203-663097162-20201126184446308.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081345859-1974744297-20201126184446354.png" class title="img">

<p>接着退出当前的dev账号，使用lead账号登录，同样lead账号首次登录需要更改密码，步骤同dev一样：</p>
<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081654799-1325405956-20201126184446283.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081737842-576013049-20201126184446292.png" class title="img">

 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106081834712-1983955035-20201126184446391.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082118521-107543261-20201126184446416.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082235982-1151283651-20201126184446371.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082302424-429176945-20201126184446391.png" class title="img">



 <img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082334050-1662187133-20201126184446418.png" class title="img">

<img src="/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/804543-20190106082350221-411675038-20201126184446449.png" class title="img">

<p>jenkins的配置与使用见Jenkins+Gitlab+Ansible自动化部署(二)</p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(二)</title>
    <url>/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%BA%8C)/</url>
    <content><![CDATA[<p>接Jenkins+Gitlab+Ansbile自动化部署(一):</p>
<p><a href="https://sugw.github.io/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/">https://sugw.github.io/sugw.github.io/2020/11/26/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E4%B8%80)/</a></p>
<p>Ansible的配置与部署</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>Chef</td>
<td>采用Ruby编写，C/S架构，配置需要Git依赖，Recipe脚本编写规范，需要良好的编程经验。</td>
</tr>
<tr>
<td>Ansible</td>
<td>采用Python编写，无Client，模块化配置管理，Playbook脚本编写规范，易于上手，适合中小规模快速部署。</td>
</tr>
<tr>
<td>Saltstack</td>
<td>采用Python编写，C/S架构，模块化配置管理，YAML脚本编写规范，内置异步文件服务器可以为客户端文件加快服务速度，适合大规模集群部署，但是需要安装客户端。</td>
</tr>
</tbody></table>
<p>Ansible的优势和应用场景</p>
<p>优势：</p>
<ul>
<li>轻量级无客户端（Agentless）；</li>
<li>开源免费，学习成本低，快速上手；</li>
<li>使用playbook作为核心配置架构，同意的脚本格式批量化部署；</li>
<li>完善的模块化扩展，支持目前主流的开发环境；</li>
<li>强大的稳定性和兼容性；</li>
<li>活跃的官方社区问题讨论，方便troubleshooting与debug问题；</li>
</ul>
<p>Ansible配合virtualenv安装配置</p>
<p>使用python自带的python virtualenv工具隔离Python3.6、Ansible2.5和系统其他python依赖环境。</p>
<p>Ansible安装方式</p>
<p>1.yum一键安装（不推荐） </p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># yum install -y ansible</span></span><br><span class="line"><span class="meta"># 虽然简单，但是会带来一系列的依赖和模块混乱</span></span><br></pre></td></tr></table></figure>

<p>2.Git源码安装（推荐）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># yum install -y git      #如果系统中没有git的话，使用这条命令安装即可</span></span><br><span class="line">[root@ansible ~]<span class="comment"># git clone https://github.com/ansible/ansible.git</span></span><br></pre></td></tr></table></figure>

<p>Ansible2.5+Python3.6安装步骤</p>
<p>1.安装python3.6.5和virtualenv工具</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># wget http://www.python.org/ftp/python/3.6.5/Python-3.6.5.tar.xz</span></span><br><span class="line">[root@ansible ~]<span class="comment"># tar -xf Python-3.6.5.tar.xz -C /usr/local/src/</span></span><br><span class="line">[root@ansible ~]<span class="comment"># cd /usr/local/src/Python-3.6.5/</span></span><br><span class="line">[root@ansible ~]<span class="comment"># cd /usr/local/src/Python-3.6.5/</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># ./configure --prefix=/usr/local/ --with-ensurepip=install --enable-shared LDFLAGS=&quot;-Wl,-rpath /usr/local/lib&quot;</span></span><br><span class="line"><span class="comment">#竟然报错</span></span><br><span class="line">configure: error: in `<span class="string">/usr/local/src/Python-3.6.5</span>&#x27;:</span><br><span class="line">configure: error: no acceptable C compiler found in $PATH</span><br><span class="line">See `config.log&#x27; for more details</span><br><span class="line"><span class="comment"># 根据报错信息，需要安装GCC套件</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># yum install -y gcc </span></span><br><span class="line"><span class="comment"># 然后再次执行编译操作，完事执行安装</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># make &amp;&amp; make altinstall</span></span><br><span class="line"><span class="comment"># 然而又报错了</span></span><br><span class="line"><span class="string">....</span></span><br><span class="line">    import pip</span><br><span class="line">zipimport.ZipImportError: can&#x27;t decompress data; zlib not available</span><br><span class="line">make: *** [altinstall] Error 1</span><br><span class="line"><span class="comment"># 提示很明显了直接执行</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># yum install zlib*</span></span><br><span class="line"><span class="comment"># 然后再吃运行安装命令即可</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># make &amp;&amp; make altinstall</span></span><br><span class="line"><span class="comment"># 当看到</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line">Collecting setuptools</span><br><span class="line">Collecting pip</span><br><span class="line">Installing collected packages: setuptools, pip</span><br><span class="line">Successfully installed pip-9.0.3 setuptools-39.0.1</span><br><span class="line"><span class="comment"># 表明安装成功</span></span><br><span class="line"><span class="comment"># 接着安装virtualenv,然而并不顺利</span></span><br><span class="line">[root@ansible bin]<span class="comment"># pwd</span></span><br><span class="line"><span class="string">/usr/local/bin</span></span><br><span class="line">[root@ansible bin]<span class="comment"># ./pip --trusted-host pypi.python.org install virtualenv</span></span><br><span class="line">pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=4, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=3, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=2, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=1, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=0, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Could not fetch URL https:<span class="string">//pypi.python.org/simple/virtualenv/</span>: There was a problem confirming the ssl certificate: HTTPSConnectionPool<span class="params">(<span class="attr">host</span>=&#x27;pypi.python.org&#x27;, <span class="attr">port</span>=443)</span>: Max retries exceeded with url: <span class="string">/simple/virtualenv/</span> <span class="params">(Caused by SSLError(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>) - skipping</span><br><span class="line">  Could not find a <span class="keyword">version</span> that satisfies the requirement virtualenv <span class="params">(from versions: )</span></span><br><span class="line">No matching distribution found for virtualenv</span><br><span class="line"><span class="comment"># 使用网友提供的方法  加上--trusted-host参数，哦...依然不行</span></span><br><span class="line">[root@ansible bin]<span class="comment"># ./pip --trusted-host pypi.python.org install virtualenv</span></span><br><span class="line">pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=4, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=3, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=2, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=1, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Retrying <span class="params">(Retry(<span class="attr">total</span>=0, <span class="attr">connect</span>=None, <span class="attr">read</span>=None, <span class="attr">redirect</span>=None, <span class="attr">status</span>=None)</span>) after connection broken by &#x27;SSLError<span class="params">(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>&#x27;: <span class="string">/simple/virtualenv/</span></span><br><span class="line">  Could not fetch URL https:<span class="string">//pypi.python.org/simple/virtualenv/</span>: There was a problem confirming the ssl certificate: HTTPSConnectionPool<span class="params">(<span class="attr">host</span>=&#x27;pypi.python.org&#x27;, <span class="attr">port</span>=443)</span>: Max retries exceeded with url: <span class="string">/simple/virtualenv/</span> <span class="params">(Caused by SSLError(&quot;Can&#x27;t connect to HTTPS URL because the SSL module is not available.&quot;,)</span>) - skipping</span><br><span class="line">  Could not find a <span class="keyword">version</span> that satisfies the requirement virtualenv <span class="params">(from versions: )</span></span><br><span class="line">No matching distribution found for virtualenv</span><br><span class="line"><span class="comment"># 根据第一行报错提示</span></span><br><span class="line">pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available</span><br><span class="line"><span class="comment"># 需要安装openssl相关软件包</span></span><br><span class="line">[root@ansible bin]<span class="comment"># yum install -y openssl*</span></span><br><span class="line"><span class="comment">#除此之外，卸载掉python2.7安装的pip防止干扰</span></span><br><span class="line">[root@ansible bin]<span class="comment"># python -m pip uninstall pip</span></span><br><span class="line">Uninstalling pip-18.1:</span><br><span class="line">  Would remove:</span><br><span class="line">    <span class="string">/usr/bin/pip</span></span><br><span class="line">    <span class="string">/usr/bin/pip2</span></span><br><span class="line">    <span class="string">/usr/bin/pip2.7</span></span><br><span class="line">    <span class="string">/usr/lib/python2.7/site-packages/pip-18.1.dist-info/</span>*</span><br><span class="line">    <span class="string">/usr/lib/python2.7/site-packages/pip/</span>*</span><br><span class="line">Proceed <span class="params">(y/n)</span>? y</span><br><span class="line">  Successfully uninstalled pip-18.1</span><br><span class="line"><span class="comment"># 然后回到解压包里，重新运行编译安装过程</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># ./configure --prefix=/usr/local/ --with-ensurepip=install --enable-shared LDFLAGS=&quot;-Wl,-rpath /usr/local/lib&quot;</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># make &amp;&amp; make altinstall </span></span><br><span class="line"><span class="string">.......</span></span><br><span class="line">Requirement already satisfied: setuptools in <span class="string">/usr/local/lib/python3.6/site-packages</span></span><br><span class="line">Requirement already satisfied: pip in <span class="string">/usr/local/lib/python3.6/site-packages</span></span><br><span class="line">[root@ansible Python-3.6.5]<span class="comment"># cd ../../bin/</span></span><br><span class="line">[root@ansible bin]<span class="comment"># ll</span></span><br><span class="line">total 68</span><br><span class="line">-rwxr-xr-x. 1 root root   101 Jan  7 11<span class="function">:42</span> 2to3-3.6</span><br><span class="line">-rwxr-xr-x. 1 root root   242 Jan  7 11<span class="function">:00</span> easy_install-3.6</span><br><span class="line">-rwxr-xr-x. 1 root root    99 Jan  7 11<span class="function">:42</span> idle3.6</span><br><span class="line">lrwxrwxrwx. 1 root root    21 Jan  7 11<span class="function">:03</span> pip -&gt; <span class="string">/usr/local/bin/pip3.6</span></span><br><span class="line">-rwxr-xr-x. 1 root root   214 Jan  7 11<span class="function">:00</span> pip3.6</span><br><span class="line">-rwxr-xr-x. 1 root root    84 Jan  7 11<span class="function">:42</span> pydoc3.6</span><br><span class="line">-rwxr-xr-x. 2 root root 17712 Jan  7 11<span class="function">:41</span> python3.6</span><br><span class="line">-rwxr-xr-x. 2 root root 17712 Jan  7 11<span class="function">:41</span> python3.6m</span><br><span class="line">-rwxr-xr-x. 1 root root  3109 Jan  7 11<span class="function">:42</span> python3.6m-config</span><br><span class="line">-rwxr-xr-x. 1 root root   441 Jan  7 11<span class="function">:42</span> pyvenv-3.6</span><br><span class="line">[root@ansible bin]<span class="comment"># ln -s /usr/local/bin/pip3.6 /usr/local/bin/pip</span></span><br><span class="line"><span class="comment"># 再次使用pip安装virtualenv</span></span><br><span class="line">[root@ansible bin]<span class="comment"># pip install virtualenv</span></span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Cache entry deserialization failed, entry ignored</span><br><span class="line">  Cache entry deserialization failed, entry ignored</span><br><span class="line">  Downloading https:<span class="string">//files.pythonhosted.org/packages/6a/d1/e0d142ce7b8a5c76adbfad01d853bca84c7c0240e35577498e20bc2ade7d/virtualenv-16.2.0-py2.py3-none-any.whl</span> <span class="params">(1.9MB)</span></span><br><span class="line">    100% |████████████████████████████████| 1.9MB 64kB/s</span><br><span class="line">Requirement already satisfied: setuptools&gt;=18.0.0 in <span class="string">/usr/local/lib/python3.6/site-packages</span> <span class="params">(from virtualenv)</span></span><br><span class="line">Installing collected packages: virtualenv</span><br><span class="line">Successfully installed virtualenv-16.2.0</span><br><span class="line">You are using pip <span class="keyword">version</span> 9.0.3, however <span class="keyword">version</span> 18.1 is available.</span><br><span class="line">You should consider upgrading via the &#x27;pip install <span class="params">--upgrade</span> pip&#x27; <span class="keyword">command</span>.</span><br><span class="line"><span class="comment"># 安装成功</span></span><br></pre></td></tr></table></figure>



<p>2.创建ansible账户并安装python3.6.5版本virtualenv实例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># useradd deploy &amp;&amp; su - deploy</span></span><br><span class="line">[deploy@ansible ~]$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python3.6 .py3-a2.5-env</span><br><span class="line">Already using interpreter /usr/<span class="built_in">local</span>/bin/python3.6</span><br><span class="line">Using base prefix <span class="string">&#x27;/usr/local&#x27;</span></span><br><span class="line">New python executable <span class="keyword">in</span> /home/deploy/.py3-a2.5-env/bin/python3.6</span><br><span class="line">Also creating executable <span class="keyword">in</span> /home/deploy/.py3-a2.5-env/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">[deploy@ansible ~]$</span><br></pre></td></tr></table></figure>

<p>3.Git源码安装ansible2.5</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先使用root账户确保git nss curl命令已经安装</span></span><br><span class="line">[root@ansible ~]<span class="comment"># yum install -y git nss curl</span></span><br><span class="line"><span class="comment"># 然后切到deploy用户，进入之前创建的.py3-a2.5-env目录下</span></span><br><span class="line">[deploy@ansible ~]$ <span class="built_in">cd</span> /home/deploy/.py3-a2.5-env/</span><br><span class="line">[deploy@ansible .py3-a2.5-env]$ git <span class="built_in">clone</span> https://github.com/ansible/ansible.git</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>加载python3.6.5 virtualenv环境</li>
</ol>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">[deploy@ansible .py3-a2<span class="number">.5</span>-<span class="keyword">env</span>]$ <span class="keyword">source</span> /home/deploy/.py3-a2<span class="number">.5</span>-<span class="keyword">env</span>/bin/activate</span><br><span class="line">(.py3-a2<span class="number">.5</span>-<span class="keyword">env</span>) [deploy@ansible .py3-a2<span class="number">.5</span>-<span class="keyword">env</span>]$</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装ansible依赖包</li>
</ol>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># 安装依赖包</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible .py3-a2<span class="number">.5</span>-env]$ pip install paramiko PyYAML jinja2</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible .py3-a2<span class="number">.5</span>-env]$ ll</span><br><span class="line">total <span class="number">8</span></span><br><span class="line">drwxrwxr-x. <span class="number">14</span> deploy deploy <span class="number">4096</span> Jan  <span class="number">7</span> <span class="number">13</span>:<span class="number">31</span> ansible</span><br><span class="line">drwxrwxr-x.  <span class="number">2</span> deploy deploy <span class="number">4096</span> Jan  <span class="number">7</span> <span class="number">11</span>:<span class="number">52</span> bin</span><br><span class="line">drwxrwxr-x.  <span class="number">2</span> deploy deploy   <span class="number">24</span> Jan  <span class="number">7</span> <span class="number">11</span>:<span class="number">52</span> include</span><br><span class="line">drwxrwxr-x.  <span class="number">3</span> deploy deploy   <span class="number">23</span> Jan  <span class="number">7</span> <span class="number">11</span>:<span class="number">52</span> lib</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible .py3-a2<span class="number">.5</span>-env]$ pwd</span><br><span class="line">/home/deploy/.py3-a2<span class="number">.5</span>-env</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>在python3.6.5虚拟环境下加载ansible2.5</li>
</ol>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># 确认ansible源码包在.py3-a2<span class="number">.5</span>-env目录下</span><br><span class="line"># 进入ansible目录</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible .py3-a2<span class="number">.5</span>-env]$ cd ansible/</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ansible]$ pwd</span><br><span class="line">/home/deploy/.py3-a2<span class="number">.5</span>-env/ansible</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ansible]$ git checkout stable<span class="number">-2.5</span>  #将ansible切换到<span class="number">2.5</span>版本</span><br><span class="line">Branch stable<span class="number">-2.5</span> <span class="keyword">set</span> up to track remote branch stable<span class="number">-2.5</span> <span class="keyword">from</span> origin.</span><br><span class="line">Switched to a new branch <span class="string">&#x27;stable-2.5&#x27;</span></span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ansible]$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/hacking/env-setup -q  #在此虚拟环境下加载ansible2<span class="number">.5</span>版本</span><br></pre></td></tr></table></figure>

<p>7.验证ansible版本</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ansible]$ ansible --version</span><br><span class="line">ansible <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> <span class="number">6548</span>b7a558) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">07</span> <span class="number">13</span>:<span class="number">56</span>:<span class="number">01</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.5</span> (<span class="keyword">default</span>, Jan  <span class="number">7</span> <span class="number">2019</span>, <span class="number">11</span>:<span class="number">40</span>:<span class="number">52</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line"># 至此ansible2<span class="number">.5</span>在虚拟环境下安装加载完成</span><br></pre></td></tr></table></figure>

<p>Playbooks框架与格式</p>
<table>
<thead>
<tr>
<th>父目录</th>
<th>1级子目录</th>
<th>2级子目录</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>inventory/</td>
<td>Server详细清单目录</td>
<td>用来保存主机域名、IP地址和相关参数</td>
<td></td>
</tr>
<tr>
<td></td>
<td>testenv</td>
<td>具体清单与变量声明文件</td>
<td></td>
</tr>
<tr>
<td>roles/</td>
<td>roles任务列表</td>
<td>可以存放一个或多个role</td>
<td></td>
</tr>
<tr>
<td></td>
<td>testbox/</td>
<td>testbox详细任务</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>tasks/</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>main.yml</td>
<td>testbox主任务文件</td>
</tr>
<tr>
<td>deploy.yml</td>
<td>Playbook任务入口文件</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>格式说明</p>
<table>
<thead>
<tr>
<th>testenv文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>[testservers]</td>
<td>Server组列表</td>
</tr>
<tr>
<td>test.example.com</td>
<td>目标部署服务器主机名</td>
</tr>
<tr>
<td>[testservers:vars]</td>
<td>Server组列表参数</td>
</tr>
<tr>
<td>server_name=test,example.com</td>
<td>目标主机Key/Value参数</td>
</tr>
<tr>
<td>user=root</td>
<td></td>
</tr>
<tr>
<td>output=/root/test.txt</td>
<td></td>
</tr>
</tbody></table>
<p>主任务文件main.yml</p>
<table>
<thead>
<tr>
<th>文件内容</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>- name:Print Server name and user to remote testbox</td>
<td>任务名称</td>
</tr>
<tr>
<td>shell:”echo ‘Currently is logining ‘ &gt; “</td>
<td>shell:使用shell模块执行命令</td>
</tr>
<tr>
<td>inventory/testenv文件[testservers:vars]server_name=test.example.comuser=rootoutput=/root/test.txt</td>
<td></td>
</tr>
</tbody></table>
<p>任务入口文件deploy.yml</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">- hosts:<span class="string">&quot;testservers&quot;</span>      <span class="meta">#Server列表</span></span><br><span class="line"><span class="symbol">  gather_facts:</span>true         <span class="meta">#获取Server基本信息   </span></span><br><span class="line"><span class="symbol">   remote_user:</span>root        <span class="meta"># 目标服务器系统用户指定</span></span><br><span class="line"><span class="symbol">   roles:</span></span><br><span class="line">   - testbox                      <span class="meta">#进入roles/testbox任务目录</span></span><br></pre></td></tr></table></figure>

<p>登录ansible主机，加载之前配置好的python3.6.5和ansible2.5环境，并验证</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@ansible ~]</span># su - deploy</span><br><span class="line">Last login: Mon Jan  <span class="number">7</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">41</span> CST <span class="number">2019</span> on pts/<span class="number">1</span></span><br><span class="line"><span class="string">[deploy@ansible ~]</span>$ source .py3-a2<span class="number">.5</span>-env/bin/activate</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ~]$ source .py3-a2<span class="number">.5</span>-env/ansible/hacking/env-setup -q</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> <span class="number">6548</span>b7a558) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">07</span> <span class="number">13</span>:<span class="number">56</span>:<span class="number">01</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible-playbook</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.5</span> (<span class="keyword">default</span>, Jan  <span class="number">7</span> <span class="number">2019</span>, <span class="number">11</span>:<span class="number">40</span>:<span class="number">52</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br></pre></td></tr></table></figure>

<p>开始编写playbooks</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible ~]$ <span class="built_in">mkdir</span> test-playbooks</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible ~]$ <span class="keyword">cd</span> test-playbooks/</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="built_in">mkdir</span> inventory</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="built_in">mkdir</span> roles</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">cd</span> inventory</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible inventory]$ <span class="keyword">vim</span> testenv</span><br><span class="line">[testservers]</span><br><span class="line">test.example.<span class="keyword">com</span></span><br><span class="line"></span><br><span class="line">[testserver<span class="variable">s:vars</span>]</span><br><span class="line">server_name=test.example.<span class="keyword">com</span></span><br><span class="line">user=root</span><br><span class="line">output=/root/test.txt</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible inventory]$ <span class="keyword">cd</span> ..</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">ls</span></span><br><span class="line">inventory  roles</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">cd</span> roles/</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible roles]$ <span class="built_in">mkdir</span> testbox</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible roles]$ <span class="keyword">cd</span> testbox/</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible testbox]$ <span class="built_in">mkdir</span> tasks</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible testbox]$ <span class="keyword">cd</span> tasks/</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible tasks]$ <span class="keyword">vim</span> main.yml</span><br><span class="line">- name: <span class="keyword">Print</span> server name <span class="built_in">and</span> user <span class="keyword">to</span> remote testbox</span><br><span class="line">  shel<span class="variable">l:</span><span class="string">&quot;echo &#x27;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#x27; &gt; &#123;&#123; output &#125;&#125;&quot;</span></span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible tasks]$ <span class="keyword">cd</span> ../../..</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">pwd</span></span><br><span class="line">/home/deploy/test-playbooks</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible tasks]$ <span class="keyword">cd</span> ../../..</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">pwd</span></span><br><span class="line">/home/deploy/test-playbooks</span><br><span class="line">(.<span class="keyword">py3</span>-a2.<span class="number">5</span>-env) [deploy@ansible test-playbooks]$ <span class="keyword">vim</span> deploy.yml</span><br><span class="line"></span><br><span class="line">- host<span class="variable">s:</span> <span class="string">&quot;testservers&quot;</span></span><br><span class="line">  gather_fact<span class="variable">s:</span> true</span><br><span class="line">  remote_user: root</span><br><span class="line">  role<span class="variable">s:</span></span><br><span class="line">  - testbox</span><br></pre></td></tr></table></figure>



<p>查看test_playbooxs目录结构</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible test-playbooks]$ tree .</span><br><span class="line">.</span><br><span class="line">├── deploy.yml</span><br><span class="line">├── inventory</span><br><span class="line">│?? └── testenv</span><br><span class="line">└── roles</span><br><span class="line">    └── testbox</span><br><span class="line">        └── tasks</span><br><span class="line">            └── main.yml</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">3</span> files</span><br></pre></td></tr></table></figure>

<p>这里需要另外一台测试被部署机器test.example.com</p>
<table>
<thead>
<tr>
<th>系统版本</th>
<th>主机名</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>CentOS Linux release 7.5.1804 (core)</td>
<td>test.example.com</td>
<td>20.10.1.209</td>
</tr>
</tbody></table>
<p>被部署的机器test.example.com与其他三台主机实验环境一致。</p>
<p>配置SSH免秘钥认证</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@ansible test-playbooks]$ su - root</span><br><span class="line">Password:</span><br><span class="line">Last login: Mon Jan  <span class="number">7</span> <span class="number">10</span>:<span class="number">05</span>:<span class="number">23</span> CST <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.1</span> <span class="keyword">on</span> pts/<span class="number">1</span></span><br><span class="line">[root@ansible ~]<span class="meta"># vim /etc/hosts</span></span><br><span class="line">....</span><br><span class="line"><span class="number">192.168</span><span class="number">.244</span><span class="number">.133</span> test.example.com</span><br><span class="line">[root@ansible ~]<span class="meta"># exit</span></span><br><span class="line">logout</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@ansible test-playbooks]$ ssh-keygen -t rsa</span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/home/deploy/.ssh/id_rsa):</span><br><span class="line">Created directory <span class="comment">&#x27;/home/deploy/.ssh&#x27;.</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/deploy/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /home/deploy/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line">SHA256:Aj+FzKSwqZS19eI/<span class="number">3</span>EQt13L78+u3vjMtseX8YXNFnnY deploy@ansible.example.com</span><br><span class="line">The <span class="keyword">key</span><span class="comment">&#x27;s randomart image is:</span></span><br><span class="line">+---[RSA <span class="number">2048</span>]----+</span><br><span class="line">|  .. ..          |</span><br><span class="line">|  o+o=..  . .    |</span><br><span class="line">| oo.o.+..o + o  .|</span><br><span class="line">|..  .o... o o .o.|</span><br><span class="line">|.    .+ S.   . oE|</span><br><span class="line">|      ooo     + +|</span><br><span class="line">|       + .     %o|</span><br><span class="line">|        .     +o@|</span><br><span class="line">|              oB@|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@ansible test-playbooks]$ ssh-copy-id -i /home/deploy/.ssh/id_rsa.pub root@test.example.com</span><br><span class="line">/bin/ssh-copy-id: INFO: Source <span class="keyword">of</span> <span class="keyword">key</span>(s) <span class="keyword">to</span> be installed: <span class="string">&quot;/home/deploy/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">&#x27;test.example.com (192.168.244.133)&#x27; can&#x27;t be established.</span></span><br><span class="line">ECDSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> SHA256:<span class="number">66</span>hu+WU6R2SL4+<span class="number">7</span>r/WYk2kjrGi7IwjuJieTrdMhwLc0.</span><br><span class="line">ECDSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> MD5:af:c7:bd:<span class="number">88</span>:<span class="number">0</span>d:<span class="number">40</span>:d8:<span class="number">19</span>:<span class="number">6</span>d:<span class="number">28</span>:<span class="number">7</span>f:dd:af:aa:<span class="number">3</span>a:c9.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">/bin/ssh-copy-id: INFO: attempting <span class="keyword">to</span> log <span class="keyword">in</span> <span class="keyword">with</span> the <span class="keyword">new</span> <span class="keyword">key</span>(s), <span class="keyword">to</span> filter out any that are already installed</span><br><span class="line">/bin/ssh-copy-id: INFO: <span class="number">1</span> <span class="keyword">key</span>(s) remain <span class="keyword">to</span> be installed -- <span class="keyword">if</span> you are prompted now it <span class="keyword">is</span> <span class="keyword">to</span> install the <span class="keyword">new</span> keys</span><br><span class="line">root@test.example.com<span class="comment">&#x27;s password:</span></span><br><span class="line"></span><br><span class="line">Number <span class="keyword">of</span> <span class="keyword">key</span>(s) added: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span>:   <span class="string">&quot;ssh &#x27;root@test.example.com&#x27;&quot;</span></span><br><span class="line"><span class="keyword">and</span> check <span class="keyword">to</span> make sure that only the <span class="keyword">key</span>(s) you wanted were added.</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  <span class="number">7</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">38</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.1</span></span><br><span class="line">[root@test ~]<span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">[root@test ~]<span class="meta"># hostname</span></span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>测试部署</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible ~]$ cd test-playbooks/</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ls</span><br><span class="line">deploy.yml  inventory  roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="emphasis">*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [Gathering Facts] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span><br><span class="line"><span class="strong">changed: [test.example.com]</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">PLAY RECAP **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">test.example.com           : ok=2    changed=1    unreachable=0    failed=0  </span></span></span><br><span class="line"><span class="strong"><span class="emphasis"># 以下内容可以看出已经成功在远程被部署主机test.example.com上创建一个test.txt文件，且文件内容与预先设置的一致</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">Last login: Mon Jan  7 17:42:57 2019 from 192.168.244.132</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">[root@test ~]# ls</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">anaconda-ks.cfg  test.txt</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">[root@test ~]# cat test.txt</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">Currently root is loggging test.example.com</span></span></span><br></pre></td></tr></table></figure>



<p>Ansible Playbooks常用模块</p>
<p>File模块：</p>
<p>在目标主机创建文件或目录，并赋予其系统权限，如：</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">- name: create a file   <span class="comment"># 任务名称</span></span><br><span class="line">  file: &#x27;path=/root/a.txt <span class="keyword">state</span>=touch mode=<span class="number">0755</span> owner=sishen <span class="keyword">group</span>=sishen&#x27;</span><br><span class="line"><span class="comment"># 任务内容</span></span><br></pre></td></tr></table></figure>

<p>Copy模块：</p>
<p>实现Ansible服务端到目标主机的文件传送，如：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">- name: <span class="keyword">copy</span> a <span class="keyword">file</span>   #任务名称 复制一个文件</span><br><span class="line">  <span class="keyword">copy</span>: &#x27;remote_src=<span class="keyword">no</span> src=roles/testbox/files/<span class="keyword">test</span>.<span class="keyword">sh</span> dest=/root/<span class="keyword">test</span>.<span class="keyword">sh</span> mode=0644 force=yes&#x27;</span><br><span class="line"></span><br><span class="line"># 说明</span><br><span class="line">remote_src:声明将ansible服务端文件传送到目标主机当中</span><br><span class="line">src:源文件的路径</span><br><span class="line">dest:目标文件的路径</span><br><span class="line">mode:赋予的文件权限</span><br><span class="line">force:强制执行</span><br></pre></td></tr></table></figure>

<p>Stat模块：</p>
<p>获取远程文件状态信息，如：</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">- name:<span class="built_in"> check </span>if test.sh exists</span><br><span class="line">  stat: &#x27;path=/root/test.sh&#x27;   <span class="comment">#需要获取的文件路径</span></span><br><span class="line">  register: script_stat           <span class="comment">#将stat变量获取到的信息传递给script_stat</span></span><br></pre></td></tr></table></figure>

<p>Debug模块：</p>
<p>打印语句到Ansible执行输出：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">- <span class="keyword">debug</span>: msf=test.sh <span class="keyword">exists</span></span><br><span class="line">  <span class="keyword">when</span>:script_stat.stat.<span class="keyword">exists</span></span><br></pre></td></tr></table></figure>

<p>Command/Shell模块</p>
<p>用来执行Linux目标主机命令行</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">- name: <span class="builtin-name">run</span> the script</span><br><span class="line">  command: <span class="string">&quot;sh /root/test.sh&quot;</span></span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">run</span> the script</span><br><span class="line">  shell: <span class="string">&quot;echo &#x27;test&#x27; &gt; /root/test.txt&quot;</span> (推荐)</span><br></pre></td></tr></table></figure>

<p>Template模块</p>
<p>实现Ansible服务端到目标主机的jinja2模板传送</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">- name: write the nginx<span class="built_in"> config </span>file</span><br><span class="line">  template: <span class="attribute">src</span>=roles/testbox/templates/nginx.conf.j2 <span class="attribute">dest</span>=/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<p>Packaging模块</p>
<p>调用目标主机系统包管理工具(yum，apt)进行安装</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  yum: pkg=nginx <span class="keyword">state</span>=latest  <span class="comment">#(CentOS/RHEL)</span></span><br><span class="line"></span><br><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  apt: pkg=nginx <span class="keyword">state</span>=latest    <span class="comment">#(Debian/Ubuntu)</span></span><br></pre></td></tr></table></figure>

<p>Service模块</p>
<p>管理目标主机系统服务</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">- name: start nginx service</span><br><span class="line">  service: <span class="attribute">name</span>=nginx <span class="attribute">state</span>=started</span><br></pre></td></tr></table></figure>

<p>登录被部署主机，创建测试用户</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [deploy@ansible test-playbooks]$ ssh root@test.example.com</span><br><span class="line">Last login: Mon Jan  <span class="number">7</span> <span class="number">17</span>:<span class="number">44</span>:<span class="number">56</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.132</span></span><br><span class="line">[root@test ~]# useradd sishen</span><br><span class="line">useradd: user <span class="string">&#x27;sishen&#x27;</span> already exists</span><br><span class="line">[root@test ~]# useradd god</span><br><span class="line">[root@test ~]# useradd deploy</span><br><span class="line">[root@test ~]# mkdir /etc/nginx</span><br><span class="line">[root@test ~]# rpm -Uvh http:<span class="comment">//nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line">Retrieving http:<span class="comment">//nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line">warning: /var/tmp/rpm-tmp.i5SPeu: Header V4 RSA/SHA1 Signature, key ID <span class="number">7</span>bd9bf62: NOKEY</span><br><span class="line">Preparing...                                                            (<span class="number">100</span>%################################# [<span class="number">100</span>%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   <span class="number">1</span>:nginx-release-centos<span class="number">-7</span><span class="number">-0.</span>el7.ngx                                   ( <span class="number">81</span>%################################# [<span class="number">100</span>%]</span><br></pre></td></tr></table></figure>



<p>退出被部署主机</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@test ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> test.example.com closed.</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ pwd</span><br><span class="line">/home/deploy/test-playbooks</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ls</span><br><span class="line">deploy.yml  inventory  roles</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/tasks/main.yml</span><br><span class="line">- name: <span class="builtin-name">Print</span><span class="built_in"> server </span>name <span class="keyword">and</span><span class="built_in"> user </span><span class="keyword">to</span> remote testbox</span><br><span class="line">  shell: <span class="string">&quot;echo &#x27;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#x27; &gt; &#123;&#123; output &#125;&#125;&quot;</span></span><br><span class="line"><span class="comment">#添加以下内容</span></span><br><span class="line">- name: create a file</span><br><span class="line">  file: <span class="string">&#x27;path=/root/god.txt state=touch mode=0755 owner=god group=god&#x27;</span></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] *************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : <span class="builtin-name">Print</span><span class="built_in"> server </span>name <span class="keyword">and</span><span class="built_in"> user </span><span class="keyword">to</span> remote testbox] ******************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : create a file] *************************************************</span><br><span class="line">changed: [test.example.com]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : <span class="attribute">ok</span>=3    <span class="attribute">changed</span>=2    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0  </span><br></pre></td></tr></table></figure>



<p>登录到远程主机查看</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible test-playbooks]$ ssh <span class="symbol">root@</span>test.example.com</span><br><span class="line">Last login: Mon Jan  <span class="number">7</span> <span class="number">19</span>:<span class="number">05</span>:<span class="number">41</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.132</span></span><br><span class="line"><span class="string">[root@test ~]</span># ls -l</span><br><span class="line">total <span class="number">8</span></span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">1732</span> Dec <span class="number">26</span> <span class="number">20</span>:<span class="number">03</span> anaconda-ks.cfg</span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> god  god     <span class="number">0</span> Jan  <span class="number">7</span> <span class="number">19</span>:<span class="number">05</span> god.txt  #已经成功创建并赋予文件权限</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root   <span class="number">44</span> Jan  <span class="number">7</span> <span class="number">19</span>:<span class="number">05</span> test.txt</span><br></pre></td></tr></table></figure>



<p>或者直接</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible test-playbooks]$ ssh <span class="symbol">root@</span>test.example.com ls -l  /root/god.txt</span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> god god <span class="number">0</span> Jan  <span class="number">7</span> <span class="number">19</span>:<span class="number">05</span> /root/god.txt</span><br></pre></td></tr></table></figure>

<p>创建god.sh</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir roles/testbox/files</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/files/god.sh</span><br><span class="line">echo <span class="string">&quot;this is a test script&quot;</span></span><br><span class="line">echo <span class="string">&quot;If you see this message, the script is executed successfully.&quot;</span></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/tasks/main.yml</span><br><span class="line">- name: <span class="builtin-name">Print</span><span class="built_in"> server </span>name <span class="keyword">and</span><span class="built_in"> user </span><span class="keyword">to</span> remote testbox</span><br><span class="line">  shell: <span class="string">&quot;echo &#x27;Currently &#123;&#123; user &#125;&#125; is loggging &#123;&#123; server_name &#125;&#125;&#x27; &gt; &#123;&#123; output &#125;&#125;&quot;</span></span><br><span class="line">- name: create a file</span><br><span class="line">  file: <span class="string">&#x27;path=/root/god.txt state=touch mode=0755 owner=god group=god&#x27;</span></span><br><span class="line"><span class="comment">#添加以下内容</span></span><br><span class="line">- name: copy a file</span><br><span class="line">  copy: <span class="string">&#x27;remote_src=no src=roles/testbox/files/god.sh dest=/root/god.sh mode=0644 force=yes&#x27;</span></span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span><br></pre></td></tr></table></figure>



<p>验证并查看</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>ansible test-playbooks]$ ssh <span class="symbol">root@</span>test.example.com ls -l /root/god.sh</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">99</span> Jan  <span class="number">7</span> <span class="number">19</span>:<span class="number">19</span> /root/god.sh</span><br></pre></td></tr></table></figure>

<p>演示stat与debug模块</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/tasks/main.yml</span><br><span class="line">....</span><br><span class="line"><span class="section"># 文件末尾添加以下内容</span></span><br><span class="line"><span class="bullet">-</span> name: check if god.sh exists</span><br><span class="line">  stat: &#x27;path=/root/gid.sh&#x27;</span><br><span class="line">  register: script<span class="emphasis">_stat</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">- debug: msg=&quot;god.sh exists&quot;</span></span><br><span class="line"><span class="emphasis">  when: script_</span>stat.stat.exists</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="emphasis">*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [Gathering Facts] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span><br><span class="line"><span class="strong">changed: [test.example.com]</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">TASK [testbox : create a file] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span><br><span class="line"><span class="strong"><span class="emphasis"></span></span></span><br><span class="line"><span class="strong"><span class="emphasis">TASK [testbox : copy a file] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [testbox : check if god.sh exists] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [testbox : debug] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com] =&gt; &#123;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">    &quot;msg&quot;: &quot;god.sh exists&quot;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">&#125;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">PLAY RECAP **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">test.example.com           : ok=6    changed=2    unreachable=0    failed=0  </span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span></span></span></span></span><br></pre></td></tr></table></figure>



<p>演示command模块</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/tasks/main.yml</span><br><span class="line"><span class="section"># 末尾添加以下内容</span></span><br><span class="line"><span class="bullet">-</span> name: run the script</span><br><span class="line">  command: &#x27;sh /root/god.sh&#x27;</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span><br><span class="line"></span><br><span class="line">PLAY [testservers] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="emphasis">*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [Gathering Facts] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line">ok: [test.example.com]</span><br><span class="line"></span><br><span class="line">TASK [testbox : Print server name and user to remote testbox] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span><br><span class="line"><span class="strong">changed: [test.example.com]</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">TASK [testbox : create a file] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span><br><span class="line"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span><br><span class="line"><span class="strong"><span class="emphasis"></span></span></span><br><span class="line"><span class="strong"><span class="emphasis">TASK [testbox : copy a file] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [testbox : check if god.sh exists] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [testbox : debug] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com] =&gt; &#123;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">    &quot;msg&quot;: &quot;god.sh exists&quot;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">&#125;</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">TASK [testbox : run the script] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">PLAY RECAP **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">test.example.com           : ok=7    changed=3    unreachable=0    failed=0  </span></span></span></span></span><br></pre></td></tr></table></figure>



<p>template模块演示</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim inventory/testenv</span><br><span class="line"><span class="section"># 末尾添加以下内容</span></span><br><span class="line">server<span class="emphasis">_name=test.example.com</span></span><br><span class="line"><span class="emphasis">port=80</span></span><br><span class="line"><span class="emphasis">user=deploy</span></span><br><span class="line"><span class="emphasis">worker_</span>processes=4</span><br><span class="line">max<span class="emphasis">_open_</span>file=65505</span><br><span class="line">root=/www</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ mkdir roles/testbox/templates</span><br><span class="line">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/templates/nginx.conf.j2</span><br><span class="line"><span class="section"># For more information on configuration, see: </span></span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker<span class="emphasis">_processes  &#123;&#123; worker_</span>processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error<span class="emphasis">_log  /var/log/nginx/error.log;  </span></span><br><span class="line"><span class="emphasis">  </span></span><br><span class="line"><span class="emphasis">pid        /var/run/nginx.pid;  </span></span><br><span class="line"><span class="emphasis">  </span></span><br><span class="line"><span class="emphasis">events &#123;  </span></span><br><span class="line"><span class="emphasis">    worker_</span>connections  &#123;&#123; max<span class="emphasis">_open_</span>file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line"><span class="code">    include       /etc/nginx/mime.types;  </span></span><br><span class="line"><span class="code">    default_type  application/octet-stream;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;  </span></span><br><span class="line"><span class="code">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;  </span></span><br><span class="line"><span class="code">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    access_log  /var/log/nginx/access.log  main;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    sendfile        on;  </span></span><br><span class="line"><span class="code">    #tcp_nopush     on;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    #keepalive_timeout  0;  </span></span><br><span class="line"><span class="code">    keepalive_timeout  65;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    #gzip  on;  </span></span><br><span class="line"><span class="code">      </span></span><br><span class="line"><span class="code">    # Load config files from the /etc/nginx/conf.d directory  </span></span><br><span class="line"><span class="code">    # The default server is in conf.d/default.conf  </span></span><br><span class="line"><span class="code">    #include /etc/nginx/conf.d/*.conf;  </span></span><br><span class="line"><span class="code">    server &#123;  </span></span><br><span class="line"><span class="code">        listen       &#123;&#123; port &#125;&#125; default_server;  </span></span><br><span class="line"><span class="code">        server_name  &#123;&#123; server_name &#125;&#125;;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">        #charset koi8-r;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">        #access_log  logs/host.access.log  main;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">        location / &#123;  </span></span><br><span class="line"><span class="code">            root   &#123;&#123; root &#125;&#125;;  </span></span><br><span class="line"><span class="code">            index  index.html index.htm;  </span></span><br><span class="line"><span class="code">        &#125;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">        error_page  404              /404.html;  </span></span><br><span class="line"><span class="code">        location = /404.html &#123;  </span></span><br><span class="line"><span class="code">            root   /usr/share/nginx/html;  </span></span><br><span class="line"><span class="code">        &#125;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">        # redirect server error pages to the static page /50x.html  </span></span><br><span class="line"><span class="code">        #  </span></span><br><span class="line"><span class="code">        error_page   500 502 503 504  /50x.html;  </span></span><br><span class="line"><span class="code">        location = /50x.html &#123;  </span></span><br><span class="line"><span class="code">            root   /usr/share/nginx/html;  </span></span><br><span class="line"><span class="code">        &#125;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">    &#125;  </span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code">配置main.yml文件</span></span><br><span class="line"><span class="code">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ vim roles/testbox/tasks/main.yml</span></span><br><span class="line"><span class="code"># 末尾添加如下内容</span></span><br><span class="line"><span class="code">- name: write the nginx config file</span></span><br><span class="line"><span class="code">  template: src=roles/testbox/templates/nginx.conf.j2 dest=/etc/nginx/nginx.c</span></span><br><span class="line"><span class="code">onf</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">- name: ensure nginx is at the latest version</span></span><br><span class="line"><span class="code">  yum: pkg=nginx state=latest</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">- name: start nginx service</span></span><br><span class="line"><span class="code">  service: name=nginx state=started</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">(.py3-a2.5-env) [deploy@ansible test-playbooks]$ ansible-playbook -i inventory/testenv ./deploy.yml</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">PLAY [testservers] *************************************************************</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [Gathering Facts] *********************************************************</span></span><br><span class="line"><span class="code">ok: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : Print server name and user to remote testbox] ******************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : create a file] *************************************************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : copy a file] ***************************************************</span></span><br><span class="line"><span class="code">ok: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : check if god.sh exists] ****************************************</span></span><br><span class="line"><span class="code">ok: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : debug] *********************************************************</span></span><br><span class="line"><span class="code">ok: [test.example.com] =&gt; &#123;</span></span><br><span class="line"><span class="code">    &quot;msg&quot;: &quot;god.sh exists&quot;</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : run the script] ************************************************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : write the nginx config file] ***********************************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : ensure nginx is at the latest version] *************************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">TASK [testbox : start nginx service] *******************************************</span></span><br><span class="line"><span class="code">changed: [test.example.com]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">PLAY RECAP *********************************************************************</span></span><br><span class="line"><span class="code">test.example.com           : ok=10   changed=6    unreachable=0    failed=0  </span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">(.py3-a2.5-env) [deploy@ansible test-playbooks]$</span></span><br></pre></td></tr></table></figure>



<p>查看并验证</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">(.py3-a2.5-env)</span> [<span class="string">deploy@ansible</span> <span class="string">test-playbooks</span>]<span class="string">$</span> <span class="string">ssh</span> <span class="string">root@test.example.com</span> <span class="string">cat</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># For more information on configuration, see:</span></span><br><span class="line"><span class="string">user</span>              <span class="string">deploy;</span></span><br><span class="line"><span class="string">worker_processes</span>  <span class="number">4</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="string">error_log</span>  <span class="string">/var/log/nginx/error.log;</span></span><br><span class="line"></span><br><span class="line"><span class="string">pid</span>        <span class="string">/var/run/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">worker_connections</span>  <span class="number">65505</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">include</span>       <span class="string">/etc/nginx/mime.types;</span></span><br><span class="line">    <span class="string">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">log_format</span>  <span class="string">main</span>  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">access_log</span>  <span class="string">/var/log/nginx/access.log</span>  <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile</span>        <span class="string">on;</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="string">keepalive_timeout</span>  <span class="number">65</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load config files from the /etc/nginx/conf.d directory</span></span><br><span class="line">    <span class="comment"># The default server is in conf.d/default.conf</span></span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>       <span class="number">80</span> <span class="string">default_server;</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">test.example.com;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">/www;</span></span><br><span class="line">            <span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">error_page</span>  <span class="number">404</span>              <span class="string">/404.html;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">=</span> <span class="string">/404.html</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="string">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  <span class="string">/50x.html;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">=</span> <span class="string">/50x.html</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">(.py3-a2.5-env)</span> [<span class="string">deploy@ansible</span> <span class="string">test-playbooks</span>]<span class="string">$</span> <span class="string">ssh</span> <span class="string">root@test.example.com</span> <span class="string">ps</span> <span class="string">-ef</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">root</span>       <span class="number">5047      </span><span class="number">1</span>  <span class="number">0</span> <span class="number">19</span><span class="string">:49</span> <span class="string">?</span>        <span class="attr">00:00:00 nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-c</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="string">deploy</span>     <span class="number">5048   </span><span class="number">5047  </span><span class="number">0</span> <span class="number">19</span><span class="string">:49</span> <span class="string">?</span>        <span class="attr">00:00:00 nginx:</span> <span class="string">worker</span> <span class="string">process</span></span><br><span class="line"><span class="string">deploy</span>     <span class="number">5049   </span><span class="number">5047  </span><span class="number">0</span> <span class="number">19</span><span class="string">:49</span> <span class="string">?</span>        <span class="attr">00:00:00 nginx:</span> <span class="string">worker</span> <span class="string">process</span></span><br><span class="line"><span class="string">deploy</span>     <span class="number">5050   </span><span class="number">5047  </span><span class="number">0</span> <span class="number">19</span><span class="string">:49</span> <span class="string">?</span>        <span class="attr">00:00:00 nginx:</span> <span class="string">worker</span> <span class="string">process</span></span><br><span class="line"><span class="string">deploy</span>     <span class="number">5051   </span><span class="number">5047  </span><span class="number">0</span> <span class="number">19</span><span class="string">:49</span> <span class="string">?</span>        <span class="attr">00:00:00 nginx:</span> <span class="string">worker</span> <span class="string">process</span></span><br></pre></td></tr></table></figure>



<p>至此ansible的安装、配置与演示已全部完成。</p>
]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins+Gitlab+Ansible自动化部署(六)</title>
    <url>/sugw.github.io/2020/11/27/Jenkins+Gitlab+Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2(%E5%85%AD)/</url>
    <content><![CDATA[<p><strong>Pipeline Job实现Nginix+MySQL+PHP+Wordpress实现自动化部署交付（Jenkins+Gitlab+Ansible自动化部署（五））</strong></p>
<ul>
<li><p>环境准备</p>
</li>
<li><p>编写ansible playbook脚本实现Wordpress远程部署</p>
</li>
<li><p>将wordpress源码与playbook部署脚本提交到gitlab仓库</p>
</li>
<li><p>编写pipeline job脚本实现Jenkins流水线持续交付流程</p>
</li>
<li><p>Jenkins集成Ansible与gitlab实现wordpress的自动化部署</p>
<p>验证环境</p>
</li>
</ul>
<p>登录Jenkins主机</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~</span><br><span class="line">$ ssh <span class="symbol">root@</span>jenkins.example.com</span><br><span class="line">Last login: Thu Jan <span class="number">10</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">49</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.1</span></span><br><span class="line"><span class="string">[root@jenkins ~]</span># su - deploy</span><br><span class="line">Last login: Wed Jan  <span class="number">9</span> <span class="number">20</span>:<span class="number">24</span>:<span class="number">43</span> CST <span class="number">2019</span> on pts/<span class="number">0</span></span><br><span class="line"><span class="string">[deploy@jenkins ~]</span>$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/bin/activate           (.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ source /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/hacking/env-setup -q</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ ansible-playbook --version</span><br><span class="line">ansible-playbook <span class="number">2.5</span><span class="number">.14</span> (stable<span class="number">-2.5</span> c748512c4c) last updated <span class="number">2019</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">20</span>:<span class="number">03</span>:<span class="number">39</span> (GMT +<span class="number">800</span>)</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [<span class="string">&#x27;/home/deploy/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/lib/ansible</span><br><span class="line">  executable location = /home/deploy/.py3-a2<span class="number">.5</span>-env/ansible/bin/ansible-playbook</span><br><span class="line">  python version = <span class="number">3.6</span><span class="number">.8</span> (<span class="keyword">default</span>, Jan  <span class="number">9</span> <span class="number">2019</span>, <span class="number">19</span>:<span class="number">44</span>:<span class="number">42</span>) [GCC <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-36</span>)]</span><br><span class="line">(.py3-a2<span class="number">.5</span>-env) [<span class="symbol">deploy@</span>jenkins ~]$ ssh <span class="symbol">root@</span>test.example.com</span><br><span class="line">Last login: Thu Jan <span class="number">10</span> <span class="number">13</span>:<span class="number">04</span>:<span class="number">32</span> <span class="number">2019</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.244</span><span class="number">.131</span></span><br><span class="line"><span class="string">[root@test ~]</span># hostname</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>登录Jenkins web管理页</p>
<p>4464</p>
<p>登录gitlab web管理页</p>
<p>4576</p>
<p>至此环境准备完成。</p>
<p>接下来编写ansible playbook脚本实现wordpress远程部署</p>
<p>开始编写配置文件</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo</span><br><span class="line">$ cd ~/Desktop/repo/ansible-playbook-repo/</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">5</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">11</span>:<span class="number">57</span> ansible-playbook.txt</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span>   <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">12</span>:<span class="number">27</span> nginx_playbooks/</span><br><span class="line">-rw-r--r-- <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">312</span> <span class="number">7</span>月  <span class="number">15</span> <span class="number">08</span>:<span class="number">33</span> nginx-freestyle-job.sh</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ mkdir wordpress_playbooks</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo (master)</span><br><span class="line">$ cd wordpress_playbooks/</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ mkdir inventory</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ mkdir -p roles/wordpress/&#123;files,tasks,templates&#125;</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ ll</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">13</span>:<span class="number">29</span> inventory/</span><br><span class="line">drwxr-xr-x <span class="number">1</span> xueji <span class="number">1049089</span> <span class="number">0</span> <span class="number">1</span>月  <span class="number">10</span> <span class="number">13</span>:<span class="number">30</span> roles/</span><br><span class="line"></span><br><span class="line">配置deploy.retry</span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim deploy.retry</span><br><span class="line">test.example.com</span><br></pre></td></tr></table></figure>



<p>配置deploy.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">xueji@xueji</span> <span class="string">MINGW64</span> <span class="string">~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks</span> <span class="string">(master)</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">deploy.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">backup_to:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;root&#125;&#125;</span>_<span class="template-variable">&#123;&#123;branch&#125;&#125;</span>_<span class="template-variable">&#123;&#123;ansible_date_time.epoch&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wordpress</span></span><br></pre></td></tr></table></figure>



<p>配置dev</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim inventory/dev</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line"><span class="attribute">server_name</span>=test.example.com</span><br><span class="line"><span class="attribute">port</span>=8080</span><br><span class="line"><span class="attribute">user</span>=deploy</span><br><span class="line"><span class="attribute">worker_processes</span>=2</span><br><span class="line"><span class="attribute">max_open_file</span>=30000</span><br><span class="line"><span class="attribute">root</span>=/data/www</span><br><span class="line"><span class="attribute">gitlab_user</span>=<span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="attribute">gitlab_pass</span>=<span class="string">&#x27;12345678&#x27;</span></span><br></pre></td></tr></table></figure>



<p>配置prod</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim inventory/prod</span><br><span class="line">[wordpress]</span><br><span class="line">test.example.com</span><br><span class="line"></span><br><span class="line">[wordpress:vars]</span><br><span class="line"><span class="attribute">server_name</span>=test.example.com</span><br><span class="line"><span class="attribute">port</span>=80</span><br><span class="line"><span class="attribute">user</span>=deploy</span><br><span class="line"><span class="attribute">worker_processes</span>=4</span><br><span class="line"><span class="attribute">max_open_file</span>=65505</span><br><span class="line"><span class="attribute">root</span>=/data/www</span><br><span class="line"><span class="attribute">gitlab_user</span>=<span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="attribute">gitlab_pass</span>=<span class="string">&#x27;12345678&#x27;</span></span><br></pre></td></tr></table></figure>



<p>配置health_check.sh和info.php</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/wordpress/</span>files/health_check.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">URL=<span class="variable">$1</span></span><br><span class="line">PORT=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">curl -Is http:<span class="regexp">//</span><span class="variable">$URL</span>:<span class="variable">$PORT</span><span class="regexp">/info.php &gt; /</span>dev/null &amp;&amp; echo <span class="string">&quot;The remote side is healthy&quot;</span> || echo <span class="string">&quot;The remote side is failed, please check&quot;</span></span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ echo <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> &gt;&gt; roles<span class="regexp">/wordpress/</span>files/info.php</span><br></pre></td></tr></table></figure>



<p>配置<a href="http://www.conf/">www.conf</a></p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">xueji<span class="symbol">@xueji</span> MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim roles/wordpress/files/www.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">; Start a new pool named &#x27;www&#x27;.</span></span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line"><span class="comment">; Unix user/group of processes</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The user is mandatory. If the group is not set, the default user&#x27;s group</span></span><br><span class="line"><span class="comment">;       will be used.</span></span><br><span class="line"><span class="comment">; RPM: apache Choosed to be able to access some dir as httpd</span></span><br><span class="line">user = deploy</span><br><span class="line"><span class="comment">; RPM: Keep a group allowed to write in log dir.</span></span><br><span class="line">group = deploy</span><br><span class="line"></span><br><span class="line"><span class="comment">; The address on which to accept FastCGI requests.</span></span><br><span class="line"><span class="comment">; Valid syntaxes are:</span></span><br><span class="line"><span class="comment">;   &#x27;ip.add.re.ss:port&#x27;    - to listen on a TCP socket to a specific IPv4 address on</span></span><br><span class="line"><span class="comment">;                            a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;[ip:6:addr:ess]:port&#x27; - to listen on a TCP socket to a specific IPv6 address on</span></span><br><span class="line"><span class="comment">;                            a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;port&#x27;                 - to listen on a TCP socket to all addresses</span></span><br><span class="line"><span class="comment">;                            (IPv6 and IPv4-mapped) on a specific port;</span></span><br><span class="line"><span class="comment">;   &#x27;/path/to/unix/socket&#x27; - to listen on a unix socket.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line"><span class="comment">;listen = 127.0.0.1:9000</span></span><br><span class="line">listen = /var/<span class="built_in">run</span>/php-fpm/php-fpm.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set listen(2) backlog.</span></span><br><span class="line"><span class="comment">; Default Value: 511 (-1 on FreeBSD and OpenBSD)</span></span><br><span class="line"><span class="comment">;listen.backlog = 511</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set permissions for unix socket, if one is used. In Linux, read/write</span></span><br><span class="line"><span class="comment">; permissions must be set in order to allow connections from a web server. Many</span></span><br><span class="line"><span class="comment">; BSD-derived systems allow connections regardless of permissions.</span></span><br><span class="line"><span class="comment">; Default Values: user and group are set as the running user</span></span><br><span class="line"><span class="comment">;                 mode is set to 0660</span></span><br><span class="line">listen.owner = deploy</span><br><span class="line">listen.group = deploy</span><br><span class="line"><span class="comment">;listen.mode = 0660</span></span><br><span class="line"><span class="comment">; When POSIX Access Control Lists are supported you can set them using</span></span><br><span class="line"><span class="comment">; these options, value is a comma separated list of user/group names.</span></span><br><span class="line"><span class="comment">; When set, listen.owner and listen.group are ignored</span></span><br><span class="line"><span class="comment">;listen.acl_users =</span></span><br><span class="line"><span class="comment">;listen.acl_groups =</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; List of addresses (IPv4/IPv6) of FastCGI clients which are allowed to connect.</span></span><br><span class="line"><span class="comment">; Equivalent to the FCGI_WEB_SERVER_ADDRS environment variable in the original</span></span><br><span class="line"><span class="comment">; PHP FCGI (5.2.2+). Makes sense only with a tcp listening socket. Each address</span></span><br><span class="line"><span class="comment">; must be separated by a comma. If this value is left blank, connections will be</span></span><br><span class="line"><span class="comment">; accepted from any ip address.</span></span><br><span class="line"><span class="comment">; Default Value: any</span></span><br><span class="line">listen.allowed_clients = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Specify the nice(2) priority to apply to the pool processes (only if set)</span></span><br><span class="line"><span class="comment">; The value can vary from -19 (highest priority) to 20 (lower priority)</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> - It will only work if the FPM master process is launched as root</span></span><br><span class="line"><span class="comment">;       - The pool processes will inherit the master process priority</span></span><br><span class="line"><span class="comment">;         unless it specified otherwise</span></span><br><span class="line"><span class="comment">; Default Value: no set</span></span><br><span class="line"><span class="comment">; process.priority = -19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Choose how the process manager will control the number of child processes.</span></span><br><span class="line"><span class="comment">; Possible Values:</span></span><br><span class="line"><span class="comment">;   static  - a fixed number (pm.max_children) of child processes;</span></span><br><span class="line"><span class="comment">;   dynamic - the number of child processes are set dynamically based on the</span></span><br><span class="line"><span class="comment">;             following directives. With this process management, there will be</span></span><br><span class="line"><span class="comment">;             always at least 1 children.</span></span><br><span class="line"><span class="comment">;             pm.max_children      - the maximum number of children that can</span></span><br><span class="line"><span class="comment">;                                    be alive at the same time.</span></span><br><span class="line"><span class="comment">;             pm.start_servers     - the number of children created on startup.</span></span><br><span class="line"><span class="comment">;             pm.min_spare_servers - the minimum number of children in &#x27;idle&#x27;</span></span><br><span class="line"><span class="comment">;                                    state (waiting to process). If the number</span></span><br><span class="line"><span class="comment">;                                    of &#x27;idle&#x27; processes is less than this</span></span><br><span class="line"><span class="comment">;                                    number then some children will be created.</span></span><br><span class="line"><span class="comment">;             pm.max_spare_servers - the maximum number of children in &#x27;idle&#x27;</span></span><br><span class="line"><span class="comment">;                                    state (waiting to process). If the number</span></span><br><span class="line"><span class="comment">;                                    of &#x27;idle&#x27; processes is greater than this</span></span><br><span class="line"><span class="comment">;                                    number then some children will be killed.</span></span><br><span class="line"><span class="comment">;  ondemand - no children are created at startup. Children will be forked when</span></span><br><span class="line"><span class="comment">;             new requests will connect. The following parameter are used:</span></span><br><span class="line"><span class="comment">;             pm.max_children           - the maximum number of children that</span></span><br><span class="line"><span class="comment">;                                         can be alive at the same time.</span></span><br><span class="line"><span class="comment">;             pm.process_idle_timeout   - The number of seconds after which</span></span><br><span class="line"><span class="comment">;                                         an idle process will be killed.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line">pm = dynamic</span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of child processes to be created when pm is set to &#x27;static&#x27; and the</span></span><br><span class="line"><span class="comment">; maximum number of child processes when pm is set to &#x27;dynamic&#x27; or &#x27;ondemand&#x27;.</span></span><br><span class="line"><span class="comment">; This value sets the limit on the number of simultaneous requests that will be</span></span><br><span class="line"><span class="comment">; served. Equivalent to the ApacheMaxClients directive with mpm_prefork.</span></span><br><span class="line"><span class="comment">; Equivalent to the PHP_FCGI_CHILDREN environment variable in the original PHP</span></span><br><span class="line"><span class="comment">; CGI.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used when pm is set to &#x27;static&#x27;, &#x27;dynamic&#x27; or &#x27;ondemand&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> This value is mandatory.</span></span><br><span class="line">pm.max_children = <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of child processes created on startup.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2</span></span><br><span class="line">pm.start_servers = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The desired minimum number of idle server processes.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Mandatory when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line">pm.min_spare_servers = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The desired maximum number of idle server processes.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Mandatory when pm is set to &#x27;dynamic&#x27;</span></span><br><span class="line">pm.max_spare_servers = <span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of seconds after which an idle process will be killed.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> Used only when pm is set to &#x27;ondemand&#x27;</span></span><br><span class="line"><span class="comment">; Default Value: 10s</span></span><br><span class="line"><span class="comment">;pm.process_idle_timeout = 10s;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The number of requests each child process should execute before respawning.</span></span><br><span class="line"><span class="comment">; This can be useful to work around memory leaks in 3rd party libraries. For</span></span><br><span class="line"><span class="comment">; endless request processing specify &#x27;0&#x27;. Equivalent to PHP_FCGI_MAX_REQUESTS.</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;pm.max_requests = 500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The URI to view the FPM status page. If this value is not set, no URI will be</span></span><br><span class="line"><span class="comment">; recognized as a status page. It shows the following informations:</span></span><br><span class="line"><span class="comment">;   pool                 - the name of the pool;</span></span><br><span class="line"><span class="comment">;   process manager      - static, dynamic or ondemand;</span></span><br><span class="line"><span class="comment">;   start time           - the date and time FPM has started;</span></span><br><span class="line"><span class="comment">;   start since          - number of seconds since FPM has started;</span></span><br><span class="line"><span class="comment">;   accepted conn        - the number of request accepted by the pool;</span></span><br><span class="line"><span class="comment">;   listen queue         - the number of request in the queue of pending</span></span><br><span class="line"><span class="comment">;                          connections (see backlog in listen(2));</span></span><br><span class="line"><span class="comment">;   max listen queue     - the maximum number of requests in the queue</span></span><br><span class="line"><span class="comment">;                          of pending connections since FPM has started;</span></span><br><span class="line"><span class="comment">;   listen queue len     - the size of the socket queue of pending connections;</span></span><br><span class="line"><span class="comment">;   idle processes       - the number of idle processes;</span></span><br><span class="line"><span class="comment">;   active processes     - the number of active processes;</span></span><br><span class="line"><span class="comment">;   total processes      - the number of idle + active processes;</span></span><br><span class="line"><span class="comment">;   max active processes - the maximum number of active processes since FPM</span></span><br><span class="line"><span class="comment">;                          has started;</span></span><br><span class="line"><span class="comment">;   max children reached - number of times, the process limit has been reached,</span></span><br><span class="line"><span class="comment">;                          when pm tries to start more children (works only for</span></span><br><span class="line"><span class="comment">;                          pm &#x27;dynamic&#x27; and &#x27;ondemand&#x27;);</span></span><br><span class="line"><span class="comment">; Value are updated in real time.</span></span><br><span class="line"><span class="comment">; Example output:</span></span><br><span class="line"><span class="comment">;   pool:                 www</span></span><br><span class="line"><span class="comment">;   process manager:      static</span></span><br><span class="line"><span class="comment">;   start time:           01/Jul/2011:17:53:49 +0200</span></span><br><span class="line"><span class="comment">;   start since:          62636</span></span><br><span class="line"><span class="comment">;   accepted conn:        190460</span></span><br><span class="line"><span class="comment">;   listen queue:         0</span></span><br><span class="line"><span class="comment">;   max listen queue:     1</span></span><br><span class="line"><span class="comment">;   listen queue len:     42</span></span><br><span class="line"><span class="comment">;   idle processes:       4</span></span><br><span class="line"><span class="comment">;   active processes:     11</span></span><br><span class="line"><span class="comment">;   total processes:      15</span></span><br><span class="line"><span class="comment">;   max active processes: 12</span></span><br><span class="line"><span class="comment">;   max children reached: 0</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; By default the status page output is formatted as text/plain. Passing either</span></span><br><span class="line"><span class="comment">; &#x27;html&#x27;, &#x27;xml&#x27; or &#x27;json&#x27; in the query string will return the corresponding</span></span><br><span class="line"><span class="comment">; output syntax. Example:</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?json</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?html</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?xml</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; By default the status page only outputs short status. Passing &#x27;full&#x27; in the</span></span><br><span class="line"><span class="comment">; query string will also return status for each pool process.</span></span><br><span class="line"><span class="comment">; Example:</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?json&amp;full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?html&amp;full</span></span><br><span class="line"><span class="comment">;   http://www.foo.bar/status?xml&amp;full</span></span><br><span class="line"><span class="comment">; The Full status returns for each process:</span></span><br><span class="line"><span class="comment">;   pid                  - the PID of the process;</span></span><br><span class="line"><span class="comment">;   state                - the state of the process (Idle, Running, ...);</span></span><br><span class="line"><span class="comment">;   start time           - the date and time the process has started;</span></span><br><span class="line"><span class="comment">;   start since          - the number of seconds since the process has started;</span></span><br><span class="line"><span class="comment">;   requests             - the number of requests the process has served;</span></span><br><span class="line"><span class="comment">;   request duration     - the duration in µs of the requests;</span></span><br><span class="line"><span class="comment">;   request method       - the request method (GET, POST, ...);</span></span><br><span class="line"><span class="comment">;   request URI          - the request URI with the query string;</span></span><br><span class="line"><span class="comment">;   content length       - the content length of the request (only with POST);</span></span><br><span class="line"><span class="comment">;   user                 - the user (PHP_AUTH_USER) (or &#x27;-&#x27; if not set);</span></span><br><span class="line"><span class="comment">;   script               - the main script called (or &#x27;-&#x27; if not set);</span></span><br><span class="line"><span class="comment">;   last request cpu     - the %cpu the last request consumed</span></span><br><span class="line"><span class="comment">;                          it&#x27;s always 0 if the process is not in Idle state</span></span><br><span class="line"><span class="comment">;                          because CPU calculation is done when the request</span></span><br><span class="line"><span class="comment">;                          processing has terminated;</span></span><br><span class="line"><span class="comment">;   last request memory  - the max amount of memory the last request consumed</span></span><br><span class="line"><span class="comment">;                          it&#x27;s always 0 if the process is not in Idle state</span></span><br><span class="line"><span class="comment">;                          because memory calculation is done when the request</span></span><br><span class="line"><span class="comment">;                          processing has terminated;</span></span><br><span class="line"><span class="comment">; If the process is in Idle state, then informations are related to the</span></span><br><span class="line"><span class="comment">; last request the process has served. Otherwise informations are related to</span></span><br><span class="line"><span class="comment">; the current request being served.</span></span><br><span class="line"><span class="comment">; Example output:</span></span><br><span class="line"><span class="comment">;   ************************</span></span><br><span class="line"><span class="comment">;   pid:                  31330</span></span><br><span class="line"><span class="comment">;   state:                Running</span></span><br><span class="line"><span class="comment">;   start time:           01/Jul/2011:17:53:49 +0200</span></span><br><span class="line"><span class="comment">;   start since:          63087</span></span><br><span class="line"><span class="comment">;   requests:             12808</span></span><br><span class="line"><span class="comment">;   request duration:     1250261</span></span><br><span class="line"><span class="comment">;   request method:       GET</span></span><br><span class="line"><span class="comment">;   request URI:          /test_mem.php?N=10000</span></span><br><span class="line"><span class="comment">;   content length:       0</span></span><br><span class="line"><span class="comment">;   user:                 -</span></span><br><span class="line"><span class="comment">;   script:               /home/fat/web/docs/php/test_mem.php</span></span><br><span class="line"><span class="comment">;   last request cpu:     0.00</span></span><br><span class="line"><span class="comment">;   last request memory:  0</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> There is a real-time FPM status monitoring sample web page available</span></span><br><span class="line"><span class="comment">;       It&#x27;s available in: @EXPANDED_DATADIR@/fpm/status.html</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The value must start with a leading slash (/). The value can be</span></span><br><span class="line"><span class="comment">;       anything, but it may not be a good idea to use the .php extension or it</span></span><br><span class="line"><span class="comment">;       may conflict with a real PHP file.</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;pm.status_path = /status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The ping URI to call the monitoring page of FPM. If this value is not set, no</span></span><br><span class="line"><span class="comment">; URI will be recognized as a ping page. This could be used to test from outside</span></span><br><span class="line"><span class="comment">; that FPM is alive and responding, or to</span></span><br><span class="line"><span class="comment">; - create a graph of FPM availability (rrd or such);</span></span><br><span class="line"><span class="comment">; - remove a server from a group if it is not responding (load balancing);</span></span><br><span class="line"><span class="comment">; - trigger alerts for the operating team (24/7).</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> The value must start with a leading slash (/). The value can be</span></span><br><span class="line"><span class="comment">;       anything, but it may not be a good idea to use the .php extension or it</span></span><br><span class="line"><span class="comment">;       may conflict with a real PHP file.</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;ping.path = /ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; This directive may be used to customize the response of a ping request. The</span></span><br><span class="line"><span class="comment">; response is formatted as text/plain with a 200 response code.</span></span><br><span class="line"><span class="comment">; Default Value: pong</span></span><br><span class="line"><span class="comment">;ping.response = pong</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The access log file</span></span><br><span class="line"><span class="comment">; Default: not set</span></span><br><span class="line"><span class="comment">;access.log = log/$pool.access.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The access log format.</span></span><br><span class="line"><span class="comment">; The following syntax is allowed</span></span><br><span class="line"><span class="comment">;  %%: the &#x27;%&#x27; character</span></span><br><span class="line"><span class="comment">;  %C: %CPU used by the request</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;user&#125;C for user CPU only</span></span><br><span class="line"><span class="comment">;      - %&#123;system&#125;C for system CPU only</span></span><br><span class="line"><span class="comment">;      - %&#123;total&#125;C  for user + system CPU (default)</span></span><br><span class="line"><span class="comment">;  %d: time taken to serve the request</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;seconds&#125;d (default)</span></span><br><span class="line"><span class="comment">;      - %&#123;miliseconds&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;mili&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;microseconds&#125;d</span></span><br><span class="line"><span class="comment">;      - %&#123;micro&#125;d</span></span><br><span class="line"><span class="comment">;  %e: an environment variable (same as $_ENV or $_SERVER)</span></span><br><span class="line"><span class="comment">;      it must be associated with embraces to specify the name of the env</span></span><br><span class="line"><span class="comment">;      variable. Some exemples:</span></span><br><span class="line"><span class="comment">;      - server specifics like: %&#123;REQUEST_METHOD&#125;e or %&#123;SERVER_PROTOCOL&#125;e</span></span><br><span class="line"><span class="comment">;      - HTTP headers like: %&#123;HTTP_HOST&#125;e or %&#123;HTTP_USER_AGENT&#125;e</span></span><br><span class="line"><span class="comment">;  %f: script filename</span></span><br><span class="line"><span class="comment">;  %l: content-length of the request (for POST request only)</span></span><br><span class="line"><span class="comment">;  %m: request method</span></span><br><span class="line"><span class="comment">;  %M: peak of memory allocated by PHP</span></span><br><span class="line"><span class="comment">;      it can accept the following format:</span></span><br><span class="line"><span class="comment">;      - %&#123;bytes&#125;M (default)</span></span><br><span class="line"><span class="comment">;      - %&#123;kilobytes&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;kilo&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;megabytes&#125;M</span></span><br><span class="line"><span class="comment">;      - %&#123;mega&#125;M</span></span><br><span class="line"><span class="comment">;  %n: pool name</span></span><br><span class="line"><span class="comment">;  %o: output header</span></span><br><span class="line"><span class="comment">;      it must be associated with embraces to specify the name of the header:</span></span><br><span class="line"><span class="comment">;      - %&#123;Content-Type&#125;o</span></span><br><span class="line"><span class="comment">;      - %&#123;X-Powered-By&#125;o</span></span><br><span class="line"><span class="comment">;      - %&#123;Transfert-Encoding&#125;o</span></span><br><span class="line"><span class="comment">;      - ....</span></span><br><span class="line"><span class="comment">;  %p: PID of the child that serviced the request</span></span><br><span class="line"><span class="comment">;  %P: PID of the parent of the child that serviced the request</span></span><br><span class="line"><span class="comment">;  %q: the query string</span></span><br><span class="line"><span class="comment">;  %Q: the &#x27;?&#x27; character if query string exists</span></span><br><span class="line"><span class="comment">;  %r: the request URI (without the query string, see %q and %Q)</span></span><br><span class="line"><span class="comment">;  %R: remote IP address</span></span><br><span class="line"><span class="comment">;  %s: status (response code)</span></span><br><span class="line"><span class="comment">;  %t: server time the request was received</span></span><br><span class="line"><span class="comment">;      it can accept a strftime(3) format:</span></span><br><span class="line"><span class="comment">;      %d/%b/%Y:%H:%M:%S %z (default)</span></span><br><span class="line"><span class="comment">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span></span><br><span class="line"><span class="comment">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span></span><br><span class="line"><span class="comment">;  %T: time the log has been written (the request has finished)</span></span><br><span class="line"><span class="comment">;      it can accept a strftime(3) format:</span></span><br><span class="line"><span class="comment">;      %d/%b/%Y:%H:%M:%S %z (default)</span></span><br><span class="line"><span class="comment">;      The strftime(3) format must be encapsuled in a %&#123;&lt;strftime_format&gt;&#125;t tag</span></span><br><span class="line"><span class="comment">;      e.g. for a ISO8601 formatted timestring, use: %&#123;%Y-%m-%dT%H:%M:%S%z&#125;t</span></span><br><span class="line"><span class="comment">;  %u: remote user</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Default: &quot;%R - %u %t \&quot;%m %r\&quot; %s&quot;</span></span><br><span class="line"><span class="comment">;access.format = &quot;%R - %u %t \&quot;%m %r%Q%q\&quot; %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The log file for slow requests</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> slowlog is mandatory if request_slowlog_timeout is set</span></span><br><span class="line">slowlog = /var/<span class="built_in">log</span>/php-fpm/www-slow.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The timeout for serving a single request after which a PHP backtrace will be</span></span><br><span class="line"><span class="comment">; dumped to the &#x27;slowlog&#x27; file. A value of &#x27;0s&#x27; means &#x27;off&#x27;.</span></span><br><span class="line"><span class="comment">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;request_slowlog_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The timeout for serving a single request after which the worker process will</span></span><br><span class="line"><span class="comment">; be killed. This option should be used when the &#x27;max_execution_time&#x27; ini option</span></span><br><span class="line"><span class="comment">; does not stop script execution for some reason. A value of &#x27;0&#x27; means &#x27;off&#x27;.</span></span><br><span class="line"><span class="comment">; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)</span></span><br><span class="line"><span class="comment">; Default Value: 0</span></span><br><span class="line"><span class="comment">;request_terminate_timeout = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set open file descriptor rlimit.</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_files = 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set max core size rlimit.</span></span><br><span class="line"><span class="comment">; Possible Values: &#x27;unlimited&#x27; or an integer greater or equal to 0</span></span><br><span class="line"><span class="comment">; Default Value: system defined value</span></span><br><span class="line"><span class="comment">;rlimit_core = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Chroot to this directory at the start. This value must be defined as an</span></span><br><span class="line"><span class="comment">; absolute path. When this value is not set, chroot is not used.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> chrooting is a great security feature and should be used whenever</span></span><br><span class="line"><span class="comment">;       possible. However, all PHP paths will be relative to the chroot</span></span><br><span class="line"><span class="comment">;       (error_log, sessions.save_path, ...).</span></span><br><span class="line"><span class="comment">; Default Value: not set</span></span><br><span class="line"><span class="comment">;chroot =</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Chdir to this directory at the start.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> relative path can be used.</span></span><br><span class="line"><span class="comment">; Default Value: current directory or / when chroot</span></span><br><span class="line"><span class="comment">;chdir = /var/www</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Redirect worker stdout and stderr into main error log. If not set, stdout and</span></span><br><span class="line"><span class="comment">; stderr will be redirected to /dev/null according to FastCGI specs.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> on highloaded environement, this can cause some delay in the page</span></span><br><span class="line"><span class="comment">; process time (several ms).</span></span><br><span class="line"><span class="comment">; Default Value: no</span></span><br><span class="line"><span class="comment">;catch_workers_output = yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Clear environment in FPM workers</span></span><br><span class="line"><span class="comment">; Prevents arbitrary environment variables from reaching FPM worker processes</span></span><br><span class="line"><span class="comment">; by clearing the environment in workers before env vars specified in this</span></span><br><span class="line"><span class="comment">; pool configuration are added.</span></span><br><span class="line"><span class="comment">; Setting to &quot;no&quot; will make all environment variables available to PHP code</span></span><br><span class="line"><span class="comment">; via getenv(), $_ENV and $_SERVER.</span></span><br><span class="line"><span class="comment">; Default Value: yes</span></span><br><span class="line"><span class="comment">;clear_env = no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Limits the extensions of the main script FPM will allow to parse. This can</span></span><br><span class="line"><span class="comment">; prevent configuration mistakes on the web server side. You should only limit</span></span><br><span class="line"><span class="comment">; FPM to .php extensions to prevent malicious users to use other extensions to</span></span><br><span class="line"><span class="comment">; exectute php code.</span></span><br><span class="line"><span class="comment">; <span class="doctag">Note:</span> set an empty value to allow all extensions.</span></span><br><span class="line"><span class="comment">; Default Value: .php</span></span><br><span class="line"><span class="comment">;security.limit_extensions = .php .php3 .php4 .php5 .php7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from</span></span><br><span class="line"><span class="comment">; the current environment.</span></span><br><span class="line"><span class="comment">; Default Value: clean env</span></span><br><span class="line"><span class="comment">;env[HOSTNAME] = $HOSTNAME</span></span><br><span class="line"><span class="comment">;env[PATH] = /usr/local/bin:/usr/bin:/bin</span></span><br><span class="line"><span class="comment">;env[TMP] = /tmp</span></span><br><span class="line"><span class="comment">;env[TMPDIR] = /tmp</span></span><br><span class="line"><span class="comment">;env[TEMP] = /tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Additional php.ini defines, specific to this pool of workers. These settings</span></span><br><span class="line"><span class="comment">; overwrite the values previously defined in the php.ini. The directives are the</span></span><br><span class="line"><span class="comment">; same as the PHP SAPI:</span></span><br><span class="line"><span class="comment">;   php_value/php_flag             - you can set classic ini defines which can</span></span><br><span class="line"><span class="comment">;                                    be overwritten from PHP call &#x27;ini_set&#x27;.</span></span><br><span class="line"><span class="comment">;   php_admin_value/php_admin_flag - these directives won&#x27;t be overwritten by</span></span><br><span class="line"><span class="comment">;                                     PHP call &#x27;ini_set&#x27;</span></span><br><span class="line"><span class="comment">; For php_*flag, valid values are on, off, 1, 0, true, false, yes or no.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Defining &#x27;extension&#x27; will load the corresponding shared extension from</span></span><br><span class="line"><span class="comment">; extension_dir. Defining &#x27;disable_functions&#x27; or &#x27;disable_classes&#x27; will not</span></span><br><span class="line"><span class="comment">; overwrite previously defined php.ini values, but will append the new value</span></span><br><span class="line"><span class="comment">; instead.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Default Value: nothing is defined by default except the values in php.ini and</span></span><br><span class="line"><span class="comment">;                specified at startup with the -d argument</span></span><br><span class="line"><span class="comment">;php_admin_value[sendmail_path] = /usr/sbin/sendmail -t -i -f www@my.domain.com</span></span><br><span class="line"><span class="comment">;php_flag[display_errors] = off</span></span><br><span class="line">php_admin_value[error_log] = /var/<span class="built_in">log</span>/php-fpm/www-error.<span class="built_in">log</span></span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line"><span class="comment">;php_admin_value[memory_limit] = 128M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Set session path to a directory owned by process user</span></span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path]    = /var/lib/php/session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcache</span><br></pre></td></tr></table></figure>



<p>配置main.yml</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ vim roles/wordpress/tasks/main.yml</span><br><span class="line"></span><br><span class="line">- name: Update yum dependency</span><br><span class="line">  shell: <span class="string">&#x27;yum update -y warn=False&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Disable</span><span class="built_in"> system </span>firewall</span><br><span class="line">  service: <span class="attribute">name</span>=firewalld <span class="attribute">state</span>=stopped</span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Disable</span> SELINX</span><br><span class="line">  selinux: <span class="attribute">state</span>=disabled</span><br><span class="line"></span><br><span class="line">- name: Setup epel yum source <span class="keyword">for</span> nginx <span class="keyword">and</span> mariadb(mysql)</span><br><span class="line">  yum: <span class="attribute">pkg</span>=epel-release <span class="attribute">state</span>=latest</span><br><span class="line"></span><br><span class="line">- name: Setup webtatic yum source <span class="keyword">for</span> php-fpm</span><br><span class="line">  yum: <span class="attribute">name</span>=https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line"></span><br><span class="line">- name: Ensure nginx is at the latest version</span><br><span class="line">  yum: <span class="attribute">pkg</span>=nginx <span class="attribute">state</span>=latest</span><br><span class="line"></span><br><span class="line">- name: Write the nginx<span class="built_in"> config </span>file</span><br><span class="line">  template: <span class="attribute">src</span>=roles/wordpress/templates/nginx.conf.j2 <span class="attribute">dest</span>=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">- name: Create nginx root folder</span><br><span class="line">  file: <span class="string">&#x27;path=&#123;&#123; root &#125;&#125; state=directory owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125; mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Copy info.php <span class="keyword">to</span> remote</span><br><span class="line">  copy: <span class="string">&#x27;remote_src=no src=roles/wordpress/files/info.php dest=/data/www/info.php mode=0755&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart nginx service</span><br><span class="line">  service: <span class="attribute">name</span>=nginx <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: Setup php-fpm</span><br><span class="line">  command: <span class="string">&#x27;yum install -y php70w php70w-fpm php70w-common php70w-mysql php70w-gd php70w-xml php70w-mbstring php70w-mcrypt warn=False&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: <span class="attribute">name</span>=php-fpm <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: Copy php-fpm<span class="built_in"> config </span>file <span class="keyword">to</span> remote</span><br><span class="line">  copy: <span class="string">&#x27;remote_src=no src=roles/wordpress/files/www.conf dest=/etc/php-fpm.d/www.conf mode=0755 owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125; force=yes&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Restart php-fpm service</span><br><span class="line">  service: <span class="attribute">name</span>=php-fpm <span class="attribute">state</span>=restarted</span><br><span class="line"></span><br><span class="line">- name: <span class="builtin-name">Run</span> the<span class="built_in"> health </span>check locally</span><br><span class="line">  shell: <span class="string">&quot;sh roles/wordpress/files/health_check.sh &#123;&#123; server_name &#125;&#125; &#123;&#123; port &#125;&#125;&quot;</span></span><br><span class="line">  delegate_to: localhost</span><br><span class="line">  register: health_status</span><br><span class="line"></span><br><span class="line">- debug: <span class="attribute">msg</span>=<span class="string">&quot;&#123;&#123; health_status.stdout &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">- name: Setup mariadb(mysql)</span><br><span class="line">  command: <span class="string">&quot;yum install -y mariadb mariadb-server warn=False&quot;</span></span><br><span class="line"></span><br><span class="line">- name: Backup current www folder</span><br><span class="line">  shell: <span class="string">&#x27;mv &#123;&#123; root &#125;&#125; &#123;&#123; backup_to &#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Close git ssl verification</span><br><span class="line">  shell: <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Clone WordPress repo <span class="keyword">to</span> remote</span><br><span class="line">  git: <span class="string">&quot;repo=https://&#123;&#123; gitlab_user | urlencode &#125;&#125;:&#123;&#123; gitlab_pass | urlencode &#125;&#125;@gitlab.example.com/root/Wordpress-project.git dest=/data/www version=&#123;&#123; branch &#125;&#125;&quot;</span></span><br><span class="line">  when: project == <span class="string">&#x27;wordpress&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: Change www folder permission</span><br><span class="line">  file: <span class="string">&quot;path=/data/www mode=0755 owner=&#123;&#123; user &#125;&#125; group=&#123;&#123; user &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<p>配置nginx.conf.j2</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ vim roles<span class="regexp">/wordpress/</span>templates/nginx.conf.j2</span><br><span class="line"><span class="comment"># For more information on configuration, see: </span></span><br><span class="line">user              &#123;&#123; user &#125;&#125;;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>error.log;  </span><br><span class="line">  </span><br><span class="line">pid        <span class="regexp">/var/</span>run/nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       <span class="regexp">/etc/</span>nginx/mime.types;  </span><br><span class="line">    default_type  application/octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span>  </span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span>  </span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    access_log  <span class="regexp">/var/</span>log<span class="regexp">/nginx/</span>access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    <span class="comment">#tcp_nopush     on;  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">#keepalive_timeout  0;  </span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">#gzip  on;  </span></span><br><span class="line">      </span><br><span class="line">    <span class="comment"># Load config files from the /etc/nginx/conf.d directory  </span></span><br><span class="line">    <span class="comment"># The default server is in conf.d/default.conf  </span></span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;  </span></span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       &#123;&#123; port &#125;&#125; default_server;  </span><br><span class="line">        server_name  &#123;&#123; server_name &#125;&#125;;  </span><br><span class="line">        root         &#123;&#123; root &#125;&#125;;</span><br><span class="line">        <span class="comment">#charset koi8-r;  </span></span><br><span class="line">  </span><br><span class="line">        location / &#123;  </span><br><span class="line">            index  index.html index.htm index.php;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            try_files <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">            fastcgi_pass unix:<span class="regexp">/var/</span>run<span class="regexp">/php-fpm/</span>php-fpm.sock;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">            fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地提交</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ pwd</span><br><span class="line"><span class="regexp">/c/U</span>sers<span class="regexp">/xueji/</span>Desktop<span class="regexp">/repo/</span>ansible-playbook-repo/wordpress_playbooks</span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/deploy.retry.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/deploy.yml.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/inventory/</span>dev.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/inventory/</span>prod.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>health_check.sh.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/m</span>ain.yml.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>www.conf.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/templates/</span>nginx.conf.j2.</span><br><span class="line">The <span class="keyword">file</span> will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git commit -m<span class="string">&quot;first commit&quot;</span></span><br><span class="line">[master c526626] first commit</span><br><span class="line"> <span class="number">9</span> files changed, <span class="number">564</span> insertions(+)</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks/deploy.retry</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks/deploy.yml</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/inventory/</span>dev</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/inventory/</span>prod</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>health_check.sh</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/m</span>ain.yml</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/</span>www.conf</span><br><span class="line"> create mode <span class="number">100644</span> wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/templates/</span>nginx.conf.j2</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/ansible-playbook-repo/</span>wordpress_playbooks (master)</span><br><span class="line">$ git <span class="keyword">push</span> origin master</span><br><span class="line">Enumerating objects: <span class="number">17</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">17</span>/<span class="number">17</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">13</span>/<span class="number">13</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">16</span><span class="regexp">/16), 8.48 KiB | 1.70 MiB/</span>s, done.</span><br><span class="line">Total <span class="number">16</span> (delta <span class="number">1</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo.git</span></span><br><span class="line">   <span class="number">06431</span>dc..c526626  master -&gt; master</span><br></pre></td></tr></table></figure>



<p>返回gitlab查看</p>
<p>93776</p>
<p>创建Wordpress-project仓库并提交本地代码到gitlab</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git -c http.sslVerify=<span class="keyword">false</span> clone https:<span class="comment">//gitlab.example.com/root/Wordpress-project.git</span></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git add .</span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">xueji@xueji MINGW64 ~<span class="regexp">/Desktop/</span>repo<span class="regexp">/1/</span>Wordpress-<span class="keyword">project</span> (master)</span><br><span class="line">$ git <span class="keyword">push</span> origin master</span><br></pre></td></tr></table></figure>



<p>登录到Jenkins web管理页</p>
<p>点击“New 任务”</p>
<p>95489</p>
<p>添加描述</p>
<p>95591</p>
<p>在如下输入框中输入</p>
<p>95700</p>
<p>pipeline script脚本内容（注意credentialsId要查看本地设置的凭据中的ID，复制过来替换掉即可）</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;node &#123;label <span class="string">&#x27;master&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        <span class="attribute">PATH</span>=<span class="string">&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(</span><br><span class="line">            choices: <span class="string">&#x27;dev\nrprod&#x27;</span>,</span><br><span class="line">            description: <span class="string">&#x27;Choose deploy environment&#x27;</span>,</span><br><span class="line">            name: <span class="string">&#x27;deploy_env&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        string (name: <span class="string">&#x27;branch&#x27;</span>, defaultValue: <span class="string">&#x27;master&#x27;</span>, description: <span class="string">&#x27;Fill in your ansible repo branch&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage (<span class="string">&quot;Pull deploy code&quot;</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;git config --global http.sslVerify false&#x27;</span></span><br><span class="line">                dir (<span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>&quot;</span>)&#123;</span><br><span class="line">                    git branch: <span class="string">&#x27;master&#x27;</span>, credentialsId: <span class="string">&#x27;&#x27;</span>, url: <span class="string">&#x27;https://gitlab.example.com/root/ansible-playbook-repo.git&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (<span class="string">&quot;Check env&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                set +x</span></span><br><span class="line"><span class="string">                user=`whoami`</span></span><br><span class="line"><span class="string">                if [ <span class="variable">$user</span> == deploy ]</span></span><br><span class="line"><span class="string">                then</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current deployment<span class="built_in"> user </span>is <span class="variable">$user</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current python version<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    python --version</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Current ansible version<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ansible-playbook --version</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Remote<span class="built_in"> system </span>disk space<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ssh root@test.example.com df -h</span></span><br><span class="line"><span class="string">                    echo &quot;</span>[<span class="builtin-name">INFO</span>] Rmote<span class="built_in"> system </span>RAM<span class="string">&quot;</span></span><br><span class="line"><span class="string">                    ssh root@test.example.com free -m</span></span><br><span class="line"><span class="string">                else</span></span><br><span class="line"><span class="string">                    echo &quot;</span>Deployment<span class="built_in"> user </span>is incorrect, please check<span class="string">&quot;</span></span><br><span class="line"><span class="string">                fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                set -x</span></span><br><span class="line"><span class="string">                &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage (<span class="string">&quot;Anisble deployment&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                input <span class="string">&quot;Do you approve the deployment?&quot;</span></span><br><span class="line">                dir(<span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/wordpress_playbooks&quot;</span>)&#123;</span><br><span class="line">                    echo <span class="string">&quot;[INFO] Start deployment&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                    set +x</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/bin/activate</span></span><br><span class="line"><span class="string">                    source /home/deploy/.py3-a2.5-env/ansible/hacking/env-setup -q</span></span><br><span class="line"><span class="string">                    ansible-playbook -i inventory/<span class="variable">$deploy_env</span> ./deploy.yml -e project=wordpress -e branch=<span class="variable">$branch</span> -e env=<span class="variable">$deploy_env</span></span></span><br><span class="line"><span class="string">                    set -x</span></span><br><span class="line"><span class="string">                    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">                    echo <span class="string">&quot;[INFO] Deployment finished...&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>凭据ID</p>
<p>105855</p>
<p>点击查看输出信息</p>
<p>105964</p>
<p>106060</p>
<p>(正常情况下)稍等片刻之后就会看到“SUCCESS”(注意首次构建可能会提示“No such property: deploy_env for class: groovy.lang.Binding”)遇到这个错误，只需返回到word press-pipeline-job工程点击“Build with Parameters”选择默认dev用户再次构建即可。</p>
<p>（纸上得来终觉浅，绝知此事要躬行，真的是各种采坑）久违的“SUCCESS”</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Do you approve the deployment?</span><br><span class="line">Proceed or Abort</span><br><span class="line"></span><br><span class="line">Approved by admin</span><br><span class="line">[Pipeline] dir</span><br><span class="line">Running in /var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress<span class="emphasis">_playbooks</span></span><br><span class="line"><span class="emphasis">[Pipeline] &#123;</span></span><br><span class="line"><span class="emphasis">[Pipeline] echo</span></span><br><span class="line"><span class="emphasis">[INFO] Start deployment</span></span><br><span class="line"><span class="emphasis">[Pipeline] sh</span></span><br><span class="line"><span class="emphasis">+ set +x</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">PLAY [wordpress] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [Gathering Facts] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : install git] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Update yum dependency] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Disable system firewall] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Disable SELINX] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Setup epel yum source for nginx and mariadb(mysql)] <span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Setup webtatic yum source for php-fpm] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">ok: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : Ensure nginx is at the latest version] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">ok: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Write the nginx config file] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">ok: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Create nginx root folder] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Copy info.php to remote] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Restart nginx service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Setup php-fpm] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Restart php-fpm service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Copy php-fpm config file to remote] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">ok: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Restart php-fpm service] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : Run the health check locally] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">changed: [test.example.com -&gt; localhost]</span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">TASK [wordpress : debug] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">ok: [test.example.com] =&gt; &#123;</span></span><br><span class="line"><span class="emphasis">    &quot;msg&quot;: &quot;The remote side is healthy&quot;</span></span><br><span class="line"><span class="emphasis">&#125;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Setup mariadb(mysql)] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">changed: [test.example.com]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK [wordpress : Backup current www folder] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Close git ssl verification] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">changed: [test.example.com]</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK [wordpress : Clone WordPress repo to remote] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK [wordpress : Change www folder permission] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">changed: [test.example.com]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">PLAY RECAP <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">test.example.com           : ok=23   changed=14   unreachable=0    failed=0   </span></span></span><br><span class="line"><span class="emphasis"><span class="strong"></span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] echo</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[INFO] Deployment finished...</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // dir</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // stage</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // withEnv</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] &#125;</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] // node</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">[Pipeline] End of Pipeline</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Finished: SUCCESS</span></span></span><br></pre></td></tr></table></figure>



<p>最后需要利用git bash或者xshell登录test.example.com主机上初始化MySQL数据库，（实际生产环境中不建议使用Jenkins重复构建初始化MySQL数据库，容易出现各种问题）</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">[root@test ~]<span class="meta"># systemctl status mariadb</span></span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (/usr/<span class="keyword">lib</span>/systemd/system/mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">[root@test ~]<span class="meta"># systemctl start mariadb</span></span><br><span class="line">[root@test ~]<span class="meta"># mysql_secure_installation</span></span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS <span class="keyword">OF</span> THIS SCRIPT <span class="keyword">IS</span> RECOMMENDED <span class="keyword">FOR</span> ALL MariaDB</span><br><span class="line">      SERVERS <span class="keyword">IN</span> PRODUCTION USE!  PLEASE READ <span class="keyword">EACH</span> <span class="keyword">STEP</span> CAREFULLY!</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> log <span class="keyword">into</span> MariaDB <span class="keyword">to</span> secure it, we<span class="comment">&#x27;ll need the current</span></span><br><span class="line">password <span class="keyword">for</span> the root user.  <span class="keyword">If</span> you<span class="comment">&#x27;ve just installed MariaDB, and</span></span><br><span class="line">you haven<span class="comment">&#x27;t set the root password yet, the password will be blank,</span></span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):   <span class="meta">#mariadb5.5首次安装没有root密码，所以直接回车即可</span></span><br><span class="line">OK, successfully used password, moving <span class="keyword">on</span>...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log <span class="keyword">into</span> the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> root password? [Y/n] y</span><br><span class="line"><span class="keyword">New</span> password:   <span class="meta">#123456</span></span><br><span class="line">Re-enter <span class="keyword">new</span> password:</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">By</span> <span class="keyword">default</span>, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line"><span class="keyword">to</span> log <span class="keyword">into</span> MariaDB without having <span class="keyword">to</span> have a user account created <span class="keyword">for</span></span><br><span class="line">them.  This <span class="keyword">is</span> intended only <span class="keyword">for</span> testing, <span class="keyword">and</span> <span class="keyword">to</span> make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving <span class="keyword">into</span> a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed <span class="keyword">to</span> connect <span class="keyword">from</span> <span class="comment">&#x27;localhost&#x27;.  This</span></span><br><span class="line">ensures that someone cannot guess at the root password <span class="keyword">from</span> the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"><span class="keyword">By</span> <span class="keyword">default</span>, MariaDB comes <span class="keyword">with</span> a database named <span class="comment">&#x27;test&#x27; that anyone can</span></span><br><span class="line">access.  This <span class="keyword">is</span> also intended only <span class="keyword">for</span> testing, <span class="keyword">and</span> should be removed</span><br><span class="line">before moving <span class="keyword">into</span> a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database <span class="keyword">and</span> access <span class="keyword">to</span> it? [Y/n] y</span><br><span class="line"> - Dropping test database...</span><br><span class="line"> ... Success!</span><br><span class="line"> - Removing privileges <span class="keyword">on</span> test database...</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will <span class="keyword">take</span> effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  <span class="keyword">If</span> you<span class="comment">&#x27;ve completed all of the above steps, your MariaDB</span></span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks <span class="keyword">for</span> <span class="keyword">using</span> MariaDB!</span><br></pre></td></tr></table></figure>



<p>创建wordpress数据库</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[root@test ~]# mysql -uroot -p123456</span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands end with ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MariaDB<span class="built_in"> connection </span>id is 10</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help.<span class="built_in"> Type </span><span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database wordpress character <span class="builtin-name">set</span> utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; \q</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>



<p>浏览器登录</p>
<p>141278</p>
<p>141374</p>
<p>141470</p>
<p>141566</p>
<p>141661</p>
<p>141756</p>
<p>141852</p>
<p>查看首页</p>
<p>141953</p>
<p>至此，使用Jenkins+Gitlab+Ansible自动化部署wordpresss全部完成。</p>
<p>接下来说说注意点，尽量避免以后重蹈覆辙：</p>
<p>第一次没有上传Wordpress-project仓库，也没有配置test.example.com主机上的/etc/hosts文件，导致在部署过程中一直卡在某个环节不动，或者直接提示</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Clone WordPress repo to remote] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**</span></span><br><span class="line"><span class="strong">fatal: [test.example.com]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;cmd&quot;: &quot;/usr/bin/git clone --origin origin &#x27;https://root:**</span><span class="strong">****</span><span class="strong">**@gitlab.example.com/root/Wordpress-project.git&#x27; /data/www&quot;, &quot;msg&quot;: &quot;fatal: unable to access &#x27;https://root:**</span><span class="strong">****</span><span class="strong">**@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error&quot;, &quot;rc&quot;: 128, &quot;stderr&quot;: &quot;fatal: unable to access &#x27;https://root:12345678@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error\n&quot;, &quot;stderr<span class="emphasis">_lines&quot;: [&quot;fatal: unable to access &#x27;https://root:12345678@gitlab.example.com/root/Wordpress-project.git/&#x27;: Could not resolve host: gitlab.example.com; Unknown error&quot;], &quot;stdout&quot;: &quot;Cloning into &#x27;/data/www&#x27;...\n&quot;, &quot;stdout_</span>lines&quot;: [&quot;Cloning into &#x27;/data/www&#x27;...&quot;]&#125;</span></span><br><span class="line"><span class="strong">    to retry, use: --limit @/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress<span class="emphasis">_playbooks/deploy.retry</span></span></span><br><span class="line"><span class="strong"><span class="emphasis"></span></span></span><br><span class="line"><span class="strong"><span class="emphasis">PLAY RECAP <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span></span><br></pre></td></tr></table></figure>

<p>145024</p>
<p>错误信息2</p>
<p>ansible-playbook-repo仓库中没有info.php文件，所以抛出以下异常</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Copy info.php to remote] *************************************</span><br><span class="line">An exception occurred during task execution. To see the full traceback, use -vvv. The error was:     <span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks<span class="regexp">/roles/</span>wordpress<span class="regexp">/files/i</span>nfo.php</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: false, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Could not find or access &#x27;roles/wordpress/files/info.php&#x27;\nSearched in:\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/files/roles/wordpress/files/info.php\n\t/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/files/info.php&quot;</span>&#125;</span><br><span class="line">    to retry, use: --limit @<span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks/deploy.retry</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">test.example.com           : ok=<span class="number">9</span>    changed=<span class="number">4</span>    unreachable=<span class="number">0</span>    failed=<span class="number">1</span>   </span><br><span class="line"></span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> dir</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> stage</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line"></span><br><span class="line">[Pipeline] <span class="regexp">//</span> withEnv</span><br><span class="line">[Pipeline] &#125;</span><br><span class="line">[Pipeline] <span class="regexp">//</span> node</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">ERROR: script returned <span class="keyword">exit</span> code <span class="number">2</span></span><br></pre></td></tr></table></figure>



<p>错误信息3</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Setup webtatic yum source <span class="keyword">for</span> php-fpm] ***********************</span><br><span class="line">Sending interrupt signal to process</span><br><span class="line">Aborted by admin</span><br><span class="line">fatal: [test.example.com]: UNREACHABLE! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: false, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Failed to connect to the host via ssh: Shared connection to test.example.com closed.\r\n&quot;</span>, <span class="string">&quot;unreachable&quot;</span>: true&#125;</span><br><span class="line"><span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks@tmp<span class="regexp">/durable-55384134/</span>script.sh: line <span class="number">5</span>: <span class="number">22534</span> Terminated              ansible-playbook -i inventory<span class="regexp">/dev ./</span>deploy.yml -e project=wordpress -e branch=master -e env=dev</span><br><span class="line">script returned <span class="keyword">exit</span> code <span class="number">143</span></span><br></pre></td></tr></table></figure>



<p>错误信息4</p>
<figure class="highlight roboconf"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : install git] *************************************************</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;&quot;<span class="attribute">changed&quot;</span>: true, &quot;cmd&quot;: &quot;yum install git&quot;, &quot;delta&quot;: &quot;0:00:04.471168&quot;, &quot;end&quot;: &quot;2019-01-10 18:05:37.319608&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 1, &quot;start&quot;: &quot;2019-01-10 18:05:32.848440&quot;, &quot;stderr&quot;: &quot;&quot;, &quot;stderr_lines&quot;: [], &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * epel: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * extras: mirrors.163<span class="variable">.com</span>\n * updates: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>\n * webtatic: us-east<span class="variable">.repo</span><span class="variable">.webtatic</span><span class="variable">.com</span>\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package git<span class="variable">.x</span>86_64 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed\n--&gt; Processing Dependency: perl-Git = 1.8.3.1-20<span class="variable">.el</span>7 for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64\n--&gt; Running transaction check\n---&gt; Package perl-Error<span class="variable">.noarch</span> 1:0.17020-2<span class="variable">.el</span>7 will be installed\n---&gt; Package perl-Git<span class="variable">.noarch</span> 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed\n---&gt; Package perl-TermReadKey<span class="variable">.x</span>86_64 0:2.30-20<span class="variable">.el</span>7 will be installed\n---&gt; Package rsync<span class="variable">.x</span>86_64 0:3.1.2-4<span class="variable">.el</span>7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package                Arch         Version                Repository     Size\n================================================================================\nInstalling:\n git                    x86_64       1.8.3.1-20<span class="variable">.el</span>7         updates       4.4 M\nInstalling for dependencies:\n perl-Error             noarch       1:0.17020-2<span class="variable">.el</span>7        base           32 k\n perl-Git               noarch       1.8.3.1-20<span class="variable">.el</span>7         updates        55 k\n perl-TermReadKey       x86_64       2.30-20<span class="variable">.el</span>7            base           31 k\n rsync                  x86_64       3.1.2-4<span class="variable">.el</span>7            base          403 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package (+4 Dependent packages)\n\nTotal download size: 4.9 M\nInstalled size: 23 M\nIs this ok [y/d/N]: Exiting on user command\nYour transaction was saved, rerun it with:\n yum load-transaction /tmp/yum_save_tx.2019-01-10.18-05<span class="variable">.jmunIG</span><span class="variable">.yumtx</span>&quot;, &quot;stdout_lines&quot;: [&quot;Loaded plugins: fastestmirror&quot;, &quot;Loading mirror speeds from cached hostfile&quot;, &quot; * base: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * epel: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * extras: mirrors.163<span class="variable">.com</span>&quot;, &quot; * updates: mirrors<span class="variable">.aliyun</span><span class="variable">.com</span>&quot;, &quot; * webtatic: us-east<span class="variable">.repo</span><span class="variable">.webtatic</span><span class="variable">.com</span>&quot;, &quot;Resolving Dependencies&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package git<span class="variable">.x</span>86_64 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed&quot;, &quot;--&gt; Processing Dependency: perl-Git = 1.8.3.1-20<span class="variable">.el</span>7 for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: rsync for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Term::ReadKey) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Git) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Processing Dependency: perl(Error) for package: git-1.8.3.1-20<span class="variable">.el</span>7<span class="variable">.x</span>86_64&quot;, &quot;--&gt; Running transaction check&quot;, &quot;---&gt; Package perl-Error<span class="variable">.noarch</span> 1:0.17020-2<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package perl-Git<span class="variable">.noarch</span> 0:1.8.3.1-20<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package perl-TermReadKey<span class="variable">.x</span>86_64 0:2.30-20<span class="variable">.el</span>7 will be installed&quot;, &quot;---&gt; Package rsync<span class="variable">.x</span>86_64 0:3.1.2-4<span class="variable">.el</span>7 will be installed&quot;, &quot;--&gt; Finished Dependency Resolution&quot;, &quot;&quot;, &quot;Dependencies Resolved&quot;, &quot;&quot;, &quot;================================================================================&quot;, &quot; Package                Arch         Version                Repository     Size&quot;, &quot;================================================================================&quot;, &quot;Installing:&quot;, &quot; git                    x86_64       1.8.3.1-20<span class="variable">.el</span>7         updates       4.4 M&quot;, &quot;Installing for dependencies:&quot;, &quot; perl-Error             noarch       1:0.17020-2<span class="variable">.el</span>7        base           32 k&quot;, &quot; perl-Git               noarch       1.8.3.1-20<span class="variable">.el</span>7         updates        55 k&quot;, &quot; perl-TermReadKey       x86_64       2.30-20<span class="variable">.el</span>7            base           31 k&quot;, &quot; rsync                  x86_64       3.1.2-4<span class="variable">.el</span>7            base          403 k&quot;, &quot;&quot;, &quot;Transaction Summary&quot;, &quot;================================================================================&quot;, &quot;Install  1 Package (+4 Dependent packages)&quot;, &quot;&quot;, &quot;Total download size: 4.9 M&quot;, &quot;Installed size: 23 M&quot;, &quot;Is this ok [y/d/N]: Exiting on user command&quot;, &quot;Your transaction was saved, rerun it with:&quot;, &quot; yum load-transaction /tmp/yum_save_tx.2019-01-10.18-05<span class="variable">.jmunIG</span><span class="variable">.yumtx</span>&quot;]&#125;</span><br><span class="line">    to retry, use: --limit @/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/deploy<span class="variable">.retry</span></span><br></pre></td></tr></table></figure>

<p>错误信息5</p>
<p>这个报错是在错误信息4之前，因为test.example.com主机没有git命令所以才有了错误信息4的步骤</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">TASK</span> [wordpress : Close git ssl verification] **********************************</span><br><span class="line">fatal: [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: <span class="keyword">true</span>, <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;git config --global http.sslVerify false&quot;</span>, <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.002747&quot;</span>, <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2019-01-10 18:00:36.334202&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;non-zero return code&quot;</span>, <span class="string">&quot;rc&quot;</span>: <span class="number">127</span>, <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2019-01-10 18:00:36.331455&quot;</span>, <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;/bin/sh: git: command not found&quot;</span>, <span class="string">&quot;stderr_lines&quot;</span>: [<span class="string">&quot;/bin/sh: git: command not found&quot;</span>], <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;stdout_lines&quot;</span>: []&#125;</span><br><span class="line">    to retry, use: --limit @<span class="regexp">/var/</span>lib<span class="regexp">/jenkins/</span>workspace<span class="regexp">/wordpress-pipeline-job/</span>wordpress_playbooks/deploy.retry</span><br></pre></td></tr></table></figure>

<p>错误信息6</p>
<p>这个变量没有在deploy.yml中定义，所以会抛出异常解决办法就是在deploy.yml中声明以下backup_to</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">TASK [wordpress : Backup current www folder] ***********************************</span><br><span class="line"><span class="symbol">fatal:</span> [test.example.com]: FAILED! =&gt; &#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;The task includes an option with an undefined variable. The error was: &#x27;backup_to&#x27; is undefined\n\nThe error appears to have been in &#x27;/var/lib/jenkins/workspace/wordpress-pipeline-job/wordpress_playbooks/roles/wordpress/tasks/main.yml&#x27;: line 53, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Backup current www folder\n  ^ here\n&quot;</span>&#125;</span><br><span class="line">    to retry, <span class="symbol">use:</span> --limit @/var/<span class="class"><span class="keyword">lib</span>/<span class="title">jenkins</span>/<span class="title">workspace</span>/<span class="title">wordpress</span>-<span class="title">pipeline</span>-<span class="title">job</span>/<span class="title">wordpress_playbooks</span>/<span class="title">deploy</span>.<span class="title">retry</span></span></span><br></pre></td></tr></table></figure>

<p>deploy.yml中添加颜色加重部分</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">     <span class="attr">backup_to:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;root&#125;&#125;</span>_<span class="template-variable">&#123;&#123;branch&#125;&#125;</span>_<span class="template-variable">&#123;&#123;ansible_date_time.epoch&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wordpress</span></span><br></pre></td></tr></table></figure>



<p>解决过程中还遇到一个git提交错误</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git add .</span><br><span class="line">warning: LF will be replaced by CRLF in wordpress_playbooks/roles/wordpress/files/info.php.</span><br><span class="line">The file will have its original line endings in your working directory</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git <span class="keyword">commit</span> -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">[<span class="keyword">master</span> eab3d83] <span class="keyword">first</span> <span class="keyword">commit</span></span><br><span class="line"> <span class="number">1</span> <span class="keyword">file</span> <span class="keyword">changed</span>, <span class="number">0</span> insertions(+), <span class="number">0</span> deletions(-)</span><br><span class="line"> <span class="keyword">rename</span> wordpress_playbooks/<span class="keyword">roles</span>/wordpress/files/&#123;index.php =&gt; info.php&#125; (<span class="number">100</span>%)</span><br><span class="line"></span><br><span class="line">xueji@xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (<span class="keyword">master</span>)</span><br><span class="line">$ git push origin <span class="keyword">master</span></span><br><span class="line"><span class="keyword">To</span> https://gitlab.example.com/root/ansible-playbook-repo.git</span><br><span class="line"> ! [rejected]        <span class="keyword">master</span> -&gt; <span class="keyword">master</span> (<span class="keyword">fetch</span> <span class="keyword">first</span>)</span><br><span class="line"><span class="keyword">error</span>: <span class="keyword">failed</span> <span class="keyword">to</span> push <span class="keyword">some</span> refs <span class="keyword">to</span> <span class="string">&#x27;https://gitlab.example.com/root/ansible-playbook-repo.git&#x27;</span></span><br><span class="line">hint: Updates were rejected because the remote contains <span class="keyword">work</span> that you <span class="keyword">do</span></span><br><span class="line">hint: <span class="keyword">not</span> have locally. This <span class="keyword">is</span> usually caused <span class="keyword">by</span> another repository pushing</span><br><span class="line">hint: <span class="keyword">to</span> the same ref. You may want <span class="keyword">to</span> <span class="keyword">first</span> integrate the remote changes</span><br><span class="line">hint: (e.g., <span class="string">&#x27;git pull ...&#x27;</span>) <span class="keyword">before</span> pushing again.</span><br><span class="line">hint: See the <span class="string">&#x27;Note about fast-forwards&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;git push --help&#x27;</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>



<p>解决办法是，在推送到远端之前，先pull一下，然后再提交</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git pull origin master</span><br><span class="line">remote: Enumerating objects: <span class="number">1</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">1</span>/<span class="number">1</span>), done.</span><br><span class="line">remote: Total <span class="number">1</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">1</span>/<span class="number">1</span>), done.</span><br><span class="line">From https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo</span></span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   <span class="number">2</span>dc88b0.<span class="number">.5</span>ea65a4  master     -&gt; origin/master</span><br><span class="line">Already up to date!</span><br><span class="line">Merge made by the <span class="string">&#x27;recursive&#x27;</span> strategy.</span><br><span class="line"></span><br><span class="line"><span class="symbol">xueji@</span>xueji MINGW64 ~/Desktop/repo/ansible-playbook-repo/wordpress_playbooks (master)</span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: <span class="number">12</span>, done.</span><br><span class="line">Counting objects: <span class="number">100</span>% (<span class="number">12</span>/<span class="number">12</span>), done.</span><br><span class="line">Delta compression using up to <span class="number">4</span> threads</span><br><span class="line">Compressing objects: <span class="number">100</span>% (<span class="number">6</span>/<span class="number">6</span>), done.</span><br><span class="line">Writing objects: <span class="number">100</span>% (<span class="number">7</span>/<span class="number">7</span>), <span class="number">648</span> bytes | <span class="number">648.00</span> KiB/s, done.</span><br><span class="line">Total <span class="number">7</span> (delta <span class="number">4</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">To https:<span class="comment">//gitlab.example.com/root/ansible-playbook-repo.git</span></span><br><span class="line">   <span class="number">5</span>ea65a4.<span class="number">.6127999</span>  master -&gt; master</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>自动部署</tag>
      </tags>
  </entry>
</search>
